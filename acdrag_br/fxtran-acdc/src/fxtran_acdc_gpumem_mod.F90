MODULE FXTRAN_ACDC_GPUMEM_MOD

!
! Copyright 2025 Meteo-France
! All rights reserved
! philippe.marguinaud@meteo.fr
!

IMPLICIT NONE

PRIVATE
PUBLIC :: FXTRAN_ACDC_GPUMEMSTAT, FXTRAN_ACDC_GPUMEMINCR, FXTRAN_ACDC_GPUMEMDECR

INTEGER*8 :: NMETADATA = 0

CONTAINS

SUBROUTINE FXTRAN_ACDC_GPUMEMSTAT (CDFILE, KLINE, CDMESS)

USE FXTRAN_ACDC_GET_MPI_RANK_MOD

IMPLICIT NONE

CHARACTER (LEN=*) :: CDFILE
INTEGER           :: KLINE
CHARACTER (LEN=*) :: CDMESS

INTEGER*8 :: ISIZE_SMI
INTEGER*8 :: ISIZE_ACC
INTEGER*8 :: IALLOCATED, IDELETED

INTEGER :: MYPROC 

LOGICAL, SAVE :: LLFIRST = .TRUE.

INTEGER*8, PARAMETER :: MB = 1024 * 1024

INTEGER*8 :: ISIZE (8)
CHARACTER*20 :: CLABEL (8)
CHARACTER*32 :: CLENV
CHARACTER*50 :: CLLOCATION

INTEGER*8 ::  IFIELD_API_DEVICE_CUR, IFIELD_API_DEVICE_MAX

INTEGER :: I

CALL GETENV ('FXTRAN_ACDC_GPUMEM', CLENV)

IF (CLENV /= '1') RETURN

CALL FXTRAN_ACDC_GET_MPI_RANK (MYPROC)

MYPROC = MYPROC + 1

IF (LLFIRST) THEN
  CLABEL (1) = "METADATA"
  CLABEL (2) = "FIELDAPI CUR"
  CLABEL (3) = "FIELDAPI MAX"
  CLABEL (4) = "TOTAL"
  CLABEL (5) = "SMI"
  CLABEL (6) = "ACC"
  CLABEL (7) = "ALLOCATED"
  CLABEL (8) = "DELETED"

  WRITE (0, '(" # GPU = ",A50)', ADVANCE='NO') "LOCATION"

  DO I = 1, 8
    WRITE (0, '(A20)', ADVANCE='NO') TRIM (CLABEL (I))
  ENDDO

  WRITE (0, '(" # ",A)') " COMMENT "

  LLFIRST = .FALSE.
ENDIF

ISIZE_SMI = 0
IF (MYPROC == 1) THEN
  CALL FXTRAN_ACDC_NVIDIA_SMI (ISIZE_SMI)
ENDIF

CALL FXTRAN_ACDC_NVIDIA_FREE_MEMORY (ISIZE_ACC)
CALL FXTRAN_ACDC_NVIDIA_PRESENT_DUMP (IALLOCATED, IDELETED)

CALL FXTRAN_ACDC_FIELD_API_STAT (IFIELD_API_DEVICE_CUR, IFIELD_API_DEVICE_MAX)

ISIZE = [NMETADATA, IFIELD_API_DEVICE_CUR, IFIELD_API_DEVICE_MAX,    &
      &  NMETADATA+IFIELD_API_DEVICE_CUR, ISIZE_SMI * MB, ISIZE_ACC, &
      &  IALLOCATED, IDELETED]

WRITE (CLLOCATION, '(I0)') KLINE
CLLOCATION = TRIM (CDFILE)//':'//TRIM (CLLOCATION)

WRITE (0, '("   GPU = ",A50)', ADVANCE='NO') CLLOCATION

DO I = 1, 8
  WRITE (0, '(A20)', ADVANCE='NO') MEMFMT (ISIZE (I))
ENDDO

WRITE (0, '(" # ",A)') CDMESS


CONTAINS

CHARACTER*20 FUNCTION MEMFMT (KSIZE)

INTEGER*8 :: KSIZE
INTEGER*8 :: ISIZE

ISIZE = KSIZE / MB

WRITE (MEMFMT, '(I20)') ISIZE

MEMFMT = ADJUSTR (MEMFMT)

END FUNCTION

END SUBROUTINE

SUBROUTINE FXTRAN_ACDC_GPUMEMINCR (KSIZE)

IMPLICIT NONE

INTEGER*8 :: KSIZE

INTEGER*8 :: NMETADATA

NMETADATA = NMETADATA + KSIZE

END SUBROUTINE

SUBROUTINE FXTRAN_ACDC_GPUMEMDECR (KSIZE)

IMPLICIT NONE

INTEGER*8 :: KSIZE

INTEGER*8 :: NMETADATA

NMETADATA = NMETADATA - KSIZE

END SUBROUTINE

END MODULE
