SUBROUTINE CUBASEN_SINGLEBLOCK (PPLDARE, PPLRG, YDTHF, YDCST, YDEPHLI, YDECLDP, YDECUMF&
&, YDSPP_CONFIG, KIDIA, KFDIA, KLON, KLEV, KINDEX, LDMIXS, LDTDKMF, PTENH, PQENH, PGEOH&
&, PAPH, PQHFL, PAHFS, PGP2DSPP, PKMFL, PTEN, PQEN, PQSEN, PGEO, PTU, PQU, PLU, PWU2H&
&, PWUBASE, KLAB, LDCUM, LDSC, KCBOT, KBOTSC, KCTOP, KDPL, PCAPE, LDACC)
USE YOEPHLI,ONLY:TEPHLI
USE PARKIND1,ONLY:JPIM, JPRB
#ifdef __PGI
USE NVTX, ONLY : NVTXSTARTRANGE, NVTXENDRANGE
#endif
USE YOMCST,ONLY:TCST
USE PARPHY,ONLY:RKAP
USE YOECUMF,ONLY:TECUMF
USE YOECLDP,ONLY:TECLDP
USE YOETHF,ONLY:TTHF
USE SPP_MOD,ONLY:TSPP_CONFIG
USE SPP_GEN_MOD,ONLY:SPP_PERT
USE FXTRAN_ACDC_STACK_MOD
#include "fxtran_acdc_stack.h"

IMPLICIT NONE


REAL (KIND=JPRB), INTENT (IN)::PPLDARE
REAL (KIND=JPRB), INTENT (IN)::PPLRG
TYPE (TECLDP), INTENT (IN)::YDECLDP
TYPE (TECUMF), INTENT (IN)::YDECUMF
TYPE (TTHF), INTENT (IN)::YDTHF
TYPE (TCST), INTENT (IN)::YDCST
TYPE (TEPHLI), INTENT (IN)::YDEPHLI
TYPE (TSPP_CONFIG), INTENT (IN)::YDSPP_CONFIG
INTEGER (KIND=JPIM), INTENT (IN)::KLON
INTEGER (KIND=JPIM), INTENT (IN)::KLEV
INTEGER (KIND=JPIM), INTENT (IN)::KIDIA
INTEGER (KIND=JPIM), INTENT (IN)::KFDIA
INTEGER (KIND=JPIM), INTENT (IN)::KINDEX
LOGICAL, INTENT (IN)::LDMIXS
LOGICAL, INTENT (IN)::LDTDKMF
REAL (KIND=JPRB), INTENT (IN)::PTENH (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PQENH (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PGEOH (KLON, KLEV+1)
REAL (KIND=JPRB), INTENT (IN)::PAPH (KLON, KLEV+1)
REAL (KIND=JPRB), INTENT (IN)::PQHFL (KLON, KLEV+1)
REAL (KIND=JPRB), INTENT (IN)::PAHFS (KLON, KLEV+1)
REAL (KIND=JPRB), INTENT (IN)::PGP2DSPP (KLON, YDSPP_CONFIG%SM%NRFTOTAL)
REAL (KIND=JPRB), INTENT (IN)::PKMFL (KLON)
REAL (KIND=JPRB), INTENT (IN)::PTEN (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PQEN (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PQSEN (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PGEO (KLON, KLEV)
REAL (KIND=JPRB), INTENT (INOUT)::PTU (KLON, KLEV)
REAL (KIND=JPRB), INTENT (INOUT)::PQU (KLON, KLEV)
REAL (KIND=JPRB), INTENT (INOUT)::PLU (KLON, KLEV)
REAL (KIND=JPRB), INTENT (INOUT)::PWU2H (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PWUBASE (KLON)
INTEGER (KIND=JPIM), INTENT (INOUT)::KLAB (KLON, KLEV)
LOGICAL, INTENT (INOUT)::LDCUM (KLON)
LOGICAL, INTENT (OUT)::LDSC (KLON)
INTEGER (KIND=JPIM), INTENT (INOUT)::KCBOT (KLON)
INTEGER (KIND=JPIM), INTENT (OUT)::KBOTSC (KLON)
INTEGER (KIND=JPIM), INTENT (OUT)::KCTOP (KLON)
INTEGER (KIND=JPIM), INTENT (OUT)::KDPL (KLON)
REAL (KIND=JPRB), INTENT (OUT)::PCAPE (KLON)
LOGICAL, INTENT (IN) :: LDACC
INTEGER (KIND=JPIM)::IDPL (KLON)
INTEGER (KIND=JPIM)::ILAB (KLON, KLEV)
INTEGER (KIND=JPIM)::IBOTSC (KLON)
INTEGER (KIND=JPIM)::ICBOT (KLON)
INTEGER (KIND=JPIM)::ICTOP (KLON)
LOGICAL::LLFIRST (KLON)
LOGICAL::LLDSC (KLON)
LOGICAL::LLDCUM (KLON)
LOGICAL::LLDEEP (KLON)
LOGICAL::LLGO_ON (KLON)
LOGICAL::LL_LDBASE (KLON)
LOGICAL::LLRESETJL (KLON)
LOGICAL::LLRESET
LOGICAL::LLPERT_ENTSTPC1
LOGICAL::LLPERT_ENTRORG
INTEGER (KIND=JPIM)::JKB
INTEGER (KIND=JPIM)::JKT
INTEGER (KIND=JPIM)::JKT2
INTEGER (KIND=JPIM)::JKT1
INTEGER (KIND=JPIM)::JKK
INTEGER (KIND=JPIM)::JL
INTEGER (KIND=JPIM)::JK
INTEGER (KIND=JPIM)::IS
INTEGER (KIND=JPIM)::IK
INTEGER (KIND=JPIM)::IPENTSTPC1
INTEGER (KIND=JPIM)::IPENTRORG
REAL (KIND=JPRB)::ZWU2H (KLON, KLEV)
REAL (KIND=JPRB)::ZBUOH (KLON, KLEV)
REAL (KIND=JPRB)::ZSUH (KLON, KLEV)
REAL (KIND=JPRB)::ZQENH (KLON, KLEV+1)
REAL (KIND=JPRB)::ZSENH (KLON, KLEV+1)
REAL (KIND=JPRB)::ZS (KLON, KLEV)
REAL (KIND=JPRB)::ZPH (KLON)
REAL (KIND=JPRB)::ZQOLD (KLON)
REAL (KIND=JPRB)::ZMIX (KLON)
REAL (KIND=JPRB)::ZCBASE (KLON)
REAL (KIND=JPRB)::ZDZ (KLON)
REAL (KIND=JPRB)::ZTU (KLON, KLEV)
REAL (KIND=JPRB)::ZQU (KLON, KLEV)
REAL (KIND=JPRB)::ZLU (KLON, KLEV)
REAL (KIND=JPRB)::ZCAPE (KLON, KLEV)
REAL (KIND=JPRB)::ZBUOF
REAL (KIND=JPRB)::ZRHO
REAL (KIND=JPRB)::ZKHVFL
REAL (KIND=JPRB)::ZWS
REAL (KIND=JPRB)::ZUST
REAL (KIND=JPRB)::ZQEXC
REAL (KIND=JPRB)::ZQEX (KLON)
REAL (KIND=JPRB)::ZTEXC
REAL (KIND=JPRB)::ZTEX (KLON)
REAL (KIND=JPRB)::ZEPS
REAL (KIND=JPRB)::ZTVENH
REAL (KIND=JPRB)::ZTVUH
REAL (KIND=JPRB)::ZLGLAC
REAL (KIND=JPRB)::ZBW
REAL (KIND=JPRB)::ZAW
REAL (KIND=JPRB)::ZQF
REAL (KIND=JPRB)::ZSF
REAL (KIND=JPRB)::ZPDIFFBOT
REAL (KIND=JPRB)::ZPDIFFTOP
REAL (KIND=JPRB)::ZDP
REAL (KIND=JPRB)::ZDTDP
REAL (KIND=JPRB)::ZDQSDT
REAL (KIND=JPRB)::ZESDP
REAL (KIND=JPRB)::ZFAC
REAL (KIND=JPRB)::ZFACI
REAL (KIND=JPRB)::ZFACW
REAL (KIND=JPRB)::ZALFAW
REAL (KIND=JPRB)::ZDQ
REAL (KIND=JPRB)::ZCOR
REAL (KIND=JPRB)::ZQSU
REAL (KIND=JPRB)::ZWORK2
REAL (KIND=JPRB)::ZWORK1
REAL (KIND=JPRB)::ZTMP
REAL (KIND=JPRB)::ZRG
REAL (KIND=JPRB)::ZRCPD
REAL (KIND=JPRB)::ZXENTSTPC1
REAL (KIND=JPRB)::ZXENTRORG
INTEGER (KIND=JPIM)::IPN
TYPE (SPP_PERT)::PN2
TYPE (SPP_PERT)::PN1

#include "fcttre.func.h"
REAL (KIND=JPRB)::ZQP
REAL (KIND=JPRB)::ZTARG
REAL (KIND=JPRB)::ZQSAT
REAL (KIND=JPRB)::ZQMAX
REAL (KIND=JPRB)::ZOEALFA
REAL (KIND=JPRB)::ZFOEEWL
REAL (KIND=JPRB)::ZFOEEWI
REAL (KIND=JPRB)::ZCOR_CUADJTQ
REAL (KIND=JPRB)::ZCOND1
REAL (KIND=JPRB)::ZCOND
REAL (KIND=JPRB)::Z2S
REAL (KIND=JPRB)::Z1S
REAL (KIND=JPRB)::ZF
REAL (KIND=JPRB)::ZI
REAL (KIND=JPRB)::ZL
LOGICAL::LLFLAG (KLON)
#include "abor1.intfb.h"
#include "cuadjtq.func.h"
TYPE (FXTRAN_ACDC_STACK) :: YLSTACK

!$ACC DATA &
!$ACC&CREATE (IBOTSC, ICBOT, ICTOP, IDPL, ILAB, LLDCUM, LLDEEP, LLDSC, LLFIRST, LLFLAG, &
!$ACC&        LLGO_ON, LLRESETJL, LL_LDBASE, ZBUOH, ZCAPE, ZCBASE, ZDZ, ZLU, ZMIX, &
!$ACC&        ZPH, ZQENH, ZQEX, ZQOLD, ZQU, ZS, ZSENH, ZSUH, ZTEX, ZTU, ZWU2H) &
!$ACC&IF (LDACC) &
!$ACC&PRESENT (KBOTSC, KCBOT, KCTOP, KDPL, KLAB, LDCUM, LDSC, PAHFS, PAPH, PCAPE, PGEO, &
!$ACC&         PGEOH, PGP2DSPP, PKMFL, PLU, PQEN, PQENH, PQHFL, PQSEN, PQU, PTEN, PTENH, &
!$ACC&         PTU, PWU2H, PWUBASE, YDCST, YDECLDP, YDECUMF, YDEPHLI, YDSPP_CONFIG, &
!$ACC&         YDTHF) 

#ifdef __PGI
CALL NVTXSTARTRANGE ('CUBASEN_SINGLEBLOCK')
#endif

ZAW=1.0_JPRB
ZBW=1.0_JPRB

!$ACC PARALLEL LOOP GANG VECTOR &
!$ACC&IF (LDACC) &
!$ACC&PRIVATE (JL) 


DO JL = KIDIA, KFDIA
  
  
  PWUBASE (JL)=0.0_JPRB
  LLGO_ON (JL)=.TRUE.
  LLFIRST (JL)=.TRUE.
  KDPL (JL)=KLEV
  
ENDDO

JKT1=KINDEX
JKT2=YDECUMF%NJKT2
ZRG=1.0_JPRB/YDCST%RG
ZRCPD=1.0_JPRB/YDCST%RCPD

!$ACC PARALLEL LOOP GANG VECTOR &
!$ACC&IF (LDACC) &
!$ACC&PRIVATE (JK, JL, LLPERT_ENTRORG, LLPERT_ENTSTPC1) 


DO JL = KIDIA, KFDIA

  

  DO JK=1, KLEV
    
    ZTU (JL, JK)=PTU (JL, JK)
    ZQU (JL, JK)=PQU (JL, JK)
    ZLU (JL, JK)=PLU (JL, JK)
    ILAB (JL, JK)=KLAB (JL, JK)
    ZCAPE (JL, JK)=0.0_JPRB
  
  ENDDO

  
  LLPERT_ENTSTPC1=.FALSE.
  LLPERT_ENTRORG=.FALSE.

  

  DO JK=1, KLEV
    
    PWU2H (JL, JK)=0.0_JPRB
    ZWU2H (JL, JK)=0.0_JPRB
    ZS (JL, JK)=YDCST%RCPD*PTEN (JL, JK)+PGEO (JL, JK)
    ZQENH (JL, JK)=PQENH (JL, JK)
    ZSENH (JL, JK)=YDCST%RCPD*PTENH (JL, JK)+PGEOH (JL, JK)
  
  ENDDO

ENDDO


!$ACC PARALLEL LOOP GANG VECTOR &
!$ACC&IF (LDACC) &
!$ACC&PRIVATE (IK, IS, JK, JKB, JKK, JKT, JL, LLRESET, Z1S, Z2S, ZALFAW, ZBUOF, ZCOND, ZCOND1, &
!$ACC&         ZCOR, ZCOR_CUADJTQ, ZDP, ZDQ, ZDQSDT, ZDTDP, ZEPS, ZESDP, ZF, ZFAC, ZFACI, &
!$ACC&         ZFACW, ZFOEEWI, ZFOEEWL, ZI, ZKHVFL, ZL, ZLGLAC, ZOEALFA, ZPDIFFBOT, &
!$ACC&         ZPDIFFTOP, ZQEXC, ZQF, ZQMAX, ZQP, ZQSAT, ZQSU, ZRHO, ZSF, ZTARG, ZTEXC, &
!$ACC&         ZTMP, ZTVENH, ZTVUH, ZUST, ZWORK1, ZWORK2, ZWS, ZXENTRORG, ZXENTSTPC1) 


DO JL = KIDIA, KFDIA

  

  DO JKK=KLEV, JKT1,-1
    IS=0

    

    IF (LLGO_ON (JL)) THEN
      IS=IS+1
      IDPL (JL)=JKK
      ICBOT (JL)=JKK
      IBOTSC (JL)=KLEV-1
      ICTOP (JL)=KLEV-1
      LLDCUM (JL)=.FALSE.
      LLDSC (JL)=.FALSE.
      LL_LDBASE (JL)=.FALSE.
    ENDIF


    

    IF (IS/=0) THEN

      IF (JKK==KLEV) THEN
        ZTEXC=0.2_JPRB
        ZQEXC=1.E-4_JPRB

        

        IF (LLGO_ON (JL)) THEN
          ZRHO=PAPH (JL, JKK+1)/(YDCST%RD*(PTEN (JL, JKK)*(1.0_JPRB+YDCST%RETV*PQEN (JL, JKK))))
          ZKHVFL=(PAHFS (JL, JKK+1)*ZRCPD+YDCST%RETV*PTEN (JL, JKK)*PQHFL (JL, JKK+1))/(ZRHO*PPLRG*PPLDARE)
          ZUST=MAX (SQRT (PKMFL (JL)), 0.1_JPRB)
          ZWS=ZUST**3._JPRB-1.5_JPRB*RKAP*ZKHVFL*(PGEOH (JL, KLEV)-PGEOH (JL, KLEV+1))/PTEN (JL, KLEV)
          ZTEX (JL)=0.0_JPRB
          ZQEX (JL)=0.0_JPRB

          IF (ZKHVFL<0.0_JPRB) THEN
            ZWS=1.2_JPRB*ZWS**.3333_JPRB
            ILAB (JL, JKK)=1
            ZTEX (JL)=MAX (-1.5_JPRB*PAHFS (JL, JKK+1)/(ZRHO*ZWS*YDCST%RCPD*PPLRG*PPLDARE), ZTEXC)
            ZQEX (JL)=MAX (-1.5_JPRB*PQHFL (JL, JKK+1)/(ZRHO*ZWS*PPLRG*PPLDARE), ZQEXC)
            ZQU (JL, JKK)=ZQENH (JL, JKK)+ZQEX (JL)
            ZSUH (JL, JKK)=ZSENH (JL, JKK)+YDCST%RCPD*ZTEX (JL)
            ZTU (JL, JKK)=(ZSENH (JL, JKK)-PGEOH (JL, JKK))*ZRCPD+ZTEX (JL)
            ZLU (JL, JKK)=0.0_JPRB
            ZWU2H (JL, JKK)=ZWS**2+0.1_JPRB
            PWU2H (JL, JKK)=ZWU2H (JL, JKK)
            ZTVENH=(1.0_JPRB+YDCST%RETV*ZQENH (JL, JKK))*(ZSENH (JL, JKK)-PGEOH (JL, JKK))*ZRCPD
            ZTVUH=(1.0_JPRB+YDCST%RETV*ZQU (JL, JKK))*ZTU (JL, JKK)
            ZBUOH (JL, JKK)=(ZTVUH-ZTVENH)*YDCST%RG/ZTVENH
          ELSE
            LLGO_ON (JL)=.FALSE.
          ENDIF

        ENDIF

      
      ELSE

        

        IF (LLGO_ON (JL)) THEN
          ZRHO=PAPH (JL, JKK+1)/(YDCST%RD*(PTEN (JL, JKK)*(1.+YDCST%RETV*PQEN (JL, JKK))))
          ILAB (JL, JKK)=1
          ZTEXC=0.2_JPRB
          ZQEXC=1.E-4_JPRB

          IF (JKK==KLEV-1) THEN
            ZTEXC=MAX (ZTEXC, ZTEX (JL))
            ZQEXC=MAX (ZQEXC, ZQEX (JL))

            IF (LDTDKMF) THEN
              ZTEXC=MIN (ZTEXC, 3.0_JPRB)
              ZQEXC=MIN (ZQEXC, 2.E-3_JPRB)
            ELSE
              ZTEXC=MIN (ZTEXC, 1.0_JPRB)
              ZQEXC=MIN (ZQEXC, 5.E-4_JPRB)
            ENDIF

          ENDIF

          ZQU (JL, JKK)=ZQENH (JL, JKK)+ZQEXC
          ZSUH (JL, JKK)=ZSENH (JL, JKK)+YDCST%RCPD*ZTEXC
          ZTU (JL, JKK)=(ZSENH (JL, JKK)-PGEOH (JL, JKK))*ZRCPD+ZTEXC
          ZLU (JL, JKK)=0.0_JPRB

          IF (PAPH (JL, KLEV+1)-PAPH (JL, JKK-1)<60.E2_JPRB) THEN
            ZQU (JL, JKK)=0.0_JPRB
            ZSUH (JL, JKK)=0.0_JPRB
            ZWORK1=0.0_JPRB

            DO JK=JKK+1, JKK-1,-1

              IF (ZWORK1<50.E2_JPRB) THEN
                ZWORK2=PAPH (JL, JK)-PAPH (JL, JK-1)
                ZWORK1=ZWORK1+ZWORK2
                ZQU (JL, JKK)=ZQU (JL, JKK)+ZQENH (JL, JK)*ZWORK2
                ZSUH (JL, JKK)=ZSUH (JL, JKK)+ZSENH (JL, JK)*ZWORK2
              ENDIF

            ENDDO

            ZQU (JL, JKK)=ZQU (JL, JKK)/ZWORK1+ZQEXC
            ZSUH (JL, JKK)=ZSUH (JL, JKK)/ZWORK1+YDCST%RCPD*ZTEXC
            ZTU (JL, JKK)=(ZSUH (JL, JKK)-PGEOH (JL, JKK))*ZRCPD+ZTEXC
          ENDIF

          ZWU2H (JL, JKK)=1.0_JPRB
          ZTVENH=(1.0_JPRB+YDCST%RETV*ZQENH (JL, JKK))*(ZSENH (JL, JKK)-PGEOH (JL, JKK))*ZRCPD
          ZTVUH=(1.0_JPRB+YDCST%RETV*ZQU (JL, JKK))*ZTU (JL, JKK)
          ZBUOH (JL, JKK)=(ZTVUH-ZTVENH)*YDCST%RG/ZTVENH
        ENDIF

      
      ENDIF

    ENDIF


    DO JK=JKK-1, JKT2,-1
      IS=0

      IF (JKK==KLEV.OR.KINDEX==KLEV-1) THEN
        
        
        ZXENTSTPC1=YDECUMF%ENTSTPC1

        

        IF (LLGO_ON (JL)) THEN
          IS=IS+1
          ZDZ (JL)=(PGEOH (JL, JK)-PGEOH (JL, JK+1))*ZRG

          IF (LDTDKMF) THEN
            ZEPS=ZXENTSTPC1/((PGEOH (JL, JK)-PGEOH (JL, KLEV+1))*ZRG*PPLRG)+YDECUMF%ENTSTPC2
          ELSE
            ZEPS=ZXENTSTPC1/((PGEO (JL, JK)-PGEOH (JL, KLEV+1))*ZRG*PPLRG)+YDECUMF%ENTSTPC2

            IF (LDMIXS.AND.KINDEX==KLEV.AND.ZLU (JL, JK+1)>0.0_JPRB)  THEN
              ZEPS=ZEPS*YDECUMF%ENTSTPC3
            ENDIF

          ENDIF

          ZMIX (JL)=0.5_JPRB*ZDZ (JL)*PPLRG*ZEPS

          IF (.NOT.LDTDKMF)  THEN
            ZMIX (JL)=MIN (1.0_JPRB, ZMIX (JL))
          ENDIF

          ZQF=(PQENH (JL, JK+1)+PQENH (JL, JK))*0.5_JPRB
          ZSF=(ZSENH (JL, JK+1)+ZSENH (JL, JK))*0.5_JPRB
          ZTMP=1.0_JPRB/(1.0_JPRB+ZMIX (JL))
          ZQU (JL, JK)=(ZQU (JL, JK+1)*(1.0_JPRB-ZMIX (JL))+2.0_JPRB*ZMIX (JL)*ZQF)*ZTMP
          ZSUH (JL, JK)=(ZSUH (JL, JK+1)*(1.0_JPRB-ZMIX (JL))+2.0_JPRB*ZMIX (JL)*ZSF)*ZTMP
          ZQOLD (JL)=ZQU (JL, JK)
          ZTU (JL, JK)=(ZSUH (JL, JK)-PGEOH (JL, JK))*ZRCPD
          ZPH (JL)=PAPH (JL, JK)
        ENDIF

      
      ELSE
        ZXENTRORG=YDECUMF%ENTRORG

        

        IF (LLGO_ON (JL)) THEN
          
          ZDZ (JL)=(PGEOH (JL, JK)-PGEOH (JL, JK+1))*ZRG
          ZMIX (JL)=YDECUMF%ENTRTEST*ZXENTRORG*ZDZ (JL)*MIN (1.0_JPRB,(PQSEN (JL, JK)/PQSEN (JL, KLEV))**3)
        ENDIF


        

        

        IF (LLGO_ON (JL)) THEN
          IS=IS+1
          ZMIX (JL)=MIN (1.0_JPRB, ZMIX (JL))
          ZQF=(PQENH (JL, JK+1)+PQENH (JL, JK))*0.5_JPRB
          ZSF=(ZSENH (JL, JK+1)+ZSENH (JL, JK))*0.5_JPRB
          ZQU (JL, JK)=ZQU (JL, JK+1)*(1.0_JPRB-ZMIX (JL))+ZQF*ZMIX (JL)
          ZSUH (JL, JK)=ZSUH (JL, JK+1)*(1.0_JPRB-ZMIX (JL))+ZSF*ZMIX (JL)
          ZQOLD (JL)=ZQU (JL, JK)
          ZTU (JL, JK)=(ZSUH (JL, JK)-PGEOH (JL, JK))*ZRCPD
          ZPH (JL)=PAPH (JL, JK)
        ENDIF

      
      ENDIF


      IF (IS==0)  THEN
        EXIT
      ENDIF

      IK=JK
      
      
      ZQMAX=0.5_JPRB

      IF (.NOT.YDEPHLI%LPHYLIN) THEN
        
        LLFLAG (JL)=LLGO_ON (JL)

        

        

        IF (LLFLAG (JL)) THEN
          ZQP=1.0_JPRB/ZPH (JL)
          ZL=1.0_JPRB/(ZTU (JL, IK)-YDTHF%R4LES)
          ZI=1.0_JPRB/(ZTU (JL, IK)-YDTHF%R4IES)
          ZQSAT=YDTHF%R2ES*(FOEALFCU (ZTU (JL, IK))*EXP (YDTHF%R3LES*(ZTU (JL, IK)-YDCST%RTT)*ZL&
          &)+(1.0_JPRB-FOEALFCU (ZTU (JL, IK)))*EXP (YDTHF%R3IES*(ZTU (JL, IK)-YDCST%RTT)*ZI))
          ZQSAT=ZQSAT*ZQP
          ZQSAT=MIN (0.5_JPRB, ZQSAT)
          ZCOR_CUADJTQ=1.0_JPRB-YDCST%RETV*ZQSAT
          ZF=FOEALFCU (ZTU (JL, IK))*YDTHF%R5ALVCP*ZL**2+(1.0_JPRB&
          &-FOEALFCU (ZTU (JL, IK)))*YDTHF%R5ALSCP*ZI**2
          ZCOND=(ZQU (JL, IK)*ZCOR_CUADJTQ**2-ZQSAT*ZCOR_CUADJTQ)/(ZCOR_CUADJTQ**2+ZQSAT*ZF)
          ZCOND=MAX (ZCOND, 0.0_JPRB)
          ZTU (JL, IK)=ZTU (JL, IK)+FOELDCPMCU (ZTU (JL, IK))*ZCOND
          ZQU (JL, IK)=ZQU (JL, IK)-ZCOND
          ZL=1.0_JPRB/(ZTU (JL, IK)-YDTHF%R4LES)
          ZI=1.0_JPRB/(ZTU (JL, IK)-YDTHF%R4IES)
          ZQSAT=YDTHF%R2ES*(FOEALFCU (ZTU (JL, IK))*EXP (YDTHF%R3LES*(ZTU (JL, IK)-YDCST%RTT)*ZL&
          &)+(1.0_JPRB-FOEALFCU (ZTU (JL, IK)))*EXP (YDTHF%R3IES*(ZTU (JL, IK)-YDCST%RTT)*ZI))
          ZQSAT=ZQSAT*ZQP
          ZQSAT=FMINJ (0.5_JPRB, ZQSAT)
          ZCOR_CUADJTQ=1.0_JPRB-YDCST%RETV*ZQSAT
          ZF=FOEALFCU (ZTU (JL, IK))*YDTHF%R5ALVCP*ZL**2+(1.0_JPRB&
          &-FOEALFCU (ZTU (JL, IK)))*YDTHF%R5ALSCP*ZI**2
          ZCOND1=(ZQU (JL, IK)*ZCOR_CUADJTQ**2-ZQSAT*ZCOR_CUADJTQ)/(ZCOR_CUADJTQ**2+ZQSAT*ZF)

          IF (ZCOND==0.0_JPRB)  THEN
            ZCOND1=0.0_JPRB
          ENDIF

          ZTU (JL, IK)=ZTU (JL, IK)+FOELDCPMCU (ZTU (JL, IK))*ZCOND1
          ZQU (JL, IK)=ZQU (JL, IK)-ZCOND1
        ENDIF

      
      
      
      
      
      
      
      
      ELSE

        

        

        IF (LLGO_ON (JL)) THEN
          ZQP=1.0_JPRB/ZPH (JL)
          ZTARG=ZTU (JL, IK)
          ZOEALFA=0.5_JPRB*(TANH (YDEPHLI%RLPAL1*(ZTARG-YDEPHLI%RLPTRC))+1.0_JPRB)
          ZFOEEWL=YDTHF%R2ES*EXP (YDTHF%R3LES*(ZTARG-YDCST%RTT)/(ZTARG-YDTHF%R4LES))
          ZFOEEWI=YDTHF%R2ES*EXP (YDTHF%R3IES*(ZTARG-YDCST%RTT)/(ZTARG-YDTHF%R4IES))
          ZQSAT=ZQP*(ZOEALFA*ZFOEEWL+(1.0_JPRB-ZOEALFA)*ZFOEEWI)
          Z1S=TANH (YDEPHLI%RLPAL2*(ZQSAT-ZQMAX))
          ZQSAT=0.5_JPRB*((1.0_JPRB-Z1S)*ZQSAT+(1.0_JPRB+Z1S)*ZQMAX)
          ZCOR_CUADJTQ=1.0_JPRB/(1.0_JPRB-YDCST%RETV*ZQSAT)
          ZQSAT=ZQSAT*ZCOR_CUADJTQ
          Z2S=ZOEALFA*YDTHF%R5ALVCP*(1.0_JPRB/(ZTARG-YDTHF%R4LES)**2)+(1.0_JPRB&
          &-ZOEALFA)*YDTHF%R5ALSCP*(1.0_JPRB/(ZTARG-YDTHF%R4IES)**2)
          ZCOND=(ZQU (JL, IK)-ZQSAT)/(1.0_JPRB+ZQSAT*ZCOR_CUADJTQ*Z2S)
          ZCOND=MAX (ZCOND, 0.0_JPRB)

          IF (ZCOND/=0.0_JPRB) THEN
            ZTU (JL, IK)=ZTU (JL, IK)+(ZOEALFA*YDTHF%RALVDCP+(1.0_JPRB-ZOEALFA)*YDTHF%RALSDCP)*ZCOND
            ZQU (JL, IK)=ZQU (JL, IK)-ZCOND
            ZTARG=ZTU (JL, IK)
            ZOEALFA=0.5_JPRB*(TANH (YDEPHLI%RLPAL1*(ZTARG-YDEPHLI%RLPTRC))+1.0_JPRB)
            ZFOEEWL=YDTHF%R2ES*EXP (YDTHF%R3LES*(ZTARG-YDCST%RTT)/(ZTARG-YDTHF%R4LES))
            ZFOEEWI=YDTHF%R2ES*EXP (YDTHF%R3IES*(ZTARG-YDCST%RTT)/(ZTARG-YDTHF%R4IES))
            ZQSAT=ZQP*(ZOEALFA*ZFOEEWL+(1.0_JPRB-ZOEALFA)*ZFOEEWI)
            Z1S=TANH (YDEPHLI%RLPAL2*(ZQSAT-ZQMAX))
            ZQSAT=0.5_JPRB*((1.0_JPRB-Z1S)*ZQSAT+(1.0_JPRB+Z1S)*ZQMAX)
            ZCOR_CUADJTQ=1.0_JPRB/(1.0_JPRB-YDCST%RETV*ZQSAT)
            ZQSAT=ZQSAT*ZCOR_CUADJTQ
            Z2S=ZOEALFA*YDTHF%R5ALVCP*(1.0_JPRB/(ZTARG-YDTHF%R4LES)**2)+(1.0_JPRB&
            &-ZOEALFA)*YDTHF%R5ALSCP*(1.0_JPRB/(ZTARG-YDTHF%R4IES)**2)
            ZCOND1=(ZQU (JL, IK)-ZQSAT)/(1.0_JPRB+ZQSAT*ZCOR_CUADJTQ*Z2S)
            ZTU (JL, IK)=ZTU (JL, IK)+(ZOEALFA*YDTHF%RALVDCP+(1.0_JPRB-ZOEALFA)*YDTHF%RALSDCP)*ZCOND1
            ZQU (JL, IK)=ZQU (JL, IK)-ZCOND1
          ENDIF

        ENDIF

      
      
      
      
      
      ENDIF


      

      

      

      

      IF (LLGO_ON (JL)) THEN
        ZDQ=MAX (ZQOLD (JL)-ZQU (JL, JK), 0.0_JPRB)
        ZLU (JL, JK)=ZLU (JL, JK+1)+ZDQ
        ZLGLAC=ZDQ*((1.0_JPRB-FOEALFCU (ZTU (JL, JK)))-(1.0_JPRB-FOEALFCU (ZTU (JL, JK+1))))
        ZLU (JL, JK)=0.5_JPRB*ZLU (JL, JK)
        ZTU (JL, JK)=ZTU (JL, JK)+YDTHF%RALFDCP*ZLGLAC
        ZSUH (JL, JK)=YDCST%RCPD*ZTU (JL, JK)+PGEOH (JL, JK)
        ZTVUH=(1.0_JPRB+YDCST%RETV*ZQU (JL, JK)-ZLU (JL, JK))*ZTU (JL, JK)+YDTHF%RALFDCP*ZLGLAC
        ZTVENH=(1.0_JPRB+YDCST%RETV*ZQENH (JL, JK))*(ZSENH (JL, JK)-PGEOH (JL, JK))*ZRCPD
        ZBUOH (JL, JK)=(ZTVUH-ZTVENH)*YDCST%RG/ZTVENH
        ZBUOF=(ZBUOH (JL, JK)+ZBUOH (JL, JK+1))*0.5_JPRB
        ZTMP=1.0_JPRB/(1.0_JPRB+2.0_JPRB*ZBW*ZMIX (JL))
        ZWU2H (JL, JK)=(ZWU2H (JL, JK+1)*(1.0_JPRB-2.0_JPRB*ZBW*ZMIX (JL))+2.0_JPRB*ZAW*ZBUOF*ZDZ (JL))*ZTMP

        IF (JKK==KLEV) THEN
          PWU2H (JL, JK)=ZWU2H (JL, JK)
        ENDIF

        ZCAPE (JL, JKK)=ZCAPE (JL, JKK)+MAX (0.0_JPRB, ZBUOF*ZDZ (JL))

        IF (ZLU (JL, JK)>0.0_JPRB.AND.ILAB (JL, JK+1)==1) THEN
          IK=JK+1
          ZQSU=FOEEWM (ZTU (JL, IK))/PAPH (JL, IK)
          ZESDP=ZQSU
          ZQSU=MIN (0.5_JPRB, ZQSU)
          ZCOR=1.0_JPRB/(1.0_JPRB-YDCST%RETV*ZQSU)
          ZQSU=ZQSU*ZCOR
          ZDQ=MIN (0._JPRB, ZQU (JL, IK)-ZQSU)
          ZALFAW=FOEALFA (ZTU (JL, IK))
          ZFACW=YDTHF%R5LES/((ZTU (JL, IK)-YDTHF%R4LES)**2)
          ZFACI=YDTHF%R5IES/((ZTU (JL, IK)-YDTHF%R4IES)**2)
          ZFAC=ZALFAW*ZFACW+(1.-ZALFAW)*ZFACI
          ZCOR=1.0_JPRB/(1.0_JPRB-YDCST%RETV*ZESDP)
          ZDQSDT=ZFAC*ZCOR*ZQSU
          ZDTDP=YDCST%RD*ZTU (JL, IK)/(YDCST%RCPD*PAPH (JL, IK))
          ZDP=ZDQ/(ZDQSDT*ZDTDP)
          ZCBASE (JL)=PAPH (JL, IK)+ZDP
          ZPDIFFTOP=ZCBASE (JL)-PAPH (JL, JK)
          ZPDIFFBOT=PAPH (JL, JK+1)-ZCBASE (JL)

          IF (ZPDIFFTOP>ZPDIFFBOT.AND.ZWU2H (JL, JK+1)>0.0_JPRB) THEN
            JKB=MIN (KLEV-1, JK+1)
            ILAB (JL, JKB)=2
            ILAB (JL, JK)=2
            LL_LDBASE (JL)=.TRUE.
            LLDSC (JL)=.TRUE.
            IBOTSC (JL)=JKB
            ICBOT (JL)=JKB
            ZLU (JL, JK+1)=YDECLDP%RLMIN
          ELSEIF (ZPDIFFTOP<=ZPDIFFBOT.AND.ZWU2H (JL, JK)>0.0_JPRB) THEN
            ILAB (JL, JK)=2
            LL_LDBASE (JL)=.TRUE.
            LLDSC (JL)=.TRUE.
            IBOTSC (JL)=JK
            ICBOT (JL)=JK
          ENDIF

        ENDIF


        IF (ZWU2H (JL, JK)<0.0_JPRB) THEN
          LLGO_ON (JL)=.FALSE.

          IF (ZLU (JL, JK+1)>0.0_JPRB) THEN
            ICTOP (JL)=JK
            LLDCUM (JL)=.TRUE.
          ELSE
            LLDCUM (JL)=.FALSE.
          ENDIF

        ELSE

          IF (ZLU (JL, JK)>0.0_JPRB) THEN
            ILAB (JL, JK)=2
          ELSE
            ILAB (JL, JK)=1
          ENDIF

        ENDIF

      ENDIF

    
    ENDDO


    IF (JKK==KLEV.OR.(JKK==KLEV-1.AND.KINDEX==KLEV-1)) THEN
      
      LDSC (JL)=LLDSC (JL)

      IF (LDSC (JL)) THEN
        KBOTSC (JL)=IBOTSC (JL)
      ELSE
        KBOTSC (JL)=-1
      ENDIF

      JKT=ICTOP (JL)
      JKB=ICBOT (JL)
      LLDEEP (JL)=PAPH (JL, JKB)-PAPH (JL, JKT)>YDECUMF%RDEPTHS

      IF (LLDEEP (JL).AND.KINDEX<KLEV-1)  THEN
        LLDCUM (JL)=.FALSE.
      ENDIF

      LLDEEP (JL)=.FALSE.
      LLGO_ON (JL)=.NOT.LLDEEP (JL)

      IF (KINDEX==KLEV-1)  THEN
        LLGO_ON (JL)=.NOT.LLDCUM (JL)
      ENDIF


      IF (LLDCUM (JL)) THEN
        KCBOT (JL)=ICBOT (JL)
        KCTOP (JL)=ICTOP (JL)
        KDPL (JL)=IDPL (JL)
        LDCUM (JL)=LLDCUM (JL)
        PWUBASE (JL)=SQRT (MAX (ZWU2H (JL, JKB), 0.0_JPRB))
      ELSE
        KCTOP (JL)=-1
        KCBOT (JL)=-1
        KDPL (JL)=KLEV-1
        LDCUM (JL)=.FALSE.
        PWUBASE (JL)=0.0_JPRB
      ENDIF


      

      DO JK=KLEV, 1,-1
        
        JKT=ICTOP (JL)

        IF (JK>=JKT.OR.(KINDEX>=KLEV-1.AND.JKK==KLEV)) THEN
          KLAB (JL, JK)=ILAB (JL, JK)
          PTU (JL, JK)=ZTU (JL, JK)
          PQU (JL, JK)=ZQU (JL, JK)
          PLU (JL, JK)=ZLU (JL, JK)
        ENDIF

      
      ENDDO

    ENDIF


    IF (JKK<KLEV) THEN
      LLRESET=.FALSE.

      

      IF (.NOT.LLDEEP (JL)) THEN
        JKT=ICTOP (JL)
        JKB=ICBOT (JL)
        LLDEEP (JL)=PAPH (JL, JKB)-PAPH (JL, JKT)>=YDECUMF%RDEPTHS
      ENDIF

      LLRESETJL (JL)=LLDEEP (JL).AND.LLFIRST (JL)
      LLRESET=LLRESET.OR.LLRESETJL (JL)

      

      IF (LLRESET) THEN

        DO JK=KLEV, 1,-1

          

          IF (LLRESETJL (JL)) THEN
            JKT=ICTOP (JL)
            JKB=IDPL (JL)

            IF (JK<=JKB.AND.JK>=JKT) THEN
              KLAB (JL, JK)=ILAB (JL, JK)
              PTU (JL, JK)=ZTU (JL, JK)
              PQU (JL, JK)=ZQU (JL, JK)
              PLU (JL, JK)=ZLU (JL, JK)
            ELSE
              KLAB (JL, JK)=1
              PTU (JL, JK)=PTENH (JL, JK)
              PQU (JL, JK)=PQENH (JL, JK)
              PLU (JL, JK)=0.0_JPRB
            ENDIF


            IF (JK<JKT)  THEN
              KLAB (JL, JK)=0
            ENDIF

          ENDIF

        
        ENDDO

      ENDIF


      

      IF (LLDEEP (JL).AND.LLFIRST (JL)) THEN
        KDPL (JL)=IDPL (JL)
        KCTOP (JL)=ICTOP (JL)
        KCBOT (JL)=ICBOT (JL)
        LDCUM (JL)=LLDCUM (JL)
        LDSC (JL)=.FALSE.
        KBOTSC (JL)=-1
        JKB=KCBOT (JL)
        PWUBASE (JL)=SQRT (MAX (ZWU2H (JL, JKB), 0.0_JPRB))
        LLFIRST (JL)=.FALSE.
      ENDIF

      LLGO_ON (JL)=.NOT.LLDEEP (JL)
    
    ENDIF

  ENDDO

ENDDO


!$ACC PARALLEL LOOP GANG VECTOR &
!$ACC&IF (LDACC) &
!$ACC&PRIVATE (JK, JL) 


DO JL = KIDIA, KFDIA
  
  PCAPE (JL)=ZCAPE (JL, 1)

  DO JK=2, KLEV
    
    PCAPE (JL)=MAX (PCAPE (JL), ZCAPE (JL, JK))
  
  ENDDO

ENDDO


#ifdef __PGI
CALL NVTXENDRANGE ()
#endif
!$ACC END DATA

ENDSUBROUTINE CUBASEN_SINGLEBLOCK
