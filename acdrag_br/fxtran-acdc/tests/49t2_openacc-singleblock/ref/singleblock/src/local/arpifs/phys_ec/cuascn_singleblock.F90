
SUBROUTINE CUASCN_SINGLEBLOCK (YDTHF, YDCST, YDEPHLI, YDECLDP, YDECUMF, YDSPP_CONFIG, YGFL, KIDIA&
&, KFDIA, KLON, KLEV, LDTDKMF, PTSPHY, PTENH, PQENH, PUEN, PVEN, PTEN, PQEN, PQSEN, PLITOT, PGEO&
&, PGEOH, PAP, PAPH, PVERVEL, PWUBASE, PGP2DSPP, LDLAND, LDCUM, KTYPE, KLAB, LSCVFLAG, PTU, PQU&
&, PLU, PLRAIN, PMFU, PMFUB, PLGLAC, PMFUS, PMFUQ, PMFUL, PLUDE, PLUDELI, PDMFUP, PLCRIT_AER,&
& PDMFEN, KCBOT, KCTOP, KCTOP0, KDPL, PMFUDE_RATE, PKINEU, PWU, PWMEAN, LDACC)
USE PARKIND1,ONLY:JPIM, JPRB
#ifdef __PGI
USE NVTX, ONLY : NVTXSTARTRANGE, NVTXENDRANGE
#endif
USE YOMCST,ONLY:TCST
USE YOETHF,ONLY:TTHF
USE YOECUMF,ONLY:TECUMF
USE YOEPHLI,ONLY:TEPHLI
USE YOECLDP,ONLY:TECLDP
USE YOM_YGFL,ONLY:TYPE_GFLD
USE SPP_MOD,ONLY:TSPP_CONFIG
USE SPP_GEN_MOD,ONLY:SPP_PERT
USE FXTRAN_ACDC_STACK_MOD
#include "fxtran_acdc_stack.h"

IMPLICIT NONE


TYPE (TTHF), INTENT (IN)::YDTHF
TYPE (TCST), INTENT (IN)::YDCST
TYPE (TECLDP), INTENT (IN)::YDECLDP
TYPE (TECUMF), INTENT (IN)::YDECUMF
TYPE (TEPHLI), INTENT (IN)::YDEPHLI
TYPE (TSPP_CONFIG), INTENT (IN)::YDSPP_CONFIG
TYPE (TYPE_GFLD), INTENT (IN)::YGFL
INTEGER (KIND=JPIM), INTENT (IN)::KLON
INTEGER (KIND=JPIM), INTENT (IN)::KLEV
INTEGER (KIND=JPIM), INTENT (IN)::KIDIA
INTEGER (KIND=JPIM), INTENT (IN)::KFDIA
REAL (KIND=JPRB), INTENT (IN)::PTSPHY
REAL (KIND=JPRB), INTENT (IN)::PLCRIT_AER (KLON, KLEV)
REAL (KIND=JPRB), INTENT (INOUT)::PTENH (KLON, KLEV)
REAL (KIND=JPRB), INTENT (INOUT)::PQENH (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PUEN (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PVEN (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PTEN (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PQEN (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PQSEN (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PLITOT (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PGEO (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PGEOH (KLON, KLEV+1)
REAL (KIND=JPRB), INTENT (IN)::PAP (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PAPH (KLON, KLEV+1)
REAL (KIND=JPRB), INTENT (IN)::PVERVEL (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PWUBASE (KLON)
REAL (KIND=JPRB), INTENT (IN)::PGP2DSPP (KLON, YDSPP_CONFIG%SM%NRFTOTAL)
LOGICAL, INTENT (IN)::LDLAND (KLON)
LOGICAL, INTENT (INOUT)::LDCUM (KLON)
LOGICAL, INTENT (IN)::LDTDKMF
LOGICAL, INTENT (OUT)::LSCVFLAG (KLON)
INTEGER (KIND=JPIM), INTENT (INOUT)::KTYPE (KLON)
INTEGER (KIND=JPIM), INTENT (INOUT)::KLAB (KLON, KLEV)
REAL (KIND=JPRB), INTENT (INOUT)::PTU (KLON, KLEV)
REAL (KIND=JPRB), INTENT (INOUT)::PQU (KLON, KLEV)
REAL (KIND=JPRB), INTENT (INOUT)::PLU (KLON, KLEV)
REAL (KIND=JPRB), INTENT (INOUT)::PLRAIN (KLON, KLEV)
REAL (KIND=JPRB), INTENT (INOUT)::PMFU (KLON, KLEV)
REAL (KIND=JPRB), INTENT (INOUT)::PMFUB (KLON)
REAL (KIND=JPRB), INTENT (OUT)::PLGLAC (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PMFUS (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PMFUQ (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PMFUL (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PLUDE (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PLUDELI (KLON, KLEV, 2)
REAL (KIND=JPRB), INTENT (OUT)::PDMFUP (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PDMFEN (KLON, KLEV)
INTEGER (KIND=JPIM), INTENT (INOUT)::KCBOT (KLON)
INTEGER (KIND=JPIM), INTENT (OUT)::KCTOP (KLON)
INTEGER (KIND=JPIM), INTENT (INOUT)::KCTOP0 (KLON)
INTEGER (KIND=JPIM), INTENT (IN)::KDPL (KLON)
REAL (KIND=JPRB), INTENT (OUT)::PMFUDE_RATE (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PKINEU (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PWU (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PWMEAN (KLON)
LOGICAL, INTENT (IN) :: LDACC
REAL (KIND=JPRB)::ZLUOLD (KLON)
REAL (KIND=JPRB)::ZBUO (KLON, KLEV)
REAL (KIND=JPRB)::ZPRECIP (KLON)
REAL (KIND=JPRB)::ZQOLD (KLON)
REAL (KIND=JPRB)::ZDMFDE (KLON)
REAL (KIND=JPRB)::ZDMFEN (KLON)
REAL (KIND=JPRB)::ZDPMEAN (KLON)
REAL (KIND=JPRB)::ZPH (KLON)
REAL (KIND=JPRB)::ZOENTR (KLON)
LOGICAL::LLO3
LOGICAL::LLO1 (KLON)
LOGICAL::LLFLAGUV (KLON)
LOGICAL::LLFLAG (KLON)
INTEGER (KIND=JPIM)::IKB
INTEGER (KIND=JPIM)::JL
INTEGER (KIND=JPIM)::JK
INTEGER (KIND=JPIM)::IS
INTEGER (KIND=JPIM)::IK
INTEGER (KIND=JPIM)::JLL
REAL (KIND=JPRB)::ZGLAC
REAL (KIND=JPRB)::ZOCUDET
REAL (KIND=JPRB)::ZZCO
REAL (KIND=JPRB)::ZVW
REAL (KIND=JPRB)::ZVV
REAL (KIND=JPRB)::ZVI
REAL (KIND=JPRB)::ZSEEN
REAL (KIND=JPRB)::ZSCDE
REAL (KIND=JPRB)::ZROLD
REAL (KIND=JPRB)::ZRNEW
REAL (KIND=JPRB)::ZQUDE
REAL (KIND=JPRB)::ZQEEN
REAL (KIND=JPRB)::ZPRCON
REAL (KIND=JPRB)::ZPRCDGW
REAL (KIND=JPRB)::ZOEALFAP
REAL (KIND=JPRB)::ZOEALFA
REAL (KIND=JPRB)::ZMFUSK
REAL (KIND=JPRB)::ZMFUQK
REAL (KIND=JPRB)::ZMFUN
REAL (KIND=JPRB)::ZMFULK
REAL (KIND=JPRB)::ZMFTEST
REAL (KIND=JPRB)::ZMFMAX
REAL (KIND=JPRB)::ZLNEW
REAL (KIND=JPRB)::ZLEEN
REAL (KIND=JPRB)::ZLCRIT
REAL (KIND=JPRB)::ZKEDKE
REAL (KIND=JPRB)::ZINT
REAL (KIND=JPRB)::ZFACBUO
REAL (KIND=JPRB)::ZFAC
REAL (KIND=JPRB)::ZDT
REAL (KIND=JPRB)::ZORCPD
REAL (KIND=JPRB)::ZRG
REAL (KIND=JPRB)::ZDNOPRC
REAL (KIND=JPRB)::ZDKEN
REAL (KIND=JPRB)::ZDKBUO
REAL (KIND=JPRB)::ZDFI
REAL (KIND=JPRB)::ZD
REAL (KIND=JPRB)::ZCONS2
REAL (KIND=JPRB)::ZCBF
REAL (KIND=JPRB)::ZC
REAL (KIND=JPRB)::ZBUOC
REAL (KIND=JPRB)::ZBE
REAL (KIND=JPRB)::ZBC
REAL (KIND=JPRB)::ZALFAW
REAL (KIND=JPRB)::Z_CWIFRAC
REAL (KIND=JPRB)::Z_CWDRAG
REAL (KIND=JPRB)::Z_CPRC2
REAL (KIND=JPRB)::Z_CLDMAX
REAL (KIND=JPRB)::ZXPRCDGW
REAL (KIND=JPRB)::ZXENTSHALP
REAL (KIND=JPRB)::ZXENTRORG
LOGICAL::LLPERT_RPRCON
LOGICAL::LLPERT_ENTSHALP
LOGICAL::LLPERT_ENTRORG
INTEGER (KIND=JPIM)::IPRPRCON
INTEGER (KIND=JPIM)::IPENTSHALP
INTEGER (KIND=JPIM)::IPENTRORG
INTEGER (KIND=JPIM)::IPN
TYPE (SPP_PERT)::PN1RPRCON
TYPE (SPP_PERT)::PN1ENTSHALP
TYPE (SPP_PERT)::PN1ENTRORG
REAL (KIND=JPRB)::ZXE
REAL (KIND=JPRB)::ZXS
REAL (KIND=JPRB)::ZCHANGE

LOGICAL::LLKLAB (KLON)
#include "fcttre.func.h"
REAL (KIND=JPRB)::ZQP
REAL (KIND=JPRB)::ZTARG
REAL (KIND=JPRB)::ZQSAT
REAL (KIND=JPRB)::ZQMAX
REAL (KIND=JPRB)::ZOEALFA_CUADJTQ000
REAL (KIND=JPRB)::ZFOEEWL
REAL (KIND=JPRB)::ZFOEEWI
REAL (KIND=JPRB)::ZCOR
REAL (KIND=JPRB)::ZCOND1
REAL (KIND=JPRB)::ZCOND
REAL (KIND=JPRB)::Z2S
REAL (KIND=JPRB)::Z1S
REAL (KIND=JPRB)::ZF
REAL (KIND=JPRB)::ZI
REAL (KIND=JPRB)::ZL
LOGICAL::LLFLAG_CUADJTQ000 (KLON)
#include "abor1.intfb.h"
#include "cuadjtq.func.h"
REAL (KIND=JPRB)::ZOEALFA_CUADJTQ001
LOGICAL::LLFLAG_CUADJTQ001 (KLON)
REAL (KIND=JPRB)::ZORCPD_CUBASMCN
REAL (KIND=JPRB)::ZRG_CUBASMCN
REAL (KIND=JPRB)::ZZZMB
LOGICAL::LLO1_CUENTR
LOGICAL::LLPERT_DETRPEN
INTEGER (KIND=JPIM)::IPDETRPEN
INTEGER (KIND=JPIM)::IPN_CUENTR
TYPE (SPP_PERT)::PN1
REAL (KIND=JPRB)::ZXDETRPEN
REAL (KIND=JPRB)::ZRG_CUENTR
REAL (KIND=JPRB)::ZMF
REAL (KIND=JPRB)::ZENTR (KLON)
REAL (KIND=JPRB)::ZDZ
TYPE (FXTRAN_ACDC_STACK) :: YLSTACK

!$ACC DATA &
!$ACC&CREATE (LLFLAG, LLFLAGUV, LLFLAG_CUADJTQ000, LLFLAG_CUADJTQ001, LLKLAB, &
!$ACC&        LLO1, ZBUO, ZDMFDE, ZDMFEN, ZDPMEAN, ZENTR, ZLUOLD, ZOENTR, ZPH, ZPRECIP, &
!$ACC&        ZQOLD) &
!$ACC&IF (LDACC) &
!$ACC&PRESENT (KCBOT, KCTOP, KCTOP0, KDPL, KLAB, KTYPE, LDCUM, LDLAND, LSCVFLAG, PAP, &
!$ACC&         PAPH, PDMFEN, PDMFUP, PGEO, PGEOH, PGP2DSPP, PKINEU, PLCRIT_AER, PLGLAC, &
!$ACC&         PLITOT, PLRAIN, PLU, PLUDE, PLUDELI, PMFU, PMFUB, PMFUDE_RATE, PMFUL, &
!$ACC&         PMFUQ, PMFUS, PQEN, PQENH, PQSEN, PQU, PTEN, PTENH, PTU, PUEN, PVEN, PVERVEL, &
!$ACC&         PWMEAN, PWU, PWUBASE, YDCST, YDECLDP, YDECUMF, YDEPHLI, YDSPP_CONFIG, &
!$ACC&         YDTHF, YGFL) 

#ifdef __PGI
CALL NVTXSTARTRANGE ('CUASCN_SINGLEBLOCK')
#endif

ZCONS2=YDECUMF%RMFCFL/(YDCST%RG*PTSPHY)
ZRG=1.0_JPRB/YDCST%RG
ZORCPD=1.0_JPRB/YDCST%RCPD
ZFACBUO=0.5_JPRB/1.5
ZPRCDGW=YDECUMF%RPRCON/YDCST%RG
ZDNOPRC=3.E-4_JPRB
Z_CLDMAX=5.E-3_JPRB
Z_CWIFRAC=0.5_JPRB
Z_CPRC2=0.5_JPRB
Z_CWDRAG=(3._JPRB/8._JPRB)*0.506_JPRB/0.2_JPRB

IF (YDECUMF%LMFGLAC) THEN
  ZGLAC=1.0_JPRB
ELSE
  ZGLAC=0.0_JPRB
ENDIF

LLO3=.FALSE.

!$ACC PARALLEL LOOP GANG VECTOR &
!$ACC&IF (LDACC) &
!$ACC&PRIVATE (JL, LLPERT_ENTRORG, LLPERT_ENTSHALP, LLPERT_RPRCON) 


DO JL = KIDIA, KFDIA
  
  
  ZLUOLD (JL)=0.0_JPRB

  IF (.NOT.LDCUM (JL)) THEN
    KCBOT (JL)=-1
    PMFUB (JL)=0.0_JPRB
    PQU (JL, KLEV)=0.0_JPRB
    KTYPE (JL)=0
  ENDIF

  PWMEAN (JL)=0.0_JPRB
  ZDPMEAN (JL)=0.0_JPRB
  ZOENTR (JL)=0.0_JPRB
  LSCVFLAG (JL)=.FALSE.

  IF (KTYPE (JL)>1.AND.YDECUMF%LSCVLIQ)  THEN
    LSCVFLAG (JL)=.TRUE.
  ENDIF

  
  
  LLPERT_ENTRORG=.FALSE.
  LLPERT_ENTSHALP=.FALSE.
  LLPERT_RPRCON=.FALSE.
  
  
  LLKLAB (JL)=.FALSE.

  IF (.NOT.LDCUM (JL).OR.KTYPE (JL)==3)  THEN
    LLKLAB (JL)=.TRUE.
  ENDIF

  
ENDDO


!$ACC PARALLEL LOOP GANG VECTOR &
!$ACC&IF (LDACC) &
!$ACC&PRIVATE (IKB, JK, JL) 


DO JL = KIDIA, KFDIA

  

  DO JK=1, KLEV

    

    IF (JK/=KCBOT (JL)) THEN
      PLU (JL, JK)=0.0_JPRB
    ENDIF

    PKINEU (JL, JK)=0.0_JPRB
    
    
    PMFU (JL, JK)=0.0_JPRB
    PMFUS (JL, JK)=0.0_JPRB
    PMFUQ (JL, JK)=0.0_JPRB
    PMFUL (JL, JK)=0.0_JPRB
    PWU (JL, JK)=0.0_JPRB
    
    
    PLUDE (JL, JK)=0.0_JPRB
    PLUDELI (JL, JK, 1)=0.0_JPRB
    PLUDELI (JL, JK, 2)=0.0_JPRB
    PLGLAC (JL, JK)=0.0_JPRB
    PDMFUP (JL, JK)=0.0_JPRB
    PLRAIN (JL, JK)=0.0_JPRB
    
    
    ZBUO (JL, JK)=0.0_JPRB

    IF (LLKLAB (JL))  THEN
      KLAB (JL, JK)=0
    ENDIF


    IF (.NOT.LDCUM (JL).AND.PAPH (JL, JK)<4.E4_JPRB)  THEN
      KCTOP0 (JL)=JK
    ENDIF

    PDMFEN (JL, JK)=0.0_JPRB
    PMFUDE_RATE (JL, JK)=0.0_JPRB
  
  ENDDO


  

  IF (KTYPE (JL)==3)  THEN
    LDCUM (JL)=.FALSE.
  ENDIF

  
  
  KCTOP (JL)=KCBOT (JL)

  IF (LDCUM (JL)) THEN
    IKB=KCBOT (JL)
    PKINEU (JL, IKB)=0.5*PWUBASE (JL)**2
    PMFU (JL, IKB)=PMFUB (JL)
    PMFUS (JL, IKB)=PMFUB (JL)*(YDCST%RCPD*PTU (JL, IKB)+PGEOH (JL, IKB))
    PMFUQ (JL, IKB)=PMFUB (JL)*PQU (JL, IKB)
    PMFUL (JL, IKB)=PMFUB (JL)*PLU (JL, IKB)
  ENDIF

  
ENDDO


!$ACC PARALLEL LOOP GANG VECTOR &
!$ACC&IF (LDACC) &
!$ACC&PRIVATE (IK, IKB, IS, JK, JL, LLO1_CUENTR, LLO3, LLPERT_DETRPEN, Z1S, Z2S, ZALFAW, &
!$ACC&         ZBC, ZBE, ZBUOC, ZC, ZCBF, ZCHANGE, ZCOND, ZCOND1, ZCOR, ZD, ZDFI, ZDKBUO, &
!$ACC&         ZDKEN, ZDT, ZDZ, ZF, ZFAC, ZFOEEWI, ZFOEEWL, ZI, ZINT, ZKEDKE, ZL, ZLCRIT, &
!$ACC&         ZLEEN, ZLNEW, ZMF, ZMFMAX, ZMFTEST, ZMFULK, ZMFUN, ZMFUQK, ZMFUSK, ZOCUDET, &
!$ACC&         ZOEALFA, ZOEALFAP, ZOEALFA_CUADJTQ001, ZORCPD_CUBASMCN, ZPRCON, &
!$ACC&         ZQEEN, ZQMAX, ZQP, ZQSAT, ZQUDE, ZRG_CUBASMCN, ZRG_CUENTR, ZRNEW, ZROLD, &
!$ACC&         ZSCDE, ZSEEN, ZTARG, ZVI, ZVV, ZVW, ZXDETRPEN, ZXE, ZXENTRORG, ZXENTSHALP, &
!$ACC&         ZXPRCDGW, ZXS, ZZCO, ZZZMB) 


DO JL = KIDIA, KFDIA

  

  DO JK=KLEV-1, 3,-1
    IK=JK
    
    
    ZRG_CUBASMCN=1.0_JPRB/YDCST%RG
    ZORCPD_CUBASMCN=1.0_JPRB/YDCST%RCPD

    

    IF (.NOT.LDCUM (JL).AND.KLAB (JL, IK+1)==0) THEN

      IF (YDECUMF%LMFMID.AND.IK>YDECUMF%NJKT7.AND.PQEN (JL, IK)>0.80_JPRB*PQSEN (JL, IK)) THEN
        PTU (JL, IK+1)=(YDCST%RCPD*PTEN (JL, IK)+PGEO (JL, IK)-PGEOH (JL, IK+1))*ZORCPD_CUBASMCN
        PQU (JL, IK+1)=PQEN (JL, IK)
        PLU (JL, IK+1)=0.0_JPRB
        ZZZMB=MAX (1.E-6_JPRB,-PVERVEL (JL, IK)*ZRG_CUBASMCN)
        ZZZMB=MIN (ZZZMB, YDECUMF%RMFLIA)
        PMFUB (JL)=ZZZMB
        PMFU (JL, IK+1)=PMFUB (JL)
        PMFUS (JL, IK+1)=PMFUB (JL)*(YDCST%RCPD*PTU (JL, IK+1)+PGEOH (JL, IK+1))
        PMFUQ (JL, IK+1)=PMFUB (JL)*PQU (JL, IK+1)
        PMFUL (JL, IK+1)=0.0_JPRB
        PDMFUP (JL, IK+1)=0.0_JPRB
        PLRAIN (JL, IK+1)=0.0_JPRB
        KCBOT (JL)=IK
        KLAB (JL, IK+1)=1
        KTYPE (JL)=3
      ENDIF

    ENDIF

    
    
    
    
    IS=0
    
    LLFLAG (JL)=.FALSE.
    ZPRECIP (JL)=0.0_JPRB
    LLO1 (JL)=.FALSE.
    IS=IS+KLAB (JL, JK+1)

    IF (KLAB (JL, JK+1)==0)  THEN
      KLAB (JL, JK)=0
    ENDIF


    IF ((LDCUM (JL).AND.KLAB (JL, JK+1)==2).OR.(KTYPE (JL)==3.AND.KLAB (JL, JK+1)==1)) THEN
      LLFLAG (JL)=.TRUE.
    ENDIF


    IF (KLAB (JL, JK+1)>0) THEN
      LLFLAGUV (JL)=.TRUE.
    ELSE
      LLFLAGUV (JL)=.FALSE.
    ENDIF

    ZPH (JL)=PAPH (JL, JK)

    IF (KTYPE (JL)==3.AND.JK==KCBOT (JL)) THEN
      ZMFMAX=(PAPH (JL, JK)-PAPH (JL, JK-1))*ZCONS2

      IF (PMFUB (JL)>ZMFMAX) THEN
        ZFAC=ZMFMAX/PMFUB (JL)
        PMFU (JL, JK+1)=PMFU (JL, JK+1)*ZFAC
        PMFUS (JL, JK+1)=PMFUS (JL, JK+1)*ZFAC
        PMFUQ (JL, JK+1)=PMFUQ (JL, JK+1)*ZFAC
        PMFUB (JL)=ZMFMAX
      ENDIF

    ENDIF


    

    IF (IS>0)  THEN
      LLO3=.TRUE.
    ENDIF

    IK=JK

    

    

    IF (LLO3) THEN
      ZRG_CUENTR=1.0_JPRB/YDCST%RG
      
      LLPERT_DETRPEN=.FALSE.
      
      
      ZDMFEN (JL)=0.0_JPRB
      ZDMFDE (JL)=0.0_JPRB
      ZENTR (JL)=0.0

      

      

      IF (LDCUM (JL)) THEN
        ZDZ=(PGEOH (JL, IK)-PGEOH (JL, IK+1))*ZRG_CUENTR
        ZMF=PMFU (JL, IK+1)*ZDZ
        LLO1_CUENTR=IK<KCBOT (JL)

        IF (LLO1_CUENTR) THEN
          
          ZXDETRPEN=YDECUMF%DETRPEN
          
          ZDMFEN (JL)=ZENTR (JL)*ZMF
          ZDMFDE (JL)=ZXDETRPEN*ZMF
        ENDIF

      ENDIF

    
    ENDIF


    

    

    

    IF (LLO3) THEN
      
      ZQOLD (JL)=0.0_JPRB

      

      

      IF (LLFLAG (JL)) THEN
        ZDMFDE (JL)=MIN (ZDMFDE (JL), 0.75_JPRB*PMFU (JL, JK+1))

        IF (JK==KCBOT (JL)) THEN
          
          ZXENTRORG=YDECUMF%ENTRORG
          
          ZOENTR (JL)=-ZXENTRORG*(MIN (1.0_JPRB, PQEN (JL, JK)/PQSEN (JL,&
          & JK))-YDECUMF%ENTR_RH)*(PGEOH (JL, JK)-PGEOH (JL, JK+1))*ZRG
          ZOENTR (JL)=MIN (0.4_JPRB, ZOENTR (JL))*PMFU (JL, JK+1)
        ENDIF


        IF (JK<KCBOT (JL)) THEN
          ZMFMAX=(PAPH (JL, JK)-PAPH (JL, JK-1))*ZCONS2
          ZXS=MAX (PMFU (JL, JK+1)-ZMFMAX, 0.0_JPRB)
          PWMEAN (JL)=PWMEAN (JL)+PKINEU (JL, JK+1)*(PAP (JL, JK+1)-PAP (JL, JK))
          ZDPMEAN (JL)=ZDPMEAN (JL)+PAP (JL, JK+1)-PAP (JL, JK)
          ZDMFEN (JL)=ZOENTR (JL)

          IF (KTYPE (JL)>=2) THEN
            
            ZXENTSHALP=YDECUMF%ENTSHALP
            
            ZDMFEN (JL)=ZXENTSHALP*ZDMFEN (JL)
            ZDMFDE (JL)=ZDMFEN (JL)
          ENDIF

          ZDMFDE (JL)=ZDMFDE (JL)*(1.6_JPRB-MIN (1.0_JPRB, PQEN (JL, JK)/PQSEN (JL, JK)))
          ZMFTEST=PMFU (JL, JK+1)+ZDMFEN (JL)-ZDMFDE (JL)
          ZCHANGE=MAX (ZMFTEST-ZMFMAX, 0.0_JPRB)
          ZXE=MAX (ZCHANGE-ZXS, 0.0_JPRB)
          ZDMFEN (JL)=ZDMFEN (JL)-ZXE
          ZCHANGE=ZCHANGE-ZXE
          ZDMFDE (JL)=ZDMFDE (JL)+ZCHANGE
        ENDIF

        PDMFEN (JL, JK)=ZDMFEN (JL)-ZDMFDE (JL)
        PMFU (JL, JK)=PMFU (JL, JK+1)+ZDMFEN (JL)-ZDMFDE (JL)
        ZQEEN=PQENH (JL, JK+1)*ZDMFEN (JL)
        ZSEEN=(YDCST%RCPD*PTENH (JL, JK+1)+PGEOH (JL, JK+1))*ZDMFEN (JL)

        IF (PLITOT (JL, JK)>YDECLDP%RLMIN) THEN
          ZLEEN=PLITOT (JL, JK)*ZDMFEN (JL)
        ELSE
          ZLEEN=0.0_JPRB
        ENDIF

        ZSCDE=(YDCST%RCPD*PTU (JL, JK+1)+PGEOH (JL, JK+1))*ZDMFDE (JL)
        ZQUDE=PQU (JL, JK+1)*ZDMFDE (JL)
        PLUDE (JL, JK)=PLU (JL, JK+1)*ZDMFDE (JL)
        ZMFUSK=PMFUS (JL, JK+1)+ZSEEN-ZSCDE
        ZMFUQK=PMFUQ (JL, JK+1)+ZQEEN-ZQUDE
        ZMFULK=PMFUL (JL, JK+1)+ZLEEN-PLUDE (JL, JK)
        ZFAC=1.0_JPRB/MAX (YDECUMF%RMFCMIN, PMFU (JL, JK))
        PLU (JL, JK)=ZMFULK*ZFAC
        PQU (JL, JK)=ZMFUQK*ZFAC
        PTU (JL, JK)=(ZMFUSK*ZFAC-PGEOH (JL, JK))*ZORCPD
        PTU (JL, JK)=MAX (100._JPRB, PTU (JL, JK))
        PTU (JL, JK)=MIN (400._JPRB, PTU (JL, JK))
        ZQOLD (JL)=PQU (JL, JK)
        PLRAIN (JL, JK)=PLRAIN (JL, JK+1)*MAX (0.0_JPRB, PMFU (JL, JK+1)-ZDMFDE (JL))*ZFAC
        ZLUOLD (JL)=PLU (JL, JK)
      ENDIF


      

      

      IF (JK>KDPL (JL)) THEN
        PTU (JL, JK)=PTENH (JL, JK)
        PQU (JL, JK)=PQENH (JL, JK)
        PLU (JL, JK)=0.0_JPRB
        ZLUOLD (JL)=PLU (JL, JK)
      ENDIF

      
      IK=JK

      IF (YDECUMF%LSCVLIQ) THEN
        
        
        ZQMAX=0.5_JPRB

        IF (.NOT.YDEPHLI%LPHYLIN) THEN
          
          LLFLAG_CUADJTQ000 (JL)=LLFLAG (JL)
          
          
          LLFLAG_CUADJTQ000 (JL)=LLFLAG_CUADJTQ000 (JL).AND..NOT.LSCVFLAG (JL)

          

          

          

          IF (LLFLAG_CUADJTQ000 (JL)) THEN
            ZQP=1.0_JPRB/ZPH (JL)
            ZL=1.0_JPRB/(PTU (JL, IK)-YDTHF%R4LES)
            ZI=1.0_JPRB/(PTU (JL, IK)-YDTHF%R4IES)
            ZQSAT=YDTHF%R2ES*(FOEALFCU (PTU (JL, IK))*EXP (YDTHF%R3LES*(PTU (JL, IK)-YDCST%RTT)*ZL&
            &)+(1.0_JPRB-FOEALFCU (PTU (JL, IK)))*EXP (YDTHF%R3IES*(PTU (JL, IK)-YDCST%RTT)*ZI))
            ZQSAT=ZQSAT*ZQP
            ZQSAT=MIN (0.5_JPRB, ZQSAT)
            ZCOR=1.0_JPRB-YDCST%RETV*ZQSAT
            ZF=FOEALFCU (PTU (JL, IK))*YDTHF%R5ALVCP*ZL**2+(1.0_JPRB&
            &-FOEALFCU (PTU (JL, IK)))*YDTHF%R5ALSCP*ZI**2
            ZCOND=(PQU (JL, IK)*ZCOR**2-ZQSAT*ZCOR)/(ZCOR**2+ZQSAT*ZF)
            ZCOND=MAX (ZCOND, 0.0_JPRB)
            PTU (JL, IK)=PTU (JL, IK)+FOELDCPMCU (PTU (JL, IK))*ZCOND
            PQU (JL, IK)=PQU (JL, IK)-ZCOND
            ZL=1.0_JPRB/(PTU (JL, IK)-YDTHF%R4LES)
            ZI=1.0_JPRB/(PTU (JL, IK)-YDTHF%R4IES)
            ZQSAT=YDTHF%R2ES*(FOEALFCU (PTU (JL, IK))*EXP (YDTHF%R3LES*(PTU (JL, IK)-YDCST%RTT)*ZL&
            &)+(1.0_JPRB-FOEALFCU (PTU (JL, IK)))*EXP (YDTHF%R3IES*(PTU (JL, IK)-YDCST%RTT)*ZI))
            ZQSAT=ZQSAT*ZQP
            ZQSAT=FMINJ (0.5_JPRB, ZQSAT)
            ZCOR=1.0_JPRB-YDCST%RETV*ZQSAT
            ZF=FOEALFCU (PTU (JL, IK))*YDTHF%R5ALVCP*ZL**2+(1.0_JPRB&
            &-FOEALFCU (PTU (JL, IK)))*YDTHF%R5ALSCP*ZI**2
            ZCOND1=(PQU (JL, IK)*ZCOR**2-ZQSAT*ZCOR)/(ZCOR**2+ZQSAT*ZF)

            IF (ZCOND==0.0_JPRB)  THEN
              ZCOND1=0.0_JPRB
            ENDIF

            PTU (JL, IK)=PTU (JL, IK)+FOELDCPMCU (PTU (JL, IK))*ZCOND1
            PQU (JL, IK)=PQU (JL, IK)-ZCOND1
          ENDIF


          

          

          

          IF (LLFLAG (JL).AND.LSCVFLAG (JL)) THEN
            ZQP=1.0_JPRB/ZPH (JL)
            ZL=1.0_JPRB/(PTU (JL, IK)-YDTHF%R4LES)
            ZQSAT=YDTHF%R2ES*EXP (YDTHF%R3LES*(PTU (JL, IK)-YDCST%RTT)*ZL)
            ZQSAT=ZQSAT*ZQP
            ZQSAT=MIN (0.5_JPRB, ZQSAT)
            ZCOR=1.0_JPRB-YDCST%RETV*ZQSAT
            ZF=YDTHF%R5ALVCP*ZL**2
            ZCOND=(PQU (JL, IK)*ZCOR**2-ZQSAT*ZCOR)/(ZCOR**2+ZQSAT*ZF)
            ZCOND=MAX (ZCOND, 0.0_JPRB)
            PTU (JL, IK)=PTU (JL, IK)+YDTHF%RALVDCP*ZCOND
            PQU (JL, IK)=PQU (JL, IK)-ZCOND
            ZL=1.0_JPRB/(PTU (JL, IK)-YDTHF%R4LES)
            ZQSAT=YDTHF%R2ES*EXP (YDTHF%R3LES*(PTU (JL, IK)-YDCST%RTT)*ZL)
            ZQSAT=ZQSAT*ZQP
            ZQSAT=FMINJ (0.5_JPRB, ZQSAT)
            ZCOR=1.0_JPRB-YDCST%RETV*ZQSAT
            ZF=YDTHF%R5ALVCP*ZL**2
            ZCOND1=(PQU (JL, IK)*ZCOR**2-ZQSAT*ZCOR)/(ZCOR**2+ZQSAT*ZF)

            IF (ZCOND==0.0_JPRB)  THEN
              ZCOND1=0.0_JPRB
            ENDIF

            PTU (JL, IK)=PTU (JL, IK)+YDTHF%RALVDCP*ZCOND1
            PQU (JL, IK)=PQU (JL, IK)-ZCOND1
          ENDIF

        
        
        
        
        
        
        
        
        ELSE
        
        
        
        
        ENDIF

      
      
      
      ELSE
        
        
        ZQMAX=0.5_JPRB

        IF (.NOT.YDEPHLI%LPHYLIN) THEN
          
          LLFLAG_CUADJTQ001 (JL)=LLFLAG (JL)

          

          

          IF (LLFLAG_CUADJTQ001 (JL)) THEN
            ZQP=1.0_JPRB/ZPH (JL)
            ZL=1.0_JPRB/(PTU (JL, IK)-YDTHF%R4LES)
            ZI=1.0_JPRB/(PTU (JL, IK)-YDTHF%R4IES)
            ZQSAT=YDTHF%R2ES*(FOEALFCU (PTU (JL, IK))*EXP (YDTHF%R3LES*(PTU (JL, IK)-YDCST%RTT)*ZL&
            &)+(1.0_JPRB-FOEALFCU (PTU (JL, IK)))*EXP (YDTHF%R3IES*(PTU (JL, IK)-YDCST%RTT)*ZI))
            ZQSAT=ZQSAT*ZQP
            ZQSAT=MIN (0.5_JPRB, ZQSAT)
            ZCOR=1.0_JPRB-YDCST%RETV*ZQSAT
            ZF=FOEALFCU (PTU (JL, IK))*YDTHF%R5ALVCP*ZL**2+(1.0_JPRB&
            &-FOEALFCU (PTU (JL, IK)))*YDTHF%R5ALSCP*ZI**2
            ZCOND=(PQU (JL, IK)*ZCOR**2-ZQSAT*ZCOR)/(ZCOR**2+ZQSAT*ZF)
            ZCOND=MAX (ZCOND, 0.0_JPRB)
            PTU (JL, IK)=PTU (JL, IK)+FOELDCPMCU (PTU (JL, IK))*ZCOND
            PQU (JL, IK)=PQU (JL, IK)-ZCOND
            ZL=1.0_JPRB/(PTU (JL, IK)-YDTHF%R4LES)
            ZI=1.0_JPRB/(PTU (JL, IK)-YDTHF%R4IES)
            ZQSAT=YDTHF%R2ES*(FOEALFCU (PTU (JL, IK))*EXP (YDTHF%R3LES*(PTU (JL, IK)-YDCST%RTT)*ZL&
            &)+(1.0_JPRB-FOEALFCU (PTU (JL, IK)))*EXP (YDTHF%R3IES*(PTU (JL, IK)-YDCST%RTT)*ZI))
            ZQSAT=ZQSAT*ZQP
            ZQSAT=FMINJ (0.5_JPRB, ZQSAT)
            ZCOR=1.0_JPRB-YDCST%RETV*ZQSAT
            ZF=FOEALFCU (PTU (JL, IK))*YDTHF%R5ALVCP*ZL**2+(1.0_JPRB&
            &-FOEALFCU (PTU (JL, IK)))*YDTHF%R5ALSCP*ZI**2
            ZCOND1=(PQU (JL, IK)*ZCOR**2-ZQSAT*ZCOR)/(ZCOR**2+ZQSAT*ZF)

            IF (ZCOND==0.0_JPRB)  THEN
              ZCOND1=0.0_JPRB
            ENDIF

            PTU (JL, IK)=PTU (JL, IK)+FOELDCPMCU (PTU (JL, IK))*ZCOND1
            PQU (JL, IK)=PQU (JL, IK)-ZCOND1
          ENDIF

        
        
        
        
        
        
        
        
        ELSE

          

          

          IF (LLFLAG (JL)) THEN
            ZQP=1.0_JPRB/ZPH (JL)
            ZTARG=PTU (JL, IK)
            ZOEALFA_CUADJTQ001=0.5_JPRB*(TANH (YDEPHLI%RLPAL1*(ZTARG-YDEPHLI%RLPTRC))+1.0_JPRB)
            ZFOEEWL=YDTHF%R2ES*EXP (YDTHF%R3LES*(ZTARG-YDCST%RTT)/(ZTARG-YDTHF%R4LES))
            ZFOEEWI=YDTHF%R2ES*EXP (YDTHF%R3IES*(ZTARG-YDCST%RTT)/(ZTARG-YDTHF%R4IES))
            ZQSAT=ZQP*(ZOEALFA_CUADJTQ001*ZFOEEWL+(1.0_JPRB-ZOEALFA_CUADJTQ001)*ZFOEEWI)
            Z1S=TANH (YDEPHLI%RLPAL2*(ZQSAT-ZQMAX))
            ZQSAT=0.5_JPRB*((1.0_JPRB-Z1S)*ZQSAT+(1.0_JPRB+Z1S)*ZQMAX)
            ZCOR=1.0_JPRB/(1.0_JPRB-YDCST%RETV*ZQSAT)
            ZQSAT=ZQSAT*ZCOR
            Z2S=ZOEALFA_CUADJTQ001*YDTHF%R5ALVCP*(1.0_JPRB/(ZTARG-YDTHF%R4LES)**2)+(1.0_JPRB&
            &-ZOEALFA_CUADJTQ001)*YDTHF%R5ALSCP*(1.0_JPRB/(ZTARG-YDTHF%R4IES)**2)
            ZCOND=(PQU (JL, IK)-ZQSAT)/(1.0_JPRB+ZQSAT*ZCOR*Z2S)
            ZCOND=MAX (ZCOND, 0.0_JPRB)

            IF (ZCOND/=0.0_JPRB) THEN
              PTU (JL, IK)=PTU (JL, IK)+(ZOEALFA_CUADJTQ001*YDTHF%RALVDCP&
              &+(1.0_JPRB-ZOEALFA_CUADJTQ001)*YDTHF%RALSDCP)*ZCOND
              PQU (JL, IK)=PQU (JL, IK)-ZCOND
              ZTARG=PTU (JL, IK)
              ZOEALFA_CUADJTQ001=0.5_JPRB*(TANH (YDEPHLI%RLPAL1*(ZTARG-YDEPHLI%RLPTRC))+1.0_JPRB)
              ZFOEEWL=YDTHF%R2ES*EXP (YDTHF%R3LES*(ZTARG-YDCST%RTT)/(ZTARG-YDTHF%R4LES))
              ZFOEEWI=YDTHF%R2ES*EXP (YDTHF%R3IES*(ZTARG-YDCST%RTT)/(ZTARG-YDTHF%R4IES))
              ZQSAT=ZQP*(ZOEALFA_CUADJTQ001*ZFOEEWL+(1.0_JPRB-ZOEALFA_CUADJTQ001)*ZFOEEWI)
              Z1S=TANH (YDEPHLI%RLPAL2*(ZQSAT-ZQMAX))
              ZQSAT=0.5_JPRB*((1.0_JPRB-Z1S)*ZQSAT+(1.0_JPRB+Z1S)*ZQMAX)
              ZCOR=1.0_JPRB/(1.0_JPRB-YDCST%RETV*ZQSAT)
              ZQSAT=ZQSAT*ZCOR
              Z2S=ZOEALFA_CUADJTQ001*YDTHF%R5ALVCP*(1.0_JPRB/(ZTARG-YDTHF%R4LES)**2)+(1.0_JPRB&
              &-ZOEALFA_CUADJTQ001)*YDTHF%R5ALSCP*(1.0_JPRB/(ZTARG-YDTHF%R4IES)**2)
              ZCOND1=(PQU (JL, IK)-ZQSAT)/(1.0_JPRB+ZQSAT*ZCOR*Z2S)
              PTU (JL, IK)=PTU (JL, IK)+(ZOEALFA_CUADJTQ001*YDTHF%RALVDCP&
              &+(1.0_JPRB-ZOEALFA_CUADJTQ001)*YDTHF%RALSDCP)*ZCOND1
              PQU (JL, IK)=PQU (JL, IK)-ZCOND1
            ENDIF

          ENDIF

        
        
        
        
        
        ENDIF

      
      
      
      ENDIF


      IF (YDEPHLI%LPHYLIN) THEN

        

        IF (LLFLAG (JL)) THEN

          IF (PQU (JL, JK)/=ZQOLD (JL)) THEN
            ZOEALFA=MIN (1.0_JPRB, 0.545_JPRB*(TANH (0.17_JPRB*(PTU (JL, JK)-YDEPHLI%RLPTRC))+1.0_JPRB))
            ZOEALFAP=MIN (1.0_JPRB, 0.545_JPRB*(TANH (0.17_JPRB*(PTU (JL, JK+1)-YDEPHLI%RLPTRC))+1.0_JPRB))
            PLGLAC (JL, JK)=PLU (JL, JK)*((1.0_JPRB-ZOEALFA)-(1.0_JPRB-ZOEALFAP))
            ZFAC=0.545_JPRB*(TANH (0.17_JPRB*(PTEN (JL, JK)-YDEPHLI%RLPTRC))+1.0_JPRB)
            PLGLAC (JL, JK)=PLGLAC (JL, JK)+ZFAC*PDMFUP (JL, JK+1)/MAX (YDECUMF%RMFCMIN, PMFU&
            & (JL, JK+1))*(0.5_JPRB+SIGN (0.5_JPRB, YDCST%RTT-PTEN (JL, JK)))*ZGLAC
            PTU (JL, JK)=PTU (JL, JK)+YDTHF%RALFDCP*PLGLAC (JL, JK)
          ENDIF

        ENDIF

      
      ELSE

        

        IF (LLFLAG (JL)) THEN

          IF (PQU (JL, JK)/=ZQOLD (JL)) THEN
            PLGLAC (JL, JK)=PLU (JL, JK)*((1.0_JPRB-FOEALFCU (PTU&
            & (JL, JK)))-(1.0_JPRB-FOEALFCU (PTU (JL, JK+1))))

            IF (LSCVFLAG (JL))  THEN
              PLGLAC (JL, JK)=0.0_JPRB
            ENDIF

            ZFAC=FOEALFCU (PTEN (JL, JK))
            PLGLAC (JL, JK)=PLGLAC (JL, JK)+ZFAC*PDMFUP (JL, JK+1)/MAX (YDECUMF%RMFCMIN, PMFU&
            & (JL, JK+1))*(0.5_JPRB+SIGN (0.5_JPRB, YDCST%RTT-PTEN (JL, JK)))*ZGLAC
            PTU (JL, JK)=PTU (JL, JK)+YDTHF%RALFDCP*PLGLAC (JL, JK)
          ENDIF

        ENDIF

      
      ENDIF


      

      IF (LLFLAG (JL)) THEN

        IF (PQU (JL, JK)/=ZQOLD (JL)) THEN
          KLAB (JL, JK)=2
          PLU (JL, JK)=PLU (JL, JK)+ZQOLD (JL)-PQU (JL, JK)
          ZBC=PTU (JL, JK)*(1.0_JPRB+YDCST%RETV*PQU (JL, JK)-PLU (JL, JK+1)-PLRAIN (JL, JK+1))
          ZBE=PTENH (JL, JK)*(1.0_JPRB+YDCST%RETV*PQENH (JL, JK))
          ZBUO (JL, JK)=ZBC-ZBE

          IF (KTYPE (JL)==3.AND.KLAB (JL, JK+1)==1) THEN

            IF (ZBUO (JL, JK)>-0.5_JPRB) THEN
              LDCUM (JL)=.TRUE.
              KCTOP (JL)=JK
              PKINEU (JL, JK)=0.5_JPRB
            ELSE
              KLAB (JL, JK)=0
              PMFU (JL, JK)=0.0_JPRB
              PLUDE (JL, JK)=0.0_JPRB
              PLU (JL, JK)=0.0_JPRB
            ENDIF

          ENDIF


          IF (KLAB (JL, JK+1)==2) THEN

            IF (ZBUO (JL, JK)<-0.1_JPRB) THEN
              PTENH (JL, JK)=0.5_JPRB*(PTEN (JL, JK)+PTEN (JL, JK-1))
              PQENH (JL, JK)=0.5_JPRB*(PQEN (JL, JK)+PQEN (JL, JK-1))
              ZBUO (JL, JK)=ZBC-PTENH (JL, JK)*(1.0_JPRB+YDCST%RETV*PQENH (JL, JK))
            ENDIF

            ZBUOC=0.5*(ZBUO (JL, JK)+ZBUO (JL, JK+1))/(PTENH (JL, JK)*(1.0_JPRB+YDCST%RETV*PQENH (JL, JK)))
            ZDKBUO=(PGEOH (JL, JK)-PGEOH (JL, JK+1))*ZFACBUO*ZBUOC

            IF (ZDMFEN (JL)>0.0_JPRB) THEN
              ZDKEN=MIN (1.0_JPRB,(1+Z_CWDRAG)*ZDMFEN (JL)/MAX (YDECUMF%RMFCMIN, PMFU (JL, JK+1)))
            ELSE
              ZDKEN=MIN (1.0_JPRB,(1+Z_CWDRAG)*ZDMFDE (JL)/MAX (YDECUMF%RMFCMIN, PMFU (JL, JK+1)))
            ENDIF


            IF (LDTDKMF) THEN
              PKINEU (JL, JK)=(PKINEU (JL, JK+1)*(1-ZDKEN)+ZDKBUO)/(1+ZDKEN)
              ZBUOC=ZBUO (JL, JK)
            ELSE
              PKINEU (JL, JK)=MAX (-1.E3_JPRB,(PKINEU (JL, JK+1)*(1-ZDKEN)+ZDKBUO)/(1+ZDKEN))
            ENDIF


            IF (ZBUOC<0.0_JPRB) THEN
              ZKEDKE=PKINEU (JL, JK)/MAX (1.E-3_JPRB, PKINEU (JL, JK+1))
              ZKEDKE=MAX (0.0_JPRB, MIN (1.0_JPRB, ZKEDKE))
              ZOCUDET=(1.6_JPRB-MIN (1.0_JPRB, PQEN (JL, JK)/PQSEN (JL, JK)))
              ZMFUN=ZOCUDET*SQRT (ZKEDKE)
              ZDMFDE (JL)=MAX (ZDMFDE (JL), PMFU (JL, JK+1)*(1.0_JPRB-ZMFUN))
              PLUDE (JL, JK)=PLU (JL, JK+1)*ZDMFDE (JL)
              PMFU (JL, JK)=PMFU (JL, JK+1)+ZDMFEN (JL)-ZDMFDE (JL)
            ENDIF


            IF (ZBUO (JL, JK)>-0.2_JPRB) THEN
              IKB=KCBOT (JL)
              
              ZXENTRORG=YDECUMF%ENTRORG
              
              ZOENTR (JL)=ZXENTRORG*(0.3_JPRB-(MIN (1.0_JPRB, PQEN (JL, JK-1)/PQSEN (JL, JK-1))-YDECUMF%ENTR_RH&
              &))*(PGEOH (JL, JK-1)-PGEOH (JL, JK))*ZRG*MIN (1.0_JPRB, PQSEN (JL, JK)/PQSEN (JL, IKB))**3
              ZOENTR (JL)=MIN (0.4_JPRB, ZOENTR (JL))*PMFU (JL, JK)
            ELSE
              ZOENTR (JL)=0.0_JPRB
            ENDIF


            IF (JK>KDPL (JL)) THEN
              PMFU (JL, JK)=PMFU (JL, JK+1)
              PKINEU (JL, JK)=0.5_JPRB
            ENDIF


            IF (PKINEU (JL, JK)>0.0_JPRB.AND.PMFU (JL, JK)>0.0_JPRB.AND.(ZBUO (JL, JK)>-2._JPRB.OR.(PTEN&
              & (JL, JK-1)-PTEN (JL, JK))/(ZRG*(PGEO (JL, JK-1)-PGEO (JL, JK)))<-3.E-3_JPRB)) THEN
              KCTOP (JL)=JK
              LLO1 (JL)=.TRUE.
            ELSE
              KLAB (JL, JK)=0
              PMFU (JL, JK)=0.0_JPRB
              PKINEU (JL, JK)=0.0_JPRB
              ZDMFDE (JL)=PMFU (JL, JK+1)
              PLUDE (JL, JK)=PLU (JL, JK+1)*ZDMFDE (JL)
            ENDIF


            IF (PMFU (JL, JK+1)>0.0_JPRB) THEN
              PMFUDE_RATE (JL, JK)=ZDMFDE (JL)
            ENDIF

          ENDIF

        ELSEIF (KTYPE (JL)==2.AND.PQU (JL, JK)==ZQOLD (JL)) THEN
          KLAB (JL, JK)=0
          PMFU (JL, JK)=0.0_JPRB
          PKINEU (JL, JK)=0.0_JPRB
          ZDMFDE (JL)=PMFU (JL, JK+1)
          PLUDE (JL, JK)=PLU (JL, JK+1)*ZDMFDE (JL)
          PMFUDE_RATE (JL, JK)=ZDMFDE (JL)
        ENDIF

      ENDIF


      

      

      IF (LLO1 (JL)) THEN

        IF (PLU (JL, JK)>ZDNOPRC) THEN
          PWU (JL, JK)=MIN (15._JPRB, SQRT (2.0_JPRB*MAX (0.5_JPRB, PKINEU (JL, JK+1))))

          IF (LDTDKMF) THEN
            ZZCO=FOEALFCU (PTU (JL, JK))*1.3_JPRB+(1.0_JPRB-FOEALFCU (PTU (JL, JK)))
          ELSE
            ZZCO=1.0_JPRB+0.3_JPRB*FOEALFCU (PTU (JL, JK))
          ENDIF

          
          ZXPRCDGW=ZPRCDGW
          
          ZPRCON=ZXPRCDGW/(0.75_JPRB*PWU (JL, JK))*ZZCO
          ZDT=MIN (YDTHF%RTBERCU-YDTHF%RTICECU, MAX (YDTHF%RTBERCU-PTU (JL, JK), 0.0_JPRB))
          ZCBF=1+Z_CPRC2*SQRT (ZDT)
          ZZCO=ZPRCON*ZCBF

          IF (YGFL%NACTAERO>0) THEN

            IF (YDECLDP%LAERLIQAUTOCP) THEN
              ZALFAW=FOEALFCU (PTU (JL, JK))
              ZLCRIT=ZALFAW*PLCRIT_AER (JL, JK)+(1.0_JPRB-ZALFAW)*ZDNOPRC
            ELSEIF (YDECLDP%LAERLIQAUTOCPB) THEN
              ZALFAW=FOEALFCU (PTU (JL, JK))
              ZLCRIT=ZALFAW*PLCRIT_AER (JL, KCBOT (JL))+(1.0_JPRB-ZALFAW)*ZDNOPRC
            ELSE
              ZLCRIT=ZDNOPRC/ZCBF
            ENDIF

          ELSE
            ZLCRIT=ZDNOPRC/ZCBF
          ENDIF

          ZDFI=PGEOH (JL, JK)-PGEOH (JL, JK+1)
          ZC=(PLU (JL, JK)-ZLUOLD (JL))
          ZD=ZZCO*(1.0_JPRB-EXP (-(PLU (JL, JK)/ZLCRIT)**2))*ZDFI
          ZINT=EXP (-ZD)
          ZLNEW=ZLUOLD (JL)*ZINT+ZC/ZD*(1.0_JPRB-ZINT)
          ZLNEW=MAX (0.0_JPRB, MIN (PLU (JL, JK), ZLNEW))
          ZLNEW=MIN (Z_CLDMAX, ZLNEW)
          ZPRECIP (JL)=MAX (0.0_JPRB, ZLUOLD (JL)+ZC-ZLNEW)
          PDMFUP (JL, JK)=ZPRECIP (JL)*PMFU (JL, JK)
          PLRAIN (JL, JK)=PLRAIN (JL, JK)+ZPRECIP (JL)
          PLU (JL, JK)=ZLNEW
        ENDIF

      ENDIF


      

      IF (YDEPHLI%LPHYLIN) THEN

        

        IF (LLO1 (JL)) THEN

          IF (PLRAIN (JL, JK)>0.0_JPRB) THEN
            ZVW=21.18_JPRB*PLRAIN (JL, JK)**0.2_JPRB
            ZVI=Z_CWIFRAC*ZVW
            ZALFAW=MIN (1.0_JPRB, 0.545_JPRB*(TANH (0.17_JPRB*(PTU (JL, JK)-YDEPHLI%RLPTRC))+1.0_JPRB))
            ZVV=ZALFAW*ZVW+(1.0_JPRB-ZALFAW)*ZVI
            ZROLD=PLRAIN (JL, JK)-ZPRECIP (JL)
            ZC=ZPRECIP (JL)
            PWU (JL, JK)=MIN (15._JPRB, SQRT (2.0_JPRB*MAX (0.1_JPRB, PKINEU (JL, JK))))
            ZD=ZVV/PWU (JL, JK)
            ZINT=EXP (-ZD)
            ZRNEW=ZROLD*ZINT+ZC/ZD*(1.0_JPRB-ZINT)
            ZRNEW=MAX (0.0_JPRB, MIN (PLRAIN (JL, JK), ZRNEW))
            PLRAIN (JL, JK)=ZRNEW
          ENDIF

        ENDIF

      
      ELSE

        

        IF (LLO1 (JL)) THEN

          IF (PLRAIN (JL, JK)>0.0_JPRB) THEN
            ZVW=21.18_JPRB*PLRAIN (JL, JK)**0.2_JPRB
            ZVI=Z_CWIFRAC*ZVW
            ZALFAW=FOEALFCU (PTU (JL, JK))

            IF (LSCVFLAG (JL))  THEN
              ZALFAW=1.0_JPRB
            ENDIF

            ZVV=ZALFAW*ZVW+(1.0_JPRB-ZALFAW)*ZVI
            ZROLD=PLRAIN (JL, JK)-ZPRECIP (JL)
            ZC=ZPRECIP (JL)
            PWU (JL, JK)=MIN (15._JPRB, SQRT (2.0_JPRB*MAX (0.1_JPRB, PKINEU (JL, JK))))
            ZD=ZVV/PWU (JL, JK)
            ZINT=EXP (-ZD)
            ZRNEW=ZROLD*ZINT+ZC/ZD*(1.0_JPRB-ZINT)
            ZRNEW=MAX (0.0_JPRB, MIN (PLRAIN (JL, JK), ZRNEW))
            PLRAIN (JL, JK)=ZRNEW
          ENDIF

        ENDIF

      
      ENDIF


      

      IF (LLFLAG (JL)) THEN
        PMFUL (JL, JK)=PLU (JL, JK)*PMFU (JL, JK)
        PMFUS (JL, JK)=(YDCST%RCPD*PTU (JL, JK)+PGEOH (JL, JK))*PMFU (JL, JK)
        PMFUQ (JL, JK)=PQU (JL, JK)*PMFU (JL, JK)
        ZALFAW=FOEALFCU (PTU (JL, JK))

        IF (LSCVFLAG (JL))  THEN
          ZALFAW=1.0_JPRB
        ENDIF

        PLUDELI (JL, JK, 1)=ZALFAW*PLUDE (JL, JK)
        PLUDELI (JL, JK, 2)=(1.0_JPRB-ZALFAW)*PLUDE (JL, JK)
      ENDIF

    
    ENDIF

  ENDDO

ENDDO


!$ACC PARALLEL LOOP GANG VECTOR &
!$ACC&IF (LDACC) &
!$ACC&PRIVATE (JL) 


DO JL = KIDIA, KFDIA

  

  

  IF (KCTOP (JL)==-1)  THEN
    LDCUM (JL)=.FALSE.
  ENDIF

  KCBOT (JL)=MAX (KCBOT (JL), KCTOP (JL))

  IF (LDCUM (JL)) THEN
    PWMEAN (JL)=MAX (1.E-2_JPRB, PWMEAN (JL)/MAX (1.0_JPRB, ZDPMEAN (JL)))
    PWMEAN (JL)=SQRT (2.0_JPRB*PWMEAN (JL))
  ENDIF

  
ENDDO


#ifdef __PGI
CALL NVTXENDRANGE ()
#endif
!$ACC END DATA

ENDSUBROUTINE CUASCN_SINGLEBLOCK
