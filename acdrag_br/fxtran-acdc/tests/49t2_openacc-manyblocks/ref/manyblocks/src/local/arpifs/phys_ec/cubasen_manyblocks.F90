SUBROUTINE CUBASEN_MANYBLOCKS (PPLDARE, PPLRG, YDTHF, YDCST, YDEPHLI, YDECLDP, YDECUMF&
&, YDSPP_CONFIG, KIDIA, KFDIA, KLON, KLEV, KINDEX, LDMIXS, LDTDKMF, PTENH, PQENH, PGEOH&
&, PAPH, PQHFL, PAHFS, PGP2DSPP, PKMFL, PTEN, PQEN, PQSEN, PGEO, PTU, PQU, PLU, PWU2H,&
& PWUBASE, KLAB, LDCUM, LDSC, KCBOT, KBOTSC, KCTOP, KDPL, PCAPE, LDACC, KGPBLKS)
USE YOEPHLI,ONLY:TEPHLI
USE PARKIND1,ONLY:JPIM, JPRB
#ifdef __PGI
USE NVTX, ONLY : NVTXSTARTRANGE, NVTXENDRANGE
#endif
USE YOMCST,ONLY:TCST
USE PARPHY,ONLY:RKAP
USE YOECUMF,ONLY:TECUMF
USE YOECLDP,ONLY:TECLDP
USE YOETHF,ONLY:TTHF
USE SPP_MOD,ONLY:TSPP_CONFIG
USE SPP_GEN_MOD,ONLY:SPP_PERT
USE FXTRAN_ACDC_STACK_MOD
USE FXTRAN_ACDC_ABORT_MOD
#include "fxtran_acdc_stack.h"

IMPLICIT NONE


REAL (KIND=JPRB), INTENT (IN)::PPLDARE
REAL (KIND=JPRB), INTENT (IN)::PPLRG
TYPE (TECLDP), INTENT (IN)::YDECLDP
TYPE (TECUMF), INTENT (IN)::YDECUMF
TYPE (TTHF), INTENT (IN)::YDTHF
TYPE (TCST), INTENT (IN)::YDCST
TYPE (TEPHLI), INTENT (IN)::YDEPHLI
TYPE (TSPP_CONFIG), INTENT (IN)::YDSPP_CONFIG
INTEGER (KIND=JPIM), INTENT (IN)::KLON
INTEGER (KIND=JPIM), INTENT (IN)::KLEV
INTEGER (KIND=JPIM), INTENT (IN)::KIDIA
INTEGER (KIND=JPIM), INTENT (IN)::KFDIA
INTEGER (KIND=JPIM), INTENT (IN)::KINDEX
LOGICAL, INTENT (IN)::LDMIXS
LOGICAL, INTENT (IN)::LDTDKMF
REAL (KIND=JPRB), INTENT (IN)::PTENH (:, :, :) ! (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PQENH (:, :, :) ! (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PGEOH (:, :, :) ! (KLON, KLEV+1)
REAL (KIND=JPRB), INTENT (IN)::PAPH (:, :, :) ! (KLON, KLEV+1)
REAL (KIND=JPRB), INTENT (IN)::PQHFL (:, :, :) ! (KLON, KLEV+1)
REAL (KIND=JPRB), INTENT (IN)::PAHFS (:, :, :) ! (KLON, KLEV+1)
REAL (KIND=JPRB), INTENT (IN)::PGP2DSPP (:, :, :) ! (KLON, YDSPP_CONFIG%SM%NRFTOTAL)
REAL (KIND=JPRB), INTENT (IN)::PKMFL (:, :) ! (KLON)
REAL (KIND=JPRB), INTENT (IN)::PTEN (:, :, :) ! (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PQEN (:, :, :) ! (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PQSEN (:, :, :) ! (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PGEO (:, :, :) ! (KLON, KLEV)
REAL (KIND=JPRB), INTENT (INOUT)::PTU (:, :, :) ! (KLON, KLEV)
REAL (KIND=JPRB), INTENT (INOUT)::PQU (:, :, :) ! (KLON, KLEV)
REAL (KIND=JPRB), INTENT (INOUT)::PLU (:, :, :) ! (KLON, KLEV)
REAL (KIND=JPRB), INTENT (INOUT)::PWU2H (:, :, :) ! (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PWUBASE (:, :) ! (KLON)
INTEGER (KIND=JPIM), INTENT (INOUT)::KLAB (:, :, :) ! (KLON, KLEV)
LOGICAL, INTENT (INOUT)::LDCUM (:, :) ! (KLON)
LOGICAL, INTENT (OUT)::LDSC (:, :) ! (KLON)
INTEGER (KIND=JPIM), INTENT (INOUT)::KCBOT (:, :) ! (KLON)
INTEGER (KIND=JPIM), INTENT (OUT)::KBOTSC (:, :) ! (KLON)
INTEGER (KIND=JPIM), INTENT (OUT)::KCTOP (:, :) ! (KLON)
INTEGER (KIND=JPIM), INTENT (OUT)::KDPL (:, :) ! (KLON)
REAL (KIND=JPRB), INTENT (OUT)::PCAPE (:, :) ! (KLON)
INTEGER, INTENT (IN) :: KGPBLKS
LOGICAL, INTENT (IN) :: LDACC
INTEGER (KIND=JPIM)::IDPL (KLON,KGPBLKS)
INTEGER (KIND=JPIM)::ILAB (KLON, KLEV,KGPBLKS)
INTEGER (KIND=JPIM)::IBOTSC (KLON,KGPBLKS)
INTEGER (KIND=JPIM)::ICBOT (KLON,KGPBLKS)
INTEGER (KIND=JPIM)::ICTOP (KLON,KGPBLKS)
LOGICAL::LLFIRST (KLON,KGPBLKS)
LOGICAL::LLDSC (KLON,KGPBLKS)
LOGICAL::LLDCUM (KLON,KGPBLKS)
LOGICAL::LLDEEP (KLON,KGPBLKS)
LOGICAL::LLGO_ON (KLON,KGPBLKS)
LOGICAL::LL_LDBASE (KLON,KGPBLKS)
LOGICAL::LLRESETJL (KLON,KGPBLKS)
LOGICAL::LLRESET
LOGICAL::LLPERT_ENTSTPC1
LOGICAL::LLPERT_ENTRORG
INTEGER (KIND=JPIM)::JKB
INTEGER (KIND=JPIM)::JKT
INTEGER (KIND=JPIM)::JKT2
INTEGER (KIND=JPIM)::JKT1
INTEGER (KIND=JPIM)::JKK
INTEGER (KIND=JPIM)::JL
INTEGER (KIND=JPIM)::JK
INTEGER (KIND=JPIM)::IS
INTEGER (KIND=JPIM)::IK
INTEGER (KIND=JPIM)::IPENTSTPC1
INTEGER (KIND=JPIM)::IPENTRORG
REAL (KIND=JPRB)::ZWU2H (KLON, KLEV,KGPBLKS)
REAL (KIND=JPRB)::ZBUOH (KLON, KLEV,KGPBLKS)
REAL (KIND=JPRB)::ZSUH (KLON, KLEV,KGPBLKS)
REAL (KIND=JPRB)::ZQENH (KLON, KLEV+1,KGPBLKS)
REAL (KIND=JPRB)::ZSENH (KLON, KLEV+1,KGPBLKS)
REAL (KIND=JPRB)::ZS (KLON, KLEV,KGPBLKS)
REAL (KIND=JPRB)::ZPH (KLON,KGPBLKS)
REAL (KIND=JPRB)::ZQOLD (KLON,KGPBLKS)
REAL (KIND=JPRB)::ZMIX (KLON,KGPBLKS)
REAL (KIND=JPRB)::ZCBASE (KLON,KGPBLKS)
REAL (KIND=JPRB)::ZDZ (KLON,KGPBLKS)
REAL (KIND=JPRB)::ZTU (KLON, KLEV,KGPBLKS)
REAL (KIND=JPRB)::ZQU (KLON, KLEV,KGPBLKS)
REAL (KIND=JPRB)::ZLU (KLON, KLEV,KGPBLKS)
REAL (KIND=JPRB)::ZCAPE (KLON, KLEV,KGPBLKS)
REAL (KIND=JPRB)::ZBUOF
REAL (KIND=JPRB)::ZRHO
REAL (KIND=JPRB)::ZKHVFL
REAL (KIND=JPRB)::ZWS
REAL (KIND=JPRB)::ZUST
REAL (KIND=JPRB)::ZQEXC
REAL (KIND=JPRB)::ZQEX (KLON,KGPBLKS)
REAL (KIND=JPRB)::ZTEXC
REAL (KIND=JPRB)::ZTEX (KLON,KGPBLKS)
REAL (KIND=JPRB)::ZEPS
REAL (KIND=JPRB)::ZTVENH
REAL (KIND=JPRB)::ZTVUH
REAL (KIND=JPRB)::ZLGLAC
REAL (KIND=JPRB)::ZBW
REAL (KIND=JPRB)::ZAW
REAL (KIND=JPRB)::ZQF
REAL (KIND=JPRB)::ZSF
REAL (KIND=JPRB)::ZPDIFFBOT
REAL (KIND=JPRB)::ZPDIFFTOP
REAL (KIND=JPRB)::ZDP
REAL (KIND=JPRB)::ZDTDP
REAL (KIND=JPRB)::ZDQSDT
REAL (KIND=JPRB)::ZESDP
REAL (KIND=JPRB)::ZFAC
REAL (KIND=JPRB)::ZFACI
REAL (KIND=JPRB)::ZFACW
REAL (KIND=JPRB)::ZALFAW
REAL (KIND=JPRB)::ZDQ
REAL (KIND=JPRB)::ZCOR
REAL (KIND=JPRB)::ZQSU
REAL (KIND=JPRB)::ZWORK2
REAL (KIND=JPRB)::ZWORK1
REAL (KIND=JPRB)::ZTMP
REAL (KIND=JPRB)::ZRG
REAL (KIND=JPRB)::ZRCPD
REAL (KIND=JPRB)::ZXENTSTPC1
REAL (KIND=JPRB)::ZXENTRORG
INTEGER (KIND=JPIM)::IPN
TYPE (SPP_PERT)::PN2
TYPE (SPP_PERT)::PN1

#include "fcttre.func.h"
REAL (KIND=JPRB)::ZQP
REAL (KIND=JPRB)::ZTARG
REAL (KIND=JPRB)::ZQSAT
REAL (KIND=JPRB)::ZQMAX
REAL (KIND=JPRB)::ZOEALFA
REAL (KIND=JPRB)::ZFOEEWL
REAL (KIND=JPRB)::ZFOEEWI
REAL (KIND=JPRB)::ZCOR_CUADJTQ
REAL (KIND=JPRB)::ZCOND1
REAL (KIND=JPRB)::ZCOND
REAL (KIND=JPRB)::Z2S
REAL (KIND=JPRB)::Z1S
REAL (KIND=JPRB)::ZF
REAL (KIND=JPRB)::ZI
REAL (KIND=JPRB)::ZL
LOGICAL::LLFLAG (KLON,KGPBLKS)
#include "abor1.intfb.h"
#include "cuadjtq.func.h"
TYPE (FXTRAN_ACDC_STACK) :: YLSTACK
INTEGER :: JBLK

!$ACC DATA &
!$ACC&CREATE (IBOTSC, ICBOT, ICTOP, IDPL, ILAB, LLDCUM, LLDEEP, LLDSC, LLFIRST, LLFLAG, &
!$ACC&        LLGO_ON, LLRESETJL, LL_LDBASE, ZBUOH, ZCAPE, ZCBASE, ZDZ, ZLU, ZMIX, &
!$ACC&        ZPH, ZQENH, ZQEX, ZQOLD, ZQU, ZS, ZSENH, ZSUH, ZTEX, ZTU, ZWU2H) &
!$ACC&IF (LDACC) &
!$ACC&PRESENT (KBOTSC, KCBOT, KCTOP, KDPL, KLAB, LDCUM, LDSC, PAHFS, PAPH, PCAPE, PGEO, &
!$ACC&         PGEOH, PGP2DSPP, PKMFL, PLU, PQEN, PQENH, PQHFL, PQSEN, PQU, PTEN, PTENH, &
!$ACC&         PTU, PWU2H, PWUBASE, YDCST, YDECLDP, YDECUMF, YDEPHLI, YDSPP_CONFIG, &
!$ACC&         YDTHF) 

#ifdef __PGI
CALL NVTXSTARTRANGE ('CUBASEN_MANYBLOCKS')
#endif

ZAW=1.0_JPRB
ZBW=1.0_JPRB

!$ACC PARALLEL LOOP GANG &
!$ACC&IF (LDACC) &
!$ACC&PRIVATE (JBLK) &
!$ACC&VECTOR_LENGTH (KLON) 


DO JBLK = 1, KGPBLKS
  
  !$ACC LOOP VECTOR &
  !$ACC&PRIVATE (JL) 

  

  DO JL = KIDIA, MERGE (KLON, KFDIA, JBLK < KGPBLKS)
    
    
    PWUBASE (JL, JBLK)=0.0_JPRB
    LLGO_ON (JL, JBLK)=.TRUE.
    LLFIRST (JL, JBLK)=.TRUE.
    KDPL (JL, JBLK)=KLEV
  
  ENDDO

ENDDO

JKT1=KINDEX
JKT2=YDECUMF%NJKT2
ZRG=1.0_JPRB/YDCST%RG
ZRCPD=1.0_JPRB/YDCST%RCPD

!$ACC PARALLEL LOOP GANG &
!$ACC&IF (LDACC) &
!$ACC&PRIVATE (JBLK) &
!$ACC&VECTOR_LENGTH (KLON) 


DO JBLK = 1, KGPBLKS
  
  !$ACC LOOP VECTOR &
  !$ACC&PRIVATE (JK, JL, LLPERT_ENTRORG, LLPERT_ENTSTPC1) 

  

  DO JL = KIDIA, MERGE (KLON, KFDIA, JBLK < KGPBLKS)

    

    DO JK=1, KLEV
      
      ZTU (JL, JK, JBLK)=PTU (JL, JK, JBLK)
      ZQU (JL, JK, JBLK)=PQU (JL, JK, JBLK)
      ZLU (JL, JK, JBLK)=PLU (JL, JK, JBLK)
      ILAB (JL, JK, JBLK)=KLAB (JL, JK, JBLK)
      ZCAPE (JL, JK, JBLK)=0.0_JPRB
    
    ENDDO

    
    LLPERT_ENTSTPC1=.FALSE.
    LLPERT_ENTRORG=.FALSE.

    

    DO JK=1, KLEV
      
      PWU2H (JL, JK, JBLK)=0.0_JPRB
      ZWU2H (JL, JK, JBLK)=0.0_JPRB
      ZS (JL, JK, JBLK)=YDCST%RCPD*PTEN (JL, JK, JBLK)+PGEO (JL, JK, JBLK)
      ZQENH (JL, JK, JBLK)=PQENH (JL, JK, JBLK)
      ZSENH (JL, JK, JBLK)=YDCST%RCPD*PTENH (JL, JK, JBLK)+PGEOH (JL, JK, JBLK)
    
    ENDDO

  ENDDO

ENDDO


!$ACC PARALLEL LOOP GANG &
!$ACC&IF (LDACC) &
!$ACC&PRIVATE (JBLK) &
!$ACC&VECTOR_LENGTH (KLON) 


DO JBLK = 1, KGPBLKS
  
  !$ACC LOOP VECTOR &
  !$ACC&PRIVATE (IK, IS, JK, JKB, JKK, JKT, JL, LLRESET, Z1S, Z2S, ZALFAW, ZBUOF, ZCOND, ZCOND1, &
  !$ACC&         ZCOR, ZCOR_CUADJTQ, ZDP, ZDQ, ZDQSDT, ZDTDP, ZEPS, ZESDP, ZF, ZFAC, ZFACI, &
  !$ACC&         ZFACW, ZFOEEWI, ZFOEEWL, ZI, ZKHVFL, ZL, ZLGLAC, ZOEALFA, ZPDIFFBOT, &
  !$ACC&         ZPDIFFTOP, ZQEXC, ZQF, ZQMAX, ZQP, ZQSAT, ZQSU, ZRHO, ZSF, ZTARG, ZTEXC, &
  !$ACC&         ZTMP, ZTVENH, ZTVUH, ZUST, ZWORK1, ZWORK2, ZWS, ZXENTRORG, ZXENTSTPC1) 

  

  DO JL = KIDIA, MERGE (KLON, KFDIA, JBLK < KGPBLKS)

    

    DO JKK=KLEV, JKT1,-1
      IS=0

      

      IF (LLGO_ON (JL, JBLK)) THEN
        IS=IS+1
        IDPL (JL, JBLK)=JKK
        ICBOT (JL, JBLK)=JKK
        IBOTSC (JL, JBLK)=KLEV-1
        ICTOP (JL, JBLK)=KLEV-1
        LLDCUM (JL, JBLK)=.FALSE.
        LLDSC (JL, JBLK)=.FALSE.
        LL_LDBASE (JL, JBLK)=.FALSE.
      ENDIF


      

      IF (IS/=0) THEN

        IF (JKK==KLEV) THEN
          ZTEXC=0.2_JPRB
          ZQEXC=1.E-4_JPRB

          

          IF (LLGO_ON (JL, JBLK)) THEN
            ZRHO=PAPH (JL, JKK+1, JBLK)/(YDCST%RD*(PTEN (JL, JKK, JBLK&
            &)*(1.0_JPRB+YDCST%RETV*PQEN (JL, JKK, JBLK))))
            ZKHVFL=(PAHFS (JL, JKK+1, JBLK)*ZRCPD+YDCST%RETV*PTEN (JL, JKK&
            &, JBLK)*PQHFL (JL, JKK+1, JBLK))/(ZRHO*PPLRG*PPLDARE)
            ZUST=MAX (SQRT (PKMFL (JL, JBLK)), 0.1_JPRB)
            ZWS=ZUST**3._JPRB-1.5_JPRB*RKAP*ZKHVFL*(PGEOH (JL, KLEV, JBLK&
            &)-PGEOH (JL, KLEV+1, JBLK))/PTEN (JL, KLEV, JBLK)
            ZTEX (JL, JBLK)=0.0_JPRB
            ZQEX (JL, JBLK)=0.0_JPRB

            IF (ZKHVFL<0.0_JPRB) THEN
              ZWS=1.2_JPRB*ZWS**.3333_JPRB
              ILAB (JL, JKK, JBLK)=1
              ZTEX (JL, JBLK)=MAX (-1.5_JPRB*PAHFS (JL, JKK+1, JBLK)/(ZRHO*ZWS*YDCST%RCPD*PPLRG*PPLDARE), ZTEXC)
              ZQEX (JL, JBLK)=MAX (-1.5_JPRB*PQHFL (JL, JKK+1, JBLK)/(ZRHO*ZWS*PPLRG*PPLDARE), ZQEXC)
              ZQU (JL, JKK, JBLK)=ZQENH (JL, JKK, JBLK)+ZQEX (JL, JBLK)
              ZSUH (JL, JKK, JBLK)=ZSENH (JL, JKK, JBLK)+YDCST%RCPD*ZTEX (JL, JBLK)
              ZTU (JL, JKK, JBLK)=(ZSENH (JL, JKK, JBLK)-PGEOH (JL, JKK, JBLK))*ZRCPD+ZTEX (JL, JBLK)
              ZLU (JL, JKK, JBLK)=0.0_JPRB
              ZWU2H (JL, JKK, JBLK)=ZWS**2+0.1_JPRB
              PWU2H (JL, JKK, JBLK)=ZWU2H (JL, JKK, JBLK)
              ZTVENH=(1.0_JPRB+YDCST%RETV*ZQENH (JL, JKK, JBLK))*(ZSENH&
              & (JL, JKK, JBLK)-PGEOH (JL, JKK, JBLK))*ZRCPD
              ZTVUH=(1.0_JPRB+YDCST%RETV*ZQU (JL, JKK, JBLK))*ZTU (JL, JKK, JBLK)
              ZBUOH (JL, JKK, JBLK)=(ZTVUH-ZTVENH)*YDCST%RG/ZTVENH
            ELSE
              LLGO_ON (JL, JBLK)=.FALSE.
            ENDIF

          ENDIF

        
        ELSE

          

          IF (LLGO_ON (JL, JBLK)) THEN
            ZRHO=PAPH (JL, JKK+1, JBLK)/(YDCST%RD*(PTEN (JL, JKK, JBLK)*(1.+YDCST%RETV*PQEN (JL, JKK, JBLK))))
            ILAB (JL, JKK, JBLK)=1
            ZTEXC=0.2_JPRB
            ZQEXC=1.E-4_JPRB

            IF (JKK==KLEV-1) THEN
              ZTEXC=MAX (ZTEXC, ZTEX (JL, JBLK))
              ZQEXC=MAX (ZQEXC, ZQEX (JL, JBLK))

              IF (LDTDKMF) THEN
                ZTEXC=MIN (ZTEXC, 3.0_JPRB)
                ZQEXC=MIN (ZQEXC, 2.E-3_JPRB)
              ELSE
                ZTEXC=MIN (ZTEXC, 1.0_JPRB)
                ZQEXC=MIN (ZQEXC, 5.E-4_JPRB)
              ENDIF

            ENDIF

            ZQU (JL, JKK, JBLK)=ZQENH (JL, JKK, JBLK)+ZQEXC
            ZSUH (JL, JKK, JBLK)=ZSENH (JL, JKK, JBLK)+YDCST%RCPD*ZTEXC
            ZTU (JL, JKK, JBLK)=(ZSENH (JL, JKK, JBLK)-PGEOH (JL, JKK, JBLK))*ZRCPD+ZTEXC
            ZLU (JL, JKK, JBLK)=0.0_JPRB

            IF (PAPH (JL, KLEV+1, JBLK)-PAPH (JL, JKK-1, JBLK)<60.E2_JPRB) THEN
              ZQU (JL, JKK, JBLK)=0.0_JPRB
              ZSUH (JL, JKK, JBLK)=0.0_JPRB
              ZWORK1=0.0_JPRB

              DO JK=JKK+1, JKK-1,-1

                IF (ZWORK1<50.E2_JPRB) THEN
                  ZWORK2=PAPH (JL, JK, JBLK)-PAPH (JL, JK-1, JBLK)
                  ZWORK1=ZWORK1+ZWORK2
                  ZQU (JL, JKK, JBLK)=ZQU (JL, JKK, JBLK)+ZQENH (JL, JK, JBLK)*ZWORK2
                  ZSUH (JL, JKK, JBLK)=ZSUH (JL, JKK, JBLK)+ZSENH (JL, JK, JBLK)*ZWORK2
                ENDIF

              ENDDO

              ZQU (JL, JKK, JBLK)=ZQU (JL, JKK, JBLK)/ZWORK1+ZQEXC
              ZSUH (JL, JKK, JBLK)=ZSUH (JL, JKK, JBLK)/ZWORK1+YDCST%RCPD*ZTEXC
              ZTU (JL, JKK, JBLK)=(ZSUH (JL, JKK, JBLK)-PGEOH (JL, JKK, JBLK))*ZRCPD+ZTEXC
            ENDIF

            ZWU2H (JL, JKK, JBLK)=1.0_JPRB
            ZTVENH=(1.0_JPRB+YDCST%RETV*ZQENH (JL, JKK, JBLK))*(ZSENH&
            & (JL, JKK, JBLK)-PGEOH (JL, JKK, JBLK))*ZRCPD
            ZTVUH=(1.0_JPRB+YDCST%RETV*ZQU (JL, JKK, JBLK))*ZTU (JL, JKK, JBLK)
            ZBUOH (JL, JKK, JBLK)=(ZTVUH-ZTVENH)*YDCST%RG/ZTVENH
          ENDIF

        
        ENDIF

      ENDIF


      DO JK=JKK-1, JKT2,-1
        IS=0

        IF (JKK==KLEV.OR.KINDEX==KLEV-1) THEN
          
          
          ZXENTSTPC1=YDECUMF%ENTSTPC1

          

          IF (LLGO_ON (JL, JBLK)) THEN
            IS=IS+1
            ZDZ (JL, JBLK)=(PGEOH (JL, JK, JBLK)-PGEOH (JL, JK+1, JBLK))*ZRG

            IF (LDTDKMF) THEN
              ZEPS=ZXENTSTPC1/((PGEOH (JL, JK, JBLK)-PGEOH (JL, KLEV+1, JBLK))*ZRG*PPLRG)+YDECUMF%ENTSTPC2
            ELSE
              ZEPS=ZXENTSTPC1/((PGEO (JL, JK, JBLK)-PGEOH (JL, KLEV+1, JBLK))*ZRG*PPLRG)+YDECUMF%ENTSTPC2

              IF (LDMIXS.AND.KINDEX==KLEV.AND.ZLU (JL, JK+1, JBLK)>0.0_JPRB)  THEN
                ZEPS=ZEPS*YDECUMF%ENTSTPC3
              ENDIF

            ENDIF

            ZMIX (JL, JBLK)=0.5_JPRB*ZDZ (JL, JBLK)*PPLRG*ZEPS

            IF (.NOT.LDTDKMF)  THEN
              ZMIX (JL, JBLK)=MIN (1.0_JPRB, ZMIX (JL, JBLK))
            ENDIF

            ZQF=(PQENH (JL, JK+1, JBLK)+PQENH (JL, JK, JBLK))*0.5_JPRB
            ZSF=(ZSENH (JL, JK+1, JBLK)+ZSENH (JL, JK, JBLK))*0.5_JPRB
            ZTMP=1.0_JPRB/(1.0_JPRB+ZMIX (JL, JBLK))
            ZQU (JL, JK, JBLK)=(ZQU (JL, JK+1, JBLK)*(1.0_JPRB-ZMIX&
            & (JL, JBLK))+2.0_JPRB*ZMIX (JL, JBLK)*ZQF)*ZTMP
            ZSUH (JL, JK, JBLK)=(ZSUH (JL, JK+1, JBLK)*(1.0_JPRB-ZMIX&
            & (JL, JBLK))+2.0_JPRB*ZMIX (JL, JBLK)*ZSF)*ZTMP
            ZQOLD (JL, JBLK)=ZQU (JL, JK, JBLK)
            ZTU (JL, JK, JBLK)=(ZSUH (JL, JK, JBLK)-PGEOH (JL, JK, JBLK))*ZRCPD
            ZPH (JL, JBLK)=PAPH (JL, JK, JBLK)
          ENDIF

        
        ELSE
          ZXENTRORG=YDECUMF%ENTRORG

          

          IF (LLGO_ON (JL, JBLK)) THEN
            
            ZDZ (JL, JBLK)=(PGEOH (JL, JK, JBLK)-PGEOH (JL, JK+1, JBLK))*ZRG
            ZMIX (JL, JBLK)=YDECUMF%ENTRTEST*ZXENTRORG*ZDZ (JL, JBLK)*MIN &
            &(1.0_JPRB,(PQSEN (JL, JK, JBLK)/PQSEN (JL, KLEV, JBLK))**3)
          ENDIF


          

          

          IF (LLGO_ON (JL, JBLK)) THEN
            IS=IS+1
            ZMIX (JL, JBLK)=MIN (1.0_JPRB, ZMIX (JL, JBLK))
            ZQF=(PQENH (JL, JK+1, JBLK)+PQENH (JL, JK, JBLK))*0.5_JPRB
            ZSF=(ZSENH (JL, JK+1, JBLK)+ZSENH (JL, JK, JBLK))*0.5_JPRB
            ZQU (JL, JK, JBLK)=ZQU (JL, JK+1, JBLK)*(1.0_JPRB-ZMIX (JL, JBLK))+ZQF*ZMIX (JL, JBLK)
            ZSUH (JL, JK, JBLK)=ZSUH (JL, JK+1, JBLK)*(1.0_JPRB-ZMIX (JL, JBLK))+ZSF*ZMIX (JL, JBLK)
            ZQOLD (JL, JBLK)=ZQU (JL, JK, JBLK)
            ZTU (JL, JK, JBLK)=(ZSUH (JL, JK, JBLK)-PGEOH (JL, JK, JBLK))*ZRCPD
            ZPH (JL, JBLK)=PAPH (JL, JK, JBLK)
          ENDIF

        
        ENDIF


        IF (IS==0)  THEN
          EXIT
        ENDIF

        IK=JK
        
        
        ZQMAX=0.5_JPRB

        IF (.NOT.YDEPHLI%LPHYLIN) THEN
          
          LLFLAG (JL, JBLK)=LLGO_ON (JL, JBLK)

          

          

          IF (LLFLAG (JL, JBLK)) THEN
            ZQP=1.0_JPRB/ZPH (JL, JBLK)
            ZL=1.0_JPRB/(ZTU (JL, IK, JBLK)-YDTHF%R4LES)
            ZI=1.0_JPRB/(ZTU (JL, IK, JBLK)-YDTHF%R4IES)
            ZQSAT=YDTHF%R2ES*(FOEALFCU (ZTU (JL, IK, JBLK))*EXP (YDTHF%R3LES*(ZTU (JL, IK, JBLK)-YDCST%RTT)*ZL&
            &)+(1.0_JPRB-FOEALFCU (ZTU (JL, IK, JBLK)))*EXP (YDTHF%R3IES*(ZTU (JL, IK, JBLK)-YDCST%RTT)*ZI))
            ZQSAT=ZQSAT*ZQP
            ZQSAT=MIN (0.5_JPRB, ZQSAT)
            ZCOR_CUADJTQ=1.0_JPRB-YDCST%RETV*ZQSAT
            ZF=FOEALFCU (ZTU (JL, IK, JBLK))*YDTHF%R5ALVCP*ZL**2+(1.0_JPRB&
            &-FOEALFCU (ZTU (JL, IK, JBLK)))*YDTHF%R5ALSCP*ZI**2
            ZCOND=(ZQU (JL, IK, JBLK)*ZCOR_CUADJTQ**2-ZQSAT*ZCOR_CUADJTQ)/(ZCOR_CUADJTQ**2+ZQSAT*ZF)
            ZCOND=MAX (ZCOND, 0.0_JPRB)
            ZTU (JL, IK, JBLK)=ZTU (JL, IK, JBLK)+FOELDCPMCU (ZTU (JL, IK, JBLK))*ZCOND
            ZQU (JL, IK, JBLK)=ZQU (JL, IK, JBLK)-ZCOND
            ZL=1.0_JPRB/(ZTU (JL, IK, JBLK)-YDTHF%R4LES)
            ZI=1.0_JPRB/(ZTU (JL, IK, JBLK)-YDTHF%R4IES)
            ZQSAT=YDTHF%R2ES*(FOEALFCU (ZTU (JL, IK, JBLK))*EXP (YDTHF%R3LES*(ZTU (JL, IK, JBLK)-YDCST%RTT)*ZL&
            &)+(1.0_JPRB-FOEALFCU (ZTU (JL, IK, JBLK)))*EXP (YDTHF%R3IES*(ZTU (JL, IK, JBLK)-YDCST%RTT)*ZI))
            ZQSAT=ZQSAT*ZQP
            ZQSAT=FMINJ (0.5_JPRB, ZQSAT)
            ZCOR_CUADJTQ=1.0_JPRB-YDCST%RETV*ZQSAT
            ZF=FOEALFCU (ZTU (JL, IK, JBLK))*YDTHF%R5ALVCP*ZL**2+(1.0_JPRB&
            &-FOEALFCU (ZTU (JL, IK, JBLK)))*YDTHF%R5ALSCP*ZI**2
            ZCOND1=(ZQU (JL, IK, JBLK)*ZCOR_CUADJTQ**2-ZQSAT*ZCOR_CUADJTQ)/(ZCOR_CUADJTQ**2+ZQSAT*ZF)

            IF (ZCOND==0.0_JPRB)  THEN
              ZCOND1=0.0_JPRB
            ENDIF

            ZTU (JL, IK, JBLK)=ZTU (JL, IK, JBLK)+FOELDCPMCU (ZTU (JL, IK, JBLK))*ZCOND1
            ZQU (JL, IK, JBLK)=ZQU (JL, IK, JBLK)-ZCOND1
          ENDIF

        
        
        
        
        
        
        
        
        ELSE

          

          

          IF (LLGO_ON (JL, JBLK)) THEN
            ZQP=1.0_JPRB/ZPH (JL, JBLK)
            ZTARG=ZTU (JL, IK, JBLK)
            ZOEALFA=0.5_JPRB*(TANH (YDEPHLI%RLPAL1*(ZTARG-YDEPHLI%RLPTRC))+1.0_JPRB)
            ZFOEEWL=YDTHF%R2ES*EXP (YDTHF%R3LES*(ZTARG-YDCST%RTT)/(ZTARG-YDTHF%R4LES))
            ZFOEEWI=YDTHF%R2ES*EXP (YDTHF%R3IES*(ZTARG-YDCST%RTT)/(ZTARG-YDTHF%R4IES))
            ZQSAT=ZQP*(ZOEALFA*ZFOEEWL+(1.0_JPRB-ZOEALFA)*ZFOEEWI)
            Z1S=TANH (YDEPHLI%RLPAL2*(ZQSAT-ZQMAX))
            ZQSAT=0.5_JPRB*((1.0_JPRB-Z1S)*ZQSAT+(1.0_JPRB+Z1S)*ZQMAX)
            ZCOR_CUADJTQ=1.0_JPRB/(1.0_JPRB-YDCST%RETV*ZQSAT)
            ZQSAT=ZQSAT*ZCOR_CUADJTQ
            Z2S=ZOEALFA*YDTHF%R5ALVCP*(1.0_JPRB/(ZTARG-YDTHF%R4LES)**2)+(1.0_JPRB&
            &-ZOEALFA)*YDTHF%R5ALSCP*(1.0_JPRB/(ZTARG-YDTHF%R4IES)**2)
            ZCOND=(ZQU (JL, IK, JBLK)-ZQSAT)/(1.0_JPRB+ZQSAT*ZCOR_CUADJTQ*Z2S)
            ZCOND=MAX (ZCOND, 0.0_JPRB)

            IF (ZCOND/=0.0_JPRB) THEN
              ZTU (JL, IK, JBLK)=ZTU (JL, IK, JBLK)+(ZOEALFA*YDTHF%RALVDCP+(1.0_JPRB-ZOEALFA)*YDTHF%RALSDCP)*ZCOND
              ZQU (JL, IK, JBLK)=ZQU (JL, IK, JBLK)-ZCOND
              ZTARG=ZTU (JL, IK, JBLK)
              ZOEALFA=0.5_JPRB*(TANH (YDEPHLI%RLPAL1*(ZTARG-YDEPHLI%RLPTRC))+1.0_JPRB)
              ZFOEEWL=YDTHF%R2ES*EXP (YDTHF%R3LES*(ZTARG-YDCST%RTT)/(ZTARG-YDTHF%R4LES))
              ZFOEEWI=YDTHF%R2ES*EXP (YDTHF%R3IES*(ZTARG-YDCST%RTT)/(ZTARG-YDTHF%R4IES))
              ZQSAT=ZQP*(ZOEALFA*ZFOEEWL+(1.0_JPRB-ZOEALFA)*ZFOEEWI)
              Z1S=TANH (YDEPHLI%RLPAL2*(ZQSAT-ZQMAX))
              ZQSAT=0.5_JPRB*((1.0_JPRB-Z1S)*ZQSAT+(1.0_JPRB+Z1S)*ZQMAX)
              ZCOR_CUADJTQ=1.0_JPRB/(1.0_JPRB-YDCST%RETV*ZQSAT)
              ZQSAT=ZQSAT*ZCOR_CUADJTQ
              Z2S=ZOEALFA*YDTHF%R5ALVCP*(1.0_JPRB/(ZTARG-YDTHF%R4LES)**2)+(1.0_JPRB&
              &-ZOEALFA)*YDTHF%R5ALSCP*(1.0_JPRB/(ZTARG-YDTHF%R4IES)**2)
              ZCOND1=(ZQU (JL, IK, JBLK)-ZQSAT)/(1.0_JPRB+ZQSAT*ZCOR_CUADJTQ*Z2S)
              ZTU (JL, IK, JBLK)=ZTU (JL, IK, JBLK)+(ZOEALFA*YDTHF&
              &%RALVDCP+(1.0_JPRB-ZOEALFA)*YDTHF%RALSDCP)*ZCOND1
              ZQU (JL, IK, JBLK)=ZQU (JL, IK, JBLK)-ZCOND1
            ENDIF

          ENDIF

        
        
        
        
        
        ENDIF


        

        

        

        

        IF (LLGO_ON (JL, JBLK)) THEN
          ZDQ=MAX (ZQOLD (JL, JBLK)-ZQU (JL, JK, JBLK), 0.0_JPRB)
          ZLU (JL, JK, JBLK)=ZLU (JL, JK+1, JBLK)+ZDQ
          ZLGLAC=ZDQ*((1.0_JPRB-FOEALFCU (ZTU (JL, JK, JBLK)))-(1.0_JPRB-FOEALFCU (ZTU (JL, JK+1, JBLK))))
          ZLU (JL, JK, JBLK)=0.5_JPRB*ZLU (JL, JK, JBLK)
          ZTU (JL, JK, JBLK)=ZTU (JL, JK, JBLK)+YDTHF%RALFDCP*ZLGLAC
          ZSUH (JL, JK, JBLK)=YDCST%RCPD*ZTU (JL, JK, JBLK)+PGEOH (JL, JK, JBLK)
          ZTVUH=(1.0_JPRB+YDCST%RETV*ZQU (JL, JK, JBLK)-ZLU (JL,&
          & JK, JBLK))*ZTU (JL, JK, JBLK)+YDTHF%RALFDCP*ZLGLAC
          ZTVENH=(1.0_JPRB+YDCST%RETV*ZQENH (JL, JK, JBLK))*(ZSENH (JL, JK, JBLK)-PGEOH (JL, JK, JBLK))*ZRCPD
          ZBUOH (JL, JK, JBLK)=(ZTVUH-ZTVENH)*YDCST%RG/ZTVENH
          ZBUOF=(ZBUOH (JL, JK, JBLK)+ZBUOH (JL, JK+1, JBLK))*0.5_JPRB
          ZTMP=1.0_JPRB/(1.0_JPRB+2.0_JPRB*ZBW*ZMIX (JL, JBLK))
          ZWU2H (JL, JK, JBLK)=(ZWU2H (JL, JK+1, JBLK)*(1.0_JPRB-2.0_JPRB*ZBW&
          &*ZMIX (JL, JBLK))+2.0_JPRB*ZAW*ZBUOF*ZDZ (JL, JBLK))*ZTMP

          IF (JKK==KLEV) THEN
            PWU2H (JL, JK, JBLK)=ZWU2H (JL, JK, JBLK)
          ENDIF

          ZCAPE (JL, JKK, JBLK)=ZCAPE (JL, JKK, JBLK)+MAX (0.0_JPRB, ZBUOF*ZDZ (JL, JBLK))

          IF (ZLU (JL, JK, JBLK)>0.0_JPRB.AND.ILAB (JL, JK+1, JBLK)==1) THEN
            IK=JK+1
            ZQSU=FOEEWM (ZTU (JL, IK, JBLK))/PAPH (JL, IK, JBLK)
            ZESDP=ZQSU
            ZQSU=MIN (0.5_JPRB, ZQSU)
            ZCOR=1.0_JPRB/(1.0_JPRB-YDCST%RETV*ZQSU)
            ZQSU=ZQSU*ZCOR
            ZDQ=MIN (0._JPRB, ZQU (JL, IK, JBLK)-ZQSU)
            ZALFAW=FOEALFA (ZTU (JL, IK, JBLK))
            ZFACW=YDTHF%R5LES/((ZTU (JL, IK, JBLK)-YDTHF%R4LES)**2)
            ZFACI=YDTHF%R5IES/((ZTU (JL, IK, JBLK)-YDTHF%R4IES)**2)
            ZFAC=ZALFAW*ZFACW+(1.-ZALFAW)*ZFACI
            ZCOR=1.0_JPRB/(1.0_JPRB-YDCST%RETV*ZESDP)
            ZDQSDT=ZFAC*ZCOR*ZQSU
            ZDTDP=YDCST%RD*ZTU (JL, IK, JBLK)/(YDCST%RCPD*PAPH (JL, IK, JBLK))
            ZDP=ZDQ/(ZDQSDT*ZDTDP)
            ZCBASE (JL, JBLK)=PAPH (JL, IK, JBLK)+ZDP
            ZPDIFFTOP=ZCBASE (JL, JBLK)-PAPH (JL, JK, JBLK)
            ZPDIFFBOT=PAPH (JL, JK+1, JBLK)-ZCBASE (JL, JBLK)

            IF (ZPDIFFTOP>ZPDIFFBOT.AND.ZWU2H (JL, JK+1, JBLK)>0.0_JPRB) THEN
              JKB=MIN (KLEV-1, JK+1)
              ILAB (JL, JKB, JBLK)=2
              ILAB (JL, JK, JBLK)=2
              LL_LDBASE (JL, JBLK)=.TRUE.
              LLDSC (JL, JBLK)=.TRUE.
              IBOTSC (JL, JBLK)=JKB
              ICBOT (JL, JBLK)=JKB
              ZLU (JL, JK+1, JBLK)=YDECLDP%RLMIN
            ELSEIF (ZPDIFFTOP<=ZPDIFFBOT.AND.ZWU2H (JL, JK, JBLK)>0.0_JPRB) THEN
              ILAB (JL, JK, JBLK)=2
              LL_LDBASE (JL, JBLK)=.TRUE.
              LLDSC (JL, JBLK)=.TRUE.
              IBOTSC (JL, JBLK)=JK
              ICBOT (JL, JBLK)=JK
            ENDIF

          ENDIF


          IF (ZWU2H (JL, JK, JBLK)<0.0_JPRB) THEN
            LLGO_ON (JL, JBLK)=.FALSE.

            IF (ZLU (JL, JK+1, JBLK)>0.0_JPRB) THEN
              ICTOP (JL, JBLK)=JK
              LLDCUM (JL, JBLK)=.TRUE.
            ELSE
              LLDCUM (JL, JBLK)=.FALSE.
            ENDIF

          ELSE

            IF (ZLU (JL, JK, JBLK)>0.0_JPRB) THEN
              ILAB (JL, JK, JBLK)=2
            ELSE
              ILAB (JL, JK, JBLK)=1
            ENDIF

          ENDIF

        ENDIF

      
      ENDDO


      IF (JKK==KLEV.OR.(JKK==KLEV-1.AND.KINDEX==KLEV-1)) THEN
        
        LDSC (JL, JBLK)=LLDSC (JL, JBLK)

        IF (LDSC (JL, JBLK)) THEN
          KBOTSC (JL, JBLK)=IBOTSC (JL, JBLK)
        ELSE
          KBOTSC (JL, JBLK)=-1
        ENDIF

        JKT=ICTOP (JL, JBLK)
        JKB=ICBOT (JL, JBLK)
        LLDEEP (JL, JBLK)=PAPH (JL, JKB, JBLK)-PAPH (JL, JKT, JBLK)>YDECUMF%RDEPTHS

        IF (LLDEEP (JL, JBLK).AND.KINDEX<KLEV-1)  THEN
          LLDCUM (JL, JBLK)=.FALSE.
        ENDIF

        LLDEEP (JL, JBLK)=.FALSE.
        LLGO_ON (JL, JBLK)=.NOT.LLDEEP (JL, JBLK)

        IF (KINDEX==KLEV-1)  THEN
          LLGO_ON (JL, JBLK)=.NOT.LLDCUM (JL, JBLK)
        ENDIF


        IF (LLDCUM (JL, JBLK)) THEN
          KCBOT (JL, JBLK)=ICBOT (JL, JBLK)
          KCTOP (JL, JBLK)=ICTOP (JL, JBLK)
          KDPL (JL, JBLK)=IDPL (JL, JBLK)
          LDCUM (JL, JBLK)=LLDCUM (JL, JBLK)
          PWUBASE (JL, JBLK)=SQRT (MAX (ZWU2H (JL, JKB, JBLK), 0.0_JPRB))
        ELSE
          KCTOP (JL, JBLK)=-1
          KCBOT (JL, JBLK)=-1
          KDPL (JL, JBLK)=KLEV-1
          LDCUM (JL, JBLK)=.FALSE.
          PWUBASE (JL, JBLK)=0.0_JPRB
        ENDIF


        

        DO JK=KLEV, 1,-1
          
          JKT=ICTOP (JL, JBLK)

          IF (JK>=JKT.OR.(KINDEX>=KLEV-1.AND.JKK==KLEV)) THEN
            KLAB (JL, JK, JBLK)=ILAB (JL, JK, JBLK)
            PTU (JL, JK, JBLK)=ZTU (JL, JK, JBLK)
            PQU (JL, JK, JBLK)=ZQU (JL, JK, JBLK)
            PLU (JL, JK, JBLK)=ZLU (JL, JK, JBLK)
          ENDIF

        
        ENDDO

      ENDIF


      IF (JKK<KLEV) THEN
        LLRESET=.FALSE.

        

        IF (.NOT.LLDEEP (JL, JBLK)) THEN
          JKT=ICTOP (JL, JBLK)
          JKB=ICBOT (JL, JBLK)
          LLDEEP (JL, JBLK)=PAPH (JL, JKB, JBLK)-PAPH (JL, JKT, JBLK)>=YDECUMF%RDEPTHS
        ENDIF

        LLRESETJL (JL, JBLK)=LLDEEP (JL, JBLK).AND.LLFIRST (JL, JBLK)
        LLRESET=LLRESET.OR.LLRESETJL (JL, JBLK)

        

        IF (LLRESET) THEN

          DO JK=KLEV, 1,-1

            

            IF (LLRESETJL (JL, JBLK)) THEN
              JKT=ICTOP (JL, JBLK)
              JKB=IDPL (JL, JBLK)

              IF (JK<=JKB.AND.JK>=JKT) THEN
                KLAB (JL, JK, JBLK)=ILAB (JL, JK, JBLK)
                PTU (JL, JK, JBLK)=ZTU (JL, JK, JBLK)
                PQU (JL, JK, JBLK)=ZQU (JL, JK, JBLK)
                PLU (JL, JK, JBLK)=ZLU (JL, JK, JBLK)
              ELSE
                KLAB (JL, JK, JBLK)=1
                PTU (JL, JK, JBLK)=PTENH (JL, JK, JBLK)
                PQU (JL, JK, JBLK)=PQENH (JL, JK, JBLK)
                PLU (JL, JK, JBLK)=0.0_JPRB
              ENDIF


              IF (JK<JKT)  THEN
                KLAB (JL, JK, JBLK)=0
              ENDIF

            ENDIF

          
          ENDDO

        ENDIF


        

        IF (LLDEEP (JL, JBLK).AND.LLFIRST (JL, JBLK)) THEN
          KDPL (JL, JBLK)=IDPL (JL, JBLK)
          KCTOP (JL, JBLK)=ICTOP (JL, JBLK)
          KCBOT (JL, JBLK)=ICBOT (JL, JBLK)
          LDCUM (JL, JBLK)=LLDCUM (JL, JBLK)
          LDSC (JL, JBLK)=.FALSE.
          KBOTSC (JL, JBLK)=-1
          JKB=KCBOT (JL, JBLK)
          PWUBASE (JL, JBLK)=SQRT (MAX (ZWU2H (JL, JKB, JBLK), 0.0_JPRB))
          LLFIRST (JL, JBLK)=.FALSE.
        ENDIF

        LLGO_ON (JL, JBLK)=.NOT.LLDEEP (JL, JBLK)
      
      ENDIF

    ENDDO

  ENDDO

ENDDO


!$ACC PARALLEL LOOP GANG &
!$ACC&IF (LDACC) &
!$ACC&PRIVATE (JBLK) &
!$ACC&VECTOR_LENGTH (KLON) 


DO JBLK = 1, KGPBLKS
  
  !$ACC LOOP VECTOR &
  !$ACC&PRIVATE (JK, JL) 

  

  DO JL = KIDIA, MERGE (KLON, KFDIA, JBLK < KGPBLKS)
    
    PCAPE (JL, JBLK)=ZCAPE (JL, 1, JBLK)

    DO JK=2, KLEV
      
      PCAPE (JL, JBLK)=MAX (PCAPE (JL, JBLK), ZCAPE (JL, JK, JBLK))
    
    ENDDO

  ENDDO

ENDDO


#ifdef __PGI
CALL NVTXENDRANGE ()
#endif
!$ACC END DATA

ENDSUBROUTINE CUBASEN_MANYBLOCKS
