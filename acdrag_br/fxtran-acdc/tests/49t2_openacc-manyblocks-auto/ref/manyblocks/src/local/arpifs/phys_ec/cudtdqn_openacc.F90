SUBROUTINE CUDTDQN_OPENACC (YDTHF, YDCST, YDEPHLI, YDPHNC, YDECUMF, YDEPHY, KIDIA, KFDIA, KLON, KLEV&
&, KTOPM2, KTYPE, KCTOP, KCBOT, KDTOP, LDTDKMF, LDCUM, LDDRAF, LSCVFLAG, PTSPHY, PAPH, PAP, PGEOH&
&, PGEO, PTEN, PTENH, PQEN, PQENH, PQSEN, PLGLAC, PLUDE, PLUDELI, PSNDE, PMFU, PMFD, PMFUS, PMFDS&
&, PMFUQ, PMFDQ, PMFUL, PDMFUP, PDPMEL, PMFLXR, PMFLXS, PTENT, PTENQ, PENTH, YDSTACK)
!$ACC ROUTINE (CUDTDQN_OPENACC) SEQ
USE PARKIND1,ONLY:JPIM, JPRB

USE YOMCST,ONLY:TCST
USE YOETHF,ONLY:TTHF
USE YOECUMF,ONLY:TECUMF
USE YOEPHY,ONLY:TEPHY
USE YOEPHLI,ONLY:TEPHLI
USE YOPHNC,ONLY:TPHNC
#include "fxtran_acdc_stack.h"
USE FXTRAN_ACDC_STACK_MOD
USE FXTRAN_ACDC_ABORT_MOD

IMPLICIT NONE


TYPE (TTHF), INTENT (IN)::YDTHF
TYPE (TCST), INTENT (IN)::YDCST
TYPE (TECUMF), INTENT (IN)::YDECUMF
TYPE (TEPHLI), INTENT (IN)::YDEPHLI
TYPE (TEPHY), INTENT (IN)::YDEPHY
TYPE (TPHNC), INTENT (IN)::YDPHNC
INTEGER (KIND=JPIM), INTENT (IN)::KLON
INTEGER (KIND=JPIM), INTENT (IN)::KLEV
INTEGER (KIND=JPIM), INTENT (IN)::KIDIA
INTEGER (KIND=JPIM), INTENT (IN)::KFDIA
INTEGER (KIND=JPIM), INTENT (IN)::KTOPM2
INTEGER (KIND=JPIM), INTENT (IN)::KTYPE 
INTEGER (KIND=JPIM), INTENT (IN)::KCTOP 
INTEGER (KIND=JPIM), INTENT (IN)::KCBOT 
INTEGER (KIND=JPIM), INTENT (IN)::KDTOP 
LOGICAL, INTENT (INOUT)::LDCUM 
LOGICAL, INTENT (IN)::LDDRAF 
LOGICAL, INTENT (IN)::LDTDKMF
LOGICAL, INTENT (IN)::LSCVFLAG 
REAL (KIND=JPRB), INTENT (IN)::PTSPHY
REAL (KIND=JPRB), INTENT (IN)::PAPH 
REAL (KIND=JPRB), INTENT (IN)::PAP 
REAL (KIND=JPRB), INTENT (IN)::PGEO 
REAL (KIND=JPRB), INTENT (IN)::PGEOH 
REAL (KIND=JPRB), INTENT (IN)::PTEN 
REAL (KIND=JPRB), INTENT (IN)::PQEN 
REAL (KIND=JPRB), INTENT (IN)::PTENH 
REAL (KIND=JPRB), INTENT (IN)::PQENH 
REAL (KIND=JPRB), INTENT (IN)::PQSEN 
REAL (KIND=JPRB), INTENT (IN)::PLGLAC 
REAL (KIND=JPRB), INTENT (INOUT)::PLUDE 
REAL (KIND=JPRB), INTENT (INOUT)::PLUDELI 
REAL (KIND=JPRB), INTENT (INOUT)::PSNDE 
REAL (KIND=JPRB), INTENT (IN)::PMFU 
REAL (KIND=JPRB), INTENT (IN)::PMFD 
REAL (KIND=JPRB), INTENT (IN)::PMFUS 
REAL (KIND=JPRB), INTENT (IN)::PMFDS 
REAL (KIND=JPRB), INTENT (IN)::PMFUQ 
REAL (KIND=JPRB), INTENT (IN)::PMFDQ 
REAL (KIND=JPRB), INTENT (IN)::PMFUL 
REAL (KIND=JPRB), INTENT (IN)::PDMFUP 
REAL (KIND=JPRB), INTENT (IN)::PDPMEL 
REAL (KIND=JPRB), INTENT (IN)::PMFLXR 
REAL (KIND=JPRB), INTENT (IN)::PMFLXS 
REAL (KIND=JPRB), INTENT (INOUT)::PTENT 
REAL (KIND=JPRB), INTENT (INOUT)::PTENQ 
REAL (KIND=JPRB), INTENT (OUT)::PENTH 
TYPE(FXTRAN_ACDC_STACK), INTENT (IN) :: YDSTACK

fxtran_acdc_temp (INTEGER(KIND=JPIM), KTYPE_PTR, (KLON))
fxtran_acdc_temp (INTEGER(KIND=JPIM), KCTOP_PTR, (KLON))
fxtran_acdc_temp (INTEGER(KIND=JPIM), KCBOT_PTR, (KLON))
fxtran_acdc_temp (INTEGER(KIND=JPIM), KDTOP_PTR, (KLON))
fxtran_acdc_temp (LOGICAL, LDCUM_PTR, (KLON))
fxtran_acdc_temp (LOGICAL, LDDRAF_PTR, (KLON))
fxtran_acdc_temp (LOGICAL, LSCVFLAG_PTR, (KLON))
fxtran_acdc_temp (REAL(KIND=JPRB), PAPH_PTR, (KLON, KLEV+1))
fxtran_acdc_temp (REAL(KIND=JPRB), PAP_PTR, (KLON, KLEV))
fxtran_acdc_temp (REAL(KIND=JPRB), PGEO_PTR, (KLON, KLEV))
fxtran_acdc_temp (REAL(KIND=JPRB), PGEOH_PTR, (KLON, KLEV+1))
fxtran_acdc_temp (REAL(KIND=JPRB), PTEN_PTR, (KLON, KLEV))
fxtran_acdc_temp (REAL(KIND=JPRB), PQEN_PTR, (KLON, KLEV))
fxtran_acdc_temp (REAL(KIND=JPRB), PTENH_PTR, (KLON, KLEV))
fxtran_acdc_temp (REAL(KIND=JPRB), PQENH_PTR, (KLON, KLEV))
fxtran_acdc_temp (REAL(KIND=JPRB), PQSEN_PTR, (KLON, KLEV))
fxtran_acdc_temp (REAL(KIND=JPRB), PLGLAC_PTR, (KLON, KLEV))
fxtran_acdc_temp (REAL(KIND=JPRB), PLUDE_PTR, (KLON, KLEV))
fxtran_acdc_temp (REAL(KIND=JPRB), PLUDELI_PTR, (KLON, KLEV, 2))
fxtran_acdc_temp (REAL(KIND=JPRB), PSNDE_PTR, (KLON, KLEV, 2))
fxtran_acdc_temp (REAL(KIND=JPRB), PMFU_PTR, (KLON, KLEV))
fxtran_acdc_temp (REAL(KIND=JPRB), PMFD_PTR, (KLON, KLEV))
fxtran_acdc_temp (REAL(KIND=JPRB), PMFUS_PTR, (KLON, KLEV))
fxtran_acdc_temp (REAL(KIND=JPRB), PMFDS_PTR, (KLON, KLEV))
fxtran_acdc_temp (REAL(KIND=JPRB), PMFUQ_PTR, (KLON, KLEV))
fxtran_acdc_temp (REAL(KIND=JPRB), PMFDQ_PTR, (KLON, KLEV))
fxtran_acdc_temp (REAL(KIND=JPRB), PMFUL_PTR, (KLON, KLEV))
fxtran_acdc_temp (REAL(KIND=JPRB), PDMFUP_PTR, (KLON, KLEV))
fxtran_acdc_temp (REAL(KIND=JPRB), PDPMEL_PTR, (KLON, KLEV))
fxtran_acdc_temp (REAL(KIND=JPRB), PMFLXR_PTR, (KLON, KLEV+1))
fxtran_acdc_temp (REAL(KIND=JPRB), PMFLXS_PTR, (KLON, KLEV+1))
fxtran_acdc_temp (REAL(KIND=JPRB), PTENT_PTR, (KLON, KLEV))
fxtran_acdc_temp (REAL(KIND=JPRB), PTENQ_PTR, (KLON, KLEV))
fxtran_acdc_temp (REAL(KIND=JPRB), PENTH_PTR, (KLON, KLEV))

TYPE(FXTRAN_ACDC_STACK) :: YLSTACK
LOGICAL::LLTEST
INTEGER (KIND=JPIM)::JL
INTEGER (KIND=JPIM)::IM
INTEGER (KIND=JPIM)::IK
INTEGER (KIND=JPIM)::JK
REAL (KIND=JPRB)::ZQ
REAL (KIND=JPRB)::ZS
REAL (KIND=JPRB)::ZGH
REAL (KIND=JPRB)::ZGS
REAL (KIND=JPRB)::ZGQ
REAL (KIND=JPRB)::ZZP
REAL (KIND=JPRB)::ZTARG
REAL (KIND=JPRB)::ZOEALFA
REAL (KIND=JPRB)::ZORCPD
REAL (KIND=JPRB)::ZIMP
REAL (KIND=JPRB)::ZTSPHY
REAL (KIND=JPRB)::ZINT2 
REAL (KIND=JPRB)::ZINT 
fxtran_acdc_temp (REAL (KIND=JPRB), ZALV2, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZALV, (KLON, KLEV))
REAL (KIND=JPRB)::ZADVW 
fxtran_acdc_temp (REAL (KIND=JPRB), ZMFDQ, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZMFDS, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZMFUQ, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZMFUS, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZDP, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZDQDT, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZDTDT, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZR2, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZR1, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZB, (KLON, KLEV))
fxtran_acdc_temp (LOGICAL, LLCUMBAS, (KLON, KLEV))

#include "cubidiag.intfb.h"
#include "fcttre.func.h"

fxtran_acdc_assoc (KTYPE_PTR, KTYPE)

fxtran_acdc_assoc (KCTOP_PTR, KCTOP)

fxtran_acdc_assoc (KCBOT_PTR, KCBOT)

fxtran_acdc_assoc (KDTOP_PTR, KDTOP)

fxtran_acdc_assoc (LDCUM_PTR, LDCUM)

fxtran_acdc_assoc (LDDRAF_PTR, LDDRAF)

fxtran_acdc_assoc (LSCVFLAG_PTR, LSCVFLAG)

fxtran_acdc_assoc (PAPH_PTR, PAPH)

fxtran_acdc_assoc (PAP_PTR, PAP)

fxtran_acdc_assoc (PGEO_PTR, PGEO)

fxtran_acdc_assoc (PGEOH_PTR, PGEOH)

fxtran_acdc_assoc (PTEN_PTR, PTEN)

fxtran_acdc_assoc (PQEN_PTR, PQEN)

fxtran_acdc_assoc (PTENH_PTR, PTENH)

fxtran_acdc_assoc (PQENH_PTR, PQENH)

fxtran_acdc_assoc (PQSEN_PTR, PQSEN)

fxtran_acdc_assoc (PLGLAC_PTR, PLGLAC)

fxtran_acdc_assoc (PLUDE_PTR, PLUDE)

fxtran_acdc_assoc (PLUDELI_PTR, PLUDELI)

fxtran_acdc_assoc (PSNDE_PTR, PSNDE)

fxtran_acdc_assoc (PMFU_PTR, PMFU)

fxtran_acdc_assoc (PMFD_PTR, PMFD)

fxtran_acdc_assoc (PMFUS_PTR, PMFUS)

fxtran_acdc_assoc (PMFDS_PTR, PMFDS)

fxtran_acdc_assoc (PMFUQ_PTR, PMFUQ)

fxtran_acdc_assoc (PMFDQ_PTR, PMFDQ)

fxtran_acdc_assoc (PMFUL_PTR, PMFUL)

fxtran_acdc_assoc (PDMFUP_PTR, PDMFUP)

fxtran_acdc_assoc (PDPMEL_PTR, PDPMEL)

fxtran_acdc_assoc (PMFLXR_PTR, PMFLXR)

fxtran_acdc_assoc (PMFLXS_PTR, PMFLXS)

fxtran_acdc_assoc (PTENT_PTR, PTENT)

fxtran_acdc_assoc (PTENQ_PTR, PTENQ)

fxtran_acdc_assoc (PENTH_PTR, PENTH)

YLSTACK = YDSTACK



IF (KIND (ZALV2) == 8) THEN
    fxtran_acdc_alloc8 (ZALV2)
ELSEIF (KIND (ZALV2) == 4) THEN
    fxtran_acdc_alloc4 (ZALV2)
ELSE
    STOP 1
ENDIF


IF (KIND (ZALV) == 8) THEN
    fxtran_acdc_alloc8 (ZALV)
ELSEIF (KIND (ZALV) == 4) THEN
    fxtran_acdc_alloc4 (ZALV)
ELSE
    STOP 1
ENDIF


IF (KIND (ZMFDQ) == 8) THEN
    fxtran_acdc_alloc8 (ZMFDQ)
ELSEIF (KIND (ZMFDQ) == 4) THEN
    fxtran_acdc_alloc4 (ZMFDQ)
ELSE
    STOP 1
ENDIF


IF (KIND (ZMFDS) == 8) THEN
    fxtran_acdc_alloc8 (ZMFDS)
ELSEIF (KIND (ZMFDS) == 4) THEN
    fxtran_acdc_alloc4 (ZMFDS)
ELSE
    STOP 1
ENDIF


IF (KIND (ZMFUQ) == 8) THEN
    fxtran_acdc_alloc8 (ZMFUQ)
ELSEIF (KIND (ZMFUQ) == 4) THEN
    fxtran_acdc_alloc4 (ZMFUQ)
ELSE
    STOP 1
ENDIF


IF (KIND (ZMFUS) == 8) THEN
    fxtran_acdc_alloc8 (ZMFUS)
ELSEIF (KIND (ZMFUS) == 4) THEN
    fxtran_acdc_alloc4 (ZMFUS)
ELSE
    STOP 1
ENDIF


IF (KIND (ZDP) == 8) THEN
    fxtran_acdc_alloc8 (ZDP)
ELSEIF (KIND (ZDP) == 4) THEN
    fxtran_acdc_alloc4 (ZDP)
ELSE
    STOP 1
ENDIF


IF (KIND (ZDQDT) == 8) THEN
    fxtran_acdc_alloc8 (ZDQDT)
ELSEIF (KIND (ZDQDT) == 4) THEN
    fxtran_acdc_alloc4 (ZDQDT)
ELSE
    STOP 1
ENDIF


IF (KIND (ZDTDT) == 8) THEN
    fxtran_acdc_alloc8 (ZDTDT)
ELSEIF (KIND (ZDTDT) == 4) THEN
    fxtran_acdc_alloc4 (ZDTDT)
ELSE
    STOP 1
ENDIF


IF (KIND (ZR2) == 8) THEN
    fxtran_acdc_alloc8 (ZR2)
ELSEIF (KIND (ZR2) == 4) THEN
    fxtran_acdc_alloc4 (ZR2)
ELSE
    STOP 1
ENDIF


IF (KIND (ZR1) == 8) THEN
    fxtran_acdc_alloc8 (ZR1)
ELSEIF (KIND (ZR1) == 4) THEN
    fxtran_acdc_alloc4 (ZR1)
ELSE
    STOP 1
ENDIF


IF (KIND (ZB) == 8) THEN
    fxtran_acdc_alloc8 (ZB)
ELSEIF (KIND (ZB) == 4) THEN
    fxtran_acdc_alloc4 (ZB)
ELSE
    STOP 1
ENDIF


IF (KIND (LLCUMBAS) == 8) THEN
    fxtran_acdc_alloc8 (LLCUMBAS)
ELSEIF (KIND (LLCUMBAS) == 4) THEN
    fxtran_acdc_alloc4 (LLCUMBAS)
ELSE
    STOP 1
ENDIF


JL = KIDIA



ZIMP=1.0_JPRB-YDECUMF%RMFSOLTQ
ZTSPHY=1.0_JPRB/PTSPHY
ZORCPD=1.0_JPRB/YDCST%RCPD

ZADVW =0.0_JPRB

IF (KTYPE_PTR (JL)==1)  THEN
  ZADVW =YDECUMF%RMFADVW
ENDIF



DO JK=1, KLEV
  
  PENTH_PTR (JL, JK)=0.0_JPRB
  
ENDDO



IF (KTYPE_PTR (JL)/=1.AND.YDEPHLI%LPHYLIN)  THEN
  LDCUM_PTR (JL)=.FALSE.
ENDIF


LLTEST=(.NOT.YDEPHY%LEPCLD.AND..NOT.YDPHNC%LENCLD2.AND..NOT.YDPHNC%LEPCLD2&
&).OR.(YDEPHLI%LPHYLIN.AND..NOT.YDPHNC%LENCLD2.AND..NOT.YDPHNC%LEPCLD2)

IF (LLTEST) THEN

  DO JK=1, KLEV
    
    PLUDE_PTR (JL, JK)=0.0_JPRB
    PLUDELI_PTR (JL, JK, 1)=0.0_JPRB
    PLUDELI_PTR (JL, JK, 2)=0.0_JPRB
  
  ENDDO

ENDIF


DO JK=1, KLEV

  

  IF (LDCUM_PTR (JL)) THEN
    ZDP (JL, JK)=YDCST%RG/(PAPH_PTR (JL, JK+1)-PAPH_PTR (JL, JK))
    ZMFUS (JL, JK)=PMFUS_PTR (JL, JK)
    ZMFDS (JL, JK)=PMFDS_PTR (JL, JK)
    ZMFUQ (JL, JK)=PMFUQ_PTR (JL, JK)
    ZMFDQ (JL, JK)=PMFDQ_PTR (JL, JK)
  ENDIF

  
ENDDO


IF (YDECUMF%RMFSOLTQ>0.0_JPRB) THEN

  DO JK=KTOPM2, KLEV
    IK=JK-1

    

    IF (LDCUM_PTR (JL).AND.JK>=KCTOP_PTR (JL)-1) THEN
      ZGQ=(PQENH_PTR (JL, JK)-PQEN_PTR (JL, IK))/PQSEN_PTR (JL, JK)
      ZGH=YDCST%RCPD*PTEN_PTR (JL, JK)+PGEO_PTR (JL, JK)
      ZGS=(YDCST%RCPD*(PTENH_PTR (JL, JK)-PTEN_PTR (JL, IK))+PGEOH_PTR (JL, JK)-PGEO_PTR (JL, IK))/ZGH
      ZS=YDCST%RCPD*(ZIMP*PTEN_PTR (JL, IK)+ZGS*PTEN_PTR (JL, JK))+PGEO_PTR (JL, IK)+ZGS*PGEO_PTR (JL, JK)
      ZQ=ZIMP*PQEN_PTR (JL, IK)+ZGQ*PQSEN_PTR (JL, JK)
      ZMFUS (JL, JK)=PMFUS_PTR (JL, JK)-PMFU_PTR (JL, JK)*ZS
      ZMFUQ (JL, JK)=PMFUQ_PTR (JL, JK)-PMFU_PTR (JL, JK)*ZQ

      IF (LDDRAF_PTR (JL).AND.JK>=KDTOP_PTR (JL)) THEN
        ZMFDS (JL, JK)=PMFDS_PTR (JL, JK)-PMFD_PTR (JL, JK)*ZS
        ZMFDQ (JL, JK)=PMFDQ_PTR (JL, JK)-PMFD_PTR (JL, JK)*ZQ
      ENDIF

    ENDIF

  
  ENDDO

ENDIF

ZINT=0._JPRB

DO JK=KTOPM2, KLEV
  
  ZALV (JL, JK)=FOELHMCU (PTEN_PTR (JL, JK))
  ZALV2 (JL, JK)=ZALV (JL, JK)
  
ENDDO


IF (YDECUMF%LMFENTHCONS) THEN

  DO JK=KTOPM2, KLEV-1

    

    IF (LSCVFLAG_PTR (JL))  THEN
      ZALV (JL, JK)=YDCST%RLVTT
    ENDIF

    ZINT =ZINT +YDCST%RLMLT*(PLGLAC_PTR (JL, JK)-PDPMEL_PTR (JL, JK))-ZALV (JL, JK)*&
    &(PMFUL_PTR (JL, JK+1)-PMFUL_PTR (JL, JK))+ZALV2 (JL, JK)*PDMFUP_PTR (JL, JK)
  
  ENDDO

  JK=KLEV

  

  IF (LSCVFLAG_PTR (JL))  THEN
    ZALV (JL, JK)=YDCST%RLVTT
  ENDIF

  ZINT =ZINT +YDCST%RLMLT*(PLGLAC_PTR (JL, JK)-PDPMEL_PTR (JL, JK))+ZALV&
  & (JL, JK)*PMFUL_PTR (JL, JK)+ZALV2 (JL, JK)*PDMFUP_PTR (JL, JK)
  ZINT2 =ZINT -YDCST%RLVTT*PMFLXR_PTR (JL, KLEV+1)-YDCST%RLSTT*PMFLXS_PTR (JL, KLEV+1)

  IF (ABS (ZINT )>0.1_JPRB) THEN
    ZINT =ZINT2 /(ZINT +1.E-3_JPRB)
  ELSE
    ZINT =0.0_JPRB
  ENDIF


  IF (ABS (ZINT )>2.0_JPRB)  THEN
    ZINT =0.0_JPRB
  ENDIF

  
ENDIF


DO JK=KTOPM2, KLEV

  IF (JK<KLEV) THEN

    

    IF (LDCUM_PTR (JL)) THEN

      IF (YDEPHLI%LPHYLIN) THEN
        ZTARG=PTEN_PTR (JL, JK)
        ZOEALFA=MIN (1.0_JPRB, 0.545_JPRB*(TANH (0.17_JPRB*(ZTARG-YDEPHLI%RLPTRC))+1.0_JPRB))
        ZALV (JL, JK)=ZOEALFA*YDCST%RLVTT+(1.0_JPRB-ZOEALFA)*YDCST%RLSTT
        ZALV2 (JL, JK)=ZALV (JL, JK)
      ENDIF


      IF (LDTDKMF) THEN
        ZDTDT (JL, JK)=ZDP (JL, JK)*ZORCPD*(ZMFUS (JL, JK+1)-ZMFUS (JL, JK)+ZMFDS (JL, JK+1)-ZMFDS&
        & (JL, JK)+YDCST%RLMLT*PLGLAC_PTR (JL, JK)-YDCST%RLMLT*PDPMEL_PTR (JL, JK)-ZALV (JL, JK)&
        &*(PMFUL_PTR (JL, JK+1)-PMFUL_PTR (JL, JK)-PLUDE_PTR (JL, JK)-PDMFUP_PTR (JL, JK)))
        ZDQDT (JL, JK)=ZDP (JL, JK)*(ZMFUQ (JL, JK+1)-ZMFUQ (JL, JK)+ZMFDQ (JL, JK+1)-ZMFDQ (JL,&
        & JK)+PMFUL_PTR (JL, JK+1)-PMFUL_PTR (JL, JK)-PLUDE_PTR (JL, JK)-PDMFUP_PTR (JL, JK))
      ELSE
        ZDTDT (JL, JK)=ZDP (JL, JK)*ZORCPD*(ZMFUS (JL, JK+1)-ZMFUS (JL, JK)+ZMFDS (JL, JK+1)-ZMFDS (JL, JK&
        &)+(YDCST%RLMLT*(PLGLAC_PTR (JL, JK)-PDPMEL_PTR (JL, JK))-ZALV (JL, JK)*(PMFUL_PTR (JL, JK+1)-PMFUL_PTR&
        & (JL, JK))+ZALV2 (JL, JK)*PDMFUP_PTR (JL, JK))*(1.0_JPRB-ZINT )+YDCST%RLVTT*(PLUDELI_PTR (JL, JK,&
        & 1)+PSNDE_PTR (JL, JK, 1))+YDCST%RLSTT*(PLUDELI_PTR (JL, JK, 2)+PSNDE_PTR (JL, JK, 2)))
        ZDQDT (JL, JK)=ZDP (JL, JK)*(ZMFUQ (JL, JK+1)-ZMFUQ (JL, JK)+ZMFDQ (JL, JK&
        &+1)-ZMFDQ (JL, JK)+PMFUL_PTR (JL, JK+1)-PMFUL_PTR (JL, JK)-PLUDE_PTR (JL,&
        & JK)-PDMFUP_PTR (JL, JK)-PSNDE_PTR (JL, JK, 1)-PSNDE_PTR (JL, JK, 2))
      ENDIF

    ENDIF

  
  ELSE

    

    IF (LDCUM_PTR (JL)) THEN

      IF (YDEPHLI%LPHYLIN) THEN
        ZTARG=PTEN_PTR (JL, JK)
        ZOEALFA=MIN (1.0_JPRB, 0.545_JPRB*(TANH (0.17_JPRB*(ZTARG-YDEPHLI%RLPTRC))+1.0_JPRB))
        ZALV (JL, JK)=ZOEALFA*YDCST%RLVTT+(1.0_JPRB-ZOEALFA)*YDCST%RLSTT
        ZALV2 (JL, JK)=ZALV (JL, JK)
      ENDIF

      ZDTDT (JL, JK)=-ZDP (JL, JK)*ZORCPD*(ZMFUS (JL, JK)+ZMFDS (JL, JK)+(YDCST&
      &%RLMLT*(PDPMEL_PTR (JL, JK)-PLGLAC_PTR (JL, JK))-ZALV (JL, JK)*PMFUL_PTR&
      & (JL, JK)-ZALV2 (JL, JK)*PDMFUP_PTR (JL, JK))*(1.0_JPRB-ZINT ))
      ZDQDT (JL, JK)=-ZDP (JL, JK)*(ZMFUQ (JL, JK)+ZMFDQ (JL&
      &, JK)+(PMFUL_PTR (JL, JK)+PDMFUP_PTR (JL, JK)))
    ENDIF

  
  ENDIF

ENDDO


IF (YDECUMF%RMFSOLTQ==0.0_JPRB) THEN

  DO JK=KTOPM2, KLEV

    

    IF (LDCUM_PTR (JL)) THEN
      PTENT_PTR (JL, JK)=PTENT_PTR (JL, JK)+ZDTDT (JL, JK)
      PTENQ_PTR (JL, JK)=PTENQ_PTR (JL, JK)+ZDQDT (JL, JK)
      PENTH_PTR (JL, JK)=ZDTDT (JL, JK)*YDCST%RCPD
    ENDIF

  
  ENDDO

ELSE
  LLCUMBAS (JL,:)=.FALSE.
  ZB (JL,:)=1.0_JPRB
  ZMFUS (JL,:)=0.0_JPRB

  DO JK=KTOPM2, KLEV
    IK=JK+1
    IM=JK-1
    
    LLCUMBAS (JL, JK)=LDCUM_PTR (JL).AND.JK>=KCTOP_PTR (JL)-1

    IF (LLCUMBAS (JL, JK)) THEN
      ZZP=YDECUMF%RMFSOLTQ*ZDP (JL, JK)*PTSPHY
      ZMFUS (JL, JK)=-ZZP*(PMFU_PTR (JL, JK)+PMFD_PTR (JL, JK))

      IF (JK<KLEV) THEN
        ZB (JL, JK)=1.0_JPRB+ZZP*(PMFU_PTR (JL, IK)+PMFD_PTR (JL, IK))
      ELSE
        ZB (JL, JK)=1.0_JPRB
      ENDIF


      IF (LDTDKMF) THEN
        ZDTDT (JL, JK)=ZDTDT (JL, JK)*PTSPHY+PTEN_PTR (JL, JK)
        ZDQDT (JL, JK)=ZDQDT (JL, JK)*PTSPHY+PQEN_PTR (JL, JK)
      ELSE
        ZZP=YDCST%RG*(PMFU_PTR (JL, JK)+YDECUMF%RMFADVWDD*PMFD_PTR (JL&
        &, JK))/(PAP_PTR (JL, JK)-PAP_PTR (JL, IM))*PTSPHY*ZADVW 
        ZS=ZZP*(PTEN_PTR (JL, IM)-PTEN_PTR (JL, JK)+ZORCPD*(PGEO_PTR (JL, IM)-PGEO_PTR (JL, JK)))
        ZQ=ZZP*(PQEN_PTR (JL, IM)-PQEN_PTR (JL, JK))
        ZDTDT (JL, JK)=(ZDTDT (JL, JK)+PTENT_PTR (JL, JK)*YDECUMF%RMFSOLRHS)*PTSPHY+PTEN_PTR (JL, JK)-ZS
        ZDQDT (JL, JK)=(ZDQDT (JL, JK)+PTENQ_PTR (JL, JK)*YDECUMF%RMFSOLRHS)*PTSPHY+PQEN_PTR (JL, JK)-ZQ
      ENDIF

    ENDIF

  
  ENDDO

  CALL CUBIDIAG_OPENACC (KIDIA, KFDIA, KLON, KLEV, KCTOP_PTR&
  &, LLCUMBAS, ZMFUS, ZB, ZDTDT, ZR1, YDSTACK=YLSTACK)
  CALL CUBIDIAG_OPENACC (KIDIA, KFDIA, KLON, KLEV, KCTOP_PTR&
  &, LLCUMBAS, ZMFUS, ZB, ZDQDT, ZR2, YDSTACK=YLSTACK)

  DO JK=KTOPM2, KLEV

    

    IF (LLCUMBAS (JL, JK)) THEN

      IF (LDTDKMF) THEN
        PTENT_PTR (JL, JK)=PTENT_PTR (JL, JK)+(ZR1 (JL, JK)-PTEN_PTR (JL, JK))*ZTSPHY
        PTENQ_PTR (JL, JK)=PTENQ_PTR (JL, JK)+(ZR2 (JL, JK)-PQEN_PTR (JL, JK))*ZTSPHY
      ELSE
        PTENT_PTR (JL, JK)=PTENT_PTR (JL, JK)*(1.0_JPRB-YDECUMF&
        &%RMFSOLRHS)+(ZR1 (JL, JK)-PTEN_PTR (JL, JK))*ZTSPHY
        PTENQ_PTR (JL, JK)=PTENQ_PTR (JL, JK)*(1.0_JPRB-YDECUMF&
        &%RMFSOLRHS)+(ZR2 (JL, JK)-PQEN_PTR (JL, JK))*ZTSPHY
      ENDIF

      PENTH_PTR (JL, JK)=(ZR1 (JL, JK)-PTEN_PTR (JL, JK))*ZTSPHY
    ENDIF

  
  ENDDO

ENDIF



ENDSUBROUTINE CUDTDQN_OPENACC
