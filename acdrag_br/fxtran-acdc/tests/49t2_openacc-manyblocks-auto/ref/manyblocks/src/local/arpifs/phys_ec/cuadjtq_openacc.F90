
SUBROUTINE CUADJTQ_OPENACC (YDTHF, YDCST, YDEPHLI, KIDIA, KFDIA, KLON&
&, KLEV, KK, PSP, PT, PQ, LDFLAG, KCALL, LDOFLAG, YDSTACK)
!$ACC ROUTINE (CUADJTQ_OPENACC) SEQ
USE PARKIND1,ONLY:JPIM, JPRB

USE YOMCST,ONLY:TCST
USE YOETHF,ONLY:TTHF
USE YOEPHLI,ONLY:TEPHLI
#include "fxtran_acdc_stack.h"
USE FXTRAN_ACDC_STACK_MOD
USE FXTRAN_ACDC_ABORT_MOD

IMPLICIT NONE


TYPE (TTHF), INTENT (IN)::YDTHF
TYPE (TCST), INTENT (IN)::YDCST
TYPE (TEPHLI), INTENT (IN)::YDEPHLI
INTEGER (KIND=JPIM), INTENT (IN)::KIDIA
INTEGER (KIND=JPIM), INTENT (IN)::KFDIA
INTEGER (KIND=JPIM), INTENT (IN)::KLON
INTEGER (KIND=JPIM), INTENT (IN)::KLEV
INTEGER (KIND=JPIM), INTENT (IN)::KK
REAL (KIND=JPRB), INTENT (IN)::PSP 
REAL (KIND=JPRB), INTENT (INOUT)::PT 
REAL (KIND=JPRB), INTENT (INOUT)::PQ 
LOGICAL, INTENT (IN)::LDFLAG 
INTEGER (KIND=JPIM), INTENT (IN)::KCALL
LOGICAL, INTENT (IN), OPTIONAL::LDOFLAG 
TYPE(FXTRAN_ACDC_STACK), INTENT (IN) :: YDSTACK

fxtran_acdc_temp (REAL(KIND=JPRB), PSP_PTR, (KLON))
fxtran_acdc_temp (REAL(KIND=JPRB), PT_PTR, (KLON, KLEV))
fxtran_acdc_temp (REAL(KIND=JPRB), PQ_PTR, (KLON, KLEV))
fxtran_acdc_temp (LOGICAL, LDFLAG_PTR, (KLON))
fxtran_acdc_temp (LOGICAL, LDOFLAG_PTR, (KLON))

INTEGER (KIND=JPIM)::JL
REAL (KIND=JPRB)::ZQP
REAL (KIND=JPRB)::ZTARG
REAL (KIND=JPRB)::ZQSAT
REAL (KIND=JPRB)::ZQMAX
REAL (KIND=JPRB)::ZOEALFA
REAL (KIND=JPRB)::ZFOEEWL
REAL (KIND=JPRB)::ZFOEEWI
REAL (KIND=JPRB)::ZCOR
REAL (KIND=JPRB)::ZCOND1
REAL (KIND=JPRB)::ZCOND
REAL (KIND=JPRB)::Z2S
REAL (KIND=JPRB)::Z1S
REAL (KIND=JPRB)::ZF
REAL (KIND=JPRB)::ZI
REAL (KIND=JPRB)::ZL
LOGICAL::LLFLAG 

#include "fcttre.func.h"
#include "cuadjtq.func.h"


fxtran_acdc_assoc (PSP_PTR, PSP)

fxtran_acdc_assoc (PT_PTR, PT)

fxtran_acdc_assoc (PQ_PTR, PQ)

fxtran_acdc_assoc (LDFLAG_PTR, LDFLAG)


IF (PRESENT (LDOFLAG)) THEN
  fxtran_acdc_assoc (LDOFLAG_PTR, LDOFLAG)
ELSE
  fxtran_acdc_nullptr (LDOFLAG_PTR)
ENDIF


JL = KIDIA



ZQMAX=0.5_JPRB

IF (.NOT.YDEPHLI%LPHYLIN) THEN

  IF (KCALL==1.OR.KCALL==6) THEN
    LLFLAG =LDFLAG_PTR (JL)

    IF (KCALL==6) THEN

      IF (PRESENT (LDOFLAG)) THEN
        LLFLAG =LLFLAG .AND..NOT.LDOFLAG_PTR (JL)
      ELSE
        CALL FXTRAN_ACDC_ABORT ("CUADJTQ: LDOFLAG has to be present when KCALL==6")
      ENDIF

    ENDIF


    

    IF (LLFLAG ) THEN
      ZQP=1.0_JPRB/PSP_PTR (JL)
      ZL=1.0_JPRB/(PT_PTR (JL, KK)-YDTHF%R4LES)
      ZI=1.0_JPRB/(PT_PTR (JL, KK)-YDTHF%R4IES)
      ZQSAT=YDTHF%R2ES*(FOEALFCU (PT_PTR (JL, KK))*EXP (YDTHF%R3LES*(PT_PTR (JL, KK)-YDCST%RTT)*ZL&
      &)+(1.0_JPRB-FOEALFCU (PT_PTR (JL, KK)))*EXP (YDTHF%R3IES*(PT_PTR (JL, KK)-YDCST%RTT)*ZI))
      ZQSAT=ZQSAT*ZQP
      ZQSAT=MIN (0.5_JPRB, ZQSAT)
      ZCOR=1.0_JPRB-YDCST%RETV*ZQSAT
      ZF=FOEALFCU (PT_PTR (JL, KK))*YDTHF%R5ALVCP*ZL**2+(1.0_JPRB&
      &-FOEALFCU (PT_PTR (JL, KK)))*YDTHF%R5ALSCP*ZI**2
      ZCOND=(PQ_PTR (JL, KK)*ZCOR**2-ZQSAT*ZCOR)/(ZCOR**2+ZQSAT*ZF)
      ZCOND=MAX (ZCOND, 0.0_JPRB)
      PT_PTR (JL, KK)=PT_PTR (JL, KK)+FOELDCPMCU (PT_PTR (JL, KK))*ZCOND
      PQ_PTR (JL, KK)=PQ_PTR (JL, KK)-ZCOND
      ZL=1.0_JPRB/(PT_PTR (JL, KK)-YDTHF%R4LES)
      ZI=1.0_JPRB/(PT_PTR (JL, KK)-YDTHF%R4IES)
      ZQSAT=YDTHF%R2ES*(FOEALFCU (PT_PTR (JL, KK))*EXP (YDTHF%R3LES*(PT_PTR (JL, KK)-YDCST%RTT)*ZL&
      &)+(1.0_JPRB-FOEALFCU (PT_PTR (JL, KK)))*EXP (YDTHF%R3IES*(PT_PTR (JL, KK)-YDCST%RTT)*ZI))
      ZQSAT=ZQSAT*ZQP
      ZQSAT=FMINJ (0.5_JPRB, ZQSAT)
      ZCOR=1.0_JPRB-YDCST%RETV*ZQSAT
      ZF=FOEALFCU (PT_PTR (JL, KK))*YDTHF%R5ALVCP*ZL**2+(1.0_JPRB&
      &-FOEALFCU (PT_PTR (JL, KK)))*YDTHF%R5ALSCP*ZI**2
      ZCOND1=(PQ_PTR (JL, KK)*ZCOR**2-ZQSAT*ZCOR)/(ZCOR**2+ZQSAT*ZF)

      IF (ZCOND==0.0_JPRB)  THEN
        ZCOND1=0.0_JPRB
      ENDIF

      PT_PTR (JL, KK)=PT_PTR (JL, KK)+FOELDCPMCU (PT_PTR (JL, KK))*ZCOND1
      PQ_PTR (JL, KK)=PQ_PTR (JL, KK)-ZCOND1
    ENDIF


    

    IF (KCALL==6) THEN

      

      IF (LDFLAG_PTR (JL).AND.LDOFLAG_PTR (JL)) THEN
        ZQP=1.0_JPRB/PSP_PTR (JL)
        ZL=1.0_JPRB/(PT_PTR (JL, KK)-YDTHF%R4LES)
        ZQSAT=YDTHF%R2ES*EXP (YDTHF%R3LES*(PT_PTR (JL, KK)-YDCST%RTT)*ZL)
        ZQSAT=ZQSAT*ZQP
        ZQSAT=MIN (0.5_JPRB, ZQSAT)
        ZCOR=1.0_JPRB-YDCST%RETV*ZQSAT
        ZF=YDTHF%R5ALVCP*ZL**2
        ZCOND=(PQ_PTR (JL, KK)*ZCOR**2-ZQSAT*ZCOR)/(ZCOR**2+ZQSAT*ZF)
        ZCOND=MAX (ZCOND, 0.0_JPRB)
        PT_PTR (JL, KK)=PT_PTR (JL, KK)+YDTHF%RALVDCP*ZCOND
        PQ_PTR (JL, KK)=PQ_PTR (JL, KK)-ZCOND
        ZL=1.0_JPRB/(PT_PTR (JL, KK)-YDTHF%R4LES)
        ZQSAT=YDTHF%R2ES*EXP (YDTHF%R3LES*(PT_PTR (JL, KK)-YDCST%RTT)*ZL)
        ZQSAT=ZQSAT*ZQP
        ZQSAT=FMINJ (0.5_JPRB, ZQSAT)
        ZCOR=1.0_JPRB-YDCST%RETV*ZQSAT
        ZF=YDTHF%R5ALVCP*ZL**2
        ZCOND1=(PQ_PTR (JL, KK)*ZCOR**2-ZQSAT*ZCOR)/(ZCOR**2+ZQSAT*ZF)

        IF (ZCOND==0.0_JPRB)  THEN
          ZCOND1=0.0_JPRB
        ENDIF

        PT_PTR (JL, KK)=PT_PTR (JL, KK)+YDTHF%RALVDCP*ZCOND1
        PQ_PTR (JL, KK)=PQ_PTR (JL, KK)-ZCOND1
      ENDIF

    
    ENDIF

  ENDIF


  IF (KCALL==2) THEN

    

    IF (LDFLAG_PTR (JL)) THEN
      ZQP=1.0_JPRB/PSP_PTR (JL)
      ZQSAT=FOEEWMCU (PT_PTR (JL, KK))*ZQP
      ZQSAT=MIN (0.5_JPRB, ZQSAT)
      ZCOR=1.0_JPRB/(1.0_JPRB-YDCST%RETV*ZQSAT)
      ZQSAT=ZQSAT*ZCOR
      ZCOND=(PQ_PTR (JL, KK)-ZQSAT)/(1.0_JPRB+ZQSAT*ZCOR*FOEDEMCU (PT_PTR (JL, KK)))
      ZCOND=MIN (ZCOND, 0.0_JPRB)
      PT_PTR (JL, KK)=PT_PTR (JL, KK)+FOELDCPMCU (PT_PTR (JL, KK))*ZCOND
      PQ_PTR (JL, KK)=PQ_PTR (JL, KK)-ZCOND
      ZQSAT=FOEEWMCU (PT_PTR (JL, KK))*ZQP
      ZQSAT=MIN (0.5_JPRB, ZQSAT)
      ZCOR=1.0_JPRB/(1.0_JPRB-YDCST%RETV*ZQSAT)
      ZQSAT=ZQSAT*ZCOR
      ZCOND1=(PQ_PTR (JL, KK)-ZQSAT)/(1.0_JPRB+ZQSAT*ZCOR*FOEDEMCU (PT_PTR (JL, KK)))

      IF (ZCOND==0.0_JPRB)  THEN
        ZCOND1=MIN (ZCOND1, 0.0_JPRB)
      ENDIF

      PT_PTR (JL, KK)=PT_PTR (JL, KK)+FOELDCPMCU (PT_PTR (JL, KK))*ZCOND1
      PQ_PTR (JL, KK)=PQ_PTR (JL, KK)-ZCOND1
    ENDIF

  
  ENDIF


  IF (KCALL==0) THEN
    
    ZQP=1.0_JPRB/PSP_PTR (JL)
    ZQSAT=FOEEWM (PT_PTR (JL, KK))*ZQP
    ZQSAT=MIN (0.5_JPRB, ZQSAT)
    ZCOR=1.0_JPRB/(1.0_JPRB-YDCST%RETV*ZQSAT)
    ZQSAT=ZQSAT*ZCOR
    ZCOND1=(PQ_PTR (JL, KK)-ZQSAT)/(1.0_JPRB+ZQSAT*ZCOR*FOEDEM (PT_PTR (JL, KK)))
    PT_PTR (JL, KK)=PT_PTR (JL, KK)+FOELDCPM (PT_PTR (JL, KK))*ZCOND1
    PQ_PTR (JL, KK)=PQ_PTR (JL, KK)-ZCOND1
    ZQSAT=FOEEWM (PT_PTR (JL, KK))*ZQP
    ZQSAT=MIN (0.5_JPRB, ZQSAT)
    ZCOR=1.0_JPRB/(1.0_JPRB-YDCST%RETV*ZQSAT)
    ZQSAT=ZQSAT*ZCOR
    ZCOND1=(PQ_PTR (JL, KK)-ZQSAT)/(1.0_JPRB+ZQSAT*ZCOR*FOEDEM (PT_PTR (JL, KK)))
    PT_PTR (JL, KK)=PT_PTR (JL, KK)+FOELDCPM (PT_PTR (JL, KK))*ZCOND1
    PQ_PTR (JL, KK)=PQ_PTR (JL, KK)-ZCOND1
  
  ENDIF


  IF (KCALL==4) THEN

    

    IF (LDFLAG_PTR (JL)) THEN
      ZQP=1.0_JPRB/PSP_PTR (JL)
      ZQSAT=FOEEWM (PT_PTR (JL, KK))*ZQP
      ZQSAT=MIN (0.5_JPRB, ZQSAT)
      ZCOR=1.0_JPRB/(1.0_JPRB-YDCST%RETV*ZQSAT)
      ZQSAT=ZQSAT*ZCOR
      ZCOND=(PQ_PTR (JL, KK)-ZQSAT)/(1.0_JPRB+ZQSAT*ZCOR*FOEDEM (PT_PTR (JL, KK)))
      PT_PTR (JL, KK)=PT_PTR (JL, KK)+FOELDCPM (PT_PTR (JL, KK))*ZCOND
      PQ_PTR (JL, KK)=PQ_PTR (JL, KK)-ZCOND
      ZQSAT=FOEEWM (PT_PTR (JL, KK))*ZQP
      ZQSAT=MIN (0.5_JPRB, ZQSAT)
      ZCOR=1.0_JPRB/(1.0_JPRB-YDCST%RETV*ZQSAT)
      ZQSAT=ZQSAT*ZCOR
      ZCOND1=(PQ_PTR (JL, KK)-ZQSAT)/(1.0_JPRB+ZQSAT*ZCOR*FOEDEM (PT_PTR (JL, KK)))
      PT_PTR (JL, KK)=PT_PTR (JL, KK)+FOELDCPM (PT_PTR (JL, KK))*ZCOND1
      PQ_PTR (JL, KK)=PQ_PTR (JL, KK)-ZCOND1
    ENDIF

  
  ENDIF


  IF (KCALL==5) THEN
    
    ZQP=1.0_JPRB/PSP_PTR (JL)
    ZQSAT=FOEEWM (PT_PTR (JL, KK))*ZQP
    ZQSAT=MIN (0.5_JPRB, ZQSAT)
    ZCOR=1.0_JPRB/(1.0_JPRB-YDCST%RETV*ZQSAT)
    ZQSAT=ZQSAT*ZCOR
    ZCOND=(PQ_PTR (JL, KK)-ZQSAT)/(1.0_JPRB+ZQSAT*ZCOR*FOEDEM (PT_PTR (JL, KK)))
    PT_PTR (JL, KK)=PT_PTR (JL, KK)+FOELDCPM (PT_PTR (JL, KK))*ZCOND
    PQ_PTR (JL, KK)=PQ_PTR (JL, KK)-ZCOND
    ZQSAT=FOEEWM (PT_PTR (JL, KK))*ZQP
    ZQSAT=MIN (0.5_JPRB, ZQSAT)
    ZCOR=1.0_JPRB/(1.0_JPRB-YDCST%RETV*ZQSAT)
    ZQSAT=ZQSAT*ZCOR
    ZCOND1=(PQ_PTR (JL, KK)-ZQSAT)/(1.0_JPRB+ZQSAT*ZCOR*FOEDEM (PT_PTR (JL, KK)))
    PT_PTR (JL, KK)=PT_PTR (JL, KK)+FOELDCPM (PT_PTR (JL, KK))*ZCOND1
    PQ_PTR (JL, KK)=PQ_PTR (JL, KK)-ZCOND1
  
  ENDIF


  IF (KCALL==3) THEN
    
    ZQP=1.0_JPRB/PSP_PTR (JL)
    ZQSAT=FOEEWMCU (PT_PTR (JL, KK))*ZQP
    ZQSAT=MIN (0.5_JPRB, ZQSAT)
    ZCOR=1.0_JPRB/(1.0_JPRB-YDCST%RETV*ZQSAT)
    ZQSAT=ZQSAT*ZCOR
    ZCOND1=(PQ_PTR (JL, KK)-ZQSAT)/(1.0_JPRB+ZQSAT*ZCOR*FOEDEMCU (PT_PTR (JL, KK)))
    PT_PTR (JL, KK)=PT_PTR (JL, KK)+FOELDCPMCU (PT_PTR (JL, KK))*ZCOND1
    PQ_PTR (JL, KK)=PQ_PTR (JL, KK)-ZCOND1
    ZQSAT=FOEEWMCU (PT_PTR (JL, KK))*ZQP
    ZQSAT=MIN (0.5_JPRB, ZQSAT)
    ZCOR=1.0_JPRB/(1.0_JPRB-YDCST%RETV*ZQSAT)
    ZQSAT=ZQSAT*ZCOR
    ZCOND1=(PQ_PTR (JL, KK)-ZQSAT)/(1.0_JPRB+ZQSAT*ZCOR*FOEDEMCU (PT_PTR (JL, KK)))
    PT_PTR (JL, KK)=PT_PTR (JL, KK)+FOELDCPMCU (PT_PTR (JL, KK))*ZCOND1
    PQ_PTR (JL, KK)=PQ_PTR (JL, KK)-ZCOND1
  
  ENDIF

ELSE

  IF (KCALL==1) THEN

    

    IF (LDFLAG_PTR (JL)) THEN
      ZQP=1.0_JPRB/PSP_PTR (JL)
      ZTARG=PT_PTR (JL, KK)
      ZOEALFA=0.5_JPRB*(TANH (YDEPHLI%RLPAL1*(ZTARG-YDEPHLI%RLPTRC))+1.0_JPRB)
      ZFOEEWL=YDTHF%R2ES*EXP (YDTHF%R3LES*(ZTARG-YDCST%RTT)/(ZTARG-YDTHF%R4LES))
      ZFOEEWI=YDTHF%R2ES*EXP (YDTHF%R3IES*(ZTARG-YDCST%RTT)/(ZTARG-YDTHF%R4IES))
      ZQSAT=ZQP*(ZOEALFA*ZFOEEWL+(1.0_JPRB-ZOEALFA)*ZFOEEWI)
      Z1S=TANH (YDEPHLI%RLPAL2*(ZQSAT-ZQMAX))
      ZQSAT=0.5_JPRB*((1.0_JPRB-Z1S)*ZQSAT+(1.0_JPRB+Z1S)*ZQMAX)
      ZCOR=1.0_JPRB/(1.0_JPRB-YDCST%RETV*ZQSAT)
      ZQSAT=ZQSAT*ZCOR
      Z2S=ZOEALFA*YDTHF%R5ALVCP*(1.0_JPRB/(ZTARG-YDTHF%R4LES)**2)+(1.0_JPRB&
      &-ZOEALFA)*YDTHF%R5ALSCP*(1.0_JPRB/(ZTARG-YDTHF%R4IES)**2)
      ZCOND=(PQ_PTR (JL, KK)-ZQSAT)/(1.0_JPRB+ZQSAT*ZCOR*Z2S)
      ZCOND=MAX (ZCOND, 0.0_JPRB)

      IF (ZCOND/=0.0_JPRB) THEN
        PT_PTR (JL, KK)=PT_PTR (JL, KK)+(ZOEALFA*YDTHF%RALVDCP+(1.0_JPRB-ZOEALFA)*YDTHF%RALSDCP)*ZCOND
        PQ_PTR (JL, KK)=PQ_PTR (JL, KK)-ZCOND
        ZTARG=PT_PTR (JL, KK)
        ZOEALFA=0.5_JPRB*(TANH (YDEPHLI%RLPAL1*(ZTARG-YDEPHLI%RLPTRC))+1.0_JPRB)
        ZFOEEWL=YDTHF%R2ES*EXP (YDTHF%R3LES*(ZTARG-YDCST%RTT)/(ZTARG-YDTHF%R4LES))
        ZFOEEWI=YDTHF%R2ES*EXP (YDTHF%R3IES*(ZTARG-YDCST%RTT)/(ZTARG-YDTHF%R4IES))
        ZQSAT=ZQP*(ZOEALFA*ZFOEEWL+(1.0_JPRB-ZOEALFA)*ZFOEEWI)
        Z1S=TANH (YDEPHLI%RLPAL2*(ZQSAT-ZQMAX))
        ZQSAT=0.5_JPRB*((1.0_JPRB-Z1S)*ZQSAT+(1.0_JPRB+Z1S)*ZQMAX)
        ZCOR=1.0_JPRB/(1.0_JPRB-YDCST%RETV*ZQSAT)
        ZQSAT=ZQSAT*ZCOR
        Z2S=ZOEALFA*YDTHF%R5ALVCP*(1.0_JPRB/(ZTARG-YDTHF%R4LES)**2)+(1.0_JPRB&
        &-ZOEALFA)*YDTHF%R5ALSCP*(1.0_JPRB/(ZTARG-YDTHF%R4IES)**2)
        ZCOND1=(PQ_PTR (JL, KK)-ZQSAT)/(1.0_JPRB+ZQSAT*ZCOR*Z2S)
        PT_PTR (JL, KK)=PT_PTR (JL, KK)+(ZOEALFA*YDTHF%RALVDCP+(1.0_JPRB-ZOEALFA)*YDTHF%RALSDCP)*ZCOND1
        PQ_PTR (JL, KK)=PQ_PTR (JL, KK)-ZCOND1
      ENDIF

    ENDIF

  
  ENDIF


  IF (KCALL==2) THEN

    

    IF (LDFLAG_PTR (JL)) THEN
      ZQP=1.0_JPRB/PSP_PTR (JL)
      ZTARG=PT_PTR (JL, KK)
      ZOEALFA=0.5_JPRB*(TANH (YDEPHLI%RLPAL1*(ZTARG-YDEPHLI%RLPTRC))+1.0_JPRB)
      ZFOEEWL=YDTHF%R2ES*EXP (YDTHF%R3LES*(ZTARG-YDCST%RTT)/(ZTARG-YDTHF%R4LES))
      ZFOEEWI=YDTHF%R2ES*EXP (YDTHF%R3IES*(ZTARG-YDCST%RTT)/(ZTARG-YDTHF%R4IES))
      ZQSAT=ZQP*(ZOEALFA*ZFOEEWL+(1.0_JPRB-ZOEALFA)*ZFOEEWI)
      Z1S=TANH (YDEPHLI%RLPAL2*(ZQSAT-ZQMAX))
      ZQSAT=0.5_JPRB*((1.0_JPRB-Z1S)*ZQSAT+(1.0_JPRB+Z1S)*ZQMAX)
      ZCOR=1.0_JPRB/(1.0_JPRB-YDCST%RETV*ZQSAT)
      ZQSAT=ZQSAT*ZCOR
      Z2S=ZOEALFA*YDTHF%R5ALVCP*(1.0_JPRB/(ZTARG-YDTHF%R4LES)**2)+(1.0_JPRB&
      &-ZOEALFA)*YDTHF%R5ALSCP*(1.0_JPRB/(ZTARG-YDTHF%R4IES)**2)
      ZCOND=(PQ_PTR (JL, KK)-ZQSAT)/(1.0_JPRB+ZQSAT*ZCOR*Z2S)
      ZCOND=MIN (ZCOND, 0.0_JPRB)

      IF (ZCOND/=0.0_JPRB) THEN
        PT_PTR (JL, KK)=PT_PTR (JL, KK)+(ZOEALFA*YDTHF%RALVDCP+(1.0_JPRB-ZOEALFA)*YDTHF%RALSDCP)*ZCOND
        PQ_PTR (JL, KK)=PQ_PTR (JL, KK)-ZCOND
        ZTARG=PT_PTR (JL, KK)
        ZOEALFA=0.5_JPRB*(TANH (YDEPHLI%RLPAL1*(ZTARG-YDEPHLI%RLPTRC))+1.0_JPRB)
        ZFOEEWL=YDTHF%R2ES*EXP (YDTHF%R3LES*(ZTARG-YDCST%RTT)/(ZTARG-YDTHF%R4LES))
        ZFOEEWI=YDTHF%R2ES*EXP (YDTHF%R3IES*(ZTARG-YDCST%RTT)/(ZTARG-YDTHF%R4IES))
        ZQSAT=ZQP*(ZOEALFA*ZFOEEWL+(1.0_JPRB-ZOEALFA)*ZFOEEWI)
        Z1S=TANH (YDEPHLI%RLPAL2*(ZQSAT-ZQMAX))
        ZQSAT=0.5_JPRB*((1.0_JPRB-Z1S)*ZQSAT+(1.0_JPRB+Z1S)*ZQMAX)
        ZCOR=1.0_JPRB/(1.0_JPRB-YDCST%RETV*ZQSAT)
        ZQSAT=ZQSAT*ZCOR
        Z2S=ZOEALFA*YDTHF%R5ALVCP*(1.0_JPRB/(ZTARG-YDTHF%R4LES)**2)+(1.0_JPRB&
        &-ZOEALFA)*YDTHF%R5ALSCP*(1.0_JPRB/(ZTARG-YDTHF%R4IES)**2)
        ZCOND1=(PQ_PTR (JL, KK)-ZQSAT)/(1.0_JPRB+ZQSAT*ZCOR*Z2S)
        PT_PTR (JL, KK)=PT_PTR (JL, KK)+(ZOEALFA*YDTHF%RALVDCP+(1.0_JPRB-ZOEALFA)*YDTHF%RALSDCP)*ZCOND1
        PQ_PTR (JL, KK)=PQ_PTR (JL, KK)-ZCOND1
      ENDIF

    ENDIF

  
  ENDIF


  IF (KCALL==0) THEN
    
    ZQP=1.0_JPRB/PSP_PTR (JL)
    ZTARG=PT_PTR (JL, KK)
    ZOEALFA=0.5_JPRB*(TANH (YDEPHLI%RLPAL1*(ZTARG-YDEPHLI%RLPTRC))+1.0_JPRB)
    ZFOEEWL=YDTHF%R2ES*EXP (YDTHF%R3LES*(ZTARG-YDCST%RTT)/(ZTARG-YDTHF%R4LES))
    ZFOEEWI=YDTHF%R2ES*EXP (YDTHF%R3IES*(ZTARG-YDCST%RTT)/(ZTARG-YDTHF%R4IES))
    ZQSAT=ZQP*(ZOEALFA*ZFOEEWL+(1.0_JPRB-ZOEALFA)*ZFOEEWI)
    Z1S=TANH (YDEPHLI%RLPAL2*(ZQSAT-ZQMAX))
    ZQSAT=0.5_JPRB*((1.0_JPRB-Z1S)*ZQSAT+(1.0_JPRB+Z1S)*ZQMAX)
    ZCOR=1.0_JPRB/(1.0_JPRB-YDCST%RETV*ZQSAT)
    ZQSAT=ZQSAT*ZCOR
    Z2S=ZOEALFA*YDTHF%R5ALVCP*(1.0_JPRB/(ZTARG-YDTHF%R4LES)**2)+(1.0_JPRB&
    &-ZOEALFA)*YDTHF%R5ALSCP*(1.0_JPRB/(ZTARG-YDTHF%R4IES)**2)
    ZCOND1=(PQ_PTR (JL, KK)-ZQSAT)/(1.0_JPRB+ZQSAT*ZCOR*Z2S)
    PT_PTR (JL, KK)=PT_PTR (JL, KK)+(ZOEALFA*YDTHF%RALVDCP+(1.0_JPRB-ZOEALFA)*YDTHF%RALSDCP)*ZCOND1
    PQ_PTR (JL, KK)=PQ_PTR (JL, KK)-ZCOND1
    ZTARG=PT_PTR (JL, KK)
    ZOEALFA=0.5_JPRB*(TANH (YDEPHLI%RLPAL1*(ZTARG-YDEPHLI%RLPTRC))+1.0_JPRB)
    ZFOEEWL=YDTHF%R2ES*EXP (YDTHF%R3LES*(ZTARG-YDCST%RTT)/(ZTARG-YDTHF%R4LES))
    ZFOEEWI=YDTHF%R2ES*EXP (YDTHF%R3IES*(ZTARG-YDCST%RTT)/(ZTARG-YDTHF%R4IES))
    ZQSAT=ZQP*(ZOEALFA*ZFOEEWL+(1.0_JPRB-ZOEALFA)*ZFOEEWI)
    Z1S=TANH (YDEPHLI%RLPAL2*(ZQSAT-ZQMAX))
    ZQSAT=0.5_JPRB*((1.0_JPRB-Z1S)*ZQSAT+(1.0_JPRB+Z1S)*ZQMAX)
    ZCOR=1.0_JPRB/(1.0_JPRB-YDCST%RETV*ZQSAT)
    ZQSAT=ZQSAT*ZCOR
    Z2S=ZOEALFA*YDTHF%R5ALVCP*(1.0_JPRB/(ZTARG-YDTHF%R4LES)**2)+(1.0_JPRB&
    &-ZOEALFA)*YDTHF%R5ALSCP*(1.0_JPRB/(ZTARG-YDTHF%R4IES)**2)
    ZCOND1=(PQ_PTR (JL, KK)-ZQSAT)/(1.0_JPRB+ZQSAT*ZCOR*Z2S)
    PT_PTR (JL, KK)=PT_PTR (JL, KK)+(ZOEALFA*YDTHF%RALVDCP+(1.0_JPRB-ZOEALFA)*YDTHF%RALSDCP)*ZCOND1
    PQ_PTR (JL, KK)=PQ_PTR (JL, KK)-ZCOND1
  
  ENDIF


  IF (KCALL==4) THEN

    

    IF (LDFLAG_PTR (JL)) THEN
      ZQP=1.0_JPRB/PSP_PTR (JL)
      ZTARG=PT_PTR (JL, KK)
      ZOEALFA=0.5_JPRB*(TANH (YDEPHLI%RLPAL1*(ZTARG-YDEPHLI%RLPTRC))+1.0_JPRB)
      ZFOEEWL=YDTHF%R2ES*EXP (YDTHF%R3LES*(ZTARG-YDCST%RTT)/(ZTARG-YDTHF%R4LES))
      ZFOEEWI=YDTHF%R2ES*EXP (YDTHF%R3IES*(ZTARG-YDCST%RTT)/(ZTARG-YDTHF%R4IES))
      ZQSAT=ZQP*(ZOEALFA*ZFOEEWL+(1.0_JPRB-ZOEALFA)*ZFOEEWI)
      Z1S=TANH (YDEPHLI%RLPAL2*(ZQSAT-ZQMAX))
      ZQSAT=0.5_JPRB*((1.0_JPRB-Z1S)*ZQSAT+(1.0_JPRB+Z1S)*ZQMAX)
      ZCOR=1.0_JPRB/(1.0_JPRB-YDCST%RETV*ZQSAT)
      ZQSAT=ZQSAT*ZCOR
      Z2S=ZOEALFA*YDTHF%R5ALVCP*(1.0_JPRB/(ZTARG-YDTHF%R4LES)**2)+(1.0_JPRB&
      &-ZOEALFA)*YDTHF%R5ALSCP*(1.0_JPRB/(ZTARG-YDTHF%R4IES)**2)
      ZCOND=(PQ_PTR (JL, KK)-ZQSAT)/(1.0_JPRB+ZQSAT*ZCOR*Z2S)
      PT_PTR (JL, KK)=PT_PTR (JL, KK)+(ZOEALFA*YDTHF%RALVDCP+(1.0_JPRB-ZOEALFA)*YDTHF%RALSDCP)*ZCOND
      PQ_PTR (JL, KK)=PQ_PTR (JL, KK)-ZCOND
      ZTARG=PT_PTR (JL, KK)
      ZOEALFA=0.5_JPRB*(TANH (YDEPHLI%RLPAL1*(ZTARG-YDEPHLI%RLPTRC))+1.0_JPRB)
      ZFOEEWL=YDTHF%R2ES*EXP (YDTHF%R3LES*(ZTARG-YDCST%RTT)/(ZTARG-YDTHF%R4LES))
      ZFOEEWI=YDTHF%R2ES*EXP (YDTHF%R3IES*(ZTARG-YDCST%RTT)/(ZTARG-YDTHF%R4IES))
      ZQSAT=ZQP*(ZOEALFA*ZFOEEWL+(1.0_JPRB-ZOEALFA)*ZFOEEWI)
      Z1S=TANH (YDEPHLI%RLPAL2*(ZQSAT-ZQMAX))
      ZQSAT=0.5_JPRB*((1.0_JPRB-Z1S)*ZQSAT+(1.0_JPRB+Z1S)*ZQMAX)
      ZQSAT=MIN (ZQMAX, ZQSAT)
      ZCOR=1.0_JPRB/(1.0_JPRB-YDCST%RETV*ZQSAT)
      ZQSAT=ZQSAT*ZCOR
      Z2S=ZOEALFA*YDTHF%R5ALVCP*(1.0_JPRB/(ZTARG-YDTHF%R4LES)**2)+(1.0_JPRB&
      &-ZOEALFA)*YDTHF%R5ALSCP*(1.0_JPRB/(ZTARG-YDTHF%R4IES)**2)
      ZCOND1=(PQ_PTR (JL, KK)-ZQSAT)/(1.0_JPRB+ZQSAT*ZCOR*Z2S)
      PT_PTR (JL, KK)=PT_PTR (JL, KK)+(ZOEALFA*YDTHF%RALVDCP+(1.0_JPRB-ZOEALFA)*YDTHF%RALSDCP)*ZCOND1
      PQ_PTR (JL, KK)=PQ_PTR (JL, KK)-ZCOND1
    ENDIF

  
  ENDIF

ENDIF


ENDSUBROUTINE CUADJTQ_OPENACC
