SUBROUTINE RECMWF_PREPARE (KAERO, KOZOCL, YDCPG_BNDS, YDCPG_OPTS, YDMODEL, PCRAE, PAER&
&, PAERO, PAPRS, PAPRSF, PDELP, PEMIS, PMU0M, PNEB, PQ, PQC11, PQC12, PQC22, PQCH4&
&, PQCL4, PQCO2, PQICE, PQLIQ, PQN2O, PQNO2, PQO3, PQSAT, PT, PTS, PCCNL, PCCNO, PEMIW&
&, PNBAS, PNTOP, PPAERO, PPQO3, ZQ, PQIWP, PQLWP, PQS, PRAER, PRC11, PRC12, PRC22,&
& PRCH4, PRCL4, PRCLC, PRCO2, PRMU0, PRN2O, PRNO2, PSPECTRALEMISS, PTH)
USE CPG_OPTS_TYPE_MOD,ONLY:CPG_BNDS_TYPE, CPG_OPTS_TYPE
USE PARKIND1,ONLY:JPIM, JPRB
USE TYPE_MODEL,ONLY:MODEL
USE YOMHOOK,ONLY:LHOOK, JPHOOK, DR_HOOK

IMPLICIT NONE

INTEGER (KIND=JPIM), INTENT (IN)::KAERO
INTEGER (KIND=JPIM), INTENT (IN)::KOZOCL
TYPE (CPG_BNDS_TYPE), INTENT (IN)::YDCPG_BNDS
TYPE (CPG_OPTS_TYPE), INTENT (IN)::YDCPG_OPTS
TYPE (MODEL), INTENT (IN)::YDMODEL
REAL (KIND=JPRB), INTENT (INOUT)::PCRAE
REAL (KIND=JPRB), INTENT (IN)::PAER (YDCPG_OPTS%KLON, YDCPG_OPTS%KFLEVG, 6)
REAL (KIND=JPRB), INTENT (IN)::PAERO (YDCPG_OPTS%KLON, YDCPG_OPTS%KFLEVG, KAERO)
REAL (KIND=JPRB), INTENT (IN)::PAPRS (YDCPG_OPTS%KLON, 0:YDCPG_OPTS%KFLEVG)
REAL (KIND=JPRB), INTENT (IN)::PAPRSF (YDCPG_OPTS%KLON, YDCPG_OPTS%KFLEVG)
REAL (KIND=JPRB), INTENT (IN)::PDELP (YDCPG_OPTS%KLON, YDCPG_OPTS%KFLEVG)
REAL (KIND=JPRB), INTENT (IN)::PEMIS (YDCPG_OPTS%KLON)
REAL (KIND=JPRB), INTENT (IN)::PMU0M (YDCPG_OPTS%KLON)
REAL (KIND=JPRB), INTENT (IN)::PNEB (YDCPG_OPTS%KLON, YDCPG_OPTS%KFLEVG)
REAL (KIND=JPRB), INTENT (IN)::PQ (YDCPG_OPTS%KLON, YDCPG_OPTS%KFLEVG)
REAL (KIND=JPRB), INTENT (IN)::PQC11 (YDCPG_OPTS%KLON, YDCPG_OPTS%KFLEVG)
REAL (KIND=JPRB), INTENT (IN)::PQC12 (YDCPG_OPTS%KLON, YDCPG_OPTS%KFLEVG)
REAL (KIND=JPRB), INTENT (IN)::PQC22 (YDCPG_OPTS%KLON, YDCPG_OPTS%KFLEVG)
REAL (KIND=JPRB), INTENT (IN)::PQCH4 (YDCPG_OPTS%KLON, YDCPG_OPTS%KFLEVG)
REAL (KIND=JPRB), INTENT (IN)::PQCL4 (YDCPG_OPTS%KLON, YDCPG_OPTS%KFLEVG)
REAL (KIND=JPRB), INTENT (IN)::PQCO2 (YDCPG_OPTS%KLON, YDCPG_OPTS%KFLEVG)
REAL (KIND=JPRB), INTENT (IN)::PQICE (YDCPG_OPTS%KLON, YDCPG_OPTS%KFLEVG)
REAL (KIND=JPRB), INTENT (IN)::PQLIQ (YDCPG_OPTS%KLON, YDCPG_OPTS%KFLEVG)
REAL (KIND=JPRB), INTENT (IN)::PQN2O (YDCPG_OPTS%KLON, YDCPG_OPTS%KFLEVG)
REAL (KIND=JPRB), INTENT (IN)::PQNO2 (YDCPG_OPTS%KLON, YDCPG_OPTS%KFLEVG)
REAL (KIND=JPRB), INTENT (IN)::PQO3 (YDCPG_OPTS%KLON, 0:YDCPG_OPTS%KFLEVG)
REAL (KIND=JPRB), INTENT (IN)::PQSAT (YDCPG_OPTS%KLON, YDCPG_OPTS%KFLEVG)
REAL (KIND=JPRB), INTENT (IN)::PT (YDCPG_OPTS%KLON, YDCPG_OPTS%KFLEVG)
REAL (KIND=JPRB), INTENT (IN)::PTS (YDCPG_OPTS%KLON)
REAL (KIND=JPRB), INTENT (INOUT)::PCCNL (YDCPG_OPTS%KLON)
REAL (KIND=JPRB), INTENT (INOUT)::PCCNO (YDCPG_OPTS%KLON)
REAL (KIND=JPRB), INTENT (INOUT)::PEMIW (YDCPG_OPTS%KLON)
REAL (KIND=JPRB), INTENT (INOUT)::PNBAS (YDCPG_OPTS%KLON)
REAL (KIND=JPRB), INTENT (INOUT)::PNTOP (YDCPG_OPTS%KLON)
REAL (KIND=JPRB), INTENT (INOUT)::PPAERO (YDCPG_OPTS%KLON, YDCPG_OPTS%KFLEVG, KAERO)
REAL (KIND=JPRB), INTENT (INOUT)::PPQO3 (YDCPG_OPTS%KLON, YDCPG_OPTS%KFLEVG)
REAL (KIND=JPRB), INTENT (INOUT)::ZQ (YDCPG_OPTS%KLON, YDCPG_OPTS%KFLEVG)
REAL (KIND=JPRB), INTENT (INOUT)::PQIWP (YDCPG_OPTS%KLON, YDCPG_OPTS%KFLEVG)
REAL (KIND=JPRB), INTENT (INOUT)::PQLWP (YDCPG_OPTS%KLON, YDCPG_OPTS%KFLEVG)
REAL (KIND=JPRB), INTENT (INOUT)::PQS (YDCPG_OPTS%KLON, YDCPG_OPTS%KFLEVG)
REAL (KIND=JPRB), INTENT (INOUT)::PRAER (YDCPG_OPTS%KLON, 6, YDCPG_OPTS%KFLEVG)
REAL (KIND=JPRB), INTENT (INOUT)::PRC11 (YDCPG_OPTS%KLON, YDCPG_OPTS%KFLEVG)
REAL (KIND=JPRB), INTENT (INOUT)::PRC12 (YDCPG_OPTS%KLON, YDCPG_OPTS%KFLEVG)
REAL (KIND=JPRB), INTENT (INOUT)::PRC22 (YDCPG_OPTS%KLON, YDCPG_OPTS%KFLEVG)
REAL (KIND=JPRB), INTENT (INOUT)::PRCH4 (YDCPG_OPTS%KLON, YDCPG_OPTS%KFLEVG)
REAL (KIND=JPRB), INTENT (INOUT)::PRCL4 (YDCPG_OPTS%KLON, YDCPG_OPTS%KFLEVG)
REAL (KIND=JPRB), INTENT (INOUT)::PRCLC (YDCPG_OPTS%KLON, YDCPG_OPTS%KFLEVG)
REAL (KIND=JPRB), INTENT (INOUT)::PRCO2 (YDCPG_OPTS%KLON, YDCPG_OPTS%KFLEVG)
REAL (KIND=JPRB), INTENT (INOUT)::PRMU0 (YDCPG_OPTS%KLON)
REAL (KIND=JPRB), INTENT (INOUT)::PRN2O (YDCPG_OPTS%KLON, YDCPG_OPTS%KFLEVG)
REAL (KIND=JPRB), INTENT (INOUT)::PRNO2 (YDCPG_OPTS%KLON, YDCPG_OPTS%KFLEVG)
REAL (KIND=JPRB), INTENT (INOUT)::PSPECTRALEMISS (YDCPG_OPTS&
&%KLON, YDMODEL%YRML_PHY_RAD%YRERAD%NLWEMISS)
REAL (KIND=JPRB), INTENT (INOUT)::PTH (YDCPG_OPTS%KLON, 0:YDCPG_OPTS%KFLEVG)
INTEGER (KIND=JPIM)::JEMIS
INTEGER (KIND=JPIM)::JLEV
INTEGER (KIND=JPIM)::JLON
REAL (KIND=JPRB)::ZFRAC
REAL (KIND=JPHOOK)::ZHOOK_HANDLE
IF (LHOOK) CALL DR_HOOK ('RECMWF_PREPARE', 0, ZHOOK_HANDLE)

IF (KOZOCL==4.OR.KOZOCL==5.OR.KOZOCL==6) THEN
  PRCH4 (:,:)=PQCH4 (:,:)
  PRN2O (:,:)=PQN2O (:,:)
  PRNO2 (:,:)=PQNO2 (:,:)
  PRC11 (:,:)=PQC11 (:,:)
  PRC12 (:,:)=PQC12 (:,:)
  PRC22 (:,:)=PQC22 (:,:)
  PRCL4 (:,:)=PQCL4 (:,:)
  PRCO2 (:,:)=PQCO2 (:,:)
ELSE
  PRCH4 (:,:)=YDMODEL%YRML_PHY_RAD%YRERDI%RCH4
  PRN2O (:,:)=YDMODEL%YRML_PHY_RAD%YRERDI%RN2O
  PRNO2 (:,:)=YDMODEL%YRML_PHY_RAD%YRERDI%RNO2
  PRC11 (:,:)=YDMODEL%YRML_PHY_RAD%YRERDI%RCFC11
  PRC12 (:,:)=YDMODEL%YRML_PHY_RAD%YRERDI%RCFC12
  PRC22 (:,:)=YDMODEL%YRML_PHY_RAD%YRERDI%RCFC22
  PRCL4 (:,:)=YDMODEL%YRML_PHY_RAD%YRERDI%RCCL4
  PRCO2 (:,:)=YDMODEL%YRML_PHY_RAD%YRERDI%RCARDI
ENDIF


IF (KAERO>0) THEN
  PPAERO (:,:,:)=PAERO (:,:,:)
ELSE
  PPAERO (:,:,:)=0.0_JPRB
ENDIF

PRAER (:,:,:)=0.0_JPRB
PNBAS (:)=1.0_JPRB
PNTOP (:)=1.0_JPRB
PCCNL (:)=YDMODEL%YRML_PHY_RAD%YRERAD%RCCNLND
PCCNO (:)=YDMODEL%YRML_PHY_RAD%YRERAD%RCCNSEA

DO JLEV=1, YDCPG_OPTS%KFLEVG

  DO JLON=YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA
    PPQO3 (JLON, JLEV)=PQO3 (JLON, JLEV)*PDELP (JLON, JLEV)
    PRCLC (JLON, JLEV)=MAX (0.0_JPRB, MIN (1.0_JPRB, PNEB (JLON, JLEV)))

    IF (YDMODEL%YRML_PHY_MF%YRPARAR%LICERAD) THEN
      ZFRAC=PQICE (JLON, JLEV)/(PQLIQ (JLON, JLEV)+PQICE (JLON, JLEV)+1.0E-15_JPRB)
      PRCLC (JLON, JLEV)=ZFRAC+(1.0_JPRB-ZFRAC)*PRCLC (JLON, JLEV)
    ENDIF


    IF (PRCLC (JLON, JLEV)>YDMODEL%YRML_PHY_RAD%YRERDI%REPCLC) THEN
      PQLWP (JLON, JLEV)=PQLIQ (JLON, JLEV)
      PQIWP (JLON, JLEV)=PQICE (JLON, JLEV)
    ELSE
      PQLWP (JLON, JLEV)=YDMODEL%YRML_PHY_RAD%YRERDI%REPH2O*PRCLC (JLON, JLEV)
      PQIWP (JLON, JLEV)=YDMODEL%YRML_PHY_RAD%YRERDI%REPH2O*PRCLC (JLON, JLEV)
    ENDIF

    PQS (JLON, JLEV)=MAX (2.0_JPRB*YDMODEL%YRML_PHY_RAD%YRERDI%REPH2O, PQSAT (JLON, JLEV))
    ZQ (JLON, JLEV)=MAX (YDMODEL%YRML_PHY_RAD%YRERDI%REPH2O, MIN (PQ (JLON, JLEV&
    &), PQS (JLON, JLEV)*(1.0_JPRB-YDMODEL%YRML_PHY_RAD%YRERDI%REPH2O)))

    IF (YDMODEL%YRML_PHY_MF%YRPARAR%LQVTOP) THEN
      ZFRAC=MIN (1._JPRB, PAPRSF (JLON, JLEV)/YDMODEL%YRML_PHY_MF%YRPARAR%GQVPLIM)
      ZQ (JLON, JLEV)=ZFRAC*MAX (YDMODEL%YRML_PHY_MF%YRPARAR%XCQVR*PQSAT (JLON, JLEV&
      &), ZQ (JLON, JLEV))+(1._JPRB-ZFRAC)*YDMODEL%YRML_PHY_MF%YRPARAR%GQVTOP
    ENDIF

  ENDDO

ENDDO


DO JEMIS=1, YDMODEL%YRML_PHY_RAD%YRERAD%NLWEMISS
  PSPECTRALEMISS (:, JEMIS)=PEMIS (:)
ENDDO


DO JLON=YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA
  PEMIW (JLON)=PEMIS (JLON)
ENDDO


IF (YDMODEL%YRML_PHY_RAD%YRERAD%NAER==0) THEN
  PRAER=YDMODEL%YRML_PHY_RAD%YREAERD%RCAEROS
ELSE

  DO JLEV=1, YDCPG_OPTS%KFLEVG

    DO JLON=YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA

      IF (YDMODEL%YRML_PHY_MF%YRPHY%LAEROLAN) THEN
        PRAER (JLON, 1, JLEV)=PAER (JLON, JLEV, 1)
      ENDIF


      IF (YDMODEL%YRML_PHY_MF%YRPHY%LAEROSEA) THEN
        PRAER (JLON, 2, JLEV)=PAER (JLON, JLEV, 2)
      ENDIF


      IF (YDMODEL%YRML_PHY_MF%YRPHY%LAERODES) THEN
        PRAER (JLON, 3, JLEV)=PAER (JLON, JLEV, 3)
      ENDIF


      IF (YDMODEL%YRML_PHY_MF%YRPHY%LAEROSOO) THEN
        PRAER (JLON, 4, JLEV)=PAER (JLON, JLEV, 4)
      ENDIF


      IF (YDMODEL%YRML_PHY_MF%YRPHY%LAEROVOL) THEN
        PRAER (JLON, 5, JLEV)=YDMODEL%YRML_PHY_RAD%YREAERD%RCAEROS
      ENDIF


      IF (YDMODEL%YRML_PHY_MF%YRPHY%LAEROSUL) THEN
        PRAER (JLON, 6, JLEV)=PAER (JLON, JLEV, 6)
      ENDIF

    ENDDO

  ENDDO

ENDIF


DO JLEV=2, YDCPG_OPTS%KFLEVG

  DO JLON=YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA
    PTH (JLON, JLEV-1)=(PT (JLON, JLEV-1)*PAPRSF (JLON, JLEV-1)*(PAPRSF (JLON, JLEV)-PAPRS (JLON&
    &, JLEV-1))+PT (JLON, JLEV)*PAPRSF (JLON, JLEV)*(PAPRS (JLON, JLEV-1)-PAPRSF (JLON, JLEV-1&
    &)))*(1.0_JPRB/(PAPRS (JLON, JLEV-1)*(PAPRSF (JLON, JLEV)-PAPRSF (JLON, JLEV-1))))
  ENDDO

ENDDO


DO JLON=YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA
  PTH (JLON, YDCPG_OPTS%KFLEVG)=PTS (JLON)
  PTH (JLON, 0)=PT (JLON, 1)-PAPRSF (JLON, 1)*(PT (JLON, 1&
  &)-PTH (JLON, 1))/(PAPRSF (JLON, 1)-PAPRS (JLON, 1))
ENDDO


DO JLON=YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA

  IF (PMU0M (JLON)>1.E-10_JPRB) THEN
    PRMU0 (JLON)=YDMODEL%YRML_PHY_RAD%YRERDI%RRAE/(SQRT (PMU0M (JLON)**2+PCRAE)-PMU0M (JLON))
  ELSE
    PRMU0 (JLON)=YDMODEL%YRML_PHY_RAD%YRERDI%RRAE/SQRT (PCRAE)
  ENDIF

ENDDO

IF (LHOOK) CALL DR_HOOK ('RECMWF_PREPARE', 1, ZHOOK_HANDLE)
ENDSUBROUTINE
