SUBROUTINE LARMES_LARMES (LDO, LDSLHD, LDSLHDQUAD, LSMOOTH, YDA_KVSEPC, YDA_KVSEPL, YDCPG_BNDS&
&, YDCPG_SL1, YDCPG_SL2, YDCST, YDGEOMETRY, YDGEOMVARS, YDMASK_SL2, YDML_DYN, YDRIP, YDSL&
&, KL0, KLEV, KLH0, PCCO, PLEV, PLSCAW, PRSCAW, PSCO, PUF, PVF, PWF)
USE CPG_OPTS_TYPE_MOD,ONLY:CPG_OPTS_TYPE, CPG_BNDS_TYPE
USE CPG_SL1_TYPE_MOD,ONLY:CPG_SL1F_TYPE
USE CPG_SL2_TYPE_MOD,ONLY:CPG_SL2_TYPE
USE CPG_SL_MASK_TYPE_MOD,ONLY:CPG_SL_MASK_TYPE
USE FIELD_ARRAY_MODULE,ONLY:FIELD_2IM_ARRAY
USE GEOMETRY_MOD,ONLY:GEOMETRY
USE FIELD_VARIABLES_MOD,ONLY:GEOMETRY_VARIABLES
USE PARKIND1,ONLY:JPIM, JPRB
USE MODEL_DYNAMICS_MOD,ONLY:MODEL_DYNAMICS_TYPE
USE EINT_MOD,ONLY:SL_STRUCT
USE YOMCST,ONLY:TCST
USE YOMRIP,ONLY:TRIP
USE YOMHOOK,ONLY:LHOOK, JPHOOK, DR_HOOK

IMPLICIT NONE

LOGICAL, INTENT (INOUT)::LDO
LOGICAL, INTENT (INOUT)::LDSLHD
LOGICAL, INTENT (INOUT)::LDSLHDQUAD
LOGICAL, INTENT (INOUT)::LSMOOTH
TYPE (FIELD_2IM_ARRAY), INTENT (INOUT)::YDA_KVSEPC
TYPE (FIELD_2IM_ARRAY), INTENT (INOUT)::YDA_KVSEPL
TYPE (CPG_BNDS_TYPE), INTENT (IN)::YDCPG_BNDS
TYPE (CPG_SL1F_TYPE), INTENT (IN)::YDCPG_SL1
TYPE (CPG_SL2_TYPE), INTENT (IN)::YDCPG_SL2
TYPE (TCST), INTENT (IN)::YDCST
TYPE (GEOMETRY), INTENT (IN)::YDGEOMETRY
TYPE (GEOMETRY_VARIABLES), INTENT (IN)::YDGEOMVARS
TYPE (CPG_SL_MASK_TYPE), INTENT (INOUT)::YDMASK_SL2
TYPE (MODEL_DYNAMICS_TYPE), INTENT (IN)::YDML_DYN
TYPE (TRIP), INTENT (IN)::YDRIP
TYPE (SL_STRUCT), INTENT (IN)::YDSL
INTEGER (KIND=JPIM), INTENT (INOUT)::KL0 (YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY%YRDIMV%NFLEVG, 0:3)
INTEGER (KIND=JPIM), INTENT (INOUT)::KLEV (YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY%YRDIMV%NFLEVG)
INTEGER (KIND=JPIM), INTENT (INOUT)::KLH0 (YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY%YRDIMV%NFLEVG, 0:3)
REAL (KIND=JPRB), INTENT (INOUT)::PCCO (YDGEOMETRY%YRDIM%NPROMA&
&, YDGEOMETRY%YRDIMV%NFLEVG, YDML_DYN%YYTCCO%NDIM)
REAL (KIND=JPRB), INTENT (INOUT)::PLEV (YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB), INTENT (INOUT)::PLSCAW (YDGEOMETRY%YRDIM%NPROMA&
&, YDGEOMETRY%YRDIMV%NFLEVG, YDML_DYN%YYTLSCAW%NDIM)
REAL (KIND=JPRB), INTENT (INOUT)::PRSCAW (YDGEOMETRY%YRDIM%NPROMA&
&, YDGEOMETRY%YRDIMV%NFLEVG, YDML_DYN%YYTRSCAW%NDIM)
REAL (KIND=JPRB), INTENT (INOUT)::PSCO (YDGEOMETRY%YRDIM%NPROMA&
&, YDGEOMETRY%YRDIMV%NFLEVG, YDML_DYN%YYTSCO%NDIM)
REAL (KIND=JPRB), INTENT (INOUT)::PUF (YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB), INTENT (INOUT)::PVF (YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB), INTENT (OUT)::PWF (YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY%YRDIMV%NFLEVG)
#include "abor1.intfb.h"
#include "cart2local.intfb.h"
#include "laismoa.intfb.h"
#include "lamaxwind.intfb.h"
#include "larcina.intfb.h"
#include "latrajout.intfb.h"
#include "local2cart.intfb.h"
#include "mcoords.intfb.h"
#include "rotuv.intfb.h"
#include "rotuvgeo.intfb.h"
LOGICAL::LLINTV
INTEGER (KIND=JPIM)::IHVI
INTEGER (KIND=JPIM)::IROT
INTEGER (KIND=JPIM)::ITIP
INTEGER (KIND=JPIM)::JITER
INTEGER (KIND=JPIM)::JLEV
INTEGER (KIND=JPIM)::JROF
REAL (KIND=JPRB)::Z2COPHI
REAL (KIND=JPRB)::ZEF
REAL (KIND=JPRB)::ZEO
REAL (KIND=JPRB), PARAMETER::ZEPS=1.E-6_JPRB
REAL (KIND=JPRB)::ZFN
REAL (KIND=JPRB)::ZFX
REAL (KIND=JPRB)::ZHVETAON
REAL (KIND=JPRB)::ZHVETAOX
REAL (KIND=JPRB)::ZLEVB
REAL (KIND=JPRB)::ZLEVO
REAL (KIND=JPRB)::ZLEVT
REAL (KIND=JPRB)::ZPU
REAL (KIND=JPRB)::ZPV
REAL (KIND=JPRB)::ZUN_KAPPA (1)
REAL (KIND=JPRB)::ZUN_KAPPAH (1)
REAL (KIND=JPRB)::ZUN_KAPPAM (1)
REAL (KIND=JPRB)::ZUN_KAPPAT (1)
REAL (KIND=JPRB)::ZVDISP
REAL (KIND=JPRB)::ZVDISP_1
REAL (KIND=JPRB)::ZVDISP_2
REAL (KIND=JPRB)::ZVETAON
REAL (KIND=JPRB)::ZVETAOX
REAL (KIND=JPRB)::ZZ
INTEGER (KIND=JPIM)::IDEP (YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY%YRDIMV%NFLEVG)
INTEGER (KIND=JPIM)::IL0A (YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY%YRDIMV%NFLEVG, 0:3)
INTEGER (KIND=JPIM)::INOWENO (YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY%YRDIMV%NFLEVG)
INTEGER (KIND=JPIM)::ISTESB (YDGEOMETRY%YRDIM%NPROMA)
INTEGER (KIND=JPIM)::ISTEST (YDGEOMETRY%YRDIM%NPROMA)
REAL (KIND=JPRB)::ZPLEV (YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB)::ZSCO (YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY%YRDIMV%NFLEVG, YDML_DYN%YYTSCO%NDIM)
REAL (KIND=JPRB)::ZWF (YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB)::ZWFASM (YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB)::ZWFSM (YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB)::ZWF_2 (YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB)::ZWO_2 (YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB)::ZX0 (YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB)::ZXF (YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB)::ZY0 (YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB)::ZYF (YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB)::ZZ0 (YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB)::ZZF (YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPHOOK)::ZHOOK_HANDLE
IF (LHOOK) CALL DR_HOOK ('LARMES_LARMES', 0, ZHOOK_HANDLE)
CALL LAMAXWIND (YDML_DYN, YDCST, YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY%YRDIMV%NFLEVG, YDCPG_BNDS%KIDIA&
&, YDCPG_BNDS%KFDIA, YDCPG_SL2%URL, YDCPG_SL2%VRL, YDGEOMVARS%RCOLON%P, YDGEOMVARS%GEMU%P)

IF (YDML_DYN%YRDYN%LSVTSM) THEN

  DO JLEV=1, YDGEOMETRY%YRDIMV%NFLEVG

    DO JROF=YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA
      ZSCO (JROF, JLEV, YDML_DYN%YYTSCO%M_SINLA)=YDGEOMVARS%GEMU%P (JROF)-ZEPS
      ZSCO (JROF, JLEV, YDML_DYN%YYTSCO%M_COSCO)=YDGEOMVARS%GSQM2%P (JROF)
      ZSCO (JROF, JLEV, YDML_DYN%YYTSCO%M_SINCO)=ZEPS
      ZSCO (JROF, JLEV, YDML_DYN%YYTSCO%M_COPHI)=1.0_JPRB-ZEPS
      ZPLEV (JROF, JLEV)=YDGEOMETRY%YRVERT_GEOM%YRVETA%VETAF (JLEV)
    ENDDO

  ENDDO

  IHVI=0
  IROT=0
  ITIP=1
  LLINTV=.FALSE.
  CALL LARCINA (YDGEOMETRY, YDCST, YDML_DYN, YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA, YDSL, IHVI, YDML_DYN%YRDYN&
  &%LFINDVSEP, LDSLHD, LDSLHDQUAD, LLINTV, ITIP, IROT,.FALSE., ZSCO, ZPLEV, ZUN_KAPPA, ZUN_KAPPAT, ZUN_KAPPAM&
  &, ZUN_KAPPAH, YDCPG_SL2%STDDISU, YDCPG_SL2%STDDISV, YDCPG_SL2%STDDISW, YDCPG_SL1%UR0%P, YDCPG_SL1%VR0&
  &%P, YDCPG_SL1%ZR0%P, YDCPG_SL1%WRA%P, YDMASK_SL2%P, YDA_KVSEPC%P, YDA_KVSEPL%P, PCCO, PUF, PVF, ZZF,&
  & ZWF, ZWFASM, IL0A, KLH0, KLEV, PLSCAW, PRSCAW, IDEP, INOWENO, YDGEOMVARS%RCOLON%P, YDGEOMVARS%RSILON&
  &%P, YDGEOMVARS%GECLO%P, YDGEOMVARS%GEMU%P, YDGEOMVARS%GESLO%P, YDGEOMVARS%GSQM2%P)
  CALL LAISMOA (YDSL%NASLB1, YDGEOMETRY%YRDIM%NPROMA, YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA, YDGEOMETRY&
  &%YRDIMV%NFLEVG, YDGEOMETRY%YRDIMV%NFLSA, YDGEOMETRY%YRDIMV%NFLEN, PLSCAW (:,:, YDML_DYN%YYTLSCAW&
  &%M_WDLO), IL0A, PLSCAW (:,:, YDML_DYN%YYTLSCAW%M_WDVER), YDCPG_SL1%WRA%P, ZWFASM)
ENDIF

ZLEVT=YDGEOMETRY%YRVERT_GEOM%YRVETA%VETAF (0)
ZLEVB=YDGEOMETRY%YRVERT_GEOM%YRVETA%VETAF (YDGEOMETRY%YRDIMV%NFLEVG+1)
ZVETAON=(1.0_JPRB-YDML_DYN%YRDYN%VETAON)*YDGEOMETRY%YRVERT_GEOM%YRVETA%VETAH&
& (0)+YDML_DYN%YRDYN%VETAON*YDGEOMETRY%YRVERT_GEOM%YRVETA%VETAF (1)
ZVETAOX=(1.0_JPRB-YDML_DYN%YRDYN%VETAOX)*YDGEOMETRY%YRVERT_GEOM%YRVETA%VETAH (YDGEOMETRY%YRDIMV%NFLEVG&
&)+YDML_DYN%YRDYN%VETAOX*YDGEOMETRY%YRVERT_GEOM%YRVETA%VETAF (YDGEOMETRY%YRDIMV%NFLEVG)

IF (YDML_DYN%YRDYNA%LRALTVDISP) THEN
  ZHVETAON=0.5_JPRB*ZVETAON
  ZHVETAOX=1.0_JPRB-0.5_JPRB*(1.0_JPRB-ZVETAOX)
ENDIF


DO JITER=1, YDML_DYN%YRDYN%NITMP
  ISTEST (:)=0
  ISTESB (:)=0

  IF (JITER==1) THEN

    IF (YDML_DYN%YRDYN%LSLDP_CURV.AND..NOT.YDML_DYN%YRDYNA%LELTRA) THEN
      CALL LOCAL2CART (YDGEOMETRY%YRDIMV%NFLEVG, YDGEOMETRY%YRDIM%NPROMA, YDCPG_BNDS%KIDIA, YDCPG_BNDS&
      &%KFDIA, YDGEOMVARS%GEMU%P, YDGEOMVARS%GSQM2%P, YDGEOMVARS%GECLO%P, YDGEOMVARS%GESLO%P, YDGEOMVARS&
      &%GNORDM%P, YDGEOMVARS%GNORDL%P, YDCPG_SL2%URL, YDCPG_SL2%VRL, ZX0, ZY0, ZZ0, LDROT=.TRUE.)
    ENDIF

    CALL MCOORDS (YDML_DYN%YYTSCO, YDRIP, YDGEOMETRY%YRDIMV%NFLEVG, YDGEOMETRY%YRDIM%NPROMA, YDCPG_BNDS&
    &%KIDIA, YDCPG_BNDS%KFDIA, YDCST%RA, YDGEOMVARS%GEMU%P, YDGEOMVARS%GSQM2%P, YDGEOMVARS%GNORDM%P, YDGEOMVARS&
    &%GNORDL%P, YDCPG_SL2%URL, YDCPG_SL2%VRL, PSCO, LDO, LD2TLM=.TRUE., LDROT=.TRUE.)

    DO JLEV=1, YDGEOMETRY%YRDIMV%NFLEVG

      IF (YDML_DYN%YRDYNA%LRALTVDISP) THEN
        ZFN=YDGEOMETRY%YRVERT_GEOM%YRVETA%VETAF (JLEV)-ZHVETAON
        ZFX=ZHVETAOX-YDGEOMETRY%YRVERT_GEOM%YRVETA%VETAF (JLEV)
        ZEF=1._JPRB/ZFN+1._JPRB/ZFX
      ENDIF


      DO JROF=YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA

        IF (YDGEOMETRY%YRSTA%STPREH (JLEV)>YDML_DYN%YRDYN%RPRES_SVTSM.OR..NOT.LSMOOTH) THEN
          ZWF (JROF, JLEV)=YDCPG_SL2%WRL (JROF, JLEV)
        ELSE
          ZWF (JROF, JLEV)=ZWFASM (JROF, JLEV)
        ENDIF


        IF (YDML_DYN%YRDYNA%LRALTVDISP) THEN
          ZVDISP_1=-YDRIP%RTDT*ZWF (JROF, JLEV)
          ZZ=EXP (ZVDISP_1*ZEF)*ZFN/ZFX
          ZVDISP_2=(ZHVETAON+ZHVETAOX*ZZ)/(1.0_JPRB+ZZ)-YDGEOMETRY%YRVERT_GEOM%YRVETA%VETAF (JLEV)
          ZVDISP=SIGN (1.0_JPRB, ZVDISP_1)*MIN (ABS (ZVDISP_1), ABS (ZVDISP_2))
          ZLEVO=YDGEOMETRY%YRVERT_GEOM%YRVETA%VETAF (JLEV)+ZVDISP
        ELSE
          ZLEVO=YDGEOMETRY%YRVERT_GEOM%YRVETA%VETAF (JLEV)-YDRIP%RTDT*ZWF (JROF, JLEV)
        ENDIF

        ISTEST (JROF)=ISTEST (JROF)-MIN (0, MAX (-1, NINT (ZLEVO-ZLEVT-0.5_JPRB)))
        ISTESB (JROF)=ISTESB (JROF)-MIN (0, MAX (-1, NINT (ZLEVB-ZLEVO-0.5_JPRB)))
        ZLEVO=MIN (ZVETAOX, MAX (ZVETAON, ZLEVO))

        IF (LDO.OR.YDML_DYN%YRDYNA%LELTRA) THEN
          PLEV (JROF, JLEV)=ZLEVO
        ELSE
          PLEV (JROF, JLEV)=0.5_JPRB*(ZLEVO+YDGEOMETRY%YRVERT_GEOM%YRVETA%VETAF (JLEV))
        ENDIF

      ENDDO

    ENDDO

  ELSE

    IF (YDML_DYN%YRDYN%LSLDP_CURV) THEN

      IF (LDO) THEN

        DO JLEV=1, YDGEOMETRY%YRDIMV%NFLEVG

          DO JROF=YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA
            ZXF (JROF, JLEV)=0.5_JPRB*(PUF (JROF, JLEV)+ZX0 (JROF, JLEV))
            ZYF (JROF, JLEV)=0.5_JPRB*(PVF (JROF, JLEV)+ZY0 (JROF, JLEV))
            ZZF (JROF, JLEV)=0.5_JPRB*(ZZF (JROF, JLEV)+ZZ0 (JROF, JLEV))
          ENDDO

        ENDDO

      ENDIF

      CALL CART2LOCAL (YDGEOMETRY%YRDIMV%NFLEVG, YDGEOMETRY%YRDIM%NPROMA, YDCPG_BNDS&
      &%KIDIA, YDCPG_BNDS%KFDIA, YDGEOMVARS%GEMU%P, YDGEOMVARS%GSQM2%P, YDGEOMVARS&
      &%GECLO%P, YDGEOMVARS%GESLO%P, ZXF, ZYF, ZZF, PUF, PVF)
    ELSE
      CALL ROTUV (YDGEOMETRY%YRDIMV%NFLEVG, YDGEOMETRY%YRDIM%NPROMA, YDCPG_BNDS&
      &%KIDIA, YDCPG_BNDS%KFDIA, PUF, PVF, PCCO (:,:, YDML_DYN%YYTCCO%M_RQX&
      &), PCCO (:,:, YDML_DYN%YYTCCO%M_RQY), PUF, PVF, LDIR=.FALSE.)

      IF (LDO) THEN

        DO JLEV=1, YDGEOMETRY%YRDIMV%NFLEVG

          DO JROF=YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA
            ZPU=PUF (JROF, JLEV)
            ZPV=PVF (JROF, JLEV)
            PUF (JROF, JLEV)=0.5_JPRB*(ZPU+YDCPG_SL2%URL (JROF, JLEV)*YDGEOMVARS%GNORDM&
            &%P (JROF)-YDCPG_SL2%VRL (JROF, JLEV)*YDGEOMVARS%GNORDL%P (JROF))
            PVF (JROF, JLEV)=0.5_JPRB*(ZPV+YDCPG_SL2%URL (JROF, JLEV)*YDGEOMVARS%GNORDL&
            &%P (JROF)+YDCPG_SL2%VRL (JROF, JLEV)*YDGEOMVARS%GNORDM%P (JROF))
          ENDDO

        ENDDO

      ENDIF

    ENDIF

    CALL MCOORDS (YDML_DYN%YYTSCO, YDRIP, YDGEOMETRY%YRDIMV%NFLEVG, YDGEOMETRY%YRDIM%NPROMA&
    &, YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA, YDCST%RA, YDGEOMVARS%GEMU%P, YDGEOMVARS%GSQM2%P&
    &, YDGEOMVARS%GNORDM%P, YDGEOMVARS%GNORDL%P, PUF, PVF, PSCO, LDO, LD2TLM=.TRUE.)

    DO JLEV=1, YDGEOMETRY%YRDIMV%NFLEVG

      IF (YDML_DYN%YRDYNA%LRALTVDISP) THEN
        ZFN=YDGEOMETRY%YRVERT_GEOM%YRVETA%VETAF (JLEV)-ZHVETAON
        ZFX=ZHVETAOX-YDGEOMETRY%YRVERT_GEOM%YRVETA%VETAF (JLEV)
        ZEF=1._JPRB/ZFN+1._JPRB/ZFX
      ENDIF


      IF (LDO) THEN

        DO JROF=YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA

          IF (YDGEOMETRY%YRSTA%STPREH (JLEV)>YDML_DYN%YRDYN%RPRES_SVTSM.OR..NOT.LSMOOTH) THEN

            IF (YDML_DYN%YRDYNA%LRALTVDISP) THEN
              ZWF_2 (JROF, JLEV)=ZWF (JROF, JLEV)
              ZWO_2 (JROF, JLEV)=YDCPG_SL2%WRL (JROF, JLEV)
            ENDIF

            ZWF (JROF, JLEV)=0.5_JPRB*(ZWF (JROF, JLEV)+YDCPG_SL2%WRL (JROF, JLEV))
          ELSE

            IF (YDML_DYN%YRDYNA%LRALTVDISP) THEN
              ZWF_2 (JROF, JLEV)=ZWFASM (JROF, JLEV)
              ZWO_2 (JROF, JLEV)=ZWFSM (JROF, JLEV)
            ENDIF

            ZWF (JROF, JLEV)=0.5_JPRB*(ZWFSM (JROF, JLEV)+ZWFASM (JROF, JLEV))
          ENDIF

        ENDDO

      ENDIF


      IF (YDML_DYN%YRDYNA%LSLDIA.AND.(JITER==YDML_DYN%YRDYN%NITMP)) THEN
        PWF (YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA, JLEV)=ZWF (YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA, JLEV)
      ENDIF


      DO JROF=YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA

        IF (YDML_DYN%YRDYNA%LRALTVDISP) THEN
          ZVDISP_1=-YDRIP%RTDT*ZWF (JROF, JLEV)
          ZEO=1._JPRB/(PLEV (JROF, JLEV)-ZHVETAON)+1._JPRB/(ZHVETAOX-PLEV (JROF, JLEV))

          IF (LDO) THEN
            ZZ=EXP (-0.5_JPRB*YDRIP%RTDT*ZWF_2 (JROF, JLEV)*ZEF-0&
            &.5_JPRB*YDRIP%RTDT*ZWO_2 (JROF, JLEV)*ZEO)*ZFN/ZFX
          ELSE
            ZZ=EXP (-YDRIP%RTDT*ZWF (JROF, JLEV)*ZEO)*ZFN/ZFX
          ENDIF

          ZVDISP_2=(ZHVETAON+ZHVETAOX*ZZ)/(1.0_JPRB+ZZ)-YDGEOMETRY%YRVERT_GEOM%YRVETA%VETAF (JLEV)
          ZVDISP=SIGN (1.0_JPRB, ZVDISP_1)*MIN (ABS (ZVDISP_1), ABS (ZVDISP_2))
          ZLEVO=YDGEOMETRY%YRVERT_GEOM%YRVETA%VETAF (JLEV)+ZVDISP
        ELSE
          ZLEVO=YDGEOMETRY%YRVERT_GEOM%YRVETA%VETAF (JLEV)-YDRIP%RTDT*ZWF (JROF, JLEV)
        ENDIF

        ISTEST (JROF)=ISTEST (JROF)-MIN (0, MAX (-1, NINT (ZLEVO-ZLEVT-0.5_JPRB)))
        ISTESB (JROF)=ISTESB (JROF)-MIN (0, MAX (-1, NINT (ZLEVB-ZLEVO-0.5_JPRB)))
        ZLEVO=MIN (ZVETAOX, MAX (ZVETAON, ZLEVO))

        IF (LDO.OR.YDML_DYN%YRDYNA%LELTRA) THEN
          PLEV (JROF, JLEV)=ZLEVO
        ELSE
          PLEV (JROF, JLEV)=0.5_JPRB*(ZLEVO+YDGEOMETRY%YRVERT_GEOM%YRVETA%VETAF (JLEV))
        ENDIF

      ENDDO

    ENDDO


    IF (JITER==YDML_DYN%YRDYN%NITMP) THEN
      CALL ROTUVGEO (YDGEOMETRY%YRDIMV%NFLEVG, YDGEOMETRY%YRDIM%NPROMA, YDCPG_BNDS%KIDIA, YDCPG_BNDS&
      &%KFDIA, YDGEOMVARS%GNORDM%P, YDGEOMVARS%GNORDL%P, PUF, PVF, PUF, PVF, LDIR=.FALSE.)
    ENDIF

  ENDIF


  IF (JITER==YDML_DYN%YRDYN%NITMP) THEN
    CALL LATRAJOUT (YDCST, YDML_DYN%YRDYNA%LRPRSLTRJ, YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY%YRDIMV%NFLEVG,&
    & YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA, ISTEST, ISTESB, ZWF, YDGEOMVARS%RCOLON%P, YDGEOMVARS%GEMU%P)
  ENDIF


  IF (JITER/=YDML_DYN%YRDYN%NITMP) THEN
    IHVI=0

    IF (YDML_DYN%YRDYN%LSLDP_CURV) THEN
      IROT=0
    ELSE
      IROT=1
    ENDIF

    ITIP=1
    LLINTV=.TRUE.
    CALL LARCINA (YDGEOMETRY, YDCST, YDML_DYN, YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA, YDSL, IHVI, YDML_DYN%YRDYN&
    &%LFINDVSEP, LDSLHD, LDSLHDQUAD, LLINTV, ITIP, IROT,.FALSE., PSCO, PLEV, ZUN_KAPPA, ZUN_KAPPAT, ZUN_KAPPAM&
    &, ZUN_KAPPAH, YDCPG_SL2%STDDISU, YDCPG_SL2%STDDISV, YDCPG_SL2%STDDISW, YDCPG_SL1%UR0%P, YDCPG_SL1%VR0&
    &%P, YDCPG_SL1%ZR0%P, YDCPG_SL1%WR0%P, YDMASK_SL2%P, YDA_KVSEPC%P, YDA_KVSEPL%P, PCCO, PUF, PVF, ZZF&
    &, ZWF, ZWFSM, KL0, KLH0, KLEV, PLSCAW, PRSCAW, IDEP, INOWENO, YDGEOMVARS%RCOLON%P, YDGEOMVARS%RSILON&
    &%P, YDGEOMVARS%GECLO%P, YDGEOMVARS%GEMU%P, YDGEOMVARS%GESLO%P, YDGEOMVARS%GSQM2%P)
  ENDIF

ENDDO


IF (.NOT.(LDO.OR.YDML_DYN%YRDYNA%LELTRA)) THEN

  IF (YDML_DYN%YRDYNA%LTWOTL) THEN
    CALL ABOR1 (' LARMES 3 ')
  ENDIF

  ZVETAON=(1.0_JPRB-YDML_DYN%YRDYN%VETAON)*YDGEOMETRY%YRVERT_GEOM%YRVETA%VETAH&
  & (0)+YDML_DYN%YRDYN%VETAON*YDGEOMETRY%YRVERT_GEOM%YRVETA%VETAF (1)
  ZVETAOX=(1.0_JPRB-YDML_DYN%YRDYN%VETAOX)*YDGEOMETRY%YRVERT_GEOM%YRVETA%VETAH (YDGEOMETRY%YRDIMV%NFLEVG&
  &)+YDML_DYN%YRDYN%VETAOX*YDGEOMETRY%YRVERT_GEOM%YRVETA%VETAF (YDGEOMETRY%YRDIMV%NFLEVG)

  DO JLEV=1, YDGEOMETRY%YRDIMV%NFLEVG

    DO JROF=YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA
      Z2COPHI=2.0_JPRB*PSCO (JROF, JLEV, YDML_DYN%YYTSCO%M_COPHI)
      PSCO (JROF, JLEV, YDML_DYN%YYTSCO%M_SINLA)=Z2COPHI*PSCO (JROF&
      &, JLEV, YDML_DYN%YYTSCO%M_SINLA)-YDGEOMVARS%GEMU%P (JROF)
      PSCO (JROF, JLEV, YDML_DYN%YYTSCO%M_SINCO)=Z2COPHI*PSCO (JROF, JLEV, YDML_DYN%YYTSCO%M_SINCO)
      PSCO (JROF, JLEV, YDML_DYN%YYTSCO%M_COSCO)=Z2COPHI*PSCO (JROF&
      &, JLEV, YDML_DYN%YYTSCO%M_COSCO)-YDGEOMVARS%GSQM2%P (JROF)
      PLEV (JROF, JLEV)=2.0_JPRB*PLEV (JROF, JLEV)-YDGEOMETRY%YRVERT_GEOM%YRVETA%VETAF (JLEV)
      PLEV (JROF, JLEV)=MAX (ZVETAON, MIN (ZVETAOX, PLEV (JROF, JLEV)))
      PSCO (JROF, JLEV, YDML_DYN%YYTSCO%M_COPHI)=Z2COPHI*PSCO&
      & (JROF, JLEV, YDML_DYN%YYTSCO%M_COPHI)-1.0_JPRB
    ENDDO

  ENDDO

ENDIF

IF (LHOOK) CALL DR_HOOK ('LARMES_LARMES', 1, ZHOOK_HANDLE)
ENDSUBROUTINE
