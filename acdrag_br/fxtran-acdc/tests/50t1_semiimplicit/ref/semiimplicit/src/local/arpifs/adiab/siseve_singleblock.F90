SUBROUTINE SISEVE_SINGLEBLOCK (YDCST, YDGEOMETRY, YDDYN, YDDYNA, KLON&
&, KLEV, KIDIA, KFDIA, PV1, PV2, LD_LSTAR, LD_SKAPI, LDACC)
USE GEOMETRY_MOD,ONLY:GEOMETRY
USE PARKIND1,ONLY:JPIM, JPRB
USE YOMHOOK,ONLY:LHOOK, DR_HOOK, JPHOOK
USE YOMCST,ONLY:TCST
USE YOMDYN,ONLY:TDYN
USE YOMDYNA,ONLY:TDYNA
USE FXTRAN_ACDC_STACK_MOD
#include "fxtran_acdc_stack.h"

IMPLICIT NONE


TYPE (TCST), INTENT (IN)::YDCST
TYPE (GEOMETRY), INTENT (IN)::YDGEOMETRY
TYPE (TDYN), INTENT (IN)::YDDYN
TYPE (TDYNA), INTENT (IN)::YDDYNA
INTEGER (KIND=JPIM), INTENT (IN)::KLEV
INTEGER (KIND=JPIM), INTENT (IN)::KLON
INTEGER (KIND=JPIM), INTENT (IN)::KIDIA
INTEGER (KIND=JPIM), INTENT (IN)::KFDIA
REAL (KIND=JPRB), INTENT (IN)::PV1 (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PV2 (KLON, KLEV)
LOGICAL, OPTIONAL, INTENT (IN)::LD_LSTAR
LOGICAL, OPTIONAL, INTENT (IN)::LD_SKAPI
LOGICAL, INTENT (IN) :: LDACC
LOGICAL::LL_SKAPI
LOGICAL::LL_LSTAR
INTEGER (KIND=JPIM)::JLON
INTEGER (KIND=JPIM)::JLEV
REAL (KIND=JPRB)::ZV2 (KLON, KLEV)
REAL (KIND=JPRB)::ZIN (KLON, KLEV)
REAL (KIND=JPRB)::ZIN1 (KLON, 0:KLEV+1)
REAL (KIND=JPRB)::ZVDERW_FE (KLON, 0:KLEV)
REAL (KIND=JPRB)::ZVDERW_FD (KLON, 0:KLEV)
REAL (KIND=JPRB)::ZVDERU (KLON, KLEV)
REAL (KIND=JPRB)::ZVDERV (KLON, KLEV)
REAL (KIND=JPRB)::ZDELPH (KLON, KLEV)
REAL (KIND=JPRB)::ZRDELPF (KLON, 0:KLEV)
REAL (KIND=JPRB)::ZINDETA (KLON, KLEV)
REAL (KIND=JPRB)::ZINDETA2 (KLON, KLEV)
REAL (KIND=JPRB)::ZP2MDETA (KLON, KLEV)
REAL (KIND=JPRB)::ZVLAPL (KLON, KLEV)
REAL (KIND=JPRB)::ZKAP_B
REAL (KIND=JPHOOK)::ZHOOK_HANDLE
#include "verdisint.intfb.h"
#include "verderfe.intfb.h"
#include "siskapi.intfb.h"
TYPE (FXTRAN_ACDC_STACK) :: YLSTACK

!$ACC DATA &
!$ACC&CREATE (ZDELPH, ZIN, ZIN1, ZINDETA, ZINDETA2, ZP2MDETA, ZRDELPF, ZV2, ZVDERU, &
!$ACC&        ZVDERV, ZVDERW_FD, ZVDERW_FE, ZVLAPL) &
!$ACC&IF (LDACC) &
!$ACC&PRESENT (PV1, PV2, YDCST, YDDYN, YDDYNA, YDGEOMETRY) 

IF (LHOOK) CALL DR_HOOK ('SISEVE_SINGLEBLOCK', 0, ZHOOK_HANDLE)


ZKAP_B=1.0_JPRB

IF (YDDYNA%LNHQE.AND.YDDYN%LNHQE_SOLVER_SP)  THEN
  ZKAP_B=YDCST%RKAPPA
ENDIF


IF (YDGEOMETRY%YRVERT_GEOM%YRCVER%LVERTFE) THEN

  IF (YDGEOMETRY%YRVERT_GEOM%YRCVER%LCOMPATIBLE) THEN
    
    !$ACC PARALLEL LOOP GANG VECTOR &
    !$ACC&IF (LDACC) &
    !$ACC&PRIVATE (JLEV, JLON) 

    

    DO JLON = KIDIA, KFDIA

      DO JLEV=1, KLEV
        
        ZIN (JLON, JLEV)=PV1 (JLON, JLEV)
        ZIN1 (JLON, JLEV)=PV1 (JLON, JLEV)*YDDYN%SITLAF_NH(JLEV)
      
      ENDDO

      
      ZIN1 (JLON, 0)=0.0_JPRB
      ZIN1 (JLON, KLEV+1)=ZIN1 (JLON, KLEV)*(YDDYN%SITLAH_NH(KLEV)/YDDYN%SITLAF_NH(KLEV))

      

      DO JLEV=1, KLEV-1
        
        ZRDELPF (JLON, JLEV)=1.0_JPRB/(YDDYN%SITLAF_NH(JLEV+1)-YDDYN%SITLAF_NH(JLEV))
        ZVDERW_FD (JLON, JLEV)=ZKAP_B*(ZIN1 (JLON, JLEV+1)-ZIN1 (JLON, JLEV))*ZRDELPF (JLON, JLEV)+(1.0_JPRB&
        &-ZKAP_B)*YDDYN%SITLAH_NH(JLEV)*(ZIN (JLON, JLEV+1)-ZIN (JLON, JLEV))*ZRDELPF (JLON, JLEV)
      
      ENDDO

      
      ZRDELPF (JLON, 0)=1.0_JPRB/(YDDYN%SITLAF_NH(1)-YDDYN%SITLAH_NH(0))
      ZVDERW_FD (JLON, 0)=ZKAP_B*(ZIN1 (JLON, 1)-ZIN1 (JLON, 0))*ZRDELPF (JLON, 0)
      ZRDELPF (JLON, KLEV)=1.0_JPRB/(YDDYN%SITLAH_NH(KLEV)-YDDYN%SITLAF_NH(KLEV))
      ZVDERW_FD (JLON, KLEV)=ZKAP_B*(ZIN1 (JLON, KLEV+1)-ZIN1 (JLON, KLEV))*ZRDELPF (JLON, KLEV)
    
    ENDDO


    

    

    

    IF (YDGEOMETRY%YRVERT_GEOM%YRCVER%LVFE_FD_MIX) THEN
      
      !$ACC PARALLEL LOOP GANG VECTOR &
      !$ACC&IF (LDACC) &
      !$ACC&PRIVATE (JLEV, JLON) 

      

      DO JLON = KIDIA, KFDIA

        DO JLEV=0, KLEV
          
          ZVDERW_FE (JLON, JLEV)=ZVDERW_FD (JLON, JLEV)
        
        ENDDO

      ENDDO

    ELSE
      
      !$ACC PARALLEL LOOP GANG VECTOR &
      !$ACC&IF (LDACC) &
      !$ACC&PRIVATE (JLEV, JLON) 

      

      DO JLON = KIDIA, KFDIA

        DO JLEV=1, KLEV
          
          ZDELPH (JLON, JLEV)=YDDYN%SIDELP_NH(JLEV)
        
        ENDDO

      ENDDO

      CALL VERDERFE_SINGLEBLOCK (KLON, KIDIA, KFDIA, KLEV, YDGEOMETRY%YRVERT_GEOM&
      &%YRVETA%VDETA_RATIO, ZDELPH, ZRDELPF, ZVDERW_FD, ZVDERW_FE, LDACC=LDACC)
    ENDIF


    IF (YDDYN%NOPT_SISLP/=0) THEN
      
      !$ACC PARALLEL LOOP GANG VECTOR &
      !$ACC&IF (LDACC) &
      !$ACC&PRIVATE (JLEV, JLON) 

      

      DO JLON = KIDIA, KFDIA

        DO JLEV=1, KLEV
          
          ZVDERU (JLON, JLEV)=(YDDYN%SIGFL(JLEV)*(YDDYN%SIWH2F(JLEV, 2)*ZVDERW_FD&
          & (JLON, JLEV)+YDDYN%SIWH2F(JLEV, 1)*ZVDERW_FD (JLON, JLEV-1))-YDCST%RD&
          &*YDDYN%SITRM(JLEV)*YDDYN%SITFL(JLEV)*ZIN (JLON, JLEV))/YDCST%RG
          ZVDERV (JLON, JLEV)=(YDDYN%SIGFM(JLEV)*(YDDYN%SIWH2F(JLEV, 2)*ZVDERW_FD&
          & (JLON, JLEV)+YDDYN%SIWH2F(JLEV, 1)*ZVDERW_FD (JLON, JLEV-1))-YDCST%RD&
          &*YDDYN%SITRM(JLEV)*YDDYN%SITFM(JLEV)*ZIN (JLON, JLEV))/YDCST%RG
        
        ENDDO


        DO JLEV=2, KLEV-1
          
          ZVLAPL (JLON, JLEV)=(YDDYN%SITRAM(JLEV)/YDDYN%SITR)*(YDCST%RD/YDCST%RG)*YDDYN%SITR*(YDDYN%SITFL&
          &(JLEV)*ZVDERU (JLON, JLEV)+YDDYN%SITFM(JLEV)*ZVDERV (JLON, JLEV))+(YDDYN%RGWFRIC(JLEV)*ZVDERW_FE&
          & (JLON, JLEV)-YDDYN%RGWFRIC(JLEV-1)*ZVDERW_FE (JLON, JLEV-1)+((YDDYN%SIGFL(JLEV+1)*ZVDERU (JLON&
          &, JLEV+1)+YDDYN%SIWF2H(JLEV)*(YDDYN%SIGFL(JLEV)*ZVDERU (JLON, JLEV)-YDDYN%SIGFL(JLEV+1)*ZVDERU&
          & (JLON, JLEV+1)))+(YDDYN%SIGFM(JLEV+1)*ZVDERV (JLON, JLEV+1)+YDDYN%SIWF2H(JLEV)*(YDDYN%SIGFM&
          &(JLEV)*ZVDERV (JLON, JLEV)-YDDYN%SIGFM(JLEV+1)*ZVDERV (JLON, JLEV+1)))-(YDDYN%SIGFL(JLEV)*ZVDERU&
          & (JLON, JLEV)+YDDYN%SIWF2H(JLEV-1)*(YDDYN%SIGFL(JLEV-1)*ZVDERU (JLON, JLEV-1)-YDDYN%SIGFL(JLEV&
          &)*ZVDERU (JLON, JLEV)))-(YDDYN%SIGFM(JLEV)*ZVDERV (JLON, JLEV)+YDDYN%SIWF2H(JLEV-1)*(YDDYN%SIGFM&
          &(JLEV-1)*ZVDERV (JLON, JLEV-1)-YDDYN%SIGFM(JLEV)*ZVDERV (JLON, JLEV))))/YDCST%RG)/(YDDYN%SILNPR_NH&
          &(JLEV)/YDGEOMETRY%YRVERT_GEOM%YRVETA%VDETA_RATIO (JLEV))
        
        ENDDO

        
        ZVLAPL (JLON, 1)=(YDDYN%SITRAM(1)/YDDYN%SITR)*(YDCST%RD/YDCST%RG)*YDDYN%SITR*(YDDYN%SITFL(1)*ZVDERU &
        &(JLON, 1)+YDDYN%SITFM(1)*ZVDERV (JLON, 1))+(YDDYN%RGWFRIC(1)*ZVDERW_FE (JLON, 1)-YDDYN%RGWFRIC(0)*ZVDERW_FE&
        & (JLON, 0)+((YDDYN%SIGFL(2)*ZVDERU (JLON, 2)+YDDYN%SIWF2H(1)*(YDDYN%SIGFL(1)*ZVDERU (JLON, 1)-YDDYN&
        &%SIGFL(2)*ZVDERU (JLON, 2)))+(YDDYN%SIGFM(2)*ZVDERV (JLON, 2)+YDDYN%SIWF2H(1)*(YDDYN%SIGFM(1)*ZVDERV&
        & (JLON, 1)-YDDYN%SIGFM(2)*ZVDERV (JLON, 2)))-YDDYN%SIGFL(1)*ZVDERU (JLON, 1)-YDDYN%SIGFM(1)*ZVDERV &
        &(JLON, 1))/YDCST%RG)/(YDDYN%SILNPR_NH(1)/YDGEOMETRY%YRVERT_GEOM%YRVETA%VDETA_RATIO (1))
        ZVLAPL (JLON, KLEV)=(YDDYN%SITRAM(KLEV)/YDDYN%SITR)*(YDCST%RD/YDCST%RG)*YDDYN%SITR*(YDDYN%SITFL(KLEV&
        &)*ZVDERU (JLON, KLEV)+YDDYN%SITFM(KLEV)*ZVDERV (JLON, KLEV))+(-YDDYN%RGWFRIC(KLEV-1)*ZVDERW_FE (JLON&
        &, KLEV-1)+(-(YDDYN%SIGFL(KLEV)*ZVDERU (JLON, KLEV)+YDDYN%SIWF2H(KLEV-1)*(YDDYN%SIGFL(KLEV-1)*ZVDERU&
        & (JLON, KLEV-1)-YDDYN%SIGFL(KLEV)*ZVDERU (JLON, KLEV)))-(YDDYN%SIGFM(KLEV)*ZVDERV (JLON, KLEV)+YDDYN&
        &%SIWF2H(KLEV-1)*(YDDYN%SIGFM(KLEV-1)*ZVDERV (JLON, KLEV-1)-YDDYN%SIGFM(KLEV)*ZVDERV (JLON, KLEV))&
        &))/YDCST%RG)/(YDDYN%SILNPR_NH(KLEV)/YDGEOMETRY%YRVERT_GEOM%YRVETA%VDETA_RATIO (KLEV))
      
      ENDDO

    
    
    ELSE
      
      !$ACC PARALLEL LOOP GANG VECTOR &
      !$ACC&IF (LDACC) &
      !$ACC&PRIVATE (JLEV, JLON) 

      

      DO JLON = KIDIA, KFDIA

        DO JLEV=1, KLEV-1
          
          ZVLAPL (JLON, JLEV)=(YDDYN%RGWFRIC(JLEV)*ZVDERW_FE (JLON, JLEV)-YDDYN%RGWFRIC(JLEV-1)*ZVDERW_FE&
          & (JLON, JLEV-1))/(YDDYN%SILNPR_NH(JLEV)/YDGEOMETRY%YRVERT_GEOM%YRVETA%VDETA_RATIO (JLEV))
        
        ENDDO

        
        ZVLAPL (JLON, KLEV)=(-YDDYN%RGWFRIC(KLEV-1)*ZVDERW_FE (JLON, KLEV-1))/(YDDYN&
        &%SILNPR_NH(KLEV)/YDGEOMETRY%YRVERT_GEOM%YRVETA%VDETA_RATIO (KLEV))
      
      ENDDO

    
    ENDIF

  ELSEIF (YDGEOMETRY%YRVERT_GEOM%YRCVER%LVFE_LAPL_HALF) THEN
    
    !$ACC PARALLEL LOOP GANG VECTOR &
    !$ACC&IF (LDACC) &
    !$ACC&PRIVATE (JLEV, JLON) 

    

    DO JLON = KIDIA, KFDIA

      DO JLEV=1, KLEV
        
        ZIN1 (JLON, JLEV)=YDDYN%SITLAF_NH(JLEV)*PV1 (JLON, JLEV)
      
      ENDDO

      
      ZIN1 (JLON, 0)=0.0_JPRB
      ZIN1 (JLON, KLEV+1)=0.0_JPRB
    
    ENDDO

    
    CALL VERDISINT_SINGLEBLOCK (YDGEOMETRY%YRVERT_GEOM%YRVFE, YDGEOMETRY%YRVERT_GEOM&
    &%YRCVER,'HDER','01', KLON, KIDIA, KFDIA, KLEV, ZIN1, ZVDERW_FE, LDACC=LDACC)
    
    !$ACC PARALLEL LOOP GANG VECTOR &
    !$ACC&IF (LDACC) &
    !$ACC&PRIVATE (JLEV, JLON) 

    

    DO JLON = KIDIA, KFDIA

      DO JLEV=1, KLEV
        
        ZIN1 (JLON, JLEV)=PV1 (JLON, JLEV)
      
      ENDDO

      
      ZIN1 (JLON, 0)=0.0_JPRB
      ZIN1 (JLON, KLEV+1)=0.0_JPRB
    
    ENDDO

    
    CALL VERDISINT_SINGLEBLOCK (YDGEOMETRY%YRVERT_GEOM%YRVFE, YDGEOMETRY%YRVERT_GEOM&
    &%YRCVER,'HDER','01', KLON, KIDIA, KFDIA, KLEV, ZIN1, ZVDERW_FD, LDACC=LDACC)
    
    !$ACC PARALLEL LOOP GANG VECTOR &
    !$ACC&IF (LDACC) &
    !$ACC&PRIVATE (JLEV, JLON) 

    

    DO JLON = KIDIA, KFDIA

      DO JLEV=1, KLEV-1
        
        ZVDERW_FE (JLON, JLEV)=(ZKAP_B*ZVDERW_FE (JLON, JLEV)+(1.0_JPRB-ZKAP_B)*YDDYN%SITLAH_NH(JLEV&
        &)*ZVDERW_FD (JLON, JLEV))*((YDGEOMETRY%YRVERT_GEOM%YRVETA%VFE_ETAF (JLEV+1)-YDGEOMETRY%YRVERT_GEOM&
        &%YRVETA%VFE_ETAF (JLEV))/(YDDYN%SITLAF_NH(JLEV+1)-YDDYN%SITLAF_NH(JLEV)))
      
      ENDDO

      
      ZVDERW_FE (JLON, 0)=ZKAP_B*ZVDERW_FE (JLON, 0)*((YDGEOMETRY%YRVERT_GEOM%YRVETA%VFE_ETAF (1&
      &)-YDGEOMETRY%YRVERT_GEOM%YRVETA%VFE_ETAH (0))/(YDDYN%SITLAF_NH(1)-YDDYN%SITLAH_NH(0)))
      ZVDERW_FE (JLON, KLEV)=(ZKAP_B*ZVDERW_FE (JLON, KLEV)+(1.0_JPRB-ZKAP_B)*YDDYN%SITLAH_NH(KLEV&
      &)*ZVDERW_FD (JLON, KLEV))*((YDGEOMETRY%YRVERT_GEOM%YRVETA%VFE_ETAH (KLEV)-YDGEOMETRY%YRVERT_GEOM&
      &%YRVETA%VFE_ETAF (KLEV))/(YDDYN%SITLAH_NH(KLEV)-YDDYN%SITLAF_NH(KLEV)))

      

      DO JLEV=1, KLEV-1
        
        ZVLAPL (JLON, JLEV)=(YDDYN%RGWFRIC(JLEV)*ZVDERW_FE (JLON, JLEV)-YDDYN&
        &%RGWFRIC(JLEV-1)*ZVDERW_FE (JLON, JLEV-1))/YDDYN%SILNPR_NH(JLEV)
      
      ENDDO

      
      ZVLAPL (JLON, KLEV)=(-YDDYN%RGWFRIC(KLEV-1)*ZVDERW_FE (JLON, KLEV-1))/YDDYN%SILNPR_NH(KLEV)
    
    ENDDO

  
  
  
  ELSE
    
    !$ACC PARALLEL LOOP GANG VECTOR &
    !$ACC&IF (LDACC) &
    !$ACC&PRIVATE (JLEV, JLON) 

    

    DO JLON = KIDIA, KFDIA

      DO JLEV=1, KLEV
        
        ZIN (JLON, JLEV)=PV1 (JLON, JLEV)
        ZIN1 (JLON, JLEV)=PV1 (JLON, JLEV)
      
      ENDDO

      
      ZIN1 (JLON, 0)=0.0_JPRB
      ZIN1 (JLON, KLEV+1)=0.0_JPRB
    
    ENDDO

    
    CALL VERDISINT_SINGLEBLOCK (YDGEOMETRY%YRVERT_GEOM%YRVFE, YDGEOMETRY%YRVERT_GEOM&
    &%YRCVER,'FDER','11', KLON, KIDIA, KFDIA, KLEV, ZIN1, ZINDETA, LDACC=LDACC)
    CALL VERDISINT_SINGLEBLOCK (YDGEOMETRY%YRVERT_GEOM%YRVFE, YDGEOMETRY%YRVERT_GEOM&
    &%YRCVER,'DDER','01', KLON, KIDIA, KFDIA, KLEV, ZIN1, ZINDETA2, LDACC=LDACC)
    
    !$ACC PARALLEL LOOP GANG VECTOR &
    !$ACC&IF (LDACC) &
    !$ACC&PRIVATE (JLEV, JLON) 

    

    DO JLON = KIDIA, KFDIA

      DO JLEV=1, KLEV
        
        ZIN1 (JLON, JLEV)=(YDDYN%SITLAF_NH(JLEV)**2)*(YDDYN%SIRDEL_NH&
        &(JLEV)/YDGEOMETRY%YRVERT_GEOM%YRVETA%VFE_RDETAH (JLEV))
      
      ENDDO

      
      ZIN1 (JLON, 0)=0.0_JPRB
      ZIN1 (JLON, KLEV+1)=2.0_JPRB*YDDYN%SIPRA
    
    ENDDO

    
    CALL VERDISINT_SINGLEBLOCK (YDGEOMETRY%YRVERT_GEOM%YRVFE, YDGEOMETRY%YRVERT_GEOM&
    &%YRCVER,'FDER','01', KLON, KIDIA, KFDIA, KLEV, ZIN1, ZP2MDETA, LDACC=LDACC)

    IF (YDGEOMETRY%YRVERT_GEOM%YRCVER%LVFE_LAPL_BC) THEN
      
      !$ACC PARALLEL LOOP GANG VECTOR &
      !$ACC&IF (LDACC) &
      !$ACC&PRIVATE (JLEV, JLON) 

      

      DO JLON = KIDIA, KFDIA

        DO JLEV=1, KLEV
          
          ZVLAPL (JLON, JLEV)=(YDDYN%SIRDEL_NH(JLEV)/YDGEOMETRY%YRVERT_GEOM%YRVETA%VFE_RDETAH&
          & (JLEV))*(ZP2MDETA (JLON, JLEV)*ZINDETA (JLON, JLEV)+(YDDYN%SITLAF_NH(JLEV)**2)*(&
          &(YDDYN%SIRDEL_NH(JLEV)/YDGEOMETRY%YRVERT_GEOM%YRVETA%VFE_RDETAH (JLEV))*ZINDETA2 &
          &(JLON, JLEV))-(1.0_JPRB-ZKAP_B)*YDDYN%SITLAF_NH(JLEV)*ZINDETA (JLON, JLEV))
        
        ENDDO

      ENDDO

    ELSE
      
      !$ACC PARALLEL LOOP GANG VECTOR &
      !$ACC&IF (LDACC) &
      !$ACC&PRIVATE (JLEV, JLON) 

      

      DO JLON = KIDIA, KFDIA

        DO JLEV=2, KLEV-1
          
          ZVLAPL (JLON, JLEV)=(YDDYN%SIRDEL_NH(JLEV)/YDGEOMETRY%YRVERT_GEOM%YRVETA%VFE_RDETAH&
          & (JLEV))*(ZP2MDETA (JLON, JLEV)*ZINDETA (JLON, JLEV)+(YDDYN%SITLAF_NH(JLEV)**2)*(&
          &(YDDYN%SIRDEL_NH(JLEV)/YDGEOMETRY%YRVERT_GEOM%YRVETA%VFE_RDETAH (JLEV))*ZINDETA2 &
          &(JLON, JLEV))-(1.0_JPRB-ZKAP_B)*YDDYN%SITLAF_NH(JLEV)*ZINDETA (JLON, JLEV))
        
        ENDDO

        
        ZVLAPL (JLON, 1)=-YDDYN%SIZA(1)*ZIN (JLON, 1)+YDDYN%SIZC(1)*(ZIN (JLON, 2)-ZIN (JLON, 1))
        ZVLAPL (JLON, KLEV)=YDDYN%SIZA(KLEV)*(ZIN (JLON, KLEV-1)&
        &-ZIN (JLON, KLEV))-YDDYN%SIZC(KLEV)*ZIN (JLON, KLEV)
      
      ENDDO

    
    ENDIF

  ENDIF

ELSE
  
  !$ACC PARALLEL LOOP GANG VECTOR &
  !$ACC&IF (LDACC) &
  !$ACC&PRIVATE (JLEV, JLON) 

  

  DO JLON = KIDIA, KFDIA

    DO JLEV=1, KLEV
      
      ZIN (JLON, JLEV)=PV1 (JLON, JLEV)
    
    ENDDO

  ENDDO


  IF (YDDYN%NOPT_SISLP/=0) THEN
    
    !$ACC PARALLEL LOOP GANG VECTOR &
    !$ACC&IF (LDACC) &
    !$ACC&PRIVATE (JLEV, JLON) 

    

    DO JLON = KIDIA, KFDIA

      DO JLEV=1, KLEV-1
        
        ZVDERW_FD (JLON, JLEV)=ZKAP_B*((YDDYN%SITLAF_NH(JLEV+1)*ZIN (JLON, JLEV+1)-YDDYN%SITLAF_NH(JLEV)*ZIN&
        & (JLON, JLEV))/(YDDYN%SITLAF_NH(JLEV+1)-YDDYN%SITLAF_NH(JLEV)))+(1.0_JPRB-ZKAP_B)*YDDYN%SITLAH_NH(JLEV&
        &)*((ZIN (JLON, JLEV+1)-ZIN (JLON, JLEV))/(YDDYN%SITLAF_NH(JLEV+1)-YDDYN%SITLAF_NH(JLEV)))
      
      ENDDO

      
      ZVDERW_FD (JLON, 0)=ZKAP_B*ZIN (JLON, 1)
      ZVDERW_FD (JLON, KLEV)=ZKAP_B*ZIN (JLON, KLEV)
    
    ENDDO


    

    IF (YDGEOMETRY%YRVERT_GEOM%YRCVER%LCOMPATIBLE) THEN
      
      !$ACC PARALLEL LOOP GANG VECTOR &
      !$ACC&IF (LDACC) &
      !$ACC&PRIVATE (JLEV, JLON) 

      

      DO JLON = KIDIA, KFDIA

        DO JLEV=1, KLEV
          
          ZVDERU (JLON, JLEV)=(YDDYN%SIGFL(JLEV)*(YDDYN%SIWH2F(JLEV, 2)*ZVDERW_FD&
          & (JLON, JLEV)+YDDYN%SIWH2F(JLEV, 1)*ZVDERW_FD (JLON, JLEV-1))-YDCST%RD&
          &*YDDYN%SITRM(JLEV)*YDDYN%SITFL(JLEV)*ZIN (JLON, JLEV))/YDCST%RG
          ZVDERV (JLON, JLEV)=(YDDYN%SIGFM(JLEV)*(YDDYN%SIWH2F(JLEV, 2)*ZVDERW_FD&
          & (JLON, JLEV)+YDDYN%SIWH2F(JLEV, 1)*ZVDERW_FD (JLON, JLEV-1))-YDCST%RD&
          &*YDDYN%SITRM(JLEV)*YDDYN%SITFM(JLEV)*ZIN (JLON, JLEV))/YDCST%RG
        
        ENDDO


        DO JLEV=2, KLEV-1
          
          ZVLAPL (JLON, JLEV)=(YDDYN%SITRAM(JLEV)/YDDYN%SITR)*(YDCST%RD/YDCST%RG)*YDDYN%SITR*(YDDYN%SITFL(JLEV&
          &)*ZVDERU (JLON, JLEV)+YDDYN%SITFM(JLEV)*ZVDERV (JLON, JLEV))+(YDDYN%RGWFRIC(JLEV)*ZVDERW_FD (JLON&
          &, JLEV)-YDDYN%RGWFRIC(JLEV-1)*ZVDERW_FD (JLON, JLEV-1)+((YDDYN%SIGFL(JLEV+1)*ZVDERU (JLON, JLEV+1&
          &)+YDDYN%SIWF2H(JLEV)*(YDDYN%SIGFL(JLEV)*ZVDERU (JLON, JLEV)-YDDYN%SIGFL(JLEV+1)*ZVDERU (JLON, JLEV&
          &+1)))+(YDDYN%SIGFM(JLEV+1)*ZVDERV (JLON, JLEV+1)+YDDYN%SIWF2H(JLEV)*(YDDYN%SIGFM(JLEV)*ZVDERV (JLON&
          &, JLEV)-YDDYN%SIGFM(JLEV+1)*ZVDERV (JLON, JLEV+1)))-(YDDYN%SIGFL(JLEV)*ZVDERU (JLON, JLEV)+YDDYN&
          &%SIWF2H(JLEV-1)*(YDDYN%SIGFL(JLEV-1)*ZVDERU (JLON, JLEV-1)-YDDYN%SIGFL(JLEV)*ZVDERU (JLON, JLEV)&
          &))-(YDDYN%SIGFM(JLEV)*ZVDERV (JLON, JLEV)+YDDYN%SIWF2H(JLEV-1)*(YDDYN%SIGFM(JLEV-1)*ZVDERV (JLON&
          &, JLEV-1)-YDDYN%SIGFM(JLEV)*ZVDERV (JLON, JLEV))))/YDCST%RG)/YDDYN%SILNPR_NH(JLEV)
        
        ENDDO

        
        ZVLAPL (JLON, 1)=(YDDYN%SITRAM(1)/YDDYN%SITR)*(YDCST%RD/YDCST%RG)*YDDYN%SITR*(YDDYN%SITFL(1)&
        &*ZVDERU (JLON, 1)+YDDYN%SITFM(1)*ZVDERV (JLON, 1))+(YDDYN%RGWFRIC(1)*ZVDERW_FD (JLON, 1)-YDDYN&
        &%RGWFRIC(0)*ZVDERW_FD (JLON, 0)+((YDDYN%SIGFL(2)*ZVDERU (JLON, 2)+YDDYN%SIWF2H(1)*(YDDYN%SIGFL&
        &(2)*ZVDERU (JLON, 1)-YDDYN%SIGFL(2)*ZVDERU (JLON, 2)))+(YDDYN%SIGFM(2)*ZVDERV (JLON, 2)+YDDYN&
        &%SIWF2H(1)*(YDDYN%SIGFM(1)*ZVDERV (JLON, 1)-YDDYN%SIGFM(2)*ZVDERV (JLON, 2)))-YDDYN%SIGFL(1&
        &)*ZVDERU (JLON, 1)-YDDYN%SIGFM(1)*ZVDERV (JLON, 1))/YDCST%RG)/YDDYN%SILNPR_NH(1)
        ZVLAPL (JLON, KLEV)=(YDDYN%SITRAM(KLEV)/YDDYN%SITR)*(YDCST%RD/YDCST%RG)*YDDYN%SITR*(YDDYN%SITFL&
        &(KLEV)*ZVDERU (JLON, KLEV)+YDDYN%SITFM(KLEV)*ZVDERV (JLON, KLEV))+(-YDDYN%RGWFRIC(KLEV-1)&
        &*ZVDERW_FD (JLON, KLEV-1)+(-(YDDYN%SIGFL(KLEV)*ZVDERU (JLON, KLEV)+YDDYN%SIWF2H(KLEV-1)*(YDDYN&
        &%SIGFL(KLEV-1)*ZVDERU (JLON, KLEV-1)-YDDYN%SIGFL(KLEV)*ZVDERU (JLON, KLEV)))-(YDDYN%SIGFM&
        &(KLEV)*ZVDERV (JLON, KLEV)+YDDYN%SIWF2H(KLEV-1)*(YDDYN%SIGFM(KLEV-1)*ZVDERV (JLON, KLEV-1&
        &)-YDDYN%SIGFM(KLEV)*ZVDERV (JLON, KLEV))))/YDCST%RG)/YDDYN%SILNPR_NH(KLEV)
      
      ENDDO

    
    
    ELSE
      
      !$ACC PARALLEL LOOP GANG VECTOR &
      !$ACC&IF (LDACC) &
      !$ACC&PRIVATE (JLEV, JLON) 

      

      DO JLON = KIDIA, KFDIA

        DO JLEV=1, KLEV
          
          ZVDERU (JLON, JLEV)=((YDDYN%SIWH2F(JLEV, 2)*YDDYN%SIGHL(JLEV)*ZVDERW_FD (JLON&
          &, JLEV)+YDDYN%SIWH2F(JLEV, 1)*YDDYN%SIGHL(JLEV-1)*ZVDERW_FD (JLON, JLEV-1))&
          &-YDCST%RD*YDDYN%SITRM(JLEV)*YDDYN%SITFL(JLEV)*ZIN (JLON, JLEV))/YDCST%RG
          ZVDERV (JLON, JLEV)=((YDDYN%SIWH2F(JLEV, 2)*YDDYN%SIGHM(JLEV)*ZVDERW_FD (JLON&
          &, JLEV)+YDDYN%SIWH2F(JLEV, 1)*YDDYN%SIGHM(JLEV-1)*ZVDERW_FD (JLON, JLEV-1))&
          &-YDCST%RD*YDDYN%SITRM(JLEV)*YDDYN%SITFM(JLEV)*ZIN (JLON, JLEV))/YDCST%RG
        
        ENDDO


        DO JLEV=2, KLEV-1
          
          ZVLAPL (JLON, JLEV)=(YDDYN%SITRAM(JLEV)/YDDYN%SITR)*(YDCST%RD/YDCST%RG)*YDDYN%SITR*(YDDYN%SITFL&
          &(JLEV)*ZVDERU (JLON, JLEV)+YDDYN%SITFM(JLEV)*ZVDERV (JLON, JLEV))+(YDDYN%RGWFRIC(JLEV)*ZVDERW_FD&
          & (JLON, JLEV)-YDDYN%RGWFRIC(JLEV-1)*ZVDERW_FD (JLON, JLEV-1)+(YDDYN%SIGHL(JLEV)*(ZVDERU (JLON&
          &, JLEV+1)+YDDYN%SIWF2H(JLEV)*(ZVDERU (JLON, JLEV)-ZVDERU (JLON, JLEV+1)))+YDDYN%SIGHM(JLEV&
          &)*(ZVDERV (JLON, JLEV+1)+YDDYN%SIWF2H(JLEV)*(ZVDERV (JLON, JLEV)-ZVDERV (JLON, JLEV+1)))-YDDYN&
          &%SIGHL(JLEV-1)*(ZVDERU (JLON, JLEV)+YDDYN%SIWF2H(JLEV-1)*(ZVDERU (JLON, JLEV-1)-ZVDERU (JLON&
          &, JLEV)))-YDDYN%SIGHM(JLEV-1)*(ZVDERV (JLON, JLEV)+YDDYN%SIWF2H(JLEV-1)*(ZVDERV (JLON, JLEV&
          &-1)-ZVDERV (JLON, JLEV))))/YDCST%RG)/YDDYN%SILNPR_NH(JLEV)
        
        ENDDO

        
        ZVLAPL (JLON, 1)=(YDDYN%SITRAM(1)/YDDYN%SITR)*(YDCST%RD/YDCST%RG)*YDDYN%SITR*(YDDYN%SITFL(1)*ZVDERU&
        & (JLON, 1)+YDDYN%SITFM(1)*ZVDERV (JLON, 1))+(YDDYN%RGWFRIC(1)*ZVDERW_FD (JLON, 1)-YDDYN%RGWFRIC(0&
        &)*ZVDERW_FD (JLON, 0)+(YDDYN%SIGHL(1)*(ZVDERU (JLON, 2)+YDDYN%SIWF2H(1)*(ZVDERU (JLON, 1)-ZVDERU &
        &(JLON, 2)))+YDDYN%SIGHM(1)*(ZVDERV (JLON, 2)+YDDYN%SIWF2H(1)*(ZVDERV (JLON, 1)-ZVDERV (JLON, 2)))&
        &-YDDYN%SIGHL(0)*ZVDERU (JLON, 1)-YDDYN%SIGHM(0)*ZVDERV (JLON, 1))/YDCST%RG)/YDDYN%SILNPR_NH(1)
        ZVLAPL (JLON, KLEV)=(YDDYN%SITRAM(KLEV)/YDDYN%SITR)*(YDCST%RD/YDCST%RG)*YDDYN%SITR*(YDDYN%SITFL&
        &(KLEV)*ZVDERU (JLON, KLEV)+YDDYN%SITFM(KLEV)*ZVDERV (JLON, KLEV))+(-YDDYN%RGWFRIC(KLEV-1)*ZVDERW_FD&
        & (JLON, KLEV-1)+(-YDDYN%SIGHL(KLEV-1)*(ZVDERU (JLON, KLEV)+YDDYN%SIWF2H(KLEV-1)*(ZVDERU (JLON&
        &, KLEV-1)-ZVDERU (JLON, KLEV)))-YDDYN%SIGHM(KLEV-1)*(ZVDERV (JLON, KLEV)+YDDYN%SIWF2H(KLEV-1&
        &)*(ZVDERV (JLON, KLEV-1)-ZVDERV (JLON, KLEV))))/YDCST%RG)/YDDYN%SILNPR_NH(KLEV)
      
      ENDDO

    
    
    ENDIF

  ELSE

    IF (YDDYN%LGWFRIC) THEN
      
      !$ACC PARALLEL LOOP GANG VECTOR &
      !$ACC&IF (LDACC) &
      !$ACC&PRIVATE (JLEV, JLON) 

      

      DO JLON = KIDIA, KFDIA

        DO JLEV=1, KLEV-1
          
          ZVDERW_FD (JLON, JLEV)=ZKAP_B*((YDDYN%SITLAF_NH(JLEV+1)*ZIN (JLON, JLEV+1)-YDDYN%SITLAF_NH(JLEV)*ZIN&
          & (JLON, JLEV))/(YDDYN%SITLAF_NH(JLEV+1)-YDDYN%SITLAF_NH(JLEV)))+(1.0_JPRB-ZKAP_B)*YDDYN%SITLAF_NH(JLEV&
          &)*((ZIN (JLON, JLEV+1)-ZIN (JLON, JLEV))/(YDDYN%SITLAF_NH(JLEV+1)-YDDYN%SITLAF_NH(JLEV)))
        
        ENDDO

        
        ZVDERW_FD (JLON, 0)=ZKAP_B*ZIN (JLON, 1)
        ZVDERW_FD (JLON, KLEV)=ZKAP_B*ZIN (JLON, KLEV)

        

        DO JLEV=1, KLEV-1
          
          ZVLAPL (JLON, JLEV)=(YDDYN%RGWFRIC(JLEV)*ZVDERW_FD (JLON, JLEV)-YDDYN&
          &%RGWFRIC(JLEV-1)*ZVDERW_FD (JLON, JLEV-1))/YDDYN%SILNPR_NH(JLEV)
        
        ENDDO

        
        ZVLAPL (JLON, KLEV)=(-YDDYN%RGWFRIC(KLEV-1)*ZVDERW_FD (JLON, KLEV-1))/YDDYN%SILNPR_NH(KLEV)
      
      ENDDO

    
    
    
    ELSE
      
      !$ACC PARALLEL LOOP GANG VECTOR &
      !$ACC&IF (LDACC) &
      !$ACC&PRIVATE (JLEV, JLON) 

      

      DO JLON = KIDIA, KFDIA
        
        ZVLAPL (JLON, 1)=-YDDYN%SIZA(1)*ZIN (JLON, 1)+YDDYN%SIZC(1)*(ZIN (JLON, 2)-ZIN (JLON, 1))
        ZVLAPL (JLON, KLEV)=YDDYN%SIZA(KLEV)*(ZIN (JLON, KLEV-1)&
        &-ZIN (JLON, KLEV))-YDDYN%SIZC(KLEV)*ZIN (JLON, KLEV)

        

        DO JLEV=2, KLEV-1
          
          ZVLAPL (JLON, JLEV)=YDDYN%SIZC(JLEV)*(ZIN (JLON, JLEV+1)-ZIN (JLON&
          &, JLEV))+YDDYN%SIZA(JLEV)*(ZIN (JLON, JLEV-1)-ZIN (JLON, JLEV))
        
        ENDDO

      ENDDO

    
    ENDIF

  ENDIF

ENDIF


!$ACC PARALLEL LOOP GANG VECTOR &
!$ACC&IF (LDACC) &
!$ACC&PRIVATE (JLEV, JLON) 


DO JLON = KIDIA, KFDIA

  DO JLEV=1, KLEV
    
    PV2 (JLON, JLEV)=ZVLAPL (JLON, JLEV)
  
  ENDDO

ENDDO


IF (PRESENT (LD_LSTAR)) THEN
  LL_LSTAR=LD_LSTAR
ELSE
  LL_LSTAR=.FALSE.
ENDIF


IF (.NOT.LL_LSTAR) THEN
  
  !$ACC PARALLEL LOOP GANG VECTOR &
  !$ACC&IF (LDACC) &
  !$ACC&PRIVATE (JLEV, JLON) 

  

  DO JLON = KIDIA, KFDIA

    DO JLEV=1, KLEV
      
      PV2 (JLON, JLEV)=(YDDYN%SITR/YDDYN%SITRAM (JLEV))*PV2 (JLON, JLEV)
    
    ENDDO

  ENDDO

ENDIF


IF (PRESENT (LD_SKAPI)) THEN
  LL_SKAPI=LD_SKAPI
ELSE
  LL_SKAPI=YDDYNA%LNHQE.AND.YDDYN%LNHQE_SOLVER_SP
ENDIF


IF (LL_SKAPI) THEN
  
  !$ACC PARALLEL LOOP GANG VECTOR &
  !$ACC&IF (LDACC) &
  !$ACC&PRIVATE (JLEV, JLON) 

  

  DO JLON = KIDIA, KFDIA

    DO JLEV=1, KLEV
      
      ZV2 (JLON, JLEV)=PV2 (JLON, JLEV)
    
    ENDDO

  ENDDO

  CALL SISKAPI_SINGLEBLOCK (YDCST, YDGEOMETRY, YDDYN, YDDYNA&
  &, KLON, KLEV, KIDIA, KFDIA, ZV2, PV2, LDACC=LDACC)
ENDIF



IF (LHOOK) CALL DR_HOOK ('SISEVE_SINGLEBLOCK', 1, ZHOOK_HANDLE)
!$ACC END DATA

ENDSUBROUTINE SISEVE_SINGLEBLOCK
