SUBROUTINE SIDD_SINGLEBLOCK (YDCST, YDGEOMETRY, YDDYN, YDDYNA,&
& KLON, KLEV, KIDIA, KFDIA, PDH, PDV, PRNH, PT, PSP, LDACC)
USE GEOMETRY_MOD,ONLY:GEOMETRY
USE PARKIND1,ONLY:JPIM, JPRB
USE YOMHOOK,ONLY:LHOOK, DR_HOOK, JPHOOK
USE YOMCST,ONLY:TCST
USE YOMDYN,ONLY:TDYN
USE YOMDYNA,ONLY:TDYNA
USE FXTRAN_ACDC_STACK_MOD
#include "fxtran_acdc_stack.h"

IMPLICIT NONE


TYPE (TCST), INTENT (IN)::YDCST
TYPE (GEOMETRY), INTENT (IN)::YDGEOMETRY
TYPE (TDYN), INTENT (IN)::YDDYN
TYPE (TDYNA), INTENT (IN)::YDDYNA
INTEGER (KIND=JPIM), INTENT (IN)::KLEV
INTEGER (KIND=JPIM), INTENT (IN)::KLON
INTEGER (KIND=JPIM), INTENT (IN)::KIDIA
INTEGER (KIND=JPIM), INTENT (IN)::KFDIA
REAL (KIND=JPRB), INTENT (INOUT)::PDH (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PDV (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PRNH (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PT (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PSP (KLON)
LOGICAL, INTENT (IN) :: LDACC
REAL (KIND=JPRB)::ZW3D (KLON, KLEV)
REAL (KIND=JPRB)::ZW2D (KLON)
REAL (KIND=JPRB)::ZIN (KLON, KLEV)
INTEGER (KIND=JPIM)::JLON
INTEGER (KIND=JPIM)::JLEV
REAL (KIND=JPRB)::ZKAP_B
REAL (KIND=JPRB)::ZDIM
REAL (KIND=JPHOOK)::ZHOOK_HANDLE
#include "siseve.intfb.h"
#include "sigam.intfb.h"
#include "sigam_nh.intfb.h"
TYPE (FXTRAN_ACDC_STACK) :: YLSTACK

!$ACC DATA &
!$ACC&CREATE (ZIN, ZW2D, ZW3D) &
!$ACC&IF (LDACC) &
!$ACC&PRESENT (PDH, PDV, PRNH, PSP, PT, YDCST, YDDYN, YDDYNA, YDGEOMETRY) 

IF (LHOOK) CALL DR_HOOK ('SIDD_SINGLEBLOCK', 0, ZHOOK_HANDLE)
CALL SIGAM_SINGLEBLOCK (YDCST, YDGEOMETRY, YDDYN, KLON&
&, KLEV, KIDIA, KFDIA, PDH, PT, PSP, LDACC=LDACC)

IF (YDDYNA%LNHEE.AND.(.NOT.YDDYNA%LSI_NHEE)) THEN
  
  !$ACC PARALLEL LOOP GANG VECTOR &
  !$ACC&IF (LDACC) &
  !$ACC&PRIVATE (JLON) 

  

  DO JLON = KIDIA, KFDIA
    
    ZW2D (JLON)=0.0_JPRB
  
  ENDDO

  CALL SIGAM_SINGLEBLOCK (YDCST, YDGEOMETRY, YDDYN, KLON,&
  & KLEV, KIDIA, KFDIA, ZW3D, PRNH, ZW2D, LDACC=LDACC)
  
  !$ACC PARALLEL LOOP GANG VECTOR &
  !$ACC&IF (LDACC) &
  !$ACC&PRIVATE (JLEV, JLON) 

  

  DO JLON = KIDIA, KFDIA

    DO JLEV=1, KLEV
      
      PDH (JLON, JLEV)=PDH (JLON, JLEV)-(1.0_JPRB-YDDYN%SITVAR)*YDDYN%SITR&
      &*ZW3D (JLON, JLEV)+YDCST%RD*YDDYN%SITR*PRNH (JLON, JLEV)
    
    ENDDO

  ENDDO

ELSE
  CALL SIGAM_NH_SINGLEBLOCK (YDCST, YDGEOMETRY, YDDYN, KLON&
  &, KLEV, KIDIA, KFDIA, ZW3D, PRNH, LDACC=LDACC)
  ZKAP_B=1.0_JPRB

  IF (YDDYNA%LNHQE.AND.YDDYN%LNHQE_SOLVER_SP)  THEN
    ZKAP_B=YDCST%RKAPPA
  ENDIF

  
  !$ACC PARALLEL LOOP GANG VECTOR &
  !$ACC&IF (LDACC) &
  !$ACC&PRIVATE (JLEV, JLON) 

  

  DO JLON = KIDIA, KFDIA

    DO JLEV=1, KLEV
      
      PDH (JLON, JLEV)=PDH (JLON, JLEV)+YDCST%RD*YDDYN%SITRM (JLEV)*PRNH (JLON&
      &, JLEV)-ZKAP_B*(1.0_JPRB-YDDYN%SITVAR)*YDDYN%SITR*ZW3D (JLON, JLEV)
    
    ENDDO

  ENDDO

ENDIF

CALL SISEVE_SINGLEBLOCK (YDCST, YDGEOMETRY, YDDYN, YDDYNA&
&, KLON, KLEV, KIDIA, KFDIA, PRNH, ZW3D, LDACC=LDACC)
ZDIM=YDCST%RG*YDCST%RG/(YDCST%RD*YDDYN%SITR)

!$ACC PARALLEL LOOP GANG VECTOR &
!$ACC&IF (LDACC) &
!$ACC&PRIVATE (JLEV, JLON) 


DO JLON = KIDIA, KFDIA

  DO JLEV=1, KLEV
    
    PDV (JLON, JLEV)=ZDIM*ZW3D (JLON, JLEV)
  
  ENDDO

ENDDO

IF (LHOOK) CALL DR_HOOK ('SIDD_SINGLEBLOCK', 1, ZHOOK_HANDLE)
!$ACC END DATA

ENDSUBROUTINE SIDD_SINGLEBLOCK
