SUBROUTINE TRIDIA2_SINGLEBLOCK (KN, KPROMA, KST, KEND, PM, PRHS, PSOL, LDACC)
USE PARKIND1,ONLY:JPIM, JPRB
USE YOMHOOK,ONLY:LHOOK, DR_HOOK, JPHOOK
USE FXTRAN_ACDC_STACK_MOD
#include "fxtran_acdc_stack.h"

IMPLICIT NONE


INTEGER (KIND=JPIM), INTENT (IN)::KN
INTEGER (KIND=JPIM), INTENT (IN)::KPROMA
INTEGER (KIND=JPIM), INTENT (IN)::KST
INTEGER (KIND=JPIM), INTENT (IN)::KEND
REAL (KIND=JPRB), INTENT (IN)::PM (KPROMA, KN,-1:1)
REAL (KIND=JPRB), INTENT (IN)::PRHS (KPROMA, KN)
REAL (KIND=JPRB), INTENT (OUT)::PSOL (KPROMA, KN)
LOGICAL, INTENT (IN) :: LDACC
REAL (KIND=JPRB)::ZRHS (KPROMA, KN)
REAL (KIND=JPRB)::ZM (KPROMA, KN,-1:1)
INTEGER (KIND=JPIM)::JROF
INTEGER (KIND=JPIM)::J
REAL (KIND=JPRB)::ZDEN
REAL (KIND=JPHOOK)::ZHOOK_HANDLE
TYPE (FXTRAN_ACDC_STACK) :: YLSTACK

!$ACC DATA &
!$ACC&CREATE (ZM, ZRHS) &
!$ACC&IF (LDACC) &
!$ACC&PRESENT (PM, PRHS, PSOL) 

IF (LHOOK) CALL DR_HOOK ('TRIDIA2_SINGLEBLOCK', 0, ZHOOK_HANDLE)

!$ACC PARALLEL LOOP GANG VECTOR &
!$ACC&IF (LDACC) &
!$ACC&PRIVATE (JROF) 


DO JROF = KST, KEND
  ZM(JROF,:,:)=PM(JROF,:,:)
  ZM (JROF, 1,-1)=0.0_JPRB
  ZM (JROF, KN, 1)=0.0_JPRB
  ZRHS (JROF, 1:KN)=PRHS (JROF, 1:KN)
  
  PSOL (JROF, 1)=-ZM (JROF, 1, 1)/ZM (JROF, 1, 0)
  ZRHS (JROF, 1)=ZRHS (JROF, 1)/ZM (JROF, 1, 0)
  
ENDDO






DO J=2, KN
  
  !$ACC PARALLEL LOOP GANG VECTOR &
  !$ACC&IF (LDACC) &
  !$ACC&PRIVATE (JROF, ZDEN) 

  

  DO JROF = KST, KEND
    
    ZDEN=1.0_JPRB/(ZM (JROF, J,-1)*PSOL (JROF, J-1)+ZM (JROF, J, 0))
    PSOL (JROF, J)=-ZM (JROF, J, 1)*ZDEN
    ZRHS (JROF, J)=(ZRHS (JROF, J)-ZRHS (JROF, J-1)*ZM (JROF, J,-1))*ZDEN
  
  ENDDO

ENDDO


!$ACC PARALLEL LOOP GANG VECTOR &
!$ACC&IF (LDACC) &
!$ACC&PRIVATE (JROF) 


DO JROF = KST, KEND
  PSOL (JROF, KN)=ZRHS (JROF, KN)
ENDDO


DO J=KN-1, 1,-1
  
  !$ACC PARALLEL LOOP GANG VECTOR &
  !$ACC&IF (LDACC) &
  !$ACC&PRIVATE (JROF) 

  

  DO JROF = KST, KEND
    
    PSOL (JROF, J)=ZRHS (JROF, J)+PSOL (JROF, J)*PSOL (JROF, J+1)
  
  ENDDO

ENDDO

IF (LHOOK) CALL DR_HOOK ('TRIDIA2_SINGLEBLOCK', 1, ZHOOK_HANDLE)
!$ACC END DATA

ENDSUBROUTINE TRIDIA2_SINGLEBLOCK
