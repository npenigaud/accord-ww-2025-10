SUBROUTINE SITNU_SINGLEBLOCK (YDCST, YDGEOMETRY, YDDYN&
&, KLON, KLEV, KIDIA, KFDIA, PD, PT, PSP, LDACC)
USE GEOMETRY_MOD,ONLY:GEOMETRY
USE PARKIND1,ONLY:JPIM, JPRB
USE YOMHOOK,ONLY:LHOOK, DR_HOOK, JPHOOK
USE YOMCST,ONLY:TCST
USE YOMDYN,ONLY:TDYN
USE FXTRAN_ACDC_STACK_MOD
#include "fxtran_acdc_stack.h"

IMPLICIT NONE


TYPE (TCST), INTENT (IN)::YDCST
TYPE (GEOMETRY), INTENT (IN)::YDGEOMETRY
TYPE (TDYN), INTENT (IN)::YDDYN
INTEGER (KIND=JPIM), INTENT (IN)::KLEV
INTEGER (KIND=JPIM), INTENT (IN)::KLON
INTEGER (KIND=JPIM), INTENT (IN)::KIDIA
INTEGER (KIND=JPIM), INTENT (IN)::KFDIA
REAL (KIND=JPRB), INTENT (IN)::PD (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PT (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PSP (KLON)
LOGICAL, INTENT (IN) :: LDACC
REAL (KIND=JPRB)::ZSDIV (KLON, 0:KLEV+1)
REAL (KIND=JPRB)::ZOUT (KLON, KLEV+1)
REAL (KIND=JPRB)::ZSDIVX (KLON)
INTEGER (KIND=JPIM)::JLON
INTEGER (KIND=JPIM)::JLEV
REAL (KIND=JPRB)::ZREC
REAL (KIND=JPHOOK)::ZHOOK_HANDLE
#include "verdisint.intfb.h"
TYPE (FXTRAN_ACDC_STACK) :: YLSTACK

!$ACC DATA &
!$ACC&CREATE (ZOUT, ZSDIV, ZSDIVX) &
!$ACC&IF (LDACC) &
!$ACC&PRESENT (PD, PSP, PT, YDCST, YDDYN, YDGEOMETRY) 

IF (LHOOK) CALL DR_HOOK ('SITNU_SINGLEBLOCK', 0, ZHOOK_HANDLE)





IF (YDGEOMETRY%YRVERT_GEOM%YRCVER%LVERTFE) THEN
  
  !$ACC PARALLEL LOOP GANG VECTOR &
  !$ACC&IF (LDACC) &
  !$ACC&PRIVATE (JLEV, JLON) 

  

  DO JLON = KIDIA, KFDIA

    DO JLEV=1, KLEV
      
      ZSDIV (JLON, JLEV)=PD (JLON, JLEV)*YDDYN%SIDELP(JLEV&
      &)*YDGEOMETRY%YRVERT_GEOM%YRVETA%VFE_RDETAH (JLEV)
    
    ENDDO

  ENDDO


  IF (KLON>=1) THEN
    
    !$ACC PARALLEL LOOP GANG VECTOR &
    !$ACC&IF (LDACC) &
    !$ACC&PRIVATE (JLON) 

    

    DO JLON = KIDIA, KFDIA
      ZSDIV (JLON, 0)=0.0_JPRB
      ZSDIV (JLON, KLEV+1)=0.0_JPRB
    ENDDO

    
    CALL VERDISINT_SINGLEBLOCK (YDGEOMETRY%YRVERT_GEOM%YRVFE, YDGEOMETRY%YRVERT_GEOM%YRCVER,'ITOP'&
    &,'11', KLON, KIDIA, KFDIA, KLEV, ZSDIV, ZOUT, KCHUNK=YDGEOMETRY%YRDIM%NPROMA, LDACC=LDACC)
  ENDIF

  
  !$ACC PARALLEL LOOP GANG VECTOR &
  !$ACC&IF (LDACC) &
  !$ACC&PRIVATE (JLEV, JLON, ZREC) 

  

  DO JLON = KIDIA, KFDIA

    DO JLEV=1, KLEV
      
      ZREC=1.0_JPRB/YDDYN%SITLAF(JLEV)
      PT (JLON, JLEV)=YDCST%RKAPPA*YDDYN%SITR*ZOUT (JLON, JLEV)*ZREC
    
    ENDDO

    
    PSP (JLON)=ZOUT (JLON, KLEV+1)*YDDYN%SIRPRN
  
  ENDDO

  
ELSE
  
  !$ACC PARALLEL LOOP GANG VECTOR &
  !$ACC&IF (LDACC) &
  !$ACC&PRIVATE (JLEV, JLON) 

  

  DO JLON = KIDIA, KFDIA
    
    ZSDIVX (JLON)=0.0_JPRB

    DO JLEV=1, KLEV
      PT (JLON, JLEV)=YDCST%RKAPPA*YDDYN%SITR*(YDDYN%SIRDEL(JLEV)*YDDYN%SILNPR&
      &(JLEV)*ZSDIVX (JLON)+YDDYN%SIALPH(JLEV)*PD (JLON, JLEV))
      ZSDIVX (JLON)=ZSDIVX (JLON)+PD (JLON, JLEV)*YDDYN%SIDELP(JLEV)
    ENDDO

    PSP (JLON)=ZSDIVX (JLON)*YDDYN%SIRPRN
  
  ENDDO

ENDIF



IF (LHOOK) CALL DR_HOOK ('SITNU_SINGLEBLOCK', 1, ZHOOK_HANDLE)
!$ACC END DATA

ENDSUBROUTINE SITNU_SINGLEBLOCK
