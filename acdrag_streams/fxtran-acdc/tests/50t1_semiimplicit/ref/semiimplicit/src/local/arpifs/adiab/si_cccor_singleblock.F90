SUBROUTINE SI_CCCOR_SINGLEBLOCK (YDCST, YDGEOMETRY, YDDYN, YDDYNA&
&, KLON, KLEV, KIDIA, KFDIA, PIN, POU, POU2, LDACC)
USE GEOMETRY_MOD,ONLY:GEOMETRY
USE PARKIND1,ONLY:JPIM, JPRB
USE YOMHOOK,ONLY:LHOOK, DR_HOOK, JPHOOK
USE YOMCST,ONLY:TCST
USE YOMDYN,ONLY:TDYN
USE YOMDYNA,ONLY:TDYNA
USE FXTRAN_ACDC_STACK_MOD
#include "fxtran_acdc_stack.h"

IMPLICIT NONE


TYPE (TCST), INTENT (IN)::YDCST
TYPE (GEOMETRY), INTENT (IN)::YDGEOMETRY
TYPE (TDYN), INTENT (IN)::YDDYN
TYPE (TDYNA), INTENT (IN)::YDDYNA
INTEGER (KIND=JPIM), INTENT (IN)::KLEV
INTEGER (KIND=JPIM), INTENT (IN)::KLON
INTEGER (KIND=JPIM), INTENT (IN)::KIDIA
INTEGER (KIND=JPIM), INTENT (IN)::KFDIA
REAL (KIND=JPRB), INTENT (IN)::PIN (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::POU (KLON, KLEV)
REAL (KIND=JPRB), OPTIONAL, INTENT (OUT)::POU2 (KLON, KLEV)
LOGICAL, INTENT (IN) :: LDACC
INTEGER (KIND=JPIM)::JLON
INTEGER (KIND=JPIM)::JLEV
REAL (KIND=JPRB)::ZGAM (KLON, KLEV)
REAL (KIND=JPRB)::ZTAU (KLON, KLEV)
REAL (KIND=JPRB)::ZGAMTAU (KLON, KLEV)
REAL (KIND=JPRB)::ZTAUGAM (KLON, KLEV)
REAL (KIND=JPRB)::ZAUX (KLON, KLEV)
REAL (KIND=JPRB)::ZNU (KLON)
REAL (KIND=JPRB)::ZFAC
REAL (KIND=JPRB)::ZSP (KLON)
REAL (KIND=JPHOOK)::ZHOOK_HANDLE
#include "sigam.intfb.h"
#include "sitnu.intfb.h"
#include "siseve.intfb.h"
TYPE (FXTRAN_ACDC_STACK) :: YLSTACK

!$ACC DATA &
!$ACC&CREATE (ZAUX, ZGAM, ZGAMTAU, ZNU, ZSP, ZTAU, ZTAUGAM) &
!$ACC&IF (LDACC) &
!$ACC&PRESENT (PIN, POU, POU2, YDCST, YDDYN, YDDYNA, YDGEOMETRY) 

IF (LHOOK) CALL DR_HOOK ('SI_CCCOR_SINGLEBLOCK', 0, ZHOOK_HANDLE)

CALL SITNU_SINGLEBLOCK (YDCST, YDGEOMETRY, YDDYN, KLON&
&, KLEV, KIDIA, KFDIA, PIN, ZTAU, ZNU, LDACC=LDACC)

!$ACC PARALLEL LOOP GANG VECTOR &
!$ACC&IF (LDACC) &
!$ACC&PRIVATE (JLON) 


DO JLON = KIDIA, KFDIA
  ZTAU (JLON,:)=ZTAU (JLON,:)*YDCST%RCPD
  ZSP (JLON)=0.0_JPRB
ENDDO


CALL SIGAM_SINGLEBLOCK (YDCST, YDGEOMETRY, YDDYN, KLON&
&, KLEV, KIDIA, KFDIA, ZGAM, PIN, ZSP, LDACC=LDACC)

!$ACC PARALLEL LOOP GANG VECTOR &
!$ACC&IF (LDACC) &
!$ACC&PRIVATE (JLON) 


DO JLON = KIDIA, KFDIA
  ZSP (JLON)=0.0_JPRB
ENDDO

CALL SIGAM_SINGLEBLOCK (YDCST, YDGEOMETRY, YDDYN, KLON, KLEV&
&, KIDIA, KFDIA, ZGAMTAU, ZTAU, ZSP, LDACC=LDACC)
ZFAC=1.0_JPRB+YDGEOMETRY%YRVERT_GEOM%YRCVER%RFAC1

!$ACC PARALLEL LOOP GANG VECTOR &
!$ACC&IF (LDACC) &
!$ACC&PRIVATE (JLEV, JLON) 


DO JLON = KIDIA, KFDIA

  DO JLEV=1, KLEV
    
    POU (JLON, JLEV)=ZGAMTAU (JLON, JLEV)/YDCST%RD*ZFAC-YDDYN%SITR*ZGAM (JLON&
    &, JLEV)-ZTAU (JLON, JLEV)*ZFAC+YDCST%RD*YDDYN%SITR*ZNU (JLON)
  
  ENDDO

ENDDO


IF (PRESENT (POU2)) THEN
  
  !$ACC PARALLEL LOOP GANG VECTOR &
  !$ACC&IF (LDACC) &
  !$ACC&PRIVATE (JLON) 

  

  DO JLON = KIDIA, KFDIA
    ZSP (JLON)=0.0_JPRB
  ENDDO

  CALL SITNU_SINGLEBLOCK (YDCST, YDGEOMETRY, YDDYN, KLON, KLEV&
  &, KIDIA, KFDIA, ZGAM, ZTAUGAM, ZSP, LDACC=LDACC)
  
  !$ACC PARALLEL LOOP GANG VECTOR &
  !$ACC&IF (LDACC) &
  !$ACC&PRIVATE (JLEV, JLON) 

  

  DO JLON = KIDIA, KFDIA

    DO JLEV=1, KLEV
      
      ZAUX (JLON, JLEV)=((YDCST%RCVD/YDCST%RD)*ZTAUGAM (JLON, JLEV)-ZTAU (JLON, JLEV&
      &)-YDDYN%SITR*ZGAM (JLON, JLEV))*YDCST%RCPD/(YDCST%RD*YDCST%RD*YDDYN%SITR)
    
    ENDDO

  ENDDO

  CALL SISEVE_SINGLEBLOCK (YDCST, YDGEOMETRY, YDDYN, YDDYNA&
  &, KLON, KLEV, KIDIA, KFDIA, ZAUX, POU2, LDACC=LDACC)
ENDIF


IF (LHOOK) CALL DR_HOOK ('SI_CCCOR_SINGLEBLOCK', 1, ZHOOK_HANDLE)
!$ACC END DATA

ENDSUBROUTINE SI_CCCOR_SINGLEBLOCK
