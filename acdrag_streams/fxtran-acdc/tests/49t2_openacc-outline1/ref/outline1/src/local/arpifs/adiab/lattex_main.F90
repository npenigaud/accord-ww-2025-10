SUBROUTINE LATTEX_MAIN (LDCT, LDCTC, LDSETTLSW, PBT, PDTS2, PESGM, PESGP, YDCPG_BNDS, YDCPG_OPTS, YDCPG_SL1&
&, YDCPG_SL2, YDCPG_TND, YDCPG_TNDSI_DDH, YDGEOMETRY, YDLDDH, YDML_DYN, YDML_GCONF, YDVARS, PCMSLP, PRGOM&
&, PRTWORGRA, PBDT, PEVEL, PGAGT0L, PGAGT0M, PGAGT9L, PGAGT9M, PGWFT0, PGWT0, PGWT9, PHIF0, PLPD0, PLPD9&
&, PMIXNL, PNHXT0, PNHXT9, POROGL, POROGM, PRDELP, PSPDS0, PSPDS9, PTOD0, PTOD9)
USE CPG_OPTS_TYPE_MOD,ONLY:CPG_BNDS_TYPE, CPG_OPTS_TYPE
USE CPG_SL1_TYPE_MOD,ONLY:CPG_SL1B_TYPE
USE CPG_SL2_TYPE_MOD,ONLY:CPG_SL2_TYPE
USE CPG_DDH_TND_TYPE_MOD,ONLY:CPG_TNDSI_DDH_TYPE
USE CPG_TYPE_MOD,ONLY:CPG_TND_TYPE
USE FIELD_VARIABLES_MOD,ONLY:FIELD_VARIABLES
USE GEOMETRY_MOD,ONLY:GEOMETRY
USE PARKIND1,ONLY:JPIM, JPRB
USE MODEL_DYNAMICS_MOD,ONLY:MODEL_DYNAMICS_TYPE
USE MODEL_GENERAL_CONF_MOD,ONLY:MODEL_GENERAL_CONF_TYPE
USE YOMLDDH,ONLY:TLDDH
USE YOMHOOK,ONLY:LHOOK, JPHOOK, DR_HOOK

IMPLICIT NONE

LOGICAL, INTENT (INOUT)::LDCT
LOGICAL, INTENT (INOUT)::LDCTC
LOGICAL, INTENT (INOUT)::LDSETTLSW
REAL (KIND=JPRB), INTENT (IN)::PBT
REAL (KIND=JPRB), INTENT (IN)::PDTS2
REAL (KIND=JPRB), INTENT (IN)::PESGM
REAL (KIND=JPRB), INTENT (IN)::PESGP
TYPE (CPG_BNDS_TYPE), INTENT (IN)::YDCPG_BNDS
TYPE (CPG_OPTS_TYPE), INTENT (IN)::YDCPG_OPTS
TYPE (CPG_SL1B_TYPE), INTENT (INOUT)::YDCPG_SL1
TYPE (CPG_SL2_TYPE), INTENT (INOUT)::YDCPG_SL2
TYPE (CPG_TND_TYPE), INTENT (INOUT)::YDCPG_TND
TYPE (CPG_TNDSI_DDH_TYPE), INTENT (INOUT)::YDCPG_TNDSI_DDH
TYPE (GEOMETRY), INTENT (IN)::YDGEOMETRY
TYPE (TLDDH), INTENT (IN)::YDLDDH
TYPE (MODEL_DYNAMICS_TYPE), INTENT (IN)::YDML_DYN
TYPE (MODEL_GENERAL_CONF_TYPE), INTENT (IN)::YDML_GCONF
TYPE (FIELD_VARIABLES), INTENT (INOUT)::YDVARS
REAL (KIND=JPRB), INTENT (INOUT)::PCMSLP
REAL (KIND=JPRB), INTENT (INOUT)::PRGOM
REAL (KIND=JPRB), INTENT (INOUT)::PRTWORGRA
REAL (KIND=JPRB), INTENT (IN)::PBDT (YDGEOMETRY%YRDIM%NPROMA)
REAL (KIND=JPRB), INTENT (IN)::PEVEL (YDGEOMETRY%YRDIM%NPROMA, 0:YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB), INTENT (IN)::PGAGT0L (YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB), INTENT (IN)::PGAGT0M (YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB), INTENT (IN)::PGAGT9L (YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB), INTENT (IN)::PGAGT9M (YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB), INTENT (IN)::PGWFT0 (YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB), INTENT (IN)::PGWT0 (YDGEOMETRY%YRDIM%NPROMNH, YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB), INTENT (IN)::PGWT9 (YDGEOMETRY%YRDIM%NPROMNH, YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB), INTENT (IN)::PHIF0 (YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB), INTENT (IN)::PLPD0 (YDGEOMETRY%YRDIM%NPROMNH, YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB), INTENT (IN)::PLPD9 (YDGEOMETRY%YRDIM%NPROMNH, YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB), INTENT (IN)::PMIXNL (YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB), INTENT (IN)::PNHXT0 (YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB), INTENT (IN)::PNHXT9 (YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB), INTENT (IN)::POROGL (YDGEOMETRY%YRDIM%NPROMA)
REAL (KIND=JPRB), INTENT (IN)::POROGM (YDGEOMETRY%YRDIM%NPROMA)
REAL (KIND=JPRB), INTENT (IN)::PRDELP (YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB), INTENT (IN)::PSPDS0 (YDGEOMETRY%YRDIM%NPROMNH, YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB), INTENT (IN)::PSPDS9 (YDGEOMETRY%YRDIM%NPROMNH, YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB), INTENT (IN)::PTOD0 (YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB), INTENT (IN)::PTOD9 (YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY%YRDIMV%NFLEVG)
#include "lattex_dnt.intfb.h"
#include "lattex_tnt.intfb.h"
INTEGER (KIND=JPIM)::JLEV
INTEGER (KIND=JPIM)::JROF
REAL (KIND=JPRB)::ZMOY1SPD (YDGEOMETRY%YRDIM%NPROMNH, YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB)::ZMOY1T (YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB)::ZMOY1U (YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB)::ZMOY1V (YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB)::ZMOY1VWV (YDGEOMETRY%YRDIM%NPROMNH, YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB)::ZSPDSI9 (YDGEOMETRY%YRDIM%NPROMNH, MERGE&
& (0, YDGEOMETRY%YRDIMV%NFLEVG, YDML_DYN%YRDYNA%LTWOTL))
REAL (KIND=JPRB)::ZTSI9 (YDGEOMETRY%YRDIM%NPROMA, MERGE (0&
&, YDGEOMETRY%YRDIMV%NFLEVG, YDML_DYN%YRDYNA%LTWOTL))
REAL (KIND=JPRB)::ZUSELESS (YDGEOMETRY%YRDIM%NPROMA,&
& YDGEOMETRY%YRDIMV%NFLSA:YDGEOMETRY%YRDIMV%NFLEN)
REAL (KIND=JPRB)::ZUSI9 (YDGEOMETRY%YRDIM%NPROMA, MERGE (0&
&, YDGEOMETRY%YRDIMV%NFLEVG, YDML_DYN%YRDYNA%LTWOTL))
REAL (KIND=JPRB)::ZVSI9 (YDGEOMETRY%YRDIM%NPROMA, MERGE (0&
&, YDGEOMETRY%YRDIMV%NFLEVG, YDML_DYN%YRDYNA%LTWOTL))
REAL (KIND=JPRB)::ZVWVSI9 (YDGEOMETRY%YRDIM%NPROMNH, MERGE&
& (0, YDGEOMETRY%YRDIMV%NFLEVG, YDML_DYN%YRDYNA%LTWOTL))
REAL (KIND=JPRB)::ZWT0 (YDGEOMETRY%YRDIM%NPROMA)
REAL (KIND=JPHOOK)::ZHOOK_HANDLE
IF (LHOOK) CALL DR_HOOK ('LATTEX_MAIN', 0, ZHOOK_HANDLE)

DO JLEV=1, YDGEOMETRY%YRDIMV%NFLEVG

  DO JROF=YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA
    YDCPG_SL2%USI (JROF, JLEV)=PBT*PGAGT0L (JROF, JLEV)
    YDCPG_SL2%VSI (JROF, JLEV)=PBT*PGAGT0M (JROF, JLEV)
  ENDDO


  DO JROF=YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA
    ZMOY1U (JROF, JLEV)=PDTS2*YDCPG_TND%TNDU_NOC (JROF, JLEV)
    ZMOY1V (JROF, JLEV)=PDTS2*YDCPG_TND%TNDV_NOC (JROF, JLEV)
  ENDDO


  IF (.NOT.YDML_DYN%YRDYN%LADVF) THEN

    IF (YDML_DYN%YRDYNA%LSACC) THEN

      DO JROF=YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA
        ZMOY1U (JROF, JLEV)=ZMOY1U (JROF, JLEV)+PDTS2*YDVARS%GEOMETRY%RCORI%T0 (JROF)*YDVARS%V%T0 (JROF, JLEV&
        &)+PDTS2*PRTWORGRA*YDVARS%GEOMETRY%RCORI%T0 (JROF)*YDVARS%V%T0 (JROF, JLEV)*PHIF0 (JROF, JLEV)-PDTS2*PRGOM&
        &*PGWFT0 (JROF, JLEV)*(1._JPRB-YDVARS%GEOMETRY%GEMU%T0 (JROF)*YDVARS%GEOMETRY%GEMU%T0 (JROF))
        ZMOY1V (JROF, JLEV)=ZMOY1V (JROF, JLEV)-PDTS2*YDVARS%GEOMETRY%RCORI%T0 (JROF)*YDVARS%U%T0 (JROF, JLEV&
        &)-PDTS2*PRTWORGRA*YDVARS%GEOMETRY%RCORI%T0 (JROF)*YDVARS%U%T0 (JROF, JLEV)*PHIF0 (JROF, JLEV)
      ENDDO

    ELSE

      DO JROF=YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA
        ZMOY1U (JROF, JLEV)=ZMOY1U (JROF, JLEV)+PDTS2*YDVARS&
        &%GEOMETRY%RCORI%P (JROF)*YDVARS%V%T0 (JROF, JLEV)
        ZMOY1V (JROF, JLEV)=ZMOY1V (JROF, JLEV)-PDTS2*YDVARS&
        &%GEOMETRY%RCORI%P (JROF)*YDVARS%U%T0 (JROF, JLEV)
      ENDDO

    ENDIF

  ENDIF

ENDDO


IF (YDML_DYN%YRDYNA%LTWOTL) THEN
  CALL LATTEX_DNT (YDCPG_OPTS%NSTEP, YDGEOMETRY, YDLDDH, YDML_GCONF%YRRIP, YDML_DYN%YRDYN&
  &, YDML_DYN%YRDYNA, YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA, LDSETTLSW, YDML_DYN%YRDYN%NWLAG&
  &, PESGP, PESGM, YDVARS%U%T0, YDVARS%U%T9, ZMOY1U, PMIXNL, YDCPG_SL2%USI, YDVARS%UNL%T9&
  &, YDVARS%U%T1, YDCPG_SL1%U0%P, YDCPG_SL1%U9%P, YDCPG_SL1%UF9%P, YDVARS%CUNL%T9, YDCPG_TNDSI_DDH&
  &%U%T0, YDCPG_TNDSI_DDH%U%T9, YDCPG_SL1%U9_SI%P, YDCPG_SL1%U9_NL%P)
  CALL LATTEX_DNT (YDCPG_OPTS%NSTEP, YDGEOMETRY, YDLDDH, YDML_GCONF%YRRIP, YDML_DYN%YRDYN&
  &, YDML_DYN%YRDYNA, YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA, LDSETTLSW, YDML_DYN%YRDYN%NWLAG&
  &, PESGP, PESGM, YDVARS%V%T0, YDVARS%V%T9, ZMOY1V, PMIXNL, YDCPG_SL2%VSI, YDVARS%VNL%T9&
  &, YDVARS%V%T1, YDCPG_SL1%V0%P, YDCPG_SL1%V9%P, YDCPG_SL1%VF9%P, YDVARS%CVNL%T9, YDCPG_TNDSI_DDH&
  &%V%T0, YDCPG_TNDSI_DDH%V%T9, YDCPG_SL1%V9_SI%P, YDCPG_SL1%V9_NL%P)
ELSE

  DO JLEV=1, YDGEOMETRY%YRDIMV%NFLEVG

    DO JROF=YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA
      ZUSI9 (JROF, JLEV)=PBT*PGAGT9L (JROF, JLEV)
      ZVSI9 (JROF, JLEV)=PBT*PGAGT9M (JROF, JLEV)
    ENDDO

  ENDDO

  CALL LATTEX_TNT (YDGEOMETRY, YDLDDH, YDML_DYN%YRDYN, YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA, YDML_DYN&
  &%YRDYN%NWLAG, PESGP, PESGM, YDVARS%U%T9, ZMOY1U, ZUSI9, YDCPG_SL2%USI, YDVARS%U%T1, YDCPG_SL1&
  &%U0%P, YDCPG_SL1%U9%P, YDCPG_SL1%UF9%P, YDCPG_TNDSI_DDH%U%T0, YDCPG_SL1%U9_SI%P)
  CALL LATTEX_TNT (YDGEOMETRY, YDLDDH, YDML_DYN%YRDYN, YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA, YDML_DYN&
  &%YRDYN%NWLAG, PESGP, PESGM, YDVARS%V%T9, ZMOY1V, ZVSI9, YDCPG_SL2%VSI, YDVARS%V%T1, YDCPG_SL1&
  &%V0%P, YDCPG_SL1%V9%P, YDCPG_SL1%VF9%P, YDCPG_TNDSI_DDH%V%T0, YDCPG_SL1%V9_SI%P)
ENDIF


IF (YDML_DYN%YRDYN%LADVF) THEN

  DO JLEV=1, YDGEOMETRY%YRDIMV%NFLEVG

    DO JROF=YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA
      YDVARS%U%T1 (JROF, JLEV)=YDVARS%U%T1 (JROF, JLEV)-YDVARS%GEOMETRY%GOMVRL%P (JROF)
      YDVARS%V%T1 (JROF, JLEV)=YDVARS%V%T1 (JROF, JLEV)-YDVARS%GEOMETRY%GOMVRM%P (JROF)
    ENDDO

  ENDDO

ENDIF


DO JLEV=1, YDGEOMETRY%YRDIMV%NFLEVG

  DO JROF=YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA
    YDCPG_SL2%TSI (JROF, JLEV)=PBDT (JROF)*PTOD0 (JROF, JLEV)
  ENDDO


  IF (YDGEOMETRY%YRVERT_GEOM%YRCVER%LVERTFE) THEN

    DO JROF=YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA
      ZWT0 (JROF)=PEVEL (JROF, JLEV)*PRDELP (JROF, JLEV)
    ENDDO

  ELSE

    DO JROF=YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA
      ZWT0 (JROF)=0.5_JPRB*(PEVEL (JROF, JLEV)+PEVEL (JROF, JLEV-1))*PRDELP (JROF, JLEV)
    ENDDO

  ENDIF


  DO JROF=YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA
    ZMOY1T (JROF, JLEV)=PDTS2*PCMSLP*YDML_DYN%YRDYN%RCORDIF (JLEV)*YDVARS%U%T0 (JROF, JLEV)*POROGL&
    & (JROF)+PDTS2*PCMSLP*YDML_DYN%YRDYN%RCORDIF (JLEV)*YDVARS%V%T0 (JROF, JLEV)*POROGM (JROF)
  ENDDO


  DO JROF=YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA
    ZMOY1T (JROF, JLEV)=ZMOY1T (JROF, JLEV)+PDTS2*YDCPG_TND%TNDT (JROF, JLEV)+PDTS2*PCMSLP*(YDML_DYN%YRDYN&
    &%RCORDIH (JLEV)-YDML_DYN%YRDYN%RCORDIH (JLEV-1))*ZWT0 (JROF)*YDVARS%GEOMETRY%OROG%P (JROF)
  ENDDO

ENDDO


IF (YDML_DYN%YRDYNA%LTWOTL) THEN
  CALL LATTEX_DNT (YDCPG_OPTS%NSTEP, YDGEOMETRY, YDLDDH, YDML_GCONF%YRRIP, YDML_DYN%YRDYN,&
  & YDML_DYN%YRDYNA, YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA, YDML_DYN%YRDYNA%LSETTLS, YDML_DYN&
  &%YRDYN%NTLAG, PESGP, PESGM, YDVARS%T%T0, YDVARS%T%T9, ZMOY1T, PMIXNL, YDCPG_SL2%TSI, YDVARS&
  &%TNL%T9, YDVARS%T%T1, YDCPG_SL1%T0%P, YDCPG_SL1%T9%P, YDCPG_SL1%TF9%P, YDVARS%CTNL%T9, YDCPG_TNDSI_DDH&
  &%T%T0, YDCPG_TNDSI_DDH%T%T9, YDCPG_SL1%T9_SI%P, YDCPG_SL1%T9_NL%P)
ELSE

  DO JLEV=1, YDGEOMETRY%YRDIMV%NFLEVG

    DO JROF=YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA
      ZTSI9 (JROF, JLEV)=PBDT (JROF)*PTOD9 (JROF, JLEV)
    ENDDO

  ENDDO

  CALL LATTEX_TNT (YDGEOMETRY, YDLDDH, YDML_DYN%YRDYN, YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA, YDML_DYN&
  &%YRDYN%NTLAG, PESGP, PESGM, YDVARS%T%T9, ZMOY1T, ZTSI9, YDCPG_SL2%TSI, YDVARS%T%T1, YDCPG_SL1&
  &%T0%P, YDCPG_SL1%T9%P, YDCPG_SL1%TF9%P, YDCPG_TNDSI_DDH%T%T0, YDCPG_SL1%T9_SI%P)
ENDIF


DO JLEV=1, YDGEOMETRY%YRDIMV%NFLEVG

  DO JROF=YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA
    YDVARS%T%T1 (JROF, JLEV)=YDVARS%T%T1 (JROF, JLEV)-YDML_DYN%YRDYN&
    &%RCORDIF (JLEV)*PCMSLP*YDVARS%GEOMETRY%OROG%P (JROF)
  ENDDO


  IF (.NOT.LDCTC) THEN

    DO JROF=YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA
      YDCPG_SL1%T9%P (JROF, JLEV)=YDCPG_SL1%T9%P (JROF, JLEV)+YDML_DYN&
      &%YRDYN%RCORDIF (JLEV)*PCMSLP*YDVARS%GEOMETRY%OROG%P (JROF)
    ENDDO

  ENDIF

ENDDO


IF (YDML_DYN%YRDYNA%LNHDYN) THEN

  DO JLEV=1, YDGEOMETRY%YRDIMV%NFLEVG

    DO JROF=YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA
      YDCPG_SL2%PDSI (JROF, JLEV)=PBDT (JROF)*PSPDS0 (JROF, JLEV)
      ZMOY1SPD (JROF, JLEV)=PDTS2*YDCPG_TND%TNDPD (JROF, JLEV)
    ENDDO

  ENDDO


  IF (YDML_DYN%YRDYNA%LTWOTL) THEN
    CALL LATTEX_DNT (YDCPG_OPTS%NSTEP, YDGEOMETRY, YDLDDH, YDML_GCONF%YRRIP, YDML_DYN%YRDYN, YDML_DYN&
    &%YRDYNA, YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA, YDML_DYN%YRDYNA%LSETTLS, YDML_DYN%YRDYN%NSPDLAG&
    &, PESGP, PESGM, YDVARS%SPD%T0, YDVARS%SPD%T9, ZMOY1SPD, PMIXNL, YDCPG_SL2%PDSI, YDVARS%SPDNL&
    &%T9, YDVARS%SPD%T1, YDCPG_SL1%PD0%P, YDCPG_SL1%PD9%P, ZUSELESS, YDVARS%CSPDNL%T9, YDCPG_TNDSI_DDH&
    &%PD%T0, YDCPG_TNDSI_DDH%PD%T9, YDCPG_SL1%PD9_SI%P, YDCPG_SL1%PD9_NL%P)
  ELSE

    DO JLEV=1, YDGEOMETRY%YRDIMV%NFLEVG

      DO JROF=YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA
        ZSPDSI9 (JROF, JLEV)=PBDT (JROF)*PSPDS9 (JROF, JLEV)
      ENDDO

    ENDDO

    CALL LATTEX_TNT (YDGEOMETRY, YDLDDH, YDML_DYN%YRDYN, YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA, YDML_DYN&
    &%YRDYN%NSPDLAG, PESGP, PESGM, YDVARS%SPD%T9, ZMOY1SPD, ZSPDSI9, YDCPG_SL2%PDSI, YDVARS%SPD%T1&
    &, YDCPG_SL1%PD0%P, YDCPG_SL1%PD9%P, ZUSELESS, YDCPG_TNDSI_DDH%PD%T0, YDCPG_SL1%PD9_SI%P)
  ENDIF

ENDIF


IF (YDML_DYN%YRDYNA%LNHDYN.AND.(.NOT.YDML_DYN%YRDYNA%LGWADV)) THEN

  DO JLEV=1, YDGEOMETRY%YRDIMV%NFLEVG

    DO JROF=YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA
      YDCPG_SL2%VDSI (JROF, JLEV)=PBT*PLPD0 (JROF, JLEV)
      ZMOY1VWV (JROF, JLEV)=PDTS2*YDCPG_TND%TNDVD (JROF, JLEV)
    ENDDO

  ENDDO


  IF (YDML_DYN%YRDYNA%LTWOTL) THEN
    CALL LATTEX_DNT (YDCPG_OPTS%NSTEP, YDGEOMETRY, YDLDDH, YDML_GCONF%YRRIP, YDML_DYN%YRDYN, YDML_DYN&
    &%YRDYNA, YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA, YDML_DYN%YRDYNA%LSETTLS, YDML_DYN%YRDYN%NSVDLAG&
    &, PESGP, PESGM, YDVARS%SVD%T0, YDVARS%SVD%T9, ZMOY1VWV, PMIXNL, YDCPG_SL2%VDSI, YDVARS%VWVNL&
    &%T9, YDVARS%SVD%T1, YDCPG_SL1%VD0%P, YDCPG_SL1%VD9%P, YDCPG_SL1%VDF9%P, YDVARS%CVWVNL%T9, YDCPG_TNDSI_DDH&
    &%VD%T0, YDCPG_TNDSI_DDH%VD%T9, YDCPG_SL1%VD9_SI%P, YDCPG_SL1%VD9_NL%P)

    IF ((YDML_DYN%YRDYNA%NVDVAR==4.OR.YDML_DYN%YRDYNA%NVDVAR==5).AND.YDML_DYN%YRDYNA%ND4SYS==1) THEN

      IF (.NOT.LDCT) THEN

        IF (YDML_DYN%YRDYNA%LNESC.OR.(YDCPG_OPTS%NSTEP<=YDML_GCONF%YRRIP%NFOST)) THEN

          DO JLEV=1, YDGEOMETRY%YRDIMV%NFLEVG

            DO JROF=YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA
              YDVARS%SVD%T1 (JROF, JLEV)=YDVARS%SVD%T1 (JROF, JLEV)+PNHXT0 (JROF, JLEV)
              YDVARS%NHX%T1 (JROF, JLEV)=PNHXT0 (JROF, JLEV)
              YDCPG_SL1%VD9%P (JROF, JLEV)=YDCPG_SL1%VD9%P (JROF, JLEV)-PNHXT0 (JROF, JLEV)
              YDCPG_SL1%NHX9%P (JROF, JLEV)=0.0_JPRB
            ENDDO

          ENDDO

        ELSEIF (.NOT.YDML_DYN%YRDYNA%LNESC.AND.(YDCPG_OPTS%NSTEP>YDML_GCONF&
          &%YRRIP%NFOST).AND.YDML_DYN%YRDYNA%LSETTLS) THEN

          DO JLEV=1, YDGEOMETRY%YRDIMV%NFLEVG

            DO JROF=YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA
              YDVARS%SVD%T1 (JROF, JLEV)=YDVARS%SVD%T1 (JROF, JLEV)+PNHXT0 (JROF, JLEV)
              YDVARS%NHX%T1 (JROF, JLEV)=PNHXT0 (JROF, JLEV)
              YDCPG_SL1%VD9%P (JROF, JLEV)=YDCPG_SL1%VD9%P (JROF, JLEV)-YDVARS%NHX%T9 (JROF, JLEV)
              YDCPG_SL1%NHX9%P (JROF, JLEV)=PNHXT0 (JROF, JLEV)-YDVARS%NHX%T9 (JROF, JLEV)
            ENDDO

          ENDDO

        ELSE

          DO JLEV=1, YDGEOMETRY%YRDIMV%NFLEVG

            DO JROF=YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA
              YDVARS%SVD%T1 (JROF, JLEV)=YDVARS%SVD%T1 (JROF, JLEV)+1.5_JPRB&
              &*PNHXT0 (JROF, JLEV)-0.5_JPRB*YDVARS%NHX%T9 (JROF, JLEV)
              YDVARS%NHX%T1 (JROF, JLEV)=1.5_JPRB*PNHXT0 (JROF, JLEV)-0.5_JPRB*YDVARS%NHX%T9 (JROF, JLEV)
              YDCPG_SL1%VD9%P (JROF, JLEV)=YDCPG_SL1%VD9%P (JROF, JLEV)-0.5_JPRB&
              &*PNHXT0 (JROF, JLEV)-0.5_JPRB*YDVARS%NHX%T9 (JROF, JLEV)
              YDCPG_SL1%NHX9%P (JROF, JLEV)=0.5_JPRB*(PNHXT0 (JROF, JLEV)-YDVARS%NHX%T9 (JROF, JLEV))
            ENDDO

          ENDDO

        ENDIF

        YDVARS%NHX%T9 (YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA, 1:YDGEOMETRY%YRDIMV%NFLEVG&
        &)=PNHXT0 (YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA, 1:YDGEOMETRY%YRDIMV%NFLEVG)
      ELSE

        DO JLEV=1, YDGEOMETRY%YRDIMV%NFLEVG

          DO JROF=YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA
            YDVARS%SVD%T1 (JROF, JLEV)=YDVARS%SVD%T1 (JROF, JLEV)+PNHXT0 (JROF, JLEV)
            YDVARS%NHX%T1 (JROF, JLEV)=PNHXT0 (JROF, JLEV)
          ENDDO


          IF (.NOT.LDCTC) THEN

            DO JROF=YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA
              YDCPG_SL1%VD9%P (JROF, JLEV)=YDCPG_SL1%VD9%P (JROF, JLEV)-YDVARS%NHX%T9 (JROF, JLEV)
              YDCPG_SL1%NHX9%P (JROF, JLEV)=0.0_JPRB
            ENDDO

          ENDIF

        ENDDO

      ENDIF

    ELSEIF ((YDML_DYN%YRDYNA%NVDVAR==4.OR.YDML_DYN%YRDYNA%NVDVAR==5).AND.YDML_DYN%YRDYNA%ND4SYS==2) THEN

      IF (.NOT.LDCT) THEN

        DO JLEV=1, YDGEOMETRY%YRDIMV%NFLEVG

          DO JROF=YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA
            YDVARS%SVD%T1 (JROF, JLEV)=YDVARS%SVD%T1 (JROF, JLEV)+PNHXT0 (JROF, JLEV)
            YDVARS%NHX%T1 (JROF, JLEV)=PNHXT0 (JROF, JLEV)
            YDCPG_SL1%VD9%P (JROF, JLEV)=YDCPG_SL1%VD9%P (JROF, JLEV)-PNHXT0 (JROF, JLEV)
            YDCPG_SL1%NHX9%P (JROF, JLEV)=0.0_JPRB
          ENDDO

        ENDDO

        YDVARS%NHX%T9 (YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA, 1:YDGEOMETRY%YRDIMV%NFLEVG&
        &)=PNHXT0 (YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA, 1:YDGEOMETRY%YRDIMV%NFLEVG)
      ELSE

        DO JLEV=1, YDGEOMETRY%YRDIMV%NFLEVG

          DO JROF=YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA
            YDVARS%SVD%T1 (JROF, JLEV)=YDVARS%SVD%T1 (JROF, JLEV)+YDVARS%NHX%T9 (JROF, JLEV)
            YDVARS%NHX%T1 (JROF, JLEV)=PNHXT0 (JROF, JLEV)
          ENDDO


          IF (.NOT.LDCTC) THEN

            DO JROF=YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA
              YDCPG_SL1%VD9%P (JROF, JLEV)=YDCPG_SL1%VD9%P (JROF, JLEV)-YDVARS%NHX%T9 (JROF, JLEV)
              YDCPG_SL1%NHX9%P (JROF, JLEV)=0.0_JPRB
            ENDDO

          ENDIF

        ENDDO

      ENDIF

    ENDIF

  ELSE

    DO JLEV=1, YDGEOMETRY%YRDIMV%NFLEVG

      DO JROF=YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA
        ZVWVSI9 (JROF, JLEV)=PBT*PLPD9 (JROF, JLEV)
      ENDDO

    ENDDO

    CALL LATTEX_TNT (YDGEOMETRY, YDLDDH, YDML_DYN%YRDYN, YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA, YDML_DYN&
    &%YRDYN%NSVDLAG, PESGP, PESGM, YDVARS%SVD%T9, ZMOY1VWV, ZVWVSI9, YDCPG_SL2%VDSI, YDVARS%SVD%T1, YDCPG_SL1&
    &%VD0%P, YDCPG_SL1%VD9%P, YDCPG_SL1%VDF9%P, YDCPG_TNDSI_DDH%VD%T0, YDCPG_SL1%VD9_SI%P)

    IF ((YDML_DYN%YRDYNA%NVDVAR==4.OR.YDML_DYN%YRDYNA%NVDVAR==5).AND.YDML_DYN%YRDYNA%ND4SYS==1) THEN

      DO JLEV=1, YDGEOMETRY%YRDIMV%NFLEVG

        DO JROF=YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA
          YDVARS%SVD%T1 (JROF, JLEV)=YDVARS%SVD%T1 (JROF, JLEV)+PNHXT0 (JROF, JLEV)
          YDVARS%NHX%T1 (JROF, JLEV)=PNHXT0 (JROF, JLEV)
          YDCPG_SL1%VD9%P (JROF, JLEV)=YDCPG_SL1%VD9%P (JROF, JLEV&
          &)+PNHXT0 (JROF, JLEV)-2.0_JPRB*PNHXT9 (JROF, JLEV)
          YDCPG_SL1%NHX9%P (JROF, JLEV)=0.0_JPRB
        ENDDO

      ENDDO

    ELSEIF ((YDML_DYN%YRDYNA%NVDVAR==4.OR.YDML_DYN%YRDYNA%NVDVAR==5).AND.YDML_DYN%YRDYNA%ND4SYS==2) THEN

      DO JLEV=1, YDGEOMETRY%YRDIMV%NFLEVG

        DO JROF=YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA
          YDVARS%SVD%T1 (JROF, JLEV)=YDVARS%SVD%T1 (JROF, JLEV)+PNHXT9 (JROF, JLEV)
          YDVARS%NHX%T1 (JROF, JLEV)=PNHXT0 (JROF, JLEV)
          YDCPG_SL1%VD9%P (JROF, JLEV)=YDCPG_SL1%VD9%P (JROF, JLEV)-PNHXT9 (JROF, JLEV)
          YDCPG_SL1%NHX9%P (JROF, JLEV)=0.0_JPRB
        ENDDO

      ENDDO

    ENDIF

  ENDIF

ENDIF


IF (YDML_DYN%YRDYNA%LNHDYN.AND.YDML_DYN%YRDYNA%LGWADV) THEN

  DO JLEV=1, YDGEOMETRY%YRDIMV%NFLEVG

    DO JROF=YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA
      YDCPG_SL2%VDSI (JROF, JLEV)=PBT*PLPD0 (JROF, JLEV)
      ZMOY1VWV (JROF, JLEV)=PDTS2*YDCPG_TND%TNDGW (JROF, JLEV)
    ENDDO

  ENDDO


  IF (YDML_DYN%YRDYNA%LTWOTL) THEN

    IF (YDML_DYN%YRDYNA%LPC_FULL.AND.YDML_DYN%YRDYN%NCURRENT_ITER==0) THEN
      YDVARS%GW%T9 (YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA, 1:YDGEOMETRY%YRDIMV%NFLEVG&
      &)=PGWT0 (YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA, 1:YDGEOMETRY%YRDIMV%NFLEVG)
    ENDIF

    CALL LATTEX_DNT (YDCPG_OPTS%NSTEP, YDGEOMETRY, YDLDDH, YDML_GCONF%YRRIP, YDML_DYN%YRDYN, YDML_DYN&
    &%YRDYNA, YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA, YDML_DYN%YRDYNA%LSETTLS, YDML_DYN%YRDYN%NSVDLAG&
    &, PESGP, PESGM, PGWT0, YDVARS%GW%T9, ZMOY1VWV, PMIXNL, YDCPG_SL2%VDSI, YDVARS%VWVNL%T9, YDVARS&
    &%SVD%T1, YDCPG_SL1%VD0%P, YDCPG_SL1%VD9%P, YDCPG_SL1%VDF9%P, YDVARS%CVWVNL%T9, YDCPG_TNDSI_DDH&
    &%VD%T0, YDCPG_TNDSI_DDH%VD%T9, YDCPG_SL1%VD9_SI%P, YDCPG_SL1%VD9_NL%P)

    IF ((YDML_DYN%YRDYNA%NVDVAR==4.OR.YDML_DYN%YRDYNA%NVDVAR==5).AND.YDML_DYN%YRDYNA%ND4SYS==2) THEN

      IF (.NOT.LDCT) THEN

        DO JLEV=1, YDGEOMETRY%YRDIMV%NFLEVG
          YDCPG_SL1%NHX9%P (YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA, JLEV&
          &)=PNHXT0 (YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA, JLEV)
        ENDDO

        YDVARS%NHX%T9 (YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA, 1:YDGEOMETRY%YRDIMV%NFLEVG&
        &)=PNHXT0 (YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA, 1:YDGEOMETRY%YRDIMV%NFLEVG)
      ELSE

        DO JLEV=1, YDGEOMETRY%YRDIMV%NFLEVG
          YDCPG_SL1%NHX9%P (YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA, JLEV)=YDVARS&
          &%NHX%T9 (YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA, JLEV)
        ENDDO

      ENDIF

    ENDIF

  ELSE

    DO JLEV=1, YDGEOMETRY%YRDIMV%NFLEVG

      DO JROF=YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA
        ZVWVSI9 (JROF, JLEV)=PBT*PLPD9 (JROF, JLEV)
      ENDDO

    ENDDO

    CALL LATTEX_TNT (YDGEOMETRY, YDLDDH, YDML_DYN%YRDYN, YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA, YDML_DYN&
    &%YRDYN%NSVDLAG, PESGP, PESGM, PGWT9, ZMOY1VWV, ZVWVSI9, YDCPG_SL2%VDSI, YDVARS%SVD%T1, YDCPG_SL1&
    &%VD0%P, YDCPG_SL1%VD9%P, YDCPG_SL1%VDF9%P, YDCPG_TNDSI_DDH%VD%T0, YDCPG_SL1%VD9_SI%P)

    IF ((YDML_DYN%YRDYNA%NVDVAR==4.OR.YDML_DYN%YRDYNA%NVDVAR==5).AND.YDML_DYN%YRDYNA%ND4SYS==2) THEN

      DO JLEV=1, YDGEOMETRY%YRDIMV%NFLEVG
        YDCPG_SL1%NHX9%P (YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA, JLEV&
        &)=PNHXT9 (YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA, JLEV)
      ENDDO

    ENDIF

  ENDIF

ENDIF

IF (LHOOK) CALL DR_HOOK ('LATTEX_MAIN', 1, ZHOOK_HANDLE)
ENDSUBROUTINE
