#ifdef RS6K
@PROCESS NOCHECK
#endif
SUBROUTINE LARCINB (YDGEOMETRY, YDVARS, YDLDDH, YDMDDH, YDML_GCONF, YDML_DYN, YDCPG_OPTS&
&, YDCPG_BNDS, KASLB1, KHVI, LDSLPHY, LD2TLFF1, KL0, KLH0, PLSCAW, PRSCAW, YDCPG_SL1, KNOWENO&
&, YDCPG_DDH_TND, YDCPG_GMVF, YDCPG_GMVF_SI, YDCPG_GMVF_NL, YDCPG_GFLF, PDP, PCF, PCF_SI&
&, PCF_NL, PUFZ, PVFZ, PUPF, PVPF, PTPF, YDCPG_GFLPF, PDBBCF, PDPHIF, PGWSF)
USE MODEL_DYNAMICS_MOD,ONLY:MODEL_DYNAMICS_TYPE
USE MODEL_GENERAL_CONF_MOD,ONLY:MODEL_GENERAL_CONF_TYPE
USE GEOMETRY_MOD,ONLY:GEOMETRY
USE PARKIND1,ONLY:JPIM, JPRB
USE YOMHOOK,ONLY:LHOOK, DR_HOOK, JPHOOK
USE YOMLDDH,ONLY:TLDDH
USE YOMMDDH,ONLY:TMDDH
USE FIELD_VARIABLES_MOD,ONLY:FIELD_VARIABLES
USE CPG_SL1_TYPE_MOD,ONLY:CPG_SL1F_TYPE
USE CPG_DDH_TND_TYPE_MOD,ONLY:CPG_DDH_TND_TYPE
USE CPG_GMV_TYPE_MOD,ONLY:CPG_GMV_TYPE
USE CPG_GFL_TYPE_MOD,ONLY:CPG_GFL_TYPE, CPG_GFLSL_TYPE
USE CPG_OPTS_TYPE_MOD,ONLY:CPG_OPTS_TYPE, CPG_BNDS_TYPE

IMPLICIT NONE


TYPE (GEOMETRY), INTENT (IN)::YDGEOMETRY
TYPE (FIELD_VARIABLES), INTENT (INOUT)::YDVARS
TYPE (TLDDH), INTENT (IN)::YDLDDH
TYPE (TMDDH), INTENT (IN)::YDMDDH
TYPE (MODEL_DYNAMICS_TYPE), INTENT (IN)::YDML_DYN
TYPE (MODEL_GENERAL_CONF_TYPE), INTENT (IN)::YDML_GCONF
INTEGER (KIND=JPIM), INTENT (IN)::KHVI
TYPE (CPG_OPTS_TYPE), INTENT (IN)::YDCPG_OPTS
TYPE (CPG_BNDS_TYPE), INTENT (IN)::YDCPG_BNDS
INTEGER (KIND=JPIM), INTENT (IN)::KASLB1
LOGICAL, INTENT (IN)::LDSLPHY
LOGICAL, INTENT (IN)::LD2TLFF1
INTEGER (KIND=JPIM), INTENT (IN)::KL0 (YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY%YRDIMV%NFLEVG, 0:3)
INTEGER (KIND=JPIM), INTENT (IN)::KLH0 (YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY%YRDIMV%NFLEVG, 0:3)
REAL (KIND=JPRB), INTENT (IN)::PLSCAW (YDGEOMETRY%YRDIM%NPROMA&
&, YDGEOMETRY%YRDIMV%NFLEVG, YDML_DYN%YYTLSCAW%NDIM)
REAL (KIND=JPRB), INTENT (IN)::PRSCAW (YDGEOMETRY%YRDIM%NPROMA&
&, YDGEOMETRY%YRDIMV%NFLEVG, YDML_DYN%YYTRSCAW%NDIM)
TYPE (CPG_SL1F_TYPE), INTENT (IN)::YDCPG_SL1
INTEGER (KIND=JPIM), INTENT (IN)::KNOWENO (YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY%YRDIMV%NFLEVG)
TYPE (CPG_DDH_TND_TYPE), INTENT (INOUT)::YDCPG_DDH_TND
TYPE (CPG_GMV_TYPE), INTENT (INOUT)::YDCPG_GMVF
TYPE (CPG_GMV_TYPE), INTENT (INOUT)::YDCPG_GMVF_SI
TYPE (CPG_GMV_TYPE), INTENT (INOUT)::YDCPG_GMVF_NL
TYPE (CPG_GFL_TYPE), INTENT (INOUT)::YDCPG_GFLF
REAL (KIND=JPRB), INTENT (OUT)::PDP (YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB), INTENT (OUT)::PCF (YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB), INTENT (OUT)::PCF_SI (YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB), INTENT (OUT)::PCF_NL (YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB), INTENT (OUT)::PUFZ (YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB), INTENT (OUT)::PVFZ (YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB), INTENT (OUT)::PUPF (YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB), INTENT (OUT)::PVPF (YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB), INTENT (OUT)::PTPF (YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY%YRDIMV%NFLEVG)
TYPE (CPG_GFLSL_TYPE), INTENT (INOUT)::YDCPG_GFLPF
REAL (KIND=JPRB), INTENT (OUT)::PDBBCF (YDGEOMETRY%YRDIM%NPROMA)
REAL (KIND=JPRB), INTENT (OUT)::PDPHIF (YDGEOMETRY%YRDIM%NPROMA)
REAL (KIND=JPRB), INTENT (OUT)::PGWSF (YDGEOMETRY%YRDIM%NPROMA)
REAL (KIND=JPRB)::ZGMVF (YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB)::ZGMVU (YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB)::ZGMVV (YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB)::ZGMVZ (YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB)::ZGMVFU (YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB)::ZGMVFV (YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB)::ZGMVFZ (YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY%YRDIMV%NFLEVG)

INTEGER (KIND=JPIM)::IFLDX
INTEGER (KIND=JPIM)::IFLDN
INTEGER (KIND=JPIM)::IPSPL
INTEGER (KIND=JPIM)::IP
INTEGER (KIND=JPIM)::JFLD
INTEGER (KIND=JPIM)::JROF
INTEGER (KIND=JPIM)::JLEV
INTEGER (KIND=JPIM)::ICLA
INTEGER (KIND=JPIM)::ICLO
INTEGER (KIND=JPIM)::IDLO
INTEGER (KIND=JPIM)::IQM
INTEGER (KIND=JPIM)::IWKGFL
INTEGER (KIND=JPIM)::IWKH
INTEGER (KIND=JPIM)::IWKM
INTEGER (KIND=JPIM)::IWNT
INTEGER (KIND=JPIM)::IWK
CHARACTER (LEN=12)::CLINT
LOGICAL::LLCOMAD
LOGICAL::LLHOI2
LOGICAL::LLNOSLHD
LOGICAL::LL_LIN
LOGICAL::LLMOM
LOGICAL::LL3
LOGICAL::LL2
LOGICAL::LL1
#include "laitlif.intfb.h"
#include "larcinb_lcomad_sp.intfb.h"
#include "larcinb_nqmgmv.intfb.h"
#include "larcinb_nvlag_3.intfb.h"
#include "larcinb_nvlag_2.intfb.h"
#include "larcinb_llcomad_2.intfb.h"
#include "larcinb_llcomad.intfb.h"
#include "larcinb_ltdiablin.intfb.h"
#include "larcinb_rrintopt.intfb.h"
#include "larcinb_laitre_gfl.intfb.h"
#include "larcinb_laitvspcqm.intfb.h"
#include "larcinb_lin.intfb.h"
#include "larcinb_ldslphy.intfb.h"
#include "larcinb_ntlag_3.intfb.h"
#include "larcinb_laitre_gmv.intfb.h"
#include "larcinb_lrhs_curv_f.intfb.h"
#include "laiddi.intfb.h"

#include "laitre_gmv.intfb.h"

#include "cart2local.intfb.h"
#include "abor1.intfb.h"
REAL (KIND=JPHOOK)::ZHOOK_HANDLE
IF (LHOOK) CALL DR_HOOK ('LARCINB', 0, ZHOOK_HANDLE)


LLNOSLHD=.FALSE.
IWNT=1
IWKGFL=1

IF (YDML_DYN%YRDYNA%L3DTURB) THEN
  IWKM=2
  IWKH=3
ELSE
  IWKM=1
  IWKH=1
ENDIF


IF (YDML_DYN%YRDYNA%LPC_FULL.AND.YDML_DYN%YRDYNA%LPC_CHEAP2.AND&
  &.(YDML_DYN%YRDYN%NCURRENT_ITER<YDML_DYN%YRDYN%NSITER)) THEN
  LL_LIN=.TRUE.
ELSE
  LL_LIN=YDML_DYN%YRDYNA%NQMGMV==-4
ENDIF

IFLDN=YDGEOMETRY%YRDIMV%NFLSA
IFLDX=YDGEOMETRY%YRDIMV%NFLEN

IF (YDML_DYN%YRDYN%LRHS_CURV) THEN
  
  LLMOM=.TRUE.
  CALL LAITRE_GMV (YDML_DYN, KASLB1, YDGEOMETRY%YRDIM%NPROMA, YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA, YDGEOMETRY&
  &%YRDIMV%NFLEVG, YDGEOMETRY%YRDIMV%NFLSA, YDGEOMETRY%YRDIMV%NFLEN, IWKM, LL_LIN, YDML_DYN%YRDYNA%LCOMAD_W&
  &, YDML_DYN%YRDYNA%LSLHD_W, YDML_DYN%YRDYN%LVWENO_W, YDML_DYN%YRDYN%WENO_ALPHA_W, LLMOM, YDML_DYN%YRDYN&
  &%LQMW, YDML_DYN%YRDYN%LQMHW, KNOWENO, KL0, PLSCAW, PRSCAW, YDCPG_SL1%U9%P, ZGMVU)
  CALL LAITRE_GMV (YDML_DYN, KASLB1, YDGEOMETRY%YRDIM%NPROMA, YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA, YDGEOMETRY&
  &%YRDIMV%NFLEVG, YDGEOMETRY%YRDIMV%NFLSA, YDGEOMETRY%YRDIMV%NFLEN, IWKM, LL_LIN, YDML_DYN%YRDYNA%LCOMAD_W&
  &, YDML_DYN%YRDYNA%LSLHD_W, YDML_DYN%YRDYN%LVWENO_W, YDML_DYN%YRDYN%WENO_ALPHA_W, LLMOM, YDML_DYN%YRDYN&
  &%LQMW, YDML_DYN%YRDYN%LQMHW, KNOWENO, KL0, PLSCAW, PRSCAW, YDCPG_SL1%V9%P, ZGMVV)
  CALL LAITRE_GMV (YDML_DYN, KASLB1, YDGEOMETRY%YRDIM%NPROMA, YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA, YDGEOMETRY&
  &%YRDIMV%NFLEVG, YDGEOMETRY%YRDIMV%NFLSA, YDGEOMETRY%YRDIMV%NFLEN, IWKM, LL_LIN, YDML_DYN%YRDYNA%LCOMAD_W&
  &, YDML_DYN%YRDYNA%LSLHD_W, YDML_DYN%YRDYN%LVWENO_W, YDML_DYN%YRDYN%WENO_ALPHA_W, LLMOM, YDML_DYN%YRDYN&
  &%LQMW, YDML_DYN%YRDYN%LQMHW, KNOWENO, KL0, PLSCAW, PRSCAW, YDCPG_SL1%Z9%P, ZGMVZ)

  IF (YDML_DYN%YRDYN%NWLAG>=3) THEN

    IF (LD2TLFF1) THEN
      CALL LAITRE_GMV (YDML_DYN, KASLB1, YDGEOMETRY%YRDIM%NPROMA, YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA, YDGEOMETRY&
      &%YRDIMV%NFLEVG, YDGEOMETRY%YRDIMV%NFLSA, YDGEOMETRY%YRDIMV%NFLEN, IWKM, LL_LIN, YDML_DYN%YRDYNA%LCOMAD_W&
      &, YDML_DYN%YRDYNA%LSLHD_W, YDML_DYN%YRDYN%LVWENO_W, YDML_DYN%YRDYN%WENO_ALPHA_W, LLMOM, YDML_DYN%YRDYN&
      &%LQMW, YDML_DYN%YRDYN%LQMHW, KNOWENO, KL0, PLSCAW, PRSCAW, YDCPG_SL1%UR9%P, ZGMVFU)
      CALL LAITRE_GMV (YDML_DYN, KASLB1, YDGEOMETRY%YRDIM%NPROMA, YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA, YDGEOMETRY&
      &%YRDIMV%NFLEVG, YDGEOMETRY%YRDIMV%NFLSA, YDGEOMETRY%YRDIMV%NFLEN, IWKM, LL_LIN, YDML_DYN%YRDYNA%LCOMAD_W&
      &, YDML_DYN%YRDYNA%LSLHD_W, YDML_DYN%YRDYN%LVWENO_W, YDML_DYN%YRDYN%WENO_ALPHA_W, LLMOM, YDML_DYN%YRDYN&
      &%LQMW, YDML_DYN%YRDYN%LQMHW, KNOWENO, KL0, PLSCAW, PRSCAW, YDCPG_SL1%VR9%P, ZGMVFV)
      CALL LAITRE_GMV (YDML_DYN, KASLB1, YDGEOMETRY%YRDIM%NPROMA, YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA, YDGEOMETRY&
      &%YRDIMV%NFLEVG, YDGEOMETRY%YRDIMV%NFLSA, YDGEOMETRY%YRDIMV%NFLEN, IWKM, LL_LIN, YDML_DYN%YRDYNA%LCOMAD_W&
      &, YDML_DYN%YRDYNA%LSLHD_W, YDML_DYN%YRDYN%LVWENO_W, YDML_DYN%YRDYN%WENO_ALPHA_W, LLMOM, YDML_DYN%YRDYN&
      &%LQMW, YDML_DYN%YRDYN%LQMHW, KNOWENO, KL0, PLSCAW, PRSCAW, YDCPG_SL1%ZR9%P, ZGMVFZ)
      CALL CART2LOCAL (YDGEOMETRY%YRDIMV%NFLEVG, YDGEOMETRY%YRDIM%NPROMA, YDCPG_BNDS%KIDIA&
      &, YDCPG_BNDS%KFDIA, YDVARS%GEOMETRY%GEMU%P, YDVARS%GEOMETRY%GSQM2%P, YDVARS%GEOMETRY&
      &%GECLO%P, YDVARS%GEOMETRY%GESLO%P, ZGMVFU, ZGMVFV, ZGMVFZ, PUFZ, PVFZ)
    ELSE
      CALL CART2LOCAL (YDGEOMETRY%YRDIMV%NFLEVG, YDGEOMETRY%YRDIM%NPROMA, YDCPG_BNDS%KIDIA&
      &, YDCPG_BNDS%KFDIA, YDVARS%GEOMETRY%GEMU%P, YDVARS%GEOMETRY%GSQM2%P, YDVARS%GEOMETRY&
      &%GECLO%P, YDVARS%GEOMETRY%GESLO%P, ZGMVU, ZGMVV, ZGMVZ, PUFZ, PVFZ)
    ENDIF

    CALL LAITLIF (YDML_DYN%YYTLSCAW, KASLB1, YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY&
    &%YRDIMV%NFLEVG, YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA, KL0, YDML_DYN%YRDYNA&
    &%LCOMAD_W, PLSCAW, YDCPG_SL1%U0%P, ZGMVU, LDADD=.TRUE.)
    CALL LAITLIF (YDML_DYN%YYTLSCAW, KASLB1, YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY&
    &%YRDIMV%NFLEVG, YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA, KL0, YDML_DYN%YRDYNA&
    &%LCOMAD_W, PLSCAW, YDCPG_SL1%V0%P, ZGMVV, LDADD=.TRUE.)
    CALL LAITLIF (YDML_DYN%YYTLSCAW, KASLB1, YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY&
    &%YRDIMV%NFLEVG, YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA, KL0, YDML_DYN%YRDYNA&
    &%LCOMAD_W, PLSCAW, YDCPG_SL1%Z0%P, ZGMVZ, LDADD=.TRUE.)

    IF (YDML_DYN%YRDYNA%LSETTLS.AND.YDML_DYN%YRDYNA%LPC_CHEAP.AND.YDML_DYN%YRDYN%NCURRENT_ITER==0) THEN
      CALL ABOR1 (' LARCINB: LRHS_CURV is not yet coded for LPC_CHEAP')
    ENDIF

  ENDIF

  CALL CART2LOCAL (YDGEOMETRY%YRDIMV%NFLEVG, YDGEOMETRY%YRDIM%NPROMA, YDCPG_BNDS%KIDIA, YDCPG_BNDS&
  &%KFDIA, YDVARS%GEOMETRY%GEMU%P, YDVARS%GEOMETRY%GSQM2%P, YDVARS%GEOMETRY%GECLO%P, YDVARS&
  &%GEOMETRY%GESLO%P, ZGMVU, ZGMVV, ZGMVZ, YDCPG_GMVF%U%P, YDCPG_GMVF%V%P)

  IF (LDSLPHY) THEN
    CALL LAITLIF (YDML_DYN%YYTLSCAW, KASLB1, YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY%YRDIMV%NFLEVG, YDCPG_BNDS&
    &%KIDIA, YDCPG_BNDS%KFDIA, KL0, YDML_DYN%YRDYNA%LCOMAD_W, PLSCAW, YDCPG_SL1%UP9%P, ZGMVU)
    CALL LAITLIF (YDML_DYN%YYTLSCAW, KASLB1, YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY%YRDIMV%NFLEVG, YDCPG_BNDS&
    &%KIDIA, YDCPG_BNDS%KFDIA, KL0, YDML_DYN%YRDYNA%LCOMAD_W, PLSCAW, YDCPG_SL1%VP9%P, ZGMVV)
    CALL LAITLIF (YDML_DYN%YYTLSCAW, KASLB1, YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY%YRDIMV%NFLEVG, YDCPG_BNDS&
    &%KIDIA, YDCPG_BNDS%KFDIA, KL0, YDML_DYN%YRDYNA%LCOMAD_W, PLSCAW, YDCPG_SL1%ZP9%P, ZGMVZ)
    CALL CART2LOCAL (YDGEOMETRY%YRDIMV%NFLEVG, YDGEOMETRY%YRDIM%NPROMA, YDCPG_BNDS%KIDIA&
    &, YDCPG_BNDS%KFDIA, YDVARS%GEOMETRY%GEMU%P, YDVARS%GEOMETRY%GSQM2%P, YDVARS%GEOMETRY&
    &%GECLO%P, YDVARS%GEOMETRY%GESLO%P, ZGMVU, ZGMVV, ZGMVZ, PUPF, PVPF)
  ENDIF

  
ELSE
  CALL LARCINB_LRHS_CURV_F (LD2TLFF1, LDSLPHY, LLHOI2, LLMOM, LLNOSLHD, LL_LIN, IWK, IWKM,&
  & KASLB1, YDCPG_BNDS, YDCPG_DDH_TND, YDCPG_GMVF, YDCPG_GMVF_NL, YDCPG_GMVF_SI, YDCPG_SL1&
  &, YDGEOMETRY, YDLDDH, YDML_DYN, KL0, KNOWENO, PLSCAW, PRSCAW, PUFZ, PUPF, PVFZ, PVPF)
ENDIF

LLMOM=.NOT.YDML_DYN%YRDYN%LSLHDHEAT
CALL LARCINB_LAITRE_GMV (LLHOI2, LLMOM, LLNOSLHD, LL_LIN, IWK, IWKH, KASLB1, YDCPG_BNDS, YDCPG_DDH_TND&
&, YDCPG_GMVF, YDCPG_SL1, YDGEOMETRY, YDLDDH, YDML_DYN, KL0, KNOWENO, PLSCAW, PRSCAW)

IF (YDML_DYN%YRDYN%NTLAG>=3) THEN
  CALL LARCINB_NTLAG_3 (KASLB1, YDCPG_BNDS, YDCPG_DDH_TND, YDCPG_GMVF, YDCPG_GMVF_NL&
  &, YDCPG_GMVF_SI, YDCPG_SL1, YDGEOMETRY, YDLDDH, YDML_DYN, KL0, PLSCAW)
ENDIF


IF (LDSLPHY) THEN
  CALL LARCINB_LDSLPHY (KASLB1, YDCPG_BNDS, YDCPG_SL1, YDGEOMETRY, YDML_DYN, KL0, PLSCAW, PTPF)
ENDIF


IF (YDML_DYN%YRDYNA%LNHDYN) THEN
  
  LLMOM=.TRUE.
  CALL LAITRE_GMV (YDML_DYN, KASLB1, YDGEOMETRY%YRDIM%NPROMA, YDCPG_BNDS%KIDIA, YDCPG_BNDS&
  &%KFDIA, YDGEOMETRY%YRDIMV%NFLEVG, YDGEOMETRY%YRDIMV%NFLSA, YDGEOMETRY%YRDIMV%NFLEN, IWNT&
  &, LL_LIN, YDML_DYN%YRDYNA%LCOMAD_SPD, YDML_DYN%YRDYNA%LSLHD_SPD, YDML_DYN%YRDYN%LVWENO_SPD&
  &, YDML_DYN%YRDYN%WENO_ALPHA_SPD, LLMOM, YDML_DYN%YRDYN%LQMPD, YDML_DYN%YRDYN%LQMHPD,&
  & KNOWENO, KL0, PLSCAW, PRSCAW, YDCPG_SL1%PD9%P, YDCPG_GMVF%SPD%P)

  IF (YDML_DYN%YRDYN%NSPDLAG==3) THEN
    CALL LAITLIF (YDML_DYN%YYTLSCAW, KASLB1, YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY&
    &%YRDIMV%NFLEVG, YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA, KL0, YDML_DYN%YRDYNA%LCOMAD_SPD&
    &, PLSCAW, YDCPG_SL1%PD0%P, YDCPG_GMVF%SPD%P, LDADD=.TRUE.)

    IF (YDLDDH%LRSIDDH) THEN
      CALL LAITLIF (YDML_DYN%YYTLSCAW, KASLB1, YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY%YRDIMV&
      &%NFLEVG, YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA, KL0, YDML_DYN%YRDYNA%LCOMAD_SPD&
      &, PLSCAW, YDCPG_SL1%PD9_SI%P, YDCPG_DDH_TND%YSI%PD%T0, LDADD=.TRUE.)
    ENDIF


    IF (YDML_DYN%YRDYNA%LSLINL.AND.YDML_DYN%YRDYN%NCURRENT_ITER==0) THEN
      CALL LAITLIF (YDML_DYN%YYTLSCAW, KASLB1, YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY&
      &%YRDIMV%NFLEVG, YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA, KL0, YDML_DYN%YRDYNA&
      &%LCOMAD_SPD, PLSCAW, YDCPG_SL1%PD9_SI%P, YDCPG_GMVF_SI%SPD%P)
    ENDIF


    IF (YDML_DYN%YRDYNA%LSETTLS.AND.YDML_DYN%YRDYNA%LPC_CHEAP.AND.YDML_DYN%YRDYN%NCURRENT_ITER==0) THEN
      CALL LAITLIF (YDML_DYN%YYTLSCAW, KASLB1, YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY&
      &%YRDIMV%NFLEVG, YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA, KL0, YDML_DYN%YRDYNA&
      &%LCOMAD_SPD, PLSCAW, YDCPG_SL1%PD9_NL%P, YDCPG_GMVF_NL%SPD%P)
    ENDIF

  ENDIF

  
ENDIF


IF (YDML_DYN%YRDYNA%LNHDYN) THEN
  
  LLMOM=.TRUE.
  LL1=.NOT.YDML_DYN%YRDYNA%LGWADV
  LL2=YDGEOMETRY%YRVERT_GEOM%YRCVER%LVFE_GW
  LL3=YDML_DYN%YRDYNA%ND4SYS==2.AND.YDML_DYN%YRDYN%NCURRENT_ITER<YDML_DYN%YRDYN%NSITER

  IF (LL1.OR.LL2) THEN
    CALL LAITRE_GMV (YDML_DYN, KASLB1, YDGEOMETRY%YRDIM%NPROMA, YDCPG_BNDS%KIDIA, YDCPG_BNDS&
    &%KFDIA, YDGEOMETRY%YRDIMV%NFLEVG, YDGEOMETRY%YRDIMV%NFLSA, YDGEOMETRY%YRDIMV%NFLEN, IWKM&
    &, LL_LIN, YDML_DYN%YRDYNA%LCOMAD_SVD, YDML_DYN%YRDYNA%LSLHD_SVD, YDML_DYN%YRDYN%LVWENO_SVD&
    &, YDML_DYN%YRDYN%WENO_ALPHA_SVD, LLMOM, YDML_DYN%YRDYN%LQMVD, YDML_DYN%YRDYN%LQMHVD,&
    & KNOWENO, KL0, PLSCAW, PRSCAW, YDCPG_SL1%VD9%P, YDCPG_GMVF%SVD%P)
  ENDIF


  IF (YDLDDH%LRSLDDH) THEN

    DO JLEV=1, YDGEOMETRY%YRDIMV%NFLEVG

      DO JROF=YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA
        YDCPG_DDH_TND%YSL%VD%P (JROF, JLEV)=YDCPG_DDH_TND%YSL&
        &%VD%P (JROF, JLEV)+YDCPG_GMVF%SVD%P (JROF, JLEV)
      ENDDO

    ENDDO

  ENDIF


  IF ((YDML_DYN%YRDYN%NSPLTHOI/=0).AND.(YDML_DYN%YRDYN%NSVDLAG<4)) THEN

    IF (YDML_DYN%YRDYN%NSPLTHOI==1) THEN
      LLHOI2=LLNOSLHD
      IWK=YDML_DYN%YRDYN%NSLDIMK
    ELSE
      LLHOI2=YDML_DYN%YRDYNA%LSLHD_SVD
      IWK=IWKM
    ENDIF

    CALL LAITRE_GMV (YDML_DYN, KASLB1, YDGEOMETRY%YRDIM%NPROMA, YDCPG_BNDS%KIDIA, YDCPG_BNDS&
    &%KFDIA, YDGEOMETRY%YRDIMV%NFLEVG, YDGEOMETRY%YRDIMV%NFLSA, YDGEOMETRY%YRDIMV%NFLEN,&
    & IWK, LL_LIN, YDML_DYN%YRDYNA%LCOMAD_SVD, LLHOI2, YDML_DYN%YRDYN%LVWENO_SVD, YDML_DYN&
    &%YRDYN%WENO_ALPHA_SVD, LLMOM, YDML_DYN%YRDYN%LQMVD, YDML_DYN%YRDYN%LQMHVD, KNOWENO,&
    & KL0, PLSCAW, PRSCAW, YDCPG_SL1%VDF9%P, YDCPG_GMVF%SVD%P, LDADD=.TRUE.)
  ENDIF


  IF ((LL1.OR.LL3).AND.(YDML_DYN%YRDYNA%NVDVAR==4.OR.YDML_DYN%YRDYNA%NVDVAR==5)) THEN
    CALL LAITRE_GMV (YDML_DYN, KASLB1, YDGEOMETRY%YRDIM%NPROMA, YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA, YDGEOMETRY&
    &%YRDIMV%NFLEVG, YDGEOMETRY%YRDIMV%NFLSA, YDGEOMETRY%YRDIMV%NFLEN, IWNT, LL_LIN, YDML_DYN%YRDYNA%LCOMAD_SVD&
    &, LLNOSLHD, YDML_DYN%YRDYN%LVWENO_SVD, YDML_DYN%YRDYN%WENO_ALPHA_SVD, LLMOM, YDML_DYN%YRDYN%LQMVD, YDML_DYN&
    &%YRDYN%LQMHVD, KNOWENO, KL0, PLSCAW, PRSCAW, YDCPG_SL1%NHX9%P, YDCPG_GMVF%NHX%P)

    IF (YDLDDH%LRSLDDH) THEN

      DO JLEV=1, YDGEOMETRY%YRDIMV%NFLEVG

        DO JROF=YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA
          YDCPG_DDH_TND%YSL%NHX%P (JROF, JLEV)=YDCPG_DDH_TND%YSL&
          &%NHX%P (JROF, JLEV)+YDCPG_GMVF%NHX%P (JROF, JLEV)
        ENDDO

      ENDDO

    ENDIF

  ENDIF


  IF (YDML_DYN%YRDYN%NSVDLAG>=3) THEN

    IF (LL1.OR.LL2) THEN
      CALL LAITLIF (YDML_DYN%YYTLSCAW, KASLB1, YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY&
      &%YRDIMV%NFLEVG, YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA, KL0, YDML_DYN%YRDYNA%LCOMAD_SVD&
      &, PLSCAW, YDCPG_SL1%VD0%P, YDCPG_GMVF%SVD%P, LDADD=.TRUE.)

      IF (YDML_DYN%YRDYNA%LSETTLS.AND.YDML_DYN%YRDYNA%LPC_CHEAP.AND.YDML_DYN%YRDYN%NCURRENT_ITER==0) THEN
        CALL LAITLIF (YDML_DYN%YYTLSCAW, KASLB1, YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY&
        &%YRDIMV%NFLEVG, YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA, KL0, YDML_DYN%YRDYNA&
        &%LCOMAD_SVD, PLSCAW, YDCPG_SL1%VD9_NL%P, YDCPG_GMVF_NL%SVD%P)
      ENDIF

    ENDIF


    IF (YDLDDH%LRSIDDH) THEN
      CALL LAITLIF (YDML_DYN%YYTLSCAW, KASLB1, YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY%YRDIMV&
      &%NFLEVG, YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA, KL0, YDML_DYN%YRDYNA%LCOMAD_SVD&
      &, PLSCAW, YDCPG_SL1%VD9_SI%P, YDCPG_DDH_TND%YSI%VD%T0, LDADD=.TRUE.)
    ENDIF


    IF (YDML_DYN%YRDYNA%LSLINL.AND.YDML_DYN%YRDYN%NCURRENT_ITER==0) THEN
      CALL LAITLIF (YDML_DYN%YYTLSCAW, KASLB1, YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY&
      &%YRDIMV%NFLEVG, YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA, KL0, YDML_DYN%YRDYNA&
      &%LCOMAD_SVD, PLSCAW, YDCPG_SL1%VD9_SI%P, YDCPG_GMVF_SI%SVD%P)
    ENDIF

  ENDIF

  
ENDIF


DO JFLD=1, SIZE (YDVARS%GFL_PTR)

  IF (YDVARS%GFL_PTR (JFLD)%YCOMP%LADV.AND.(.NOT.YDVARS%GFL_PTR (JFLD)%YCOMP%LMGRID)) THEN
    LLMOM=TRIM (YDVARS%GFL_PTR (JFLD)%YCOMP%CNAME)=='TKE'.OR..NOT.YDML_DYN%YRDYN%LSLHDHEAT

    IF (YDML_DYN%YRDYNA%L3DTURB.AND.YDVARS%GFL_PTR (JFLD)%YCOMP%LHORTURB) THEN
      IWKGFL=IWKH

      IF (TRIM (YDVARS%GFL_PTR (JFLD)%YCOMP%CNAME)=='TKE')  THEN
        IWKGFL=IWKM
      ENDIF

    ELSE
      IWKGFL=1
    ENDIF


    IF (YDVARS%GFL_PTR (JFLD)%YCOMP%CSLINT (1:3)=="LIN") THEN
      CALL LARCINB_LIN (LLCOMAD, JFLD, KASLB1, YDCPG_BNDS, YDCPG_GFLF&
      &, YDCPG_SL1, YDGEOMETRY, YDML_DYN, YDML_GCONF, KL0, PLSCAW)
    ELSEIF (YDML_GCONF%YGFL%NUMFLDS_SL1>0.AND.YDML_GCONF%YGFL%NUMFLDS_SPL&
      &>0.AND.YDVARS%GFL_PTR (JFLD)%YCOMP%CSLINT=='LAITVSPCQM  ') THEN
      CALL LARCINB_LAITVSPCQM (LLMOM, IWKGFL, JFLD, KASLB1, KHVI, YDCPG_BNDS, YDCPG_GFLF, YDCPG_SL1&
      &, YDGEOMETRY, YDML_DYN, YDML_GCONF, YDVARS, KL0, KNOWENO, PLSCAW, PRSCAW)
    ELSE
      CALL LARCINB_LAITRE_GFL (LLMOM, IWKGFL, JFLD, KASLB1, KHVI, YDCPG_BNDS, YDCPG_GFLF, YDCPG_SL1&
      &, YDGEOMETRY, YDML_DYN, YDML_GCONF, YDVARS, KL0, KNOWENO, PLSCAW, PRSCAW)
    ENDIF

    CALL LARCINB_RRINTOPT (JFLD, YDCPG_BNDS, YDCPG_DDH_TND, YDCPG_GFLF, YDGEOMETRY, YDLDDH, YDML_DYN)

    IF (.NOT.(YDML_DYN%YRDYN%NSPLTHOI==0.OR.YDVARS%GFL_PTR (JFLD)%YCOMP%LTDIABLIN)) THEN

      IF (YDML_DYN%YRDYN%NSPLTHOI==1) THEN

        SELECTCASE (YDVARS%GFL_PTR (JFLD)%YCOMP%CSLINT)
        CASE ('LAITQM(SLD) ')
          CLINT='LAITQM      '
        CASE ('LAITQMH(SLD)')
          CLINT='LAITQMH     '
        CASE ('LAITRI(SLD) ')
          CLINT='LAITRI      '
        CASE DEFAULT
          CLINT=YDVARS%GFL_PTR (JFLD)%YCOMP%CSLINT
        ENDSELECT

        IWK=YDML_DYN%YRDYN%NSLDIMK
      ELSE
        CLINT=YDVARS%GFL_PTR (JFLD)%YCOMP%CSLINT
        IWK=IWKGFL
      ENDIF

      CALL LARCINB_LTDIABLIN (CLINT, LLMOM, IWK, JFLD, KASLB1, KHVI, YDCPG_BNDS, YDCPG_GFLF,&
      & YDCPG_SL1, YDGEOMETRY, YDML_DYN, YDML_GCONF, YDVARS, KL0, KNOWENO, PLSCAW, PRSCAW)
    ENDIF


    IF (YDVARS%GFL_PTR (JFLD)%YCOMP%LTDIABLIN) THEN
      LLCOMAD=YDML_GCONF%YGFL%YCOMP(JFLD)%CSLINT=='LIN(MAD)    '.OR.YDML_GCONF%YGFL&
      &%YCOMP(JFLD)%CSLINT=='LAITQM(MAD) '.OR.YDML_GCONF%YGFL%YCOMP(JFLD)%CSLINT=&
      &='LAITQMH(MAD)'.OR.YDML_GCONF%YGFL%YCOMP(JFLD)%CSLINT=='LAITRI(MAD) '
      CALL LARCINB_LLCOMAD (LLCOMAD, JFLD, KASLB1, YDCPG_BNDS, YDCPG_GFLF&
      &, YDCPG_SL1, YDGEOMETRY, YDML_DYN, KL0, PLSCAW)
    ENDIF

  ENDIF


  IF (YDVARS%GFL_PTR (JFLD)%YCOMP%LADV) THEN

    IF (YDVARS%GFL_PTR (JFLD)%YCOMP%LPHY.AND.LDSLPHY) THEN
      LLCOMAD=(YDVARS%GFL_PTR (JFLD)%YCOMP%CSLINT=='LIN(MAD)    ').OR.(YDVARS%GFL_PTR&
      & (JFLD)%YCOMP%CSLINT=='LAITQM(MAD) ').OR.(YDVARS%GFL_PTR (JFLD)%YCOMP%CSLINT=&
      &='LAITQMH(MAD)').OR.(YDVARS%GFL_PTR (JFLD)%YCOMP%CSLINT=='LAITRI(MAD) ')
      CALL LARCINB_LLCOMAD_2 (LLCOMAD, JFLD, KASLB1, YDCPG_BNDS, YDCPG_GFLPF&
      &, YDCPG_SL1, YDGEOMETRY, YDML_DYN, KL0, PLSCAW)
    ENDIF

  ENDIF

ENDDO

LLMOM=.TRUE.

IF (YDML_DYN%YRDYN%NVLAG==2) THEN
  CALL LARCINB_NVLAG_2 (LLMOM, LLNOSLHD, LL_LIN, IWNT, KASLB1, YDCPG_BNDS,&
  & YDCPG_SL1, YDGEOMETRY, YDML_DYN, KL0, KNOWENO, PCF, PLSCAW, PRSCAW)
ENDIF


IF (YDML_DYN%YRDYN%NVLAG==3) THEN
  CALL LARCINB_NVLAG_3 (KASLB1, YDCPG_BNDS, YDCPG_SL1, YDGEOMETRY&
  &, YDML_DYN, KL0, PCF, PCF_NL, PCF_SI, PLSCAW)
ENDIF


IF (YDML_DYN%YRDYNA%NQMGMV==-4) THEN
  CALL LARCINB_NQMGMV (KASLB1, YDCPG_BNDS, YDCPG_SL1, YDGEOMETRY, YDML_DYN, KLH0, PDP, PLSCAW)
ELSE

  IF (YDML_DYN%YRDYN%LQMP.OR.YDML_DYN%YRDYN%LQMHP) THEN
    IQM=1
  ELSE
    IQM=0
  ENDIF

  CALL LARCINB_LCOMAD_SP (IQM, IWNT, KASLB1, YDCPG_BNDS, YDCPG_SL1&
  &, YDGEOMETRY, YDML_DYN, KLH0, PDP, PLSCAW, PRSCAW)
ENDIF


IF (YDML_DYN%YRDYNA%LNHDYN.AND.YDML_DYN%YRDYNA%LRDBBC) THEN
  

  IF (YDML_DYN%YRDYN%LQMVD.OR.YDML_DYN%YRDYN%LQMHVD) THEN
    IQM=1
  ELSE
    IQM=0
  ENDIF


  IF (YDML_DYN%YRDYNA%LCOMAD_SVD) THEN
    IDLO=YDML_DYN%YYTLSCAW%M_WDLOMAD
    ICLO=YDML_DYN%YYTRSCAW%M_WCLOMAD (IWNT)
    ICLA=YDML_DYN%YYTRSCAW%M_WCLAMAD (IWNT)
  ELSE
    IDLO=YDML_DYN%YYTLSCAW%M_WDLO
    ICLO=YDML_DYN%YYTRSCAW%M_WCLO (IWNT)
    ICLA=YDML_DYN%YYTRSCAW%M_WCLA (IWNT)
  ENDIF

  CALL LAIDDI (KASLB1, YDGEOMETRY%YRDIM%NPROMA, YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA, 1, YDGEOMETRY&
  &%YRDIMV%NFLSA, YDGEOMETRY%YRDIMV%NFLEN, IQM, PRSCAW (:, YDGEOMETRY%YRDIMV%NFLEVG, ICLA:ICLA&
  &+2), PLSCAW (:, YDGEOMETRY%YRDIMV%NFLEVG, IDLO:IDLO+3), PRSCAW (:, YDGEOMETRY%YRDIMV%NFLEVG&
  &, ICLO:ICLO+5), KLH0 (:, YDGEOMETRY%YRDIMV%NFLEVG,:), YDCPG_SL1%GWS9%P, PGWSF)

  IF (YDML_DYN%YRDYN%NSVDLAG==2) THEN
    CALL LAITRE_GMV (YDML_DYN, KASLB1, YDGEOMETRY%YRDIM%NPROMA, YDCPG_BNDS%KIDIA, YDCPG_BNDS&
    &%KFDIA, 1, YDGEOMETRY%YRDIMV%NFLSA, YDGEOMETRY%YRDIMV%NFLEN, IWNT, LL_LIN, YDML_DYN%YRDYNA&
    &%LCOMAD_SVD, LLNOSLHD, YDML_DYN%YRDYN%LVWENO_SVD, YDML_DYN%YRDYN%WENO_ALPHA_SVD, LLMOM&
    &, YDML_DYN%YRDYN%LQMVD, YDML_DYN%YRDYN%LQMHVD, KNOWENO, KL0 (:, YDGEOMETRY%YRDIMV%NFLEVG&
    &, 0:3), PLSCAW (:, YDGEOMETRY%YRDIMV%NFLEVG, 1:YDML_DYN%YYTLSCAW%NDIM), PRSCAW (:, YDGEOMETRY&
    &%YRDIMV%NFLEVG, 1:YDML_DYN%YYTRSCAW%NDIM), YDCPG_SL1%DBBC9%P, PDBBCF)
    CALL LAITRE_GMV (YDML_DYN, KASLB1, YDGEOMETRY%YRDIM%NPROMA, YDCPG_BNDS%KIDIA, YDCPG_BNDS&
    &%KFDIA, 1, YDGEOMETRY%YRDIMV%NFLSA, YDGEOMETRY%YRDIMV%NFLEN, IWNT, LL_LIN, YDML_DYN%YRDYNA&
    &%LCOMAD_SVD, LLNOSLHD, YDML_DYN%YRDYN%LVWENO_SVD, YDML_DYN%YRDYN%WENO_ALPHA_SVD, LLMOM&
    &, YDML_DYN%YRDYN%LQMVD, YDML_DYN%YRDYN%LQMHVD, KNOWENO, KL0 (:, YDGEOMETRY%YRDIMV%NFLEVG&
    &, 0:3), PLSCAW (:, YDGEOMETRY%YRDIMV%NFLEVG, 1:YDML_DYN%YYTLSCAW%NDIM), PRSCAW (:, YDGEOMETRY&
    &%YRDIMV%NFLEVG, 1:YDML_DYN%YYTRSCAW%NDIM), YDCPG_SL1%DPHI9%P, PDPHIF)
  ELSEIF (YDML_DYN%YRDYN%NSVDLAG>=3) THEN
    CALL LAITLIF (YDML_DYN%YYTLSCAW, KASLB1, YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY&
    &%YRDIMV%NFLEVG, YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA, KL0, YDML_DYN%YRDYNA&
    &%LCOMAD_SVD, PLSCAW, YDCPG_SL1%DBBC9%P, PDBBCF, LD2D=.TRUE.)
    CALL LAITLIF (YDML_DYN%YYTLSCAW, KASLB1, YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY&
    &%YRDIMV%NFLEVG, YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA, KL0, YDML_DYN%YRDYNA&
    &%LCOMAD_SVD, PLSCAW, YDCPG_SL1%DPHI9%P, PDPHIF, LD2D=.TRUE.)
  ENDIF

  
ENDIF



IF (LHOOK) CALL DR_HOOK ('LARCINB', 1, ZHOOK_HANDLE)
ENDSUBROUTINE LARCINB
