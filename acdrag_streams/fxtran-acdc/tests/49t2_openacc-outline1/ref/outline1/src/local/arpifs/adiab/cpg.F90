SUBROUTINE CPG (YDGEOMETRY, YDCPG_BNDS, YDCPG_OPTS, YDCPG_TND, YDCPG_SL1AUX, YDCPG_SL2, YDCPG_MISC&
&, YDCPG_GPAR, YDCPG_PHY0, YDCPG_PHY9, YDMF_PHYS, YDHGRAD, YDCPG_DDH, YDCPG_DYN0, YDCPG_DYN9, YDMF_PHYS_SURF&
&, YDVARS, YDXFU, YDCFU, YDMODEL, YDFIELDS, YDA_GFLSLP, YDA_SAVTEND, YDCPG_DDH_TND, YDPGTERM, YDA_GFLPC&
&, YDA_GFLPT, YDCPG_SLMISC, YDCPG_SL1, YDA_EXTRA, YDDDH, YDTDDH, YDA_RSAVEDP, YDA_PWRL9, YDPHYSMWAVE&
&, PGPSDT2D, PGFL, PGMVT1, PGFLT1, PTRAJ_PHYS, PTRAJ_SLAG)
USE TYPE_MODEL,ONLY:MODEL
USE FIELDS_MOD,ONLY:FIELDS
USE GEOMETRY_MOD,ONLY:GEOMETRY
USE MF_PHYS_TYPE_MOD,ONLY:MF_PHYS_TYPE
USE CPG_TYPE_MOD,ONLY:CPG_DDH_TYPE, CPG_DYN_TYPE, CPG_GPAR_TYPE&
&, CPG_MISC_TYPE, CPG_PHY_TYPE, CPG_TND_TYPE
USE CPG_SL1_TYPE_MOD,ONLY:CPG_SL1B_TYPE, CPG_SL1F_TYPE
USE CPG_SL2_TYPE_MOD,ONLY:CPG_SL2_TYPE
USE CPG_OPTS_TYPE_MOD,ONLY:CPG_BNDS_TYPE, CPG_OPTS_TYPE
USE MF_PHYS_SURFACE_TYPE_MOD,ONLY:MF_PHYS_SURF_TYPE
USE FIELD_VARIABLES_MOD,ONLY:FIELD_VARIABLES
USE YOMXFU,ONLY:TXFU
USE YOMCFU,ONLY:TCFU
USE PARKIND1,ONLY:JPIM, JPRB
USE YOMHOOK,ONLY:DR_HOOK, LHOOK, JPHOOK
USE EINT_MOD,ONLY:SL_STRUCT
USE DDH_MIX,ONLY:CLEANDDH, RESET_DDHFLEX, SETDDH, TYP_DDH
USE YOMTRAJ,ONLY:LTRAJSAVE, LTRAJSLAG, TRAJ_PHYS_TYPE, TRAJ_SLAG_TYPE
USE YOMINI,ONLY:LINITER
USE ALGORITHM_STATE_MOD,ONLY:GET_NUPTRA
USE CPG_DDH_TND_TYPE_MOD,ONLY:CPG_DDH_TND_TYPE
USE CPG_SLMISC_TYPE_MOD,ONLY:CPG_SLMISC_TYPE
USE FIELD_ARRAY_MODULE,ONLY:FIELD_4RB_ARRAY, FIELD_3RB_ARRAY
USE INTDYN_MOD,ONLY:TPG_TYPE
USE YOMTDDH,ONLY:TTDDH
USE YOMDGRADIENT_TYPE_MOD,ONLY:GRADIENT_TYPE
USE YOE_PHYS_MWAVE,ONLY:TEPHYSMWAVE

IMPLICIT NONE


TYPE (GEOMETRY), INTENT (IN)::YDGEOMETRY
TYPE (CPG_BNDS_TYPE), INTENT (IN)::YDCPG_BNDS
TYPE (CPG_OPTS_TYPE), INTENT (IN)::YDCPG_OPTS
TYPE (CPG_TND_TYPE), INTENT (INOUT)::YDCPG_TND
TYPE (CPG_SL1B_TYPE), INTENT (INOUT)::YDCPG_SL1AUX
TYPE (CPG_SL2_TYPE), INTENT (INOUT)::YDCPG_SL2
TYPE (CPG_MISC_TYPE), INTENT (INOUT)::YDCPG_MISC
TYPE (CPG_GPAR_TYPE), INTENT (INOUT)::YDCPG_GPAR
TYPE (CPG_PHY_TYPE), INTENT (INOUT)::YDCPG_PHY0
TYPE (CPG_PHY_TYPE), INTENT (INOUT)::YDCPG_PHY9
TYPE (MF_PHYS_TYPE), INTENT (INOUT)::YDMF_PHYS
TYPE (GRADIENT_TYPE), INTENT (INOUT)::YDHGRAD
TYPE (CPG_DDH_TYPE), INTENT (INOUT)::YDCPG_DDH
TYPE (CPG_DYN_TYPE), INTENT (INOUT)::YDCPG_DYN0
TYPE (CPG_DYN_TYPE), INTENT (INOUT)::YDCPG_DYN9
TYPE (MF_PHYS_SURF_TYPE), INTENT (INOUT)::YDMF_PHYS_SURF
TYPE (FIELD_VARIABLES), INTENT (INOUT)::YDVARS
TYPE (TXFU), INTENT (INOUT)::YDXFU
TYPE (TCFU), INTENT (INOUT)::YDCFU
TYPE (MODEL), INTENT (IN)::YDMODEL
TYPE (FIELDS), INTENT (INOUT)::YDFIELDS
TYPE (FIELD_4RB_ARRAY), INTENT (IN)::YDA_GFLSLP
TYPE (FIELD_4RB_ARRAY), INTENT (IN)::YDA_SAVTEND
TYPE (CPG_DDH_TND_TYPE), INTENT (INOUT)::YDCPG_DDH_TND
TYPE (TPG_TYPE), INTENT (INOUT)::YDPGTERM
TYPE (FIELD_4RB_ARRAY), INTENT (INOUT)::YDA_GFLPC
TYPE (FIELD_4RB_ARRAY), INTENT (INOUT)::YDA_GFLPT
TYPE (CPG_SLMISC_TYPE), INTENT (INOUT)::YDCPG_SLMISC
TYPE (CPG_SL1F_TYPE), INTENT (INOUT)::YDCPG_SL1
TYPE (FIELD_4RB_ARRAY), INTENT (INOUT)::YDA_EXTRA
TYPE (TYP_DDH), INTENT (INOUT)::YDDDH
TYPE (TTDDH), INTENT (INOUT)::YDTDDH
TYPE (FIELD_4RB_ARRAY), INTENT (INOUT)::YDA_RSAVEDP
TYPE (FIELD_3RB_ARRAY), INTENT (INOUT)::YDA_PWRL9
TYPE (TEPHYSMWAVE), INTENT (INOUT)::YDPHYSMWAVE
REAL (KIND=JPRB), INTENT (IN), OPTIONAL::PGPSDT2D (YDGEOMETRY%YRDIM%NPROMA&
&, YDMODEL%YRML_SPPT%YGPSDT (1)%NG2D, YDGEOMETRY%YRDIM%NGPBLKS)
REAL (KIND=JPRB), INTENT (INOUT), OPTIONAL::PGFL (YDCPG_OPTS&
&%KLON, YDCPG_OPTS%KFLEVG, YDMODEL%YRML_GCONF%YGFL%NDIM)
REAL (KIND=JPRB), INTENT (OUT), OPTIONAL::PGMVT1 (YDCPG_OPTS&
&%KLON, YDCPG_OPTS%KFLEVG, YDFIELDS%YRGMV%YT1%NDIM)
REAL (KIND=JPRB), INTENT (OUT), OPTIONAL::PGFLT1 (YDCPG_OPTS&
&%KLON, YDCPG_OPTS%KFLEVG, YDMODEL%YRML_GCONF%YGFL%NDIM1)
TYPE (TRAJ_PHYS_TYPE), INTENT (INOUT), OPTIONAL::PTRAJ_PHYS
TYPE (TRAJ_SLAG_TYPE), INTENT (INOUT), OPTIONAL::PTRAJ_SLAG
INTEGER (KIND=JPIM)::JLEV
INTEGER (KIND=JPIM)::JFLD
INTEGER (KIND=JPIM)::IUPTRA
REAL (KIND=JPHOOK)::ZHOOK_HANDLE
#include "cpdysldia.intfb.h"
#include "cpg_shufflesl1.intfb.h"
#include "cpg_lsmtsol.intfb.h"
#include "cpg_zerosl1.intfb.h"
#include "cpg_isettloff.intfb.h"
#include "cpg_zeropb2.intfb.h"
#include "cpg_dia_ddh.intfb.h"
#include "cpg_dia_flu.intfb.h"
#include "cpg_dyn_slg.intfb.h"
#include "cpg_dyn_eul.intfb.h"
#include "cpg_dyn_tra.intfb.h"
#include "cpg_gp_tenc.intfb.h"
#include "cpg_gp.intfb.h"
#include "ec_phys_lslphy.intfb.h"
#include "gpiniddh.intfb.h"
#include "mf_phys.intfb.h"
#include "cpg_gp_tndddh_expl.intfb.h"
#include "cpg_end_sfc.intfb.h"
#include "cpg_end_tra.intfb.h"
#include "cpg_end_map.intfb.h"
#include "cpg_end_spr.intfb.h"
IF (LHOOK) CALL DR_HOOK ('CPG', 0, ZHOOK_HANDLE)


CALL CPG_ZEROPB2 (YDCPG_BNDS, YDCPG_OPTS, YDCPG_SL2)
CALL CPG_ISETTLOFF (YDCPG_SLMISC)

IF (YDMODEL%YRML_LBC%LTENC) THEN
  
  CALL CPG_GP_TENC (YDGEOMETRY, YDCPG_BNDS, YDCPG_OPTS, YDVARS, YDMODEL, YDFIELDS)
  
ENDIF

CALL CPG_GP (YDGEOMETRY, YDCPG_BNDS, YDCPG_OPTS, YDCPG_TND, YDCPG_MISC, YDCPG_GPAR, YDCPG_DYN0&
&, YDCPG_DYN9, YDHGRAD, YDMF_PHYS_SURF, YDVARS, YDMODEL, YDCPG_SL2, YDPGTERM, YDDDH)

IF (YDMODEL%YRML_DIAG%YRLDDH%LRSLDDH.AND.YDMODEL%YRML_DYN%YRDYNA%LSLAG) THEN
  
  CALL CPG_GP_TNDDDH_EXPL (YDGEOMETRY, YDCPG_OPTS, YDCPG_BNDS, YDCPG_DYN0&
  &, YDCPG_DYN9, YDVARS, YDMODEL, YDCPG_DDH_TND%YSL)
  
ENDIF


IF (YDMODEL%YRML_DIAG%YRLDDH%LSDDH) THEN
  

  IF (YDMODEL%YRML_DYN%YRDYN%NCURRENT_ITER==0)  THEN
    CALL GPINIDDH (YDGEOMETRY, YDMODEL%YRML_DIAG%YRMDDH, YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA, YDCPG_DDH&
    &%DDHI, YDCPG_MISC%DHSF, YDCPG_DDH%DHCV, YDCPG_MISC%NEB, YDCPG_MISC%CLCT, YDCPG_BNDS%KSTGLO)
  ENDIF


  IF (YDMODEL%YRML_DIAG%YRLDDH%LFLEXDIA.AND.YDMODEL%YRML_DIAG%YRLDDH%LDDH_OMP) THEN
    CALL SETDDH (YDMODEL%YRML_DIAG%YRMDDH, YDDDH, YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA, YDGEOMETRY&
    &%YRDIM%NPROMA, YDGEOMETRY%YRDIMV%NFLEVG, YDMODEL%YRML_DYN%YRDYN%NCURRENT_ITER, YDCPG_MISC&
    &%DHSF, YDCPG_DDH%DDHI, YDCPG_DDH%AUX3D, YDCPG_DDH%AUX2D, YDCPG_DDH%AUXSM)
  ENDIF

  
ENDIF


IF (YDCPG_OPTS%LUSEPB1) THEN
  CALL CPG_ZEROSL1 (YDCPG_BNDS, YDCPG_OPTS, YDCPG_SL1AUX)
ENDIF


IF (YDCPG_OPTS%LSLPHY.AND.((YDMODEL%YRML_DYN%YRDYNA%LPC_FULL.AND.(YDMODEL%YRML_DYN%YRDYN%NCURRENT_ITER&
  &==YDMODEL%YRML_DYN%YRDYN%NSITER)).OR.(.NOT.YDMODEL%YRML_DYN%YRDYNA%LPC_FULL))) THEN
  
  CALL EC_PHYS_LSLPHY (YDGEOMETRY, YDMODEL%YRML_DYN, YDMODEL%YRML_PHY_G%YRSLPHY, YDMODEL%YRML_GCONF, YDMODEL&
  &%YRML_PHY_MF%YRPHY2, YDCPG_OPTS, YDCPG_BNDS, YDVARS, YDCPG_SL1AUX, YDA_SAVTEND, YDA_GFLSLP)
  
ENDIF


IF (YDMODEL%YRML_PHY_EC%YRECUCONVCA%LCUCONV_CA) THEN
  
  YDMF_PHYS%OUT%CUCONVCA (1:YDCPG_BNDS%KFDIA)=YDMODEL%YRML_PHY_EC%YRECUCONVCA&
  &%RCUCONVCA(YDCPG_BNDS%KSTGLO:YDCPG_BNDS%KSTGLO+YDCPG_BNDS%KFDIA-1)
  YDMF_PHYS%OUT%NLCONVCA (1:YDCPG_BNDS%KFDIA)=YDMODEL%YRML_PHY_EC%YRECUCONVCA&
  &%RNLCONVCA(YDCPG_BNDS%KSTGLO:YDCPG_BNDS%KSTGLO+YDCPG_BNDS%KFDIA-1)
  
ENDIF


IF (YDMODEL%YRML_PHY_MF%YRPHY%LMPHYS.OR.YDMODEL%YRML_PHY_MF%YRSIMPHL%LSIMPH) THEN
  CALL MF_PHYS (YDGEOMETRY, YDCPG_BNDS, YDCPG_OPTS, YDCPG_MISC, YDCPG_GPAR, YDCPG_PHY0, YDCPG_PHY9, YDMF_PHYS&
  &, YDHGRAD, YDCPG_DYN0, YDCPG_DYN9, YDMF_PHYS_SURF, YDCPG_SL1AUX, YDCPG_SL2, YDVARS, YDXFU, YDCFU, YDMODEL&
  &, YDFIELDS, YDPHYSMWAVE, YDA_GFLPT, PGPSDT2D, PGFL, PGMVT1, PGFLT1, PTRAJ_PHYS, YDDDH)
ENDIF


IF (YDMODEL%YRML_DYN%YRDYN%NCURRENT_ITER==0) THEN

  IF ((YDCPG_OPTS%NSTEP>=0).AND.YDMODEL%YRML_DIAG%YRLDDH%LSDDH&
    &.AND.(.NOT.LINITER).AND.(.NOT.YDCPG_OPTS%LCONFX)) THEN
    
    CALL CPG_DIA_DDH (YDGEOMETRY, YDCPG_BNDS, YDCPG_OPTS, YDCPG_TND, YDCPG_MISC, YDCPG_GPAR, YDMF_PHYS&
    &%OUT, YDCPG_DYN0, YDMF_PHYS_SURF, YDVARS, YDMODEL, YDCPG_DDH%DDHI, YDCPG_SL2%VVEL, YDCPG_DDH_TND&
    &%YSI, YDCPG_DDH_TND%YHD, YDCPG_DDH%DHCV, YDDDH, YDTDDH, YDCPG_MISC%FTCNS)
    
  ENDIF

  CALL CPG_DIA_FLU (YDCPG_BNDS, YDCPG_OPTS, YDCPG_MISC, YDMF_PHYS%OUT&
  &, YDCPG_DYN0, YDMF_PHYS_SURF, YDVARS, YDCFU, YDXFU, YDMODEL)

  IF (YDCPG_OPTS%LCONFX.AND.YDMODEL%YRML_DIAG%YRLDDH%LFLEXDIA&
    &.AND.(.NOT.YDMODEL%YRML_DIAG%YRLDDH%LDDH_OMP)) THEN
    
    CALL RESET_DDHFLEX
    
  ENDIF

ENDIF


IF (YDMODEL%YRML_DYN%YRDYNA%LSLDIA.AND.(YDMODEL%YRML_DYN%YRDYN&
  &%NCURRENT_ITER==YDMODEL%YRML_DYN%YRDYN%NSITER)) THEN
  
  CALL CPDYSLDIA (YDMODEL%YRCST, YDVARS, YDCPG_DYN0, YDCPG_OPTS, YDCPG_BNDS,&
  & YDGEOMETRY, YDMODEL%YRML_PHY_G%YRDPHY, YDMODEL%YRML_GCONF, YDA_EXTRA)
  
ENDIF

CALL CPG_LSMTSOL (YDCPG_BNDS, YDCPG_MISC, YDCPG_OPTS, YDGEOMETRY, YDMF_PHYS_SURF, YDVARS)

IF (YDMODEL%YRML_DYN%YRDYNA%LSLAG) THEN
  CALL CPG_DYN_SLG (YDGEOMETRY, YDCPG_BNDS, YDCPG_OPTS, YDCPG_TND, YDCPG_MISC, YDCPG_DYN0, YDCPG_DYN9&
  &, YDVARS, YDCPG_SL1AUX, YDCPG_SL2, YDMODEL, YDCPG_SLMISC, YDCPG_DDH_TND%YSI, YDA_PWRL9)
ELSE
  
  CALL CPG_DYN_EUL (YDGEOMETRY, YDCPG_BNDS, YDCPG_OPTS, YDCPG_TND, YDCPG_MISC&
  &, YDCPG_DYN0, YDCPG_DYN9, YDVARS, YDMODEL, YDCPG_SL2, YDA_GFLPC)
  
ENDIF


IF (LTRAJSAVE.AND.LTRAJSLAG) THEN
  
  CALL CPG_DYN_TRA (YDGEOMETRY, YDCPG_BNDS, YDCPG_DYN9, YDVARS, YDMODEL&
  &, YDCPG_SL1AUX, YDCPG_SL2, PTRAJ_SLAG, YDA_RSAVEDP, YDA_PWRL9)
  
ENDIF


IF (YDCPG_OPTS%LUSEPB1) THEN
  CALL CPG_SHUFFLESL1 (YDCPG_BNDS, YDCPG_OPTS, YDCPG_SL1, YDCPG_SL1AUX, YDMODEL)
ENDIF

IUPTRA=GET_NUPTRA ()
CALL CPG_END_SFC (YDMODEL, YDCPG_OPTS, YDCPG_BNDS, YDMF_PHYS_SURF, IUPTRA)

IF (YDMODEL%YRML_PHY_MF%YRSIMPHL%LTRAJPS) THEN
  
  CALL CPG_END_TRA (YDMF_PHYS_SURF, YDCPG_MISC, YDCPG_BNDS, PTRAJ_PHYS)
  
ENDIF

CALL CPG_END_MAP (YDGEOMETRY, YDMODEL, YDVARS, YDCPG_BNDS, YDCPG_OPTS)

IF (YDMODEL%YRML_LBC%LTENC) THEN
  
  CALL CPG_END_SPR (YDVARS, YDMODEL%YRML_DYN%YRDYNA, YDCPG_BNDS, YDCPG_OPTS)
  
ENDIF


IF (YDMODEL%YRML_DIAG%YRLDDH%LSDDH.AND.YDMODEL%YRML_DIAG%YRLDDH&
  &%LFLEXDIA.AND.YDMODEL%YRML_DIAG%YRLDDH%LDDH_OMP) THEN
  
  CALL CLEANDDH (YDTDDH, YDDDH, YDCPG_BNDS%KSTGLO, YDMODEL%YRML_DYN%YRDYN%NCURRENT_ITER)
  
ENDIF



IF (LHOOK) CALL DR_HOOK ('CPG', 1, ZHOOK_HANDLE)
ENDSUBROUTINE CPG
