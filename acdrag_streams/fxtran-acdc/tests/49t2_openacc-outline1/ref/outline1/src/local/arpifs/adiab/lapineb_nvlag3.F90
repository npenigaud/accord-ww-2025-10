SUBROUTINE LAPINEB_NVLAG3 (YDCPG_BNDS, YDCPG_SL2, YDGEOMETRY,&
& YDMODEL, YDVARS, PC9, PC9_SI, PDP9, PSPT1, PSPTO, PVWEI)
USE CPG_OPTS_TYPE_MOD,ONLY:CPG_OPTS_TYPE, CPG_BNDS_TYPE
USE CPG_SL2_TYPE_MOD,ONLY:CPG_SL2_TYPE
USE FIELD_VARIABLES_MOD,ONLY:FIELD_VARIABLES
USE GEOMETRY_MOD,ONLY:GEOMETRY
USE PARKIND1,ONLY:JPIM, JPRB
USE TYPE_MODEL,ONLY:MODEL
USE YOMHOOK,ONLY:LHOOK, JPHOOK, DR_HOOK

IMPLICIT NONE

TYPE (CPG_BNDS_TYPE), INTENT (IN)::YDCPG_BNDS
TYPE (CPG_SL2_TYPE), INTENT (IN)::YDCPG_SL2
TYPE (GEOMETRY), INTENT (IN)::YDGEOMETRY
TYPE (MODEL), INTENT (IN)::YDMODEL
TYPE (FIELD_VARIABLES), INTENT (INOUT)::YDVARS
REAL (KIND=JPRB), INTENT (INOUT)::PC9 (YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB), INTENT (INOUT)::PC9_SI (YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB), INTENT (INOUT)::PDP9 (YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB), INTENT (INOUT)::PSPT1 (YDGEOMETRY%YRDIM%NPROMA, 0:YDGEOMETRY%YRDIMV%NFLEVG+1)
REAL (KIND=JPRB), INTENT (INOUT)::PSPTO (YDGEOMETRY%YRDIM%NPROMA)
REAL (KIND=JPRB), INTENT (INOUT)::PVWEI (YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY%YRDIMV%NFLEVG)
#include "verdisint.intfb.h"
LOGICAL::LLSLINLC2
INTEGER (KIND=JPIM)::JLEV
INTEGER (KIND=JPIM)::JROF
REAL (KIND=JPHOOK)::ZHOOK_HANDLE
IF (LHOOK) CALL DR_HOOK ('LAPINEB_NVLAG3', 0, ZHOOK_HANDLE)

IF (YDGEOMETRY%YRVERT_GEOM%YRCVER%LVERTFE) THEN

  DO JLEV=1, YDGEOMETRY%YRDIMV%NFLEVG

    DO JROF=YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA
      PSPT1 (JROF, JLEV)=PVWEI (JROF, JLEV)*YDGEOMETRY%YRVERT_GEOM%YRVETA&
      &%VFE_RDETAH (JLEV)*(PDP9 (JROF, JLEV)+PC9 (JROF, JLEV))
    ENDDO

  ENDDO

  PSPT1 (YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA, 0)=0.0_JPRB
  PSPT1 (YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA, YDGEOMETRY%YRDIMV%NFLEVG+1)=0.0_JPRB
  CALL VERDISINT (YDGEOMETRY%YRVERT_GEOM%YRVFE, YDGEOMETRY%YRVERT_GEOM%YRCVER,'ITOP','11', YDGEOMETRY&
  &%YRDIM%NPROMA, YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA, YDGEOMETRY%YRDIMV%NFLEVG, PSPT1, POUTS=PSPTO)
  YDVARS%SP%T1 (YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA)=YDVARS%SP%T1 (YDCPG_BNDS&
  &%KIDIA:YDCPG_BNDS%KFDIA)+PSPTO (YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA)
ELSE

  DO JLEV=1, YDGEOMETRY%YRDIMV%NFLEVG
    YDVARS%SP%T1 (YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA)=YDVARS%SP%T1 (YDCPG_BNDS%KIDIA:YDCPG_BNDS&
    &%KFDIA)+PVWEI (YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA, JLEV)*(PDP9 (YDCPG_BNDS%KIDIA:YDCPG_BNDS&
    &%KFDIA, JLEV)+PC9 (YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA, JLEV))
  ENDDO

ENDIF

LLSLINLC2=YDMODEL%YRML_DYN%YRDYNA%LSLINLC2.AND.YDMODEL%YRML_DYN%YRDYNA&
&%NGWADVSI==1.AND.(YDMODEL%YRML_DYN%YRDYN%NCURRENT_ITER==0)

IF (LLSLINLC2.AND..NOT.YDGEOMETRY%YRVERT_GEOM%YRCVER%LVERTFE) THEN

  DO JLEV=1, YDGEOMETRY%YRDIMV%NFLEVG

    DO JROF=YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA
      YDCPG_SL2%SPSI (JROF)=YDCPG_SL2%SPSI (JROF)+PVWEI (JROF, JLEV)*PC9_SI (JROF, JLEV)
    ENDDO

  ENDDO

ELSEIF (LLSLINLC2.AND.YDGEOMETRY%YRVERT_GEOM%YRCVER%LVERTFE) THEN

  DO JLEV=1, YDGEOMETRY%YRDIMV%NFLEVG

    DO JROF=YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA
      PSPT1 (JROF, JLEV)=PVWEI (JROF, JLEV)*YDGEOMETRY%YRVERT_GEOM&
      &%YRVETA%VFE_RDETAH (JLEV)*PC9_SI (JROF, JLEV)
    ENDDO

  ENDDO

  PSPT1 (YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA, 0)=0.0_JPRB
  PSPT1 (YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA, YDGEOMETRY%YRDIMV%NFLEVG+1)=0.0_JPRB
  CALL VERDISINT (YDGEOMETRY%YRVERT_GEOM%YRVFE, YDGEOMETRY%YRVERT_GEOM%YRCVER,'ITOP','11', YDGEOMETRY&
  &%YRDIM%NPROMA, YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA, YDGEOMETRY%YRDIMV%NFLEVG, PSPT1, POUTS=PSPTO)

  DO JROF=YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA
    YDCPG_SL2%SPSI (JROF)=YDCPG_SL2%SPSI (JROF)+PSPTO (JROF)
  ENDDO

ENDIF

IF (LHOOK) CALL DR_HOOK ('LAPINEB_NVLAG3', 1, ZHOOK_HANDLE)
ENDSUBROUTINE
