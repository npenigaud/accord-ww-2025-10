SUBROUTINE ARP_SHALLOW_MF (YDCST, YDPHYEX, YDCPG_OPTS, YDCPG_BNDS, PTSPHY, PZZ, PZZF&
&, PR, PCP, PU, PV, PT, PQV, PQL, PQI, PQR, PQS, PTKE, PAPRSF, PDELP, PDIFTQ, PDIFTS&
&, PSTRTU, PSTRTV, YDMF_PHYS_SURF, PRODTH_CVPP, PQLI, PNEB, KNLAB, PMF_UP)
USE PARKIND1,ONLY:JPIM, JPRB
USE YOMHOOK,ONLY:DR_HOOK, JPHOOK, LHOOK
USE YOMCST,ONLY:TCST
USE YOMLSFORC,ONLY:LMUSCLFA, NMUSCLFA
USE MODD_PHYEX,ONLY:PHYEX_T
USE MODD_DIMPHYEX,ONLY:DIMPHYEX_T
USE MODI_SHALLOW_MF,ONLY:SHALLOW_MF
USE MODE_FILL_DIMPHYEX,ONLY:FILL_DIMPHYEX
USE MF_PHYS_SURFACE_TYPE_MOD,ONLY:MF_PHYS_SURF_TYPE
USE CPG_OPTS_TYPE_MOD,ONLY:CPG_BNDS_TYPE, CPG_OPTS_TYPE

IMPLICIT NONE


TYPE (TCST), INTENT (IN)::YDCST
TYPE (PHYEX_T), INTENT (IN)::YDPHYEX
TYPE (CPG_OPTS_TYPE), INTENT (IN)::YDCPG_OPTS
TYPE (CPG_BNDS_TYPE), INTENT (IN)::YDCPG_BNDS
REAL (KIND=JPRB), INTENT (IN)::PTSPHY
REAL (KIND=JPRB), INTENT (IN)::PZZ (YDCPG_OPTS%KLON, 0:YDCPG_OPTS%KFLEVG)
REAL (KIND=JPRB), INTENT (IN)::PZZF (YDCPG_OPTS%KLON, YDCPG_OPTS%KFLEVG)
REAL (KIND=JPRB), INTENT (IN)::PR (YDCPG_OPTS%KLON, YDCPG_OPTS%KFLEVG)
REAL (KIND=JPRB), INTENT (IN)::PCP (YDCPG_OPTS%KLON, YDCPG_OPTS%KFLEVG)
REAL (KIND=JPRB), INTENT (IN)::PU (YDCPG_OPTS%KLON, YDCPG_OPTS%KFLEVG)
REAL (KIND=JPRB), INTENT (IN)::PV (YDCPG_OPTS%KLON, YDCPG_OPTS%KFLEVG)
REAL (KIND=JPRB), INTENT (IN)::PT (YDCPG_OPTS%KLON, YDCPG_OPTS%KFLEVG)
REAL (KIND=JPRB), INTENT (IN)::PQV (YDCPG_OPTS%KLON, YDCPG_OPTS%KFLEVG)
REAL (KIND=JPRB), INTENT (IN)::PQL (YDCPG_OPTS%KLON, YDCPG_OPTS%KFLEVG)
REAL (KIND=JPRB), INTENT (IN)::PQI (YDCPG_OPTS%KLON, YDCPG_OPTS%KFLEVG)
REAL (KIND=JPRB), INTENT (IN)::PQR (YDCPG_OPTS%KLON, YDCPG_OPTS%KFLEVG)
REAL (KIND=JPRB), INTENT (IN)::PQS (YDCPG_OPTS%KLON, YDCPG_OPTS%KFLEVG)
REAL (KIND=JPRB), INTENT (IN)::PTKE (YDCPG_OPTS%KLON, YDCPG_OPTS%KFLEVG)
REAL (KIND=JPRB), INTENT (IN)::PAPRSF (YDCPG_OPTS%KLON, YDCPG_OPTS%KFLEVG)
REAL (KIND=JPRB), INTENT (IN)::PDELP (YDCPG_OPTS%KLON, YDCPG_OPTS%KFLEVG)
REAL (KIND=JPRB), INTENT (INOUT)::PDIFTQ (YDCPG_OPTS%KLON, 0:YDCPG_OPTS%KFLEVG)
REAL (KIND=JPRB), INTENT (INOUT)::PDIFTS (YDCPG_OPTS%KLON, 0:YDCPG_OPTS%KFLEVG)
REAL (KIND=JPRB), INTENT (INOUT)::PSTRTU (YDCPG_OPTS%KLON, 0:YDCPG_OPTS%KFLEVG)
REAL (KIND=JPRB), INTENT (INOUT)::PSTRTV (YDCPG_OPTS%KLON, 0:YDCPG_OPTS%KFLEVG)
REAL (KIND=JPRB), INTENT (OUT)::PRODTH_CVPP (YDCPG_OPTS%KLON, 0:YDCPG_OPTS%KFLEVG)
REAL (KIND=JPRB), INTENT (OUT)::PQLI (YDCPG_OPTS%KLON, YDCPG_OPTS%KFLEVG)
REAL (KIND=JPRB), INTENT (OUT)::PNEB (YDCPG_OPTS%KLON, YDCPG_OPTS%KFLEVG)
INTEGER (KIND=JPIM), INTENT (OUT)::KNLAB (YDCPG_OPTS%KLON, YDCPG_OPTS%KFLEVG)
REAL (KIND=JPRB), INTENT (OUT)::PMF_UP (YDCPG_OPTS%KLON, 0:YDCPG_OPTS%KFLEVG)
TYPE (MF_PHYS_SURF_TYPE), INTENT (IN)::YDMF_PHYS_SURF
INTEGER (KIND=JPIM)::IKL
INTEGER (KIND=JPIM)::IKR
INTEGER (KIND=JPIM)::IKRL
INTEGER (KIND=JPIM)::IKRI


INTEGER (KIND=JPIM)::ITCOUNT
INTEGER (KIND=JPIM)::ISV_LGEND
INTEGER (KIND=JPIM)::ISV_LGBEG
REAL (KIND=JPRB)::ZVMD

REAL (KIND=JPRB)::ZINVG



REAL (KIND=JPRB)::ZFLXZTHMF (YDCPG_OPTS%KLON, YDCPG_OPTS%KFLEVG)

REAL (KIND=JPRB)::ZFLXZUMF (YDCPG_OPTS%KLON, YDCPG_OPTS%KFLEVG)
REAL (KIND=JPRB)::ZFLXZVMF (YDCPG_OPTS%KLON, YDCPG_OPTS%KFLEVG)
REAL (KIND=JPRB)::ZEMF (YDCPG_OPTS%KLON, YDCPG_OPTS%KFLEVG)


REAL (KIND=JPRB)::ZDZZ (YDCPG_OPTS%KLON, YDCPG_OPTS%KFLEVG)
REAL (KIND=JPRB)::ZZZ (YDCPG_OPTS%KLON, YDCPG_OPTS%KFLEVG)

REAL (KIND=JPRB)::ZTHETA (YDCPG_OPTS%KLON, YDCPG_OPTS%KFLEVG)
REAL (KIND=JPRB)::ZEXNER (YDCPG_OPTS%KLON, YDCPG_OPTS%KFLEVG)

REAL (KIND=JPRB)::ZHRODJ (YDCPG_OPTS%KLON, YDCPG_OPTS%KFLEVG)
REAL (KIND=JPRB)::ZHRODREF (YDCPG_OPTS%KLON, YDCPG_OPTS%KFLEVG)
REAL (KIND=JPRB)::ZRM (YDCPG_OPTS%KLON, YDCPG_OPTS%KFLEVG, 5)
REAL (KIND=JPRB)::ZSFTH (YDCPG_OPTS%KLON)
REAL (KIND=JPRB)::ZSFRV (YDCPG_OPTS%KLON)
REAL (KIND=JPRB)::ZSVM (YDCPG_OPTS%KLON, YDCPG_OPTS%KFLEVG, 1)

REAL (KIND=JPRB)::ZDUDT_MF (YDCPG_OPTS%KLON, YDCPG_OPTS%KFLEVG)
REAL (KIND=JPRB)::ZDVDT_MF (YDCPG_OPTS%KLON, YDCPG_OPTS%KFLEVG)
REAL (KIND=JPRB)::ZDTHLDT_MF (YDCPG_OPTS%KLON, YDCPG_OPTS%KFLEVG)
REAL (KIND=JPRB)::ZDRTDT_MF (YDCPG_OPTS%KLON, YDCPG_OPTS%KFLEVG)

REAL (KIND=JPRB)::ZFLXZTHVMF (YDCPG_OPTS%KLON, YDCPG_OPTS%KFLEVG)
REAL (KIND=JPRB)::ZTHL_UP (YDCPG_OPTS%KLON, YDCPG_OPTS%KFLEVG)
REAL (KIND=JPRB)::ZRT_UP (YDCPG_OPTS%KLON, YDCPG_OPTS%KFLEVG)
REAL (KIND=JPRB)::ZRV_UP (YDCPG_OPTS%KLON, YDCPG_OPTS%KFLEVG)
REAL (KIND=JPRB)::ZU_UP (YDCPG_OPTS%KLON, YDCPG_OPTS%KFLEVG)

REAL (KIND=JPRB)::ZRC_UP (YDCPG_OPTS%KLON, YDCPG_OPTS%KFLEVG)
REAL (KIND=JPRB)::ZRI_UP (YDCPG_OPTS%KLON, YDCPG_OPTS%KFLEVG)

REAL (KIND=JPRB)::ZW_UP (YDCPG_OPTS%KLON, YDCPG_OPTS%KFLEVG)
REAL (KIND=JPRB)::ZFRAC_UP (YDCPG_OPTS%KLON, YDCPG_OPTS%KFLEVG)
REAL (KIND=JPRB)::ZDPSG (YDCPG_OPTS%KLON, YDCPG_OPTS%KFLEVG)




REAL (KIND=JPRB)::ZQDM (YDCPG_OPTS%KLON, YDCPG_OPTS%KFLEVG)
REAL (KIND=JPRB)::ZTKE (YDCPG_OPTS%KLON, YDCPG_OPTS%KFLEVG)
REAL (KIND=JPRB)::ZU (YDCPG_OPTS%KLON, YDCPG_OPTS%KFLEVG)
REAL (KIND=JPRB)::ZV (YDCPG_OPTS%KLON, YDCPG_OPTS%KFLEVG)
TYPE (DIMPHYEX_T)::D
#include "wrscmr.intfb.h"
#include "arp_shallow_mf_finish.intfb.h"
#include "arp_shallow_mf_shallow_mf.intfb.h"
#include "arp_shallow_mf_init.intfb.h"
#include "arp_shallow_mf_zero.intfb.h"
REAL (KIND=JPHOOK)::ZHOOK_HANDLE
IF (LHOOK) CALL DR_HOOK ('ARP_SHALLOW_MF', 0, ZHOOK_HANDLE)

CALL FILL_DIMPHYEX (D, YDCPG_OPTS%KLON, 1, YDCPG_OPTS%KFLEVG, 0, YDCPG_BNDS%KFDIA)
IKR=5
IKRL=2
IKRI=2
ISV_LGBEG=0
ISV_LGEND=0
ITCOUNT=1
ZINVG=1./YDCST%RG
ZVMD=YDCST%RCPV-YDCST%RCPD


IF (YDCPG_OPTS%NSTEP==0) THEN
  CALL ARP_SHALLOW_MF_ZERO (YDMF_PHYS_SURF)
ENDIF

CALL ARP_SHALLOW_MF_INIT (YDCPG_BNDS, YDCPG_OPTS, YDCST, YDMF_PHYS_SURF, ZINVG, KNLAB, PAPRSF, PDELP,&
& PMF_UP, PQI, PQL, PQLI, PQR, PQS, PQV, PR, PT, PZZ, PZZF, ZDPSG, ZDRTDT_MF, ZDTHLDT_MF, ZDUDT_MF, ZDVDT_MF&
&, ZDZZ, ZEMF, ZEXNER, ZFLXZTHMF, ZFLXZTHVMF, ZFLXZUMF, ZFLXZVMF, ZFRAC_UP, ZHRODJ, ZHRODREF, ZQDM, ZRC_UP&
&, ZRI_UP, ZRM, ZRT_UP, ZRV_UP, ZSFRV, ZSFTH, ZSVM, ZTHETA, ZTHL_UP, ZU_UP, ZW_UP, ZZZ)
CALL ARP_SHALLOW_MF_SHALLOW_MF (D, IKR, IKRI, IKRL, ISV_LGBEG, ISV_LGEND, PTSPHY, YDCPG_OPTS&
&, YDPHYEX, PAPRSF, PNEB, PTKE, PU, PV, ZDRTDT_MF, ZDTHLDT_MF, ZDUDT_MF, ZDVDT_MF, ZDZZ, ZEMF&
&, ZEXNER, ZFLXZTHMF, ZFLXZTHVMF, ZFLXZUMF, ZFLXZVMF, ZFRAC_UP, ZHRODJ, ZHRODREF, ZRC_UP, ZRI_UP&
&, ZRM, ZRT_UP, ZRV_UP, ZSFRV, ZSFTH, ZSVM, ZTHETA, ZTHL_UP, ZU_UP, ZW_UP, ZZZ)


IF (LMUSCLFA) THEN
  CALL WRSCMR (NMUSCLFA,'PEMF_CVPP', ZEMF, YDCPG_OPTS%KLON, YDCPG_OPTS%KFLEVG)
  CALL WRSCMR (NMUSCLFA,'PWUP_CVPP', ZW_UP, YDCPG_OPTS%KLON, YDCPG_OPTS%KFLEVG)
  CALL WRSCMR (NMUSCLFA,'PFRAC_CVPP', ZFRAC_UP, YDCPG_OPTS%KLON, YDCPG_OPTS%KFLEVG)
  CALL WRSCMR (NMUSCLFA,'ZDRTDT_MF', ZDRTDT_MF, YDCPG_OPTS%KLON, YDCPG_OPTS%KFLEVG)
  CALL WRSCMR (NMUSCLFA,'ZDTHLDT_MF', ZDTHLDT_MF, YDCPG_OPTS%KLON, YDCPG_OPTS%KFLEVG)
  CALL WRSCMR (NMUSCLFA,'PNEB_CVPP', PNEB, YDCPG_OPTS%KLON, YDCPG_OPTS%KFLEVG)
ENDIF


CALL ARP_SHALLOW_MF_FINISH (PTSPHY, YDCPG_BNDS, YDCPG_OPTS, YDCST, ZVMD, KNLAB, PCP, PDIFTQ,&
& PDIFTS, PMF_UP, PQLI, PRODTH_CVPP, PSTRTU, PSTRTV, PT, ZDPSG, ZDRTDT_MF, ZDTHLDT_MF, ZDUDT_MF&
&, ZDVDT_MF, ZEMF, ZEXNER, ZFLXZTHVMF, ZHRODREF, ZQDM, ZRC_UP, ZRI_UP, ZRT_UP, ZTHETA)


IF (LMUSCLFA) THEN
  CALL WRSCMR (NMUSCLFA,'PQLI_CVPP', PQLI, YDCPG_OPTS%KLON, YDCPG_OPTS%KFLEVG)
ENDIF


IF (LHOOK) CALL DR_HOOK ('ARP_SHALLOW_MF', 1, ZHOOK_HANDLE)
ENDSUBROUTINE ARP_SHALLOW_MF
