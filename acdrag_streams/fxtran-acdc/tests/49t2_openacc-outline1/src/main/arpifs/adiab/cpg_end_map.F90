SUBROUTINE CPG_END_MAP (YDGEOMETRY, YDMODEL, YDVARS, YDCPG_BNDS, YDCPG_OPTS)

!$ACDC outline1    


!**** *CPG_END_MAP*

!     Author.
!     -------
!      Philippe Marguinaud *METEO-FRANCE*
!      Original : 28-11-2022

USE PARKIND1, ONLY : JPIM, JPRB
USE YOMHOOK, ONLY : DR_HOOK, LHOOK, JPHOOK

USE GEOMETRY_MOD , ONLY : GEOMETRY
USE TYPE_MODEL         , ONLY : MODEL
USE FIELD_VARIABLES_MOD, ONLY : FIELD_VARIABLES
USE CPG_OPTS_TYPE_MOD, ONLY : CPG_BNDS_TYPE, CPG_OPTS_TYPE


IMPLICIT NONE

TYPE(GEOMETRY)        ,INTENT(IN)     :: YDGEOMETRY
TYPE(MODEL)           ,INTENT(IN)     :: YDMODEL
TYPE(FIELD_VARIABLES) ,INTENT(INOUT)  :: YDVARS
TYPE(CPG_BNDS_TYPE)   ,INTENT(IN)     :: YDCPG_BNDS
TYPE(CPG_OPTS_TYPE)   ,INTENT(IN)     :: YDCPG_OPTS

#include "gpmpfc_expl.intfb.h"

INTEGER(KIND=JPIM), PARAMETER :: IFLAG = 1_JPIM
REAL(KIND=JPRB),    PARAMETER :: ZEPS = 100.0_JPRB * TINY (1.0_JPRB)
LOGICAL :: LLSTR

REAL (KIND=JPHOOK) :: ZHOOK_HANDLE

IF (LHOOK) CALL DR_HOOK('CPG_END_MAP',0,ZHOOK_HANDLE)

!*    3.    DIVIDE BY MAPPING FACTOR.
!           -------------------------

LLSTR=(ABS(YDGEOMETRY%YRGEM%RSTRET-1.0_JPRB)>ZEPS)

IF (LLSTR.AND.(.NOT.YDMODEL%YRML_PHY_EC%YREPHY%LAGPHY)) THEN

  CALL GPMPFC_EXPL(YDVARS, YDMODEL%YRML_GCONF, YDMODEL%YRML_DYN%YRDYN, YDMODEL%YRML_DYN%YRDYNA, YDCPG_OPTS, YDCPG_BNDS, IFLAG, YDVARS%GEOMETRY%GM%T0)

ENDIF

IF (LHOOK) CALL DR_HOOK('CPG_END_MAP',1,ZHOOK_HANDLE)

END SUBROUTINE CPG_END_MAP

