SUBROUTINE CPG_END_SFC (YDMODEL, YDCPG_OPTS, YDCPG_BNDS, YDMF_PHYS_SURF, KUPTRA)

!$ACDC pointerparallel    


!**** *CPG_END_SFC*

!     Author.
!     -------
!      Philippe Marguinaud *METEO-FRANCE*
!      Original : 28-11-2022

USE PARKIND1                , ONLY : JPIM
USE YOMHOOK                 , ONLY : DR_HOOK, JPHOOK, LHOOK
USE TYPE_MODEL              , ONLY : MODEL
USE CPG_OPTS_TYPE_MOD       , ONLY : CPG_OPTS_TYPE, CPG_BNDS_TYPE
USE MF_PHYS_SURFACE_TYPE_MOD, ONLY : MF_PHYS_SURF_TYPE


IMPLICIT NONE

TYPE(MODEL)            ,INTENT(IN)    :: YDMODEL
TYPE(CPG_OPTS_TYPE),    INTENT(IN)    :: YDCPG_OPTS
TYPE(CPG_BNDS_TYPE),    INTENT(IN)    :: YDCPG_BNDS
TYPE(MF_PHYS_SURF_TYPE),INTENT(INOUT) :: YDMF_PHYS_SURF
INTEGER(KIND=JPIM)     ,INTENT(IN)    :: KUPTRA

REAL (KIND=JPHOOK) :: ZHOOK_HANDLE

IF (LHOOK) CALL DR_HOOK('CPG_END_SFC',0,ZHOOK_HANDLE)

! NO TIME-STEPPING FOR SURFACE FIELDS IF ADIABATIC CALL OR NHS ITERATION.
!  EXCEPT IN CASE OF ASSIMILATION FOR TAKING INTO ACCOUNT THE NEW TRAJECTORY
!  UPDATED WITH THE LAST INCREMENT (CLS FIELDS ONLY)

IF ((YDMODEL%YRML_DYN%YRDYN%NCURRENT_ITER == 0) .AND. YDCPG_OPTS%LDIAB) THEN

  IF (.NOT.YDCPG_OPTS%LCONFX) THEN  
    IF (YDMODEL%YRML_DYN%YRDYNA%LTWOTL) THEN

!$ACDC PARALLEL, TARGET=UpdateView/OpenMPMethod/OpenACCMethod, NAME=SET0TO1 {

      CALL YDMF_PHYS_SURF%SET0TO1 (YDCPG_OPTS, YDCPG_BNDS)

!$ACDC }

    ELSE

!$ACDC PARALLEL, TARGET=UpdateView/OpenMPMethod/OpenACCMethod, NAME=PHTFILT {

      CALL YDMF_PHYS_SURF%PHTFILT (YDMODEL%YRML_DYN%YRDYN, YDCPG_OPTS, YDCPG_BNDS)

!$ACDC }

    ENDIF
  ELSEIF (YDMODEL%YRML_DYN%YRDYNA%LTWOTL .AND. YDMODEL%YRML_PHY_G%YRDPHY%LDIRCLSMOD .AND. (KUPTRA > 0)) THEN

!$ACDC PARALLEL, TARGET=UpdateView/OpenMPMethod/OpenACCMethod, NAME=GSP_CL_SET0TO1 {

    CALL YDMF_PHYS_SURF%GSP_CL%SET0TO1 (YDCPG_OPTS, YDCPG_BNDS)

!$ACDC }

  ENDIF

ENDIF

IF (LHOOK) CALL DR_HOOK('CPG_END_SFC',1,ZHOOK_HANDLE)

END SUBROUTINE CPG_END_SFC
