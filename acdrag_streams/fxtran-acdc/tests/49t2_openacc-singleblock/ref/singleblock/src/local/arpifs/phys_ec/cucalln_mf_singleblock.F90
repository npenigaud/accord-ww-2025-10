SUBROUTINE CUCALLN_MF_SINGLEBLOCK (PPLDARE, PPLRG, KSTEP, YDTHF, YDCST, YDERAD, YDML_PHY_SLIN, YDML_PHY_EC&
&, YGFL, YDCHEM, YDSPP_CONFIG, YDPERTPAR, KIDIA, KFDIA, KLON, KSMAX, KLEV, PDX, KSPPN2D, LDMCAPEA&
&, LDLAND, LDSLPHY, PTSPHY, PVDIFTS, PTM1, PQM1, PUM1, PVM1, PLITOT, PVERVEL, PQHFL, PAHFS, PAPHM1&
&, PAP, PAPH, PGEO, PGEOH, PGAW, PCUCONVCA, PGP2DSPP, PTENT, PTENQ, PTENU, PTENV, PTENTA, PTENQA,&
& PARPRC, KTOPC, KBASEC, KTYPE, KCBOT, KCTOP, KBOTSC, LDCUM, LDSC, KCBOT_LIG, KCTOP_LIG, LDCUM_LIG&
&, LDSHCV, PLCRIT_AER, PLU, PLUDE, PLUDELI, PSNDE, PMFU, PMFD, PLGLAC, PDIFCQ, PDIFCS, PFHPCL, PFHPCN&
&, PFPLCL, PFPLCN, PLRAIN, PRSUD, PSTRCU, PSTRCV, PFCQLF, PFCQIF, PMFUDE_RATE, PMFDDE_RATE, PCAPE&
&, PWU, PWMEAN, PVDISCU, PDISS, KTRAC, PCM1, PTENC, PSCAV, PSCAV0, LDACC)
USE MODEL_PHYSICS_ECMWF_MOD,ONLY:MODEL_PHYSICS_ECMWF_TYPE
USE MODEL_PHYSICS_SIMPLINEAR_MOD,ONLY:MODEL_PHYSICS_SIMPLINEAR_TYPE
USE YOERAD,ONLY:TERAD
USE YOM_YGFL,ONLY:TYPE_GFLD
USE YOMCHEM,ONLY:TCHEM
USE SPP_MOD,ONLY:TSPP_CONFIG
USE PARKIND1,ONLY:JPIM, JPRB
#ifdef __PGI
USE NVTX, ONLY : NVTXSTARTRANGE, NVTXENDRANGE
#endif
USE YOMCST,ONLY:TCST
USE YOETHF,ONLY:TTHF
USE YOMPERTPAR,ONLY:TPERTPAR
USE FXTRAN_ACDC_STACK_MOD
#include "fxtran_acdc_stack.h"

IMPLICIT NONE


REAL (KIND=JPRB), INTENT (IN)::PPLDARE
REAL (KIND=JPRB), INTENT (IN)::PPLRG
INTEGER (KIND=JPIM), INTENT (IN)::KSTEP
TYPE (TTHF), INTENT (IN)::YDTHF
TYPE (TCST), INTENT (IN)::YDCST
TYPE (TERAD), INTENT (IN)::YDERAD
TYPE (MODEL_PHYSICS_SIMPLINEAR_TYPE), INTENT (IN)::YDML_PHY_SLIN
TYPE (MODEL_PHYSICS_ECMWF_TYPE), INTENT (IN)::YDML_PHY_EC
TYPE (TYPE_GFLD), INTENT (IN)::YGFL
TYPE (TCHEM), INTENT (IN)::YDCHEM
TYPE (TSPP_CONFIG), INTENT (IN)::YDSPP_CONFIG
TYPE (TPERTPAR), INTENT (IN)::YDPERTPAR
INTEGER (KIND=JPIM), INTENT (IN)::KLON
INTEGER (KIND=JPIM), INTENT (IN)::KSMAX
INTEGER (KIND=JPIM), INTENT (IN)::KLEV
INTEGER (KIND=JPIM), INTENT (IN)::KSPPN2D
INTEGER (KIND=JPIM), INTENT (IN)::KTRAC
INTEGER (KIND=JPIM), INTENT (IN)::KIDIA
INTEGER (KIND=JPIM), INTENT (IN)::KFDIA
LOGICAL, INTENT (IN)::LDMCAPEA
LOGICAL, INTENT (IN)::LDLAND (KLON)
LOGICAL, INTENT (IN)::LDSLPHY
REAL (KIND=JPRB), INTENT (IN)::PTSPHY
REAL (KIND=JPRB), INTENT (IN)::PVDIFTS
REAL (KIND=JPRB), INTENT (IN)::PLCRIT_AER (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PTM1 (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PQM1 (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PUM1 (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PVM1 (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PCM1 (KLON, KLEV, KTRAC)
REAL (KIND=JPRB), INTENT (IN)::PLITOT (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PVERVEL (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PQHFL (KLON, KLEV+1)
REAL (KIND=JPRB), INTENT (IN)::PAHFS (KLON, KLEV+1)
REAL (KIND=JPRB), INTENT (IN)::PAPHM1 (KLON, KLEV+1)
REAL (KIND=JPRB), INTENT (IN)::PAP (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PAPH (KLON, KLEV+1)
REAL (KIND=JPRB), INTENT (IN)::PGEO (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PGEOH (KLON, KLEV+1)
REAL (KIND=JPRB), INTENT (INOUT)::PTENT (KLON, KLEV)
REAL (KIND=JPRB), INTENT (INOUT)::PTENQ (KLON, KLEV)
REAL (KIND=JPRB), INTENT (INOUT)::PTENU (KLON, KLEV)
REAL (KIND=JPRB), INTENT (INOUT)::PTENV (KLON, KLEV)
REAL (KIND=JPRB), INTENT (INOUT)::PTENTA (KLON, KLEV)
REAL (KIND=JPRB), INTENT (INOUT)::PTENQA (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PGAW (KLON)
REAL (KIND=JPRB), INTENT (IN)::PCUCONVCA (KLON)
REAL (KIND=JPRB), INTENT (IN)::PGP2DSPP (KLON, KSPPN2D)
REAL (KIND=JPRB), INTENT (IN)::PSCAV (KTRAC)
REAL (KIND=JPRB), INTENT (IN)::PSCAV0 (KTRAC)
REAL (KIND=JPRB), INTENT (IN)::PDX (KLON)
REAL (KIND=JPRB), INTENT (INOUT)::PTENC (KLON, KLEV, KTRAC)
REAL (KIND=JPRB), INTENT (OUT)::PARPRC (KLON)
INTEGER (KIND=JPIM), INTENT (OUT)::KTOPC (KLON)
INTEGER (KIND=JPIM), INTENT (OUT)::KBASEC (KLON)
INTEGER (KIND=JPIM), INTENT (OUT)::KTYPE (KLON)
INTEGER (KIND=JPIM), INTENT (OUT)::KCBOT (KLON)
INTEGER (KIND=JPIM), INTENT (OUT)::KCTOP (KLON)
INTEGER (KIND=JPIM), INTENT (OUT)::KCBOT_LIG (KLON)
INTEGER (KIND=JPIM), INTENT (OUT)::KCTOP_LIG (KLON)
INTEGER (KIND=JPIM), INTENT (OUT)::KBOTSC (KLON)
LOGICAL, INTENT (OUT)::LDCUM (KLON)
LOGICAL, INTENT (OUT)::LDCUM_LIG (KLON)
LOGICAL, INTENT (OUT)::LDSC (KLON)
LOGICAL, INTENT (IN)::LDSHCV (KLON)
REAL (KIND=JPRB), INTENT (OUT)::PLU (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PLUDE (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PLUDELI (KLON, KLEV, 4)
REAL (KIND=JPRB), INTENT (OUT)::PSNDE (KLON, KLEV, 2)
REAL (KIND=JPRB), INTENT (OUT)::PMFU (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PMFD (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PLGLAC (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PDIFCQ (KLON, KLEV+1)
REAL (KIND=JPRB), INTENT (OUT)::PDIFCS (KLON, KLEV+1)
REAL (KIND=JPRB), INTENT (OUT)::PFHPCL (KLON, KLEV+1)
REAL (KIND=JPRB), INTENT (OUT)::PFHPCN (KLON, KLEV+1)
REAL (KIND=JPRB), INTENT (OUT)::PFPLCL (KLON, KLEV+1)
REAL (KIND=JPRB), INTENT (OUT)::PFPLCN (KLON, KLEV+1)
REAL (KIND=JPRB), INTENT (OUT)::PLRAIN (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PRSUD (KLON, KLEV, 2)
REAL (KIND=JPRB), INTENT (OUT)::PSTRCU (KLON, KLEV+1)
REAL (KIND=JPRB), INTENT (OUT)::PSTRCV (KLON, KLEV+1)
REAL (KIND=JPRB), INTENT (OUT)::PFCQLF (KLON, KLEV+1)
REAL (KIND=JPRB), INTENT (OUT)::PFCQIF (KLON, KLEV+1)
REAL (KIND=JPRB), INTENT (OUT)::PMFUDE_RATE (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PMFDDE_RATE (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PCAPE (KLON)
REAL (KIND=JPRB), INTENT (OUT)::PWMEAN (KLON)
REAL (KIND=JPRB), INTENT (OUT)::PVDISCU (KLON)
REAL (KIND=JPRB), INTENT (OUT)::PWU (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PDISS (KLON, KLEV)
LOGICAL, INTENT (IN) :: LDACC
REAL (KIND=JPRB)::ZRAIN (KLON)
REAL (KIND=JPRB)::ZQSAT (KLON, KLEV)
REAL (KIND=JPRB)::ZQU (KLON, KLEV)
REAL (KIND=JPRB)::ZTU (KLON, KLEV)
REAL (KIND=JPRB)::ZVP1 (KLON, KLEV)
REAL (KIND=JPRB)::ZUP1 (KLON, KLEV)
REAL (KIND=JPRB)::ZQP1 (KLON, KLEV)
REAL (KIND=JPRB)::ZTP1 (KLON, KLEV)
REAL (KIND=JPRB)::ZCP1 (KLON, KLEV, KTRAC)
REAL (KIND=JPRB)::ZENTHS (KLON, KLEV)
REAL (KIND=JPRB)::ZENTHD (KLON, KLEV)
REAL (KIND=JPRB)::ZUEA (KLON, KLEV)
REAL (KIND=JPRB)::ZVEA (KLON, KLEV)
REAL (KIND=JPRB)::ZTEA (KLON, KLEV)
REAL (KIND=JPRB)::ZQEA (KLON, KLEV)
REAL (KIND=JPRB)::ZCONDFLN (KLON)
REAL (KIND=JPRB)::ZCONDFLL (KLON)
INTEGER (KIND=JPIM)::JN
INTEGER (KIND=JPIM)::JL
INTEGER (KIND=JPIM)::JK
INTEGER (KIND=JPIM)::IFLAG
REAL (KIND=JPRB)::ZEPS
REAL (KIND=JPRB)::ZGDPH
REAL (KIND=JPRB)::ZCP
LOGICAL::LLTDKMF

#include "cuccdia.intfb.h"
#include "cumastrn.intfb.h"
#include "satur.intfb.h"
#include "fcttre.func.h"
#include "fcttrm.func.h"
TYPE (FXTRAN_ACDC_STACK) :: YLSTACK

!$ACC DATA &
!$ACC&CREATE (ZCONDFLL, ZCONDFLN, ZCP1, ZENTHD, ZENTHS, ZQEA, ZQP1, ZQSAT, ZQU, ZRAIN, &
!$ACC&        ZTEA, ZTP1, ZTU, ZUEA, ZUP1, ZVEA, ZVP1) &
!$ACC&IF (LDACC) &
!$ACC&PRESENT (KBASEC, KBOTSC, KCBOT, KCBOT_LIG, KCTOP, KCTOP_LIG, KTOPC, KTYPE, LDCUM, &
!$ACC&         LDCUM_LIG, LDLAND, LDSC, LDSHCV, PAHFS, PAP, PAPH, PAPHM1, PARPRC, PCAPE, &
!$ACC&         PCM1, PCUCONVCA, PDIFCQ, PDIFCS, PDISS, PDX, PFCQIF, PFCQLF, PFHPCL, &
!$ACC&         PFHPCN, PFPLCL, PFPLCN, PGAW, PGEO, PGEOH, PGP2DSPP, PLCRIT_AER, PLGLAC, &
!$ACC&         PLITOT, PLRAIN, PLU, PLUDE, PLUDELI, PMFD, PMFDDE_RATE, PMFU, PMFUDE_RATE, &
!$ACC&         PQHFL, PQM1, PRSUD, PSNDE, PSTRCU, PSTRCV, PTENC, PTENQ, PTENQA, PTENT, &
!$ACC&         PTENTA, PTENU, PTENV, PTM1, PUM1, PVDISCU, PVERVEL, PVM1, PWMEAN, PWU, &
!$ACC&         YDCHEM, YDCST, YDERAD, YDML_PHY_EC, YDML_PHY_SLIN, YDPERTPAR, YDSPP_CONFIG, &
!$ACC&         YDTHF, YGFL) 

#ifdef __PGI
CALL NVTXSTARTRANGE ('CUCALLN_MF_SINGLEBLOCK')
#endif


!$ACC PARALLEL LOOP GANG VECTOR &
!$ACC&IF (LDACC) &
!$ACC&PRIVATE (JK, JL) 


DO JL = KIDIA, KFDIA

  

  DO JK=1, KLEV
    
    ZQEA (JL, JK)=PTENQ (JL, JK)
    ZTEA (JL, JK)=PTENT (JL, JK)
    ZVEA (JL, JK)=PTENV (JL, JK)
    ZUEA (JL, JK)=PTENU (JL, JK)
    ZENTHD (JL, JK)=0.0_JPRB
    ZENTHS (JL, JK)=0.0_JPRB
  
  ENDDO


  DO JK=1, KLEV+1
    
    PFPLCL (JL, JK)=0.0_JPRB
    PFPLCN (JL, JK)=0.0_JPRB
  
  ENDDO

ENDDO

ZEPS=1.0E-10_JPRB

!$ACC PARALLEL LOOP GANG VECTOR &
!$ACC&IF (LDACC) &
!$ACC&PRIVATE (JK, JL, JN) 


DO JL = KIDIA, KFDIA

  

  DO JK=1, KLEV
    
    ZUP1 (JL, JK)=PUM1 (JL, JK)+PTENU (JL, JK)*PTSPHY
    ZVP1 (JL, JK)=PVM1 (JL, JK)+PTENV (JL, JK)*PTSPHY
    ZTP1 (JL, JK)=PTM1 (JL, JK)+PTENT (JL, JK)*PTSPHY
    ZQP1 (JL, JK)=PQM1 (JL, JK)+PTENQ (JL, JK)*PTSPHY
    ZQSAT (JL, JK)=ZQP1 (JL, JK)

    IF (ZQSAT (JL, JK)<=0.0_JPRB)  THEN
      ZQSAT (JL, JK)=ZEPS
    ENDIF

  
  ENDDO


  IF (LDSLPHY) THEN

    IF (KTRAC>0.AND.YDML_PHY_EC%YREPHY%LMFTRAC) THEN

      DO JN=1, KTRAC

        DO JK=1, KLEV
          
          ZCP1 (JL, JK, JN)=PCM1 (JL, JK, JN)
        
        ENDDO

      ENDDO

    ENDIF

  ELSE

    IF (KTRAC>0.AND.YDML_PHY_EC%YREPHY%LMFTRAC) THEN

      DO JN=1, KTRAC

        DO JK=1, KLEV
          
          ZCP1 (JL, JK, JN)=PCM1 (JL, JK, JN)+PTENC (JL, JK, JN)*PTSPHY
        
        ENDDO

      ENDDO

    ENDIF

  ENDIF

ENDDO

IFLAG=1

!$ACC PARALLEL LOOP GANG VECTOR &
!$ACC&IF (LDACC) &
!$ACC&PRIVATE (JL, YLSTACK) 


DO JL = KIDIA, KFDIA
  YLSTACK%L8 = fxtran_acdc_stack_l8 (YFXTRAN_ACDC_STACK, 1, 1)
  YLSTACK%U8 = fxtran_acdc_stack_u8 (YFXTRAN_ACDC_STACK, 1, 1)
  YLSTACK%L4 = fxtran_acdc_stack_l4 (YFXTRAN_ACDC_STACK, 1, 1)
  YLSTACK%U4 = fxtran_acdc_stack_u4 (YFXTRAN_ACDC_STACK, 1, 1)
  
  CALL SATUR_OPENACC (YDTHF, YDCST, JL, JL, KLON, YDML_PHY_EC%YRECUMF%NJKT2, KLEV&
  &, YDML_PHY_SLIN%YREPHLI%LPHYLIN, PAP, ZTP1, ZQSAT, IFLAG, YDSTACK=YLSTACK)
  
  ZRAIN (JL)=0.0_JPRB
  
ENDDO

LLTDKMF=.TRUE.
CALL CUMASTRN_SINGLEBLOCK (PPLDARE, PPLRG, YDTHF, YDCST, YDML_PHY_SLIN, YDML_PHY_EC, YGFL, YDCHEM&
&, YDSPP_CONFIG, YDPERTPAR, KIDIA, KFDIA, KLON, KLEV, PDX, LLTDKMF, LDMCAPEA, LDLAND, PTSPHY, ZTP1&
&, ZQP1, ZUP1, ZVP1, PLITOT, PVERVEL, ZQSAT, PQHFL, PAHFS, PAP, PAPH, PGEO, PGEOH, PGAW, PCUCONVCA&
&, PGP2DSPP, PTENT, PTENQ, PTENU, PTENV, PTENTA, PTENQA, LDCUM, KTYPE, KCBOT, KCTOP, LDCUM_LIG,&
& KCBOT_LIG, KCTOP_LIG, KBOTSC, LDSC, LDSHCV, PLCRIT_AER, ZTU, ZQU, PLU, PLUDE, PLUDELI, PSNDE,&
& ZENTHD, PFPLCL, PFPLCN, ZRAIN, PLRAIN, PRSUD, PMFU, PMFD, PLGLAC, PMFUDE_RATE, PMFDDE_RATE, PCAPE&
&, PWU, PWMEAN, PVDISCU, PDISS, KTRAC, ZCP1, PTENC, PSCAV, PSCAV0, LDACC=LDACC)

!$ACC PARALLEL LOOP GANG VECTOR &
!$ACC&IF (LDACC) &
!$ACC&PRIVATE (JL, YLSTACK) 


DO JL = KIDIA, KFDIA
  YLSTACK%L8 = fxtran_acdc_stack_l8 (YFXTRAN_ACDC_STACK, 1, 1)
  YLSTACK%U8 = fxtran_acdc_stack_u8 (YFXTRAN_ACDC_STACK, 1, 1)
  YLSTACK%L4 = fxtran_acdc_stack_l4 (YFXTRAN_ACDC_STACK, 1, 1)
  YLSTACK%U4 = fxtran_acdc_stack_u4 (YFXTRAN_ACDC_STACK, 1, 1)
  
  CALL CUCCDIA_OPENACC (YDERAD, YDML_PHY_SLIN%YREPHLI, YDML_PHY_EC%YREPHY, JL, JL, KLON, KLEV, KSTEP&
  &, KCBOT, KCTOP, LDCUM, ZQU, PLU, PMFU, ZRAIN, PARPRC, KTOPC, KBASEC, YDSTACK=YLSTACK)
ENDDO


!$ACC PARALLEL LOOP GANG VECTOR &
!$ACC&IF (LDACC) &
!$ACC&PRIVATE (JK, JL, ZCP, ZGDPH) 


DO JL = KIDIA, KFDIA
  
  
  PDIFCQ (JL, 1)=0.0_JPRB
  PDIFCS (JL, 1)=0.0_JPRB
  PSTRCU (JL, 1)=0.0_JPRB
  PSTRCV (JL, 1)=0.0_JPRB
  PFCQLF (JL, 1)=0.0_JPRB
  PFCQIF (JL, 1)=0.0_JPRB
  PFHPCL (JL, 1)=0.0_JPRB
  PFHPCN (JL, 1)=0.0_JPRB
  PDIFCS (JL, 1)=0.0_JPRB
  PDIFCQ (JL, 1)=0.0_JPRB
  ZCONDFLL (JL)=0.0_JPRB
  ZCONDFLN (JL)=0.0_JPRB

  

  DO JK=1, KLEV
    
    ZGDPH=-YDCST%RG/(PAPHM1 (JL, JK+1)-PAPHM1 (JL, JK))
    ZCP=YDCST%RCPD*(1+YDTHF%RVTMP2*ZQP1 (JL, JK))
    PDIFCS (JL, JK+1)=(PTENT (JL, JK)-ZTEA (JL, JK))/ZGDPH*ZCP+PDIFCS (JL, JK)
    PSTRCU (JL, JK+1)=(PTENU (JL, JK)-ZUEA (JL, JK))/ZGDPH+PSTRCU (JL, JK)
    PSTRCV (JL, JK+1)=(PTENV (JL, JK)-ZVEA (JL, JK))/ZGDPH+PSTRCV (JL, JK)
    PDIFCQ (JL, JK+1)=(PTENQ (JL, JK)-ZQEA (JL, JK))/ZGDPH+PDIFCQ (JL, JK)
  
  ENDDO


  DO JK=1, KLEV
    
    PFHPCL (JL, JK+1)=-PFPLCL (JL, JK+1)*YDCST%RLVTT
    PFHPCN (JL, JK+1)=-PFPLCN (JL, JK+1)*YDCST%RLSTT
    ZCONDFLL (JL)=ZCONDFLL (JL)+PLUDELI (JL, JK, 1)
    ZCONDFLN (JL)=ZCONDFLN (JL)+PLUDELI (JL, JK, 2)
    PDIFCS (JL, JK+1)=PDIFCS (JL, JK+1)-PFHPCL (JL, JK+1)-PFHPCN (JL&
    &, JK+1)+YDCST%RLVTT*ZCONDFLL (JL)+YDCST%RLSTT*ZCONDFLN (JL)
    PDIFCQ (JL, JK+1)=PDIFCQ (JL, JK+1)-PFPLCL (JL, JK+1)-PFPLCN (JL, JK+1)-ZCONDFLL (JL)-ZCONDFLN (JL)
    PFCQLF (JL, JK+1)=ZCONDFLL (JL)
    PFCQIF (JL, JK+1)=ZCONDFLN (JL)
  
  ENDDO

ENDDO


#ifdef __PGI
CALL NVTXENDRANGE ()
#endif
!$ACC END DATA

ENDSUBROUTINE CUCALLN_MF_SINGLEBLOCK
