SUBROUTINE CUDDRAFN_OPENACC (YDCST, YDTHF, YDEPHLI, YDECUMF, KIDIA, KFDIA, KLON&
&, KLEV, LDDRAF, PTENH, PQENH, PQSEN, PGEO, PGEOH, PAPH, PRFL, PTD, PQD, PMFU&
&, PMFD, PMFDS, PMFDQ, PDMFDP, PDMFDE, PMFDDE_RATE, PKINED, YDSTACK)
!$ACC ROUTINE (CUDDRAFN_OPENACC) SEQ
USE YOEPHLI,ONLY:TEPHLI
USE PARKIND1,ONLY:JPIM, JPRB

USE YOMCST,ONLY:TCST
USE YOETHF,ONLY:TTHF
USE YOECUMF,ONLY:TECUMF
#include "fxtran_acdc_stack.h"
USE FXTRAN_ACDC_STACK_MOD
USE FXTRAN_ACDC_ABORT_MOD

IMPLICIT NONE


TYPE (TCST), INTENT (IN)::YDCST
TYPE (TTHF), INTENT (IN)::YDTHF
TYPE (TECUMF), INTENT (IN)::YDECUMF
TYPE (TEPHLI), INTENT (IN)::YDEPHLI
INTEGER (KIND=JPIM), INTENT (IN)::KLON
INTEGER (KIND=JPIM), INTENT (IN)::KLEV
INTEGER (KIND=JPIM), INTENT (IN)::KIDIA
INTEGER (KIND=JPIM), INTENT (IN)::KFDIA
LOGICAL, INTENT (IN)::LDDRAF 
REAL (KIND=JPRB), INTENT (IN)::PTENH 
REAL (KIND=JPRB), INTENT (IN)::PQENH 
REAL (KIND=JPRB), INTENT (IN)::PQSEN 
REAL (KIND=JPRB), INTENT (IN)::PGEO 
REAL (KIND=JPRB), INTENT (IN)::PGEOH 
REAL (KIND=JPRB), INTENT (IN)::PAPH 
REAL (KIND=JPRB), INTENT (INOUT)::PRFL 
REAL (KIND=JPRB), INTENT (INOUT)::PTD 
REAL (KIND=JPRB), INTENT (INOUT)::PQD 
REAL (KIND=JPRB), INTENT (IN)::PMFU 
REAL (KIND=JPRB), INTENT (INOUT)::PMFD 
REAL (KIND=JPRB), INTENT (INOUT)::PMFDS 
REAL (KIND=JPRB), INTENT (INOUT)::PMFDQ 
REAL (KIND=JPRB), INTENT (OUT)::PDMFDP 
REAL (KIND=JPRB), INTENT (OUT)::PDMFDE 
REAL (KIND=JPRB), INTENT (OUT)::PMFDDE_RATE 
REAL (KIND=JPRB), INTENT (OUT)::PKINED 
TYPE(FXTRAN_ACDC_STACK), INTENT (IN) :: YDSTACK

fxtran_acdc_temp (LOGICAL, LDDRAF_PTR, (KLON))
fxtran_acdc_temp (REAL(KIND=JPRB), PTENH_PTR, (KLON, KLEV))
fxtran_acdc_temp (REAL(KIND=JPRB), PQENH_PTR, (KLON, KLEV))
fxtran_acdc_temp (REAL(KIND=JPRB), PQSEN_PTR, (KLON, KLEV))
fxtran_acdc_temp (REAL(KIND=JPRB), PGEO_PTR, (KLON, KLEV))
fxtran_acdc_temp (REAL(KIND=JPRB), PGEOH_PTR, (KLON, KLEV+1))
fxtran_acdc_temp (REAL(KIND=JPRB), PAPH_PTR, (KLON, KLEV+1))
fxtran_acdc_temp (REAL(KIND=JPRB), PRFL_PTR, (KLON))
fxtran_acdc_temp (REAL(KIND=JPRB), PTD_PTR, (KLON, KLEV))
fxtran_acdc_temp (REAL(KIND=JPRB), PQD_PTR, (KLON, KLEV))
fxtran_acdc_temp (REAL(KIND=JPRB), PMFU_PTR, (KLON, KLEV))
fxtran_acdc_temp (REAL(KIND=JPRB), PMFD_PTR, (KLON, KLEV))
fxtran_acdc_temp (REAL(KIND=JPRB), PMFDS_PTR, (KLON, KLEV))
fxtran_acdc_temp (REAL(KIND=JPRB), PMFDQ_PTR, (KLON, KLEV))
fxtran_acdc_temp (REAL(KIND=JPRB), PDMFDP_PTR, (KLON, KLEV))
fxtran_acdc_temp (REAL(KIND=JPRB), PDMFDE_PTR, (KLON, KLEV))
fxtran_acdc_temp (REAL(KIND=JPRB), PMFDDE_RATE_PTR, (KLON, KLEV))
fxtran_acdc_temp (REAL(KIND=JPRB), PKINED_PTR, (KLON, KLEV))

REAL (KIND=JPRB)::ZBUOY 
REAL (KIND=JPRB)::ZOENTR 
REAL (KIND=JPRB)::ZCOND 
REAL (KIND=JPRB)::ZDMFDE 
REAL (KIND=JPRB)::ZDMFEN 
REAL (KIND=JPRB)::ZPH 
LOGICAL::LLO2 
INTEGER (KIND=JPIM)::JL
INTEGER (KIND=JPIM)::JK
INTEGER (KIND=JPIM)::ITOPDE
INTEGER (KIND=JPIM)::IS
INTEGER (KIND=JPIM)::IK
REAL (KIND=JPRB)::ZDKEN
REAL (KIND=JPRB)::ZDKBUO
REAL (KIND=JPRB)::Z_CWDRAG
REAL (KIND=JPRB)::ZFACBUO
REAL (KIND=JPRB)::ZRG
REAL (KIND=JPRB)::ZZENTR
REAL (KIND=JPRB)::ZSEEN
REAL (KIND=JPRB)::ZSDDE
REAL (KIND=JPRB)::ZRAIN
REAL (KIND=JPRB)::ZQEEN
REAL (KIND=JPRB)::ZQDDE
REAL (KIND=JPRB)::ZMFDSK
REAL (KIND=JPRB)::ZMFDQK
REAL (KIND=JPRB)::ZENTR
REAL (KIND=JPRB)::ZDZ
REAL (KIND=JPRB)::ZDMFDP
REAL (KIND=JPRB)::ZBUOYV
REAL (KIND=JPRB)::ZBUOYZ
REAL (KIND=JPRB)::ZBUO

REAL (KIND=JPRB)::ZQP
REAL (KIND=JPRB)::ZTARG
REAL (KIND=JPRB)::ZQSAT
REAL (KIND=JPRB)::ZQMAX
REAL (KIND=JPRB)::ZOEALFA
REAL (KIND=JPRB)::ZFOEEWL
REAL (KIND=JPRB)::ZFOEEWI
REAL (KIND=JPRB)::ZCOR
REAL (KIND=JPRB)::ZCOND1
REAL (KIND=JPRB)::ZCOND_CUADJTQ
REAL (KIND=JPRB)::Z2S
REAL (KIND=JPRB)::Z1S
REAL (KIND=JPRB)::ZF
REAL (KIND=JPRB)::ZI
REAL (KIND=JPRB)::ZL
LOGICAL::LLFLAG 

#include "fcttre.func.h"
#include "cuadjtq.func.h"

fxtran_acdc_assoc (LDDRAF_PTR, LDDRAF)

fxtran_acdc_assoc (PTENH_PTR, PTENH)

fxtran_acdc_assoc (PQENH_PTR, PQENH)

fxtran_acdc_assoc (PQSEN_PTR, PQSEN)

fxtran_acdc_assoc (PGEO_PTR, PGEO)

fxtran_acdc_assoc (PGEOH_PTR, PGEOH)

fxtran_acdc_assoc (PAPH_PTR, PAPH)

fxtran_acdc_assoc (PRFL_PTR, PRFL)

fxtran_acdc_assoc (PTD_PTR, PTD)

fxtran_acdc_assoc (PQD_PTR, PQD)

fxtran_acdc_assoc (PMFU_PTR, PMFU)

fxtran_acdc_assoc (PMFD_PTR, PMFD)

fxtran_acdc_assoc (PMFDS_PTR, PMFDS)

fxtran_acdc_assoc (PMFDQ_PTR, PMFDQ)

fxtran_acdc_assoc (PDMFDP_PTR, PDMFDP)

fxtran_acdc_assoc (PDMFDE_PTR, PDMFDE)

fxtran_acdc_assoc (PMFDDE_RATE_PTR, PMFDDE_RATE)

fxtran_acdc_assoc (PKINED_PTR, PKINED)

JL = KIDIA



ITOPDE=YDECUMF%NJKT3
ZRG=1.0_JPRB/YDCST%RG
ZFACBUO=0.5_JPRB/1.5
Z_CWDRAG=(3._JPRB/8._JPRB)*0.506_JPRB/0.2_JPRB

ZOENTR =0.0_JPRB
ZBUOY =0.0_JPRB
ZDMFEN =0.0_JPRB
ZDMFDE =0.0_JPRB
PDMFDE_PTR (JL,:)=0.0_JPRB
PMFDDE_RATE_PTR (JL,:)=0.0_JPRB
PKINED_PTR (JL,:)=0.0_JPRB


DO JK=3, KLEV
  IS=0
  
  ZPH =PAPH_PTR (JL, JK)
  LLO2 =LDDRAF_PTR (JL).AND.PMFD_PTR (JL, JK-1)<0.0_JPRB

  IF (LLO2 ) THEN
    IS=IS+1
  ENDIF


  

  IF (IS==0)  THEN
    CYCLE
  ENDIF


  

  IF (LLO2 ) THEN
    ZENTR=YDECUMF%ENTRDD*PMFD_PTR (JL, JK-1)*(PGEOH_PTR (JL, JK-1)-PGEOH_PTR (JL, JK))*ZRG
    ZDMFEN =ZENTR
    ZDMFDE =ZENTR
  ENDIF


  

  IF (JK>ITOPDE) THEN

    

    IF (LLO2 ) THEN
      ZDMFEN =0.0_JPRB
      ZDMFDE =PMFD_PTR (JL, ITOPDE)*(PAPH_PTR (JL, JK)-PAPH_PTR (JL&
      &, JK-1))/(PAPH_PTR (JL, KLEV+1)-PAPH_PTR (JL, ITOPDE))
    ENDIF

  
  ENDIF


  IF (JK<=ITOPDE) THEN

    

    IF (LLO2 ) THEN
      ZDZ=-(PGEOH_PTR (JL, JK-1)-PGEOH_PTR (JL, JK))*ZRG
      ZZENTR=ZOENTR *ZDZ*PMFD_PTR (JL, JK-1)
      ZDMFEN =ZDMFEN +ZZENTR
      ZDMFEN =MAX (ZDMFEN , 0.3_JPRB*PMFD_PTR (JL, JK-1))
      ZDMFEN =MAX (ZDMFEN ,-0.75_JPRB*PMFU_PTR (JL, JK)-(PMFD_PTR (JL, JK-1)-ZDMFDE ))
      ZDMFEN =MIN (ZDMFEN , 0.0_JPRB)
    ENDIF

    PDMFDE_PTR (JL, JK)=ZDMFEN -ZDMFDE 
  
  ENDIF


  

  IF (LLO2 ) THEN
    PMFD_PTR (JL, JK)=PMFD_PTR (JL, JK-1)+ZDMFEN -ZDMFDE 
    ZSEEN=(YDCST%RCPD*PTENH_PTR (JL, JK-1)+PGEOH_PTR (JL, JK-1))*ZDMFEN 
    ZQEEN=PQENH_PTR (JL, JK-1)*ZDMFEN 
    ZSDDE=(YDCST%RCPD*PTD_PTR (JL, JK-1)+PGEOH_PTR (JL, JK-1))*ZDMFDE 
    ZQDDE=PQD_PTR (JL, JK-1)*ZDMFDE 
    ZMFDSK=PMFDS_PTR (JL, JK-1)+ZSEEN-ZSDDE
    ZMFDQK=PMFDQ_PTR (JL, JK-1)+ZQEEN-ZQDDE
    PQD_PTR (JL, JK)=ZMFDQK*(1.0_JPRB/MIN (-YDECUMF%RMFCMIN, PMFD_PTR (JL, JK)))
    PTD_PTR (JL, JK)=(ZMFDSK*(1.0_JPRB/MIN (-YDECUMF%RMFCMIN&
    &, PMFD_PTR (JL, JK)))-PGEOH_PTR (JL, JK))/YDCST%RCPD
    PTD_PTR (JL, JK)=MIN (400._JPRB, PTD_PTR (JL, JK))
    PTD_PTR (JL, JK)=MAX (100._JPRB, PTD_PTR (JL, JK))
    ZCOND =PQD_PTR (JL, JK)
  ENDIF

  
  IK=JK
  
  
  ZQMAX=0.5_JPRB

  IF (.NOT.YDEPHLI%LPHYLIN) THEN

    

    

    

    IF (LLO2 ) THEN
      ZQP=1.0_JPRB/ZPH 
      ZQSAT=FOEEWMCU (PTD_PTR (JL, IK))*ZQP
      ZQSAT=MIN (0.5_JPRB, ZQSAT)
      ZCOR=1.0_JPRB/(1.0_JPRB-YDCST%RETV*ZQSAT)
      ZQSAT=ZQSAT*ZCOR
      ZCOND_CUADJTQ=(PQD_PTR (JL, IK)-ZQSAT)/(1.0_JPRB+ZQSAT*ZCOR*FOEDEMCU (PTD_PTR (JL, IK)))
      ZCOND_CUADJTQ=MIN (ZCOND_CUADJTQ, 0.0_JPRB)
      PTD_PTR (JL, IK)=PTD_PTR (JL, IK)+FOELDCPMCU (PTD_PTR (JL, IK))*ZCOND_CUADJTQ
      PQD_PTR (JL, IK)=PQD_PTR (JL, IK)-ZCOND_CUADJTQ
      ZQSAT=FOEEWMCU (PTD_PTR (JL, IK))*ZQP
      ZQSAT=MIN (0.5_JPRB, ZQSAT)
      ZCOR=1.0_JPRB/(1.0_JPRB-YDCST%RETV*ZQSAT)
      ZQSAT=ZQSAT*ZCOR
      ZCOND1=(PQD_PTR (JL, IK)-ZQSAT)/(1.0_JPRB+ZQSAT*ZCOR*FOEDEMCU (PTD_PTR (JL, IK)))

      IF (ZCOND_CUADJTQ==0.0_JPRB)  THEN
        ZCOND1=MIN (ZCOND1, 0.0_JPRB)
      ENDIF

      PTD_PTR (JL, IK)=PTD_PTR (JL, IK)+FOELDCPMCU (PTD_PTR (JL, IK))*ZCOND1
      PQD_PTR (JL, IK)=PQD_PTR (JL, IK)-ZCOND1
    ENDIF

  
  
  
  
  
  
  ELSE

    

    

    

    IF (LLO2 ) THEN
      ZQP=1.0_JPRB/ZPH 
      ZTARG=PTD_PTR (JL, IK)
      ZOEALFA=0.5_JPRB*(TANH (YDEPHLI%RLPAL1*(ZTARG-YDEPHLI%RLPTRC))+1.0_JPRB)
      ZFOEEWL=YDTHF%R2ES*EXP (YDTHF%R3LES*(ZTARG-YDCST%RTT)/(ZTARG-YDTHF%R4LES))
      ZFOEEWI=YDTHF%R2ES*EXP (YDTHF%R3IES*(ZTARG-YDCST%RTT)/(ZTARG-YDTHF%R4IES))
      ZQSAT=ZQP*(ZOEALFA*ZFOEEWL+(1.0_JPRB-ZOEALFA)*ZFOEEWI)
      Z1S=TANH (YDEPHLI%RLPAL2*(ZQSAT-ZQMAX))
      ZQSAT=0.5_JPRB*((1.0_JPRB-Z1S)*ZQSAT+(1.0_JPRB+Z1S)*ZQMAX)
      ZCOR=1.0_JPRB/(1.0_JPRB-YDCST%RETV*ZQSAT)
      ZQSAT=ZQSAT*ZCOR
      Z2S=ZOEALFA*YDTHF%R5ALVCP*(1.0_JPRB/(ZTARG-YDTHF%R4LES)**2)+(1.0_JPRB&
      &-ZOEALFA)*YDTHF%R5ALSCP*(1.0_JPRB/(ZTARG-YDTHF%R4IES)**2)
      ZCOND_CUADJTQ=(PQD_PTR (JL, IK)-ZQSAT)/(1.0_JPRB+ZQSAT*ZCOR*Z2S)
      ZCOND_CUADJTQ=MIN (ZCOND_CUADJTQ, 0.0_JPRB)

      IF (ZCOND_CUADJTQ/=0.0_JPRB) THEN
        PTD_PTR (JL, IK)=PTD_PTR (JL, IK)+(ZOEALFA*YDTHF%RALVDCP&
        &+(1.0_JPRB-ZOEALFA)*YDTHF%RALSDCP)*ZCOND_CUADJTQ
        PQD_PTR (JL, IK)=PQD_PTR (JL, IK)-ZCOND_CUADJTQ
        ZTARG=PTD_PTR (JL, IK)
        ZOEALFA=0.5_JPRB*(TANH (YDEPHLI%RLPAL1*(ZTARG-YDEPHLI%RLPTRC))+1.0_JPRB)
        ZFOEEWL=YDTHF%R2ES*EXP (YDTHF%R3LES*(ZTARG-YDCST%RTT)/(ZTARG-YDTHF%R4LES))
        ZFOEEWI=YDTHF%R2ES*EXP (YDTHF%R3IES*(ZTARG-YDCST%RTT)/(ZTARG-YDTHF%R4IES))
        ZQSAT=ZQP*(ZOEALFA*ZFOEEWL+(1.0_JPRB-ZOEALFA)*ZFOEEWI)
        Z1S=TANH (YDEPHLI%RLPAL2*(ZQSAT-ZQMAX))
        ZQSAT=0.5_JPRB*((1.0_JPRB-Z1S)*ZQSAT+(1.0_JPRB+Z1S)*ZQMAX)
        ZCOR=1.0_JPRB/(1.0_JPRB-YDCST%RETV*ZQSAT)
        ZQSAT=ZQSAT*ZCOR
        Z2S=ZOEALFA*YDTHF%R5ALVCP*(1.0_JPRB/(ZTARG-YDTHF%R4LES)**2)+(1.0_JPRB&
        &-ZOEALFA)*YDTHF%R5ALSCP*(1.0_JPRB/(ZTARG-YDTHF%R4IES)**2)
        ZCOND1=(PQD_PTR (JL, IK)-ZQSAT)/(1.0_JPRB+ZQSAT*ZCOR*Z2S)
        PTD_PTR (JL, IK)=PTD_PTR (JL, IK)+(ZOEALFA*YDTHF%RALVDCP+(1.0_JPRB-ZOEALFA)*YDTHF%RALSDCP)*ZCOND1
        PQD_PTR (JL, IK)=PQD_PTR (JL, IK)-ZCOND1
      ENDIF

    ENDIF

  
  
  
  
  ENDIF


  

  

  

  

  IF (LLO2 ) THEN
    ZCOND =ZCOND -PQD_PTR (JL, JK)
    ZBUO=PTD_PTR (JL, JK)*(1.0_JPRB+YDCST%RETV*PQD_PTR (JL, JK))-PTENH_PTR&
    & (JL, JK)*(1.0_JPRB+YDCST%RETV*PQENH_PTR (JL, JK))

    IF (PRFL_PTR (JL)>0.0_JPRB.AND.PMFU_PTR (JL, JK)>0.0_JPRB) THEN
      ZRAIN=PRFL_PTR (JL)/PMFU_PTR (JL, JK)
      ZBUO=ZBUO-PTD_PTR (JL, JK)*ZRAIN
    ENDIF


    IF (ZBUO>=0.0_JPRB.OR.PRFL_PTR (JL)<=(PMFD_PTR (JL, JK)*ZCOND )) THEN
      PMFD_PTR (JL, JK)=0.0_JPRB
      ZBUO=0.0_JPRB
    ENDIF

    PMFDS_PTR (JL, JK)=(YDCST%RCPD*PTD_PTR (JL, JK)+PGEOH_PTR (JL, JK))*PMFD_PTR (JL, JK)
    PMFDQ_PTR (JL, JK)=PQD_PTR (JL, JK)*PMFD_PTR (JL, JK)
    ZDMFDP=-PMFD_PTR (JL, JK)*ZCOND 
    PDMFDP_PTR (JL, JK-1)=ZDMFDP
    PRFL_PTR (JL)=PRFL_PTR (JL)+ZDMFDP
    ZBUOYZ=ZBUO/PTENH_PTR (JL, JK)
    ZBUOYV=ZBUOYZ
    ZBUOYZ=MIN (ZBUOYZ, 0.0_JPRB)
    ZDZ=-(PGEO_PTR (JL, JK-1)-PGEO_PTR (JL, JK))
    ZBUOY =ZBUOY +ZBUOYZ*ZDZ
    ZOENTR =YDCST%RG*ZBUOYZ*0.5_JPRB/(1.0_JPRB+ZBUOY )
    PMFDDE_RATE_PTR (JL, JK)=-ZDMFDE 
    ZDKBUO=ZDZ*ZBUOYV*ZFACBUO

    IF (ZDMFEN <0.0_JPRB) THEN
      ZDKEN=MIN (1.0_JPRB,(1+Z_CWDRAG)*ZDMFEN /MIN (-YDECUMF%RMFCMIN, PMFD_PTR (JL, JK-1)))
    ELSE
      ZDKEN=MIN (1.0_JPRB,(1+Z_CWDRAG)*ZDMFDE /MIN (-YDECUMF%RMFCMIN, PMFD_PTR (JL, JK-1)))
    ENDIF

    PKINED_PTR (JL, JK)=MAX (0.0_JPRB,(PKINED_PTR (JL, JK-1)*(1-ZDKEN)+ZDKBUO)/(1+ZDKEN))
  ENDIF

  
ENDDO



ENDSUBROUTINE CUDDRAFN_OPENACC
