SUBROUTINE VERDISINT_SINGLEBLOCK (YDVFE, YDCVER, CDOPER, CDBC, KPROMA&
&, KST, KEND, KFLEV, PIN, POUT, POUTS, PINS, KCHUNK, KLOUT, LDACC)
USE PARKIND1,ONLY:JPIM, JPRB, JPRD
USE YOMCVER,ONLY:TCVER
USE YOMHOOK,ONLY:LHOOK, DR_HOOK, JPHOOK
USE YOMLUN,ONLY:NULERR
USE YOMVERT,ONLY:TVFE
USE OML_MOD,ONLY:OML_MAX_THREADS
USE FXTRAN_ACDC_STACK_MOD
#include "fxtran_acdc_stack.h"

IMPLICIT NONE


TYPE (TVFE), TARGET, INTENT (IN)::YDVFE
TYPE (TCVER), INTENT (IN)::YDCVER
CHARACTER (LEN=*), INTENT (IN)::CDOPER
CHARACTER (LEN=2), INTENT (IN)::CDBC
INTEGER (KIND=JPIM), INTENT (IN)::KFLEV
INTEGER (KIND=JPIM), INTENT (IN)::KEND
INTEGER (KIND=JPIM), INTENT (IN)::KST
INTEGER (KIND=JPIM), INTENT (IN)::KPROMA
INTEGER (KIND=JPIM), OPTIONAL, INTENT (IN)::KLOUT
INTEGER (KIND=JPIM), OPTIONAL, INTENT (IN)::KCHUNK
REAL (KIND=JPRB), INTENT (IN)::PIN (KPROMA, 0:KFLEV+1)
REAL (KIND=JPRB), OPTIONAL, INTENT (OUT)::POUTS (KPROMA)
REAL (KIND=JPRB), OPTIONAL, INTENT (OUT)::POUT (KPROMA,*)
REAL (KIND=JPRB), OPTIONAL, INTENT (IN)::PINS (KPROMA)
LOGICAL, INTENT (IN) :: LDACC
LOGICAL::LLVERINT_ON_CPU
CHARACTER (LEN=2)::CLBC
INTEGER (KIND=JPIM)::JCHUNK
INTEGER (KIND=JPIM)::ITYPE
INTEGER (KIND=JPIM)::IEND
INTEGER (KIND=JPIM)::IND
INTEGER (KIND=JPIM)::ILEVOUT
INTEGER (KIND=JPIM)::ILEVIN
REAL (KIND=JPRD), CONTIGUOUS, POINTER::ZOPER (:,:)
REAL (KIND=JPRD)::ZOUTS (KPROMA)
INTEGER (KIND=JPIM)::IMAXTHREADS
REAL (KIND=JPHOOK)::ZHOOK_HANDLE
#include "abor1.intfb.h"
#include "verder.intfb.h"
#include "verint.intfb.h"
#include "verints.intfb.h"
TYPE (FXTRAN_ACDC_STACK) :: YLSTACK
INTEGER :: JROF

!$ACC DATA &
!$ACC&CREATE (ZOUTS) &
!$ACC&IF (LDACC) &
!$ACC&PRESENT (PIN, PINS, POUT, POUTS, YDCVER, YDVFE) 

IF (LHOOK) CALL DR_HOOK ('VERDISINT_SINGLEBLOCK', 0, ZHOOK_HANDLE)

IMAXTHREADS=1


IF (YDCVER%LVFE_ECMWF) THEN

  IF (CDOPER (1:4)/='FDER'.OR.YDCVER%LVFE_NOBC) THEN
    CLBC='XX'
  ELSE
    CLBC='BC'
  ENDIF

ELSE
  CLBC=CDBC
ENDIF


IF (CDOPER (1:4)=='FDER'.OR.CDOPER (1:4)=='DDER') THEN
  ILEVOUT=KFLEV
ELSE
  ILEVOUT=KFLEV+1
ENDIF


IF (CDOPER (1:4)=='IBOT') THEN
  ITYPE=1
ELSE
  ITYPE=0
ENDIF


IF (CDOPER (1:4)=='INGW'.OR.CDOPER (1:4)=='DEGW') THEN
  IND=0
  ILEVIN=KFLEV+1
ELSEIF (CLBC=='XX') THEN
  IND=1
  ILEVIN=KFLEV
ELSE
  IND=0
  ILEVIN=KFLEV+2
ENDIF

IEND=ILEVIN-1+IND

IF (CDOPER (1:4)=='INGW') THEN
  WRITE (0,*)"oper INWG", PRESENT (KLOUT), PRESENT (PINS)
  ZOPER=>YDVFE%RINTGW (:,:)
ELSEIF (ANY (CDOPER (1:4)==(/'ITOP','IBOT'/))) THEN

  IF (CLBC=='XX') THEN
    ZOPER=>YDVFE%RINTE (:,:)
  ELSEIF (CLBC=='00') THEN
    ZOPER=>YDVFE%RINTBF00 (:,:)
  ELSEIF (CLBC=='11') THEN
    ZOPER=>YDVFE%RINTBF11 (:,:)
  ELSE
    WRITE (NULERR,*)'VERDISINT: ITOP/IBOT NOT IMPLEMENTED FOR CDBC=', CLBC
    CALL ABOR1 (' VERDISINT: ABOR1 CALLED')
  ENDIF

ELSEIF (CDOPER=='INTG') THEN
  ZOPER=>YDVFE%RINTG (:,:)
ENDIF


IF (CDOPER (1:4)=='DEGW') THEN
  ZOPER=>YDVFE%RDERGW (:,:)
ELSEIF (CDOPER (1:4)=='HDER') THEN

  IF (CLBC=='00') THEN
    ZOPER=>YDVFE%RDERBH00 (:,:)
  ELSEIF (CLBC=='01') THEN
    ZOPER=>YDVFE%RDERBH01 (:,:)
  ELSE
    WRITE (NULERR,*)'VERDISINT: HDER NOT IMPLEMENTED FOR CDBC=', CLBC
    CALL ABOR1 (' VERDISINT: ABOR1 CALLED')
  ENDIF

ELSEIF (CDOPER (1:4)=='FDER') THEN

  IF (CLBC=='XX') THEN
    ZOPER=>YDVFE%RDERI (:,:)
  ELSEIF (CLBC=='BC') THEN
    ZOPER=>YDVFE%RDERB (:,:)
  ELSEIF (CLBC=='00') THEN
    ZOPER=>YDVFE%RDERBF00 (:,:)
  ELSEIF (CLBC=='01') THEN
    ZOPER=>YDVFE%RDERBF01 (:,:)
  ELSEIF (CLBC=='10') THEN
    ZOPER=>YDVFE%RDERBF10 (:,:)
  ELSEIF (CLBC=='11') THEN
    ZOPER=>YDVFE%RDERBF11 (:,:)
  ELSE
    WRITE (NULERR,*)'VERDISINT: FDER NOT IMPLEMENTED FOR CDBC=', CLBC
    CALL ABOR1 (' VERDISINT: ABOR1 CALLED')
  ENDIF

ELSEIF (CDOPER (1:4)=='DDER') THEN

  IF (CLBC=='XX') THEN
    ZOPER=>YDVFE%RDDERI (:,:)
  ELSEIF (CLBC=='01') THEN
    ZOPER=>YDVFE%RDDERBF01 (:,:)
  ELSE
    WRITE (NULERR,*)'VERDISINT: DDER NOT IMPLEMENTED FOR CDBC=', CLBC
    CALL ABOR1 (' VERDISINT: ABOR1 CALLED')
  ENDIF

ENDIF


IF (ANY (CDOPER (1:4)==(/'INGW','ITOP','IBOT','INTG'/))) THEN

  IF (PRESENT (KCHUNK)) THEN
    JCHUNK=KCHUNK
  ELSE
    JCHUNK=1+(KEND-KST)/IMAXTHREADS
  ENDIF


  IF (.NOT.PRESENT (POUT)) THEN

    IF (.NOT.PRESENT (POUTS))  THEN
      CALL ABOR1 ("ERROR: NEEDS AT LEAST 1 OF POUT/POUTS")
    ENDIF


    IF (ITYPE==1)  THEN
      CALL ABOR1 ("ERROR POUTS: ITYPE=1 NOT POSSIBLE")
    ENDIF


    IF (ILEVOUT==KFLEV)  THEN
      CALL ABOR1 ("ERROR POUTS: DERIVATIVE NOT POSSIBLE")
    ENDIF

    CALL VERINTS_SINGLEBLOCK (KPROMA, KST, KEND, ILEVIN, ILEVOUT&
    &, ZOPER, PIN (:, IND:IEND), ZOUTS, LDACC=LDACC)
    
    !$ACC PARALLEL LOOP GANG VECTOR &
    !$ACC&IF (LDACC) &
    !$ACC&PRIVATE (JROF) 

    

    DO JROF = KST, KEND
      POUTS (JROF)=ZOUTS (JROF)
    ENDDO

  ELSEIF (PRESENT (POUTS)) THEN

    IF (ITYPE==1)  THEN
      CALL ABOR1 ("ERROR KFLEV+1: ITYPE=1 NOT POSSIBLE")
    ENDIF


    IF (PRESENT (PINS))  THEN
      CALL ABOR1 ("ERROR: PINS MEANINGLESS WITH POUTS")
    ENDIF

    CALL VERINTS_SINGLEBLOCK (KPROMA, KST, KEND, ILEVIN, ILEVOUT&
    &, ZOPER, PIN (:, IND:IEND), ZOUTS, LDACC=LDACC)
    
    !$ACC PARALLEL LOOP GANG VECTOR &
    !$ACC&IF (LDACC) &
    !$ACC&PRIVATE (JROF) 

    

    DO JROF = KST, KEND
      POUTS (JROF)=ZOUTS (JROF)
    ENDDO

    CALL VERINT_SINGLEBLOCK (KPROMA, KST, KEND, ILEVIN, ILEVOUT, ZOPER&
    &, PIN (:, IND:IEND), POUT, ITYPE, JCHUNK, ZOUTS, LDACC=LDACC)
  ELSEIF (ITYPE==1) THEN
    CALL VERINTS_SINGLEBLOCK (KPROMA, KST, KEND, ILEVIN, ILEVOUT&
    &, ZOPER, PIN (:, IND:IEND), ZOUTS, LDACC=LDACC)
    CALL VERINT_SINGLEBLOCK (KPROMA, KST, KEND, ILEVIN, ILEVOUT, ZOPER, PIN&
    & (:, IND:IEND), POUT, ITYPE, JCHUNK, ZOUTS, PINS, LDACC=LDACC)
  ELSEIF ((ILEVOUT==KFLEV+1).AND.(.NOT.PRESENT (KLOUT)).AND.(CDOPER (1:4)/='INTG')) THEN

    IF (PRESENT (PINS))  THEN
      CALL ABOR1 ("ERROR: PINS MEANINGLESS WITH POUTS")
    ENDIF

    CALL VERINTS_SINGLEBLOCK (KPROMA, KST, KEND, ILEVIN, ILEVOUT&
    &, ZOPER, PIN (:, IND:IEND), ZOUTS, LDACC=LDACC)
    
    !$ACC PARALLEL LOOP GANG VECTOR &
    !$ACC&IF (LDACC) &
    !$ACC&PRIVATE (JROF) 

    

    DO JROF = KST, KEND
      POUT (JROF, ILEVOUT)=ZOUTS (JROF)
    ENDDO

    CALL VERINT_SINGLEBLOCK (KPROMA, KST, KEND, ILEVIN, ILEVOUT, ZOPER, PIN&
    & (:, IND:IEND), POUT, ITYPE, JCHUNK, ZOUTS, PINS, LDACC=LDACC)
  ELSE
    CALL VERINT_SINGLEBLOCK (KPROMA, KST, KEND, ILEVIN, ILEVOUT, ZOPER,&
    & PIN (:, IND:IEND), POUT, ITYPE, JCHUNK, PINS=PINS, LDACC=LDACC)
  ENDIF

ELSEIF (ANY (CDOPER (1:4)==(/'FDER','HDER','DEGW','DDER'/))) THEN
  CALL VERDER_SINGLEBLOCK (KPROMA, KST, KEND, ILEVIN, ILEVOUT&
  &, ZOPER, PIN (:, IND:IEND), POUT, LDACC=LDACC)
ELSE
  WRITE (NULERR,*)'VERDISINT: UNKNOWN CDOPER=', CDOPER
  CALL ABOR1 (' VERDISINT: ABOR1 CALLED')
ENDIF

IF (LHOOK) CALL DR_HOOK ('VERDISINT_SINGLEBLOCK', 1, ZHOOK_HANDLE)
!$ACC END DATA

ENDSUBROUTINE VERDISINT_SINGLEBLOCK
