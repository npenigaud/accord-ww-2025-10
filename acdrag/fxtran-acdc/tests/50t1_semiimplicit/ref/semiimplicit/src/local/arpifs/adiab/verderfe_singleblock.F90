SUBROUTINE VERDERFE_SINGLEBLOCK (KPROMA, KST, KEND, KFLEV, PDETA_RATIO&
&, PDELPH, PRDELPF, PIN, POUT, PCORR, LD_CHECK_TRIDIAG, LDACC)
USE YOMLUN,ONLY:NULOUT
USE PARKIND1,ONLY:JPIM, JPRB, JPRD
USE YOMHOOK,ONLY:LHOOK, DR_HOOK, JPHOOK
USE FXTRAN_ACDC_STACK_MOD
#include "fxtran_acdc_stack.h"

IMPLICIT NONE


INTEGER (KIND=JPIM), INTENT (IN)::KPROMA
INTEGER (KIND=JPIM), INTENT (IN)::KST
INTEGER (KIND=JPIM), INTENT (IN)::KEND
INTEGER (KIND=JPIM), INTENT (IN)::KFLEV
REAL (KIND=JPRB), INTENT (IN)::PDETA_RATIO (KFLEV)
REAL (KIND=JPRB), INTENT (IN)::PDELPH (KPROMA, KFLEV)
REAL (KIND=JPRB), INTENT (IN)::PRDELPF (KPROMA, 0:KFLEV)
REAL (KIND=JPRB), INTENT (IN)::PIN (KPROMA, 0:KFLEV)
REAL (KIND=JPRB), INTENT (OUT)::POUT (KPROMA, 0:KFLEV)
REAL (KIND=JPRB), INTENT (IN), OPTIONAL::PCORR (KPROMA)
LOGICAL, INTENT (IN), OPTIONAL::LD_CHECK_TRIDIAG
LOGICAL, INTENT (IN) :: LDACC
LOGICAL::LL_CHECK_TRIDIAG
INTEGER (KIND=JPIM)::ILEV
INTEGER (KIND=JPIM)::JROF
INTEGER (KIND=JPIM)::JLEV
REAL (KIND=JPRB)::ZCOR (KPROMA)
REAL (KIND=JPRB)::ZSOL (KPROMA, KFLEV+1)
REAL (KIND=JPRB)::ZRHS (KPROMA, KFLEV+1)
REAL (KIND=JPRB)::ZRES (KPROMA, KFLEV+1)
REAL (KIND=JPRB)::ZM (KPROMA, KFLEV+1,-1:1)
REAL (KIND=JPHOOK)::ZHOOK_HANDLE
#include "tridia2.intfb.h"
TYPE (FXTRAN_ACDC_STACK) :: YLSTACK

!$ACC DATA &
!$ACC&CREATE (ZCOR, ZM, ZRES, ZRHS, ZSOL) &
!$ACC&IF (LDACC) &
!$ACC&PRESENT (PCORR, PDELPH, PIN, POUT, PRDELPF) 

IF (LHOOK) CALL DR_HOOK ('VERDERFE_SINGLEBLOCK', 0, ZHOOK_HANDLE)
LL_CHECK_TRIDIAG=.FALSE.

IF (PRESENT (LD_CHECK_TRIDIAG))  THEN
  LL_CHECK_TRIDIAG=LD_CHECK_TRIDIAG
ENDIF

ILEV=KFLEV+1

!$ACC PARALLEL LOOP GANG VECTOR &
!$ACC&IF (LDACC) &
!$ACC&PRIVATE (JROF) 


DO JROF = KST, KEND
  ZCOR (JROF)=1.0_JPRB
ENDDO


IF (PRESENT (PCORR))  THEN
  
  !$ACC PARALLEL LOOP GANG VECTOR &
  !$ACC&IF (LDACC) &
  !$ACC&PRIVATE (JROF) 

  

  DO JROF = KST, KEND
    ZCOR (JROF)=PCORR (JROF)
  ENDDO

ENDIF


!$ACC PARALLEL LOOP GANG VECTOR &
!$ACC&IF (LDACC) &
!$ACC&PRIVATE (JLEV, JROF) 


DO JROF = KST, KEND

  DO JLEV=1, KFLEV+1
    ZRHS (JROF, JLEV)=PIN (JROF, JLEV-1)
  ENDDO


  DO JLEV=2, KFLEV
    
    ZM (JROF, JLEV, 1)=PRDELPF (JROF, JLEV-1)*((PDELPH (JROF, JLEV)/PDETA_RATIO (JLEV))/6.0_JPRB)
    ZM (JROF, JLEV, 0)=PRDELPF (JROF, JLEV-1)*(((PDELPH (JROF, JLEV-1)/PDETA_RATIO&
    & (JLEV-1))+(PDELPH (JROF, JLEV)/PDETA_RATIO (JLEV)))/3.0_JPRB)
    ZM (JROF, JLEV,-1)=PRDELPF (JROF, JLEV-1)*((PDELPH (JROF, JLEV-1)/PDETA_RATIO (JLEV-1))/6.0_JPRB)
  
  ENDDO

  
  ZM (JROF, 1, 1)=PRDELPF (JROF, 0)*((PDELPH (JROF, 1)/PDETA_RATIO (1))/6.0_JPRB)
  ZM (JROF, 1, 0)=PRDELPF (JROF, 0)*((PDELPH (JROF, 1)/PDETA_RATIO (1))/3.0_JPRB)
  ZM (JROF, KFLEV+1, 0)=PRDELPF (JROF, KFLEV)*((PDELPH (JROF, KFLEV)/PDETA_RATIO (KFLEV))/3.0_JPRB)
  ZM (JROF, KFLEV+1,-1)=PRDELPF (JROF, KFLEV)*(ZCOR (JROF)&
  &*(PDELPH (JROF, KFLEV)/PDETA_RATIO (KFLEV))/6.0_JPRB)
  
ENDDO



CALL TRIDIA2_SINGLEBLOCK (ILEV, KPROMA, KST, KEND, ZM, ZRHS, ZSOL, LDACC=LDACC)

!$ACC PARALLEL LOOP GANG VECTOR &
!$ACC&IF (LDACC) &
!$ACC&PRIVATE (JLEV, JROF) 


DO JROF = KST, KEND

  DO JLEV=0, KFLEV
    POUT (JROF, JLEV)=ZSOL (JROF, JLEV+1)
  ENDDO

ENDDO


IF (LL_CHECK_TRIDIAG) THEN
  
  !$ACC PARALLEL LOOP GANG VECTOR &
  !$ACC&IF (LDACC) &
  !$ACC&PRIVATE (JLEV, JROF) 

  

  DO JROF = KST, KEND

    DO JLEV=2, KFLEV
      
      ZRES (JROF, JLEV)=ZRHS (JROF, JLEV)-(ZM (JROF, JLEV, 0)*ZSOL (JROF, JLEV)+ZM (JROF&
      &, JLEV,-1)*ZSOL (JROF, JLEV-1)+ZM (JROF, JLEV, 1)*ZSOL (JROF, JLEV+1))
    
    ENDDO

    
    ZRES (JROF, 1)=ZRHS (JROF, 1)-(ZM (JROF, 1, 0)*ZSOL (JROF, 1)+ZM (JROF, 1, 1)*ZSOL (JROF, 2))
    ZRES (JROF, KFLEV+1)=ZRHS (JROF, KFLEV+1)-(ZM (JROF, KFLEV+1, 0)*ZSOL&
    & (JROF, KFLEV+1)+ZM (JROF, KFLEV+1,-1)*ZSOL (JROF, KFLEV))
  
  ENDDO

  
  WRITE (NULOUT,'(''* VERDERFE: Tridiag matrix inversion error = '',E14.8)') MAXVAL (ABS (ZRES))
ENDIF

IF (LHOOK) CALL DR_HOOK ('VERDERFE_SINGLEBLOCK', 1, ZHOOK_HANDLE)
!$ACC END DATA

ENDSUBROUTINE VERDERFE_SINGLEBLOCK
