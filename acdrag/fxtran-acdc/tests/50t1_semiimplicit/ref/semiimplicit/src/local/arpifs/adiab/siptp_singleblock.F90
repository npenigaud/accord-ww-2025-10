SUBROUTINE SIPTP_SINGLEBLOCK (YDCST, YDGEOMETRY, YDDYN, YDDYNA&
&, KLON, KLEV, KIDIA, KFDIA, PDH, PDV, PRNH, PT, PSP, LDACC)
USE GEOMETRY_MOD,ONLY:GEOMETRY
USE PARKIND1,ONLY:JPIM, JPRB
USE YOMHOOK,ONLY:LHOOK, DR_HOOK, JPHOOK
USE YOMCST,ONLY:TCST
USE YOMDYN,ONLY:TDYN
USE YOMDYNA,ONLY:TDYNA
USE FXTRAN_ACDC_STACK_MOD
#include "fxtran_acdc_stack.h"

IMPLICIT NONE


TYPE (TCST), INTENT (IN)::YDCST
TYPE (GEOMETRY), INTENT (IN)::YDGEOMETRY
TYPE (TDYN), INTENT (IN)::YDDYN
TYPE (TDYNA), INTENT (IN)::YDDYNA
INTEGER (KIND=JPIM), INTENT (IN)::KLEV
INTEGER (KIND=JPIM), INTENT (IN)::KLON
INTEGER (KIND=JPIM), INTENT (IN)::KIDIA
INTEGER (KIND=JPIM), INTENT (IN)::KFDIA
REAL (KIND=JPRB), INTENT (IN)::PDH (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PDV (KLON, KLEV)
REAL (KIND=JPRB), INTENT (INOUT)::PRNH (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PT (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PSP (KLON)
LOGICAL, INTENT (IN) :: LDACC
INTEGER (KIND=JPIM)::JLEV
INTEGER (KIND=JPIM)::JLON
REAL (KIND=JPRB)::Z3DIVC
REAL (KIND=JPHOOK)::ZHOOK_HANDLE
#include "sitnu.intfb.h"
TYPE (FXTRAN_ACDC_STACK) :: YLSTACK

!$ACC DATA &
!$ACC&IF (LDACC) &
!$ACC&PRESENT (PDH, PDV, PRNH, PSP, PT, YDCST, YDDYN, YDDYNA, YDGEOMETRY) 

IF (LHOOK) CALL DR_HOOK ('SIPTP_SINGLEBLOCK', 0, ZHOOK_HANDLE)
CALL SITNU_SINGLEBLOCK (YDCST, YDGEOMETRY, YDDYN, KLON&
&, KLEV, KIDIA, KFDIA, PDH, PRNH, PSP, LDACC=LDACC)

IF (YDDYNA%LNHEE.AND.(YDDYNA%NTPVAR==1)) THEN
  
  !$ACC PARALLEL LOOP GANG VECTOR &
  !$ACC&IF (LDACC) &
  !$ACC&PRIVATE (JLEV, JLON, Z3DIVC) 

  

  DO JLON = KIDIA, KFDIA

    DO JLEV=1, KLEV
      
      Z3DIVC=(PDH (JLON, JLEV)+PDV (JLON, JLEV))/YDCST%RCVD
      PT (JLON, JLEV)=YDCST%RD*YDDYN%SITRM (JLEV)*Z3DIVC
      PRNH (JLON, JLEV)=YDCST%RCPD*Z3DIVC-YDCST%RCPD*(PRNH (JLON, JLEV)*(1.0_JPRB&
      &+YDGEOMETRY%YRVERT_GEOM%YRCVER%RFAC1))/(YDCST%RD*YDDYN%SITR)
    
    ENDDO

  ENDDO

ELSEIF (YDDYNA%LNHEE.AND.(YDDYNA%NTPVAR==2)) THEN
  
  !$ACC PARALLEL LOOP GANG VECTOR &
  !$ACC&IF (LDACC) &
  !$ACC&PRIVATE (JLEV, JLON, Z3DIVC) 

  

  DO JLON = KIDIA, KFDIA

    DO JLEV=1, KLEV
      
      Z3DIVC=(PDH (JLON, JLEV)+PDV (JLON, JLEV))/YDCST%RCVD
      PT (JLON, JLEV)=YDDYN%SITRM (JLEV)*(-YDCST%RCVD*Z3DIVC+(YDCST&
      &%RCPD/(YDCST%RD*YDDYN%SITR))*PRNH (JLON, JLEV))
      PRNH (JLON, JLEV)=YDCST%RCPD*Z3DIVC-(YDCST%RCPD/(YDCST%RD*YDDYN%SITR))*PRNH (JLON, JLEV)
    
    ENDDO

  ENDDO

ELSEIF ((YDDYNA%LNHHY.OR.YDDYNA%LNHQE).AND.(YDDYNA%NTPVAR==1)) THEN
  
  !$ACC PARALLEL LOOP GANG VECTOR &
  !$ACC&IF (LDACC) &
  !$ACC&PRIVATE (JLEV, JLON, Z3DIVC) 

  

  DO JLON = KIDIA, KFDIA

    DO JLEV=1, KLEV
      
      Z3DIVC=(PDH (JLON, JLEV)+PDV (JLON, JLEV))/YDCST%RCVD
      PT (JLON, JLEV)=YDDYN%SITRM (JLEV)*(YDDYN%RNHQE_DELTAM*YDDYN%RNHHY_DELTAM (JLEV)*YDCST%RD*Z3DIVC&
      &+(1.0_JPRB-YDDYN%RNHQE_DELTAM*YDDYN%RNHHY_DELTAM (JLEV))*(PRNH (JLON, JLEV)/YDDYN%SITR))
      PRNH (JLON, JLEV)=YDDYN%RNHQE_DELTAM*YDDYN%RNHHY_DELTAM (JLEV)*YDCST&
      &%RCPD*((Z3DIVC-(PRNH (JLON, JLEV)/(YDCST%RD*YDDYN%SITR))))
    
    ENDDO

  ENDDO

ELSEIF ((YDDYNA%LNHHY.OR.YDDYNA%LNHQE).AND.(YDDYNA%NTPVAR==2)) THEN
  
  !$ACC PARALLEL LOOP GANG VECTOR &
  !$ACC&IF (LDACC) &
  !$ACC&PRIVATE (JLEV, JLON, Z3DIVC) 

  

  DO JLON = KIDIA, KFDIA

    DO JLEV=1, KLEV
      
      Z3DIVC=(PDH (JLON, JLEV)+PDV (JLON, JLEV))/YDCST%RCVD
      PT (JLON, JLEV)=YDDYN%SITRM (JLEV)*(YDDYN%RNHQE_DELTAM*YDDYN%RNHHY_DELTAM (JLEV)*(&
      &-YDCST%RCVD*Z3DIVC+(YDCST%RCPD/(YDCST%RD*YDDYN%SITR))*PRNH (JLON, JLEV))+(1.0_JPRB&
      &-YDDYN%RNHQE_DELTAM*YDDYN%RNHHY_DELTAM (JLEV))*(PRNH (JLON, JLEV)/YDDYN%SITR))
      PRNH (JLON, JLEV)=YDDYN%RNHQE_DELTAM*YDDYN%RNHHY_DELTAM (JLEV)*YDCST&
      &%RCPD*((Z3DIVC-(PRNH (JLON, JLEV)/(YDCST%RD*YDDYN%SITR))))
    
    ENDDO

  ENDDO

ENDIF

IF (LHOOK) CALL DR_HOOK ('SIPTP_SINGLEBLOCK', 1, ZHOOK_HANDLE)
!$ACC END DATA

ENDSUBROUTINE SIPTP_SINGLEBLOCK
