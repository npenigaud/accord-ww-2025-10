
SUBROUTINE CUASCN_MANYBLOCKS (YDTHF, YDCST, YDEPHLI, YDECLDP, YDECUMF, YDSPP_CONFIG, YGFL, KIDIA&
&, KFDIA, KLON, KLEV, LDTDKMF, PTSPHY, PTENH, PQENH, PUEN, PVEN, PTEN, PQEN, PQSEN, PLITOT, PGEO&
&, PGEOH, PAP, PAPH, PVERVEL, PWUBASE, PGP2DSPP, LDLAND, LDCUM, KTYPE, KLAB, LSCVFLAG, PTU, PQU&
&, PLU, PLRAIN, PMFU, PMFUB, PLGLAC, PMFUS, PMFUQ, PMFUL, PLUDE, PLUDELI, PDMFUP, PLCRIT_AER, PDMFEN&
&, KCBOT, KCTOP, KCTOP0, KDPL, PMFUDE_RATE, PKINEU, PWU, PWMEAN, LDACC, KGPBLKS)
USE PARKIND1,ONLY:JPIM, JPRB
#ifdef __PGI
USE NVTX, ONLY : NVTXSTARTRANGE, NVTXENDRANGE
#endif
USE YOMCST,ONLY:TCST
USE YOETHF,ONLY:TTHF
USE YOECUMF,ONLY:TECUMF
USE YOEPHLI,ONLY:TEPHLI
USE YOECLDP,ONLY:TECLDP
USE YOM_YGFL,ONLY:TYPE_GFLD
USE SPP_MOD,ONLY:TSPP_CONFIG
USE SPP_GEN_MOD,ONLY:SPP_PERT
USE FXTRAN_ACDC_STACK_MOD
USE FXTRAN_ACDC_ABORT_MOD
#include "fxtran_acdc_stack.h"

IMPLICIT NONE


TYPE (TTHF), INTENT (IN)::YDTHF
TYPE (TCST), INTENT (IN)::YDCST
TYPE (TECLDP), INTENT (IN)::YDECLDP
TYPE (TECUMF), INTENT (IN)::YDECUMF
TYPE (TEPHLI), INTENT (IN)::YDEPHLI
TYPE (TSPP_CONFIG), INTENT (IN)::YDSPP_CONFIG
TYPE (TYPE_GFLD), INTENT (IN)::YGFL
INTEGER (KIND=JPIM), INTENT (IN)::KLON
INTEGER (KIND=JPIM), INTENT (IN)::KLEV
INTEGER (KIND=JPIM), INTENT (IN)::KIDIA
INTEGER (KIND=JPIM), INTENT (IN)::KFDIA
REAL (KIND=JPRB), INTENT (IN)::PTSPHY
REAL (KIND=JPRB), INTENT (IN)::PLCRIT_AER (:, :, :) ! (KLON, KLEV)
REAL (KIND=JPRB), INTENT (INOUT)::PTENH (:, :, :) ! (KLON, KLEV)
REAL (KIND=JPRB), INTENT (INOUT)::PQENH (:, :, :) ! (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PUEN (:, :, :) ! (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PVEN (:, :, :) ! (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PTEN (:, :, :) ! (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PQEN (:, :, :) ! (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PQSEN (:, :, :) ! (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PLITOT (:, :, :) ! (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PGEO (:, :, :) ! (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PGEOH (:, :, :) ! (KLON, KLEV+1)
REAL (KIND=JPRB), INTENT (IN)::PAP (:, :, :) ! (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PAPH (:, :, :) ! (KLON, KLEV+1)
REAL (KIND=JPRB), INTENT (IN)::PVERVEL (:, :, :) ! (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PWUBASE (:, :) ! (KLON)
REAL (KIND=JPRB), INTENT (IN)::PGP2DSPP (:, :, :) ! (KLON, YDSPP_CONFIG%SM%NRFTOTAL)
LOGICAL, INTENT (IN)::LDLAND (:, :) ! (KLON)
LOGICAL, INTENT (INOUT)::LDCUM (:, :) ! (KLON)
LOGICAL, INTENT (IN)::LDTDKMF
LOGICAL, INTENT (OUT)::LSCVFLAG (:, :) ! (KLON)
INTEGER (KIND=JPIM), INTENT (INOUT)::KTYPE (:, :) ! (KLON)
INTEGER (KIND=JPIM), INTENT (INOUT)::KLAB (:, :, :) ! (KLON, KLEV)
REAL (KIND=JPRB), INTENT (INOUT)::PTU (:, :, :) ! (KLON, KLEV)
REAL (KIND=JPRB), INTENT (INOUT)::PQU (:, :, :) ! (KLON, KLEV)
REAL (KIND=JPRB), INTENT (INOUT)::PLU (:, :, :) ! (KLON, KLEV)
REAL (KIND=JPRB), INTENT (INOUT)::PLRAIN (:, :, :) ! (KLON, KLEV)
REAL (KIND=JPRB), INTENT (INOUT)::PMFU (:, :, :) ! (KLON, KLEV)
REAL (KIND=JPRB), INTENT (INOUT)::PMFUB (:, :) ! (KLON)
REAL (KIND=JPRB), INTENT (OUT)::PLGLAC (:, :, :) ! (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PMFUS (:, :, :) ! (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PMFUQ (:, :, :) ! (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PMFUL (:, :, :) ! (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PLUDE (:, :, :) ! (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PLUDELI (:, :, :, :) ! (KLON, KLEV, 2)
REAL (KIND=JPRB), INTENT (OUT)::PDMFUP (:, :, :) ! (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PDMFEN (:, :, :) ! (KLON, KLEV)
INTEGER (KIND=JPIM), INTENT (INOUT)::KCBOT (:, :) ! (KLON)
INTEGER (KIND=JPIM), INTENT (OUT)::KCTOP (:, :) ! (KLON)
INTEGER (KIND=JPIM), INTENT (INOUT)::KCTOP0 (:, :) ! (KLON)
INTEGER (KIND=JPIM), INTENT (IN)::KDPL (:, :) ! (KLON)
REAL (KIND=JPRB), INTENT (OUT)::PMFUDE_RATE (:, :, :) ! (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PKINEU (:, :, :) ! (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PWU (:, :, :) ! (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PWMEAN (:, :) ! (KLON)
INTEGER, INTENT (IN) :: KGPBLKS
LOGICAL, INTENT (IN) :: LDACC
REAL (KIND=JPRB)::ZLUOLD (KLON,KGPBLKS)
REAL (KIND=JPRB)::ZBUO (KLON, KLEV,KGPBLKS)
REAL (KIND=JPRB)::ZPRECIP (KLON,KGPBLKS)
REAL (KIND=JPRB)::ZQOLD (KLON,KGPBLKS)
REAL (KIND=JPRB)::ZDMFDE (KLON,KGPBLKS)
REAL (KIND=JPRB)::ZDMFEN (KLON,KGPBLKS)
REAL (KIND=JPRB)::ZDPMEAN (KLON,KGPBLKS)
REAL (KIND=JPRB)::ZPH (KLON,KGPBLKS)
REAL (KIND=JPRB)::ZOENTR (KLON,KGPBLKS)
LOGICAL::LLO3
LOGICAL::LLO1 (KLON,KGPBLKS)
LOGICAL::LLFLAGUV (KLON,KGPBLKS)
LOGICAL::LLFLAG (KLON,KGPBLKS)
INTEGER (KIND=JPIM)::IKB
INTEGER (KIND=JPIM)::JL
INTEGER (KIND=JPIM)::JK
INTEGER (KIND=JPIM)::IS
INTEGER (KIND=JPIM)::IK
INTEGER (KIND=JPIM)::JLL
REAL (KIND=JPRB)::ZGLAC
REAL (KIND=JPRB)::ZOCUDET
REAL (KIND=JPRB)::ZZCO
REAL (KIND=JPRB)::ZVW
REAL (KIND=JPRB)::ZVV
REAL (KIND=JPRB)::ZVI
REAL (KIND=JPRB)::ZSEEN
REAL (KIND=JPRB)::ZSCDE
REAL (KIND=JPRB)::ZROLD
REAL (KIND=JPRB)::ZRNEW
REAL (KIND=JPRB)::ZQUDE
REAL (KIND=JPRB)::ZQEEN
REAL (KIND=JPRB)::ZPRCON
REAL (KIND=JPRB)::ZPRCDGW
REAL (KIND=JPRB)::ZOEALFAP
REAL (KIND=JPRB)::ZOEALFA
REAL (KIND=JPRB)::ZMFUSK
REAL (KIND=JPRB)::ZMFUQK
REAL (KIND=JPRB)::ZMFUN
REAL (KIND=JPRB)::ZMFULK
REAL (KIND=JPRB)::ZMFTEST
REAL (KIND=JPRB)::ZMFMAX
REAL (KIND=JPRB)::ZLNEW
REAL (KIND=JPRB)::ZLEEN
REAL (KIND=JPRB)::ZLCRIT
REAL (KIND=JPRB)::ZKEDKE
REAL (KIND=JPRB)::ZINT
REAL (KIND=JPRB)::ZFACBUO
REAL (KIND=JPRB)::ZFAC
REAL (KIND=JPRB)::ZDT
REAL (KIND=JPRB)::ZORCPD
REAL (KIND=JPRB)::ZRG
REAL (KIND=JPRB)::ZDNOPRC
REAL (KIND=JPRB)::ZDKEN
REAL (KIND=JPRB)::ZDKBUO
REAL (KIND=JPRB)::ZDFI
REAL (KIND=JPRB)::ZD
REAL (KIND=JPRB)::ZCONS2
REAL (KIND=JPRB)::ZCBF
REAL (KIND=JPRB)::ZC
REAL (KIND=JPRB)::ZBUOC
REAL (KIND=JPRB)::ZBE
REAL (KIND=JPRB)::ZBC
REAL (KIND=JPRB)::ZALFAW
REAL (KIND=JPRB)::Z_CWIFRAC
REAL (KIND=JPRB)::Z_CWDRAG
REAL (KIND=JPRB)::Z_CPRC2
REAL (KIND=JPRB)::Z_CLDMAX
REAL (KIND=JPRB)::ZXPRCDGW
REAL (KIND=JPRB)::ZXENTSHALP
REAL (KIND=JPRB)::ZXENTRORG
LOGICAL::LLPERT_RPRCON
LOGICAL::LLPERT_ENTSHALP
LOGICAL::LLPERT_ENTRORG
INTEGER (KIND=JPIM)::IPRPRCON
INTEGER (KIND=JPIM)::IPENTSHALP
INTEGER (KIND=JPIM)::IPENTRORG
INTEGER (KIND=JPIM)::IPN
TYPE (SPP_PERT)::PN1RPRCON
TYPE (SPP_PERT)::PN1ENTSHALP
TYPE (SPP_PERT)::PN1ENTRORG
REAL (KIND=JPRB)::ZXE
REAL (KIND=JPRB)::ZXS
REAL (KIND=JPRB)::ZCHANGE

LOGICAL::LLKLAB (KLON,KGPBLKS)
#include "fcttre.func.h"
REAL (KIND=JPRB)::ZQP
REAL (KIND=JPRB)::ZTARG
REAL (KIND=JPRB)::ZQSAT
REAL (KIND=JPRB)::ZQMAX
REAL (KIND=JPRB)::ZOEALFA_CUADJTQ000
REAL (KIND=JPRB)::ZFOEEWL
REAL (KIND=JPRB)::ZFOEEWI
REAL (KIND=JPRB)::ZCOR
REAL (KIND=JPRB)::ZCOND1
REAL (KIND=JPRB)::ZCOND
REAL (KIND=JPRB)::Z2S
REAL (KIND=JPRB)::Z1S
REAL (KIND=JPRB)::ZF
REAL (KIND=JPRB)::ZI
REAL (KIND=JPRB)::ZL
LOGICAL::LLFLAG_CUADJTQ000 (KLON,KGPBLKS)
#include "abor1.intfb.h"
#include "cuadjtq.func.h"
REAL (KIND=JPRB)::ZOEALFA_CUADJTQ001
LOGICAL::LLFLAG_CUADJTQ001 (KLON,KGPBLKS)
REAL (KIND=JPRB)::ZORCPD_CUBASMCN
REAL (KIND=JPRB)::ZRG_CUBASMCN
REAL (KIND=JPRB)::ZZZMB
LOGICAL::LLO1_CUENTR
LOGICAL::LLPERT_DETRPEN
INTEGER (KIND=JPIM)::IPDETRPEN
INTEGER (KIND=JPIM)::IPN_CUENTR
TYPE (SPP_PERT)::PN1
REAL (KIND=JPRB)::ZXDETRPEN
REAL (KIND=JPRB)::ZRG_CUENTR
REAL (KIND=JPRB)::ZMF
REAL (KIND=JPRB)::ZENTR (KLON,KGPBLKS)
REAL (KIND=JPRB)::ZDZ
TYPE (FXTRAN_ACDC_STACK) :: YLSTACK
INTEGER :: JBLK

!$ACC DATA &
!$ACC&CREATE (LLFLAG, LLFLAGUV, LLFLAG_CUADJTQ000, LLFLAG_CUADJTQ001, LLKLAB, &
!$ACC&        LLO1, ZBUO, ZDMFDE, ZDMFEN, ZDPMEAN, ZENTR, ZLUOLD, ZOENTR, ZPH, ZPRECIP, &
!$ACC&        ZQOLD) &
!$ACC&IF (LDACC) &
!$ACC&PRESENT (KCBOT, KCTOP, KCTOP0, KDPL, KLAB, KTYPE, LDCUM, LDLAND, LSCVFLAG, PAP, &
!$ACC&         PAPH, PDMFEN, PDMFUP, PGEO, PGEOH, PGP2DSPP, PKINEU, PLCRIT_AER, PLGLAC, &
!$ACC&         PLITOT, PLRAIN, PLU, PLUDE, PLUDELI, PMFU, PMFUB, PMFUDE_RATE, PMFUL, &
!$ACC&         PMFUQ, PMFUS, PQEN, PQENH, PQSEN, PQU, PTEN, PTENH, PTU, PUEN, PVEN, PVERVEL, &
!$ACC&         PWMEAN, PWU, PWUBASE, YDCST, YDECLDP, YDECUMF, YDEPHLI, YDSPP_CONFIG, &
!$ACC&         YDTHF, YGFL) 

#ifdef __PGI
CALL NVTXSTARTRANGE ('CUASCN_MANYBLOCKS')
#endif

ZCONS2=YDECUMF%RMFCFL/(YDCST%RG*PTSPHY)
ZRG=1.0_JPRB/YDCST%RG
ZORCPD=1.0_JPRB/YDCST%RCPD
ZFACBUO=0.5_JPRB/1.5
ZPRCDGW=YDECUMF%RPRCON/YDCST%RG
ZDNOPRC=3.E-4_JPRB
Z_CLDMAX=5.E-3_JPRB
Z_CWIFRAC=0.5_JPRB
Z_CPRC2=0.5_JPRB
Z_CWDRAG=(3._JPRB/8._JPRB)*0.506_JPRB/0.2_JPRB

IF (YDECUMF%LMFGLAC) THEN
  ZGLAC=1.0_JPRB
ELSE
  ZGLAC=0.0_JPRB
ENDIF

LLO3=.FALSE.

!$ACC PARALLEL LOOP GANG &
!$ACC&IF (LDACC) &
!$ACC&PRIVATE (JBLK) &
!$ACC&VECTOR_LENGTH (KLON) 


DO JBLK = 1, KGPBLKS
  
  !$ACC LOOP VECTOR &
  !$ACC&PRIVATE (JL, LLPERT_ENTRORG, LLPERT_ENTSHALP, LLPERT_RPRCON) 

  

  DO JL = KIDIA, MERGE (KLON, KFDIA, JBLK < KGPBLKS)
    
    
    ZLUOLD (JL, JBLK)=0.0_JPRB

    IF (.NOT.LDCUM (JL, JBLK)) THEN
      KCBOT (JL, JBLK)=-1
      PMFUB (JL, JBLK)=0.0_JPRB
      PQU (JL, KLEV, JBLK)=0.0_JPRB
      KTYPE (JL, JBLK)=0
    ENDIF

    PWMEAN (JL, JBLK)=0.0_JPRB
    ZDPMEAN (JL, JBLK)=0.0_JPRB
    ZOENTR (JL, JBLK)=0.0_JPRB
    LSCVFLAG (JL, JBLK)=.FALSE.

    IF (KTYPE (JL, JBLK)>1.AND.YDECUMF%LSCVLIQ)  THEN
      LSCVFLAG (JL, JBLK)=.TRUE.
    ENDIF

    
    
    LLPERT_ENTRORG=.FALSE.
    LLPERT_ENTSHALP=.FALSE.
    LLPERT_RPRCON=.FALSE.
    
    
    LLKLAB (JL, JBLK)=.FALSE.

    IF (.NOT.LDCUM (JL, JBLK).OR.KTYPE (JL, JBLK)==3)  THEN
      LLKLAB (JL, JBLK)=.TRUE.
    ENDIF

  
  ENDDO

ENDDO


!$ACC PARALLEL LOOP GANG &
!$ACC&IF (LDACC) &
!$ACC&PRIVATE (JBLK) &
!$ACC&VECTOR_LENGTH (KLON) 


DO JBLK = 1, KGPBLKS
  
  !$ACC LOOP VECTOR &
  !$ACC&PRIVATE (IKB, JK, JL) 

  

  DO JL = KIDIA, MERGE (KLON, KFDIA, JBLK < KGPBLKS)

    

    DO JK=1, KLEV

      

      IF (JK/=KCBOT (JL, JBLK)) THEN
        PLU (JL, JK, JBLK)=0.0_JPRB
      ENDIF

      PKINEU (JL, JK, JBLK)=0.0_JPRB
      
      
      PMFU (JL, JK, JBLK)=0.0_JPRB
      PMFUS (JL, JK, JBLK)=0.0_JPRB
      PMFUQ (JL, JK, JBLK)=0.0_JPRB
      PMFUL (JL, JK, JBLK)=0.0_JPRB
      PWU (JL, JK, JBLK)=0.0_JPRB
      
      
      PLUDE (JL, JK, JBLK)=0.0_JPRB
      PLUDELI (JL, JK, 1, JBLK)=0.0_JPRB
      PLUDELI (JL, JK, 2, JBLK)=0.0_JPRB
      PLGLAC (JL, JK, JBLK)=0.0_JPRB
      PDMFUP (JL, JK, JBLK)=0.0_JPRB
      PLRAIN (JL, JK, JBLK)=0.0_JPRB
      
      
      ZBUO (JL, JK, JBLK)=0.0_JPRB

      IF (LLKLAB (JL, JBLK))  THEN
        KLAB (JL, JK, JBLK)=0
      ENDIF


      IF (.NOT.LDCUM (JL, JBLK).AND.PAPH (JL, JK, JBLK)<4.E4_JPRB)  THEN
        KCTOP0 (JL, JBLK)=JK
      ENDIF

      PDMFEN (JL, JK, JBLK)=0.0_JPRB
      PMFUDE_RATE (JL, JK, JBLK)=0.0_JPRB
    
    ENDDO


    

    IF (KTYPE (JL, JBLK)==3)  THEN
      LDCUM (JL, JBLK)=.FALSE.
    ENDIF

    
    
    KCTOP (JL, JBLK)=KCBOT (JL, JBLK)

    IF (LDCUM (JL, JBLK)) THEN
      IKB=KCBOT (JL, JBLK)
      PKINEU (JL, IKB, JBLK)=0.5*PWUBASE (JL, JBLK)**2
      PMFU (JL, IKB, JBLK)=PMFUB (JL, JBLK)
      PMFUS (JL, IKB, JBLK)=PMFUB (JL, JBLK)*(YDCST%RCPD*PTU (JL, IKB, JBLK)+PGEOH (JL, IKB, JBLK))
      PMFUQ (JL, IKB, JBLK)=PMFUB (JL, JBLK)*PQU (JL, IKB, JBLK)
      PMFUL (JL, IKB, JBLK)=PMFUB (JL, JBLK)*PLU (JL, IKB, JBLK)
    ENDIF

  
  ENDDO

ENDDO


!$ACC PARALLEL LOOP GANG &
!$ACC&IF (LDACC) &
!$ACC&PRIVATE (JBLK) &
!$ACC&VECTOR_LENGTH (KLON) 


DO JBLK = 1, KGPBLKS
  
  !$ACC LOOP VECTOR &
  !$ACC&PRIVATE (IK, IKB, IS, JK, JL, LLO1_CUENTR, LLO3, LLPERT_DETRPEN, Z1S, Z2S, ZALFAW, &
  !$ACC&         ZBC, ZBE, ZBUOC, ZC, ZCBF, ZCHANGE, ZCOND, ZCOND1, ZCOR, ZD, ZDFI, ZDKBUO, &
  !$ACC&         ZDKEN, ZDT, ZDZ, ZF, ZFAC, ZFOEEWI, ZFOEEWL, ZI, ZINT, ZKEDKE, ZL, ZLCRIT, &
  !$ACC&         ZLEEN, ZLNEW, ZMF, ZMFMAX, ZMFTEST, ZMFULK, ZMFUN, ZMFUQK, ZMFUSK, ZOCUDET, &
  !$ACC&         ZOEALFA, ZOEALFAP, ZOEALFA_CUADJTQ001, ZORCPD_CUBASMCN, ZPRCON, &
  !$ACC&         ZQEEN, ZQMAX, ZQP, ZQSAT, ZQUDE, ZRG_CUBASMCN, ZRG_CUENTR, ZRNEW, ZROLD, &
  !$ACC&         ZSCDE, ZSEEN, ZTARG, ZVI, ZVV, ZVW, ZXDETRPEN, ZXE, ZXENTRORG, ZXENTSHALP, &
  !$ACC&         ZXPRCDGW, ZXS, ZZCO, ZZZMB) 

  

  DO JL = KIDIA, MERGE (KLON, KFDIA, JBLK < KGPBLKS)

    

    DO JK=KLEV-1, 3,-1
      IK=JK
      
      
      ZRG_CUBASMCN=1.0_JPRB/YDCST%RG
      ZORCPD_CUBASMCN=1.0_JPRB/YDCST%RCPD

      

      IF (.NOT.LDCUM (JL, JBLK).AND.KLAB (JL, IK+1, JBLK)==0) THEN

        IF (YDECUMF%LMFMID.AND.IK>YDECUMF%NJKT7.AND.PQEN (JL, IK, JBLK)>0.80_JPRB*PQSEN (JL, IK, JBLK)) THEN
          PTU (JL, IK+1, JBLK)=(YDCST%RCPD*PTEN (JL, IK, JBLK)+PGEO &
          &(JL, IK, JBLK)-PGEOH (JL, IK+1, JBLK))*ZORCPD_CUBASMCN
          PQU (JL, IK+1, JBLK)=PQEN (JL, IK, JBLK)
          PLU (JL, IK+1, JBLK)=0.0_JPRB
          ZZZMB=MAX (1.E-6_JPRB,-PVERVEL (JL, IK, JBLK)*ZRG_CUBASMCN)
          ZZZMB=MIN (ZZZMB, YDECUMF%RMFLIA)
          PMFUB (JL, JBLK)=ZZZMB
          PMFU (JL, IK+1, JBLK)=PMFUB (JL, JBLK)
          PMFUS (JL, IK+1, JBLK)=PMFUB (JL, JBLK)*(YDCST%RCPD*PTU (JL, IK+1, JBLK)+PGEOH (JL, IK+1, JBLK))
          PMFUQ (JL, IK+1, JBLK)=PMFUB (JL, JBLK)*PQU (JL, IK+1, JBLK)
          PMFUL (JL, IK+1, JBLK)=0.0_JPRB
          PDMFUP (JL, IK+1, JBLK)=0.0_JPRB
          PLRAIN (JL, IK+1, JBLK)=0.0_JPRB
          KCBOT (JL, JBLK)=IK
          KLAB (JL, IK+1, JBLK)=1
          KTYPE (JL, JBLK)=3
        ENDIF

      ENDIF

      
      
      
      
      IS=0
      
      LLFLAG (JL, JBLK)=.FALSE.
      ZPRECIP (JL, JBLK)=0.0_JPRB
      LLO1 (JL, JBLK)=.FALSE.
      IS=IS+KLAB (JL, JK+1, JBLK)

      IF (KLAB (JL, JK+1, JBLK)==0)  THEN
        KLAB (JL, JK, JBLK)=0
      ENDIF


      IF ((LDCUM (JL, JBLK).AND.KLAB (JL, JK+1, JBLK)==2).OR.(KTYPE&
        & (JL, JBLK)==3.AND.KLAB (JL, JK+1, JBLK)==1)) THEN
        LLFLAG (JL, JBLK)=.TRUE.
      ENDIF


      IF (KLAB (JL, JK+1, JBLK)>0) THEN
        LLFLAGUV (JL, JBLK)=.TRUE.
      ELSE
        LLFLAGUV (JL, JBLK)=.FALSE.
      ENDIF

      ZPH (JL, JBLK)=PAPH (JL, JK, JBLK)

      IF (KTYPE (JL, JBLK)==3.AND.JK==KCBOT (JL, JBLK)) THEN
        ZMFMAX=(PAPH (JL, JK, JBLK)-PAPH (JL, JK-1, JBLK))*ZCONS2

        IF (PMFUB (JL, JBLK)>ZMFMAX) THEN
          ZFAC=ZMFMAX/PMFUB (JL, JBLK)
          PMFU (JL, JK+1, JBLK)=PMFU (JL, JK+1, JBLK)*ZFAC
          PMFUS (JL, JK+1, JBLK)=PMFUS (JL, JK+1, JBLK)*ZFAC
          PMFUQ (JL, JK+1, JBLK)=PMFUQ (JL, JK+1, JBLK)*ZFAC
          PMFUB (JL, JBLK)=ZMFMAX
        ENDIF

      ENDIF


      

      IF (IS>0)  THEN
        LLO3=.TRUE.
      ENDIF

      IK=JK

      

      

      IF (LLO3) THEN
        ZRG_CUENTR=1.0_JPRB/YDCST%RG
        
        LLPERT_DETRPEN=.FALSE.
        
        
        ZDMFEN (JL, JBLK)=0.0_JPRB
        ZDMFDE (JL, JBLK)=0.0_JPRB
        ZENTR (JL, JBLK)=0.0

        

        

        IF (LDCUM (JL, JBLK)) THEN
          ZDZ=(PGEOH (JL, IK, JBLK)-PGEOH (JL, IK+1, JBLK))*ZRG_CUENTR
          ZMF=PMFU (JL, IK+1, JBLK)*ZDZ
          LLO1_CUENTR=IK<KCBOT (JL, JBLK)

          IF (LLO1_CUENTR) THEN
            
            ZXDETRPEN=YDECUMF%DETRPEN
            
            ZDMFEN (JL, JBLK)=ZENTR (JL, JBLK)*ZMF
            ZDMFDE (JL, JBLK)=ZXDETRPEN*ZMF
          ENDIF

        ENDIF

      
      ENDIF


      

      

      

      IF (LLO3) THEN
        
        ZQOLD (JL, JBLK)=0.0_JPRB

        

        

        IF (LLFLAG (JL, JBLK)) THEN
          ZDMFDE (JL, JBLK)=MIN (ZDMFDE (JL, JBLK), 0.75_JPRB*PMFU (JL, JK+1, JBLK))

          IF (JK==KCBOT (JL, JBLK)) THEN
            
            ZXENTRORG=YDECUMF%ENTRORG
            
            ZOENTR (JL, JBLK)=-ZXENTRORG*(MIN (1.0_JPRB, PQEN (JL, JK, JBLK)/PQSEN (JL, JK&
            &, JBLK))-YDECUMF%ENTR_RH)*(PGEOH (JL, JK, JBLK)-PGEOH (JL, JK+1, JBLK))*ZRG
            ZOENTR (JL, JBLK)=MIN (0.4_JPRB, ZOENTR (JL, JBLK))*PMFU (JL, JK+1, JBLK)
          ENDIF


          IF (JK<KCBOT (JL, JBLK)) THEN
            ZMFMAX=(PAPH (JL, JK, JBLK)-PAPH (JL, JK-1, JBLK))*ZCONS2
            ZXS=MAX (PMFU (JL, JK+1, JBLK)-ZMFMAX, 0.0_JPRB)
            PWMEAN (JL, JBLK)=PWMEAN (JL, JBLK)+PKINEU (JL, JK+1&
            &, JBLK)*(PAP (JL, JK+1, JBLK)-PAP (JL, JK, JBLK))
            ZDPMEAN (JL, JBLK)=ZDPMEAN (JL, JBLK)+PAP (JL, JK+1, JBLK)-PAP (JL, JK, JBLK)
            ZDMFEN (JL, JBLK)=ZOENTR (JL, JBLK)

            IF (KTYPE (JL, JBLK)>=2) THEN
              
              ZXENTSHALP=YDECUMF%ENTSHALP
              
              ZDMFEN (JL, JBLK)=ZXENTSHALP*ZDMFEN (JL, JBLK)
              ZDMFDE (JL, JBLK)=ZDMFEN (JL, JBLK)
            ENDIF

            ZDMFDE (JL, JBLK)=ZDMFDE (JL, JBLK)*(1.6_JPRB-MIN (1.0_JPRB&
            &, PQEN (JL, JK, JBLK)/PQSEN (JL, JK, JBLK)))
            ZMFTEST=PMFU (JL, JK+1, JBLK)+ZDMFEN (JL, JBLK)-ZDMFDE (JL, JBLK)
            ZCHANGE=MAX (ZMFTEST-ZMFMAX, 0.0_JPRB)
            ZXE=MAX (ZCHANGE-ZXS, 0.0_JPRB)
            ZDMFEN (JL, JBLK)=ZDMFEN (JL, JBLK)-ZXE
            ZCHANGE=ZCHANGE-ZXE
            ZDMFDE (JL, JBLK)=ZDMFDE (JL, JBLK)+ZCHANGE
          ENDIF

          PDMFEN (JL, JK, JBLK)=ZDMFEN (JL, JBLK)-ZDMFDE (JL, JBLK)
          PMFU (JL, JK, JBLK)=PMFU (JL, JK+1, JBLK)+ZDMFEN (JL, JBLK)-ZDMFDE (JL, JBLK)
          ZQEEN=PQENH (JL, JK+1, JBLK)*ZDMFEN (JL, JBLK)
          ZSEEN=(YDCST%RCPD*PTENH (JL, JK+1, JBLK)+PGEOH (JL, JK+1, JBLK))*ZDMFEN (JL, JBLK)

          IF (PLITOT (JL, JK, JBLK)>YDECLDP%RLMIN) THEN
            ZLEEN=PLITOT (JL, JK, JBLK)*ZDMFEN (JL, JBLK)
          ELSE
            ZLEEN=0.0_JPRB
          ENDIF

          ZSCDE=(YDCST%RCPD*PTU (JL, JK+1, JBLK)+PGEOH (JL, JK+1, JBLK))*ZDMFDE (JL, JBLK)
          ZQUDE=PQU (JL, JK+1, JBLK)*ZDMFDE (JL, JBLK)
          PLUDE (JL, JK, JBLK)=PLU (JL, JK+1, JBLK)*ZDMFDE (JL, JBLK)
          ZMFUSK=PMFUS (JL, JK+1, JBLK)+ZSEEN-ZSCDE
          ZMFUQK=PMFUQ (JL, JK+1, JBLK)+ZQEEN-ZQUDE
          ZMFULK=PMFUL (JL, JK+1, JBLK)+ZLEEN-PLUDE (JL, JK, JBLK)
          ZFAC=1.0_JPRB/MAX (YDECUMF%RMFCMIN, PMFU (JL, JK, JBLK))
          PLU (JL, JK, JBLK)=ZMFULK*ZFAC
          PQU (JL, JK, JBLK)=ZMFUQK*ZFAC
          PTU (JL, JK, JBLK)=(ZMFUSK*ZFAC-PGEOH (JL, JK, JBLK))*ZORCPD
          PTU (JL, JK, JBLK)=MAX (100._JPRB, PTU (JL, JK, JBLK))
          PTU (JL, JK, JBLK)=MIN (400._JPRB, PTU (JL, JK, JBLK))
          ZQOLD (JL, JBLK)=PQU (JL, JK, JBLK)
          PLRAIN (JL, JK, JBLK)=PLRAIN (JL, JK+1, JBLK)*MAX (0.0_JPRB&
          &, PMFU (JL, JK+1, JBLK)-ZDMFDE (JL, JBLK))*ZFAC
          ZLUOLD (JL, JBLK)=PLU (JL, JK, JBLK)
        ENDIF


        

        

        IF (JK>KDPL (JL, JBLK)) THEN
          PTU (JL, JK, JBLK)=PTENH (JL, JK, JBLK)
          PQU (JL, JK, JBLK)=PQENH (JL, JK, JBLK)
          PLU (JL, JK, JBLK)=0.0_JPRB
          ZLUOLD (JL, JBLK)=PLU (JL, JK, JBLK)
        ENDIF

        
        IK=JK

        IF (YDECUMF%LSCVLIQ) THEN
          
          
          ZQMAX=0.5_JPRB

          IF (.NOT.YDEPHLI%LPHYLIN) THEN
            
            LLFLAG_CUADJTQ000 (JL, JBLK)=LLFLAG (JL, JBLK)
            
            
            LLFLAG_CUADJTQ000 (JL, JBLK)=LLFLAG_CUADJTQ000 (JL, JBLK).AND..NOT.LSCVFLAG (JL, JBLK)

            

            

            

            IF (LLFLAG_CUADJTQ000 (JL, JBLK)) THEN
              ZQP=1.0_JPRB/ZPH (JL, JBLK)
              ZL=1.0_JPRB/(PTU (JL, IK, JBLK)-YDTHF%R4LES)
              ZI=1.0_JPRB/(PTU (JL, IK, JBLK)-YDTHF%R4IES)
              ZQSAT=YDTHF%R2ES*(FOEALFCU (PTU (JL, IK, JBLK))*EXP (YDTHF%R3LES*(PTU (JL, IK, JBLK)-YDCST%RTT)*ZL&
              &)+(1.0_JPRB-FOEALFCU (PTU (JL, IK, JBLK)))*EXP (YDTHF%R3IES*(PTU (JL, IK, JBLK)-YDCST%RTT)*ZI))
              ZQSAT=ZQSAT*ZQP
              ZQSAT=MIN (0.5_JPRB, ZQSAT)
              ZCOR=1.0_JPRB-YDCST%RETV*ZQSAT
              ZF=FOEALFCU (PTU (JL, IK, JBLK))*YDTHF%R5ALVCP*ZL**2+(1.0_JPRB&
              &-FOEALFCU (PTU (JL, IK, JBLK)))*YDTHF%R5ALSCP*ZI**2
              ZCOND=(PQU (JL, IK, JBLK)*ZCOR**2-ZQSAT*ZCOR)/(ZCOR**2+ZQSAT*ZF)
              ZCOND=MAX (ZCOND, 0.0_JPRB)
              PTU (JL, IK, JBLK)=PTU (JL, IK, JBLK)+FOELDCPMCU (PTU (JL, IK, JBLK))*ZCOND
              PQU (JL, IK, JBLK)=PQU (JL, IK, JBLK)-ZCOND
              ZL=1.0_JPRB/(PTU (JL, IK, JBLK)-YDTHF%R4LES)
              ZI=1.0_JPRB/(PTU (JL, IK, JBLK)-YDTHF%R4IES)
              ZQSAT=YDTHF%R2ES*(FOEALFCU (PTU (JL, IK, JBLK))*EXP (YDTHF%R3LES*(PTU (JL, IK, JBLK)-YDCST%RTT)*ZL&
              &)+(1.0_JPRB-FOEALFCU (PTU (JL, IK, JBLK)))*EXP (YDTHF%R3IES*(PTU (JL, IK, JBLK)-YDCST%RTT)*ZI))
              ZQSAT=ZQSAT*ZQP
              ZQSAT=FMINJ (0.5_JPRB, ZQSAT)
              ZCOR=1.0_JPRB-YDCST%RETV*ZQSAT
              ZF=FOEALFCU (PTU (JL, IK, JBLK))*YDTHF%R5ALVCP*ZL**2+(1.0_JPRB&
              &-FOEALFCU (PTU (JL, IK, JBLK)))*YDTHF%R5ALSCP*ZI**2
              ZCOND1=(PQU (JL, IK, JBLK)*ZCOR**2-ZQSAT*ZCOR)/(ZCOR**2+ZQSAT*ZF)

              IF (ZCOND==0.0_JPRB)  THEN
                ZCOND1=0.0_JPRB
              ENDIF

              PTU (JL, IK, JBLK)=PTU (JL, IK, JBLK)+FOELDCPMCU (PTU (JL, IK, JBLK))*ZCOND1
              PQU (JL, IK, JBLK)=PQU (JL, IK, JBLK)-ZCOND1
            ENDIF


            

            

            

            IF (LLFLAG (JL, JBLK).AND.LSCVFLAG (JL, JBLK)) THEN
              ZQP=1.0_JPRB/ZPH (JL, JBLK)
              ZL=1.0_JPRB/(PTU (JL, IK, JBLK)-YDTHF%R4LES)
              ZQSAT=YDTHF%R2ES*EXP (YDTHF%R3LES*(PTU (JL, IK, JBLK)-YDCST%RTT)*ZL)
              ZQSAT=ZQSAT*ZQP
              ZQSAT=MIN (0.5_JPRB, ZQSAT)
              ZCOR=1.0_JPRB-YDCST%RETV*ZQSAT
              ZF=YDTHF%R5ALVCP*ZL**2
              ZCOND=(PQU (JL, IK, JBLK)*ZCOR**2-ZQSAT*ZCOR)/(ZCOR**2+ZQSAT*ZF)
              ZCOND=MAX (ZCOND, 0.0_JPRB)
              PTU (JL, IK, JBLK)=PTU (JL, IK, JBLK)+YDTHF%RALVDCP*ZCOND
              PQU (JL, IK, JBLK)=PQU (JL, IK, JBLK)-ZCOND
              ZL=1.0_JPRB/(PTU (JL, IK, JBLK)-YDTHF%R4LES)
              ZQSAT=YDTHF%R2ES*EXP (YDTHF%R3LES*(PTU (JL, IK, JBLK)-YDCST%RTT)*ZL)
              ZQSAT=ZQSAT*ZQP
              ZQSAT=FMINJ (0.5_JPRB, ZQSAT)
              ZCOR=1.0_JPRB-YDCST%RETV*ZQSAT
              ZF=YDTHF%R5ALVCP*ZL**2
              ZCOND1=(PQU (JL, IK, JBLK)*ZCOR**2-ZQSAT*ZCOR)/(ZCOR**2+ZQSAT*ZF)

              IF (ZCOND==0.0_JPRB)  THEN
                ZCOND1=0.0_JPRB
              ENDIF

              PTU (JL, IK, JBLK)=PTU (JL, IK, JBLK)+YDTHF%RALVDCP*ZCOND1
              PQU (JL, IK, JBLK)=PQU (JL, IK, JBLK)-ZCOND1
            ENDIF

          
          
          
          
          
          
          
          
          ELSE
          
          
          
          
          ENDIF

        
        
        
        ELSE
          
          
          ZQMAX=0.5_JPRB

          IF (.NOT.YDEPHLI%LPHYLIN) THEN
            
            LLFLAG_CUADJTQ001 (JL, JBLK)=LLFLAG (JL, JBLK)

            

            

            IF (LLFLAG_CUADJTQ001 (JL, JBLK)) THEN
              ZQP=1.0_JPRB/ZPH (JL, JBLK)
              ZL=1.0_JPRB/(PTU (JL, IK, JBLK)-YDTHF%R4LES)
              ZI=1.0_JPRB/(PTU (JL, IK, JBLK)-YDTHF%R4IES)
              ZQSAT=YDTHF%R2ES*(FOEALFCU (PTU (JL, IK, JBLK))*EXP (YDTHF%R3LES*(PTU (JL, IK, JBLK)-YDCST%RTT)*ZL&
              &)+(1.0_JPRB-FOEALFCU (PTU (JL, IK, JBLK)))*EXP (YDTHF%R3IES*(PTU (JL, IK, JBLK)-YDCST%RTT)*ZI))
              ZQSAT=ZQSAT*ZQP
              ZQSAT=MIN (0.5_JPRB, ZQSAT)
              ZCOR=1.0_JPRB-YDCST%RETV*ZQSAT
              ZF=FOEALFCU (PTU (JL, IK, JBLK))*YDTHF%R5ALVCP*ZL**2+(1.0_JPRB&
              &-FOEALFCU (PTU (JL, IK, JBLK)))*YDTHF%R5ALSCP*ZI**2
              ZCOND=(PQU (JL, IK, JBLK)*ZCOR**2-ZQSAT*ZCOR)/(ZCOR**2+ZQSAT*ZF)
              ZCOND=MAX (ZCOND, 0.0_JPRB)
              PTU (JL, IK, JBLK)=PTU (JL, IK, JBLK)+FOELDCPMCU (PTU (JL, IK, JBLK))*ZCOND
              PQU (JL, IK, JBLK)=PQU (JL, IK, JBLK)-ZCOND
              ZL=1.0_JPRB/(PTU (JL, IK, JBLK)-YDTHF%R4LES)
              ZI=1.0_JPRB/(PTU (JL, IK, JBLK)-YDTHF%R4IES)
              ZQSAT=YDTHF%R2ES*(FOEALFCU (PTU (JL, IK, JBLK))*EXP (YDTHF%R3LES*(PTU (JL, IK, JBLK)-YDCST%RTT)*ZL&
              &)+(1.0_JPRB-FOEALFCU (PTU (JL, IK, JBLK)))*EXP (YDTHF%R3IES*(PTU (JL, IK, JBLK)-YDCST%RTT)*ZI))
              ZQSAT=ZQSAT*ZQP
              ZQSAT=FMINJ (0.5_JPRB, ZQSAT)
              ZCOR=1.0_JPRB-YDCST%RETV*ZQSAT
              ZF=FOEALFCU (PTU (JL, IK, JBLK))*YDTHF%R5ALVCP*ZL**2+(1.0_JPRB&
              &-FOEALFCU (PTU (JL, IK, JBLK)))*YDTHF%R5ALSCP*ZI**2
              ZCOND1=(PQU (JL, IK, JBLK)*ZCOR**2-ZQSAT*ZCOR)/(ZCOR**2+ZQSAT*ZF)

              IF (ZCOND==0.0_JPRB)  THEN
                ZCOND1=0.0_JPRB
              ENDIF

              PTU (JL, IK, JBLK)=PTU (JL, IK, JBLK)+FOELDCPMCU (PTU (JL, IK, JBLK))*ZCOND1
              PQU (JL, IK, JBLK)=PQU (JL, IK, JBLK)-ZCOND1
            ENDIF

          
          
          
          
          
          
          
          
          ELSE

            

            

            IF (LLFLAG (JL, JBLK)) THEN
              ZQP=1.0_JPRB/ZPH (JL, JBLK)
              ZTARG=PTU (JL, IK, JBLK)
              ZOEALFA_CUADJTQ001=0.5_JPRB*(TANH (YDEPHLI%RLPAL1*(ZTARG-YDEPHLI%RLPTRC))+1.0_JPRB)
              ZFOEEWL=YDTHF%R2ES*EXP (YDTHF%R3LES*(ZTARG-YDCST%RTT)/(ZTARG-YDTHF%R4LES))
              ZFOEEWI=YDTHF%R2ES*EXP (YDTHF%R3IES*(ZTARG-YDCST%RTT)/(ZTARG-YDTHF%R4IES))
              ZQSAT=ZQP*(ZOEALFA_CUADJTQ001*ZFOEEWL+(1.0_JPRB-ZOEALFA_CUADJTQ001)*ZFOEEWI)
              Z1S=TANH (YDEPHLI%RLPAL2*(ZQSAT-ZQMAX))
              ZQSAT=0.5_JPRB*((1.0_JPRB-Z1S)*ZQSAT+(1.0_JPRB+Z1S)*ZQMAX)
              ZCOR=1.0_JPRB/(1.0_JPRB-YDCST%RETV*ZQSAT)
              ZQSAT=ZQSAT*ZCOR
              Z2S=ZOEALFA_CUADJTQ001*YDTHF%R5ALVCP*(1.0_JPRB/(ZTARG-YDTHF%R4LES)**2)+(1.0_JPRB&
              &-ZOEALFA_CUADJTQ001)*YDTHF%R5ALSCP*(1.0_JPRB/(ZTARG-YDTHF%R4IES)**2)
              ZCOND=(PQU (JL, IK, JBLK)-ZQSAT)/(1.0_JPRB+ZQSAT*ZCOR*Z2S)
              ZCOND=MAX (ZCOND, 0.0_JPRB)

              IF (ZCOND/=0.0_JPRB) THEN
                PTU (JL, IK, JBLK)=PTU (JL, IK, JBLK)+(ZOEALFA_CUADJTQ001*YDTHF&
                &%RALVDCP+(1.0_JPRB-ZOEALFA_CUADJTQ001)*YDTHF%RALSDCP)*ZCOND
                PQU (JL, IK, JBLK)=PQU (JL, IK, JBLK)-ZCOND
                ZTARG=PTU (JL, IK, JBLK)
                ZOEALFA_CUADJTQ001=0.5_JPRB*(TANH (YDEPHLI%RLPAL1*(ZTARG-YDEPHLI%RLPTRC))+1.0_JPRB)
                ZFOEEWL=YDTHF%R2ES*EXP (YDTHF%R3LES*(ZTARG-YDCST%RTT)/(ZTARG-YDTHF%R4LES))
                ZFOEEWI=YDTHF%R2ES*EXP (YDTHF%R3IES*(ZTARG-YDCST%RTT)/(ZTARG-YDTHF%R4IES))
                ZQSAT=ZQP*(ZOEALFA_CUADJTQ001*ZFOEEWL+(1.0_JPRB-ZOEALFA_CUADJTQ001)*ZFOEEWI)
                Z1S=TANH (YDEPHLI%RLPAL2*(ZQSAT-ZQMAX))
                ZQSAT=0.5_JPRB*((1.0_JPRB-Z1S)*ZQSAT+(1.0_JPRB+Z1S)*ZQMAX)
                ZCOR=1.0_JPRB/(1.0_JPRB-YDCST%RETV*ZQSAT)
                ZQSAT=ZQSAT*ZCOR
                Z2S=ZOEALFA_CUADJTQ001*YDTHF%R5ALVCP*(1.0_JPRB/(ZTARG-YDTHF%R4LES)**2)+(1.0_JPRB&
                &-ZOEALFA_CUADJTQ001)*YDTHF%R5ALSCP*(1.0_JPRB/(ZTARG-YDTHF%R4IES)**2)
                ZCOND1=(PQU (JL, IK, JBLK)-ZQSAT)/(1.0_JPRB+ZQSAT*ZCOR*Z2S)
                PTU (JL, IK, JBLK)=PTU (JL, IK, JBLK)+(ZOEALFA_CUADJTQ001*YDTHF&
                &%RALVDCP+(1.0_JPRB-ZOEALFA_CUADJTQ001)*YDTHF%RALSDCP)*ZCOND1
                PQU (JL, IK, JBLK)=PQU (JL, IK, JBLK)-ZCOND1
              ENDIF

            ENDIF

          
          
          
          
          
          ENDIF

        
        
        
        ENDIF


        IF (YDEPHLI%LPHYLIN) THEN

          

          IF (LLFLAG (JL, JBLK)) THEN

            IF (PQU (JL, JK, JBLK)/=ZQOLD (JL, JBLK)) THEN
              ZOEALFA=MIN (1.0_JPRB, 0.545_JPRB*(TANH (0.17_JPRB*(PTU (JL, JK, JBLK)-YDEPHLI%RLPTRC))+1.0_JPRB))
              ZOEALFAP=MIN (1.0_JPRB, 0.545_JPRB*(TANH (0.17_JPRB*&
              &(PTU (JL, JK+1, JBLK)-YDEPHLI%RLPTRC))+1.0_JPRB))
              PLGLAC (JL, JK, JBLK)=PLU (JL, JK, JBLK)*((1.0_JPRB-ZOEALFA)-(1.0_JPRB-ZOEALFAP))
              ZFAC=0.545_JPRB*(TANH (0.17_JPRB*(PTEN (JL, JK, JBLK)-YDEPHLI%RLPTRC))+1.0_JPRB)
              PLGLAC (JL, JK, JBLK)=PLGLAC (JL, JK, JBLK)+ZFAC*PDMFUP (JL, JK+1, JBLK)/MAX (YDECUMF%RMFCMIN&
              &, PMFU (JL, JK+1, JBLK))*(0.5_JPRB+SIGN (0.5_JPRB, YDCST%RTT-PTEN (JL, JK, JBLK)))*ZGLAC
              PTU (JL, JK, JBLK)=PTU (JL, JK, JBLK)+YDTHF%RALFDCP*PLGLAC (JL, JK, JBLK)
            ENDIF

          ENDIF

        
        ELSE

          

          IF (LLFLAG (JL, JBLK)) THEN

            IF (PQU (JL, JK, JBLK)/=ZQOLD (JL, JBLK)) THEN
              PLGLAC (JL, JK, JBLK)=PLU (JL, JK, JBLK)*((1.0_JPRB-FOEALFCU (PTU&
              & (JL, JK, JBLK)))-(1.0_JPRB-FOEALFCU (PTU (JL, JK+1, JBLK))))

              IF (LSCVFLAG (JL, JBLK))  THEN
                PLGLAC (JL, JK, JBLK)=0.0_JPRB
              ENDIF

              ZFAC=FOEALFCU (PTEN (JL, JK, JBLK))
              PLGLAC (JL, JK, JBLK)=PLGLAC (JL, JK, JBLK)+ZFAC*PDMFUP (JL, JK+1, JBLK)/MAX (YDECUMF%RMFCMIN&
              &, PMFU (JL, JK+1, JBLK))*(0.5_JPRB+SIGN (0.5_JPRB, YDCST%RTT-PTEN (JL, JK, JBLK)))*ZGLAC
              PTU (JL, JK, JBLK)=PTU (JL, JK, JBLK)+YDTHF%RALFDCP*PLGLAC (JL, JK, JBLK)
            ENDIF

          ENDIF

        
        ENDIF


        

        IF (LLFLAG (JL, JBLK)) THEN

          IF (PQU (JL, JK, JBLK)/=ZQOLD (JL, JBLK)) THEN
            KLAB (JL, JK, JBLK)=2
            PLU (JL, JK, JBLK)=PLU (JL, JK, JBLK)+ZQOLD (JL, JBLK)-PQU (JL, JK, JBLK)
            ZBC=PTU (JL, JK, JBLK)*(1.0_JPRB+YDCST%RETV*PQU (JL, JK,&
            & JBLK)-PLU (JL, JK+1, JBLK)-PLRAIN (JL, JK+1, JBLK))
            ZBE=PTENH (JL, JK, JBLK)*(1.0_JPRB+YDCST%RETV*PQENH (JL, JK, JBLK))
            ZBUO (JL, JK, JBLK)=ZBC-ZBE

            IF (KTYPE (JL, JBLK)==3.AND.KLAB (JL, JK+1, JBLK)==1) THEN

              IF (ZBUO (JL, JK, JBLK)>-0.5_JPRB) THEN
                LDCUM (JL, JBLK)=.TRUE.
                KCTOP (JL, JBLK)=JK
                PKINEU (JL, JK, JBLK)=0.5_JPRB
              ELSE
                KLAB (JL, JK, JBLK)=0
                PMFU (JL, JK, JBLK)=0.0_JPRB
                PLUDE (JL, JK, JBLK)=0.0_JPRB
                PLU (JL, JK, JBLK)=0.0_JPRB
              ENDIF

            ENDIF


            IF (KLAB (JL, JK+1, JBLK)==2) THEN

              IF (ZBUO (JL, JK, JBLK)<-0.1_JPRB) THEN
                PTENH (JL, JK, JBLK)=0.5_JPRB*(PTEN (JL, JK, JBLK)+PTEN (JL, JK-1, JBLK))
                PQENH (JL, JK, JBLK)=0.5_JPRB*(PQEN (JL, JK, JBLK)+PQEN (JL, JK-1, JBLK))
                ZBUO (JL, JK, JBLK)=ZBC-PTENH (JL, JK, JBLK)*(1.0_JPRB+YDCST%RETV*PQENH (JL, JK, JBLK))
              ENDIF

              ZBUOC=0.5*(ZBUO (JL, JK, JBLK)+ZBUO (JL, JK+1, JBLK))/(PTENH &
              &(JL, JK, JBLK)*(1.0_JPRB+YDCST%RETV*PQENH (JL, JK, JBLK)))
              ZDKBUO=(PGEOH (JL, JK, JBLK)-PGEOH (JL, JK+1, JBLK))*ZFACBUO*ZBUOC

              IF (ZDMFEN (JL, JBLK)>0.0_JPRB) THEN
                ZDKEN=MIN (1.0_JPRB,(1+Z_CWDRAG)*ZDMFEN (JL, JBLK)/MAX (YDECUMF%RMFCMIN, PMFU (JL, JK+1, JBLK)))
              ELSE
                ZDKEN=MIN (1.0_JPRB,(1+Z_CWDRAG)*ZDMFDE (JL, JBLK)/MAX (YDECUMF%RMFCMIN, PMFU (JL, JK+1, JBLK)))
              ENDIF


              IF (LDTDKMF) THEN
                PKINEU (JL, JK, JBLK)=(PKINEU (JL, JK+1, JBLK)*(1-ZDKEN)+ZDKBUO)/(1+ZDKEN)
                ZBUOC=ZBUO (JL, JK, JBLK)
              ELSE
                PKINEU (JL, JK, JBLK)=MAX (-1.E3_JPRB,(PKINEU (JL, JK+1, JBLK)*(1-ZDKEN)+ZDKBUO)/(1+ZDKEN))
              ENDIF


              IF (ZBUOC<0.0_JPRB) THEN
                ZKEDKE=PKINEU (JL, JK, JBLK)/MAX (1.E-3_JPRB, PKINEU (JL, JK+1, JBLK))
                ZKEDKE=MAX (0.0_JPRB, MIN (1.0_JPRB, ZKEDKE))
                ZOCUDET=(1.6_JPRB-MIN (1.0_JPRB, PQEN (JL, JK, JBLK)/PQSEN (JL, JK, JBLK)))
                ZMFUN=ZOCUDET*SQRT (ZKEDKE)
                ZDMFDE (JL, JBLK)=MAX (ZDMFDE (JL, JBLK), PMFU (JL, JK+1, JBLK)*(1.0_JPRB-ZMFUN))
                PLUDE (JL, JK, JBLK)=PLU (JL, JK+1, JBLK)*ZDMFDE (JL, JBLK)
                PMFU (JL, JK, JBLK)=PMFU (JL, JK+1, JBLK)+ZDMFEN (JL, JBLK)-ZDMFDE (JL, JBLK)
              ENDIF


              IF (ZBUO (JL, JK, JBLK)>-0.2_JPRB) THEN
                IKB=KCBOT (JL, JBLK)
                
                ZXENTRORG=YDECUMF%ENTRORG
                
                ZOENTR (JL, JBLK)=ZXENTRORG*(0.3_JPRB-(MIN (1.0_JPRB, PQEN (JL, JK-1, JBLK)/PQSEN&
                & (JL, JK-1, JBLK))-YDECUMF%ENTR_RH))*(PGEOH (JL, JK-1, JBLK)-PGEOH (JL, JK, JBLK&
                &))*ZRG*MIN (1.0_JPRB, PQSEN (JL, JK, JBLK)/PQSEN (JL, IKB, JBLK))**3
                ZOENTR (JL, JBLK)=MIN (0.4_JPRB, ZOENTR (JL, JBLK))*PMFU (JL, JK, JBLK)
              ELSE
                ZOENTR (JL, JBLK)=0.0_JPRB
              ENDIF


              IF (JK>KDPL (JL, JBLK)) THEN
                PMFU (JL, JK, JBLK)=PMFU (JL, JK+1, JBLK)
                PKINEU (JL, JK, JBLK)=0.5_JPRB
              ENDIF


              IF (PKINEU (JL, JK, JBLK)>0.0_JPRB.AND.PMFU (JL, JK, JBLK)>0.0_JPRB.AND.(ZBUO&
                & (JL, JK, JBLK)>-2._JPRB.OR.(PTEN (JL, JK-1, JBLK)-PTEN (JL, JK, JBLK))/(ZRG&
                &*(PGEO (JL, JK-1, JBLK)-PGEO (JL, JK, JBLK)))<-3.E-3_JPRB)) THEN
                KCTOP (JL, JBLK)=JK
                LLO1 (JL, JBLK)=.TRUE.
              ELSE
                KLAB (JL, JK, JBLK)=0
                PMFU (JL, JK, JBLK)=0.0_JPRB
                PKINEU (JL, JK, JBLK)=0.0_JPRB
                ZDMFDE (JL, JBLK)=PMFU (JL, JK+1, JBLK)
                PLUDE (JL, JK, JBLK)=PLU (JL, JK+1, JBLK)*ZDMFDE (JL, JBLK)
              ENDIF


              IF (PMFU (JL, JK+1, JBLK)>0.0_JPRB) THEN
                PMFUDE_RATE (JL, JK, JBLK)=ZDMFDE (JL, JBLK)
              ENDIF

            ENDIF

          ELSEIF (KTYPE (JL, JBLK)==2.AND.PQU (JL, JK, JBLK)==ZQOLD (JL, JBLK)) THEN
            KLAB (JL, JK, JBLK)=0
            PMFU (JL, JK, JBLK)=0.0_JPRB
            PKINEU (JL, JK, JBLK)=0.0_JPRB
            ZDMFDE (JL, JBLK)=PMFU (JL, JK+1, JBLK)
            PLUDE (JL, JK, JBLK)=PLU (JL, JK+1, JBLK)*ZDMFDE (JL, JBLK)
            PMFUDE_RATE (JL, JK, JBLK)=ZDMFDE (JL, JBLK)
          ENDIF

        ENDIF


        

        

        IF (LLO1 (JL, JBLK)) THEN

          IF (PLU (JL, JK, JBLK)>ZDNOPRC) THEN
            PWU (JL, JK, JBLK)=MIN (15._JPRB, SQRT (2.0_JPRB*MAX (0.5_JPRB, PKINEU (JL, JK+1, JBLK))))

            IF (LDTDKMF) THEN
              ZZCO=FOEALFCU (PTU (JL, JK, JBLK))*1.3_JPRB+(1.0_JPRB-FOEALFCU (PTU (JL, JK, JBLK)))
            ELSE
              ZZCO=1.0_JPRB+0.3_JPRB*FOEALFCU (PTU (JL, JK, JBLK))
            ENDIF

            
            ZXPRCDGW=ZPRCDGW
            
            ZPRCON=ZXPRCDGW/(0.75_JPRB*PWU (JL, JK, JBLK))*ZZCO
            ZDT=MIN (YDTHF%RTBERCU-YDTHF%RTICECU, MAX (YDTHF%RTBERCU-PTU (JL, JK, JBLK), 0.0_JPRB))
            ZCBF=1+Z_CPRC2*SQRT (ZDT)
            ZZCO=ZPRCON*ZCBF

            IF (YGFL%NACTAERO>0) THEN

              IF (YDECLDP%LAERLIQAUTOCP) THEN
                ZALFAW=FOEALFCU (PTU (JL, JK, JBLK))
                ZLCRIT=ZALFAW*PLCRIT_AER (JL, JK, JBLK)+(1.0_JPRB-ZALFAW)*ZDNOPRC
              ELSEIF (YDECLDP%LAERLIQAUTOCPB) THEN
                ZALFAW=FOEALFCU (PTU (JL, JK, JBLK))
                ZLCRIT=ZALFAW*PLCRIT_AER (JL, KCBOT (JL, JBLK), JBLK)+(1.0_JPRB-ZALFAW)*ZDNOPRC
              ELSE
                ZLCRIT=ZDNOPRC/ZCBF
              ENDIF

            ELSE
              ZLCRIT=ZDNOPRC/ZCBF
            ENDIF

            ZDFI=PGEOH (JL, JK, JBLK)-PGEOH (JL, JK+1, JBLK)
            ZC=(PLU (JL, JK, JBLK)-ZLUOLD (JL, JBLK))
            ZD=ZZCO*(1.0_JPRB-EXP (-(PLU (JL, JK, JBLK)/ZLCRIT)**2))*ZDFI
            ZINT=EXP (-ZD)
            ZLNEW=ZLUOLD (JL, JBLK)*ZINT+ZC/ZD*(1.0_JPRB-ZINT)
            ZLNEW=MAX (0.0_JPRB, MIN (PLU (JL, JK, JBLK), ZLNEW))
            ZLNEW=MIN (Z_CLDMAX, ZLNEW)
            ZPRECIP (JL, JBLK)=MAX (0.0_JPRB, ZLUOLD (JL, JBLK)+ZC-ZLNEW)
            PDMFUP (JL, JK, JBLK)=ZPRECIP (JL, JBLK)*PMFU (JL, JK, JBLK)
            PLRAIN (JL, JK, JBLK)=PLRAIN (JL, JK, JBLK)+ZPRECIP (JL, JBLK)
            PLU (JL, JK, JBLK)=ZLNEW
          ENDIF

        ENDIF


        

        IF (YDEPHLI%LPHYLIN) THEN

          

          IF (LLO1 (JL, JBLK)) THEN

            IF (PLRAIN (JL, JK, JBLK)>0.0_JPRB) THEN
              ZVW=21.18_JPRB*PLRAIN (JL, JK, JBLK)**0.2_JPRB
              ZVI=Z_CWIFRAC*ZVW
              ZALFAW=MIN (1.0_JPRB, 0.545_JPRB*(TANH (0.17_JPRB*(PTU (JL, JK, JBLK)-YDEPHLI%RLPTRC))+1.0_JPRB))
              ZVV=ZALFAW*ZVW+(1.0_JPRB-ZALFAW)*ZVI
              ZROLD=PLRAIN (JL, JK, JBLK)-ZPRECIP (JL, JBLK)
              ZC=ZPRECIP (JL, JBLK)
              PWU (JL, JK, JBLK)=MIN (15._JPRB, SQRT (2.0_JPRB*MAX (0.1_JPRB, PKINEU (JL, JK, JBLK))))
              ZD=ZVV/PWU (JL, JK, JBLK)
              ZINT=EXP (-ZD)
              ZRNEW=ZROLD*ZINT+ZC/ZD*(1.0_JPRB-ZINT)
              ZRNEW=MAX (0.0_JPRB, MIN (PLRAIN (JL, JK, JBLK), ZRNEW))
              PLRAIN (JL, JK, JBLK)=ZRNEW
            ENDIF

          ENDIF

        
        ELSE

          

          IF (LLO1 (JL, JBLK)) THEN

            IF (PLRAIN (JL, JK, JBLK)>0.0_JPRB) THEN
              ZVW=21.18_JPRB*PLRAIN (JL, JK, JBLK)**0.2_JPRB
              ZVI=Z_CWIFRAC*ZVW
              ZALFAW=FOEALFCU (PTU (JL, JK, JBLK))

              IF (LSCVFLAG (JL, JBLK))  THEN
                ZALFAW=1.0_JPRB
              ENDIF

              ZVV=ZALFAW*ZVW+(1.0_JPRB-ZALFAW)*ZVI
              ZROLD=PLRAIN (JL, JK, JBLK)-ZPRECIP (JL, JBLK)
              ZC=ZPRECIP (JL, JBLK)
              PWU (JL, JK, JBLK)=MIN (15._JPRB, SQRT (2.0_JPRB*MAX (0.1_JPRB, PKINEU (JL, JK, JBLK))))
              ZD=ZVV/PWU (JL, JK, JBLK)
              ZINT=EXP (-ZD)
              ZRNEW=ZROLD*ZINT+ZC/ZD*(1.0_JPRB-ZINT)
              ZRNEW=MAX (0.0_JPRB, MIN (PLRAIN (JL, JK, JBLK), ZRNEW))
              PLRAIN (JL, JK, JBLK)=ZRNEW
            ENDIF

          ENDIF

        
        ENDIF


        

        IF (LLFLAG (JL, JBLK)) THEN
          PMFUL (JL, JK, JBLK)=PLU (JL, JK, JBLK)*PMFU (JL, JK, JBLK)
          PMFUS (JL, JK, JBLK)=(YDCST%RCPD*PTU (JL, JK, JBLK)+PGEOH (JL, JK, JBLK))*PMFU (JL, JK, JBLK)
          PMFUQ (JL, JK, JBLK)=PQU (JL, JK, JBLK)*PMFU (JL, JK, JBLK)
          ZALFAW=FOEALFCU (PTU (JL, JK, JBLK))

          IF (LSCVFLAG (JL, JBLK))  THEN
            ZALFAW=1.0_JPRB
          ENDIF

          PLUDELI (JL, JK, 1, JBLK)=ZALFAW*PLUDE (JL, JK, JBLK)
          PLUDELI (JL, JK, 2, JBLK)=(1.0_JPRB-ZALFAW)*PLUDE (JL, JK, JBLK)
        ENDIF

      
      ENDIF

    ENDDO

  ENDDO

ENDDO


!$ACC PARALLEL LOOP GANG &
!$ACC&IF (LDACC) &
!$ACC&PRIVATE (JBLK) &
!$ACC&VECTOR_LENGTH (KLON) 


DO JBLK = 1, KGPBLKS
  
  !$ACC LOOP VECTOR &
  !$ACC&PRIVATE (JL) 

  

  DO JL = KIDIA, MERGE (KLON, KFDIA, JBLK < KGPBLKS)

    

    

    IF (KCTOP (JL, JBLK)==-1)  THEN
      LDCUM (JL, JBLK)=.FALSE.
    ENDIF

    KCBOT (JL, JBLK)=MAX (KCBOT (JL, JBLK), KCTOP (JL, JBLK))

    IF (LDCUM (JL, JBLK)) THEN
      PWMEAN (JL, JBLK)=MAX (1.E-2_JPRB, PWMEAN (JL, JBLK)/MAX (1.0_JPRB, ZDPMEAN (JL, JBLK)))
      PWMEAN (JL, JBLK)=SQRT (2.0_JPRB*PWMEAN (JL, JBLK))
    ENDIF

  
  ENDDO

ENDDO


#ifdef __PGI
CALL NVTXENDRANGE ()
#endif
!$ACC END DATA

ENDSUBROUTINE CUASCN_MANYBLOCKS
