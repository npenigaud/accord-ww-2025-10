SUBROUTINE LATTEX (YDCST, YDGEOMETRY, YDVARS, YDCPG_TND, YDCPG_SL1, YDCPG_SL2, YDCPG_BNDS,&
& YDCPG_OPTS, YDLDDH, YDMDDH, YDML_GCONF, YDML_DYN, PDTS2, PBT, PBDT, PESGP, PESGM, POROGL&
&, POROGM, PHIF0, PGAGT0L, PGAGT0M, PTOD0, PSPDS0, PLPD0, PGAGT9L, PGAGT9M, PTOD9, PSPDS9,&
& PLPD9, PRDELP, PEVEL, PNHXT0, PGWT0, PGWFT0, PNHXT9, PGWT9, PMIXNL, YDCPG_TNDSI_DDH)
USE MODEL_DYNAMICS_MOD,ONLY:MODEL_DYNAMICS_TYPE
USE MODEL_GENERAL_CONF_MOD,ONLY:MODEL_GENERAL_CONF_TYPE
USE GEOMETRY_MOD,ONLY:GEOMETRY
USE PARKIND1,ONLY:JPIM, JPRB
USE YOMHOOK,ONLY:LHOOK, DR_HOOK, JPHOOK
USE YOMCST,ONLY:TCST
USE YOMMDDH,ONLY:TMDDH
USE YOMLDDH,ONLY:TLDDH
USE FIELD_VARIABLES_MOD,ONLY:FIELD_VARIABLES
USE CPG_OPTS_TYPE_MOD,ONLY:CPG_BNDS_TYPE, CPG_OPTS_TYPE
USE CPG_TYPE_MOD,ONLY:CPG_TND_TYPE
USE CPG_SL1_TYPE_MOD,ONLY:CPG_SL1B_TYPE
USE CPG_SL2_TYPE_MOD,ONLY:CPG_SL2_TYPE
USE CPG_DDH_TND_TYPE_MOD,ONLY:CPG_TNDSI_DDH_TYPE

IMPLICIT NONE


TYPE (TCST), INTENT (IN)::YDCST
TYPE (GEOMETRY), INTENT (IN)::YDGEOMETRY
TYPE (FIELD_VARIABLES), INTENT (INOUT)::YDVARS
TYPE (CPG_TND_TYPE), INTENT (INOUT)::YDCPG_TND
TYPE (CPG_SL1B_TYPE), INTENT (INOUT)::YDCPG_SL1
TYPE (CPG_SL2_TYPE), INTENT (INOUT)::YDCPG_SL2
TYPE (CPG_BNDS_TYPE), INTENT (IN)::YDCPG_BNDS
TYPE (CPG_OPTS_TYPE), INTENT (IN)::YDCPG_OPTS
TYPE (TLDDH), INTENT (IN)::YDLDDH
TYPE (TMDDH), INTENT (IN)::YDMDDH
TYPE (MODEL_GENERAL_CONF_TYPE), INTENT (IN)::YDML_GCONF
TYPE (MODEL_DYNAMICS_TYPE), INTENT (IN)::YDML_DYN
REAL (KIND=JPRB), INTENT (IN)::PDTS2
REAL (KIND=JPRB), INTENT (IN)::PBT
REAL (KIND=JPRB), INTENT (IN)::PBDT (YDGEOMETRY%YRDIM%NPROMA)
REAL (KIND=JPRB), INTENT (IN)::PESGP
REAL (KIND=JPRB), INTENT (IN)::PESGM
REAL (KIND=JPRB), INTENT (IN)::POROGL (YDGEOMETRY%YRDIM%NPROMA)
REAL (KIND=JPRB), INTENT (IN)::POROGM (YDGEOMETRY%YRDIM%NPROMA)
REAL (KIND=JPRB), INTENT (IN)::PHIF0 (YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB), INTENT (IN)::PGAGT0L (YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB), INTENT (IN)::PGAGT0M (YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB), INTENT (IN)::PTOD0 (YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB), INTENT (IN)::PSPDS0 (YDGEOMETRY%YRDIM%NPROMNH, YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB), INTENT (IN)::PLPD0 (YDGEOMETRY%YRDIM%NPROMNH, YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB), INTENT (IN)::PGAGT9L (YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB), INTENT (IN)::PGAGT9M (YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB), INTENT (IN)::PTOD9 (YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB), INTENT (IN)::PSPDS9 (YDGEOMETRY%YRDIM%NPROMNH, YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB), INTENT (IN)::PLPD9 (YDGEOMETRY%YRDIM%NPROMNH, YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB), INTENT (IN)::PRDELP (YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB), INTENT (IN)::PEVEL (YDGEOMETRY%YRDIM%NPROMA, 0:YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB), INTENT (IN)::PNHXT0 (YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB), INTENT (IN)::PGWT0 (YDGEOMETRY%YRDIM%NPROMNH, YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB), INTENT (IN)::PGWFT0 (YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB), INTENT (IN)::PNHXT9 (YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB), INTENT (IN)::PGWT9 (YDGEOMETRY%YRDIM%NPROMNH, YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB), INTENT (IN)::PMIXNL (YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY%YRDIMV%NFLEVG)
TYPE (CPG_TNDSI_DDH_TYPE), INTENT (INOUT)::YDCPG_TNDSI_DDH













INTEGER (KIND=JPIM)::IPX

INTEGER (KIND=JPIM)::JGFL

LOGICAL::LLCTC
LOGICAL::LLCT
LOGICAL::LLSETTLSW
LOGICAL::LLTDIABLIN
REAL (KIND=JPRB)::ZRGOM
REAL (KIND=JPRB)::ZRTWORGRA
REAL (KIND=JPRB)::ZCMSLP
REAL (KIND=JPHOOK)::ZHOOK_HANDLE

#include "lattex_lrsiddh.intfb.h"
#include "lattex_lrhs_curv.intfb.h"
#include "lattex_main.intfb.h"

#include "lattex_expl_2tl.intfb.h"
#include "lattex_expl_3tl.intfb.h"
#include "lattex_expl_vspltrans.intfb.h"
#include "lattex_rintopt.intfb.h"
IF (LHOOK) CALL DR_HOOK ('LATTEX', 0, ZHOOK_HANDLE)



LLCT=YDML_DYN%YRDYNA%LPC_FULL.AND.YDML_DYN%YRDYN%NCURRENT_ITER>0
LLCTC=YDML_DYN%YRDYNA%LPC_CHEAP.AND.YDML_DYN%YRDYN%NCURRENT_ITER>0
ZCMSLP=YDML_DYN%YRDYN%RCMSLP0/(YDCST%RD*YDCPG_OPTS%RTSUR)

IF (YDLDDH%LRSIDDH) THEN
  CALL LATTEX_LRSIDDH (YDCPG_BNDS, YDCPG_SL1, YDCPG_TNDSI_DDH, YDGEOMETRY, YDML_DYN)
ENDIF


IF (PESGP>PESGM) THEN
  LLSETTLSW=.FALSE.
ELSE
  LLSETTLSW=YDML_DYN%YRDYNA%LSETTLS
ENDIF

ZRTWORGRA=2._JPRB/(YDCST%RG*YDCST%RA)
ZRGOM=2._JPRB*YDCST%ROMEGA/YDCST%RG
CALL LATTEX_MAIN (LLCT, LLCTC, LLSETTLSW, PBT, PDTS2, PESGM, PESGP, YDCPG_BNDS, YDCPG_OPTS, YDCPG_SL1&
&, YDCPG_SL2, YDCPG_TND, YDCPG_TNDSI_DDH, YDGEOMETRY, YDLDDH, YDML_DYN, YDML_GCONF, YDVARS, ZCMSLP&
&, ZRGOM, ZRTWORGRA, PBDT, PEVEL, PGAGT0L, PGAGT0M, PGAGT9L, PGAGT9M, PGWFT0, PGWT0, PGWT9, PHIF0,&
& PLPD0, PLPD9, PMIXNL, PNHXT0, PNHXT9, POROGL, POROGM, PRDELP, PSPDS0, PSPDS9, PTOD0, PTOD9)

IF (YDML_DYN%YRDYNA%LTWOTL) THEN
  CALL LATTEX_EXPL_2TL (YDGEOMETRY, YDCPG_BNDS, YDCPG_OPTS, YDML_DYN, YDCPG_SL1, YDVARS, LLCT, LLCTC)
ELSE
  
  CALL LATTEX_EXPL_3TL (YDGEOMETRY, YDCPG_BNDS, YDCPG_OPTS, YDML_DYN, YDCPG_SL1, YDVARS)
  
ENDIF


IF (YDML_DYN%YRDYN%RINTOPT/=1._JPRB) THEN
  
  CALL LATTEX_RINTOPT (YDGEOMETRY, YDCPG_BNDS, YDCPG_OPTS, YDCPG_SL1, YDML_DYN%YRDYN%RINTOPT)
  
ENDIF


IF (.NOT.LLCTC) THEN
  CALL LATTEX_EXPL_VSPLTRANS (YDGEOMETRY, YDCPG_BNDS, YDCPG_OPTS, YDML_DYN, YDCPG_SL1)
ENDIF


IF (YDML_DYN%YRDYN%LRHS_CURV) THEN
  CALL LATTEX_LRHS_CURV (YDCPG_BNDS, YDCPG_SL1, YDGEOMETRY, YDML_DYN, YDVARS)
ENDIF




IF (LHOOK) CALL DR_HOOK ('LATTEX', 1, ZHOOK_HANDLE)
ENDSUBROUTINE LATTEX
