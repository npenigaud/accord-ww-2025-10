SUBROUTINE APL_ARPEGE_SURFACE (YDMF_PHYS_BASE_STATE, YDGEOMETRY, YDCPG_BNDS, YDCPG_OPTS, YDCPG_MISC&
&, YDCPG_GPAR, YDMF_PHYS, YDMF_PHYS_SURF, YDVARS, YDMODEL, PALBD, PALBP, PALPHA1, PCDROV, PCEROV&
&, PCFATH, PCFAU, PCFBTH, PCFBU, PCFBV, PCHROV, PCOEFA, PCOEFN, PCP, PDIFEXT, PDIFWQ, PDIFWS,&
& PDQSTS, PDSA_CPS, PDSA_LHS, PDTMSE, PEDMFQ, PEDMFS, PEDMFU, PEDMFV, PFLU_CD, PFLU_CDN, PFLU_EMIS&
&, PFLU_FEVI, PFLU_NEIJ, PFLU_QSATS, PFLU_VEG, PHQ, PHTR, PHU, PKQLROV, PKQROV, PKTROV, PKUROV&
&, PLVT, PMF_UP, PNEBCH, PNEBDIFF, PNEBS, PPOID, PQI, PQICE, PQL, PQV, PRDG_MU0, PRDG_MU0N, PRHGMT&
&, PSC_FCLL, PSC_FCLN, PSC_FEVI, PSC_FEVN, PSFSWDIF, PSFSWDIR, PSGROUPEL, PSRAIN, PSSNOW, PSTATI&
&, PTSN, PXDROV, PXHROV, PXQRO, PXTRO, PXTROV, PXURO, PXUROV)
USE YOMHOOK,ONLY:LHOOK, DR_HOOK, JPHOOK
USE PARKIND1,ONLY:JPIM, JPRB
USE MF_PHYS_BASE_STATE_TYPE_MOD,ONLY:MF_PHYS_BASE_STATE_TYPE
USE GEOMETRY_MOD,ONLY:GEOMETRY
USE CPG_OPTS_TYPE_MOD,ONLY:CPG_BNDS_TYPE, CPG_OPTS_TYPE
USE CPG_TYPE_MOD,ONLY:CPG_MISC_TYPE, CPG_GPAR_TYPE
USE MF_PHYS_TYPE_MOD,ONLY:MF_PHYS_TYPE
USE MF_PHYS_SURFACE_TYPE_MOD,ONLY:MF_PHYS_SURF_TYPE
USE FIELD_VARIABLES_MOD,ONLY:FIELD_VARIABLES
USE SURFACE_FIELDS_MIX,ONLY:TSURF
USE TYPE_MODEL,ONLY:MODEL

IMPLICIT NONE


TYPE (MF_PHYS_BASE_STATE_TYPE), INTENT (IN)::YDMF_PHYS_BASE_STATE
TYPE (GEOMETRY), INTENT (IN)::YDGEOMETRY
TYPE (CPG_BNDS_TYPE), INTENT (IN)::YDCPG_BNDS
TYPE (CPG_OPTS_TYPE), INTENT (IN)::YDCPG_OPTS
TYPE (CPG_MISC_TYPE), INTENT (INOUT)::YDCPG_MISC
TYPE (CPG_GPAR_TYPE), INTENT (INOUT)::YDCPG_GPAR
TYPE (MF_PHYS_TYPE), INTENT (INOUT)::YDMF_PHYS
TYPE (MF_PHYS_SURF_TYPE), INTENT (INOUT)::YDMF_PHYS_SURF
TYPE (FIELD_VARIABLES), INTENT (INOUT)::YDVARS
TYPE (MODEL), INTENT (IN)::YDMODEL
REAL (KIND=JPRB), INTENT (INOUT)::PALBD (YDCPG_OPTS%KLON, YDCPG_OPTS%KSW)
REAL (KIND=JPRB), INTENT (INOUT)::PALBP (YDCPG_OPTS%KLON, YDCPG_OPTS%KSW)
REAL (KIND=JPRB), INTENT (OUT)::PALPHA1 (YDCPG_OPTS%KLON, 0:YDCPG_OPTS%KFLEVG)
REAL (KIND=JPRB), INTENT (IN)::PCDROV (YDCPG_OPTS%KLON)
REAL (KIND=JPRB), INTENT (IN)::PCEROV (YDCPG_OPTS%KLON)
REAL (KIND=JPRB), INTENT (OUT)::PCFATH (YDCPG_OPTS%KLON, YDCPG_OPTS%KFLEVG)
REAL (KIND=JPRB), INTENT (OUT)::PCFAU (YDCPG_OPTS%KLON, YDCPG_OPTS%KFLEVG)
REAL (KIND=JPRB), INTENT (OUT)::PCFBTH (YDCPG_OPTS%KLON, YDCPG_OPTS%KFLEVG)
REAL (KIND=JPRB), INTENT (OUT)::PCFBU (YDCPG_OPTS%KLON, YDCPG_OPTS%KFLEVG)
REAL (KIND=JPRB), INTENT (OUT)::PCFBV (YDCPG_OPTS%KLON, YDCPG_OPTS%KFLEVG)
REAL (KIND=JPRB), INTENT (IN)::PCHROV (YDCPG_OPTS%KLON)
REAL (KIND=JPRB), INTENT (OUT)::PCOEFA (YDCPG_OPTS%KLON, 0:YDCPG_OPTS%KFLEVG)
REAL (KIND=JPRB), INTENT (IN)::PCOEFN (YDCPG_OPTS%KLON, YDCPG_OPTS%KFLEVG)
REAL (KIND=JPRB), INTENT (IN)::PCP (YDCPG_OPTS%KLON, YDCPG_OPTS%KFLEVG)
REAL (KIND=JPRB), INTENT (OUT)::PDIFEXT (YDCPG_OPTS%KLON, 0&
&:YDCPG_OPTS%KFLEVG, YDMODEL%YRML_GCONF%YGFL%NGFL_EXT)
REAL (KIND=JPRB), INTENT (OUT)::PDIFWQ (YDCPG_OPTS%KLON)
REAL (KIND=JPRB), INTENT (OUT)::PDIFWS (YDCPG_OPTS%KLON)
REAL (KIND=JPRB), INTENT (IN)::PDQSTS (YDCPG_OPTS%KLON)
REAL (KIND=JPRB), INTENT (IN)::PDSA_CPS (YDCPG_OPTS%KLON)
REAL (KIND=JPRB), INTENT (OUT)::PDSA_LHS (YDCPG_OPTS%KLON)
REAL (KIND=JPRB), INTENT (IN)::PDTMSE
REAL (KIND=JPRB), INTENT (IN)::PEDMFQ (YDCPG_OPTS%KLON, 0:YDCPG_OPTS%KFLEVG)
REAL (KIND=JPRB), INTENT (IN)::PEDMFS (YDCPG_OPTS%KLON, 0:YDCPG_OPTS%KFLEVG)
REAL (KIND=JPRB), INTENT (IN)::PEDMFU (YDCPG_OPTS%KLON, 0:YDCPG_OPTS%KFLEVG)
REAL (KIND=JPRB), INTENT (IN)::PEDMFV (YDCPG_OPTS%KLON, 0:YDCPG_OPTS%KFLEVG)
REAL (KIND=JPRB), INTENT (IN)::PFLU_CD (YDCPG_OPTS%KLON)
REAL (KIND=JPRB), INTENT (IN)::PFLU_CDN (YDCPG_OPTS%KLON)
REAL (KIND=JPRB), INTENT (INOUT)::PFLU_EMIS (YDCPG_OPTS%KLON)
REAL (KIND=JPRB), INTENT (OUT)::PFLU_FEVI (YDCPG_OPTS%KLON, 1:YDCPG_OPTS%KTSSG+1)
REAL (KIND=JPRB), INTENT (IN)::PFLU_NEIJ (YDCPG_OPTS%KLON)
REAL (KIND=JPRB), INTENT (IN)::PFLU_QSATS (YDCPG_OPTS%KLON)
REAL (KIND=JPRB), INTENT (IN)::PFLU_VEG (YDCPG_OPTS%KLON)
REAL (KIND=JPRB), INTENT (IN)::PHQ (YDCPG_OPTS%KLON)
REAL (KIND=JPRB), INTENT (IN)::PHTR (YDCPG_OPTS%KLON)
REAL (KIND=JPRB), INTENT (IN)::PHU (YDCPG_OPTS%KLON)
REAL (KIND=JPRB), INTENT (IN)::PKQLROV (YDCPG_OPTS%KLON, 0:YDCPG_OPTS%KFLEVG)
REAL (KIND=JPRB), INTENT (IN)::PKQROV (YDCPG_OPTS%KLON, 0:YDCPG_OPTS%KFLEVG)
REAL (KIND=JPRB), INTENT (IN)::PKTROV (YDCPG_OPTS%KLON, 0:YDCPG_OPTS%KFLEVG)
REAL (KIND=JPRB), INTENT (IN)::PKUROV (YDCPG_OPTS%KLON, 0:YDCPG_OPTS%KFLEVG)
REAL (KIND=JPRB), INTENT (OUT)::PLVT (YDCPG_OPTS%KLON, 0:YDCPG_OPTS%KFLEVG)
REAL (KIND=JPRB), INTENT (IN)::PMF_UP (YDCPG_OPTS%KLON, 0:YDCPG_OPTS%KFLEVG)
REAL (KIND=JPRB), INTENT (IN)::PNEBCH (YDCPG_OPTS%KLON, YDCPG_OPTS%KFLEVG)
REAL (KIND=JPRB), INTENT (INOUT)::PNEBDIFF (YDCPG_OPTS%KLON, YDCPG_OPTS%KFLEVG)
REAL (KIND=JPRB), INTENT (IN)::PNEBS (YDCPG_OPTS%KLON, YDCPG_OPTS%KFLEVG)
REAL (KIND=JPRB), INTENT (IN)::PPOID (YDCPG_OPTS%KLON, YDCPG_OPTS%KFLEVG)
REAL (KIND=JPRB), INTENT (IN)::PQI (YDCPG_OPTS%KLON, YDCPG_OPTS%KFLEVG)
REAL (KIND=JPRB), INTENT (OUT)::PQICE (YDCPG_OPTS%KLON, 0:YDCPG_OPTS%KFLEVG)
REAL (KIND=JPRB), INTENT (IN)::PQL (YDCPG_OPTS%KLON, YDCPG_OPTS%KFLEVG)
REAL (KIND=JPRB), INTENT (IN)::PQV (YDCPG_OPTS%KLON, YDCPG_OPTS%KFLEVG)
REAL (KIND=JPRB), INTENT (IN)::PRDG_MU0 (YDCPG_OPTS%KLON)
REAL (KIND=JPRB), INTENT (IN)::PRDG_MU0N (YDCPG_OPTS%KLON)
REAL (KIND=JPRB), INTENT (IN)::PRHGMT
REAL (KIND=JPRB), INTENT (OUT)::PSC_FCLL (YDCPG_OPTS%KLON)
REAL (KIND=JPRB), INTENT (OUT)::PSC_FCLN (YDCPG_OPTS%KLON)
REAL (KIND=JPRB), INTENT (OUT)::PSC_FEVI (YDCPG_OPTS%KLON)
REAL (KIND=JPRB), INTENT (OUT)::PSC_FEVN (YDCPG_OPTS%KLON)
REAL (KIND=JPRB), INTENT (INOUT)::PSFSWDIF (YDCPG_OPTS%KLON, YDCPG_OPTS%KSW)
REAL (KIND=JPRB), INTENT (INOUT)::PSFSWDIR (YDCPG_OPTS%KLON, YDCPG_OPTS%KSW)
REAL (KIND=JPRB), INTENT (INOUT)::PSGROUPEL (YDCPG_OPTS%KLON)
REAL (KIND=JPRB), INTENT (INOUT)::PSRAIN (YDCPG_OPTS%KLON)
REAL (KIND=JPRB), INTENT (INOUT)::PSSNOW (YDCPG_OPTS%KLON)
REAL (KIND=JPRB), INTENT (IN)::PSTATI
REAL (KIND=JPRB), INTENT (INOUT)::PTSN (YDCPG_OPTS%KLON)
REAL (KIND=JPRB), INTENT (INOUT)::PXDROV (YDCPG_OPTS%KLON)
REAL (KIND=JPRB), INTENT (INOUT)::PXHROV (YDCPG_OPTS%KLON)
REAL (KIND=JPRB), INTENT (OUT)::PXQRO (YDCPG_OPTS%KLON, 0:YDCPG_OPTS%KFLEVG)
REAL (KIND=JPRB), INTENT (OUT)::PXTRO (YDCPG_OPTS%KLON, 0:YDCPG_OPTS%KFLEVG)
REAL (KIND=JPRB), INTENT (INOUT)::PXTROV (YDCPG_OPTS%KLON, 0:YDCPG_OPTS%KFLEVG)
REAL (KIND=JPRB), INTENT (INOUT)::PXURO (YDCPG_OPTS%KLON, 0:YDCPG_OPTS%KFLEVG)
REAL (KIND=JPRB), INTENT (INOUT)::PXUROV (YDCPG_OPTS%KLON, 0:YDCPG_OPTS%KFLEVG)

#include "apl_arpege_surface_acdifv1.intfb.h"
#include "apl_arpege_surface_lmse_f2.intfb.h"
#include "apl_arpege_surface_ledkf.intfb.h"
#include "apl_arpege_surface_acdifv2.intfb.h"
#include "apl_arpege_surface_callsfx_f.intfb.h"
#include "apl_arpege_surface_lmse_f.intfb.h"
#include "apl_arpege_surface_outline_001.intfb.h"







REAL (KIND=JPRB)::ZTWSNOW (YDCPG_OPTS%KLON)

REAL (KIND=JPRB)::ZSVM (YDCPG_OPTS%KLON, 1, 1)

REAL (KIND=JPRB)::ZSFSV (YDCPG_OPTS%KLON, 1)


REAL (KIND=JPRB)::ZQT (YDCPG_OPTS%KLON, YDCPG_OPTS%KFLEVG)

REAL (KIND=JPRB)::ZFMDV (YDCPG_OPTS%KLON)
REAL (KIND=JPRB)::ZFMDU (YDCPG_OPTS%KLON)

REAL (KIND=JPRB)::ZFEV (YDCPG_OPTS%KLON)

REAL (KIND=JPRB)::ZDSE (YDCPG_OPTS%KLON, YDCPG_OPTS%KFLEVG)

REAL (KIND=JPRB)::ZCFBSV (YDCPG_OPTS%KLON, YDCPG_OPTS%KFLEVG, 1:YDMODEL%YRML_GCONF%YGFL%NGFL_EXT)
REAL (KIND=JPRB)::ZCFBS (YDCPG_OPTS%KLON, YDCPG_OPTS%KFLEVG)
REAL (KIND=JPRB)::ZCFBQ (YDCPG_OPTS%KLON, YDCPG_OPTS%KFLEVG)
REAL (KIND=JPRB)::ZCFASV (YDCPG_OPTS%KLON, YDCPG_OPTS%KFLEVG, 1:YDMODEL%YRML_GCONF%YGFL%NGFL_EXT)
REAL (KIND=JPRB)::ZCFAS (YDCPG_OPTS%KLON, YDCPG_OPTS%KFLEVG)
REAL (KIND=JPRB)::ZCFAQ (YDCPG_OPTS%KLON, YDCPG_OPTS%KFLEVG)




REAL (KIND=JPRB)::ZCARDI





INTEGER (KIND=JPIM)::IRR



REAL (KIND=JPHOOK)::ZHOOK_HANDLE
IF (LHOOK) CALL DR_HOOK ('APL_ARPEGE_SURFACE', 0, ZHOOK_HANDLE)


CALL APL_ARPEGE_SURFACE_ACDIFV1 (YDCPG_BNDS, YDCPG_OPTS, YDMF_PHYS_BASE_STATE, YDMODEL&
&, PCFATH, PCFAU, PCFBTH, PCFBU, PCFBV, PCP, PEDMFQ, PEDMFS, PEDMFU, PEDMFV, PKQROV&
&, PKTROV, PKUROV, PMF_UP, PQI, PQL, PQV, PXDROV, PXHROV, PXQRO, PXTRO, PXTROV, PXURO&
&, PXUROV, ZCFAQ, ZCFAS, ZCFASV, ZCFBQ, ZCFBS, ZCFBSV, ZDSE, ZQT, ZSVM)

IF (YDMODEL%YRML_PHY_MF%YRARPHY%LMSE.AND.YDCPG_OPTS%LCALLSFX) THEN
  ZCARDI=YDMODEL%YRML_PHY_RAD%YRERDI%RCARDI
  IRR=2
  CALL APL_ARPEGE_SURFACE_OUTLINE_001 (IRR, PDTMSE, PRHGMT, PSTATI, YDCPG_BNDS, YDCPG_GPAR,&
  & YDCPG_MISC, YDCPG_OPTS, YDGEOMETRY, YDMF_PHYS, YDMF_PHYS_BASE_STATE, YDMF_PHYS_SURF, YDMODEL&
  &, YDVARS, ZCARDI, PALBD, PALBP, PALPHA1, PCFATH, PCFAU, PCFBTH, PCFBU, PCFBV, PCOEFA, PCOEFN&
  &, PFLU_EMIS, PLVT, PQI, PQICE, PQL, PRDG_MU0, PRDG_MU0N, PSFSWDIF, PSFSWDIR, PSGROUPEL, PSRAIN&
  &, PSSNOW, PTSN, ZCFAQ, ZCFBQ, ZFEV, ZFMDU, ZFMDV, ZSFSV, ZSVM, ZTWSNOW)
ELSEIF (.NOT.YDMODEL%YRML_PHY_MF%YRARPHY%LMSE) THEN
  CALL APL_ARPEGE_SURFACE_LMSE_F (YDCPG_BNDS, YDCPG_MISC, YDCPG_OPTS, YDMF_PHYS, YDMF_PHYS_BASE_STATE, YDMF_PHYS_SURF&
  &, YDMODEL, PALPHA1, PCDROV, PCEROV, PCFAU, PCFBU, PCFBV, PCHROV, PCOEFA, PCP, PDIFWQ, PDIFWS, PDQSTS&
  &, PDSA_CPS, PDSA_LHS, PFLU_CD, PFLU_CDN, PFLU_EMIS, PFLU_FEVI, PFLU_NEIJ, PFLU_QSATS, PFLU_VEG, PHQ,&
  & PHTR, PHU, PLVT, PNEBCH, PNEBDIFF, PNEBS, PQI, PQICE, PQL, PQV, PSC_FCLL, PSC_FCLN, PSC_FEVI, PSC_FEVN&
  &, PXDROV, PXHROV, PXQRO, PXTRO, PXURO, ZCFAS, ZCFBQ, ZCFBS, ZDSE, ZFMDU, ZFMDV)
ELSEIF (.NOT.YDCPG_OPTS%LCALLSFX) THEN
  CALL APL_ARPEGE_SURFACE_CALLSFX_F (YDCPG_OPTS, YDMF_PHYS, ZFEV)
ENDIF

CALL APL_ARPEGE_SURFACE_ACDIFV2 (YDCPG_BNDS, YDCPG_OPTS, YDMF_PHYS, YDMF_PHYS_BASE_STATE&
&, YDMODEL, YDVARS, PALPHA1, PCFAU, PCFBU, PCFBV, PCOEFA, PDIFEXT, PKQLROV, PKQROV&
&, PKTROV, PKUROV, PLVT, PPOID, PQI, PQICE, PQL, PTSN, PXHROV, ZCFAQ, ZCFAS, ZCFASV&
&, ZCFBQ, ZCFBS, ZCFBSV, ZDSE, ZFEV, ZFMDU, ZFMDV, ZQT, ZSFSV)

IF (YDMODEL%YRML_PHY_MF%YRPHY%LEDKF) THEN
  CALL APL_ARPEGE_SURFACE_LEDKF (YDCPG_BNDS, YDCPG_OPTS, YDMF_PHYS, YDMF_PHYS_SURF)
ENDIF


IF (YDMODEL%YRML_PHY_MF%YRARPHY%LMSE) THEN
  CALL APL_ARPEGE_SURFACE_LMSE_F2 (YDCPG_BNDS, YDCPG_GPAR, YDCPG_OPTS, YDMF_PHYS_SURF, PTSN, ZTWSNOW)
ENDIF



IF (LHOOK) CALL DR_HOOK ('APL_ARPEGE_SURFACE', 1, ZHOOK_HANDLE)
ENDSUBROUTINE APL_ARPEGE_SURFACE
