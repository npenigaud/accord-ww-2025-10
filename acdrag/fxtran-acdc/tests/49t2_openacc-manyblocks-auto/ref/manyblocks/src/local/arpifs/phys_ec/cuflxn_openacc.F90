
SUBROUTINE CUFLXN_OPENACC (YDTHF, YDCST, YDEPHLI, YDECUMF, KIDIA, KFDIA, KLON, KLEV, PTSPHY, PTEN&
&, PQEN, PQSEN, PTENH, PQENH, PAPH, PAP, PGEOH, LDLAND, LDCUM, LDTDKMF, KCBOT, KCTOP, KDTOP, KTOPM2&
&, KTYPE, LDDRAF, PMFU, PMFD, PMFUS, PMFDS, PMFUQ, PMFDQ, PMFUL, PLUDE, PLUDELI, PLRAIN, PSNDE, PDMFUP&
&, PDMFDP, PDPMEL, PLGLAC, PMFLXR, PMFLXS, PRAIN, PMFUDE_RATE, PMFDDE_RATE, YDSTACK)
!$ACC ROUTINE (CUFLXN_OPENACC) SEQ
USE PARKIND1,ONLY:JPIM, JPRB

USE YOMCST,ONLY:TCST
USE YOETHF,ONLY:TTHF
USE YOEPHLI,ONLY:TEPHLI
USE YOECUMF,ONLY:TECUMF
#include "fxtran_acdc_stack.h"
USE FXTRAN_ACDC_STACK_MOD
USE FXTRAN_ACDC_ABORT_MOD

IMPLICIT NONE


TYPE (TTHF), INTENT (IN)::YDTHF
TYPE (TCST), INTENT (IN)::YDCST
TYPE (TECUMF), INTENT (IN)::YDECUMF
TYPE (TEPHLI), INTENT (IN)::YDEPHLI
INTEGER (KIND=JPIM), INTENT (IN)::KLON
INTEGER (KIND=JPIM), INTENT (IN)::KLEV
INTEGER (KIND=JPIM), INTENT (IN)::KIDIA
INTEGER (KIND=JPIM), INTENT (IN)::KFDIA
REAL (KIND=JPRB), INTENT (IN)::PTSPHY
REAL (KIND=JPRB), INTENT (IN)::PTEN 
REAL (KIND=JPRB), INTENT (IN)::PQEN 
REAL (KIND=JPRB), INTENT (INOUT)::PQSEN 
REAL (KIND=JPRB), INTENT (IN)::PTENH 
REAL (KIND=JPRB), INTENT (IN)::PQENH 
REAL (KIND=JPRB), INTENT (IN)::PAPH 
REAL (KIND=JPRB), INTENT (IN)::PAP 
REAL (KIND=JPRB), INTENT (IN)::PGEOH 
LOGICAL, INTENT (IN)::LDLAND 
LOGICAL, INTENT (IN)::LDCUM 
LOGICAL, INTENT (IN)::LDTDKMF
INTEGER (KIND=JPIM), INTENT (IN)::KCBOT 
INTEGER (KIND=JPIM), INTENT (IN)::KCTOP 
INTEGER (KIND=JPIM), INTENT (IN)::KDTOP 
INTEGER (KIND=JPIM), INTENT (IN)::KTOPM2
INTEGER (KIND=JPIM), INTENT (INOUT)::KTYPE 
LOGICAL, INTENT (INOUT)::LDDRAF 
REAL (KIND=JPRB), INTENT (INOUT)::PMFU 
REAL (KIND=JPRB), INTENT (INOUT)::PMFD 
REAL (KIND=JPRB), INTENT (INOUT)::PMFUS 
REAL (KIND=JPRB), INTENT (INOUT)::PMFDS 
REAL (KIND=JPRB), INTENT (INOUT)::PMFUQ 
REAL (KIND=JPRB), INTENT (INOUT)::PMFDQ 
REAL (KIND=JPRB), INTENT (INOUT)::PMFUL 
REAL (KIND=JPRB), INTENT (OUT)::PLUDE 
REAL (KIND=JPRB), INTENT (OUT)::PLUDELI 
REAL (KIND=JPRB), INTENT (IN)::PLRAIN 
REAL (KIND=JPRB), INTENT (OUT)::PSNDE 
REAL (KIND=JPRB), INTENT (INOUT)::PDMFUP 
REAL (KIND=JPRB), INTENT (INOUT)::PDMFDP 
REAL (KIND=JPRB), INTENT (OUT)::PDPMEL 
REAL (KIND=JPRB), INTENT (INOUT)::PLGLAC 
REAL (KIND=JPRB), INTENT (OUT)::PMFLXR 
REAL (KIND=JPRB), INTENT (OUT)::PMFLXS 
REAL (KIND=JPRB), INTENT (OUT)::PRAIN 
REAL (KIND=JPRB), INTENT (IN)::PMFUDE_RATE 
REAL (KIND=JPRB), INTENT (INOUT)::PMFDDE_RATE 
TYPE(FXTRAN_ACDC_STACK), INTENT (IN) :: YDSTACK

fxtran_acdc_temp (REAL(KIND=JPRB), PTEN_PTR, (KLON, KLEV))
fxtran_acdc_temp (REAL(KIND=JPRB), PQEN_PTR, (KLON, KLEV))
fxtran_acdc_temp (REAL(KIND=JPRB), PQSEN_PTR, (KLON, KLEV))
fxtran_acdc_temp (REAL(KIND=JPRB), PTENH_PTR, (KLON, KLEV))
fxtran_acdc_temp (REAL(KIND=JPRB), PQENH_PTR, (KLON, KLEV))
fxtran_acdc_temp (REAL(KIND=JPRB), PAPH_PTR, (KLON, KLEV+1))
fxtran_acdc_temp (REAL(KIND=JPRB), PAP_PTR, (KLON, KLEV))
fxtran_acdc_temp (REAL(KIND=JPRB), PGEOH_PTR, (KLON, KLEV+1))
fxtran_acdc_temp (LOGICAL, LDLAND_PTR, (KLON))
fxtran_acdc_temp (LOGICAL, LDCUM_PTR, (KLON))
fxtran_acdc_temp (INTEGER(KIND=JPIM), KCBOT_PTR, (KLON))
fxtran_acdc_temp (INTEGER(KIND=JPIM), KCTOP_PTR, (KLON))
fxtran_acdc_temp (INTEGER(KIND=JPIM), KDTOP_PTR, (KLON))
fxtran_acdc_temp (INTEGER(KIND=JPIM), KTYPE_PTR, (KLON))
fxtran_acdc_temp (LOGICAL, LDDRAF_PTR, (KLON))
fxtran_acdc_temp (REAL(KIND=JPRB), PMFU_PTR, (KLON, KLEV))
fxtran_acdc_temp (REAL(KIND=JPRB), PMFD_PTR, (KLON, KLEV))
fxtran_acdc_temp (REAL(KIND=JPRB), PMFUS_PTR, (KLON, KLEV))
fxtran_acdc_temp (REAL(KIND=JPRB), PMFDS_PTR, (KLON, KLEV))
fxtran_acdc_temp (REAL(KIND=JPRB), PMFUQ_PTR, (KLON, KLEV))
fxtran_acdc_temp (REAL(KIND=JPRB), PMFDQ_PTR, (KLON, KLEV))
fxtran_acdc_temp (REAL(KIND=JPRB), PMFUL_PTR, (KLON, KLEV))
fxtran_acdc_temp (REAL(KIND=JPRB), PLUDE_PTR, (KLON, KLEV))
fxtran_acdc_temp (REAL(KIND=JPRB), PLUDELI_PTR, (KLON, KLEV, 2))
fxtran_acdc_temp (REAL(KIND=JPRB), PLRAIN_PTR, (KLON, KLEV))
fxtran_acdc_temp (REAL(KIND=JPRB), PSNDE_PTR, (KLON, KLEV, 2))
fxtran_acdc_temp (REAL(KIND=JPRB), PDMFUP_PTR, (KLON, KLEV))
fxtran_acdc_temp (REAL(KIND=JPRB), PDMFDP_PTR, (KLON, KLEV))
fxtran_acdc_temp (REAL(KIND=JPRB), PDPMEL_PTR, (KLON, KLEV))
fxtran_acdc_temp (REAL(KIND=JPRB), PLGLAC_PTR, (KLON, KLEV))
fxtran_acdc_temp (REAL(KIND=JPRB), PMFLXR_PTR, (KLON, KLEV+1))
fxtran_acdc_temp (REAL(KIND=JPRB), PMFLXS_PTR, (KLON, KLEV+1))
fxtran_acdc_temp (REAL(KIND=JPRB), PRAIN_PTR, (KLON))
fxtran_acdc_temp (REAL(KIND=JPRB), PMFUDE_RATE_PTR, (KLON, KLEV))
fxtran_acdc_temp (REAL(KIND=JPRB), PMFDDE_RATE_PTR, (KLON, KLEV))

REAL (KIND=JPRB)::ZRCUCOV 
REAL (KIND=JPRB)::ZMFS 
REAL (KIND=JPRB)::ZRHEBC 
INTEGER (KIND=JPIM)::JL
INTEGER (KIND=JPIM)::JK
INTEGER (KIND=JPIM)::IKB
INTEGER (KIND=JPIM)::IK
INTEGER (KIND=JPIM)::IDBAS 
LOGICAL::LLDDRAF
REAL (KIND=JPRB)::ZRHM
REAL (KIND=JPRB)::ZMFMAX
REAL (KIND=JPRB)::ZGLAC
REAL (KIND=JPRB)::ZTEN
REAL (KIND=JPRB)::ZWETB
REAL (KIND=JPRB)::ZTWETB
REAL (KIND=JPRB)::ZZP
REAL (KIND=JPRB)::ZTMST
REAL (KIND=JPRB)::ZTARG
REAL (KIND=JPRB)::ZSNMLT
REAL (KIND=JPRB)::ZRNEW
REAL (KIND=JPRB)::ZRMIN
REAL (KIND=JPRB)::ZRFLN
REAL (KIND=JPRB)::ZRFL
REAL (KIND=JPRB)::ZPDS
REAL (KIND=JPRB)::ZPDR
REAL (KIND=JPRB)::ZOELHM
REAL (KIND=JPRB)::ZOEEWM
REAL (KIND=JPRB)::ZOEALFA
REAL (KIND=JPRB)::ZFOEEWL
REAL (KIND=JPRB)::ZFOEEWI
REAL (KIND=JPRB)::ZFAC
REAL (KIND=JPRB)::ZDRFL1
REAL (KIND=JPRB)::ZDRFL
REAL (KIND=JPRB)::ZDENOM
REAL (KIND=JPRB)::ZCONS2
REAL (KIND=JPRB)::ZCONS1A
REAL (KIND=JPRB)::ZCONS1
REAL (KIND=JPRB)::ZALFAW
REAL (KIND=JPRB), PARAMETER::ZTW1=1329.31_JPRB
REAL (KIND=JPRB), PARAMETER::ZTW2=0.0074615_JPRB
REAL (KIND=JPRB), PARAMETER::ZTW3=0.85E5_JPRB
REAL (KIND=JPRB), PARAMETER::ZTW4=40.637_JPRB
REAL (KIND=JPRB), PARAMETER::ZTW5=275.0_JPRB

#include "fcttre.func.h"

fxtran_acdc_assoc (PTEN_PTR, PTEN)

fxtran_acdc_assoc (PQEN_PTR, PQEN)

fxtran_acdc_assoc (PQSEN_PTR, PQSEN)

fxtran_acdc_assoc (PTENH_PTR, PTENH)

fxtran_acdc_assoc (PQENH_PTR, PQENH)

fxtran_acdc_assoc (PAPH_PTR, PAPH)

fxtran_acdc_assoc (PAP_PTR, PAP)

fxtran_acdc_assoc (PGEOH_PTR, PGEOH)

fxtran_acdc_assoc (LDLAND_PTR, LDLAND)

fxtran_acdc_assoc (LDCUM_PTR, LDCUM)

fxtran_acdc_assoc (KCBOT_PTR, KCBOT)

fxtran_acdc_assoc (KCTOP_PTR, KCTOP)

fxtran_acdc_assoc (KDTOP_PTR, KDTOP)

fxtran_acdc_assoc (KTYPE_PTR, KTYPE)

fxtran_acdc_assoc (LDDRAF_PTR, LDDRAF)

fxtran_acdc_assoc (PMFU_PTR, PMFU)

fxtran_acdc_assoc (PMFD_PTR, PMFD)

fxtran_acdc_assoc (PMFUS_PTR, PMFUS)

fxtran_acdc_assoc (PMFDS_PTR, PMFDS)

fxtran_acdc_assoc (PMFUQ_PTR, PMFUQ)

fxtran_acdc_assoc (PMFDQ_PTR, PMFDQ)

fxtran_acdc_assoc (PMFUL_PTR, PMFUL)

fxtran_acdc_assoc (PLUDE_PTR, PLUDE)

fxtran_acdc_assoc (PLUDELI_PTR, PLUDELI)

fxtran_acdc_assoc (PLRAIN_PTR, PLRAIN)

fxtran_acdc_assoc (PSNDE_PTR, PSNDE)

fxtran_acdc_assoc (PDMFUP_PTR, PDMFUP)

fxtran_acdc_assoc (PDMFDP_PTR, PDMFDP)

fxtran_acdc_assoc (PDPMEL_PTR, PDPMEL)

fxtran_acdc_assoc (PLGLAC_PTR, PLGLAC)

fxtran_acdc_assoc (PMFLXR_PTR, PMFLXR)

fxtran_acdc_assoc (PMFLXS_PTR, PMFLXS)

fxtran_acdc_assoc (PRAIN_PTR, PRAIN)

fxtran_acdc_assoc (PMFUDE_RATE_PTR, PMFUDE_RATE)

fxtran_acdc_assoc (PMFDDE_RATE_PTR, PMFDDE_RATE)

JL = KIDIA



ZTMST=PTSPHY
ZCONS1A=YDCST%RCPD/(YDCST%RLMLT*YDCST%RG*YDECUMF%RTAUMEL)
ZCONS2=YDECUMF%RMFCFL/(YDCST%RG*ZTMST)

IF (YDECUMF%LMFWETB) THEN
  ZWETB=1.0_JPRB
ELSE
  ZWETB=0.0_JPRB
ENDIF


IF (YDECUMF%LMFGLAC) THEN
  ZGLAC=0.0_JPRB
ELSE
  ZGLAC=1.0_JPRB
ENDIF


PRAIN_PTR (JL)=0.0_JPRB

IF (.NOT.LDCUM_PTR (JL).OR.KDTOP_PTR (JL)<KCTOP_PTR (JL))  THEN
  LDDRAF_PTR (JL)=.FALSE.
ENDIF


IF (.NOT.LDCUM_PTR (JL))  THEN
  KTYPE_PTR (JL)=0
ENDIF

IDBAS =KLEV

IF (LDLAND_PTR (JL)) THEN
  ZRHEBC =0.75_JPRB

  IF (KTYPE_PTR (JL)==1)  THEN
    ZRHEBC =0.70_JPRB
  ENDIF

ELSE
  ZRHEBC =YDECUMF%RHEBC

  IF (KTYPE_PTR (JL)==1)  THEN
    ZRHEBC =0.85_JPRB
  ENDIF

ENDIF



DO JK=KTOPM2, KLEV
  IKB=MIN (JK+1, KLEV)
  
  PMFLXR_PTR (JL, JK)=0.0_JPRB
  PMFLXS_PTR (JL, JK)=0.0_JPRB
  PDPMEL_PTR (JL, JK)=0.0_JPRB
  PSNDE_PTR (JL, JK, 1)=0.0_JPRB
  PSNDE_PTR (JL, JK, 2)=0.0_JPRB

  IF (LDCUM_PTR (JL).AND.JK>=KCTOP_PTR (JL)) THEN
    PMFUS_PTR (JL, JK)=PMFUS_PTR (JL, JK)-PMFU_PTR (JL, JK)&
    &*(YDCST%RCPD*PTENH_PTR (JL, JK)+PGEOH_PTR (JL, JK))
    PMFUQ_PTR (JL, JK)=PMFUQ_PTR (JL, JK)-PMFU_PTR (JL, JK)*PQENH_PTR (JL, JK)
    PLGLAC_PTR (JL, JK)=PMFU_PTR (JL, JK)*PLGLAC_PTR (JL, JK)
    LLDDRAF=LDDRAF_PTR (JL).AND.JK>=KDTOP_PTR (JL)

    IF (LLDDRAF) THEN
      PMFDS_PTR (JL, JK)=PMFDS_PTR (JL, JK)-PMFD_PTR (JL, JK)&
      &*(YDCST%RCPD*PTENH_PTR (JL, JK)+PGEOH_PTR (JL, JK))
      PMFDQ_PTR (JL, JK)=PMFDQ_PTR (JL, JK)-PMFD_PTR (JL, JK)*PQENH_PTR (JL, JK)
    ELSE
      PMFD_PTR (JL, JK)=0.0_JPRB
      PMFDS_PTR (JL, JK)=0.0_JPRB
      PMFDQ_PTR (JL, JK)=0.0_JPRB
      PDMFDP_PTR (JL, JK-1)=0.0_JPRB
    ENDIF


    IF (LLDDRAF.AND.PMFD_PTR (JL, JK)<0._JPRB.AND.PMFD_PTR (JL, IKB)==0._JPRB) THEN
      IDBAS =JK
    ENDIF

  ELSE
    PMFU_PTR (JL, JK)=0.0_JPRB
    PMFD_PTR (JL, JK)=0.0_JPRB
    PMFUS_PTR (JL, JK)=0.0_JPRB
    PMFDS_PTR (JL, JK)=0.0_JPRB
    PMFUQ_PTR (JL, JK)=0.0_JPRB
    PMFDQ_PTR (JL, JK)=0.0_JPRB
    PMFUL_PTR (JL, JK)=0.0_JPRB
    PLGLAC_PTR (JL, JK)=0.0_JPRB
    PDMFUP_PTR (JL, JK-1)=0.0_JPRB
    PDMFDP_PTR (JL, JK-1)=0.0_JPRB
    PLUDE_PTR (JL, JK-1)=0.0_JPRB
    PLUDELI_PTR (JL, JK-1, 1)=0.0_JPRB
    PLUDELI_PTR (JL, JK-1, 2)=0.0_JPRB
  ENDIF

  
ENDDO

PMFLXR_PTR (JL, KLEV+1)=0.0_JPRB
PMFLXS_PTR (JL, KLEV+1)=0.0_JPRB
PMFLXR_PTR (JL, 1)=0.0_JPRB
PMFLXS_PTR (JL, 1)=0.0_JPRB
PSNDE_PTR (JL, 1, 1)=0.0_JPRB
PSNDE_PTR (JL, 1, 2)=0.0_JPRB


IF (LDCUM_PTR (JL)) THEN
  IKB=KCBOT_PTR (JL)
  IK=IKB+1
  ZZP=((PAPH_PTR (JL, KLEV+1)-PAPH_PTR (JL, IK))/(PAPH_PTR (JL, KLEV+1)-PAPH_PTR (JL, IKB)))

  IF (KTYPE_PTR (JL)==3)  THEN
    ZZP=ZZP*ZZP
  ENDIF

  PMFU_PTR (JL, IK)=PMFU_PTR (JL, IKB)*ZZP

  IF (YDEPHLI%LPHYLIN) THEN
    ZTARG=PTENH_PTR (JL, IKB)
    ZOEALFA=MIN (1.0_JPRB, 0.545_JPRB*(TANH (0.17_JPRB*(ZTARG-YDEPHLI%RLPTRC))+1.0_JPRB))
    ZOELHM=ZOEALFA*YDCST%RLVTT+(1.0_JPRB-ZOEALFA)*YDCST%RLSTT
    PMFUS_PTR (JL, IK)=(PMFUS_PTR (JL, IKB)-ZOELHM*PMFUL_PTR (JL, IKB))*ZZP
  ELSE
    PMFUS_PTR (JL, IK)=(PMFUS_PTR (JL, IKB)-FOELHMCU (PTENH_PTR (JL, IKB))*PMFUL_PTR (JL, IKB))*ZZP
  ENDIF

  PMFUQ_PTR (JL, IK)=(PMFUQ_PTR (JL, IKB)+PMFUL_PTR (JL, IKB))*ZZP
  PMFUL_PTR (JL, IK)=0.0_JPRB
ENDIF



DO JK=KTOPM2, KLEV

  

  IF (LDCUM_PTR (JL).AND.JK>KCBOT_PTR (JL)+1) THEN
    IKB=KCBOT_PTR (JL)+1
    ZZP=((PAPH_PTR (JL, KLEV+1)-PAPH_PTR (JL, JK))/(PAPH_PTR (JL, KLEV+1)-PAPH_PTR (JL, IKB)))

    IF (KTYPE_PTR (JL)==3)  THEN
      ZZP=ZZP*ZZP
    ENDIF

    PMFU_PTR (JL, JK)=PMFU_PTR (JL, IKB)*ZZP
    PMFUS_PTR (JL, JK)=PMFUS_PTR (JL, IKB)*ZZP
    PMFUQ_PTR (JL, JK)=PMFUQ_PTR (JL, IKB)*ZZP
    PMFUL_PTR (JL, JK)=0.0_JPRB
  ENDIF

  IK=IDBAS 
  LLDDRAF=LDDRAF_PTR (JL).AND.JK>IK.AND.IK<KLEV

  IF (LLDDRAF.AND.IK==KCBOT_PTR (JL)+1) THEN
    ZZP=((PAPH_PTR (JL, KLEV+1)-PAPH_PTR (JL, JK))/(PAPH_PTR (JL, KLEV+1)-PAPH_PTR (JL, IK)))

    IF (KTYPE_PTR (JL)==3)  THEN
      ZZP=ZZP*ZZP
    ENDIF

    PMFD_PTR (JL, JK)=PMFD_PTR (JL, IK)*ZZP
    PMFDS_PTR (JL, JK)=PMFDS_PTR (JL, IK)*ZZP
    PMFDQ_PTR (JL, JK)=PMFDQ_PTR (JL, IK)*ZZP
    PMFDDE_RATE_PTR (JL, JK)=-(PMFD_PTR (JL, JK-1)-PMFD_PTR (JL, JK))
  ELSEIF (LLDDRAF.AND.IK/=KCBOT_PTR (JL)+1.AND.JK==IK+1) THEN
    PMFDDE_RATE_PTR (JL, JK)=-(PMFD_PTR (JL, JK-1)-PMFD_PTR (JL, JK))
  ENDIF

  
ENDDO

ZMFS =1.0_JPRB

DO JK=2, KLEV

  

  IF (LDDRAF_PTR (JL).AND.JK>=KDTOP_PTR (JL)-1) THEN
    ZMFMAX=ABS (PMFU_PTR (JL, JK))*0.98_JPRB

    IF (PMFD_PTR (JL, JK)+ZMFMAX+1.E-15_JPRB<0.0_JPRB) THEN
      ZMFS =MIN (ZMFS ,-ZMFMAX/PMFD_PTR (JL, JK))
    ENDIF

  ENDIF

  
ENDDO


DO JK=2, KLEV

  

  IF (ZMFS <1.0_JPRB.AND.JK>=KDTOP_PTR (JL)-1) THEN
    PMFD_PTR (JL, JK)=PMFD_PTR (JL, JK)*ZMFS 
    PMFDS_PTR (JL, JK)=PMFDS_PTR (JL, JK)*ZMFS 
    PMFDQ_PTR (JL, JK)=PMFDQ_PTR (JL, JK)*ZMFS 
    PMFDDE_RATE_PTR (JL, JK)=PMFDDE_RATE_PTR (JL, JK)*ZMFS 
    PDMFDP_PTR (JL, JK)=PDMFDP_PTR (JL, JK)*ZMFS 
  ENDIF

  
ENDDO


DO JK=KTOPM2, KLEV

  

  IF (LDCUM_PTR (JL).AND.JK>=KCTOP_PTR (JL)-1) THEN
    PRAIN_PTR (JL)=PRAIN_PTR (JL)+PDMFUP_PTR (JL, JK)
    ZTWETB=PTEN_PTR (JL, JK)-MAX (0.0_JPRB, PQSEN_PTR (JL, JK)-PQEN_PTR (JL, JK&
    &))*(ZTW1+ZTW2*(PAP_PTR (JL, JK)-ZTW3)-ZTW4*(PTEN_PTR (JL, JK)-ZTW5))
    ZTEN=ZTWETB*ZWETB+(1.0_JPRB-ZWETB)*PTEN_PTR (JL, JK)

    IF (PMFLXS_PTR (JL, JK)>0.0_JPRB.AND.ZTEN>YDCST%RTT) THEN
      ZCONS1=ZCONS1A*(1.0_JPRB+0.5_JPRB*(ZTEN-YDCST%RTT))
      ZFAC=ZCONS1*(PAPH_PTR (JL, JK+1)-PAPH_PTR (JL, JK))
      ZSNMLT=MIN (PMFLXS_PTR (JL, JK), ZFAC*(ZTEN-YDCST%RTT))
      PDPMEL_PTR (JL, JK)=ZSNMLT

      IF (YDEPHLI%LPHYLIN) THEN
        ZTARG=ZTEN-ZSNMLT/ZFAC
        ZOEALFA=MIN (1.0_JPRB, 0.545_JPRB*(TANH (0.17_JPRB*(ZTARG-YDEPHLI%RLPTRC))+1.0_JPRB))
        ZFOEEWL=YDTHF%R2ES*EXP (YDTHF%R3LES*(ZTARG-YDCST%RTT)/(ZTARG-YDTHF%R4LES))
        ZFOEEWI=YDTHF%R2ES*EXP (YDTHF%R3IES*(ZTARG-YDCST%RTT)/(ZTARG-YDTHF%R4IES))
        ZOEEWM=ZOEALFA*ZFOEEWL+(1.0_JPRB-ZOEALFA)*ZFOEEWI
        PQSEN_PTR (JL, JK)=ZOEEWM/PAP_PTR (JL, JK)
      ELSE
        PQSEN_PTR (JL, JK)=FOEEWMCU (ZTEN-ZSNMLT/ZFAC)/PAP_PTR (JL, JK)
      ENDIF

    ENDIF


    IF (YDEPHLI%LPHYLIN) THEN
      ZALFAW=MIN (1.0_JPRB, 0.545_JPRB*(TANH (0.17_JPRB*(ZTEN-YDEPHLI%RLPTRC))+1.0_JPRB))
    ELSE
      ZALFAW=FOEALFCU (ZTEN)
    ENDIF


    IF (PTEN_PTR (JL, JK)<=YDCST%RTT.AND.ZALFAW>0.0_JPRB) THEN
      PLGLAC_PTR (JL, JK)=PLGLAC_PTR (JL, JK)+ZGLAC*ZALFAW*PDMFUP_PTR (JL, JK)+ZALFAW*PDMFDP_PTR (JL, JK)
      ZALFAW=0.0_JPRB
    ENDIF


    IF (YDECUMF%LMFDSNOW.AND.JK<=KCBOT_PTR (JL)) THEN
      PSNDE_PTR (JL, JK, 2)=PLRAIN_PTR (JL, JK+1)*PMFUDE_RATE_PTR (JL, JK)
      PSNDE_PTR (JL, JK, 1)=PSNDE_PTR (JL, JK, 2)*ZALFAW
      PSNDE_PTR (JL, JK, 2)=PSNDE_PTR (JL, JK, 2)*(1.0_JPRB-ZALFAW)
      PSNDE_PTR (JL, JK, 1)=MIN (PSNDE_PTR (JL, JK, 1), ZALFAW*(PDMFUP_PTR (JL, JK)+PDMFDP_PTR (JL, JK)))
      PSNDE_PTR (JL, JK, 2)=MIN (PSNDE_PTR (JL, JK, 2),(1.0_JPRB-ZALFAW)&
      &*(PDMFUP_PTR (JL, JK)+PDMFDP_PTR (JL, JK))-PDPMEL_PTR (JL, JK))
      PSNDE_PTR (JL, JK, 1)=MAX (PSNDE_PTR (JL, JK, 1), 0.0_JPRB)
      PSNDE_PTR (JL, JK, 2)=MAX (PSNDE_PTR (JL, JK, 2), 0.0_JPRB)
    ENDIF

    PMFLXR_PTR (JL, JK+1)=PMFLXR_PTR (JL, JK)+ZALFAW*(PDMFUP_PTR (JL, JK&
    &)+PDMFDP_PTR (JL, JK))+PDPMEL_PTR (JL, JK)-PSNDE_PTR (JL, JK, 1)
    PMFLXS_PTR (JL, JK+1)=PMFLXS_PTR (JL, JK)+(1.0_JPRB-ZALFAW)*(PDMFUP_PTR (JL&
    &, JK)+PDMFDP_PTR (JL, JK))-PDPMEL_PTR (JL, JK)-PSNDE_PTR (JL, JK, 2)

    IF (PMFLXR_PTR (JL, JK+1)+PMFLXS_PTR (JL, JK+1)<0.0_JPRB) THEN
      PDMFDP_PTR (JL, JK)=-(PMFLXR_PTR (JL, JK)+PMFLXS_PTR (JL, JK)+PDMFUP_PTR (JL, JK))
      PMFLXR_PTR (JL, JK+1)=0.0_JPRB
      PMFLXS_PTR (JL, JK+1)=0.0_JPRB
      PDPMEL_PTR (JL, JK)=0.0_JPRB
    ELSEIF (PMFLXR_PTR (JL, JK+1)<0.0_JPRB) THEN
      PMFLXS_PTR (JL, JK+1)=PMFLXS_PTR (JL, JK+1)+PMFLXR_PTR (JL, JK+1)
      PMFLXR_PTR (JL, JK+1)=0.0_JPRB
    ELSEIF (PMFLXS_PTR (JL, JK+1)<0.0_JPRB) THEN
      PMFLXR_PTR (JL, JK+1)=PMFLXR_PTR (JL, JK+1)+PMFLXS_PTR (JL, JK+1)
      PMFLXS_PTR (JL, JK+1)=0.0_JPRB
    ENDIF

  ENDIF

  
ENDDO


IF (.NOT.LDTDKMF) THEN

  

  IF (KTYPE_PTR (JL)>=2) THEN
    IKB=KCBOT_PTR (JL)
    IK=KCTOP_PTR (JL)
    ZRHM=0.5*(PQEN_PTR (JL, IKB)/PQSEN_PTR (JL, IKB)+PQEN_PTR (JL, IK)/PQSEN_PTR (JL, IK))
    ZRCUCOV =YDECUMF%RCUCOV*(1.0_JPRB+(MAX (0.8_JPRB, ZRHM)-0.8_JPRB)/0.025_JPRB)
  ELSE
    ZRCUCOV =YDECUMF%RCUCOV*0.6
  ENDIF

  
ELSE
  
  ZRCUCOV =YDECUMF%RCUCOV
  
ENDIF


DO JK=KTOPM2, KLEV

  

  IF (LDCUM_PTR (JL).AND.JK>=KCBOT_PTR (JL)) THEN
    ZRFL=PMFLXR_PTR (JL, JK)+PMFLXS_PTR (JL, JK)

    IF (ZRFL>1.E-12_JPRB) THEN
      ZDRFL1=YDECUMF%RCPECONS*MAX (0.0_JPRB, PQSEN_PTR (JL, JK)-PQEN_PTR (JL, JK)&
      &)*ZRCUCOV *(SQRT (PAPH_PTR (JL, JK)/PAPH_PTR (JL, KLEV+1))/YDECUMF%RCVRFACTOR&
      &*ZRFL/ZRCUCOV )**0.5777_JPRB*(PAPH_PTR (JL, JK+1)-PAPH_PTR (JL, JK))
      ZRNEW=ZRFL-ZDRFL1
      ZRMIN=ZRFL-ZRCUCOV *MAX (0.0_JPRB, ZRHEBC *PQSEN_PTR (JL, JK)-PQEN_PTR&
      & (JL, JK))*ZCONS2*(PAPH_PTR (JL, JK+1)-PAPH_PTR (JL, JK))
      ZRNEW=MAX (ZRNEW, ZRMIN)
      ZRFLN=MAX (ZRNEW, 0.0_JPRB)
      ZDRFL=MIN (0.0_JPRB, ZRFLN-ZRFL)

      IF (YDEPHLI%LPHYLIN) THEN
        ZALFAW=MIN (1.0_JPRB, 0.545_JPRB*(TANH (0.17_JPRB*(PTEN_PTR (JL, JK)-YDEPHLI%RLPTRC))+1.0_JPRB))
      ELSE
        ZALFAW=FOEALFCU (PTEN_PTR (JL, JK))
      ENDIF


      IF (PTEN_PTR (JL, JK)<YDCST%RTT)  THEN
        ZALFAW=0.0_JPRB
      ENDIF

      ZPDR=ZALFAW*PDMFDP_PTR (JL, JK)
      ZPDS=(1.0_JPRB-ZALFAW)*PDMFDP_PTR (JL, JK)
      ZDENOM=1.0_JPRB/MAX (1.E-12_JPRB, PMFLXR_PTR (JL, JK)+PMFLXS_PTR (JL, JK))
      PMFLXR_PTR (JL, JK+1)=PMFLXR_PTR (JL, JK)+ZPDR+PDPMEL_PTR (JL, JK)+ZDRFL*PMFLXR_PTR (JL, JK)*ZDENOM
      PMFLXS_PTR (JL, JK+1)=PMFLXS_PTR (JL, JK)+ZPDS-PDPMEL_PTR (JL, JK)+ZDRFL*PMFLXS_PTR (JL, JK)*ZDENOM
      PDMFUP_PTR (JL, JK)=PDMFUP_PTR (JL, JK)+ZDRFL

      IF (PMFLXR_PTR (JL, JK+1)+PMFLXS_PTR (JL, JK+1)<0.0_JPRB) THEN
        PDMFUP_PTR (JL, JK)=PDMFUP_PTR (JL, JK)-(PMFLXR_PTR (JL, JK+1)+PMFLXS_PTR (JL, JK+1))
        PMFLXR_PTR (JL, JK+1)=0.0_JPRB
        PMFLXS_PTR (JL, JK+1)=0.0_JPRB
        PDPMEL_PTR (JL, JK)=0.0_JPRB
      ELSEIF (PMFLXR_PTR (JL, JK+1)<0.0_JPRB) THEN
        PMFLXS_PTR (JL, JK+1)=PMFLXS_PTR (JL, JK+1)+PMFLXR_PTR (JL, JK+1)
        PMFLXR_PTR (JL, JK+1)=0.0_JPRB
      ELSEIF (PMFLXS_PTR (JL, JK+1)<0.0_JPRB) THEN
        PMFLXR_PTR (JL, JK+1)=PMFLXR_PTR (JL, JK+1)+PMFLXS_PTR (JL, JK+1)
        PMFLXS_PTR (JL, JK+1)=0.0_JPRB
      ENDIF

    ELSE
      PMFLXR_PTR (JL, JK+1)=0.0_JPRB
      PMFLXS_PTR (JL, JK+1)=0.0_JPRB
      PDMFDP_PTR (JL, JK)=0.0_JPRB
      PDPMEL_PTR (JL, JK)=0.0_JPRB
    ENDIF

  ENDIF

  
ENDDO



ENDSUBROUTINE CUFLXN_OPENACC
