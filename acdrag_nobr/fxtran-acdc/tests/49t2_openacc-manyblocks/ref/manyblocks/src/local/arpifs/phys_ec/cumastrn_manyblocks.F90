SUBROUTINE CUMASTRN_MANYBLOCKS (PPLDARE, PPLRG, YDTHF, YDCST, YDML_PHY_SLIN, YDML_PHY_EC, YGFL, YDCHEM&
&, YDSPP_CONFIG, YDPERTPAR, KIDIA, KFDIA, KLON, KLEV, PDX, LDTDKMF, LDMCAPEA, LDLAND, PTSPHY, PTEN&
&, PQEN, PUEN, PVEN, PLITOT, PVERVEL, PQSEN, PQHFL, PAHFS, PAP, PAPH, PGEO, PGEOH, PGAW, PCUCONVCA&
&, PGP2DSPP, PTENT, PTENQ, PTENU, PTENV, PTENTA, PTENQA, LDCUM, KTYPE, KCBOT, KCTOP, LDCUM_LIG, KCBOT_LIG&
&, KCTOP_LIG, KBOTSC, LDSC, LDSHCV, PLCRIT_AER, PTU, PQU, PLU, PLUDE, PLUDELI, PSNDE, PENTH, PMFLXR&
&, PMFLXS, PRAIN, PLRAIN, PRSUD, PMFU, PMFD, PLGLAC, PMFUDE_RATE, PMFDDE_RATE, PCAPE, PWU, PWMEAN&
&, PVDISCU, PDISS, KTRAC, PCEN, PTENC, PSCAV, PSCAV0, LDACC, KGPBLKS)
USE MODEL_PHYSICS_ECMWF_MOD,ONLY:MODEL_PHYSICS_ECMWF_TYPE
USE MODEL_PHYSICS_SIMPLINEAR_MOD,ONLY:MODEL_PHYSICS_SIMPLINEAR_TYPE
USE YOM_YGFL,ONLY:TYPE_GFLD
USE YOMCHEM,ONLY:TCHEM
USE PARKIND1,ONLY:JPIM, JPRB
#ifdef __PGI
USE NVTX, ONLY : NVTXSTARTRANGE, NVTXENDRANGE
#endif
USE YOMCST,ONLY:TCST
USE YOETHF,ONLY:TTHF
USE SPP_MOD,ONLY:TSPP_CONFIG
USE SPP_GEN_MOD,ONLY:SPP_PERT
USE YOMPERTPAR,ONLY:TPERTPAR
USE FXTRAN_ACDC_STACK_MOD
USE FXTRAN_ACDC_ABORT_MOD
#include "fxtran_acdc_stack.h"

IMPLICIT NONE


REAL (KIND=JPRB), INTENT (IN)::PPLDARE
REAL (KIND=JPRB), INTENT (IN)::PPLRG
TYPE (TTHF), INTENT (IN)::YDTHF
TYPE (TCST), INTENT (IN)::YDCST
TYPE (MODEL_PHYSICS_ECMWF_TYPE), INTENT (IN)::YDML_PHY_EC
TYPE (TCHEM), INTENT (IN)::YDCHEM
TYPE (TSPP_CONFIG), INTENT (IN)::YDSPP_CONFIG
TYPE (TPERTPAR), INTENT (IN)::YDPERTPAR
TYPE (MODEL_PHYSICS_SIMPLINEAR_TYPE), INTENT (IN)::YDML_PHY_SLIN
TYPE (TYPE_GFLD), INTENT (IN)::YGFL
INTEGER (KIND=JPIM), INTENT (IN)::KLON
INTEGER (KIND=JPIM), INTENT (IN)::KLEV
INTEGER (KIND=JPIM), INTENT (IN)::KIDIA
INTEGER (KIND=JPIM), INTENT (IN)::KFDIA
INTEGER (KIND=JPIM), INTENT (IN)::KTRAC
LOGICAL, INTENT (IN)::LDMCAPEA
LOGICAL, INTENT (IN)::LDLAND (:, :) ! (KLON)
REAL (KIND=JPRB), INTENT (IN)::PTSPHY
REAL (KIND=JPRB), INTENT (IN)::PLCRIT_AER (:, :, :) ! (KLON, KLEV)
REAL (KIND=JPRB), INTENT (INOUT)::PTEN (:, :, :) ! (KLON, KLEV)
REAL (KIND=JPRB), INTENT (INOUT)::PQEN (:, :, :) ! (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PUEN (:, :, :) ! (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PVEN (:, :, :) ! (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PLITOT (:, :, :) ! (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PVERVEL (:, :, :) ! (KLON, KLEV)
REAL (KIND=JPRB), INTENT (INOUT)::PQSEN (:, :, :) ! (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PQHFL (:, :, :) ! (KLON, KLEV+1)
REAL (KIND=JPRB), INTENT (IN)::PAHFS (:, :, :) ! (KLON, KLEV+1)
REAL (KIND=JPRB), INTENT (IN)::PAP (:, :, :) ! (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PAPH (:, :, :) ! (KLON, KLEV+1)
REAL (KIND=JPRB), INTENT (IN)::PGEO (:, :, :) ! (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PGEOH (:, :, :) ! (KLON, KLEV+1)
REAL (KIND=JPRB), INTENT (IN)::PGAW (:, :) ! (KLON)
REAL (KIND=JPRB), INTENT (IN)::PCUCONVCA (:, :) ! (KLON)
REAL (KIND=JPRB), INTENT (IN)::PGP2DSPP (:, :, :) ! (KLON, YDSPP_CONFIG%SM%NRFTOTAL)
REAL (KIND=JPRB), INTENT (IN)::PCEN (:, :, :, :) ! (KLON, KLEV, KTRAC)
REAL (KIND=JPRB), INTENT (IN)::PSCAV (KTRAC)
REAL (KIND=JPRB), INTENT (IN)::PSCAV0 (KTRAC)
INTEGER, INTENT (IN) :: KGPBLKS
LOGICAL, INTENT (IN) :: LDACC
REAL (KIND=JPRB), INTENT (IN)::PDX (:, :) ! (KLON)
LOGICAL, INTENT (IN)::LDTDKMF
REAL (KIND=JPRB), INTENT (INOUT)::PTENT (:, :, :) ! (KLON, KLEV)
REAL (KIND=JPRB), INTENT (INOUT)::PTENQ (:, :, :) ! (KLON, KLEV)
REAL (KIND=JPRB), INTENT (INOUT)::PTENU (:, :, :) ! (KLON, KLEV)
REAL (KIND=JPRB), INTENT (INOUT)::PTENV (:, :, :) ! (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PTENTA (:, :, :) ! (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PTENQA (:, :, :) ! (KLON, KLEV)
REAL (KIND=JPRB), INTENT (INOUT)::PTENC (:, :, :, :) ! (KLON, KLEV, KTRAC)
LOGICAL, INTENT (OUT)::LDCUM (:, :) ! (KLON)
INTEGER (KIND=JPIM), INTENT (OUT)::KTYPE (:, :) ! (KLON)
INTEGER (KIND=JPIM), INTENT (OUT)::KCBOT (:, :) ! (KLON)
INTEGER (KIND=JPIM), INTENT (OUT)::KCTOP (:, :) ! (KLON)
LOGICAL, INTENT (OUT)::LDCUM_LIG (:, :) ! (KLON)
INTEGER (KIND=JPIM), INTENT (OUT)::KCBOT_LIG (:, :) ! (KLON)
INTEGER (KIND=JPIM), INTENT (OUT)::KCTOP_LIG (:, :) ! (KLON)
INTEGER (KIND=JPIM), INTENT (OUT)::KBOTSC (:, :) ! (KLON)
LOGICAL, INTENT (OUT)::LDSC (:, :) ! (KLON)
LOGICAL, INTENT (IN)::LDSHCV (:, :) ! (KLON)
REAL (KIND=JPRB), INTENT (OUT)::PTU (:, :, :) ! (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PQU (:, :, :) ! (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PLU (:, :, :) ! (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PLUDE (:, :, :) ! (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PLUDELI (:, :, :, :) ! (KLON, KLEV, 4)
REAL (KIND=JPRB), INTENT (OUT)::PSNDE (:, :, :, :) ! (KLON, KLEV, 2)
REAL (KIND=JPRB), INTENT (OUT)::PENTH (:, :, :) ! (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PMFLXR (:, :, :) ! (KLON, KLEV+1)
REAL (KIND=JPRB), INTENT (OUT)::PMFLXS (:, :, :) ! (KLON, KLEV+1)
REAL (KIND=JPRB), INTENT (OUT)::PRAIN (:, :) ! (KLON)
REAL (KIND=JPRB), INTENT (OUT)::PLRAIN (:, :, :) ! (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PRSUD (:, :, :, :) ! (KLON, KLEV, 2)
REAL (KIND=JPRB), INTENT (OUT)::PMFU (:, :, :) ! (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PMFD (:, :, :) ! (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PLGLAC (:, :, :) ! (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PMFUDE_RATE (:, :, :) ! (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PMFDDE_RATE (:, :, :) ! (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PCAPE (:, :) ! (KLON)
REAL (KIND=JPRB), INTENT (OUT)::PWMEAN (:, :) ! (KLON)
REAL (KIND=JPRB), INTENT (OUT)::PVDISCU (:, :) ! (KLON)
REAL (KIND=JPRB), INTENT (OUT)::PWU (:, :, :) ! (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PDISS (:, :, :) ! (KLON, KLEV)
REAL (KIND=JPRB)::ZKINED (KLON, KLEV,KGPBLKS)
REAL (KIND=JPRB)::ZKINEU (KLON, KLEV,KGPBLKS)
REAL (KIND=JPRB)::ZVD (KLON, KLEV,KGPBLKS)
REAL (KIND=JPRB)::ZUD (KLON, KLEV,KGPBLKS)
REAL (KIND=JPRB)::ZVU (KLON, KLEV,KGPBLKS)
REAL (KIND=JPRB)::ZUU (KLON, KLEV,KGPBLKS)
REAL (KIND=JPRB)::ZRFL (KLON,KGPBLKS)
REAL (KIND=JPRB)::ZMFUL (KLON, KLEV,KGPBLKS)
REAL (KIND=JPRB)::ZDMFDP (KLON, KLEV,KGPBLKS)
REAL (KIND=JPRB)::ZDMFUP (KLON, KLEV,KGPBLKS)
REAL (KIND=JPRB)::ZMFDQ (KLON, KLEV,KGPBLKS)
REAL (KIND=JPRB)::ZMFUQ (KLON, KLEV,KGPBLKS)
REAL (KIND=JPRB)::ZMFDS (KLON, KLEV,KGPBLKS)
REAL (KIND=JPRB)::ZMFUS (KLON, KLEV,KGPBLKS)
REAL (KIND=JPRB)::ZQD (KLON, KLEV,KGPBLKS)
REAL (KIND=JPRB)::ZTD (KLON, KLEV,KGPBLKS)
REAL (KIND=JPRB)::ZQSENH (KLON, KLEV,KGPBLKS)
REAL (KIND=JPRB)::ZQENH2 (KLON, KLEV,KGPBLKS)
REAL (KIND=JPRB)::ZTENH2 (KLON, KLEV,KGPBLKS)
REAL (KIND=JPRB)::ZQENH (KLON, KLEV,KGPBLKS)
REAL (KIND=JPRB)::ZTENH (KLON, KLEV,KGPBLKS)
REAL (KIND=JPRB)::ZSATFR (KLON,KGPBLKS)
REAL (KIND=JPRB)::ZMFCFL (KLON,KGPBLKS)
REAL (KIND=JPRB)::ZFACCA (KLON,KGPBLKS)
REAL (KIND=JPRB)::ZDQCV (KLON,KGPBLKS)
REAL (KIND=JPRB)::ZKHFL (KLON,KGPBLKS)
REAL (KIND=JPRB)::ZKHVFL (KLON,KGPBLKS)
REAL (KIND=JPRB)::ZMFUB1 (KLON,KGPBLKS)
REAL (KIND=JPRB)::ZMFUB (KLON,KGPBLKS)
REAL (KIND=JPRB)::ZDPMEL (KLON, KLEV,KGPBLKS)
REAL (KIND=JPRB)::ZWUBASE (KLON,KGPBLKS)
REAL (KIND=JPRB)::ZDHPBL (KLON,KGPBLKS)
REAL (KIND=JPRB)::ZDX (KLON,KGPBLKS)
REAL (KIND=JPRB)::ZDMFDE (KLON, KLEV,KGPBLKS)
REAL (KIND=JPRB)::ZDMFEN (KLON, KLEV,KGPBLKS)
INTEGER (KIND=JPIM)::ICTOP0 (KLON,KGPBLKS)
INTEGER (KIND=JPIM)::IDTOP (KLON,KGPBLKS)
INTEGER (KIND=JPIM)::ILAB (KLON, KLEV,KGPBLKS)
INTEGER (KIND=JPIM)::IDPL (KLON,KGPBLKS)
REAL (KIND=JPRB)::ZCAPDCYCLSE (KLON,KGPBLKS)
REAL (KIND=JPRB)::ZCAPDCYCLLD (KLON,KGPBLKS)
REAL (KIND=JPRB)::ZCAPDCYCL (KLON,KGPBLKS)
REAL (KIND=JPRB)::ZCAPPBL (KLON,KGPBLKS)
REAL (KIND=JPRB)::ZHEAT (KLON,KGPBLKS)
REAL (KIND=JPRB)::ZCAPE2 (KLON,KGPBLKS)
REAL (KIND=JPRB)::ZCAPE (KLON,KGPBLKS)
LOGICAL::LLSCVFLAG (KLON,KGPBLKS)
LOGICAL::LLDCUM (KLON,KGPBLKS)
LOGICAL::LLDDRAF3 (KLON,KGPBLKS)
LOGICAL::LLDDRAF (KLON,KGPBLKS)
LOGICAL::LLO3
LOGICAL::LLMIXS
LOGICAL::LLO2 (KLON,KGPBLKS)
LOGICAL::LLO1
INTEGER (KIND=JPIM)::JL
INTEGER (KIND=JPIM)::IK
INTEGER (KIND=JPIM)::JK
INTEGER (KIND=JPIM)::ITOPM2
INTEGER (KIND=JPIM)::IKD
INTEGER (KIND=JPIM)::IKB
REAL (KIND=JPRB)::ZIND
REAL (KIND=JPRB)::ZRG
REAL (KIND=JPRB)::ZAK
REAL (KIND=JPRB)::ZBS
REAL (KIND=JPRB)::ZBR
REAL (KIND=JPRB)::ZAS
REAL (KIND=JPRB)::ZAR
REAL (KIND=JPRB)::ZTAURES
REAL (KIND=JPRB)::ZTDIS
REAL (KIND=JPRB)::ZDVTEN
REAL (KIND=JPRB)::ZDUTEN
REAL (KIND=JPRB)::ZRDOCPD
REAL (KIND=JPRB)::ZORCPD
REAL (KIND=JPRB)::ZDERATE
REAL (KIND=JPRB)::ZERATE
REAL (KIND=JPRB)::ZMFA
REAL (KIND=JPRB)::ZRO
REAL (KIND=JPRB)::ZQUMQE
REAL (KIND=JPRB)::ZPBMPT
REAL (KIND=JPRB)::ZMFMAX
REAL (KIND=JPRB)::ZFAC
REAL (KIND=JPRB)::ZEPS
REAL (KIND=JPRB)::ZDZ
REAL (KIND=JPRB)::ZDQMIN
REAL (KIND=JPRB)::ZDH2
REAL (KIND=JPRB)::ZDH
REAL (KIND=JPRB)::ZCONS
REAL (KIND=JPRB)::ZCONS2
REAL (KIND=JPRB)::ZTAUPBL (KLON,KGPBLKS)
REAL (KIND=JPRB)::ZTAU (KLON,KGPBLKS)
REAL (KIND=JPRB)::ZXTAU (KLON,KGPBLKS)
LOGICAL::LLPERT_RTAU
INTEGER (KIND=JPIM)::IPRTAU
INTEGER (KIND=JPIM)::IPN
TYPE (SPP_PERT)::PN1
REAL (KIND=JPRB)::ZSUM22 (KLON,KGPBLKS)
REAL (KIND=JPRB)::ZSUM12 (KLON,KGPBLKS)
REAL (KIND=JPRB)::ZUV2 (KLON, KLEV,KGPBLKS)
REAL (KIND=JPRB)::ZDMFDPC (KLON, KLEV,KGPBLKS)
REAL (KIND=JPRB)::ZDMFUPC (KLON, KLEV,KGPBLKS)
REAL (KIND=JPRB)::ZKMFL (KLON,KGPBLKS)
REAL (KIND=JPRB)::ZMF_SHAL (KLON,KGPBLKS)
REAL (KIND=JPRB)::ZMFUVB (KLON,KGPBLKS)
REAL (KIND=JPRB)::ZMFUUB (KLON,KGPBLKS)
REAL (KIND=JPRB)::ZTENV (KLON, KLEV,KGPBLKS)
REAL (KIND=JPRB)::ZTENU (KLON, KLEV,KGPBLKS)
REAL (KIND=JPRB)::ZMFDDR (KLON, KLEV,KGPBLKS)
REAL (KIND=JPRB)::ZMFUDR (KLON, KLEV,KGPBLKS)
REAL (KIND=JPRB)::ZMFDUS (KLON, KLEV,KGPBLKS)
REAL (KIND=JPRB)::ZMFUUS (KLON, KLEV,KGPBLKS)
REAL (KIND=JPRB)::ZMFS (KLON,KGPBLKS)

#include "cuascn.intfb.h"
#include "cubasen.intfb.h"
#include "cuddrafn.intfb.h"
#include "cudlfsn.intfb.h"
#include "cudtdqn.intfb.h"
#include "cududv.intfb.h"
#include "cuflxn.intfb.h"
#include "cuinin.intfb.h"
#include "cuctracer.intfb.h"
#include "fcttre.func.h"
TYPE (FXTRAN_ACDC_STACK) :: YLSTACK
INTEGER :: JBLK

!$ACC DATA &
!$ACC&CREATE (ICTOP0, IDPL, IDTOP, ILAB, LLDCUM, LLDDRAF, LLDDRAF3, LLO2, LLSCVFLAG, &
!$ACC&        ZCAPDCYCL, ZCAPDCYCLLD, ZCAPDCYCLSE, ZCAPE, ZCAPE2, ZCAPPBL, ZDHPBL, &
!$ACC&        ZDMFDE, ZDMFDP, ZDMFDPC, ZDMFEN, ZDMFUP, ZDMFUPC, ZDPMEL, ZDQCV, ZDX, &
!$ACC&        ZFACCA, ZHEAT, ZKHFL, ZKHVFL, ZKINED, ZKINEU, ZKMFL, ZMFCFL, ZMFDDR, &
!$ACC&        ZMFDQ, ZMFDS, ZMFDUS, ZMFS, ZMFUB, ZMFUB1, ZMFUDR, ZMFUL, ZMFUQ, ZMFUS, &
!$ACC&        ZMFUUB, ZMFUUS, ZMFUVB, ZMF_SHAL, ZQD, ZQENH, ZQENH2, ZQSENH, ZRFL, ZSATFR, &
!$ACC&        ZSUM12, ZSUM22, ZTAU, ZTAUPBL, ZTD, ZTENH, ZTENH2, ZTENU, ZTENV, ZUD, ZUU, &
!$ACC&        ZUV2, ZVD, ZVU, ZWUBASE, ZXTAU) &
!$ACC&IF (LDACC) &
!$ACC&PRESENT (KBOTSC, KCBOT, KCBOT_LIG, KCTOP, KCTOP_LIG, KTYPE, LDCUM, LDCUM_LIG, &
!$ACC&         LDLAND, LDSC, LDSHCV, PAHFS, PAP, PAPH, PCAPE, PCEN, PCUCONVCA, PDISS, &
!$ACC&         PDX, PENTH, PGAW, PGEO, PGEOH, PGP2DSPP, PLCRIT_AER, PLGLAC, PLITOT, &
!$ACC&         PLRAIN, PLU, PLUDE, PLUDELI, PMFD, PMFDDE_RATE, PMFLXR, PMFLXS, PMFU, &
!$ACC&         PMFUDE_RATE, PQEN, PQHFL, PQSEN, PQU, PRAIN, PRSUD, PSNDE, PTEN, PTENC, &
!$ACC&         PTENQ, PTENQA, PTENT, PTENTA, PTENU, PTENV, PTU, PUEN, PVDISCU, PVEN, PVERVEL, &
!$ACC&         PWMEAN, PWU, YDCHEM, YDCST, YDML_PHY_EC, YDML_PHY_SLIN, YDPERTPAR, &
!$ACC&         YDSPP_CONFIG, YDTHF, YGFL) 

#ifdef __PGI
CALL NVTXSTARTRANGE ('CUMASTRN_MANYBLOCKS')
#endif

ZCONS2=YDML_PHY_EC%YRECUMF%RMFCFL/(YDCST%RG*PTSPHY)
ZCONS=1.0_JPRB/(YDCST%RG*PTSPHY)
ZORCPD=1.0_JPRB/YDCST%RCPD
ZRDOCPD=YDCST%RD*ZORCPD
ZRG=1.0_JPRB/YDCST%RG

!$ACC PARALLEL LOOP GANG &
!$ACC&IF (LDACC) &
!$ACC&PRIVATE (JBLK) &
!$ACC&VECTOR_LENGTH (KLON) 


DO JBLK = 1, KGPBLKS
  
  !$ACC LOOP VECTOR &
  !$ACC&PRIVATE (JL) 

  

  DO JL = KIDIA, MERGE (KLON, KFDIA, JBLK < KGPBLKS)
    
    ZTAU (JL, JBLK)=0.0
  ENDDO

ENDDO


LLPERT_RTAU=.FALSE.


!$ACC PARALLEL LOOP GANG &
!$ACC&IF (LDACC) &
!$ACC&PRIVATE (JBLK) &
!$ACC&VECTOR_LENGTH (KLON) 


DO JBLK = 1, KGPBLKS
  
  !$ACC LOOP VECTOR &
  !$ACC&PRIVATE (JL, YLSTACK) 

  

  DO JL = KIDIA, MERGE (KLON, KFDIA, JBLK < KGPBLKS)
    YLSTACK%L8 = fxtran_acdc_stack_l8 (YFXTRAN_ACDC_STACK, (JBLK-1)+1, KGPBLKS)
    YLSTACK%U8 = fxtran_acdc_stack_u8 (YFXTRAN_ACDC_STACK, (JBLK-1)+1, KGPBLKS)
    YLSTACK%L4 = fxtran_acdc_stack_l4 (YFXTRAN_ACDC_STACK, (JBLK-1)+1, KGPBLKS)
    YLSTACK%U4 = fxtran_acdc_stack_u4 (YFXTRAN_ACDC_STACK, (JBLK-1)+1, KGPBLKS)
    
    
    PCAPE (JL, JBLK)=0.0_JPRB
    PVDISCU (JL, JBLK)=0.0_JPRB
    LDCUM (JL, JBLK)=.FALSE.
    
    CALL CUININ_OPENACC (YDCST, YDTHF, YDML_PHY_SLIN%YREPHLI, YDML_PHY_EC%YRECUMF, JL, JL, KLON, KLEV, PTEN&
    &(:, :, JBLK), PQEN(:, :, JBLK), PQSEN(:, :, JBLK), PUEN(:, :, JBLK), PVEN(:, :, JBLK), PGEO(:, :, JBLK&
    &), PAPH(:, :, JBLK), ILAB(:, :, JBLK), ZTENH(:, :, JBLK), ZQENH(:, :, JBLK), ZQSENH(:, :, JBLK), PGEOH&
    &(:, :, JBLK), PTU(:, :, JBLK), PQU(:, :, JBLK), ZTD(:, :, JBLK), ZQD(:, :, JBLK), ZUU(:, :, JBLK), ZVU&
    &(:, :, JBLK), ZUD(:, :, JBLK), ZVD(:, :, JBLK), PLU(:, :, JBLK), YDSTACK=YLSTACK)
    ZKMFL (JL, JBLK)=0.0_JPRB
  ENDDO

ENDDO

LLMIXS=LDTDKMF
CALL CUBASEN_MANYBLOCKS (PPLDARE, PPLRG, YDTHF, YDCST, YDML_PHY_SLIN%YREPHLI, YDML_PHY_EC&
&%YRECLDP, YDML_PHY_EC%YRECUMF, YDSPP_CONFIG, KIDIA, KFDIA, KLON, KLEV, YDML_PHY_EC&
&%YRECUMF%NJKT1, LLMIXS, LDTDKMF, ZTENH, ZQENH, PGEOH, PAPH, PQHFL, PAHFS, PGP2DSPP&
&, ZKMFL, PTEN, PQEN, PQSEN, PGEO, PTU, PQU, PLU, ZKINEU, ZWUBASE, ILAB, LDCUM, LDSC&
&, KCBOT, KBOTSC, ICTOP0, IDPL, PCAPE, LDACC = LDACC, KGPBLKS = KGPBLKS)

!$ACC PARALLEL LOOP GANG &
!$ACC&IF (LDACC) &
!$ACC&PRIVATE (JBLK) &
!$ACC&VECTOR_LENGTH (KLON) 


DO JBLK = 1, KGPBLKS
  
  !$ACC LOOP VECTOR &
  !$ACC&PRIVATE (JK, JL, ZDZ) 

  

  DO JL = KIDIA, MERGE (KLON, KFDIA, JBLK < KGPBLKS)
    
    
    ZDHPBL (JL, JBLK)=0.0_JPRB
    IDTOP (JL, JBLK)=0
    ZCAPPBL (JL, JBLK)=0.
    ZKHVFL (JL, JBLK)=(-PAHFS (JL, KLEV+1, JBLK)*ZORCPD-YDCST%RETV*PTEN&
    & (JL, KLEV, JBLK)*PQHFL (JL, KLEV+1, JBLK))/(PPLRG*PPLDARE)
    ZKHFL (JL, JBLK)=(-PAHFS (JL, KLEV+1, JBLK)-YDCST%RLVTT*PQHFL (JL, KLEV+1, JBLK))/(PPLRG*PPLDARE)

    

    DO JK=YDML_PHY_EC%YRECUMF%NJKT2, KLEV

      

      IF (LDCUM (JL, JBLK).AND.JK>=KCBOT (JL, JBLK)) THEN
        ZDZ=(PAPH (JL, JK+1, JBLK)-PAPH (JL, JK, JBLK))
        ZDHPBL (JL, JBLK)=ZDHPBL (JL, JBLK)+(YDCST%RLVTT*PTENQ &
        &(JL, JK, JBLK)+YDCST%RCPD*PTENT (JL, JK, JBLK))*ZDZ
        ZCAPPBL (JL, JBLK)=ZCAPPBL (JL, JBLK)+(PTENT (JL, JK, JBLK)+YDCST&
        &%RETV*PTEN (JL, JK, JBLK)*PTENQ (JL, JK, JBLK))*ZDZ
      ENDIF

    
    ENDDO

  ENDDO

ENDDO


!$ACC PARALLEL LOOP GANG &
!$ACC&IF (LDACC) &
!$ACC&PRIVATE (JBLK) &
!$ACC&VECTOR_LENGTH (KLON) 


DO JBLK = 1, KGPBLKS
  
  !$ACC LOOP VECTOR &
  !$ACC&PRIVATE (IKB, ITOPM2, JL, ZDH, ZDQMIN, ZDZ, ZMFMAX, ZPBMPT, ZQUMQE) 

  

  DO JL = KIDIA, MERGE (KLON, KFDIA, JBLK < KGPBLKS)

    

    

    IF (LDCUM (JL, JBLK)) THEN
      IKB=KCBOT (JL, JBLK)
      ITOPM2=ICTOP0 (JL, JBLK)
      ZPBMPT=PAPH (JL, IKB, JBLK)-PAPH (JL, ITOPM2, JBLK)

      IF (ZPBMPT>=YDML_PHY_EC%YRECUMF%RDEPTHS) THEN
        KTYPE (JL, JBLK)=1
      ELSE
        KTYPE (JL, JBLK)=2
      ENDIF

    ELSE
      KTYPE (JL, JBLK)=0
    ENDIF


    

    IF (YDML_PHY_EC%YRECUMF%LMFWSTAR) THEN

      

      IF (LDCUM (JL, JBLK)) THEN
        IKB=KCBOT (JL, JBLK)
        ZDZ=MAX (0.0_JPRB, MIN (1.5E3_JPRB,(PGEOH (JL, IKB, JBLK)-PGEOH (JL, KLEV+1, JBLK))/YDCST%RG))
        ZMF_SHAL (JL, JBLK)=0.07_JPRB*(YDCST%RG/PTEN (JL, KLEV,&
        & JBLK)*ZDZ*MAX (0.0_JPRB, ZKHVFL (JL, JBLK)))**.3333
        ZMFMAX=(PAPH (JL, IKB, JBLK)-PAPH (JL, IKB-1, JBLK))*ZCONS2
        ZMF_SHAL (JL, JBLK)=MIN (ZMF_SHAL (JL, JBLK), ZMFMAX)
      ENDIF

    
    ENDIF


    

    IF (LDCUM (JL, JBLK)) THEN
      IKB=KCBOT (JL, JBLK)
      ZMFMAX=(PAPH (JL, IKB, JBLK)-PAPH (JL, IKB-1, JBLK))*ZCONS2

      IF (KTYPE (JL, JBLK)==1) THEN
        ZMFUB (JL, JBLK)=ZMFMAX*0.1_JPRB
      ELSEIF (KTYPE (JL, JBLK)==2) THEN
        ZQUMQE=PQU (JL, IKB, JBLK)+PLU (JL, IKB, JBLK)-ZQENH (JL, IKB, JBLK)
        ZDQMIN=MAX (0.01_JPRB*ZQENH (JL, IKB, JBLK), 1.E-10_JPRB)
        ZDH=YDCST%RCPD*(PTU (JL, IKB, JBLK)-ZTENH (JL, IKB, JBLK))+YDCST%RLVTT*ZQUMQE
        ZDH=YDCST%RG*MAX (ZDH, 1.E5_JPRB*ZDQMIN)

        IF (ZDHPBL (JL, JBLK)>0.0_JPRB) THEN
          ZMFUB (JL, JBLK)=ZDHPBL (JL, JBLK)/ZDH
          ZMFUB (JL, JBLK)=MIN (ZMFUB (JL, JBLK), ZMFMAX)
        ELSE
          ZMFUB (JL, JBLK)=ZMFMAX*0.1_JPRB
          LDCUM (JL, JBLK)=.FALSE.
        ENDIF


        IF (YDML_PHY_EC%YRECUMF%LMFWSTAR)  THEN
          ZMFUB (JL, JBLK)=ZMF_SHAL (JL, JBLK)
        ENDIF

      ENDIF

    ELSE
      ZMFUB (JL, JBLK)=0.0_JPRB
    ENDIF

  
  ENDDO

ENDDO

CALL CUASCN_MANYBLOCKS (YDTHF, YDCST, YDML_PHY_SLIN%YREPHLI, YDML_PHY_EC%YRECLDP, YDML_PHY_EC&
&%YRECUMF, YDSPP_CONFIG, YGFL, KIDIA, KFDIA, KLON, KLEV, LDTDKMF, PTSPHY, ZTENH, ZQENH,&
& PUEN, PVEN, PTEN, PQEN, PQSEN, PLITOT, PGEO, PGEOH, PAP, PAPH, PVERVEL, ZWUBASE, PGP2DSPP&
&, LDLAND, LDCUM, KTYPE, ILAB, LLSCVFLAG, PTU, PQU, PLU, PLRAIN, PMFU, ZMFUB, PLGLAC, ZMFUS&
&, ZMFUQ, ZMFUL, PLUDE, PLUDELI, ZDMFUP, PLCRIT_AER, ZDMFEN, KCBOT, KCTOP, ICTOP0, IDPL&
&, PMFUDE_RATE, ZKINEU, PWU, PWMEAN, LDACC = LDACC, KGPBLKS = KGPBLKS)

!$ACC PARALLEL LOOP GANG &
!$ACC&IF (LDACC) &
!$ACC&PRIVATE (JBLK) &
!$ACC&VECTOR_LENGTH (KLON) 


DO JBLK = 1, KGPBLKS
  
  !$ACC LOOP VECTOR &
  !$ACC&PRIVATE (IKB, ITOPM2, JK, JL, ZPBMPT) 

  

  DO JL = KIDIA, MERGE (KLON, KFDIA, JBLK < KGPBLKS)

    

    

    IF (LDCUM (JL, JBLK)) THEN
      IKB=KCBOT (JL, JBLK)
      ITOPM2=KCTOP (JL, JBLK)
      ZPBMPT=PAPH (JL, IKB, JBLK)-PAPH (JL, ITOPM2, JBLK)

      IF (KTYPE (JL, JBLK)==1.AND.ZPBMPT<YDML_PHY_EC%YRECUMF%RDEPTHS)  THEN
        KTYPE (JL, JBLK)=2
      ENDIF


      IF (KTYPE (JL, JBLK)==2.AND.ZPBMPT>=YDML_PHY_EC%YRECUMF%RDEPTHS)  THEN
        KTYPE (JL, JBLK)=1
      ENDIF

      ICTOP0 (JL, JBLK)=KCTOP (JL, JBLK)
    ENDIF

    ZRFL (JL, JBLK)=ZDMFUP (JL, 1, JBLK)

    

    DO JK=2, KLEV
      
      ZRFL (JL, JBLK)=ZRFL (JL, JBLK)+ZDMFUP (JL, JK, JBLK)
    
    ENDDO


    DO JK=1, KLEV
      
      PMFD (JL, JK, JBLK)=0.0_JPRB
      ZMFDS (JL, JK, JBLK)=0.0_JPRB
      ZMFDQ (JL, JK, JBLK)=0.0_JPRB
      ZDMFDP (JL, JK, JBLK)=0.0_JPRB
      ZDPMEL (JL, JK, JBLK)=0.0_JPRB
    
    ENDDO


    DO JK=1, KLEV
      
      ZTENU (JL, JK, JBLK)=PTENU (JL, JK, JBLK)
      ZTENV (JL, JK, JBLK)=PTENV (JL, JK, JBLK)
    
    ENDDO

  ENDDO

ENDDO


!$ACC PARALLEL LOOP GANG &
!$ACC&IF (LDACC) &
!$ACC&PRIVATE (JBLK) &
!$ACC&VECTOR_LENGTH (KLON) 


DO JBLK = 1, KGPBLKS
  
  !$ACC LOOP VECTOR &
  !$ACC&PRIVATE (JL, YLSTACK) 

  

  DO JL = KIDIA, MERGE (KLON, KFDIA, JBLK < KGPBLKS)
    YLSTACK%L8 = fxtran_acdc_stack_l8 (YFXTRAN_ACDC_STACK, (JBLK-1)+1, KGPBLKS)
    YLSTACK%U8 = fxtran_acdc_stack_u8 (YFXTRAN_ACDC_STACK, (JBLK-1)+1, KGPBLKS)
    YLSTACK%L4 = fxtran_acdc_stack_l4 (YFXTRAN_ACDC_STACK, (JBLK-1)+1, KGPBLKS)
    YLSTACK%U4 = fxtran_acdc_stack_u4 (YFXTRAN_ACDC_STACK, (JBLK-1)+1, KGPBLKS)

    

    IF (YDML_PHY_EC%YRECUMF%LMFDD) THEN
      CALL CUDLFSN_OPENACC (YDTHF, YDCST, YDML_PHY_SLIN%YREPHLI, YDML_PHY_EC%YRECUMF, JL, JL&
      &, KLON, KLEV, KCBOT(:, JBLK), KCTOP(:, JBLK), LDCUM(:, JBLK), ZTENH(:, :, JBLK), ZQENH&
      &(:, :, JBLK), PTEN(:, :, JBLK), PQSEN(:, :, JBLK), PGEO(:, :, JBLK), PGEOH(:, :, JBLK&
      &), PAPH(:, :, JBLK), PTU(:, :, JBLK), PQU(:, :, JBLK), ZMFUB(:, JBLK), ZRFL(:, JBLK)&
      &, ZTD(:, :, JBLK), ZQD(:, :, JBLK), PMFD(:, :, JBLK), ZMFDS(:, :, JBLK), ZMFDQ(:, :,&
      & JBLK), ZDMFDP(:, :, JBLK), IDTOP(:, JBLK), LLDDRAF(:, JBLK), YDSTACK=YLSTACK)
      CALL CUDDRAFN_OPENACC (YDCST, YDTHF, YDML_PHY_SLIN%YREPHLI, YDML_PHY_EC%YRECUMF, JL, JL, KLON&
      &, KLEV, LLDDRAF(:, JBLK), ZTENH(:, :, JBLK), ZQENH(:, :, JBLK), PQSEN(:, :, JBLK), PGEO(:, :&
      &, JBLK), PGEOH(:, :, JBLK), PAPH(:, :, JBLK), ZRFL(:, JBLK), ZTD(:, :, JBLK), ZQD(:, :, JBLK&
      &), PMFU(:, :, JBLK), PMFD(:, :, JBLK), ZMFDS(:, :, JBLK), ZMFDQ(:, :, JBLK), ZDMFDP(:, :, JBLK&
      &), ZDMFDE(:, :, JBLK), PMFDDE_RATE(:, :, JBLK), ZKINED(:, :, JBLK), YDSTACK=YLSTACK)
    ENDIF

  ENDDO

ENDDO


!$ACC PARALLEL LOOP GANG &
!$ACC&IF (LDACC) &
!$ACC&PRIVATE (JBLK) &
!$ACC&VECTOR_LENGTH (KLON) 


DO JBLK = 1, KGPBLKS
  
  !$ACC LOOP VECTOR &
  !$ACC&PRIVATE (IK, IKB, IKD, JK, JL, LLO1, LLO3, ZDUTEN, ZDZ, ZIND, ZTAURES) 

  

  DO JL = KIDIA, MERGE (KLON, KFDIA, JBLK < KGPBLKS)
    
    
    ZHEAT (JL, JBLK)=0.0_JPRB
    ZCAPE (JL, JBLK)=0.0_JPRB
    ZCAPE2 (JL, JBLK)=0.0_JPRB
    ZMFUB1 (JL, JBLK)=ZMFUB (JL, JBLK)
    ZDQCV (JL, JBLK)=0.0_JPRB
    ZSATFR (JL, JBLK)=0.0_JPRB
    ZDX (JL, JBLK)=2*YDCST%RA*SQRT (YDCST%RPI*PGAW (JL, JBLK))
    ZDX (JL, JBLK)=MAX (ZDX (JL, JBLK), 1.E2_JPRB)

    

    DO JK=YDML_PHY_EC%YRECUMF%NJKT2, KLEV
      
      LLO1=LDCUM (JL, JBLK).AND.KTYPE (JL, JBLK)==1
      LLO3=LLO1.AND.JK<=KCBOT (JL, JBLK).AND.JK>KCTOP (JL, JBLK)

      IF (LLO3) THEN
        ZDZ=(PGEO (JL, JK-1, JBLK)-PGEO (JL, JK, JBLK))

        IF (LDTDKMF) THEN
          ZHEAT (JL, JBLK)=ZHEAT (JL, JBLK)+((PTEN (JL, JK-1, JBLK)-PTEN (JL, JK, JBLK&
          &)+ZDZ*ZORCPD)/ZTENH (JL, JK, JBLK)+YDCST%RETV*(PQEN (JL, JK-1, JBLK)-PQEN &
          &(JL, JK, JBLK)))*(YDCST%RG*(PMFU (JL, JK, JBLK)+PMFD (JL, JK, JBLK)))
        ELSE
          ZHEAT (JL, JBLK)=ZHEAT (JL, JBLK)+MAX (0.0_JPRB,((PTEN (JL, JK-1, JBLK)-PTEN (JL&
          &, JK, JBLK)+ZDZ*ZORCPD)/ZTENH (JL, JK, JBLK)+YDCST%RETV*(PQEN (JL, JK-1, JBLK)-PQEN&
          & (JL, JK, JBLK)))*(YDCST%RG*(PMFU (JL, JK, JBLK)+PMFD (JL, JK, JBLK))))
        ENDIF

        ZDZ=(PAP (JL, JK, JBLK)-PAP (JL, JK-1, JBLK))
        ZCAPE (JL, JBLK)=ZCAPE (JL, JBLK)+((PTU (JL, JK, JBLK)-ZTENH (JL, JK, JBLK))/ZTENH (JL, JK&
        &, JBLK)+YDCST%RETV*(PQU (JL, JK, JBLK)-ZQENH (JL, JK, JBLK))-PLU (JL, JK, JBLK))*ZDZ
      ENDIF


      IF (LLO3.AND.YDML_PHY_EC%YRECUMF%RCAPQADV>0.0_JPRB) THEN
        ZTENH2 (JL, JK, JBLK)=ZTENH (JL, JK, JBLK)-0.5_JPRB*(PTENTA&
        & (JL, JK, JBLK)+PTENTA (JL, JK-1, JBLK))*PTSPHY
        ZQENH2 (JL, JK, JBLK)=ZQENH (JL, JK, JBLK)-0.5_JPRB*(PTENQA&
        & (JL, JK, JBLK)+PTENQA (JL, JK-1, JBLK))*PTSPHY
        ZCAPE2 (JL, JBLK)=ZCAPE2 (JL, JBLK)+((PTU (JL, JK, JBLK)-ZTENH2 (JL, JK, JBLK))/ZTENH2 (JL,&
        & JK, JBLK)+YDCST%RETV*(PQU (JL, JK, JBLK)-ZQENH2 (JL, JK, JBLK))-PLU (JL, JK, JBLK))*ZDZ
      ENDIF


      IF (LLO1) THEN
        ZDZ=(PAPH (JL, JK+1, JBLK)-PAPH (JL, JK, JBLK))
        ZDQCV (JL, JBLK)=ZDQCV (JL, JBLK)+PTENQA (JL, JK, JBLK&
        &)*ZDZ*(PQEN (JL, JK, JBLK)/PQSEN (JL, JK, JBLK))
      ENDIF


      IF (LLO1.AND.JK>=KCTOP (JL, JBLK)) THEN
        ZDZ=(PAPH (JL, JK+1, JBLK)-PAPH (JL, JK, JBLK))
        ZSATFR (JL, JBLK)=ZSATFR (JL, JBLK)+(PQEN (JL, JK, JBLK)/PQSEN (JL, JK, JBLK))*ZDZ
      ENDIF

    
    ENDDO

    
    ZCAPDCYCL (JL, JBLK)=0.0_JPRB
    ZTAU (JL, JBLK)=0.0_JPRB

    IF (LDTDKMF) THEN
      ZDX (JL, JBLK)=PDX (JL, JBLK)
      ZDX (JL, JBLK)=MAX (ZDX (JL, JBLK), 1.E2_JPRB)
    ENDIF


    IF (LDCUM (JL, JBLK).AND.KTYPE (JL, JBLK)==1) THEN

      IF (YDML_PHY_EC%YRECUMF%LNEWTAU) THEN
        ZTAURES=YDML_PHY_EC%YRECUMF%RTAULIM*(1._JPRB+YDML_PHY_EC%YRECUMF%RTAUFAC&
        &/((ZDX (JL, JBLK)/1000._JPRB-YDML_PHY_EC%YRECUMF%RXMIN+1._JPRB)**2))
      ELSE
        ZTAURES=1.0_JPRB+1.60_JPRB*ZDX (JL, JBLK)/125.E3_JPRB

        IF (ZDX (JL, JBLK)<8.E3_JPRB) THEN
          ZTAURES=1.0_JPRB+(LOG (8.E3_JPRB/ZDX (JL, JBLK)))**2
        ENDIF

      ENDIF


      IF (ZDX (JL, JBLK)>125.E3_JPRB)  THEN
        ZTAURES=MIN (3.0_JPRB, ZTAURES)
      ENDIF

      IKD=IDPL (JL, JBLK)
      IKB=KCBOT (JL, JBLK)
      IK=KCTOP (JL, JBLK)
      ZTAU (JL, JBLK)=(PGEOH (JL, IK, JBLK)-PGEOH (JL, IKB, JBLK))/((2.0_JPRB+MIN (15&
      &.0_JPRB, PWMEAN (JL, JBLK)))*YDCST%RG)*ZTAURES*YDML_PHY_EC%YRECUMF%RTAUA
      
      ZXTAU (JL, JBLK)=ZTAU (JL, JBLK)
      
      LLO1=PAPH (JL, KLEV+1, JBLK)-PAPH (JL, IKD, JBLK)<50.E2_JPRB

      IF (LLO1.AND.LDLAND (JL, JBLK).AND.YDML_PHY_EC%YRECUMF%RCAPDCYCL==1.0_JPRB) THEN
        ZDZ=MIN (1.E4_JPRB, PGEOH (JL, IKB, JBLK)-PGEOH (JL, KLEV+1, JBLK))/YDCST%RG
        ZCAPDCYCL (JL, JBLK)=ZXTAU (JL, JBLK)*MAX (0.0_JPRB, ZKHVFL (JL, JBLK))*YDCST%RCPD/ZDZ
      ENDIF


      IF (LLO1.AND.YDML_PHY_EC%YRECUMF%RCAPDCYCL==2.0_JPRB) THEN
        ZIND=MAX (0._JPRB, MIN (1._JPRB,(YDML_PHY_EC%YRECUMF%RDXMAX-ZDX (JL,&
        & JBLK))/(YDML_PHY_EC%YRECUMF%RDXMAX-YDML_PHY_EC%YRECUMF%RDXMIN)))

        IF (LDLAND (JL, JBLK))  THEN
          ZIND=1._JPRB
        ENDIF

        ZCAPDCYCLLD (JL, JBLK)=ZCAPPBL (JL, JBLK)*ZTAU (JL, JBLK)/ZTAURES
        ZDUTEN=2.0_JPRB+SQRT (0.5*(PUEN (JL, IKB, JBLK)**2+PVEN (JL, IKB, JBLK)**2+PUEN (JL, YDML_PHY_EC&
        &%YRECUMF%NJKT3, JBLK)**2+PVEN (JL, YDML_PHY_EC%YRECUMF%NJKT3, JBLK)**2))
        ZTAUPBL (JL, JBLK)=MIN (1.E4_JPRB, PGEOH (JL, IKB, JBLK)-PGEOH (JL, KLEV+1, JBLK))/(YDCST%RG*ZDUTEN)
        ZCAPDCYCLSE (JL, JBLK)=ZCAPPBL (JL, JBLK)*ZTAUPBL (JL, JBLK)
        ZCAPDCYCL (JL, JBLK)=ZIND*ZCAPDCYCLLD (JL, JBLK)+(1._JPRB-ZIND)*ZCAPDCYCLSE (JL, JBLK)
      ENDIF

      ZDQCV (JL, JBLK)=ZDQCV (JL, JBLK)*YDCST%RLVTT/PGEOH (JL, IK, JBLK)*ZXTAU&
      & (JL, JBLK)/MAX (1.25_JPRB, ZTAURES)*YDML_PHY_EC%YRECUMF%RCAPQADV
      ZSATFR (JL, JBLK)=ZSATFR (JL, JBLK)/(PAPH (JL, KLEV+1, JBLK)-PAPH (JL, IK, JBLK))
    ELSE
      ZTAU (JL, JBLK)=0.0_JPRB
    ENDIF

  
  ENDDO

ENDDO


!$ACC PARALLEL LOOP GANG &
!$ACC&IF (LDACC) &
!$ACC&PRIVATE (JBLK) &
!$ACC&VECTOR_LENGTH (KLON) 


DO JBLK = 1, KGPBLKS
  
  !$ACC LOOP VECTOR &
  !$ACC&PRIVATE (IKB, JL, ZMFMAX) 

  

  DO JL = KIDIA, MERGE (KLON, KFDIA, JBLK < KGPBLKS)

    

    IF (YDML_PHY_EC%YRECUMF%LMFCUCA) THEN
      
      ZFACCA (JL, JBLK)=MAX (0.3_JPRB, MIN (1.8_JPRB, PCUCONVCA (JL, JBLK)))
    
    ELSE
      ZFACCA (JL, JBLK)=1.0_JPRB
    ENDIF


    

    IF (LDCUM (JL, JBLK).AND.KTYPE (JL, JBLK)==1) THEN
      IKB=KCBOT (JL, JBLK)
      ZCAPE2 (JL, JBLK)=YDML_PHY_EC%YRECUMF%RCAPQADV*ZCAPE2 (JL, JBLK&
      &)+(1.0_JPRB-YDML_PHY_EC%YRECUMF%RCAPQADV)*ZCAPE (JL, JBLK)
      ZCAPDCYCL (JL, JBLK)=MAX (ZCAPDCYCL (JL, JBLK),-2*ZCAPE2 (JL, JBLK))

      IF (ZSATFR (JL, JBLK)<=0.94.OR.PVERVEL (JL, YDML_PHY_EC%YRECUMF%NJKT5, JBLK)<-100._JPRB) THEN
        ZCAPE (JL, JBLK)=MAX (YDML_PHY_EC%YRECUMF%RMINCAPE*ZCAPE (JL, JBLK&
        &), ZCAPE2 (JL, JBLK)-ZCAPDCYCL (JL, JBLK)+ZDQCV (JL, JBLK))
      ELSE
        ZCAPE (JL, JBLK)=MAX (YDML_PHY_EC%YRECUMF%RMINCAPE*ZCAPE&
        & (JL, JBLK), ZCAPE (JL, JBLK)-ZCAPDCYCL (JL, JBLK))
      ENDIF

      ZCAPE (JL, JBLK)=MIN (ZCAPE (JL, JBLK), 5000.0_JPRB)
      ZHEAT (JL, JBLK)=MAX (1.E-4_JPRB, ZHEAT (JL, JBLK))
      ZXTAU (JL, JBLK)=MAX (3.6E3_JPRB/(5.0_JPRB*PPLRG*PPLDARE), MIN&
      & (3.0_JPRB*3.6E3_JPRB/(PPLRG*PPLDARE), ZXTAU (JL, JBLK)))
      ZMFUB1 (JL, JBLK)=(ZCAPE (JL, JBLK)*ZMFUB (JL, JBLK))/(ZHEAT (JL, JBLK)*ZXTAU (JL, JBLK))
      ZMFUB1 (JL, JBLK)=MAX (ZMFUB1 (JL, JBLK), 0.001_JPRB)*ZFACCA (JL, JBLK)
      ZMFMAX=(PAPH (JL, IKB, JBLK)-PAPH (JL, IKB-1, JBLK))*ZCONS2
      ZMFUB1 (JL, JBLK)=MIN (ZMFUB1 (JL, JBLK), ZMFMAX)
    ENDIF


    

    IF (LDMCAPEA) THEN
      
      PCAPE (JL, JBLK)=YDCST%RG*ZCAPE (JL, JBLK)
    
    ENDIF

  ENDDO

ENDDO


!$ACC PARALLEL LOOP GANG &
!$ACC&IF (LDACC) &
!$ACC&PRIVATE (JBLK) &
!$ACC&VECTOR_LENGTH (KLON) 


DO JBLK = 1, KGPBLKS
  
  !$ACC LOOP VECTOR &
  !$ACC&PRIVATE (IKB, JL, ZDH, ZDH2, ZEPS, ZMFMAX, ZQUMQE) 

  

  DO JL = KIDIA, MERGE (KLON, KFDIA, JBLK < KGPBLKS)

    

    

    IF (LDCUM (JL, JBLK).AND.KTYPE (JL, JBLK)>=2) THEN
      IKB=KCBOT (JL, JBLK)

      IF (PMFD (JL, IKB, JBLK)<0.0_JPRB) THEN
        ZEPS=-PMFD (JL, IKB, JBLK)/MAX (ZMFUB (JL, JBLK), 1.E-10_JPRB)
      ELSE
        ZEPS=0.0_JPRB
      ENDIF

      ZMFMAX=(PAPH (JL, IKB, JBLK)-PAPH (JL, IKB-1, JBLK))*ZCONS2

      IF (KTYPE (JL, JBLK)==2) THEN

        IF (ZDHPBL (JL, JBLK)>0.0_JPRB) THEN
          ZQUMQE=PQU (JL, IKB, JBLK)+PLU (JL, IKB, JBLK)-ZEPS*ZQD &
          &(JL, IKB, JBLK)-(1.0_JPRB-ZEPS)*ZQENH (JL, IKB, JBLK)
          ZDH=YDCST%RCPD*(PTU (JL, IKB, JBLK)-ZEPS*ZTD (JL, IKB, JBLK)-&
          &(1.0_JPRB-ZEPS)*ZTENH (JL, IKB, JBLK))+YDCST%RLVTT*ZQUMQE
          ZDH2=YDCST%RCPD*(PTU (JL, IKB-1, JBLK)-ZEPS*ZTD (JL, IKB-1, JBLK&
          &)-(1.0_JPRB-ZEPS)*ZTENH (JL, IKB-1, JBLK))+YDCST%RLVTT*ZQUMQE
          ZDH=0.5_JPRB*(ZDH+ZDH2)
          ZDH=YDCST%RG*MAX (ZDH, 0.1_JPRB*YDCST%RCPD)
          ZMFUB1 (JL, JBLK)=ZDHPBL (JL, JBLK)/ZDH

          IF (.NOT.LDTDKMF) THEN

            IF (ZMFUB1 (JL, JBLK)>0.9_JPRB*ZMFMAX/YDML_PHY_EC%YRECUMF&
              &%RMFCFL.AND.ZDH<0.5_JPRB*YDCST%RG*YDCST%RCPD) THEN
              ZDH=0.75_JPRB*YDCST%RCPD*YDCST%RG
              ZMFUB1 (JL, JBLK)=ZDHPBL (JL, JBLK)/ZDH
            ENDIF

          ENDIF

        ELSE
          ZMFUB1 (JL, JBLK)=ZMFUB (JL, JBLK)
        ENDIF


        IF (YDML_PHY_EC%YRECUMF%LMFWSTAR)  THEN
          ZMFUB1 (JL, JBLK)=ZMF_SHAL (JL, JBLK)
        ENDIF

        ZMFUB1 (JL, JBLK)=MIN (ZMFUB1 (JL, JBLK), ZMFMAX)
      ENDIF


      IF (KTYPE (JL, JBLK)==3) THEN

        IF (LDTDKMF) THEN
          ZMFUB1 (JL, JBLK)=MAX (ZMFUB (JL, JBLK), ZKHFL (JL, JBLK)/PGEOH (JL, IKB, JBLK))*(1.0_JPRB+ZEPS)
        ELSE
          ZMFUB1 (JL, JBLK)=MAX (ZMFUB (JL, JBLK), 5*ZKHFL (JL, JBLK)/PGEOH (JL, IKB, JBLK))*(1.0_JPRB+ZEPS)
        ENDIF


        IF (PGEOH (JL, IKB, JBLK)<1.5E3_JPRB) THEN
          ZMFUB1 (JL, JBLK)=MIN (ZMFUB1 (JL, JBLK), ZMFMAX/(1.05_JPRB*YDML_PHY_EC%YRECUMF%RMFCFL))
        ELSE
          ZMFUB1 (JL, JBLK)=MIN (ZMFUB1 (JL, JBLK), ZMFMAX)
        ENDIF

      ENDIF

    ENDIF

  
  ENDDO

ENDDO


!$ACC PARALLEL LOOP GANG &
!$ACC&IF (LDACC) &
!$ACC&PRIVATE (JBLK) &
!$ACC&VECTOR_LENGTH (KLON) 


DO JBLK = 1, KGPBLKS
  
  !$ACC LOOP VECTOR &
  !$ACC&PRIVATE (IKB, JK, JL, ZDZ, ZFAC, ZMFMAX) 

  

  DO JL = KIDIA, MERGE (KLON, KFDIA, JBLK < KGPBLKS)

    

    DO JK=1, KLEV

      

      IF (LLDDRAF (JL, JBLK).AND.(KTYPE (JL, JBLK)==1.OR.KTYPE (JL, JBLK)==2)) THEN
        ZFAC=ZMFUB1 (JL, JBLK)/MAX (ZMFUB (JL, JBLK), 1.E-10_JPRB)
        PMFD (JL, JK, JBLK)=PMFD (JL, JK, JBLK)*ZFAC
        ZMFDS (JL, JK, JBLK)=ZMFDS (JL, JK, JBLK)*ZFAC
        ZMFDQ (JL, JK, JBLK)=ZMFDQ (JL, JK, JBLK)*ZFAC
        ZDMFDP (JL, JK, JBLK)=ZDMFDP (JL, JK, JBLK)*ZFAC
        PMFDDE_RATE (JL, JK, JBLK)=PMFDDE_RATE (JL, JK, JBLK)*ZFAC
      ENDIF

    
    ENDDO


    

    IF (LDCUM (JL, JBLK)) THEN
      ZMFS (JL, JBLK)=ZMFUB1 (JL, JBLK)/MAX (YDML_PHY_EC%YRECUMF%RMFCMIN, ZMFUB (JL, JBLK))
    ENDIF


    

    DO JK=2, KLEV

      

      IF (LDCUM (JL, JBLK).AND.JK>=KCTOP (JL, JBLK)-1) THEN
        IKB=KCBOT (JL, JBLK)

        IF (JK>IKB) THEN
          ZDZ=((PAPH (JL, KLEV+1, JBLK)-PAPH (JL, JK, JBLK))/(PAPH (JL, KLEV+1, JBLK)-PAPH (JL, IKB, JBLK)))
          PMFU (JL, JK, JBLK)=PMFU (JL, IKB, JBLK)*ZDZ
        ENDIF

        ZMFMAX=(PAPH (JL, JK, JBLK)-PAPH (JL, JK-1, JBLK))*ZCONS2

        IF (.NOT.LDTDKMF)  THEN
          ZMFMAX=MIN (ZMFMAX, YDML_PHY_EC%YRECUMF%RMFLIA)
        ENDIF


        IF (PMFU (JL, JK, JBLK)*ZMFS (JL, JBLK)>ZMFMAX) THEN
          ZMFS (JL, JBLK)=MIN (ZMFS (JL, JBLK), ZMFMAX/PMFU (JL, JK, JBLK))
          ZMFS (JL, JBLK)=MAX (ZMFS (JL, JBLK), 1.E-10_JPRB)
        ENDIF

      ENDIF

    
    ENDDO


    IF (YDML_PHY_EC%YRECUMF%RMFADVW>0.0_JPRB) THEN

      DO JK=2, KLEV-1

        

        IF (KTYPE (JL, JBLK)==1.AND.JK>=KCTOP (JL, JBLK)-1) THEN
          ZFAC=ZMFS (JL, JBLK)*YDCST%RG*YDML_PHY_EC%YRECUMF%RMFADVW*(PMFU (JL, JK, JBLK&
          &)-PMFU (JL, JK+1, JBLK)+YDML_PHY_EC%YRECUMF%RMFADVWDD*(PMFD (JL, JK, JBLK)-PMFD&
          & (JL, JK+1, JBLK)))/(PAPH (JL, JK, JBLK)-PAPH (JL, JK+1, JBLK))*PTSPHY

          IF (ABS (ZFAC)>0.98_JPRB)  THEN
            ZMFS (JL, JBLK)=ZMFS (JL, JBLK)/MAX (1.02_JPRB, ABS (ZFAC))
          ENDIF

        ENDIF

      
      ENDDO

      JK=KLEV

      

      IF (KTYPE (JL, JBLK)==1) THEN
        ZFAC=ZMFS (JL, JBLK)*YDCST%RG*YDML_PHY_EC%YRECUMF%RMFADVW*(PMFU (JL, JK, JBLK)+YDML_PHY_EC%YRECUMF&
        &%RMFADVWDD*PMFD (JL, JK, JBLK))/(PAPH (JL, JK, JBLK)-PAPH (JL, JK+1, JBLK))*PTSPHY

        IF (ABS (ZFAC)>0.98_JPRB)  THEN
          ZMFS (JL, JBLK)=ZMFS (JL, JBLK)/MAX (1.02_JPRB, ABS (ZFAC))
        ENDIF

      ENDIF

    
    ENDIF

  ENDDO

ENDDO


!$ACC PARALLEL LOOP GANG &
!$ACC&IF (LDACC) &
!$ACC&PRIVATE (JBLK) &
!$ACC&VECTOR_LENGTH (KLON) 


DO JBLK = 1, KGPBLKS
  
  !$ACC LOOP VECTOR &
  !$ACC&PRIVATE (JK, JL) 

  

  DO JL = KIDIA, MERGE (KLON, KFDIA, JBLK < KGPBLKS)

    

    DO JK=2, KLEV

      

      IF (LDCUM (JL, JBLK).AND.JK<=KCBOT (JL, JBLK).AND.JK>=KCTOP (JL, JBLK)-1) THEN
        PMFU (JL, JK, JBLK)=PMFU (JL, JK, JBLK)*ZMFS (JL, JBLK)
        ZMFUS (JL, JK, JBLK)=ZMFUS (JL, JK, JBLK)*ZMFS (JL, JBLK)
        ZMFUQ (JL, JK, JBLK)=ZMFUQ (JL, JK, JBLK)*ZMFS (JL, JBLK)
        ZMFUL (JL, JK, JBLK)=ZMFUL (JL, JK, JBLK)*ZMFS (JL, JBLK)
        ZDMFUP (JL, JK, JBLK)=ZDMFUP (JL, JK, JBLK)*ZMFS (JL, JBLK)
        ZDMFEN (JL, JK, JBLK)=ZDMFEN (JL, JK, JBLK)*ZMFS (JL, JBLK)
        PLUDE (JL, JK, JBLK)=PLUDE (JL, JK, JBLK)*ZMFS (JL, JBLK)
        PLUDELI (JL, JK, 1, JBLK)=PLUDELI (JL, JK, 1, JBLK)*ZMFS (JL, JBLK)
        PLUDELI (JL, JK, 2, JBLK)=PLUDELI (JL, JK, 2, JBLK)*ZMFS (JL, JBLK)
        PMFUDE_RATE (JL, JK, JBLK)=PMFUDE_RATE (JL, JK, JBLK)*ZMFS (JL, JBLK)
      ENDIF

    
    ENDDO


    

    IF (KTYPE (JL, JBLK)==2.AND.KCBOT (JL, JBLK)==KCTOP (JL, JBLK).AND.KCBOT (JL, JBLK)>=KLEV-1) THEN
      LDCUM (JL, JBLK)=.FALSE.
      KTYPE (JL, JBLK)=0
    ENDIF

    
    
    LLO2 (JL, JBLK)=.FALSE.

    IF ((.NOT.LDSHCV (JL, JBLK).AND.KTYPE (JL, JBLK)==2)) THEN
      LLO2 (JL, JBLK)=.TRUE.
      LDCUM (JL, JBLK)=.FALSE.
    ENDIF

    
    
    LDCUM_LIG (JL, JBLK)=LDCUM (JL, JBLK)
    KCTOP_LIG (JL, JBLK)=KCTOP (JL, JBLK)
    KCBOT_LIG (JL, JBLK)=KCBOT (JL, JBLK)

    

    IF (.NOT.YDML_PHY_EC%YRECUMF%LMFSCV.OR..NOT.YDML_PHY_EC%YRECUMF%LMFPEN) THEN

      

      IF ((.NOT.YDML_PHY_EC%YRECUMF%LMFSCV.AND.KTYPE (JL, JBLK)==2).OR.(&
        &.NOT.YDML_PHY_EC%YRECUMF%LMFPEN.AND.KTYPE (JL, JBLK)==1)) THEN
        LLO2 (JL, JBLK)=.TRUE.
        LDCUM (JL, JBLK)=.FALSE.
      ENDIF

    
    ENDIF

  ENDDO

ENDDO

ITOPM2=2

!$ACC PARALLEL LOOP GANG &
!$ACC&IF (LDACC) &
!$ACC&PRIVATE (JBLK) &
!$ACC&VECTOR_LENGTH (KLON) 


DO JBLK = 1, KGPBLKS
  
  !$ACC LOOP VECTOR &
  !$ACC&PRIVATE (JK, JL, YLSTACK) 

  

  DO JL = KIDIA, MERGE (KLON, KFDIA, JBLK < KGPBLKS)
    YLSTACK%L8 = fxtran_acdc_stack_l8 (YFXTRAN_ACDC_STACK, (JBLK-1)+1, KGPBLKS)
    YLSTACK%U8 = fxtran_acdc_stack_u8 (YFXTRAN_ACDC_STACK, (JBLK-1)+1, KGPBLKS)
    YLSTACK%L4 = fxtran_acdc_stack_l4 (YFXTRAN_ACDC_STACK, (JBLK-1)+1, KGPBLKS)
    YLSTACK%U4 = fxtran_acdc_stack_u4 (YFXTRAN_ACDC_STACK, (JBLK-1)+1, KGPBLKS)

    

    

    IF (LLDDRAF (JL, JBLK).AND.IDTOP (JL, JBLK)<=KCTOP (JL, JBLK)) THEN
      IDTOP (JL, JBLK)=KCTOP (JL, JBLK)+1
    ENDIF


    

    DO JK=2, KLEV

      

      IF (LLDDRAF (JL, JBLK)) THEN

        IF (JK<IDTOP (JL, JBLK)) THEN
          PMFD (JL, JK, JBLK)=0.0_JPRB
          ZMFDS (JL, JK, JBLK)=0.0_JPRB
          ZMFDQ (JL, JK, JBLK)=0.0_JPRB
          PMFDDE_RATE (JL, JK, JBLK)=0.0_JPRB
          ZDMFDP (JL, JK, JBLK)=0.0_JPRB
        ELSEIF (JK==IDTOP (JL, JBLK)) THEN
          PMFDDE_RATE (JL, JK, JBLK)=0.0_JPRB
        ENDIF

      ENDIF

    
    ENDDO

    CALL CUFLXN_OPENACC (YDTHF, YDCST, YDML_PHY_SLIN%YREPHLI, YDML_PHY_EC%YRECUMF, JL, JL, KLON&
    &, KLEV, PTSPHY, PTEN(:, :, JBLK), PQEN(:, :, JBLK), PQSEN(:, :, JBLK), ZTENH(:, :, JBLK), ZQENH&
    &(:, :, JBLK), PAPH(:, :, JBLK), PAP(:, :, JBLK), PGEOH(:, :, JBLK), LDLAND(:, JBLK), LDCUM&
    &(:, JBLK), LDTDKMF, KCBOT(:, JBLK), KCTOP(:, JBLK), IDTOP(:, JBLK), ITOPM2, KTYPE(:, JBLK)&
    &, LLDDRAF(:, JBLK), PMFU(:, :, JBLK), PMFD(:, :, JBLK), ZMFUS(:, :, JBLK), ZMFDS(:, :, JBLK&
    &), ZMFUQ(:, :, JBLK), ZMFDQ(:, :, JBLK), ZMFUL(:, :, JBLK), PLUDE(:, :, JBLK), PLUDELI(:, &
    &:, :, JBLK), PLRAIN(:, :, JBLK), PSNDE(:, :, :, JBLK), ZDMFUP(:, :, JBLK), ZDMFDP(:, :, JBLK&
    &), ZDPMEL(:, :, JBLK), PLGLAC(:, :, JBLK), PMFLXR(:, :, JBLK), PMFLXS(:, :, JBLK), PRAIN(:&
    &, JBLK), PMFUDE_RATE(:, :, JBLK), PMFDDE_RATE(:, :, JBLK), YDSTACK=YLSTACK)
  ENDDO

ENDDO


!$ACC PARALLEL LOOP GANG &
!$ACC&IF (LDACC) &
!$ACC&PRIVATE (JBLK) &
!$ACC&VECTOR_LENGTH (KLON) 


DO JBLK = 1, KGPBLKS
  
  !$ACC LOOP VECTOR &
  !$ACC&PRIVATE (IK, JK, JL, ZDZ, ZERATE, ZFAC, ZMFA) 

  

  DO JL = KIDIA, MERGE (KLON, KFDIA, JBLK < KGPBLKS)

    

    DO JK=2, KLEV-1

      

      IF (LLDDRAF (JL, JBLK).AND.JK>=IDTOP (JL, JBLK)-1) THEN
        ZERATE=-PMFD (JL, JK, JBLK)+PMFD (JL, JK-1, JBLK)+PMFDDE_RATE (JL, JK, JBLK)

        IF (ZERATE<0.0_JPRB) THEN
          PMFDDE_RATE (JL, JK, JBLK)=PMFDDE_RATE (JL, JK, JBLK)-ZERATE
        ENDIF

      ENDIF


      IF (LDCUM (JL, JBLK).AND.JK>=KCTOP (JL, JBLK)-1) THEN
        ZERATE=PMFU (JL, JK, JBLK)-PMFU (JL, JK+1, JBLK)+PMFUDE_RATE (JL, JK, JBLK)

        IF (ZERATE<0.0_JPRB) THEN
          PMFUDE_RATE (JL, JK, JBLK)=PMFUDE_RATE (JL, JK, JBLK)-ZERATE
        ENDIF

        ZDMFUP (JL, JK, JBLK)=PMFLXR (JL, JK+1, JBLK)+PMFLXS (JL, JK&
        &+1, JBLK)-PMFLXR (JL, JK, JBLK)-PMFLXS (JL, JK, JBLK)
        ZDMFDP (JL, JK, JBLK)=0.0_JPRB
      ENDIF

    
    ENDDO


    

    IF (LLDDRAF (JL, JBLK)) THEN
      JK=IDTOP (JL, JBLK)
      IK=MIN (JK+1, KLEV)

      IF (ZMFDQ (JL, JK, JBLK)<0.3_JPRB*ZMFDQ (JL, IK, JBLK)) THEN

        IF (YDML_PHY_EC%YRECUMF%RMFSOLTQ==0.0_JPRB) THEN
          ZMFDQ (JL, JK, JBLK)=0.3_JPRB*ZMFDQ (JL, IK, JBLK)
        ELSE
          PMFD (JL, JK, JBLK)=0.3_JPRB*PMFD (JL, IK, JBLK)
        ENDIF

      ENDIF

    ENDIF


    

    DO JK=2, KLEV

      

      IF (LDCUM (JL, JBLK).AND.JK>=KCTOP (JL, JBLK)-1.AND.JK<KCBOT (JL, JBLK)) THEN
        ZDZ=PTSPHY*YDCST%RG/(PAPH (JL, JK+1, JBLK)-PAPH (JL, JK, JBLK))
        ZMFA=ZMFUQ (JL, JK+1, JBLK)+ZMFDQ (JL, JK+1, JBLK)-ZMFUQ (JL, JK, JBLK&
        &)-ZMFDQ (JL, JK, JBLK)+ZMFUL (JL, JK+1, JBLK)-ZMFUL (JL, JK, JBLK)+ZDMFUP&
        & (JL, JK, JBLK)-PSNDE (JL, JK, 1, JBLK)-PSNDE (JL, JK, 2, JBLK)
        ZMFA=(ZMFA-PLUDE (JL, JK, JBLK))*ZDZ

        IF (PQEN (JL, JK, JBLK)+ZMFA<0.0_JPRB.AND.PLUDE (JL, JK, JBLK)>0.0_JPRB) THEN
          ZFAC=MIN (-(PQEN (JL, JK, JBLK)+ZMFA)/ZDZ, PLUDE (JL, JK, JBLK))
          PLUDE (JL, JK, JBLK)=PLUDE (JL, JK, JBLK)+ZFAC
          PLUDELI (JL, JK, 1, JBLK)=PLUDELI (JL, JK, 1, JBLK)+ZFAC&
          &*PLUDELI (JL, JK, 1, JBLK)/PLUDE (JL, JK, JBLK)
          PLUDELI (JL, JK, 2, JBLK)=PLUDELI (JL, JK, 2, JBLK)+ZFAC&
          &*PLUDELI (JL, JK, 2, JBLK)/PLUDE (JL, JK, JBLK)
        ENDIF


        IF (PLUDE (JL, JK, JBLK)<0.0_JPRB) THEN
          PLUDE (JL, JK, JBLK)=0.0_JPRB
          PLUDELI (JL, JK, 1, JBLK)=0.0_JPRB
          PLUDELI (JL, JK, 2, JBLK)=0.0_JPRB
        ENDIF

      ENDIF


      IF (.NOT.LDCUM (JL, JBLK)) THEN
        PMFUDE_RATE (JL, JK, JBLK)=0.0_JPRB
      ENDIF


      IF (PMFD (JL, JK-1, JBLK)==0.0_JPRB) THEN
        PMFDDE_RATE (JL, JK, JBLK)=0.0_JPRB
      ENDIF

    
    ENDDO

  ENDDO

ENDDO


!$ACC PARALLEL LOOP GANG &
!$ACC&IF (LDACC) &
!$ACC&PRIVATE (JBLK) &
!$ACC&VECTOR_LENGTH (KLON) 


DO JBLK = 1, KGPBLKS
  
  !$ACC LOOP VECTOR &
  !$ACC&PRIVATE (JK, JL, YLSTACK, ZMFA) 

  

  DO JL = KIDIA, MERGE (KLON, KFDIA, JBLK < KGPBLKS)
    YLSTACK%L8 = fxtran_acdc_stack_l8 (YFXTRAN_ACDC_STACK, (JBLK-1)+1, KGPBLKS)
    YLSTACK%U8 = fxtran_acdc_stack_u8 (YFXTRAN_ACDC_STACK, (JBLK-1)+1, KGPBLKS)
    YLSTACK%L4 = fxtran_acdc_stack_l4 (YFXTRAN_ACDC_STACK, (JBLK-1)+1, KGPBLKS)
    YLSTACK%U4 = fxtran_acdc_stack_u4 (YFXTRAN_ACDC_STACK, (JBLK-1)+1, KGPBLKS)

    

    IF (YDML_PHY_EC%YRECUMF%RMFSOLTQ>0.0_JPRB) THEN

      DO JK=KLEV, 2,-1

        

        IF (LDCUM (JL, JBLK)) THEN

          IF (JK>KCBOT (JL, JBLK)) THEN
            ZMFA=1.0_JPRB/MAX (1.E-15_JPRB, PMFU (JL, JK, JBLK))
            PQU (JL, JK, JBLK)=ZQENH (JL, JK, JBLK)+ZMFUQ (JL, JK, JBLK)*ZMFA
            PTU (JL, JK, JBLK)=ZTENH (JL, JK, JBLK)+ZMFUS (JL, JK, JBLK)*ZMFA*ZORCPD
            ZMFUS (JL, JK, JBLK)=PMFU (JL, JK, JBLK)*(YDCST%RCPD*PTU (JL, JK, JBLK)+PGEOH (JL, JK, JBLK))
            ZMFUQ (JL, JK, JBLK)=PMFU (JL, JK, JBLK)*PQU (JL, JK, JBLK)

            IF (LLDDRAF (JL, JBLK)) THEN
              ZMFA=1.0_JPRB/MIN (-1.E-15_JPRB, PMFD (JL, JK, JBLK))
              ZQD (JL, JK, JBLK)=ZQENH (JL, JK, JBLK)+ZMFDQ (JL, JK, JBLK)*ZMFA
              ZTD (JL, JK, JBLK)=ZTENH (JL, JK, JBLK)+ZMFDS (JL, JK, JBLK)*ZMFA*ZORCPD
              ZMFDQ (JL, JK, JBLK)=PMFD (JL, JK, JBLK)*ZQD (JL, JK, JBLK)
              ZMFDS (JL, JK, JBLK)=PMFD (JL, JK, JBLK)*(YDCST%RCPD*ZTD (JL, JK, JBLK)+PGEOH (JL, JK, JBLK))
            ENDIF

          ELSEIF (JK<=KCBOT (JL, JBLK).AND.JK>=KCTOP (JL, JBLK)) THEN
            ZMFUS (JL, JK, JBLK)=PMFU (JL, JK, JBLK)*(YDCST%RCPD*PTU (JL, JK, JBLK)+PGEOH (JL, JK, JBLK))
            ZMFUQ (JL, JK, JBLK)=PMFU (JL, JK, JBLK)*PQU (JL, JK, JBLK)
            ZMFDS (JL, JK, JBLK)=PMFD (JL, JK, JBLK)*(YDCST%RCPD*ZTD (JL, JK, JBLK)+PGEOH (JL, JK, JBLK))
            ZMFDQ (JL, JK, JBLK)=PMFD (JL, JK, JBLK)*ZQD (JL, JK, JBLK)
          ENDIF

        ENDIF

      
      ENDDO

    ENDIF

    CALL CUDTDQN_OPENACC (YDTHF, YDCST, YDML_PHY_SLIN%YREPHLI, YDML_PHY_SLIN%YRPHNC, YDML_PHY_EC%YRECUMF&
    &, YDML_PHY_EC%YREPHY, JL, JL, KLON, KLEV, ITOPM2, KTYPE(:, JBLK), KCTOP(:, JBLK), KCBOT(:, JBLK&
    &), IDTOP(:, JBLK), LDTDKMF, LDCUM(:, JBLK), LLDDRAF(:, JBLK), LLSCVFLAG(:, JBLK), PTSPHY, PAPH&
    &(:, :, JBLK), PAP(:, :, JBLK), PGEOH(:, :, JBLK), PGEO(:, :, JBLK), PTEN(:, :, JBLK), ZTENH(&
    &:, :, JBLK), PQEN(:, :, JBLK), ZQENH(:, :, JBLK), PQSEN(:, :, JBLK), PLGLAC(:, :, JBLK), PLUDE&
    &(:, :, JBLK), PLUDELI(:, :, :, JBLK), PSNDE(:, :, :, JBLK), PMFU(:, :, JBLK), PMFD(:, :, JBLK&
    &), ZMFUS(:, :, JBLK), ZMFDS(:, :, JBLK), ZMFUQ(:, :, JBLK), ZMFDQ(:, :, JBLK), ZMFUL(:, :, JBLK&
    &), ZDMFUP(:, :, JBLK), ZDPMEL(:, :, JBLK), PMFLXR(:, :, JBLK), PMFLXS(:, :, JBLK), PTENT(:, &
    &:, JBLK), PTENQ(:, :, JBLK), PENTH(:, :, JBLK), YDSTACK=YLSTACK)
  ENDDO

ENDDO


!$ACC PARALLEL LOOP GANG &
!$ACC&IF (LDACC) &
!$ACC&PRIVATE (JBLK) &
!$ACC&VECTOR_LENGTH (KLON) 


DO JBLK = 1, KGPBLKS
  
  !$ACC LOOP VECTOR &
  !$ACC&PRIVATE (IK, IKB, JK, JL, YLSTACK, ZDERATE, ZDUTEN, ZDVTEN, ZDZ, ZERATE, ZFAC, ZMFA, &
  !$ACC&         ZMFMAX, ZTDIS) 

  

  DO JL = KIDIA, MERGE (KLON, KFDIA, JBLK < KGPBLKS)
    YLSTACK%L8 = fxtran_acdc_stack_l8 (YFXTRAN_ACDC_STACK, (JBLK-1)+1, KGPBLKS)
    YLSTACK%U8 = fxtran_acdc_stack_u8 (YFXTRAN_ACDC_STACK, (JBLK-1)+1, KGPBLKS)
    YLSTACK%L4 = fxtran_acdc_stack_l4 (YFXTRAN_ACDC_STACK, (JBLK-1)+1, KGPBLKS)
    YLSTACK%U4 = fxtran_acdc_stack_u4 (YFXTRAN_ACDC_STACK, (JBLK-1)+1, KGPBLKS)

    

    IF (YDML_PHY_EC%YRECUMF%LMFDUDV) THEN

      DO JK=KLEV-1, 2,-1
        IK=JK+1

        

        IF (LDCUM (JL, JBLK)) THEN

          IF (JK==KCBOT (JL, JBLK).AND.KTYPE (JL, JBLK)<3) THEN
            IKB=IDPL (JL, JBLK)
            ZUU (JL, JK, JBLK)=PUEN (JL, IKB-1, JBLK)
            ZVU (JL, JK, JBLK)=PVEN (JL, IKB-1, JBLK)
          ELSEIF (JK==KCBOT (JL, JBLK).AND.KTYPE (JL, JBLK)==3) THEN
            ZUU (JL, JK, JBLK)=PUEN (JL, JK-1, JBLK)
            ZVU (JL, JK, JBLK)=PVEN (JL, JK-1, JBLK)
          ENDIF


          IF (JK<KCBOT (JL, JBLK).AND.JK>=KCTOP (JL, JBLK)) THEN
            ZFAC=0.0_JPRB

            IF (LDTDKMF.AND.(KTYPE (JL, JBLK)==1.OR.KTYPE (JL, JBLK)==3))  THEN
              ZFAC=2.0_JPRB
            ENDIF

            ZERATE=PMFU (JL, JK, JBLK)-PMFU (JL, IK, JBLK)+(1.0_JPRB+ZFAC)*PMFUDE_RATE (JL, JK, JBLK)
            ZDERATE=(1.0_JPRB+ZFAC)*PMFUDE_RATE (JL, JK, JBLK)
            ZMFA=1.0_JPRB/MAX (YDML_PHY_EC%YRECUMF%RMFCMIN, PMFU (JL, JK, JBLK))
            ZUU (JL, JK, JBLK)=(ZUU (JL, IK, JBLK)*PMFU (JL, IK, JBLK)+ZERATE&
            &*PUEN (JL, JK, JBLK)-ZDERATE*ZUU (JL, IK, JBLK))*ZMFA
            ZVU (JL, JK, JBLK)=(ZVU (JL, IK, JBLK)*PMFU (JL, IK, JBLK)+ZERATE&
            &*PVEN (JL, JK, JBLK)-ZDERATE*ZVU (JL, IK, JBLK))*ZMFA
          ENDIF

        ENDIF

      
      ENDDO


      DO JK=3, KLEV
        IK=JK-1

        

        IF (LDCUM (JL, JBLK)) THEN

          IF (JK==IDTOP (JL, JBLK)) THEN
            ZUD (JL, JK, JBLK)=0.5_JPRB*(ZUU (JL, JK, JBLK)+PUEN (JL, IK, JBLK))
            ZVD (JL, JK, JBLK)=0.5_JPRB*(ZVU (JL, JK, JBLK)+PVEN (JL, IK, JBLK))
          ELSEIF (JK>IDTOP (JL, JBLK)) THEN
            ZERATE=-PMFD (JL, JK, JBLK)+PMFD (JL, IK, JBLK)+PMFDDE_RATE (JL, JK, JBLK)
            ZMFA=1.0_JPRB/MIN (-YDML_PHY_EC%YRECUMF%RMFCMIN, PMFD (JL, JK, JBLK))
            ZUD (JL, JK, JBLK)=(ZUD (JL, IK, JBLK)*PMFD (JL, IK, JBLK)-ZERATE*PUEN&
            & (JL, IK, JBLK)+PMFDDE_RATE (JL, JK, JBLK)*ZUD (JL, IK, JBLK))*ZMFA
            ZVD (JL, JK, JBLK)=(ZVD (JL, IK, JBLK)*PMFD (JL, IK, JBLK)-ZERATE*PVEN&
            & (JL, IK, JBLK)+PMFDDE_RATE (JL, JK, JBLK)*ZVD (JL, IK, JBLK))*ZMFA
          ENDIF

        ENDIF

      
      ENDDO

      ZMFS (JL, JBLK)=1.0_JPRB

      IF (YDML_PHY_EC%YRECUMF%RMFSOLUV<=1.0_JPRB) THEN

        DO JK=2, KLEV

          

          IF (LDCUM (JL, JBLK).AND.JK>=KCTOP (JL, JBLK)-1) THEN
            ZMFMAX=(PAPH (JL, JK, JBLK)-PAPH (JL, JK-1, JBLK))*ZCONS

            IF (PMFU (JL, JK, JBLK)>ZMFMAX.AND.JK>=KCTOP (JL, JBLK))  THEN
              ZMFS (JL, JBLK)=MIN (ZMFS (JL, JBLK), ZMFMAX/PMFU (JL, JK, JBLK))
            ENDIF

          ENDIF

        
        ENDDO

      ENDIF


      DO JK=1, KLEV
        
        ZMFUUS (JL, JK, JBLK)=PMFU (JL, JK, JBLK)
        ZMFDUS (JL, JK, JBLK)=PMFD (JL, JK, JBLK)

        IF (LDCUM (JL, JBLK).AND.JK>=KCTOP (JL, JBLK)-1) THEN
          ZMFUUS (JL, JK, JBLK)=PMFU (JL, JK, JBLK)*ZMFS (JL, JBLK)
          ZMFDUS (JL, JK, JBLK)=PMFD (JL, JK, JBLK)*ZMFS (JL, JBLK)
        ENDIF

      
      ENDDO


      IF (YDML_PHY_EC%YRECUMF%RMFSOLUV>0.0_JPRB) THEN

        

        IF (LDCUM (JL, JBLK)) THEN
          JK=KCBOT (JL, JBLK)
          IK=JK-1
          ZMFUUB (JL, JBLK)=ZMFUUS (JL, JK, JBLK)*(ZUU (JL, JK, JBLK)-PUEN (JL, IK, JBLK))
          ZMFUVB (JL, JBLK)=ZMFUUS (JL, JK, JBLK)*(ZVU (JL, JK, JBLK)-PVEN (JL, IK, JBLK))
        ENDIF


        

        DO JK=2, KLEV
          IK=JK-1

          

          IF (LDCUM (JL, JBLK).AND.JK>KCBOT (JL, JBLK)) THEN
            IKB=KCBOT (JL, JBLK)
            ZDZ=((PAPH (JL, KLEV+1, JBLK)-PAPH (JL, JK, JBLK))/(PAPH (JL, KLEV+1, JBLK)-PAPH (JL, IKB, JBLK)))

            IF (KTYPE (JL, JBLK)==3) THEN
              ZDZ=ZDZ*ZDZ
            ENDIF

            ZMFA=1.0_JPRB/MAX (YDML_PHY_EC%YRECUMF%RMFCMIN, ZMFUUS (JL, JK, JBLK))
            ZUU (JL, JK, JBLK)=PUEN (JL, IK, JBLK)+ZMFUUB (JL, JBLK)*ZDZ*ZMFA
            ZVU (JL, JK, JBLK)=PVEN (JL, IK, JBLK)+ZMFUVB (JL, JBLK)*ZDZ*ZMFA
            ZMFDUS (JL, JK, JBLK)=ZMFDUS (JL, IKB, JBLK)*ZDZ
            ZUD (JL, JK, JBLK)=PUEN (JL, IK, JBLK)+ZUD (JL, IKB, JBLK)-PUEN (JL, IKB-1, JBLK)
            ZVD (JL, JK, JBLK)=PVEN (JL, IK, JBLK)+ZVD (JL, IKB, JBLK)-PVEN (JL, IKB-1, JBLK)
          ENDIF


          IF (LDCUM (JL, JBLK).AND.JK>=KCTOP (JL, JBLK)) THEN

            IF (LDTDKMF) THEN
              ZUU (JL, JK, JBLK)=ZUU (JL, JK, JBLK)-YDML_PHY_EC%YRECUMF%RUVPER*SIGN (1.0_JPRB, ZUU (JL, JK, JBLK))
              ZVU (JL, JK, JBLK)=ZVU (JL, JK, JBLK)-YDML_PHY_EC%YRECUMF%RUVPER*SIGN (1.0_JPRB, ZVU (JL, JK, JBLK))
            ELSE
              ZUU (JL, JK, JBLK)=ZUU (JL, JK, JBLK)-MIN (ABS (ZUU (JL, JK, JBLK)),&
              & YDML_PHY_EC%YRECUMF%RUVPER)*SIGN (1.0_JPRB, ZUU (JL, JK, JBLK))
              ZVU (JL, JK, JBLK)=ZVU (JL, JK, JBLK)-MIN (ABS (ZVU (JL, JK, JBLK)),&
              & YDML_PHY_EC%YRECUMF%RUVPER)*SIGN (1.0_JPRB, ZVU (JL, JK, JBLK))
            ENDIF

          ENDIF

        
        ENDDO

      ENDIF

      CALL CUDUDV_OPENACC (YDCST, YDML_PHY_EC%YRECUMF, YDSPP_CONFIG, YDPERTPAR, JL, JL, KLON, KLEV, ITOPM2&
      &, KTYPE(:, JBLK), KCBOT(:, JBLK), KCTOP(:, JBLK), LDCUM(:, JBLK), PTSPHY, PAPH(:, :, JBLK), PAP&
      &(:, :, JBLK), PUEN(:, :, JBLK), PVEN(:, :, JBLK), ZMFUUS(:, :, JBLK), ZMFDUS(:, :, JBLK), PMFU&
      &(:, :, JBLK), PMFD(:, :, JBLK), ZUU(:, :, JBLK), ZUD(:, :, JBLK), ZVU(:, :, JBLK), ZVD(:, :, JBLK&
      &), PGP2DSPP(:, :, JBLK), PTENU(:, :, JBLK), PTENV(:, :, JBLK), YDSTACK=YLSTACK)

      IF (YDML_PHY_EC%YRECUMF%LMFUVDIS) THEN
        
        ZSUM12 (JL, JBLK)=0.0_JPRB
        ZSUM22 (JL, JBLK)=0.0_JPRB

        

        DO JK=1, KLEV
          
          ZUV2 (JL, JK, JBLK)=0.0_JPRB

          IF (LDCUM (JL, JBLK).AND.JK>=KCTOP (JL, JBLK)-1) THEN
            ZDZ=(PAPH (JL, JK+1, JBLK)-PAPH (JL, JK, JBLK))
            ZDUTEN=PTENU (JL, JK, JBLK)-ZTENU (JL, JK, JBLK)
            ZDVTEN=PTENV (JL, JK, JBLK)-ZTENV (JL, JK, JBLK)
            ZUV2 (JL, JK, JBLK)=SQRT (ZDUTEN**2+ZDVTEN**2)
            ZSUM22 (JL, JBLK)=ZSUM22 (JL, JBLK)+ZUV2 (JL, JK, JBLK)*ZDZ
            ZSUM12 (JL, JBLK)=ZSUM12 (JL, JBLK)-(PUEN (JL, JK, JBLK)*ZDUTEN+PVEN (JL, JK, JBLK)*ZDVTEN)*ZDZ
          ENDIF

        
        ENDDO

        
        PVDISCU (JL, JBLK)=ZSUM12 (JL, JBLK)*ZRG

        

        DO JK=1, KLEV

          

          IF (LDCUM (JL, JBLK).AND.JK>=KCTOP (JL, JBLK)-1) THEN
            ZTDIS=ZORCPD*ZSUM12 (JL, JBLK)*ZUV2 (JL, JK, JBLK)/MAX (1.E-15_JPRB, ZSUM22 (JL, JBLK))
            PTENT (JL, JK, JBLK)=PTENT (JL, JK, JBLK)+ZTDIS
          ENDIF

        
        ENDDO

      ENDIF

    ENDIF

  ENDDO

ENDDO


!$ACC PARALLEL LOOP GANG &
!$ACC&IF (LDACC) &
!$ACC&PRIVATE (JBLK) &
!$ACC&VECTOR_LENGTH (KLON) 


DO JBLK = 1, KGPBLKS
  
  !$ACC LOOP VECTOR &
  !$ACC&PRIVATE (JK, JL) 

  

  DO JL = KIDIA, MERGE (KLON, KFDIA, JBLK < KGPBLKS)

    

    IF (.NOT.YDML_PHY_EC%YRECUMF%LMFSCV.OR..NOT.YDML_PHY_EC%YRECUMF%LMFPEN) THEN

      DO JK=2, KLEV

        

        IF (LLO2 (JL, JBLK).AND.JK>=KCTOP (JL, JBLK)-1) THEN
          PMFUDE_RATE (JL, JK, JBLK)=0.0_JPRB
          PMFDDE_RATE (JL, JK, JBLK)=0.0_JPRB
        ENDIF

      
      ENDDO


      

      IF (LLO2 (JL, JBLK)) THEN
        KCTOP (JL, JBLK)=KLEV-1
        KCBOT (JL, JBLK)=KLEV-1
      ENDIF

    
    ENDIF

  ENDDO

ENDDO


IF (YDML_PHY_EC%YREPHY%LMFTRAC.AND.KTRAC>0) THEN
  
  !$ACC PARALLEL LOOP GANG &
  !$ACC&IF (LDACC) &
  !$ACC&PRIVATE (JBLK) &
  !$ACC&VECTOR_LENGTH (KLON) 

  

  DO JBLK = 1, KGPBLKS
    
    !$ACC LOOP VECTOR &
    !$ACC&PRIVATE (IKB, JK, JL, YLSTACK, ZERATE, ZMFMAX) 

    

    DO JL = KIDIA, MERGE (KLON, KFDIA, JBLK < KGPBLKS)
      YLSTACK%L8 = fxtran_acdc_stack_l8 (YFXTRAN_ACDC_STACK, (JBLK-1)+1, KGPBLKS)
      YLSTACK%U8 = fxtran_acdc_stack_u8 (YFXTRAN_ACDC_STACK, (JBLK-1)+1, KGPBLKS)
      YLSTACK%L4 = fxtran_acdc_stack_l4 (YFXTRAN_ACDC_STACK, (JBLK-1)+1, KGPBLKS)
      YLSTACK%U4 = fxtran_acdc_stack_u4 (YFXTRAN_ACDC_STACK, (JBLK-1)+1, KGPBLKS)

      

      

      IF (LDCUM (JL, JBLK).AND.KTYPE (JL, JBLK)/=3.AND.KCBOT (JL, JBLK)-KCTOP (JL, JBLK)>=1) THEN
        LLDCUM (JL, JBLK)=.TRUE.
        LLDDRAF3 (JL, JBLK)=LLDDRAF (JL, JBLK)
      ELSE
        LLDCUM (JL, JBLK)=.FALSE.
        LLDDRAF3 (JL, JBLK)=.FALSE.
      ENDIF

      
      ZMFS (JL, JBLK)=1.0_JPRB

      IF (YDML_PHY_EC%YRECUMF%RMFSOLCT<=3.0_JPRB) THEN

        DO JK=2, KLEV

          

          IF (LLDCUM (JL, JBLK).AND.JK>=KCTOP (JL, JBLK)) THEN
            ZMFMAX=(PAPH (JL, JK, JBLK)-PAPH (JL, JK-1, JBLK))*0.8_JPRB*ZCONS

            IF (PMFU (JL, JK, JBLK)>ZMFMAX)  THEN
              ZMFS (JL, JBLK)=MIN (ZMFS (JL, JBLK), ZMFMAX/PMFU (JL, JK, JBLK))
            ENDIF

          ENDIF

        
        ENDDO

      ENDIF


      DO JK=1, KLEV

        

        IF (LLDCUM (JL, JBLK).AND.JK>=KCTOP (JL, JBLK)-1) THEN
          ZMFUUS (JL, JK, JBLK)=PMFU (JL, JK, JBLK)*ZMFS (JL, JBLK)
          ZMFUDR (JL, JK, JBLK)=PMFUDE_RATE (JL, JK, JBLK)*ZMFS (JL, JBLK)
          ZDMFUPC (JL, JK, JBLK)=(PMFLXR (JL, JK, JBLK)+PMFLXS (JL, JK, JBLK))*ZMFS (JL, JBLK)
          IKB=KCBOT (JL, JBLK)

          IF (JK>IKB) THEN
            ZDMFUPC (JL, JK, JBLK)=ZDMFUPC (JL, IKB, JBLK)
          ENDIF

        ELSE
          ZMFUUS (JL, JK, JBLK)=0._JPRB
          ZMFUDR (JL, JK, JBLK)=0._JPRB
        ENDIF


        IF (LLDDRAF3 (JL, JBLK).AND.JK>=IDTOP (JL, JBLK)-1) THEN
          ZMFDUS (JL, JK, JBLK)=PMFD (JL, JK, JBLK)*ZMFS (JL, JBLK)
          ZMFDDR (JL, JK, JBLK)=PMFDDE_RATE (JL, JK, JBLK)*ZMFS (JL, JBLK)
          ZDMFDPC (JL, JK, JBLK)=0.0_JPRB
        ELSE
          ZMFDUS (JL, JK, JBLK)=0._JPRB
          ZMFDDR (JL, JK, JBLK)=0._JPRB
        ENDIF

      
      ENDDO


      IF (YDML_PHY_EC%YRECUMF%LMFSMOOTH) THEN

        DO JK=2, KLEV-1

          

          IF (LLDDRAF3 (JL, JBLK).AND.ZMFDUS (JL, JK, JBLK)<0.0_JPRB&
            &.AND.ZMFDUS (JL, JK+1, JBLK)==0.0_JPRB) THEN
            ZERATE=MIN (0._JPRB, ZMFDUS (JL, JK, JBLK)-0.5*ZMFDUS (JL, JK-1, JBLK))
            ZMFDUS (JL, JK, JBLK)=ZMFDUS (JL, JK, JBLK)-ZERATE
            ZMFDDR (JL, JK, JBLK)=ZMFDDR (JL, JK, JBLK)-ZERATE
            ZMFDDR (JL, JK+1, JBLK)=-ZMFDUS (JL, JK, JBLK)
          ENDIF


          IF (LLDCUM (JL, JBLK).AND.JK==KCTOP (JL, JBLK)) THEN
            ZERATE=MAX (0.0_JPRB, ZMFUUS (JL, JK, JBLK)-0.5_JPRB*ZMFUUS (JL, JK+1, JBLK))
            ZMFUUS (JL, JK, JBLK)=ZMFUUS (JL, JK, JBLK)-ZERATE
            ZMFUDR (JL, JK, JBLK)=ZMFUDR (JL, JK, JBLK)+ZERATE
            ZMFUDR (JL, JK-1, JBLK)=ZMFUUS (JL, JK, JBLK)
          ENDIF

        
        ENDDO


        DO JK=KLEV-1, 2,-1

          

          IF (LLDCUM (JL, JBLK)) THEN

            IF (ZMFUDR (JL, JK, JBLK)==0.0_JPRB.AND.ZMFUDR (JL, JK-1, JBLK)>0.0_JPRB) THEN
              ZMFUDR (JL, JK, JBLK)=0.5_JPRB*ZMFUDR (JL, JK-1, JBLK)
            ENDIF

          ENDIF

        
        ENDDO

      ENDIF


      IF (YDML_PHY_EC%YREPHY%LMFSCAV) THEN
        CALL CUCTRACER_OPENACC (YDCST, YDML_PHY_SLIN%YRCUMFS, YDML_PHY_SLIN%YRECUMF2, YDML_PHY_EC%YRECUMF&
        &, JL, JL, KLON, KLEV, KTRAC, KCTOP(:, JBLK), IDTOP(:, JBLK), KTYPE(:, JBLK), LLDCUM(:, JBLK), LLDDRAF3&
        &(:, JBLK), PTSPHY, PAPH(:, :, JBLK), PAP(:, :, JBLK), ZMFUUS(:, :, JBLK), ZMFDUS(:, :, JBLK), PMFU&
        &(:, :, JBLK), PMFD(:, :, JBLK), ZMFUDR(:, :, JBLK), ZMFDDR(:, :, JBLK), ZDMFUPC(:, :, JBLK), ZDMFDPC&
        &(:, :, JBLK), PCEN(:, :, :, JBLK), PTENC(:, :, :, JBLK), PSCAV, YDSTACK=YLSTACK)
      ELSE
        ZDMFUPC (JL,:, JBLK)=0.0_JPRB
        CALL CUCTRACER_OPENACC (YDCST, YDML_PHY_SLIN%YRCUMFS, YDML_PHY_SLIN%YRECUMF2, YDML_PHY_EC%YRECUMF&
        &, JL, JL, KLON, KLEV, KTRAC, KCTOP(:, JBLK), IDTOP(:, JBLK), KTYPE(:, JBLK), LLDCUM(:, JBLK), LLDDRAF3&
        &(:, JBLK), PTSPHY, PAPH(:, :, JBLK), PAP(:, :, JBLK), ZMFUUS(:, :, JBLK), ZMFDUS(:, :, JBLK), PMFU&
        &(:, :, JBLK), PMFD(:, :, JBLK), ZMFUDR(:, :, JBLK), ZMFDDR(:, :, JBLK), ZDMFUPC(:, :, JBLK), ZDMFDPC&
        &(:, :, JBLK), PCEN(:, :, :, JBLK), PTENC(:, :, :, JBLK), PSCAV0, YDSTACK=YLSTACK)
      ENDIF

    ENDDO

  ENDDO

ENDIF


!$ACC PARALLEL LOOP GANG &
!$ACC&IF (LDACC) &
!$ACC&PRIVATE (JBLK) &
!$ACC&VECTOR_LENGTH (KLON) 


DO JBLK = 1, KGPBLKS
  
  !$ACC LOOP VECTOR &
  !$ACC&PRIVATE (IK, IKD, JK, JL, ZAK, ZAR, ZAS, ZBR, ZBS, ZDUTEN, ZDVTEN, ZRO) 

  

  DO JL = KIDIA, MERGE (KLON, KFDIA, JBLK < KGPBLKS)
    
    PDISS (JL, 1, JBLK)=0.0_JPRB
    ZAR=1.0_JPRB/20.89_JPRB
    ZAS=1.0_JPRB/29.51_JPRB
    ZBR=1.0_JPRB/1.15_JPRB
    ZBS=1.0_JPRB/1.10_JPRB
    ZAK=1.0_JPRB/5.09E-3_JPRB

    DO JK=1, KLEV
      IK=MIN (JK+1, KLEV)
      IKD=MAX (JK-1, 1)
      
      PDISS (JL, JK, JBLK)=0.0_JPRB
      PRSUD (JL, JK, 1, JBLK)=0.0_JPRB
      PRSUD (JL, JK, 2, JBLK)=0.0_JPRB

      IF (LDCUM (JL, JBLK).AND.JK>=KCTOP (JL, JBLK)-1) THEN
        PLUDELI (JL, JK, 3, JBLK)=PMFUDE_RATE (JL, JK, JBLK)*(PQU (JL, IK, JBLK)-ZQENH (JL, IK&
        &, JBLK))+PMFDDE_RATE (JL, JK, JBLK)*(ZQD (JL, IKD, JBLK)-ZQENH (JL, IKD, JBLK))
        PLUDELI (JL, JK, 4, JBLK)=PMFUDE_RATE (JL, JK, JBLK)*(PTU (JL, IK, JBLK)-ZTENH (JL, IK&
        &, JBLK))+PMFDDE_RATE (JL, JK, JBLK)*(ZTD (JL, IKD, JBLK)-ZTENH (JL, IKD, JBLK))
        ZRO=YDCST%RG/(PGEOH (JL, JK, JBLK)-PGEOH (JL, JK+1, JBLK))
        PMFUDE_RATE (JL, JK, JBLK)=PMFUDE_RATE (JL, JK, JBLK)*ZRO
        PMFDDE_RATE (JL, JK, JBLK)=PMFDDE_RATE (JL, JK, JBLK)*ZRO
        ZRO=YDCST%RD*PTEN (JL, JK, JBLK)*(1.0_JPRB+YDCST%RETV*PQEN (JL, JK, JBLK))/PAP (JL, JK, JBLK)
        ZDUTEN=PTENU (JL, JK, JBLK)-ZTENU (JL, JK, JBLK)
        ZDVTEN=PTENV (JL, JK, JBLK)-ZTENV (JL, JK, JBLK)
        PDISS (JL, JK, JBLK)=ABS (PUEN (JL, JK, JBLK)*ZDUTEN+PVEN (JL, JK, JBLK)*ZDVTEN)**0.3333
        PRSUD (JL, JK, 1, JBLK)=1.E-3_JPRB*ZRO*(PMFLXR (JL, JK, JBLK)*3600._JPRB*ZAR)**ZBR
        PRSUD (JL, JK, 2, JBLK)=0.5*1.E-3_JPRB*ZRO*(10.0_JPRB*PMFLXS (JL, JK, JBLK)*3600._JPRB*ZAS)**ZBS
      ELSE
        PMFU (JL, JK, JBLK)=0.0_JPRB
        PMFD (JL, JK, JBLK)=0.0_JPRB
        PLUDE (JL, JK, JBLK)=0.0_JPRB
        PLUDELI (JL, JK, 1, JBLK)=0.0_JPRB
        PLUDELI (JL, JK, 2, JBLK)=0.0_JPRB
        PLUDELI (JL, JK, 3, JBLK)=0.0_JPRB
        PLUDELI (JL, JK, 4, JBLK)=0.0_JPRB
        PSNDE (JL, JK, 1, JBLK)=0.0_JPRB
        PSNDE (JL, JK, 2, JBLK)=0.0_JPRB
        PTU (JL, JK, JBLK)=PTEN (JL, JK, JBLK)
        PQU (JL, JK, JBLK)=PQEN (JL, JK, JBLK)
        PLU (JL, JK, JBLK)=0.0_JPRB
        PENTH (JL, JK, JBLK)=0.0_JPRB
        PMFUDE_RATE (JL, JK, JBLK)=0.0_JPRB
        PMFDDE_RATE (JL, JK, JBLK)=0.0_JPRB
      ENDIF

    
    ENDDO

  ENDDO

ENDDO


#ifdef __PGI
CALL NVTXENDRANGE ()
#endif
!$ACC END DATA

ENDSUBROUTINE CUMASTRN_MANYBLOCKS
