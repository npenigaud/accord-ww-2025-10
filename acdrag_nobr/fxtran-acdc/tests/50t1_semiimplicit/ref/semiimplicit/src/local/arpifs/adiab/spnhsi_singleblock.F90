SUBROUTINE SPNHSI_SINGLEBLOCK (YDCST, YDGEOMETRY, YDLDDH, YDRIP, YDDYN, YDDYNA, KM, KMLOC, KSTA&
&, KEND, KSPEC2V, LDONEM, LDOHD, LESIDG, PSPVORG, PSPDIVG, PSPTG, PSPSPG, PSPSPDG, PSPSVDG, PSPTNDSI_VORG&
&, PSPTNDSI_DIVG, PSPTNDSI_TG, PSPTNDSI_SPDG, PSPTNDSI_SVDG, PSPAUXG, LDACC)
USE GEOMETRY_MOD,ONLY:GEOMETRY
USE PARKIND1,ONLY:JPIM, JPRB
USE YOMHOOK,ONLY:LHOOK, DR_HOOK, JPHOOK
USE YOMCST,ONLY:TCST
USE YOMMP0,ONLY:MYSETV, MYSETN
USE YOMDYN,ONLY:TDYN
USE YOMDYNA,ONLY:TDYNA
USE YOMLDDH,ONLY:TLDDH
USE YOMRIP,ONLY:TRIP
USE YOMCT0,ONLY:LELAM
USE FXTRAN_ACDC_STACK_MOD
#include "fxtran_acdc_stack.h"

IMPLICIT NONE


TYPE (TCST), INTENT (IN)::YDCST
TYPE (GEOMETRY), INTENT (IN)::YDGEOMETRY
TYPE (TLDDH), INTENT (IN)::YDLDDH
TYPE (TRIP), INTENT (IN)::YDRIP
TYPE (TDYN), INTENT (IN)::YDDYN
TYPE (TDYNA), INTENT (IN)::YDDYNA
INTEGER (KIND=JPIM), INTENT (IN)::KM
INTEGER (KIND=JPIM), INTENT (IN)::KMLOC
INTEGER (KIND=JPIM), INTENT (IN)::KSTA
INTEGER (KIND=JPIM), INTENT (IN)::KEND
INTEGER (KIND=JPIM), INTENT (IN)::KSPEC2V
LOGICAL, INTENT (IN)::LDONEM
LOGICAL, INTENT (IN)::LDOHD
LOGICAL, INTENT (IN)::LESIDG
REAL (KIND=JPRB), INTENT (INOUT)::PSPVORG (KSPEC2V, YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB), INTENT (INOUT)::PSPDIVG (KSPEC2V, YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB), INTENT (INOUT)::PSPTG (KSPEC2V, YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB), INTENT (INOUT)::PSPSPG (KSPEC2V)
REAL (KIND=JPRB), INTENT (INOUT)::PSPSPDG (KSPEC2V, YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB), INTENT (INOUT)::PSPSVDG (KSPEC2V, YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB), INTENT (INOUT)::PSPTNDSI_VORG (YDGEOMETRY&
&%YRMP%NSPEC2VDDH, YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB), INTENT (INOUT)::PSPTNDSI_DIVG (YDGEOMETRY&
&%YRMP%NSPEC2VDDH, YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB), INTENT (INOUT)::PSPTNDSI_TG (YDGEOMETRY%YRMP%NSPEC2VDDH, YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB), INTENT (INOUT)::PSPTNDSI_SPDG (YDGEOMETRY&
&%YRMP%NSPEC2VDDH, YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB), INTENT (INOUT)::PSPTNDSI_SVDG (YDGEOMETRY&
&%YRMP%NSPEC2VDDH, YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB), INTENT (IN)::PSPAUXG (KSPEC2V, YDGEOMETRY%YRDIMV%NFLEVG)
LOGICAL, INTENT (IN) :: LDACC
REAL (KIND=JPRB)::ZZSPVORG (KSTA:KEND, YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB)::ZZSPDIVG (KSTA:KEND, YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB)::ZZSPTG (KSTA:KEND, YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB)::ZZSPSPG (KSTA:KEND)
REAL (KIND=JPRB)::ZZSPSPDG (KSTA:KEND, YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB)::ZZSPSVDG (KSTA:KEND, YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB)::ZZSPGDIVG (KSTA:KEND, MERGE (YDGEOMETRY%YRDIMV%NFLEVG, 0,&
&(YDDYN%NITERHELM>0.AND..NOT.(YDGEOMETRY%YRVERT_GEOM%YRCVER%NDLNPR==1))))
REAL (KIND=JPRB)::ZZSPDIV0G (KSTA:KEND, MERGE (YDGEOMETRY%YRDIMV%NFLEVG, 0,&
&(YDDYN%NITERHELM>0.AND..NOT.(YDGEOMETRY%YRVERT_GEOM%YRCVER%NDLNPR==1))))
REAL (KIND=JPRB)::ZZSPGDIV0G (KSTA:KEND, MERGE (YDGEOMETRY%YRDIMV%NFLEVG, 0,&
&(YDDYN%NITERHELM>0.AND..NOT.(YDGEOMETRY%YRVERT_GEOM%YRCVER%NDLNPR==1))))
REAL (KIND=JPRB)::ZZSPVOR0G (KSTA:KEND, MERGE (YDGEOMETRY%YRDIMV%NFLEVG, 0,&
&(YDDYN%NITERHELM>0.AND..NOT.(YDGEOMETRY%YRVERT_GEOM%YRCVER%NDLNPR==1))))
REAL (KIND=JPRB)::ZZSPSVD0G (KSTA:KEND, MERGE (YDGEOMETRY%YRDIMV%NFLEVG, 0,&
&(YDDYN%NITERHELM>0.AND..NOT.(YDGEOMETRY%YRVERT_GEOM%YRCVER%NDLNPR==1))))
REAL (KIND=JPRB)::ZSDIV (KSTA:KEND, YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB)::ZST (KSTA:KEND, YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB)::ZSP (KSTA:KEND)
REAL (KIND=JPRB)::ZSDIVP (KSTA:KEND, YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB)::ZSPDIVP (KSTA:KEND, YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB)::ZSVED (KSTA:KEND, YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB)::ZR1D (KSTA:KEND, YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB)::ZR1D2 (KSTA:KEND, YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB)::ZR1DPRIM (KSTA:KEND, YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB)::ZR2D (KSTA:KEND, YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB)::ZR3D (KSTA:KEND, YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB)::ZR4D (KSTA:KEND, YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB)::ZSRHS (KSTA:KEND, YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB)::ZWORK (KSTA:KEND, YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB)::ZSRHS2 (KSTA:KEND, YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB)::ZSRHS2_INC (KSTA:KEND, YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB)::ZSNHP (KSTA:KEND, YDGEOMETRY%YRDIMV%NFLEVG)
INTEGER (KIND=JPIM)::IMLOCEND
INTEGER (KIND=JPIM)::IMLOCSTA
INTEGER (KIND=JPIM)::IOFF
INTEGER (KIND=JPIM)::JN
INTEGER (KIND=JPIM)::JSP
INTEGER (KIND=JPIM)::JLEV
INTEGER (KIND=JPIM)::ISPCOL
INTEGER (KIND=JPIM)::IMSP
INTEGER (KIND=JPIM)::IRSP
INTEGER (KIND=JPIM)::JL
INTEGER (KIND=JPIM)::ILO
INTEGER (KIND=JPIM)::JITER
INTEGER (KIND=JPIM)::I_NITERHELM
REAL (KIND=JPRB)::ZBTCMH
REAL (KIND=JPRB)::ZBTCM
REAL (KIND=JPRB)::ZCC
REAL (KIND=JPRB)::ZRRT
REAL (KIND=JPRB)::ZBDT2
REAL (KIND=JPRB)::ZBDT
LOGICAL::LLNH_NOC1
REAL (KIND=JPHOOK)::ZHOOK_HANDLE
#include "mxmaoptr.h"
#include "siseve.intfb.h"
#include "si_cccor.intfb.h"
#include "sidd.intfb.h"
#include "sigam.intfb.h"
#include "spcimpfsolve.intfb.h"
#include "siptp.intfb.h"
#include "sitnu.intfb.h"
#include "spcsidg_part0nh.intfb.h"
#include "spcsidg_part1.intfb.h"
#include "spcsidg_part2.intfb.h"
#include "spcimpf_hsi1.intfb.h"
#include "spcimpf_hsi2.intfb.h"
#include "spcimpf_hsi3.intfb.h"
TYPE (FXTRAN_ACDC_STACK) :: YLSTACK

!$ACC DATA &
!$ACC&CREATE (ZR1D, ZR1D2, ZR1DPRIM, ZR2D, ZR3D, ZR4D, ZSDIV, ZSDIVP, ZSNHP, ZSP, ZSPDIVP, &
!$ACC&        ZSRHS, ZSRHS2, ZSRHS2_INC, ZST, ZSVED, ZWORK, ZZSPDIV0G, ZZSPDIVG, &
!$ACC&        ZZSPGDIV0G, ZZSPGDIVG, ZZSPSPDG, ZZSPSPG, ZZSPSVD0G, ZZSPSVDG, &
!$ACC&        ZZSPTG, ZZSPVOR0G, ZZSPVORG) &
!$ACC&IF (LDACC) &
!$ACC&PRESENT (PSPAUXG, PSPDIVG, PSPSPDG, PSPSPG, PSPSVDG, PSPTG, PSPVORG, YDCST, &
!$ACC&         YDDYN, YDDYNA, YDGEOMETRY, YDLDDH, YDRIP) 

IF (LHOOK) CALL DR_HOOK ('SPNHSI_SINGLEBLOCK', 0, ZHOOK_HANDLE)


LLNH_NOC1=.NOT.(YDGEOMETRY%YRVERT_GEOM%YRCVER%NDLNPR==1)

IF (LLNH_NOC1) THEN
  I_NITERHELM=YDDYN%NITERHELM
ELSE
  I_NITERHELM=0
ENDIF


IF (YDDYN%LIMPF) THEN
  CALL ABOR1 ('NOT SUPPORTED')
ENDIF


!$ACC PARALLEL LOOP GANG VECTOR &
!$ACC&IF (LDACC) &
!$ACC&PRIVATE (JLEV, JSP) 


DO JSP = KSTA, KEND

  DO JLEV=1, YDGEOMETRY%YRDIMV%NFLEVG
    
    ZZSPTG (JSP, JLEV)=PSPTG (JSP, JLEV)
    ZZSPSPDG (JSP, JLEV)=PSPSPDG (JSP, JLEV)
  
  ENDDO

  
  ZZSPSPG (JSP)=PSPSPG (JSP)
  
ENDDO



IF (YDLDDH%LRSIDDH) THEN
  CALL ABOR1 ('NOT SUPPORTED')
ENDIF


IF (LDONEM) THEN
  IOFF=YDGEOMETRY%YRMP%NPTRSVF(MYSETV)-1
ELSE
  IOFF=YDGEOMETRY%YRMP%NPTRSV(MYSETV)-1
ENDIF

ISPCOL=KEND-KSTA+1

IF ((YDDYN%LSIDG.OR.LESIDG).OR.YDDYN%LIMPF) THEN

  IF (KM==-999) THEN
    IMLOCSTA=YDGEOMETRY%YRMP%NPTRMF(MYSETN)
    IMLOCEND=YDGEOMETRY%YRMP%NPTRMF(MYSETN+1)-1
  ELSE
    IMLOCSTA=KMLOC
    IMLOCEND=KMLOC
  ENDIF

ENDIF

ZBDT=YDDYN%RBTS2*YDRIP%TDT
ZBDT2=(ZBDT*YDGEOMETRY%YRGEM%RSTRET)**2
ZRRT=1.0_JPRB/(YDCST%RD*YDDYN%SITR)
ZCC=YDCST%RCPD/YDCST%RCVD
ZBTCM=ZBDT*ZBDT*YDCST%RD*YDDYN%SITR*ZCC*YDGEOMETRY%YRGEM%RSTRET*YDGEOMETRY%YRGEM%RSTRET
ZBTCMH=ZBTCM*YDCST%RG*YDCST%RG*ZRRT*ZRRT

DO JITER=0, I_NITERHELM

  IF (JITER==0) THEN
    CALL SIDD_SINGLEBLOCK (YDCST, YDGEOMETRY, YDDYN, YDDYNA, ISPCOL, YDGEOMETRY%YRDIMV&
    &%NFLEVG, 1, ISPCOL, ZSDIV, ZSVED, ZZSPSPDG, ZZSPTG, ZZSPSPG, LDACC=LDACC)
    
    !$ACC PARALLEL LOOP GANG VECTOR &
    !$ACC&IF (LDACC) &
    !$ACC&PRIVATE (JLEV, JSP) 

    

    DO JSP = KSTA, KEND

      DO JLEV=1, YDGEOMETRY%YRDIMV%NFLEVG
        
        ZSDIV (JSP, JLEV)=PSPDIVG (JSP, JLEV)-ZBDT*YDDYN%SILAPDI(IOFF+JSP)*ZSDIV (JSP, JLEV)
      
      ENDDO

    ENDDO

  ELSE
    CALL SI_CCCOR_SINGLEBLOCK (YDCST, YDGEOMETRY, YDDYN, YDDYNA, ISPCOL, YDGEOMETRY&
    &%YRDIMV%NFLEVG, 1, ISPCOL, ZZSPGDIVG, ZSDIV, LDACC=LDACC)
    
    !$ACC PARALLEL LOOP GANG VECTOR &
    !$ACC&IF (LDACC) &
    !$ACC&PRIVATE (JLEV, JSP) 

    

    DO JSP = KSTA, KEND

      DO JLEV=1, YDGEOMETRY%YRDIMV%NFLEVG
        
        ZSDIV (JSP, JLEV)=ZBDT*ZBDT*YDDYN%SILAPDI(IOFF+JSP)*ZSDIV (JSP, JLEV)
      
      ENDDO

    ENDDO

  ENDIF


  IF (YDDYN%LIMPF) THEN
    CALL ABOR1 ('NOT SUPPORTED')
  ENDIF


  IF (JITER==0) THEN
    
    !$ACC PARALLEL LOOP GANG VECTOR &
    !$ACC&IF (LDACC) &
    !$ACC&PRIVATE (JLEV, JSP) 

    

    DO JSP = KSTA, KEND

      DO JLEV=1, YDGEOMETRY%YRDIMV%NFLEVG
        
        ZR2D (JSP, JLEV)=PSPSVDG (JSP, JLEV)-ZBDT*ZSVED (JSP, JLEV)
      
      ENDDO

    ENDDO

  ELSE
    
    !$ACC PARALLEL LOOP GANG VECTOR &
    !$ACC&IF (LDACC) &
    !$ACC&PRIVATE (JLEV, JSP) 

    

    DO JSP = KSTA, KEND

      DO JLEV=1, YDGEOMETRY%YRDIMV%NFLEVG
        
        ZR2D (JSP, JLEV)=0.0_JPRB
      
      ENDDO

    ENDDO

  ENDIF

  
  !$ACC PARALLEL LOOP GANG VECTOR &
  !$ACC&IF (LDACC) &
  !$ACC&PRIVATE (JLEV, JSP) 

  

  DO JSP = KSTA, KEND

    DO JLEV=1, YDGEOMETRY%YRDIMV%NFLEVG
      
      ZR1D (JSP, JLEV)=ZSDIV (JSP, JLEV)
      ZR1DPRIM (JSP, JLEV)=ZSDIV (JSP, JLEV)
    
    ENDDO

  ENDDO


  IF (YDDYN%LSIDG.OR.LESIDG) THEN
    

    IF (YDDYN%LSIDG) THEN
      CALL SPCSIDG_PART2 (YDGEOMETRY, KSTA, KEND, ZR1D, ZR1D2, IMLOCSTA, IMLOCEND, YDDYN&
      &%LSIDG, YDDYN%NSZNISNAX, YDDYN%SINISNAX, YDGEOMETRY%YSPGEOM%SCGMAP(:, 1), YDGEOMETRY&
      &%YSPGEOM%SCGMAP(:, 2), YDGEOMETRY%YSPGEOM%SCGMAP(:, 3),LDACC=LDACC)
    ELSE
      CALL SPCSIDG_PART2 (YDGEOMETRY, KSTA, KEND, ZR1D, ZR1D2, IMLOCSTA, IMLOCEND, YDDYN%LSIDG&
      &, YDDYN%NSZNISNAX, YDDYN%SINISNAX, YDDYN%SIPD, YDDYN%SIPE, YDDYN%SIPF,LDACC=LDACC)
    ENDIF

    
    
    !$ACC PARALLEL LOOP GANG VECTOR &
    !$ACC&IF (LDACC) &
    !$ACC&PRIVATE (JLEV, JSP) 

    

    DO JSP = KSTA, KEND

      DO JLEV=1, YDGEOMETRY%YRDIMV%NFLEVG
        
        ZR1D (JSP, JLEV)=ZR1D2 (JSP, JLEV)/(YDGEOMETRY%YRGEM%RSTRET*YDGEOMETRY%YRGEM%RSTRET)
      
      ENDDO

    ENDDO

  ENDIF

  CALL SISEVE_SINGLEBLOCK (YDCST, YDGEOMETRY, YDDYN, YDDYNA, ISPCOL,&
  & YDGEOMETRY%YRDIMV%NFLEVG, 1, ISPCOL, ZR1D, ZSRHS, LDACC=LDACC)
  CALL SITNU_SINGLEBLOCK (YDCST, YDGEOMETRY, YDDYN, ISPCOL, YDGEOMETRY&
  &%YRDIMV%NFLEVG, 1, ISPCOL, ZR1D, ZST, ZSP, LDACC=LDACC)
  CALL SISEVE_SINGLEBLOCK (YDCST, YDGEOMETRY, YDDYN, YDDYNA, ISPCOL,&
  & YDGEOMETRY%YRDIMV%NFLEVG, 1, ISPCOL, ZST, ZWORK, LDACC=LDACC)
  
  !$ACC PARALLEL LOOP GANG VECTOR &
  !$ACC&IF (LDACC) &
  !$ACC&PRIVATE (JLEV, JSP) 

  

  DO JSP = KSTA, KEND

    DO JLEV=1, YDGEOMETRY%YRDIMV%NFLEVG
      
      ZWORK (JSP, JLEV)=ZWORK (JSP, JLEV)*YDCST%RCVD*ZRRT
    
    ENDDO

  ENDDO


  IF (JITER==0) THEN

    IF (YDDYN%LSIDG.OR.LESIDG) THEN
      
      !$ACC PARALLEL LOOP GANG VECTOR &
      !$ACC&IF (LDACC) &
      !$ACC&PRIVATE (JLEV, JSP) 

      

      DO JSP = KSTA, KEND

        DO JLEV=1, YDGEOMETRY%YRDIMV%NFLEVG
          
          ZR3D (JSP, JLEV)=YDDYN%SILAPDI(IOFF+JSP)*ZR2D (JSP, JLEV)
        
        ENDDO

      ENDDO

      

      IF (YDDYN%LSIDG) THEN
        CALL SPCSIDG_PART2 (YDGEOMETRY, KSTA, KEND, ZR3D, ZR4D, IMLOCSTA, IMLOCEND, YDDYN&
        &%LSIDG, YDDYN%NSZNISNAX, YDDYN%SINISNAX, YDGEOMETRY%YSPGEOM%SCGMAP(:, 1), YDGEOMETRY&
        &%YSPGEOM%SCGMAP(:, 2), YDGEOMETRY%YSPGEOM%SCGMAP(:, 3),LDACC=LDACC)
      ELSEIF (LESIDG) THEN
        CALL SPCSIDG_PART2 (YDGEOMETRY, KSTA, KEND, ZR3D, ZR4D, IMLOCSTA, IMLOCEND, YDDYN%LSIDG&
        &, YDDYN%NSZNISNAX, YDDYN%SINISNAX, YDDYN%SIPD, YDDYN%SIPE, YDDYN%SIPF,LDACC=LDACC)
      ENDIF

      
      
      !$ACC PARALLEL LOOP GANG VECTOR &
      !$ACC&IF (LDACC) &
      !$ACC&PRIVATE (JLEV, JSP) 

      

      DO JSP = KSTA, KEND

        DO JLEV=1, YDGEOMETRY%YRDIMV%NFLEVG
          
          ZSVED (JSP, JLEV)=ZR2D (JSP, JLEV)-(ZBTCM/(YDGEOMETRY%YRGEM&
          &%RSTRET*YDGEOMETRY%YRGEM%RSTRET))*ZR4D (JSP, JLEV)
        
        ENDDO

      ENDDO

    ELSE

      IF (LELAM) THEN
        
        !$ACC PARALLEL LOOP GANG VECTOR &
        !$ACC&IF (LDACC) &
        !$ACC&PRIVATE (JLEV, JSP) 

        

        DO JSP = KSTA, KEND

          DO JLEV=1, YDGEOMETRY%YRDIMV%NFLEVG
            
            ZSVED (JSP, JLEV)=ZR2D (JSP, JLEV)*(1.0_JPRB-ZBTCM*YDDYN%SILAPDI(IOFF+JSP))
          
          ENDDO

        ENDDO

      ELSE
        
        !$ACC PARALLEL LOOP GANG VECTOR &
        !$ACC&IF (LDACC) &
        !$ACC&PRIVATE (JLEV, JSP) 

        

        DO JSP = KSTA, KEND

          DO JLEV=1, YDGEOMETRY%YRDIMV%NFLEVG
            
            ZSVED (JSP, JLEV)=ZR2D (JSP, JLEV)-ZBTCM*ZR2D (JSP, JLEV)*YDDYN%SILAPDI(IOFF+JSP)
          
          ENDDO

        ENDDO

      ENDIF

    ENDIF

  ELSE
    
    !$ACC PARALLEL LOOP GANG VECTOR &
    !$ACC&IF (LDACC) &
    !$ACC&PRIVATE (JLEV, JSP) 

    

    DO JSP = KSTA, KEND

      DO JLEV=1, YDGEOMETRY%YRDIMV%NFLEVG
        
        ZSVED (JSP, JLEV)=0.0_JPRB
      
      ENDDO

    ENDDO

  ENDIF

  
  !$ACC PARALLEL LOOP GANG VECTOR &
  !$ACC&IF (LDACC) &
  !$ACC&PRIVATE (JLEV, JSP) 

  

  DO JSP = KSTA, KEND

    DO JLEV=1, YDGEOMETRY%YRDIMV%NFLEVG
      
      ZSRHS2 (JSP, JLEV)=ZBTCMH*(ZSRHS (JSP, JLEV)-ZWORK (JSP, JLEV))+ZSVED (JSP, JLEV)
    
    ENDDO

  ENDDO


  IF (YDDYN%LIMPF.AND.(JITER==0)) THEN
    CALL ABOR1 ('NOT SUPPORTED')
  ENDIF

  CALL MXMAOPTR (YDDYN%SIFACI, 1, YDGEOMETRY%YRDIMV%NFLEVG, ZSRHS2, 1, YDGEOMETRY&
  &%YRDIMV%NFLEVG, ZSRHS, 1, YDGEOMETRY%YRDIMV%NFLEVG, YDGEOMETRY%YRDIMV&
  &%NFLEVG, YDGEOMETRY%YRDIMV%NFLEVG, ISPCOL, LDACC=LDACC)
  CALL MXMAOPTR (YDDYN%SIMI, 1, YDGEOMETRY%YRDIMV%NFLEVG, ZSRHS, 1, YDGEOMETRY&
  &%YRDIMV%NFLEVG, ZSDIVP, 1, YDGEOMETRY%YRDIMV%NFLEVG, YDGEOMETRY%YRDIMV&
  &%NFLEVG, YDGEOMETRY%YRDIMV%NFLEVG, ISPCOL, LDACC=LDACC)

  IF (YDDYN%LSIDG.OR.LESIDG) THEN

    IF (KM==-999) THEN
      
      CALL SPCSIDG_PART1 (YDGEOMETRY, YDDYN, KSTA, KEND, ZSDIVP, ZSPDIVP, YDGEOMETRY&
      &%YRMP%NPTRMF(MYSETN), YDGEOMETRY%YRMP%NPTRMF(MYSETN+1)-1, YDDYN%LSIDG, YDDYN&
      &%NSZNISNAX, YDDYN%SINISNAX, YDDYN%SIHEGTRA, YDDYN%SIHEG2TRA,LDACC=LDACC)
      CALL SPCSIDG_PART0NH (YDGEOMETRY, YDDYN, KSTA, KEND, ZSPDIVP, YDDYN%SILAPIN, KM, IOFF,LDACC=LDACC)
      
    ELSE
      CALL ABOR1 ('NOT SUPPORTED')
    ENDIF

  ELSE

    IF (YDDYN%LIMPF) THEN
      CALL ABOR1 ('NOT SUPPORTED')
    ELSE
      
      !$ACC PARALLEL LOOP GANG VECTOR &
      !$ACC&IF (LDACC) &
      !$ACC&PRIVATE (JLEV, JSP) 

      

      DO JSP = KSTA, KEND

        DO JLEV=1, YDGEOMETRY%YRDIMV%NFLEVG
          
          ZSPDIVP (JSP, JLEV)=ZSDIVP (JSP, JLEV)/(1.0_JPRB-ZBDT2*YDDYN%SIVP(JLEV)*YDDYN%SILAPDI(IOFF+JSP))
        
        ENDDO

      ENDDO

    ENDIF

  ENDIF

  CALL MXMAOPTR (YDDYN%SIMO, 1, YDGEOMETRY%YRDIMV%NFLEVG, ZSPDIVP, 1, YDGEOMETRY&
  &%YRDIMV%NFLEVG, ZZSPSVDG, 1, YDGEOMETRY%YRDIMV%NFLEVG, YDGEOMETRY%YRDIMV&
  &%NFLEVG, YDGEOMETRY%YRDIMV%NFLEVG, ISPCOL, LDACC=LDACC)
  
  !$ACC PARALLEL LOOP GANG VECTOR &
  !$ACC&IF (LDACC) &
  !$ACC&PRIVATE (JSP) 

  

  DO JSP = KSTA, KEND
    
    ZSP (JSP)=0.0_JPRB
  
  ENDDO

  CALL SIGAM_SINGLEBLOCK (YDCST, YDGEOMETRY, YDDYN, ISPCOL, YDGEOMETRY&
  &%YRDIMV%NFLEVG, 1, ISPCOL, ZWORK, ZZSPSVDG, ZSP, LDACC=LDACC)
  
  !$ACC PARALLEL LOOP GANG VECTOR &
  !$ACC&IF (LDACC) &
  !$ACC&PRIVATE (JLEV, JSP) 

  

  DO JSP = KSTA, KEND

    DO JLEV=1, YDGEOMETRY%YRDIMV%NFLEVG
      
      ZSRHS (JSP, JLEV)=(ZZSPSVDG (JSP, JLEV)*YDCST%RD*ZCC-ZWORK (JSP, JLEV)&
      &)*YDDYN%SITR*ZBDT*ZBDT*YDDYN%SILAPDI(IOFF+JSP)+ZR1DPRIM (JSP, JLEV)
    
    ENDDO

  ENDDO


  IF (YDDYN%LSIDG.OR.LESIDG) THEN
    
    CALL SPCSIDG_PART0NH (YDGEOMETRY, YDDYN, KSTA, KEND, ZSRHS, YDDYN%SILAPIN, KM, IOFF,LDACC=LDACC)
    CALL SPCSIDG_PART1 (YDGEOMETRY, YDDYN, KSTA, KEND, ZSRHS, ZZSPDIVG, IMLOCSTA, IMLOCEND, YDDYN&
    &%LSIDG, YDDYN%NSZNISNAX, YDDYN%SINISNAX, YDDYN%SIHEGBTRA, YDDYN%SIHEGB2TRA,LDACC=LDACC)
    
  ELSE

    IF (YDDYN%LIMPF) THEN
      CALL ABOR1 ('NOT SUPPORTED')
    ELSE
      
      !$ACC PARALLEL LOOP GANG VECTOR &
      !$ACC&IF (LDACC) &
      !$ACC&PRIVATE (JLEV, JSP) 

      

      DO JSP = KSTA, KEND

        DO JLEV=1, YDGEOMETRY%YRDIMV%NFLEVG
          
          ZZSPDIVG (JSP, JLEV)=ZSRHS (JSP, JLEV)/(1.0_JPRB-ZBTCM*YDDYN%SILAPDI(IOFF+JSP))
        
        ENDDO

      ENDDO

    ENDIF

  ENDIF


  IF (YDDYN%LSIDG) THEN
    
    CALL SPCSIDG_PART2 (YDGEOMETRY, KSTA, KEND, ZZSPDIVG, ZWORK, IMLOCSTA, IMLOCEND, YDDYN&
    &%LSIDG, YDDYN%NSZNISNAX, YDDYN%SINISNAX, YDGEOMETRY%YSPGEOM%SCGMAP(:, 1), YDGEOMETRY&
    &%YSPGEOM%SCGMAP(:, 2), YDGEOMETRY%YSPGEOM%SCGMAP(:, 3),LDACC=LDACC)
    
  ELSEIF (LESIDG) THEN
    CALL ABOR1 ('NOT SUPPORTED')
  ELSE
    
    !$ACC PARALLEL LOOP GANG VECTOR &
    !$ACC&IF (LDACC) &
    !$ACC&PRIVATE (JLEV, JSP) 

    

    DO JSP = KSTA, KEND

      DO JLEV=1, YDGEOMETRY%YRDIMV%NFLEVG
        
        ZWORK (JSP, JLEV)=ZZSPDIVG (JSP, JLEV)*YDGEOMETRY%YRGEM%RSTRET*YDGEOMETRY%YRGEM%RSTRET
      
      ENDDO

    ENDDO

  ENDIF


  IF (YDDYN%LIMPF) THEN
    
    CALL SPCIMPF_HSI3 (YDGEOMETRY, YDRIP, YDDYN, IMLOCSTA, IMLOCEND&
    &, KSTA, KEND, ZZSPDIVG, ZZSPVORG,LDACC=LDACC)
    
  ENDIF


  IF (I_NITERHELM>0) THEN

    IF (JITER==0) THEN
      
      !$ACC PARALLEL LOOP GANG VECTOR &
      !$ACC&IF (LDACC) &
      !$ACC&PRIVATE (JLEV, JSP) 

      

      DO JSP = KSTA, KEND

        DO JLEV=1, YDGEOMETRY%YRDIMV%NFLEVG
          
          ZZSPDIV0G (JSP, JLEV)=ZZSPDIVG (JSP, JLEV)
          ZZSPGDIV0G (JSP, JLEV)=ZWORK (JSP, JLEV)
          ZZSPSVD0G (JSP, JLEV)=ZZSPSVDG (JSP, JLEV)
        
        ENDDO

      ENDDO


      IF (YDDYN%LIMPF) THEN
        CALL ABOR1 ('NOT SUPPORTED')
      ENDIF

    ENDIF


    IF (JITER==0) THEN
      
      !$ACC PARALLEL LOOP GANG VECTOR &
      !$ACC&IF (LDACC) &
      !$ACC&PRIVATE (JLEV, JSP) 

      

      DO JSP = KSTA, KEND

        DO JLEV=1, YDGEOMETRY%YRDIMV%NFLEVG
          
          ZZSPGDIVG (JSP, JLEV)=ZWORK (JSP, JLEV)
        
        ENDDO

      ENDDO

    ELSE
      
      !$ACC PARALLEL LOOP GANG VECTOR &
      !$ACC&IF (LDACC) &
      !$ACC&PRIVATE (JLEV, JSP) 

      

      DO JSP = KSTA, KEND

        DO JLEV=1, YDGEOMETRY%YRDIMV%NFLEVG
          
          ZZSPGDIVG (JSP, JLEV)=ZWORK (JSP, JLEV)+ZZSPGDIV0G (JSP, JLEV)
        
        ENDDO

      ENDDO

    ENDIF

  ENDIF

ENDDO


IF (I_NITERHELM>0) THEN
  
  !$ACC PARALLEL LOOP GANG VECTOR &
  !$ACC&IF (LDACC) &
  !$ACC&PRIVATE (JLEV, JSP) 

  

  DO JSP = KSTA, KEND

    DO JLEV=1, YDGEOMETRY%YRDIMV%NFLEVG
      
      ZZSPDIVG (JSP, JLEV)=ZZSPDIVG (JSP, JLEV)+ZZSPDIV0G (JSP, JLEV)
      ZWORK (JSP, JLEV)=ZWORK (JSP, JLEV)+ZZSPGDIV0G (JSP, JLEV)
      ZZSPSVDG (JSP, JLEV)=ZZSPSVDG (JSP, JLEV)+ZZSPSVD0G (JSP, JLEV)
    
    ENDDO

  ENDDO


  IF (YDDYN%LIMPF) THEN
    CALL ABOR1 ('NOT SUPPORTED')
  ENDIF

ENDIF

CALL SIPTP_SINGLEBLOCK (YDCST, YDGEOMETRY, YDDYN, YDDYNA, ISPCOL, YDGEOMETRY&
&%YRDIMV%NFLEVG, 1, ISPCOL, ZWORK, ZZSPSVDG, ZSNHP, ZST, ZSP, LDACC=LDACC)

!$ACC PARALLEL LOOP GANG VECTOR &
!$ACC&IF (LDACC) &
!$ACC&PRIVATE (JLEV, JSP) 


DO JSP = KSTA, KEND

  DO JLEV=1, YDGEOMETRY%YRDIMV%NFLEVG
    
    PSPTG (JSP, JLEV)=ZZSPTG (JSP, JLEV)-ZBDT*ZST (JSP, JLEV)
    PSPSPDG (JSP, JLEV)=ZZSPSPDG (JSP, JLEV)-ZBDT*ZSNHP (JSP, JLEV)
  
  ENDDO

  
  PSPSPG (JSP)=ZZSPSPG (JSP)-ZBDT*ZSP (JSP)
  
ENDDO



IF (YDDYN%LIMPF) THEN
  CALL ABOR1 ('NOT SUPPORTED')
ENDIF


!$ACC PARALLEL LOOP GANG VECTOR &
!$ACC&IF (LDACC) &
!$ACC&PRIVATE (JLEV, JSP) 


DO JSP = KSTA, KEND

  DO JLEV=1, YDGEOMETRY%YRDIMV%NFLEVG
    
    PSPDIVG (JSP, JLEV)=ZZSPDIVG (JSP, JLEV)
    PSPSVDG (JSP, JLEV)=ZZSPSVDG (JSP, JLEV)
  
  ENDDO

ENDDO


IF (YDLDDH%LRSIDDH) THEN
  CALL ABOR1 ('NOT SUPPORTED')
ENDIF



IF (LHOOK) CALL DR_HOOK ('SPNHSI_SINGLEBLOCK', 1, ZHOOK_HANDLE)
!$ACC END DATA

ENDSUBROUTINE SPNHSI_SINGLEBLOCK
