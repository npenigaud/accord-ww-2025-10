SUBROUTINE LATTEX_EXPL_2TL (YDGEOMETRY, YDCPG_BNDS, YDCPG_OPTS, YDML_DYN, YDCPG_SL1, YDVARS, LDCT, LDCTC)

!$ACDC outline1    


USE PARKIND1, ONLY : JPIM, JPRB
USE YOMHOOK, ONLY : LHOOK, JPHOOK, DR_HOOK

USE GEOMETRY_MOD           , ONLY : GEOMETRY
USE CPG_OPTS_TYPE_MOD      , ONLY : CPG_BNDS_TYPE, CPG_OPTS_TYPE
USE MODEL_DYNAMICS_MOD     , ONLY : MODEL_DYNAMICS_TYPE
USE CPG_SL1_TYPE_MOD       , ONLY : CPG_SL1B_TYPE
USE FIELD_VARIABLES_MOD    , ONLY : FIELD_VARIABLES


IMPLICIT NONE

TYPE(GEOMETRY)                ,INTENT (IN)    :: YDGEOMETRY
TYPE(CPG_BNDS_TYPE)           ,INTENT (IN)    :: YDCPG_BNDS
TYPE(CPG_OPTS_TYPE)           ,INTENT (IN)    :: YDCPG_OPTS
TYPE(MODEL_DYNAMICS_TYPE)     ,INTENT (IN)    :: YDML_DYN
TYPE(CPG_SL1B_TYPE)           ,INTENT (INOUT) :: YDCPG_SL1
TYPE(FIELD_VARIABLES)         ,INTENT (INOUT) :: YDVARS
LOGICAL                       ,INTENT (IN)    :: LDCT
LOGICAL                       ,INTENT (IN)    :: LDCTC

LOGICAL :: LLTDIABLIN
INTEGER (KIND=JPIM) :: JLEV
INTEGER (KIND=JPIM) :: JROF
INTEGER (KIND=JPIM) :: JGFL

REAL(KIND=JPHOOK) :: ZHOOK_HANDLE

IF (LHOOK) CALL DR_HOOK('LATTEX_EXPL_2TL',0,ZHOOK_HANDLE)

IF(LDCT.AND.(.NOT.LDCTC))THEN

DO JGFL = 1, SIZE (YDCPG_SL1%GFL)

  IF (YDVARS%GFL_PTR (JGFL)%YCOMP%LADV) THEN
    IF (YDML_DYN%YRDYN%LSPLTHOIGFL.AND.(YDML_DYN%YRDYN%NSPLTHOI==0).AND.(.NOT.YDVARS%GFL_PTR (JGFL)%YCOMP%LTDIABLIN)) THEN

!$ACDC PARALLEL, TARGET=OpenMP/OpenMPSingleColumn/OpenACCSingleColumn {

      DO JLEV=1,YDGEOMETRY%YRDIMV%NFLEVG
        DO JROF=YDCPG_BNDS%KIDIA,YDCPG_BNDS%KFDIA
          YDCPG_SL1%GFL (JGFL)%P(JROF,JLEV)=YDCPG_SL1%GFL (JGFL)%P(JROF,JLEV) &
           & +YDCPG_SL1%GFL (JGFL)%P_F(JROF,JLEV)+YDVARS%GFL_PTR (JGFL)%T9(JROF,JLEV)
        ENDDO
      ENDDO

!$ACDC }

    ELSE

!$ACDC PARALLEL, TARGET=OpenMP/OpenMPSingleColumn/OpenACCSingleColumn {

      DO JLEV=1,YDGEOMETRY%YRDIMV%NFLEVG
        DO JROF=YDCPG_BNDS%KIDIA,YDCPG_BNDS%KFDIA
          YDCPG_SL1%GFL (JGFL)%P(JROF,JLEV)=YDCPG_SL1%GFL (JGFL)%P(JROF,JLEV) &
           & +YDVARS%GFL_PTR (JGFL)%T9(JROF,JLEV)
        ENDDO
      ENDDO

!$ACDC }

    ENDIF
  ENDIF

ENDDO

ELSEIF (.NOT.LDCT) THEN

DO JGFL = 1, SIZE (YDCPG_SL1%GFL)

  IF (YDVARS%GFL_PTR (JGFL)%YCOMP%LADV) THEN
    IF (YDML_DYN%YRDYN%LSPLTHOIGFL.AND.(YDML_DYN%YRDYN%NSPLTHOI==0).AND.(.NOT.YDVARS%GFL_PTR (JGFL)%YCOMP%LTDIABLIN)) THEN

!$ACDC PARALLEL, TARGET=OpenMP/OpenMPSingleColumn/OpenACCSingleColumn {

      DO JLEV=1,YDGEOMETRY%YRDIMV%NFLEVG
        DO JROF=YDCPG_BNDS%KIDIA,YDCPG_BNDS%KFDIA
          YDCPG_SL1%GFL (JGFL)%P(JROF,JLEV)=YDCPG_SL1%GFL (JGFL)%P(JROF,JLEV) &
           & +YDCPG_SL1%GFL (JGFL)%P_F(JROF,JLEV)+YDVARS%GFL_PTR (JGFL)%T0(JROF,JLEV)
        ENDDO
      ENDDO

!$ACDC }

    ELSE

!$ACDC PARALLEL, TARGET=OpenMP/OpenMPSingleColumn/OpenACCSingleColumn {

      DO JLEV=1,YDGEOMETRY%YRDIMV%NFLEVG
        DO JROF=YDCPG_BNDS%KIDIA,YDCPG_BNDS%KFDIA
          YDCPG_SL1%GFL (JGFL)%P(JROF,JLEV)=YDCPG_SL1%GFL (JGFL)%P(JROF,JLEV) &
           & +YDVARS%GFL_PTR (JGFL)%T0(JROF,JLEV)
        ENDDO
      ENDDO

!$ACDC }

    ENDIF

  ENDIF

ENDDO

ENDIF

!  Qv in YCVGQ for computation of SL Moisture Convergence for French physics

IF (YDVARS%CVGQ%YCOMP%LGP .AND. (.NOT.LDCTC)) THEN  

  LLTDIABLIN=YDVARS%CVGQ%YCOMP%LTDIABLIN
  IF ((YDML_DYN%YRDYN%NSPLTHOI /= 0).OR.LLTDIABLIN) THEN

!$ACDC PARALLEL, TARGET=OpenMP/OpenMPSingleColumn/OpenACCSingleColumn {

    DO JLEV=1,YDGEOMETRY%YRDIMV%NFLEVG
      DO JROF=YDCPG_BNDS%KIDIA,YDCPG_BNDS%KFDIA
        YDCPG_SL1%CVGQ%P_F(JROF,JLEV)=YDCPG_SL1%Q%P_F(JROF,JLEV)
      ENDDO
    ENDDO

!$ACDC }

  ENDIF

!$ACDC PARALLEL, TARGET=OpenMP/OpenMPSingleColumn/OpenACCSingleColumn {

  DO JLEV=1,YDGEOMETRY%YRDIMV%NFLEVG
    DO JROF=YDCPG_BNDS%KIDIA,YDCPG_BNDS%KFDIA
      YDCPG_SL1%CVGQ%P(JROF,JLEV)=YDCPG_SL1%Q%P(JROF,JLEV)
    ENDDO
  ENDDO

!$ACDC }

  LLTDIABLIN=YDVARS%CVGQ%YCOMP%LTDIABLIN.AND.YDVARS%Q%YCOMP%LTDIABLIN
  IF ((YDML_DYN%YRDYN%NSPLTHOI == 0).AND.LLTDIABLIN) THEN

!$ACDC PARALLEL, TARGET=OpenMP/OpenMPSingleColumn/OpenACCSingleColumn {

    DO JLEV=1,YDGEOMETRY%YRDIMV%NFLEVG
      DO JROF=YDCPG_BNDS%KIDIA,YDCPG_BNDS%KFDIA
        YDCPG_SL1%CVGQ%P(JROF,JLEV)=YDCPG_SL1%CVGQ%P(JROF,JLEV)+YDCPG_SL1%Q%P_F(JROF,JLEV)
      ENDDO
    ENDDO

!$ACDC }

  ENDIF

ENDIF   

IF (LHOOK) CALL DR_HOOK('LATTEX_EXPL_2TL',1,ZHOOK_HANDLE)

END SUBROUTINE LATTEX_EXPL_2TL


