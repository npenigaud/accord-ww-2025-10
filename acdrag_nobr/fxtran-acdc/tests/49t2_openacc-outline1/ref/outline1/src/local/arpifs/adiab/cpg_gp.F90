SUBROUTINE CPG_GP (YDGEOMETRY, YDCPG_BNDS, YDCPG_OPTS, YDCPG_TND, YDCPG_MISC, YDCPG_GPAR, YDCPG_DYN0&
&, YDCPG_DYN9, YDHGRAD, YDMF_PHYS_SURF, YDVARS, YDMODEL, YDCPG_SL2, YDPGTERM, YDDDH)
USE TYPE_MODEL,ONLY:MODEL
USE GEOMETRY_MOD,ONLY:GEOMETRY
USE CPG_TYPE_MOD,ONLY:CPG_DYN_TYPE, CPG_GPAR_TYPE, CPG_MISC_TYPE, CPG_TND_TYPE
USE CPG_SL2_TYPE_MOD,ONLY:CPG_SL2_TYPE
USE CPG_OPTS_TYPE_MOD,ONLY:CPG_BNDS_TYPE, CPG_OPTS_TYPE
USE YOMDGRADIENT_TYPE_MOD,ONLY:GRADIENT_TYPE
USE MF_PHYS_SURFACE_TYPE_MOD,ONLY:MF_PHYS_SURF_TYPE
USE FIELD_VARIABLES_MOD,ONLY:FIELD_VARIABLES
USE DDH_MIX,ONLY:TYP_DDH
USE PARKIND1,ONLY:JPIM, JPRB
USE YOMHOOK,ONLY:DR_HOOK, LHOOK, JPHOOK
USE INTDYN_MOD,ONLY:TPG_TYPE

IMPLICIT NONE


TYPE (GEOMETRY), INTENT (IN)::YDGEOMETRY
TYPE (CPG_BNDS_TYPE), INTENT (IN)::YDCPG_BNDS
TYPE (CPG_OPTS_TYPE), INTENT (IN)::YDCPG_OPTS
TYPE (CPG_TND_TYPE), INTENT (INOUT)::YDCPG_TND
TYPE (CPG_MISC_TYPE), INTENT (INOUT)::YDCPG_MISC
TYPE (CPG_GPAR_TYPE), INTENT (INOUT)::YDCPG_GPAR
TYPE (CPG_DYN_TYPE), INTENT (INOUT)::YDCPG_DYN0
TYPE (CPG_DYN_TYPE), INTENT (INOUT)::YDCPG_DYN9
TYPE (GRADIENT_TYPE), INTENT (INOUT)::YDHGRAD
TYPE (MF_PHYS_SURF_TYPE), INTENT (INOUT)::YDMF_PHYS_SURF
TYPE (FIELD_VARIABLES), INTENT (INOUT)::YDVARS
TYPE (MODEL), INTENT (IN)::YDMODEL
TYPE (CPG_SL2_TYPE), INTENT (INOUT)::YDCPG_SL2
TYPE (TPG_TYPE), INTENT (INOUT)::YDPGTERM
TYPE (TYP_DDH), INTENT (INOUT)::YDDDH
#include "abor1.intfb.h"
#include "cpg_gp_set1to9.intfb.h"
#include "cpg_gp_set1to0.intfb.h"
#include "cpg_gp_gpinislb_part3_expl.intfb.h"
#include "cpg_gp_gpinislb_part1_expl.intfb.h"
#include "cpg_gp_set9to0.intfb.h"
#include "cpg_gp_setzero.intfb.h"
#include "cpg_gp_gp_spv.intfb.h"
#include "cpg_gp_map_factor.intfb.h"
#include "cpg_gp_gptf2_expl_2tl.intfb.h"
#include "cp_forcing.intfb.h"
#include "cp_forcing_ps.intfb.h"

#include "gpinislb_part2_expl.intfb.h"

#include "gpinozst.intfb.h"
#include "gpmpfc_expl.intfb.h"
#include "gpnspng_expl.intfb.h"


#include "gptf2_expl_3tl_part1.intfb.h"
#include "gptf2_expl_3tl_part2.intfb.h"
#include "updsst.intfb.h"
#include "cpg_gp_hyd.intfb.h"
#include "cpg_gp_nhee.intfb.h"
#include "cpg_gp_nhqe.intfb.h"
#include "cpg_gp_sacc.intfb.h"
#include "cpg_gp_nhhy.intfb.h"
REAL (KIND=JPRB)::Z_GDW_T0 (YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB)::Z_GWHT_T0 (YDGEOMETRY%YRDIM%NPROMA, 0:YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB)::Z_OROGLL_T0 (YDGEOMETRY%YRDIM%NPROMA)
REAL (KIND=JPRB)::Z_OROGLM_T0 (YDGEOMETRY%YRDIM%NPROMA)
REAL (KIND=JPRB)::Z_OROGMM_T0 (YDGEOMETRY%YRDIM%NPROMA)
INTEGER (KIND=JPIM)::JGFL
INTEGER (KIND=JPIM)::IFLAG

LOGICAL::LLSTR
REAL (KIND=JPRB)::ZEPS

REAL (KIND=JPHOOK)::ZHOOK_HANDLE
IF (LHOOK) CALL DR_HOOK ('CPG_GP', 0, ZHOOK_HANDLE)



ZEPS=100.0_JPRB*TINY (1.0_JPRB)
LLSTR=(ABS (YDGEOMETRY%YRGEM%RSTRET-1.0_JPRB)>ZEPS)

IF (YDMODEL%YRML_DYN%YRSPNG%LNSPONGE) THEN
  
  CALL GPNSPNG_EXPL (YDMODEL%YRML_DYN%YRSPNG, YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY&
  &%YRDIMV%NFLEVG, YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA, YDVARS)
  
ENDIF


IF (YDMODEL%YRML_DYN%YRDYN%NCURRENT_ITER==0) THEN

  IF (YDMODEL%YRML_DYN%YRDYNA%LTWOTL) THEN
    CALL CPG_GP_GPTF2_EXPL_2TL (YDCPG_BNDS, YDCPG_OPTS, YDGEOMETRY, YDVARS)
  ELSE
    
    CALL GPTF2_EXPL_3TL_PART1 (YDGEOMETRY, YDMODEL%YRML_GCONF, YDMODEL%YRML_DYN%YRDYN, YDMODEL%YRML_DYN&
    &%YRDYNA, YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA, YDCPG_OPTS%LFSTEP, P0SP=YDVARS%SP%T0, P0SPL=YDVARS&
    &%SP%DL, P0SPM=YDVARS%SP%DM, P9SP=YDVARS%SP%T9, P9SPL=YDVARS%SP%DL9, P9SPM=YDVARS%SP%DM9, P0DIV&
    &=YDVARS%DIV%T0, P0NHX=YDVARS%NHX%T0, P0SPD=YDVARS%SPD%T0, P0SPDL=YDVARS%SPD%DL, P0SPDM=YDVARS&
    &%SPD%DM, P0SVD=YDVARS%SVD%T0, P0SVDL=YDVARS%SVD%DL, P0SVDM=YDVARS%SVD%DM, P0T=YDVARS%T%T0,&
    & P0TL=YDVARS%T%DL, P0TM=YDVARS%T%DM, P0U=YDVARS%U%T0, P0V=YDVARS%V%T0, P9DIV=YDVARS%DIV%T9&
    &, P9NHX=YDVARS%NHX%T9, P9SPD=YDVARS%SPD%T9, P9SPDL=YDVARS%SPD%DL9, P9SPDM=YDVARS%SPD%DM9, P9SVD&
    &=YDVARS%SVD%T9, P9SVDL=YDVARS%SVD%DL9, P9SVDM=YDVARS%SVD%DM9, P9T=YDVARS%T%T9, P9TL=YDVARS&
    &%T%DL9, P9TM=YDVARS%T%DM9, P9U=YDVARS%U%T9, P9V=YDVARS%V%T9)
    CALL GPTF2_EXPL_3TL_PART2 (YDGEOMETRY, YDMODEL%YRML_DYN%YRDYN, YDCPG_BNDS&
    &%KIDIA, YDCPG_BNDS%KFDIA, YDCPG_OPTS%LFSTEP, YDVARS)
    
  ENDIF

ENDIF

CALL CPG_GP_MAP_FACTOR (YDCPG_BNDS, YDCPG_DYN0, YDGEOMETRY,&
& YDMODEL, YDVARS, Z_OROGLL_T0, Z_OROGLM_T0, Z_OROGMM_T0)

IF (LLSTR.AND.(.NOT.YDMODEL%YRML_DYN%YRDYNA%LPGFSF)) THEN
  IFLAG=0
  CALL GPMPFC_EXPL (YDVARS, YDMODEL%YRML_GCONF, YDMODEL%YRML_DYN%YRDYN, YDMODEL&
  &%YRML_DYN%YRDYNA, YDCPG_OPTS, YDCPG_BNDS, IFLAG, YDVARS%GEOMETRY%GM%T0)
ENDIF

CALL CPG_GP_GP_SPV (YDCPG_BNDS, YDCPG_DYN0, YDCPG_DYN9, YDGEOMETRY, YDMODEL, YDVARS)

IF (YDCPG_OPTS%LSFORC.AND.YDCPG_OPTS%LSPS_FRC) THEN
  
  CALL CP_FORCING_PS (YDGEOMETRY, YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA, YDCPG_DYN0%PRE)
  
ENDIF


IF (YDMODEL%YRML_DYN%YRDYN%NCURRENT_ITER==0) THEN

  IF (YDCPG_OPTS%LDIAB.OR.YDMODEL%YRML_PHY_SLIN%YRPHLC%LSPHLC&
    &.OR.YDMODEL%YRML_PHY_MF%YRSIMPHL%LSIMPH) THEN
    CALL CPG_GP_SETZERO (YDCPG_BNDS, YDCPG_MISC)

    IF (YDCPG_OPTS%LFSTEP.AND..NOT.YDMODEL%YRML_DYN%YRDYNA%LTWOTL) THEN
      CALL CPG_GP_SET9TO0 (YDCPG_BNDS, YDCPG_OPTS, YDMF_PHYS_SURF)
    ENDIF

  ENDIF


  IF (YDCPG_OPTS%LDIAB) THEN

    IF (YDMODEL%YRML_PHY_G%YRDPHY%NTOZ3D>0.OR.YDMODEL%YRML_PHY_G%YRDPHY%NTOZ2D>0.OR.YDMODEL&
      &%YRML_PHY_G%YRDPHY%NTOZ1D>0.AND.(.NOT.YDMODEL%YRML_PHY_EC%YREPHY%LEO3CH)) THEN
      
      CALL GPINOZST (YDGEOMETRY, YDMODEL%YRML_CHEM%YROZO, YDMODEL%YRML_PHY_G%YRDPHY&
      &, YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA, YDCPG_BNDS%KSTGLO, YDCPG_MISC%KOZO)
      
    ENDIF

  ENDIF


  IF (YDCPG_OPTS%LNUDG.AND.(.NOT.YDMODEL%YRML_PHY_MF%YRARPHY%LMSE)) THEN
    
    CALL UPDSST (YDMODEL%YRML_AOC%YRMCC, YDMODEL%YRML_PHY_MF%YRPHY1, YDGEOMETRY%YRDIM%NPROMA, YDCPG_BNDS&
    &%KIDIA, YDCPG_BNDS%KFDIA, YDCPG_OPTS%NFNUDG, YDCPG_OPTS%YRSURF_DIMS%YSP_SBD%NLEVS, YDCPG_BNDS%KBL,&
    & YDCPG_OPTS%XPNUDG, YDMF_PHYS_SURF%GSP_RR%PT_T0, YDMF_PHYS_SURF%GSP_SB%PT_T0, YDMF_PHYS_SURF%GSP_RR&
    &%PW_T0, YDMF_PHYS_SURF%GSP_SB%PQ_T0, YDMF_PHYS_SURF%GSP_SG%PF_T0, YDMF_PHYS_SURF%GSP_SG%PA_T0, YDMF_PHYS_SURF&
    &%GSP_SG%PR_T0, YDMF_PHYS_SURF%GSP_RR%PIC_T0, YDMF_PHYS_SURF%GSP_SB%PTL_T0, YDMF_PHYS_SURF%GSD_VF%PLSM&
    &, YDMF_PHYS_SURF%GSD_VF%PALBF, YDMF_PHYS_SURF%GSD_VF%PEMISF, YDMF_PHYS_SURF%GSD_VF%PZ0F, YDMF_PHYS_SURF&
    &%GSD_VV%PZ0H, YDMF_PHYS_SURF%GSD_VV%PD2, YDMF_PHYS_SURF%GSD_VV%PIVEG)
    
  ENDIF

ENDIF


IF (YDMODEL%YRML_DYN%YRDYNA%LNHQE) THEN
  
  CALL CPG_GP_NHQE (YDGEOMETRY, YDCPG_BNDS, YDCPG_OPTS, YDVARS, YDCPG_DYN0, YDCPG_DYN9&
  &, YDMODEL, Z_OROGLL_T0, Z_OROGMM_T0, Z_OROGLM_T0, Z_GDW_T0, Z_GWHT_T0, YDCPG_TND)
  
ELSEIF (YDMODEL%YRML_DYN%YRDYNA%LNHEE) THEN
  
  CALL CPG_GP_NHEE (YDGEOMETRY, YDCPG_BNDS, YDCPG_OPTS, YDVARS, YDCPG_DYN0, YDCPG_DYN9, YDMODEL&
  &, YDHGRAD, Z_OROGLL_T0, Z_OROGMM_T0, Z_OROGLM_T0, Z_GDW_T0, Z_GWHT_T0, YDCPG_TND)
  
ELSEIF (YDMODEL%YRML_DYN%YRDYNA%LNHHY) THEN
  
  CALL CPG_GP_NHHY (YDGEOMETRY, YDCPG_BNDS, YDCPG_OPTS, YDVARS, YDCPG_DYN0, YDCPG_DYN9&
  &, YDMODEL, Z_OROGLL_T0, Z_OROGMM_T0, Z_OROGLM_T0, Z_GDW_T0, Z_GWHT_T0, YDCPG_TND)
  
ELSEIF (YDMODEL%YRML_DYN%YRDYNA%LSACC) THEN
  
  CALL CPG_GP_SACC (YDGEOMETRY, YDCPG_BNDS, YDCPG_OPTS, YDVARS, YDCPG_DYN0, YDCPG_DYN9, YDMODEL, YDPGTERM&
  &%PHI0H, YDPGTERM%PHI0FL, YDPGTERM%PHI0FM, Z_GWHT_T0, YDPGTERM%RT0L, YDPGTERM%RT0M, YDCPG_TND)
  
ELSE
  CALL CPG_GP_HYD (YDGEOMETRY, YDCPG_BNDS, YDCPG_OPTS, YDVARS, YDCPG_DYN0, YDCPG_DYN9,&
  & YDMODEL, Z_OROGLL_T0, Z_OROGMM_T0, Z_OROGLM_T0, Z_GDW_T0, Z_GWHT_T0, YDCPG_TND)
ENDIF

CALL CPG_GP_GPINISLB_PART1_EXPL (YDCPG_BNDS, YDCPG_DYN9,&
& YDCPG_MISC, YDCPG_OPTS, YDGEOMETRY, YDMODEL, YDVARS)
CALL GPINISLB_PART2_EXPL (YDMODEL%YRML_DYN%YRDYN, YDMODEL&
&%YRML_DYN%YRDYNA, YDCPG_BNDS, YDCPG_OPTS, YDVARS)
CALL CPG_GP_GPINISLB_PART3_EXPL (YDCPG_BNDS, YDCPG_DYN0,&
& YDCPG_SL2, YDGEOMETRY, YDMODEL, Z_GDW_T0, Z_GWHT_T0)

IF (YDMODEL%YRML_DYN%YRDYN%NCURRENT_ITER==0) THEN

  IF (YDCPG_OPTS%LDIAB.OR.YDMODEL%YRML_PHY_MF%YRSIMPHL%LSIMPH) THEN

    IF (YDMODEL%YRML_DYN%YRDYNA%LTWOTL) THEN
      CALL CPG_GP_SET1TO0 (YDCPG_BNDS, YDCPG_OPTS, YDMF_PHYS_SURF)
    ELSE
      CALL CPG_GP_SET1TO9 (YDCPG_BNDS, YDCPG_OPTS, YDMF_PHYS_SURF)
    ENDIF

  ENDIF

ENDIF


IF (YDCPG_OPTS%LSFORC) THEN
  

  IF (YDMODEL%YRML_DYN%YRDYN%NCURRENT_ITER>0.AND.YDMODEL%YRML_DYN%YRDYNA%LPC_FULL) THEN
    CALL ABOR1 ('CPG_GP: part 5')
  ENDIF


  IF (YDMODEL%YRML_GCONF%YGFL%YQ%MP/=YDMODEL%YRML_GCONF%YGFL%YQ%MP1) THEN
    CALL ABOR1 ('CPG_GP: CP_FORCING NEEDS DOUBLE CHECK ON Q POINTER. REK')
  ENDIF

  CALL CP_FORCING (YDGEOMETRY, YDMODEL, YDCPG_OPTS, YDCPG_BNDS, YDCPG_DYN0, YDCPG_TND, YDVARS, YDDDH)
  
ENDIF




IF (LHOOK) CALL DR_HOOK ('CPG_GP', 1, ZHOOK_HANDLE)
ENDSUBROUTINE CPG_GP
