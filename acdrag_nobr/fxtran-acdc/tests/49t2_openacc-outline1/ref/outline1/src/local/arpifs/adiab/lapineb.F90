SUBROUTINE LAPINEB (YDMODEL, YDGEOMETRY, YDCPG_OPTS, YDCPG_BNDS, YDSL, LDSLPHY, YDCPG_GMV9, YDCPG_GMV9_SI&
&, YDCPG_GMV9_NL, YDCPG_GFL9, YDA_KNOWENO, YDA_KL0, YDA_KLH0, YDA_PLSCAW, YDA_PRSCAW, YDA_KL0H&
&, YDA_PLSCAWH, YDA_PRSCAWH, YDA_PUF, YDA_PVF, YDCPG_SL1, YDA_PSCO, YDA_PCCO, YDCPG_SL2, YDVARS&
&, YDA_PGFLPC, YDCPG_DDH_TND, YDA_PUP9, YDA_PVP9, YDA_PTP9, YDCPG_GFLP9)
USE TYPE_MODEL,ONLY:MODEL
USE GEOMETRY_MOD,ONLY:GEOMETRY
USE YOMGMV,ONLY:TGMV
USE PARKIND1,ONLY:JPIM, JPRB
USE YOMCST,ONLY:TCST
USE YOMHOOK,ONLY:DR_HOOK, JPHOOK, LHOOK
USE EINT_MOD,ONLY:SL_STRUCT
USE FIELD_VARIABLES_MOD,ONLY:FIELD_VARIABLES
USE CPG_SL1_TYPE_MOD,ONLY:CPG_SL1F_TYPE
USE CPG_SL2_TYPE_MOD,ONLY:CPG_SL2_TYPE
USE CPG_DDH_TND_TYPE_MOD,ONLY:CPG_DDH_TND_TYPE
USE CPG_GMV_TYPE_MOD,ONLY:CPG_GMV_TYPE
USE CPG_GFL_TYPE_MOD,ONLY:CPG_GFL_TYPE, CPG_GFLSL_TYPE
USE CPG_OPTS_TYPE_MOD,ONLY:CPG_OPTS_TYPE, CPG_BNDS_TYPE
USE FIELD_ARRAY_MODULE,ONLY:FIELD_3IM_ARRAY, FIELD_4IM_ARRAY, FIELD_3RB_ARRAY, FIELD_4RB_ARRAY

IMPLICIT NONE


TYPE (MODEL), INTENT (IN)::YDMODEL
TYPE (GEOMETRY), INTENT (IN)::YDGEOMETRY
TYPE (CPG_OPTS_TYPE), INTENT (IN)::YDCPG_OPTS
TYPE (CPG_BNDS_TYPE), INTENT (IN)::YDCPG_BNDS
TYPE (SL_STRUCT), INTENT (IN)::YDSL
LOGICAL, INTENT (IN)::LDSLPHY
TYPE (CPG_GMV_TYPE), INTENT (INOUT)::YDCPG_GMV9
TYPE (CPG_GMV_TYPE), INTENT (INOUT)::YDCPG_GMV9_SI
TYPE (CPG_GMV_TYPE), INTENT (INOUT)::YDCPG_GMV9_NL
TYPE (CPG_GFL_TYPE), INTENT (INOUT)::YDCPG_GFL9
TYPE (FIELD_3IM_ARRAY), INTENT (IN)::YDA_KNOWENO
TYPE (FIELD_4IM_ARRAY), INTENT (IN)::YDA_KL0
TYPE (FIELD_4IM_ARRAY), INTENT (IN)::YDA_KLH0
TYPE (FIELD_4RB_ARRAY), INTENT (IN)::YDA_PLSCAW
TYPE (FIELD_4RB_ARRAY), INTENT (IN)::YDA_PRSCAW
TYPE (FIELD_4IM_ARRAY), INTENT (IN)::YDA_KL0H
TYPE (FIELD_4RB_ARRAY), INTENT (IN)::YDA_PLSCAWH
TYPE (FIELD_4RB_ARRAY), INTENT (IN)::YDA_PRSCAWH
TYPE (FIELD_3RB_ARRAY), INTENT (IN)::YDA_PUF
TYPE (FIELD_3RB_ARRAY), INTENT (IN)::YDA_PVF
TYPE (CPG_SL1F_TYPE), INTENT (IN)::YDCPG_SL1
TYPE (FIELD_4RB_ARRAY), INTENT (IN)::YDA_PSCO
TYPE (FIELD_4RB_ARRAY), INTENT (IN)::YDA_PCCO
TYPE (CPG_SL2_TYPE), INTENT (IN)::YDCPG_SL2
TYPE (FIELD_VARIABLES), INTENT (INOUT)::YDVARS
TYPE (FIELD_4RB_ARRAY), INTENT (IN)::YDA_PGFLPC
TYPE (CPG_DDH_TND_TYPE), INTENT (INOUT)::YDCPG_DDH_TND
TYPE (FIELD_3RB_ARRAY), INTENT (IN)::YDA_PUP9
TYPE (FIELD_3RB_ARRAY), INTENT (IN)::YDA_PVP9
TYPE (FIELD_3RB_ARRAY), INTENT (IN)::YDA_PTP9
TYPE (CPG_GFLSL_TYPE), INTENT (INOUT)::YDCPG_GFLP9
INTEGER (KIND=JPIM)::IVDVAR
INTEGER (KIND=JPIM)::IHVIO
INTEGER (KIND=JPIM)::JFLD
INTEGER (KIND=JPIM)::JGFL
INTEGER (KIND=JPIM)::JROF
INTEGER (KIND=JPIM)::JLEV
LOGICAL::LL2TLFFO
LOGICAL::LLUPDATE_NHX
LOGICAL::LLDER

LOGICAL::LLNHEE
REAL (KIND=JPRB)::ZVT1 (YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB)::ZUT1 (YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB)::ZVZ9 (YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB)::ZUZ9 (YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB)::ZSPTO (YDGEOMETRY%YRDIM%NPROMA)
REAL (KIND=JPRB)::ZSPT1 (YDGEOMETRY%YRDIM%NPROMA, 0:YDGEOMETRY%YRDIMV%NFLEVG+1)
REAL (KIND=JPRB)::ZDP9 (YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB)::ZC9 (YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB)::ZC9_SI (YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB)::ZC9_NL (YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB)::ZUP9 (YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB)::ZVP9 (YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB)::ZOROGL_SR (YDGEOMETRY%YRDIM%NPROMA)
REAL (KIND=JPRB)::ZOROGM_SR (YDGEOMETRY%YRDIM%NPROMA)
REAL (KIND=JPRB)::ZUST1 (YDGEOMETRY%YRDIM%NPROMA)
REAL (KIND=JPRB)::ZVST1 (YDGEOMETRY%YRDIM%NPROMA)
REAL (KIND=JPRB)::ZVWVT1 (YDGEOMETRY%YRDIM%NPROMA, 1:YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB)::ZVWVT0 (YDGEOMETRY%YRDIM%NPROMA, 0:YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB)::ZVWVT1S (YDGEOMETRY%YRDIM%NPROMA)
REAL (KIND=JPRB)::ZSVDT1 (YDGEOMETRY%YRDIM%NPROMA, 1:YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB)::ZNHYT0 (YDGEOMETRY%YRDIM%NPROMA, 0:YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB)::ZDBBC9 (YDGEOMETRY%YRDIM%NPROMA)
REAL (KIND=JPRB)::ZDPHI9 (YDGEOMETRY%YRDIM%NPROMA)
REAL (KIND=JPRB)::ZGWS9 (YDGEOMETRY%YRDIM%NPROMA)
REAL (KIND=JPRB)::ZGMDTX (YDGEOMETRY%YRDIM%NPROMA)
REAL (KIND=JPRB)::ZGMDTY (YDGEOMETRY%YRDIM%NPROMA)
REAL (KIND=JPRB)::ZINEZV (YDGEOMETRY%YRDIM%NPROMA)


REAL (KIND=JPRB)::ZVWEI (YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB)::ZR1 (YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB)::ZRT1 (YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB)::ZP (YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB)::ZQ (YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB)::ZCOPHI
REAL (KIND=JPRB)::ZDEPI
REAL (KIND=JPRB)::ZDGUN
REAL (KIND=JPRB)::ZDGUX
REAL (KIND=JPRB)::ZDLUN
REAL (KIND=JPRB)::ZDLUX
REAL (KIND=JPRB)::ZDSTRET
REAL (KIND=JPRB)::ZPHI
REAL (KIND=JPRB)::ZPP


REAL (KIND=JPRB)::ZQQ


REAL (KIND=JPRB)::ZSINX
REAL (KIND=JPRB)::ZTXO
REAL (KIND=JPRB)::ZTYO
REAL (KIND=JPRB)::ZCMSLP
REAL (KIND=JPRB)::ZTAUD_NL
#include "abor1.intfb.h"
#include "lapineb_lrdbbc.intfb.h"
#include "lapineb_rotuvgeo_2.intfb.h"
#include "lapineb_larche.intfb.h"
#include "lapineb_lacone.intfb.h"
#include "lapineb_l_rdry_vd.intfb.h"
#include "lapineb_ycvgq.intfb.h"
#include "lapineb_cvgq.intfb.h"
#include "lapineb_dpdeta0.intfb.h"
#include "lapineb_temp_eq.intfb.h"
#include "lapineb_rotuv.intfb.h"
#include "lapineb_nvlag3.intfb.h"
#include "lapineb_nvlag2.intfb.h"
#include "lapineb_zvwei.intfb.h"
#include "lapineb_lrplane.intfb.h"
#include "lapineb_rotuvgeo_1.intfb.h"
#include "lapineb_zero_uv9.intfb.h"
#include "lapineb_zero_gmv9_sl.intfb.h"
#include "lapineb_zero_gmv9_si.intfb.h"
#include "lapineb_zero_gmv9.intfb.h"
#include "elarche.intfb.h"
#include "gnhgw2svd.intfb.h"
#include "gpuvs.intfb.h"
#include "gprcp_expl.intfb.h"


#include "larcinb.intfb.h"
#include "larcinhb.intfb.h"
#include "verdisint.intfb.h"

#include "rotuv.intfb.h"

REAL (KIND=JPHOOK)::ZHOOK_HANDLE
IF (LHOOK) CALL DR_HOOK ('LAPINEB', 0, ZHOOK_HANDLE)


LLUPDATE_NHX=YDMODEL%YRML_DYN%YRDYNA%LNHX.AND.(YDMODEL%YRML_DYN%YRDYNA%NVDVAR==4.OR.YDMODEL%YRML_DYN&
&%YRDYNA%NVDVAR==5).AND.(.NOT.YDMODEL%YRML_DYN%YRDYNA%LGWADV.OR.(YDMODEL%YRML_DYN%YRDYNA%ND4SYS&
&==2.AND.YDMODEL%YRML_DYN%YRDYN%NCURRENT_ITER<YDMODEL%YRML_DYN%YRDYN%NSITER))
ZDEPI=2.0_JPRB*YDMODEL%YRCST%RPI
ZDSTRET=2.0_JPRB*YDGEOMETRY%YRGEM%RSTRET

DO JFLD=1, SIZE (YDCPG_GMV9%GMV)
  CALL LAPINEB_ZERO_GMV9 (JFLD, YDCPG_GMV9)
ENDDO


IF (YDMODEL%YRML_DYN%YRDYNA%LSLINL) THEN

  DO JFLD=1, SIZE (YDCPG_GMV9_SI%GMV)
    CALL LAPINEB_ZERO_GMV9_SI (JFLD, YDCPG_GMV9_SI)
  ENDDO

ENDIF


IF (YDMODEL%YRML_DYN%YRDYNA%LPC_CHEAP.AND.YDMODEL%YRML_DYN%YRDYNA%LSETTLS) THEN

  DO JFLD=1, SIZE (YDCPG_GMV9_NL%GMV)
    CALL LAPINEB_ZERO_GMV9_SL (JFLD, YDCPG_GMV9_NL)
  ENDDO

ENDIF


IF (LDSLPHY) THEN
  CALL LAPINEB_ZERO_UV9 (YDGEOMETRY, ZUP9, ZVP9)
ENDIF

CALL LAPINEB_ROTUVGEO_1 (YDA_PCCO, YDCPG_BNDS, YDGEOMETRY, YDMODEL, YDVARS, ZP, ZQ)
IHVIO=0

DO JGFL=1, YDMODEL%YRML_GCONF%YGFL%NUMFLDS

  IF (YDMODEL%YRML_GCONF%YGFL%YCOMP(JGFL)%CSLINT=='LAIHVT      '.OR.YDMODEL%YRML_GCONF%YGFL%YCOMP(JGFL&
    &)%CSLINT=='LAIHVTQM    '.OR.YDMODEL%YRML_GCONF%YGFL%YCOMP(JGFL)%CSLINT=='LAIHVTQMH   ') THEN
    IHVIO=1
  ENDIF

ENDDO

LL2TLFFO=YDMODEL%YRML_DYN%YRDYN%L2TLFF.AND.(YDMODEL%YRML_PHY_MF%YRPHY%LMPHYS.OR.YDMODEL&
&%YRML_PHY_EC%YREPHY%LEPHYS).AND.(.NOT.YDMODEL%YRML_PHY_EC%YREPHY%LAGPHY)

IF (YDCPG_OPTS%LRPLANE) THEN
  ZDLUN=REAL (YDSL%NDLUNG, JPRB)
  ZDLUX=REAL (YDSL%NDLUXG, JPRB)
  ZDGUN=REAL (YDSL%NDGUNG, JPRB)
  ZDGUX=REAL (YDSL%NDGUXG, JPRB)
  CALL LAPINEB_LRPLANE (YDA_PCCO, YDA_PSCO, YDCPG_BNDS, YDGEOMETRY, YDMODEL&
  &, YDVARS, ZDGUN, ZDGUX, ZDLUN, ZDLUX, ZGMDTX, ZGMDTY, ZINEZV)
ENDIF

CALL LAPINEB_ZVWEI (YDCPG_BNDS, YDGEOMETRY, ZVWEI)

IF (.NOT.(YDMODEL%YRML_DYN%YRDYNA%LPC_CHEAP.AND.(YDMODEL%YRML_DYN%YRDYN%NCURRENT_ITER>0))) THEN
  CALL LARCINB (YDGEOMETRY, YDVARS, YDMODEL%YRML_DIAG%YRLDDH, YDMODEL%YRML_DIAG%YRMDDH, YDMODEL&
  &%YRML_GCONF, YDMODEL%YRML_DYN, YDCPG_OPTS, YDCPG_BNDS, YDSL%NASLB1, IHVIO, LDSLPHY, LL2TLFFO&
  &, YDA_KL0%P, YDA_KLH0%P, YDA_PLSCAW%P, YDA_PRSCAW%P, YDCPG_SL1, YDA_KNOWENO%P, YDCPG_DDH_TND&
  &, YDCPG_GMV9, YDCPG_GMV9_SI, YDCPG_GMV9_NL, YDCPG_GFL9, ZDP9, ZC9, ZC9_SI, ZC9_NL, ZUZ9&
  &, ZVZ9, ZUP9, ZVP9, YDA_PTP9%P, YDCPG_GFLP9, ZDBBC9, ZDPHI9, ZGWS9)

  IF (YDMODEL%YRML_DYN%YRDYNA%LNHDYN.AND.YDMODEL%YRML_DYN%YRDYNA%LGWADV&
    &.AND.(.NOT.YDGEOMETRY%YRVERT_GEOM%YRCVER%LVFE_GW)) THEN
    
    CALL LARCINHB (YDGEOMETRY, YDMODEL%YRML_DYN, YDCPG_OPTS, YDCPG_BNDS, YDSL%NASLB1, YDA_KL0H&
    &%P, YDA_PLSCAWH%P, YDA_PRSCAWH%P, YDCPG_SL1, YDCPG_GMV9%SVD%P, YDCPG_GMV9_NL%SVD%P)
    
  ENDIF

ENDIF


IF (YDMODEL%YRML_DYN%YRDYNA%LPC_CHEAP.AND.(YDMODEL%YRML_DYN%YRDYN%NCURRENT_ITER==0)) THEN
  
  YDVARS%PCF_U%PC_PH=0._JPRB
  YDVARS%PCF_V%PC_PH=0._JPRB

  IF (YDMODEL%YRML_DYN%YRDYN%LRHS_CURV) THEN

    DO JLEV=1, YDGEOMETRY%YRDIMV%NFLEVG

      DO JROF=YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA
        YDVARS%PCF_U%PC_PH (JROF, JLEV)=YDCPG_GMV9%U%P (JROF, JLEV)
        YDVARS%PCF_V%PC_PH (JROF, JLEV)=YDCPG_GMV9%V%P (JROF, JLEV)

        IF (LDSLPHY) THEN
          YDVARS%PCF_UP%PC_PH (JROF, JLEV)=ZUP9 (JROF, JLEV)
          YDVARS%PCF_VP%PC_PH (JROF, JLEV)=ZVP9 (JROF, JLEV)
        ENDIF

      ENDDO

    ENDDO

  ELSE
    CALL ROTUV (YDGEOMETRY%YRDIMV%NFLEVG, YDGEOMETRY%YRDIM%NPROMA, YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA,&
    & YDCPG_GMV9%U%P, YDCPG_GMV9%V%P, ZP, ZQ, YDVARS%PCF_U%PC_PH, YDVARS%PCF_V%PC_PH, LDIR=.FALSE.)

    IF (LDSLPHY) THEN
      CALL ROTUV (YDGEOMETRY%YRDIMV%NFLEVG, YDGEOMETRY%YRDIM%NPROMA, YDCPG_BNDS%KIDIA, YDCPG_BNDS&
      &%KFDIA, ZUP9, ZVP9, ZP, ZQ, YDVARS%PCF_U%PC_PH, YDVARS%PCF_V%PC_PH, LDIR=.FALSE.)
    ENDIF

  ENDIF


  DO JLEV=1, YDGEOMETRY%YRDIMV%NFLEVG

    DO JROF=YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA
      YDVARS%PCF_T%PC_PH (JROF, JLEV)=YDCPG_GMV9%T%P (JROF, JLEV)
    ENDDO

  ENDDO


  IF (LDSLPHY) THEN

    DO JLEV=1, YDGEOMETRY%YRDIMV%NFLEVG

      DO JROF=YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA
        YDVARS%PCF_TP%PC_PH (JROF, JLEV)=YDA_PTP9%P (JROF, JLEV)
      ENDDO

    ENDDO

  ENDIF


  IF (YDMODEL%YRML_DYN%YRDYNA%LNHDYN) THEN
    YDVARS%PCF_SPD%PC_PH (YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA, 1:YDGEOMETRY%YRDIMV%NFLEVG)&
    &=YDCPG_GMV9%SPD%P (YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA, 1:YDGEOMETRY%YRDIMV%NFLEVG)
    YDVARS%PCF_SVD%PC_PH (YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA, 1:YDGEOMETRY%YRDIMV%NFLEVG)&
    &=YDCPG_GMV9%SVD%P (YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA, 1:YDGEOMETRY%YRDIMV%NFLEVG)

    IF (LLUPDATE_NHX) THEN
      YDVARS%PCF_NHX%PC_PH (YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA, 1:YDGEOMETRY%YRDIMV%NFLEVG)&
      &=YDCPG_GMV9%NHX%P (YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA, 1:YDGEOMETRY%YRDIMV%NFLEVG)
    ENDIF


    IF (YDMODEL%YRML_DYN%YRDYNA%LRDBBC) THEN
      YDVARS%PCF_BBC%PC_PH (YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA)=ZDBBC9 (YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA)
      YDVARS%PCF_DPHI%PC_PH (YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA)=ZDPHI9 (YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA)
      YDVARS%PCF_GWS%PC_PH (YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA)=ZGWS9 (YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA)
    ENDIF

  ENDIF


  DO JLEV=1, YDGEOMETRY%YRDIMV%NFLEVG

    DO JROF=YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA
      YDVARS%PCF_SP%PC_PH (JROF, JLEV)=ZDP9 (JROF, JLEV)
      YDVARS%PCF_CP%PC_PH (JROF, JLEV)=ZC9 (JROF, JLEV)
    ENDDO

  ENDDO


  IF (LDSLPHY) THEN

    DO JFLD=1, SIZE (YDVARS%GFL_PTR)

      DO JLEV=1, YDGEOMETRY%YRDIMV%NFLEVG

        DO JROF=YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA
          YDVARS%GFL_PTR (JFLD)%PC_PH (JROF, JLEV)=YDCPG_GFLP9%GFL (JFLD)%P (JROF, JLEV)
        ENDDO

      ENDDO

    ENDDO

  ENDIF


  DO JFLD=1, SIZE (YDVARS%GFL_PTR)

    IF ((YDVARS%GFL_PTR (JFLD)%YCOMP%LADV).AND.(YDVARS%GFL_PTR (JFLD)%YCOMP%LPC)) THEN

      DO JLEV=1, YDGEOMETRY%YRDIMV%NFLEVG

        DO JROF=YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA
          YDA_PGFLPC%P (JROF, JLEV, YDVARS%GFL_PTR (JFLD)%YCOMP%MPPC)=YDCPG_GFL9%GFL (JFLD)%P (JROF, JLEV)
        ENDDO

      ENDDO

    ENDIF

  ENDDO

  
ENDIF


IF (YDMODEL%YRML_DYN%YRDYNA%LPC_CHEAP.AND.(YDMODEL%YRML_DYN%YRDYN%NCURRENT_ITER>0)) THEN
  
  YDCPG_GMV9%U%P (YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA, 1:YDGEOMETRY%YRDIMV%NFLEVG)=YDVARS&
  &%PCF_U%PC_PH (YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA, 1:YDGEOMETRY%YRDIMV%NFLEVG)
  YDCPG_GMV9%V%P (YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA, 1:YDGEOMETRY%YRDIMV%NFLEVG)=YDVARS&
  &%PCF_V%PC_PH (YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA, 1:YDGEOMETRY%YRDIMV%NFLEVG)

  IF (LDSLPHY) THEN
    ZUP9 (YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA, 1:YDGEOMETRY%YRDIMV%NFLEVG)=YDVARS%PCF_UP&
    &%PC_PH (YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA, 1:YDGEOMETRY%YRDIMV%NFLEVG)
    ZVP9 (YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA, 1:YDGEOMETRY%YRDIMV%NFLEVG)=YDVARS%PCF_VP&
    &%PC_PH (YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA, 1:YDGEOMETRY%YRDIMV%NFLEVG)
  ENDIF

  YDCPG_GMV9%T%P (YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA, 1:YDGEOMETRY%YRDIMV%NFLEVG)=YDVARS&
  &%PCF_T%PC_PH (YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA, 1:YDGEOMETRY%YRDIMV%NFLEVG)

  IF (LDSLPHY) THEN
    YDA_PTP9%P (YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA, 1:YDGEOMETRY%YRDIMV%NFLEVG)=YDVARS&
    &%PCF_TP%PC_PH (YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA, 1:YDGEOMETRY%YRDIMV%NFLEVG)
  ENDIF


  IF (YDMODEL%YRML_DYN%YRDYNA%LNHDYN) THEN
    YDCPG_GMV9%SPD%P (YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA, 1:YDGEOMETRY%YRDIMV%NFLEVG)=YDVARS&
    &%PCF_SPD%PC_PH (YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA, 1:YDGEOMETRY%YRDIMV%NFLEVG)
    YDCPG_GMV9%SVD%P (YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA, 1:YDGEOMETRY%YRDIMV%NFLEVG)=YDVARS&
    &%PCF_SVD%PC_PH (YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA, 1:YDGEOMETRY%YRDIMV%NFLEVG)

    IF (LLUPDATE_NHX) THEN
      YDCPG_GMV9%NHX%P (YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA, 1:YDGEOMETRY%YRDIMV%NFLEVG)=YDVARS&
      &%PCF_NHX%PC_PH (YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA, 1:YDGEOMETRY%YRDIMV%NFLEVG)
    ENDIF


    IF (YDMODEL%YRML_DYN%YRDYNA%LRDBBC) THEN
      ZDBBC9 (YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA)=YDVARS%PCF_BBC%PC_PH (YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA)
      ZDPHI9 (YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA)=YDVARS%PCF_DPHI%PC_PH (YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA)
      ZGWS9 (YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA)=YDVARS%PCF_GWS%PC_PH (YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA)
    ENDIF

  ENDIF

  ZDP9 (YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA, 1:YDGEOMETRY%YRDIMV%NFLEVG)=YDVARS%PCF_SP&
  &%PC_PH (YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA, 1:YDGEOMETRY%YRDIMV%NFLEVG)
  ZC9 (YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA, 1:YDGEOMETRY%YRDIMV%NFLEVG)=YDVARS%PCF_CP&
  &%PC_PH (YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA, 1:YDGEOMETRY%YRDIMV%NFLEVG)

  IF (LDSLPHY) THEN

    DO JFLD=1, SIZE (YDVARS%GFL_PTR)

      DO JLEV=1, YDGEOMETRY%YRDIMV%NFLEVG

        DO JROF=YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA
          YDCPG_GFLP9%GFL (JFLD)%P (JROF, JLEV)=YDVARS%GFL_PTR (JFLD)%PC_PH (JROF, JLEV)
        ENDDO

      ENDDO

    ENDDO

  ENDIF


  DO JFLD=1, SIZE (YDVARS%GFL_PTR)

    IF ((YDVARS%GFL_PTR (JFLD)%YCOMP%LADV).AND.(YDVARS%GFL_PTR (JFLD)%YCOMP%LPC)) THEN

      DO JLEV=1, YDGEOMETRY%YRDIMV%NFLEVG

        DO JROF=YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA
          YDCPG_GFL9%GFL (JFLD)%P (JROF, JLEV)=YDA_PGFLPC%P (JROF, JLEV, YDVARS%GFL_PTR (JFLD)%YCOMP%MPPC)
        ENDDO

      ENDDO

    ENDIF

  ENDDO

  
ENDIF


IF (YDMODEL%YRML_DYN%YRDYNA%LPC_CHEAP.AND.YDMODEL%YRML_DYN%YRDYNA&
  &%LSETTLS.AND.(YDMODEL%YRML_DYN%YRDYN%NCURRENT_ITER==0)) THEN
  

  DO JLEV=1, YDGEOMETRY%YRDIMV%NFLEVG

    DO JROF=YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA
      ZC9 (JROF, JLEV)=ZC9 (JROF, JLEV)+ZC9_NL (JROF, JLEV)
    ENDDO

  ENDDO

  
ENDIF


IF (YDMODEL%YRML_DYN%YRDYN%NVLAG==2) THEN

  IF (YDGEOMETRY%YRVERT_GEOM%YRCVER%LVERTFE) THEN
    CALL ABOR1 (' LAPINEB 2.2.1: LVERTFE=.T. NOT CODED WITH NVLAG == 2')
  ELSE
    CALL LAPINEB_NVLAG2 (YDCPG_BNDS, YDGEOMETRY, YDVARS, ZC9, ZDP9, ZVWEI)
  ENDIF

ELSEIF (YDMODEL%YRML_DYN%YRDYN%NVLAG==3) THEN
  CALL LAPINEB_NVLAG3 (YDCPG_BNDS, YDCPG_SL2, YDGEOMETRY, YDMODEL&
  &, YDVARS, ZC9, ZC9_SI, ZDP9, ZSPT1, ZSPTO, ZVWEI)
ENDIF


IF (YDMODEL%YRML_DYN%YRDYNA%LPC_CHEAP.AND.YDMODEL%YRML_DYN%YRDYNA&
  &%LSETTLS.AND.(YDMODEL%YRML_DYN%YRDYN%NCURRENT_ITER==0)) THEN
  

  DO JFLD=1, SIZE (YDCPG_GMV9%GMV)

    DO JLEV=1, YDGEOMETRY%YRDIMV%NFLEVG

      DO JROF=YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA
        YDCPG_GMV9%GMV (JFLD)%P (JROF, JLEV)=YDCPG_GMV9%GMV (JFLD)&
        &%P (JROF, JLEV)+YDCPG_GMV9_NL%GMV (JFLD)%P (JROF, JLEV)
      ENDDO

    ENDDO

  ENDDO

  
ENDIF


IF ((YDMODEL%YRML_DYN%YRDYNA%LPC_CHEAP.AND.(YDMODEL%YRML_DYN%YRDYN&
  &%NCURRENT_ITER>0)).OR.YDMODEL%YRML_DYN%YRDYN%LRHS_CURV) THEN
  

  DO JLEV=1, YDGEOMETRY%YRDIMV%NFLEVG

    DO JROF=YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA
      YDVARS%U%T1 (JROF, JLEV)=YDVARS%U%T1 (JROF, JLEV)+YDCPG_GMV9%U%P (JROF, JLEV)
      YDVARS%V%T1 (JROF, JLEV)=YDVARS%V%T1 (JROF, JLEV)+YDCPG_GMV9%V%P (JROF, JLEV)
    ENDDO

  ENDDO


  IF (LDSLPHY) THEN
    YDA_PUP9%P (YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA, 1:YDGEOMETRY%YRDIMV%NFLEVG&
    &)=ZUP9 (YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA, 1:YDGEOMETRY%YRDIMV%NFLEVG)
    YDA_PVP9%P (YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA, 1:YDGEOMETRY%YRDIMV%NFLEVG&
    &)=ZVP9 (YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA, 1:YDGEOMETRY%YRDIMV%NFLEVG)
  ENDIF

  
ELSE
  CALL LAPINEB_ROTUV (LDSLPHY, YDA_PUP9, YDA_PVP9, YDCPG_BNDS, YDCPG_GMV9, YDCPG_GMV9_SI&
  &, YDCPG_SL2, YDGEOMETRY, YDMODEL, YDVARS, ZP, ZQ, ZUP9, ZVP9)
ENDIF

CALL LAPINEB_TEMP_EQ (YDCPG_BNDS, YDCPG_GMV9, YDCPG_GMV9_SI, YDCPG_SL2, YDGEOMETRY, YDMODEL, YDVARS)

DO JFLD=1, SIZE (YDVARS%GFL_PTR)

  IF (YDMODEL%YRML_DYN%YRDYNA%LSLDIA.AND.(YDVARS%GFL_PTR (JFLD)%YCOMP%CNAME&
    &=='DPDETA0         ').AND.YDVARS%GFL_PTR (JFLD)%YCOMP%LGP) THEN
    ZCMSLP=YDMODEL%YRML_DYN%YRDYN%RCMSLP0/(YDMODEL%YRCST%RD*YDCPG_OPTS%RTSUR)
    CALL LAPINEB_DPDETA0 (JFLD, YDCPG_BNDS, YDGEOMETRY, YDVARS, ZCMSLP, ZDP9)
  ENDIF


  IF (YDVARS%GFL_PTR (JFLD)%YCOMP%LADV) THEN
    CALL LAPINEB_CVGQ (JFLD, YDCPG_BNDS, YDCPG_GFL9, YDGEOMETRY, YDVARS)
  ENDIF

ENDDO


IF (YDMODEL%YRML_GCONF%YGFL%YCVGQ%LSP) THEN
  CALL LAPINEB_YCVGQ (YDCPG_BNDS, YDGEOMETRY, YDVARS)
ENDIF


IF (YDMODEL%YRML_DYN%YRDYNA%LNHDYN) THEN
  

  DO JLEV=1, YDGEOMETRY%YRDIMV%NFLEVG

    DO JROF=YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA
      YDVARS%SPD%T1 (JROF, JLEV)=YDVARS%SPD%T1 (JROF, JLEV)+YDCPG_GMV9%SPD%P (JROF, JLEV)
    ENDDO

  ENDDO


  IF (YDMODEL%YRML_DYN%YRDYNA%LSLINL.AND.YDMODEL%YRML_DYN%YRDYNA%NGWADVSI&
    &==1.AND.YDMODEL%YRML_DYN%YRDYN%NCURRENT_ITER==0) THEN

    DO JLEV=1, YDGEOMETRY%YRDIMV%NFLEVG

      DO JROF=YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA
        YDCPG_SL2%PDSI (JROF, JLEV)=YDCPG_SL2%PDSI (JROF, JLEV)+YDCPG_GMV9_SI%SPD%P (JROF, JLEV)
      ENDDO

    ENDDO

  ENDIF

  
ENDIF


IF (YDMODEL%YRML_DYN%YRDYNA%LNHDYN) THEN
  

  DO JLEV=1, YDGEOMETRY%YRDIMV%NFLEVG

    DO JROF=YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA
      YDVARS%SVD%T1 (JROF, JLEV)=YDVARS%SVD%T1 (JROF, JLEV)+YDCPG_GMV9%SVD%P (JROF, JLEV)
    ENDDO

  ENDDO


  IF (LLUPDATE_NHX) THEN

    DO JLEV=1, YDGEOMETRY%YRDIMV%NFLEVG

      DO JROF=YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA
        YDVARS%NHX%T1 (JROF, JLEV)=YDVARS%NHX%T1 (JROF, JLEV)+YDCPG_GMV9%NHX%P (JROF, JLEV)
      ENDDO

    ENDDO

  ENDIF


  IF (YDMODEL%YRML_DYN%YRDYNA%LSLINL.AND.YDMODEL%YRML_DYN%YRDYNA%NGWADVSI&
    &==1.AND.YDMODEL%YRML_DYN%YRDYN%NCURRENT_ITER==0) THEN

    DO JLEV=1, YDGEOMETRY%YRDIMV%NFLEVG

      DO JROF=YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA
        YDCPG_SL2%VDSI (JROF, JLEV)=YDCPG_SL2%VDSI (JROF, JLEV)+YDCPG_GMV9_SI%SVD%P (JROF, JLEV)
      ENDDO

    ENDDO

  ENDIF

  
ENDIF


IF (YDMODEL%YRML_DYN%YRDYNA%L_RDRY_VD) THEN
  CALL LAPINEB_L_RDRY_VD (YDCPG_BNDS, YDGEOMETRY, YDMODEL, YDVARS, ZRT1)
ELSE
  
  CALL GPRCP_EXPL (YDMODEL%YRCST, YDCPG_BNDS, YDCPG_OPTS, PR=ZR1, YDVARS=YDVARS, KGFLTYP=1)

  DO JLEV=1, YDGEOMETRY%YRDIMV%NFLEVG

    DO JROF=YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA
      ZRT1 (JROF, JLEV)=ZR1 (JROF, JLEV)*YDVARS%T%T1 (JROF, JLEV)
    ENDDO

  ENDDO

  
ENDIF


IF (YDMODEL%YRML_DYN%YRDYN%LADVF.AND..NOT.(YDMODEL%YRML_DYN%YRDYNA&
  &%LPC_CHEAP.AND.YDMODEL%YRML_DYN%YRDYN%NCURRENT_ITER>0)) THEN
  CALL LAPINEB_LACONE (YDA_PCCO, YDCPG_BNDS, YDCPG_GMV9, YDCPG_OPTS&
  &, YDGEOMETRY, YDMODEL, YDVARS, ZDSTRET, ZP, ZQ)
ENDIF


IF (YDMODEL%YRML_DYN%YRDYN%L2TLFF.AND..NOT.(YDMODEL%YRML_DYN%YRDYNA&
  &%LPC_CHEAP.AND.(YDMODEL%YRML_DYN%YRDYN%NCURRENT_ITER>0))) THEN

  IF (YDCPG_OPTS%LRPLANE) THEN
    

    DO JLEV=1, YDGEOMETRY%YRDIMV%NFLEVG

      DO JROF=YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA
        ZUT1 (JROF, JLEV)=(1.0_JPRB-YDMODEL%YRML_DYN%YRDYN%RW2TLFF)*YDA_PUF%P (JROF, JLEV)+YDMODEL&
        &%YRML_DYN%YRDYN%RW2TLFF*0.5_JPRB*(YDVARS%U%T1 (JROF, JLEV)+ZUZ9 (JROF, JLEV))
        ZVT1 (JROF, JLEV)=(1.0_JPRB-YDMODEL%YRML_DYN%YRDYN%RW2TLFF)*YDA_PVF%P (JROF, JLEV)+YDMODEL&
        &%YRML_DYN%YRDYN%RW2TLFF*0.5_JPRB*(YDVARS%V%T1 (JROF, JLEV)+ZVZ9 (JROF, JLEV))
        ZTXO=YDVARS%GEOMETRY%RINDX%P (JROF)-2.0_JPRB*ZUT1 (JROF, JLEV)*ZGMDTX (JROF)
        ZTYO=YDVARS%GEOMETRY%RINDY%P (JROF)-2.0_JPRB*ZVT1 (JROF, JLEV)*ZGMDTY (JROF)
        YDA_PCCO%P (JROF, JLEV, YDMODEL%YRML_DYN%YYTCCO%M_RLON)=ZTXO*ZINEZV&
        & (JROF)+YDVARS%GEOMETRY%RINDX%P (JROF)*(1.0_JPRB-ZINEZV (JROF))
        YDA_PCCO%P (JROF, JLEV, YDMODEL%YRML_DYN%YYTCCO%M_RLAT)=ZTYO*ZINEZV&
        & (JROF)+YDVARS%GEOMETRY%RINDY%P (JROF)*(1.0_JPRB-ZINEZV (JROF))
        ZTXO=MIN (MAX (ZTXO, ZDLUN), ZDLUX)
        ZTYO=MIN (MAX (ZTYO, ZDGUN), ZDGUX)
        YDA_PSCO%P (JROF, JLEV, YDMODEL%YRML_DYN%YYTSCO%M_COSCO)=ZTXO*ZINEZV&
        & (JROF)+YDVARS%GEOMETRY%RINDX%P (JROF)*(1.0_JPRB-ZINEZV (JROF))
        YDA_PSCO%P (JROF, JLEV, YDMODEL%YRML_DYN%YYTSCO%M_SINCO)=ZTYO*ZINEZV&
        & (JROF)+YDVARS%GEOMETRY%RINDY%P (JROF)*(1.0_JPRB-ZINEZV (JROF))
      ENDDO

    ENDDO

    CALL ROTUV (YDGEOMETRY%YRDIMV%NFLEVG, YDGEOMETRY%YRDIM%NPROMA, YDCPG_BNDS&
    &%KIDIA, YDCPG_BNDS%KFDIA, YDCPG_GMV9%U%P, YDCPG_GMV9%V%P, ZP, ZQ, YDVARS&
    &%U%T1, YDVARS%V%T1, LDIR=.FALSE., LDADD=.TRUE., LDSUB=.TRUE.)
    CALL ELARCHE (YDMODEL%YRCST, YDMODEL%YRML_DYN, YDGEOMETRY%YRDIM%NPROMA, YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA&
    &, YDGEOMETRY%YRDIMV%NFLEVG, YDSL, YDGEOMETRY%YREGSL, YDGEOMETRY%YREGEO, YDA_PSCO%P, YDA_PCCO%P, YDVARS&
    &%GEOMETRY%GECLO%P, YDVARS%GEOMETRY%GEMU%P, YDVARS%GEOMETRY%GESLO%P, YDVARS%GEOMETRY%GSQM2%P)
    YDCPG_GMV9%U%P (YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA, 1:YDGEOMETRY%YRDIMV%NFLEVG)=YDA_PCCO%P (YDCPG_BNDS&
    &%KIDIA:YDCPG_BNDS%KFDIA, 1:YDGEOMETRY%YRDIMV%NFLEVG, YDMODEL%YRML_DYN%YYTCCO%M_RLON)
    YDCPG_GMV9%V%P (YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA, 1:YDGEOMETRY%YRDIMV%NFLEVG)=YDA_PCCO%P (YDCPG_BNDS&
    &%KIDIA:YDCPG_BNDS%KFDIA, 1:YDGEOMETRY%YRDIMV%NFLEVG, YDMODEL%YRML_DYN%YYTCCO%M_RLAT)
    
  ELSE
    CALL LAPINEB_LARCHE (YDA_PCCO, YDA_PSCO, YDCPG_BNDS, YDCPG_GMV9, YDCPG_OPTS, YDGEOMETRY&
    &, YDMODEL, YDVARS, ZDEPI, ZDSTRET, ZP, ZQ, ZUT1, ZUZ9, ZVT1, ZVZ9)
  ENDIF

  CALL LAPINEB_ROTUVGEO_2 (YDA_PCCO, YDCPG_BNDS, YDCPG_GMV9, YDGEOMETRY, YDMODEL, YDVARS)
ENDIF


IF (YDMODEL%YRML_DYN%YRDYNA%LGWADV.OR.YDMODEL%YRML_DYN%YRDYNA%LRDBBC) THEN
  
  LLDER=.FALSE.
  CALL GPUVS (YDGEOMETRY%YRDIMV%NFLEVG, YDGEOMETRY%YRDIM%NPROMA, YDCPG_BNDS%KIDIA&
  &, YDCPG_BNDS%KFDIA, LLDER, YDVARS%U%T1, YDVARS%V%T1, ZUST1, ZVST1)
  ZOROGL_SR (YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA)=YDVARS%GEOMETRY%GM%P (YDCPG_BNDS%KIDIA&
  &:YDCPG_BNDS%KFDIA)*YDVARS%GEOMETRY%OROGL%P (YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA)
  ZOROGM_SR (YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA)=YDVARS%GEOMETRY%GM%P (YDCPG_BNDS%KIDIA&
  &:YDCPG_BNDS%KFDIA)*YDVARS%GEOMETRY%OROGM%P (YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA)
  
ENDIF


IF (YDMODEL%YRML_DYN%YRDYNA%LGWADV) THEN
  

  IF (YDMODEL%YRML_DYN%YRDYNA%NVDVAR==4.OR.YDMODEL%YRML_DYN%YRDYNA%NVDVAR==5) THEN
    IVDVAR=3
  ELSE
    IVDVAR=YDMODEL%YRML_DYN%YRDYNA%NVDVAR
  ENDIF


  IF (YDMODEL%YRML_DYN%YRDYNA%LNHHY) THEN
    ZTAUD_NL=YDMODEL%YRML_DYN%YRDYNA%RNHHY_TAUD_NL
  ELSE
    ZTAUD_NL=1.0_JPRB
  ENDIF

  LLNHEE=YDMODEL%YRML_DYN%YRDYNA%LNHEE.OR.(YDMODEL%YRML_DYN%YRDYNA%LNHHY&
  &.AND..NOT.YDMODEL%YRML_DYN%YRDYNA%LNHHY_SOLVER_HY).OR.(YDMODEL%YRML_DYN&
  &%YRDYNA%LNHQE.AND..NOT.YDMODEL%YRML_DYN%YRDYNA%LNHQE_SOLVER_QE)

  IF (YDGEOMETRY%YRVERT_GEOM%YRCVER%LVERTFE.AND.YDGEOMETRY%YRVERT_GEOM%YRCVER%LVFE_GW) THEN
    ZVWVT1 (YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA, 1:YDGEOMETRY%YRDIMV%NFLEVG)=YDVARS&
    &%SVD%T1 (YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA, 1:YDGEOMETRY%YRDIMV%NFLEVG)
    ZVWVT1S (YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA)=ZUST1 (YDCPG_BNDS%KIDIA:YDCPG_BNDS&
    &%KFDIA)*ZOROGL_SR (YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA)+ZVST1 (YDCPG_BNDS%KIDIA&
    &:YDCPG_BNDS%KFDIA)*ZOROGM_SR (YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA)
    CALL GNHGW2SVD (YDGEOMETRY, YDMODEL%YRCST, YDCPG_OPTS%TOPPRES, YDCPG_BNDS%KIDIA&
    &, YDCPG_BNDS%KFDIA, YDMODEL%YRML_DYN%YRDYNA%LNHEE, YDMODEL%YRML_DYN%YRDYNA%NPDVAR&
    &, IVDVAR, YDVARS%SP%T1, ZRT1, YDVARS%SPD%T1, ZSVDT1, PGWF=ZVWVT1, PGWS=ZVWVT1S&
    &, PGWRF=YDCPG_SL2%GWF, PGWRS=YDCPG_SL2%GWS, PGDWR=YDCPG_SL2%GDW)
  ELSE
    ZVWVT0 (YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA, 0:YDGEOMETRY%YRDIMV%NFLEVG-1)=YDVARS&
    &%SVD%T1 (YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA, 1:YDGEOMETRY%YRDIMV%NFLEVG)
    ZVWVT0 (YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA, YDGEOMETRY%YRDIMV%NFLEVG)=ZUST1 (YDCPG_BNDS&
    &%KIDIA:YDCPG_BNDS%KFDIA)*ZOROGL_SR (YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA)+ZVST1 (YDCPG_BNDS&
    &%KIDIA:YDCPG_BNDS%KFDIA)*ZOROGM_SR (YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA)

    IF (YDMODEL%YRML_DYN%YRDYN%LGWFRIC) THEN
      CALL GNHGW2SVD (YDGEOMETRY, YDMODEL%YRCST, YDCPG_OPTS%TOPPRES, YDCPG_BNDS%KIDIA, YDCPG_BNDS&
      &%KFDIA, LLNHEE, YDMODEL%YRML_DYN%YRDYNA%NPDVAR, IVDVAR, YDVARS%SP%T1, ZRT1, YDVARS%SPD%T1&
      &, ZSVDT1, PGWH=ZVWVT0, PGWDAMP=YDMODEL%YRML_DYN%YRDYN%RGWFRIC, PTAUD_NL=ZTAUD_NL)
    ELSE
      CALL GNHGW2SVD (YDGEOMETRY, YDMODEL%YRCST, YDCPG_OPTS%TOPPRES, YDCPG_BNDS%KIDIA&
      &, YDCPG_BNDS%KFDIA, LLNHEE, YDMODEL%YRML_DYN%YRDYNA%NPDVAR, IVDVAR, YDVARS&
      &%SP%T1, ZRT1, YDVARS%SPD%T1, ZSVDT1, PGWH=ZVWVT0, PTAUD_NL=ZTAUD_NL)
    ENDIF

  ENDIF

  YDVARS%SVD%T1 (YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA, 1:YDGEOMETRY%YRDIMV%NFLEVG&
  &)=ZSVDT1 (YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA, 1:YDGEOMETRY%YRDIMV%NFLEVG)
  
ENDIF


IF (YDMODEL%YRML_DYN%YRDYNA%LRDBBC) THEN
  CALL LAPINEB_LRDBBC (YDCPG_BNDS, YDCPG_SL2, YDGEOMETRY, YDVARS,&
  & ZDBBC9, ZDPHI9, ZGWS9, ZOROGL_SR, ZOROGM_SR, ZUST1, ZVST1)
ENDIF


IF (YDMODEL%YRML_DYN%YRDYNA%LNHDYN.AND.YDMODEL%YRML_DYN%YRDYNA%LGWADV.AND.YDMODEL&
  &%YRML_DYN%YRDYNA%NGWADVSI==2.AND.YDMODEL%YRML_DYN%YRDYN%NCURRENT_ITER==0) THEN
  

  IF (YDMODEL%YRML_DYN%YRDYN%NVLAG==3.AND.YDMODEL%YRML_DYN%YRDYNA%LSLINLC2) THEN

    IF (YDGEOMETRY%YRVERT_GEOM%YRCVER%LVERTFE) THEN

      DO JLEV=1, YDGEOMETRY%YRDIMV%NFLEVG
        ZSPT1 (YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA, JLEV)=ZVWEI (YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA, JLEV)*YDGEOMETRY&
        &%YRVERT_GEOM%YRVETA%VFE_RDETAH (JLEV)*ZC9_SI (YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA, JLEV)
      ENDDO

      ZSPT1 (YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA, 0)=0.0_JPRB
      ZSPT1 (YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA, YDGEOMETRY%YRDIMV%NFLEVG+1)=0.0_JPRB
      CALL VERDISINT (YDGEOMETRY%YRVERT_GEOM%YRVFE, YDGEOMETRY%YRVERT_GEOM%YRCVER,'ITOP','11', YDGEOMETRY&
      &%YRDIM%NPROMA, YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA, YDGEOMETRY%YRDIMV%NFLEVG, ZSPT1, POUTS=ZSPTO)
      YDVARS%SP%T1 (YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA)=YDVARS%SP%T1 (YDCPG_BNDS&
      &%KIDIA:YDCPG_BNDS%KFDIA)+ZSPTO (YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA)
    ELSE

      DO JLEV=1, YDGEOMETRY%YRDIMV%NFLEVG

        DO JROF=YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA
          YDVARS%SP%T1 (JROF)=YDVARS%SP%T1 (JROF)+ZVWEI (JROF, JLEV)*ZC9_SI (JROF, JLEV)
        ENDDO

      ENDDO

    ENDIF

  ENDIF


  IF (YDMODEL%YRML_DYN%YRDYNA%LSLINL) THEN
    CALL ROTUV (YDGEOMETRY%YRDIMV%NFLEVG, YDGEOMETRY%YRDIM%NPROMA, YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA, YDCPG_GMV9_SI&
    &%U%P, YDCPG_GMV9_SI%V%P, ZP, ZQ, YDVARS%U%T1, YDVARS%V%T1, LDIR=.FALSE., LDADD=.TRUE.)
  ENDIF


  IF (YDMODEL%YRML_DYN%YRDYNA%LSLINL) THEN

    DO JLEV=1, YDGEOMETRY%YRDIMV%NFLEVG

      DO JROF=YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA
        YDVARS%T%T1 (JROF, JLEV)=YDVARS%T%T1 (JROF, JLEV)+YDCPG_GMV9_SI%T%P (JROF, JLEV)
        YDVARS%SVD%T1 (JROF, JLEV)=YDVARS%SVD%T1 (JROF, JLEV)+YDCPG_GMV9_SI%SVD%P (JROF, JLEV)
      ENDDO

    ENDDO

  ENDIF


  IF (YDMODEL%YRML_DYN%YRDYNA%LSLINL.AND.YDMODEL%YRML_DYN%YRDYNA%LNHDYN) THEN

    DO JLEV=1, YDGEOMETRY%YRDIMV%NFLEVG

      DO JROF=YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA
        YDVARS%SPD%T1 (JROF, JLEV)=YDVARS%SPD%T1 (JROF, JLEV)+YDCPG_GMV9_SI%SPD%P (JROF, JLEV)
      ENDDO

    ENDDO

  ENDIF

  
ENDIF



IF (LHOOK) CALL DR_HOOK ('LAPINEB', 1, ZHOOK_HANDLE)
ENDSUBROUTINE LAPINEB
