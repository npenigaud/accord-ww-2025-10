SUBROUTINE CPGLAG (YDGEOMETRY, YDCPG_BNDS, YDCPG_OPTS, YDCPG_SL2, YDCPG_DDH_TNDHD,&
& YDMODEL, YDVARS, LDCONFX, YDDDH, YDA_PGPSTRESS, YDTDDH, PTRAJEC, PTRAJEC_OOPS)
USE MODEL_DIAGNOSTICS_MOD,ONLY:MODEL_DIAGNOSTICS_TYPE
USE MODEL_GENERAL_CONF_MOD,ONLY:MODEL_GENERAL_CONF_TYPE
USE MODEL_DYNAMICS_MOD,ONLY:MODEL_DYNAMICS_TYPE
USE GEOMETRY_MOD,ONLY:GEOMETRY
USE YOMGMV,ONLY:TGMV
USE PARKIND1,ONLY:JPIM, JPRB
USE YOMHOOK,ONLY:LHOOK, DR_HOOK, JPHOOK
USE YOMTRAJ,ONLY:TRAJ_TYPE, LPRTTRAJ, LTRAJSAVE, LTRAJSLAG
USE YOMTRAJ_OOPS,ONLY:TRAJ_TYPE_OOPS, LTRAJSAVE_OOPS, LTRAJSLAG_OOPS
USE YOMLUN,ONLY:NULOUT
USE DDH_MIX,ONLY:TYP_DDH
USE FIELD_VARIABLES_MOD,ONLY:FIELD_VARIABLES
USE TYPE_MODEL,ONLY:MODEL
USE CPG_OPTS_TYPE_MOD,ONLY:CPG_BNDS_TYPE, CPG_OPTS_TYPE
USE CPG_SL2_TYPE_MOD,ONLY:CPG_SL2_TYPE
USE CPG_DDH_TND_TYPE_MOD,ONLY:CPG_TNDHD_DDH_TYPE
USE FIELD_ARRAY_MODULE,ONLY:FIELD_4RB_ARRAY
USE YOMTDDH,ONLY:TTDDH

IMPLICIT NONE


TYPE (GEOMETRY), INTENT (IN)::YDGEOMETRY
TYPE (MODEL), INTENT (IN)::YDMODEL
TYPE (FIELD_VARIABLES), INTENT (INOUT)::YDVARS
TYPE (CPG_BNDS_TYPE), INTENT (IN)::YDCPG_BNDS
TYPE (CPG_OPTS_TYPE), INTENT (IN)::YDCPG_OPTS
TYPE (CPG_SL2_TYPE), INTENT (IN)::YDCPG_SL2
TYPE (CPG_TNDHD_DDH_TYPE), INTENT (INOUT)::YDCPG_DDH_TNDHD
LOGICAL, INTENT (IN)::LDCONFX
TYPE (TYP_DDH), INTENT (INOUT)::YDDDH
TYPE (FIELD_4RB_ARRAY), INTENT (IN)::YDA_PGPSTRESS
TYPE (TTDDH), INTENT (INOUT)::YDTDDH
TYPE (TRAJ_TYPE), INTENT (INOUT), OPTIONAL::PTRAJEC
TYPE (TRAJ_TYPE_OOPS), INTENT (INOUT), OPTIONAL::PTRAJEC_OOPS


LOGICAL::LL_DIAG_NHX
LOGICAL::LLTF1
LOGICAL::LLSTR
LOGICAL::LLLSTEP
REAL (KIND=JPRB)::ZEPS
REAL (KIND=JPRB)::ZOROGL_SR (YDGEOMETRY%YRDIM%NPROMA)
REAL (KIND=JPRB)::ZOROGM_SR (YDGEOMETRY%YRDIM%NPROMA)
REAL (KIND=JPRB)::ZGMVNHXT1B (YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB)::ZR1 (YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB)::ZGMVSVDT1A (YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB)::ZGMVSVDT1B (YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB)::ZRD_R
#include "gnhx.intfb.h"
#include "cpglag_str.intfb.h"
#include "cpglag_outline_001.intfb.h"
#include "cpglag_outline_000.intfb.h"
#include "gnhqe_svd.intfb.h"
#include "gprcp_expl.intfb.h"
#include "gptf1_ydvars.intfb.h"
#include "cpdyddhlag.intfb.h"
REAL (KIND=JPHOOK)::ZHOOK_HANDLE
IF (LHOOK) CALL DR_HOOK ('CPGLAG', 0, ZHOOK_HANDLE)


LL_DIAG_NHX=(YDMODEL%YRML_DYN%YRDYNA%ND4SYS==0.OR.YDMODEL%YRML_DYN%YRDYNA%ND4SYS==3)

IF (YDMODEL%YRML_DYN%YRDYNA%LNHDYN.AND.YDMODEL%YRML_DYN%YRDYNA%LSLAG.AND.(YDMODEL%YRML_DYN%YRDYNA%NVDVAR&
  &==4.OR.YDMODEL%YRML_DYN%YRDYNA%NVDVAR==5).AND.(YDMODEL%YRML_DYN%YRDYNA%ND4SYS==2.OR.LL_DIAG_NHX).AND&
  &.(YDMODEL%YRML_DYN%YRDYN%NCURRENT_ITER==YDMODEL%YRML_DYN%YRDYN%NSITER.OR.LL_DIAG_NHX)) THEN
  
  ZOROGL_SR (YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA)=YDVARS%GEOMETRY%GM%P (YDCPG_BNDS%KIDIA&
  &:YDCPG_BNDS%KFDIA)*YDVARS%GEOMETRY%OROGL%P (YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA)
  ZOROGM_SR (YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA)=YDVARS%GEOMETRY%GM%P (YDCPG_BNDS%KIDIA&
  &:YDCPG_BNDS%KFDIA)*YDVARS%GEOMETRY%OROGM%P (YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA)

  IF (YDMODEL%YRML_DYN%YRDYNA%LNHEE.OR.YDMODEL%YRML_DYN%YRDYNA%LNHHY) THEN

    IF (YDMODEL%YRML_DYN%YRDYNA%LNHHY) THEN
      CALL GNHX (YDGEOMETRY, YDMODEL%YRML_DYN%YRDYNA, YDGEOMETRY%YRDIM%NPROMA, YDCPG_BNDS%KIDIA, YDCPG_BNDS&
      &%KFDIA, YDVARS%GEOMETRY%OROG%P, ZOROGL_SR, ZOROGM_SR, YDVARS%SP%T1, YDVARS%SP%DL, YDVARS%SP&
      &%DM, YDVARS%T%T1, YDVARS%T%DL, YDVARS%T%DM, YDVARS%Q%T1, YDVARS%Q%DL, YDVARS%Q%DM, YDVARS%L&
      &%T1, YDVARS%L%DL, YDVARS%L%DM, YDVARS%I%T1, YDVARS%I%DL, YDVARS%I%DM, YDVARS%R%T1, YDVARS%S&
      &%T1, YDVARS%G%T1, YDVARS%U%T1, YDVARS%V%T1, ZGMVNHXT1B, PEPS_NL=YDMODEL%YRML_DYN%YRDYN%RNHHY_EPS_NL&
      &, PSPD=YDVARS%SPD%T1, PSPDL=YDVARS%SPD%DL, PSPDM=YDVARS%SPD%DM)
    ELSE
      CALL GNHX (YDGEOMETRY, YDMODEL%YRML_DYN%YRDYNA, YDGEOMETRY%YRDIM%NPROMA, YDCPG_BNDS%KIDIA, YDCPG_BNDS&
      &%KFDIA, YDVARS%GEOMETRY%OROG%P, ZOROGL_SR, ZOROGM_SR, YDVARS%SP%T1, YDVARS%SP%DL, YDVARS%SP%DM, YDVARS&
      &%T%T1, YDVARS%T%DL, YDVARS%T%DM, YDVARS%Q%T1, YDVARS%Q%DL, YDVARS%Q%DM, YDVARS%L%T1, YDVARS%L%DL, YDVARS&
      &%L%DM, YDVARS%I%T1, YDVARS%I%DL, YDVARS%I%DM, YDVARS%R%T1, YDVARS%S%T1, YDVARS%G%T1, YDVARS%U%T1, YDVARS&
      &%V%T1, ZGMVNHXT1B, PSPD=YDVARS%SPD%T1, PSPDL=YDVARS%SPD%DL, PSPDM=YDVARS%SPD%DM)
    ENDIF


    IF (LL_DIAG_NHX) THEN
      YDVARS%SVD%T1 (YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA, 1:YDGEOMETRY%YRDIMV%NFLEVG)=YDVARS&
      &%SVD%T1 (YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA, 1:YDGEOMETRY%YRDIMV%NFLEVG)+ZGMVNHXT1B&
      & (YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA, 1:YDGEOMETRY%YRDIMV%NFLEVG)
    ELSE

      IF (YDMODEL%YRML_DYN%YRDYNA%LTWOTL) THEN

        IF (YDMODEL%YRML_DYN%YRDYN%NSITER==0) THEN
          YDVARS%SVD%T1 (YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA, 1:YDGEOMETRY%YRDIMV%NFLEVG)=YDVARS&
          &%SVD%T1 (YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA, 1:YDGEOMETRY%YRDIMV%NFLEVG)+ZGMVNHXT1B&
          & (YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA, 1:YDGEOMETRY%YRDIMV%NFLEVG)-YDVARS%NHX%T0&
          & (YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA, 1:YDGEOMETRY%YRDIMV%NFLEVG)
        ELSE
          YDVARS%SVD%T1 (YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA, 1:YDGEOMETRY%YRDIMV%NFLEVG)=YDVARS&
          &%SVD%T1 (YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA, 1:YDGEOMETRY%YRDIMV%NFLEVG)+ZGMVNHXT1B&
          & (YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA, 1:YDGEOMETRY%YRDIMV%NFLEVG)-YDVARS%NHX%T9&
          & (YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA, 1:YDGEOMETRY%YRDIMV%NFLEVG)
        ENDIF

      ELSE
        YDVARS%SVD%T1 (YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA, 1:YDGEOMETRY%YRDIMV%NFLEVG)=YDVARS&
        &%SVD%T1 (YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA, 1:YDGEOMETRY%YRDIMV%NFLEVG)+ZGMVNHXT1B&
        & (YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA, 1:YDGEOMETRY%YRDIMV%NFLEVG)-YDVARS%NHX%T9&
        & (YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA, 1:YDGEOMETRY%YRDIMV%NFLEVG)
      ENDIF

    ENDIF

  ELSEIF (YDMODEL%YRML_DYN%YRDYNA%LNHQE) THEN
    CALL GNHX (YDGEOMETRY, YDMODEL%YRML_DYN%YRDYNA, YDGEOMETRY%YRDIM%NPROMA, YDCPG_BNDS%KIDIA, YDCPG_BNDS&
    &%KFDIA, YDVARS%GEOMETRY%OROG%P, ZOROGL_SR, ZOROGM_SR, YDVARS%SP%T1, YDVARS%SP%DL, YDVARS%SP%DM, YDVARS&
    &%T%T1, YDVARS%T%DL, YDVARS%T%DM, YDVARS%Q%T1, YDVARS%Q%DL, YDVARS%Q%DM, YDVARS%L%T1, YDVARS%L%DL, YDVARS&
    &%L%DM, YDVARS%I%T1, YDVARS%I%DL, YDVARS%I%DM, YDVARS%R%T1, YDVARS%S%T1, YDVARS%G%T1, YDVARS%U%T1, YDVARS&
    &%V%T1, ZGMVNHXT1B, PSPD=YDVARS%SPD%T1, PSPDL=YDVARS%SPD%DL, PSPDM=YDVARS%SPD%DM)

    IF (.NOT.YDMODEL%YRML_DYN%YRDYNA%LNHQE_SOLVER_QE) THEN
      YDVARS%SVD%T1 (YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA, 1:YDGEOMETRY%YRDIMV%NFLEVG)=YDVARS&
      &%SVD%T1 (YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA, 1:YDGEOMETRY%YRDIMV%NFLEVG)+ZGMVNHXT1B&
      & (YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA, 1:YDGEOMETRY%YRDIMV%NFLEVG)
    ELSE
      ZGMVSVDT1A (YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA, 1:YDGEOMETRY%YRDIMV%NFLEVG)=YDVARS&
      &%SVD%T1 (YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA, 1:YDGEOMETRY%YRDIMV%NFLEVG)+ZGMVNHXT1B&
      & (YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA, 1:YDGEOMETRY%YRDIMV%NFLEVG)
      CALL GNHQE_SVD (YDGEOMETRY, YDGEOMETRY%YRDIM%NPROMA, YDCPG_BNDS%KIDIA,&
      & YDCPG_BNDS%KFDIA, YDVARS%SP%T1, YDVARS%Q%T1, YDVARS%L%T1, YDVARS%I%T1&
      &, YDVARS%R%T1, YDVARS%S%T1, YDVARS%G%T1, ZGMVSVDT1A, ZGMVSVDT1B)
      YDVARS%SVD%T1 (YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA, 1:YDGEOMETRY%YRDIMV%NFLEVG)=ZGMVSVDT1B&
      & (YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA, 1:YDGEOMETRY%YRDIMV%NFLEVG)
    ENDIF

  ENDIF

  YDVARS%NHX%T1 (YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA, 1:YDGEOMETRY%YRDIMV%NFLEVG)=ZGMVNHXT1B&
  & (YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA, 1:YDGEOMETRY%YRDIMV%NFLEVG)
  
ENDIF


IF ((YDMODEL%YRML_DYN%YRDYNA%LPC_FULL.AND.YDMODEL%YRML_DYN%YRDYN%NCURRENT_ITER==YDMODEL&
  &%YRML_DYN%YRDYN%NSITER).OR..NOT.YDMODEL%YRML_DYN%YRDYNA%LPC_FULL) THEN

  IF (YDMODEL%YRML_DYN%YRDYN%LGPSTRESS) THEN
    
    YDVARS%U%T1 (YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA, 1:YDGEOMETRY%YRDIMV%NFLEVG)=YDVARS&
    &%U%T1 (YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA, 1:YDGEOMETRY%YRDIMV%NFLEVG)+YDA_PGPSTRESS&
    &%P (YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA, 1:YDGEOMETRY%YRDIMV%NFLEVG, 1)
    YDVARS%V%T1 (YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA, 1:YDGEOMETRY%YRDIMV%NFLEVG)=YDVARS&
    &%V%T1 (YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA, 1:YDGEOMETRY%YRDIMV%NFLEVG)+YDA_PGPSTRESS&
    &%P (YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA, 1:YDGEOMETRY%YRDIMV%NFLEVG, 2)
    
  ENDIF

ENDIF


IF (YDCPG_OPTS%NSTEP<YDMODEL%YRML_GCONF%YRRIP%NSTOP) THEN
  LLLSTEP=.FALSE.
ELSE
  LLLSTEP=.TRUE.
ENDIF

LLTF1=.FALSE.

IF (YDMODEL%YRML_DYN%YRDYN%NCURRENT_ITER==0) THEN
  LLTF1=.TRUE.
ENDIF

CALL GPTF1_YDVARS (YDGEOMETRY, YDMODEL%YRML_GCONF, YDMODEL%YRML_DYN%YRDYN, YDMODEL&
&%YRML_DYN%YRDYNA, YDVARS, LLTF1, YDCPG_BNDS, YDCPG_OPTS, LLLSTEP)

IF (PRESENT (PTRAJEC)) THEN

  IF (YDMODEL%YRML_DYN%YRDYNA%LSPRT.AND.LTRAJSAVE.AND.LTRAJSLAG) THEN
    
    PTRAJEC%SLAG (YDCPG_BNDS%KBL)%PTT15 (YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA, 1:YDGEOMETRY%YRDIMV&
    &%NFLEVG)=YDVARS%T%T1 (YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA, 1:YDGEOMETRY%YRDIMV%NFLEVG)
    PTRAJEC%SLAG (YDCPG_BNDS%KBL)%PQT15 (YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA, 1:YDGEOMETRY%YRDIMV&
    &%NFLEVG)=YDVARS%Q%T1 (YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA, 1:YDGEOMETRY%YRDIMV%NFLEVG)

    IF (LPRTTRAJ.AND.PTRAJEC%SLAG (YDCPG_BNDS%KBL)%LASTCHUNK)  THEN
      WRITE (NULOUT,*)'GREPTRAJ ADD TRAJEC%SLAG in CPGLAG'
    ENDIF

    
  ENDIF

ELSE

  IF (YDMODEL%YRML_DYN%YRDYNA%LSPRT.AND.LTRAJSAVE_OOPS.AND.LTRAJSLAG_OOPS) THEN
    
    PTRAJEC_OOPS%SLAG (YDCPG_BNDS%KBL)%PTT15 (YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA, 1:YDGEOMETRY%YRDIMV&
    &%NFLEVG)=YDVARS%T%T1 (YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA, 1:YDGEOMETRY%YRDIMV%NFLEVG)
    PTRAJEC_OOPS%SLAG (YDCPG_BNDS%KBL)%PQT15 (YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA, 1:YDGEOMETRY%YRDIMV&
    &%NFLEVG)=YDVARS%Q%T1 (YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA, 1:YDGEOMETRY%YRDIMV%NFLEVG)

    IF (PTRAJEC_OOPS%SLAG (YDCPG_BNDS%KBL)%LASTCHUNK)  THEN
      WRITE (NULOUT,*)'GREPTRAJ ADD TRAJEC%SLAG in CPGLAG'
    ENDIF

    
  ENDIF

ENDIF

CALL CPGLAG_OUTLINE_000 (YDCPG_BNDS, YDCPG_SL2, YDGEOMETRY, YDMODEL, YDVARS)

IF (YDMODEL%YRML_DYN%YRDYNA%LSPRT) THEN
  CALL GPRCP_EXPL (YDMODEL%YRCST, YDCPG_BNDS, YDCPG_OPTS, PR=ZR1, YDVARS=YDVARS, KGFLTYP=1)
  ZRD_R=1.0_JPRB/YDMODEL%YRCST%RD
  CALL CPGLAG_OUTLINE_001 (YDCPG_BNDS, YDGEOMETRY, YDVARS, ZRD_R, ZR1)
ENDIF

ZEPS=100.0_JPRB*TINY (1.0_JPRB)
LLSTR=(ABS (YDGEOMETRY%YRGEM%RSTRET-1.0_JPRB)>ZEPS)

IF (LLSTR) THEN
  CALL CPGLAG_STR (YDCPG_BNDS, YDGEOMETRY, YDVARS)
ENDIF


IF (YDMODEL%YRML_DYN%YRDYNA%LSLAG.AND.YDMODEL%YRML_DIAG%YRLDDH%LRSLDDH.AND.(.NOT.LDCONFX)) THEN
  
  CALL CPDYDDHLAG (YDGEOMETRY, YDCPG_DDH_TNDHD, YDMODEL%YRML_DIAG, YDMODEL%YRML_GCONF&
  &, YDMODEL%YRML_DYN%YRDYNA%LNHDYN, YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA, YDCPG_BNDS&
  &%KSTGLO, YDMODEL%YRML_DYN%YRDYN%NCURRENT_ITER, YDDDH, YDTDDH)
  
ENDIF



IF (LHOOK) CALL DR_HOOK ('CPGLAG', 1, ZHOOK_HANDLE)
ENDSUBROUTINE CPGLAG
