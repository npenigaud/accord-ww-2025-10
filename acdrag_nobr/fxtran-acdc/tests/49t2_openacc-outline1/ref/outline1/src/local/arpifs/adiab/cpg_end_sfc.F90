SUBROUTINE CPG_END_SFC (YDMODEL, YDCPG_OPTS, YDCPG_BNDS, YDMF_PHYS_SURF, KUPTRA)
USE PARKIND1,ONLY:JPIM
USE YOMHOOK,ONLY:DR_HOOK, JPHOOK, LHOOK
USE TYPE_MODEL,ONLY:MODEL
USE CPG_OPTS_TYPE_MOD,ONLY:CPG_OPTS_TYPE, CPG_BNDS_TYPE
USE MF_PHYS_SURFACE_TYPE_MOD,ONLY:MF_PHYS_SURF_TYPE

IMPLICIT NONE


TYPE (MODEL), INTENT (IN)::YDMODEL
TYPE (CPG_OPTS_TYPE), INTENT (IN)::YDCPG_OPTS
TYPE (CPG_BNDS_TYPE), INTENT (IN)::YDCPG_BNDS
TYPE (MF_PHYS_SURF_TYPE), INTENT (INOUT)::YDMF_PHYS_SURF
INTEGER (KIND=JPIM), INTENT (IN)::KUPTRA
REAL (KIND=JPHOOK)::ZHOOK_HANDLE
#include "cpg_end_sfc_set0to1.intfb.h"
#include "cpg_end_sfc_gsp_cl_set0to1.intfb.h"
#include "cpg_end_sfc_phtfilt.intfb.h"
IF (LHOOK) CALL DR_HOOK ('CPG_END_SFC', 0, ZHOOK_HANDLE)

IF ((YDMODEL%YRML_DYN%YRDYN%NCURRENT_ITER==0).AND.YDCPG_OPTS%LDIAB) THEN

  IF (.NOT.YDCPG_OPTS%LCONFX) THEN

    IF (YDMODEL%YRML_DYN%YRDYNA%LTWOTL) THEN
      CALL CPG_END_SFC_SET0TO1 (YDCPG_BNDS, YDCPG_OPTS, YDMF_PHYS_SURF)
    ELSE
      CALL CPG_END_SFC_PHTFILT (YDCPG_BNDS, YDCPG_OPTS, YDMF_PHYS_SURF, YDMODEL)
    ENDIF

  ELSEIF (YDMODEL%YRML_DYN%YRDYNA%LTWOTL.AND.YDMODEL%YRML_PHY_G%YRDPHY%LDIRCLSMOD.AND.(KUPTRA>0)) THEN
    CALL CPG_END_SFC_GSP_CL_SET0TO1 (YDCPG_BNDS, YDCPG_OPTS, YDMF_PHYS_SURF)
  ENDIF

ENDIF

IF (LHOOK) CALL DR_HOOK ('CPG_END_SFC', 1, ZHOOK_HANDLE)
ENDSUBROUTINE CPG_END_SFC
