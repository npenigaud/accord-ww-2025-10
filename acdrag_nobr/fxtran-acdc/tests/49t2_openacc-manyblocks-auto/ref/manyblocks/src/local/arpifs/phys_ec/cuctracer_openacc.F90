SUBROUTINE CUCTRACER_OPENACC (YDCST, YDCUMFS, YDECUMF2, YDECUMF, KIDIA, KFDIA, KLON&
&, KLEV, KTRAC, KCTOP, KDTOP, KTYPE, LDCUM, LDDRAF, PTSPHY, PAPH, PAP, PMFU, PMFD,&
& PMFUO, PMFDO, PUDRATE, PDDRATE, PDMFUP, PDMFDP, PCEN, PTENC, PSCAV, YDSTACK)
!$ACC ROUTINE (CUCTRACER_OPENACC) SEQ
USE PARKIND1,ONLY:JPIM, JPRB

USE YOMCST,ONLY:TCST
USE YOECUMF,ONLY:TECUMF
USE YOECUMF2,ONLY:TECUMF2
USE YOMCUMFS,ONLY:TCUMFS
#include "fxtran_acdc_stack.h"
USE FXTRAN_ACDC_STACK_MOD
USE FXTRAN_ACDC_ABORT_MOD

IMPLICIT NONE


TYPE (TCST), INTENT (IN)::YDCST
TYPE (TCUMFS), INTENT (IN)::YDCUMFS
TYPE (TECUMF), INTENT (IN)::YDECUMF
TYPE (TECUMF2), INTENT (IN)::YDECUMF2
INTEGER (KIND=JPIM), INTENT (IN)::KLON
INTEGER (KIND=JPIM), INTENT (IN)::KLEV
INTEGER (KIND=JPIM), INTENT (IN)::KTRAC
INTEGER (KIND=JPIM), INTENT (IN)::KIDIA
INTEGER (KIND=JPIM), INTENT (IN)::KFDIA
INTEGER (KIND=JPIM), INTENT (IN)::KCTOP 
INTEGER (KIND=JPIM), INTENT (IN)::KDTOP 
INTEGER (KIND=JPIM), INTENT (IN)::KTYPE 
LOGICAL, INTENT (IN)::LDCUM 
LOGICAL, INTENT (IN)::LDDRAF 
REAL (KIND=JPRB), INTENT (IN)::PTSPHY
REAL (KIND=JPRB), INTENT (IN)::PAPH 
REAL (KIND=JPRB), INTENT (IN)::PAP 
REAL (KIND=JPRB), INTENT (IN)::PMFU 
REAL (KIND=JPRB), INTENT (IN)::PMFD 
REAL (KIND=JPRB), INTENT (IN)::PMFUO 
REAL (KIND=JPRB), INTENT (IN)::PMFDO 
REAL (KIND=JPRB), INTENT (IN)::PUDRATE 
REAL (KIND=JPRB), INTENT (IN)::PDDRATE 
REAL (KIND=JPRB), INTENT (IN)::PDMFUP 
REAL (KIND=JPRB), INTENT (IN)::PDMFDP 
REAL (KIND=JPRB), INTENT (IN)::PCEN 
REAL (KIND=JPRB), INTENT (IN)::PSCAV (KTRAC)
TYPE(FXTRAN_ACDC_STACK), INTENT (IN) :: YDSTACK
TYPE(FXTRAN_ACDC_STACK) :: YLSTACK
REAL (KIND=JPRB), INTENT (INOUT)::PTENC 

fxtran_acdc_temp (INTEGER(KIND=JPIM), KCTOP_PTR, (KLON))
fxtran_acdc_temp (INTEGER(KIND=JPIM), KDTOP_PTR, (KLON))
fxtran_acdc_temp (INTEGER(KIND=JPIM), KTYPE_PTR, (KLON))
fxtran_acdc_temp (LOGICAL, LDCUM_PTR, (KLON))
fxtran_acdc_temp (LOGICAL, LDDRAF_PTR, (KLON))
fxtran_acdc_temp (REAL(KIND=JPRB), PAPH_PTR, (KLON, KLEV+1))
fxtran_acdc_temp (REAL(KIND=JPRB), PAP_PTR, (KLON, KLEV))
fxtran_acdc_temp (REAL(KIND=JPRB), PMFU_PTR, (KLON, KLEV))
fxtran_acdc_temp (REAL(KIND=JPRB), PMFD_PTR, (KLON, KLEV))
fxtran_acdc_temp (REAL(KIND=JPRB), PMFUO_PTR, (KLON, KLEV))
fxtran_acdc_temp (REAL(KIND=JPRB), PMFDO_PTR, (KLON, KLEV))
fxtran_acdc_temp (REAL(KIND=JPRB), PUDRATE_PTR, (KLON, KLEV))
fxtran_acdc_temp (REAL(KIND=JPRB), PDDRATE_PTR, (KLON, KLEV))
fxtran_acdc_temp (REAL(KIND=JPRB), PDMFUP_PTR, (KLON, KLEV))
fxtran_acdc_temp (REAL(KIND=JPRB), PDMFDP_PTR, (KLON, KLEV))
fxtran_acdc_temp (REAL(KIND=JPRB), PCEN_PTR, (KLON, KLEV, KTRAC))
fxtran_acdc_temp (REAL(KIND=JPRB), PTENC_PTR, (KLON, KLEV, KTRAC))

INTEGER (KIND=JPIM)::JN
INTEGER (KIND=JPIM)::JL
INTEGER (KIND=JPIM)::JK
INTEGER (KIND=JPIM)::IM
INTEGER (KIND=JPIM)::IK
REAL (KIND=JPRB)::ZADVW 
REAL (KIND=JPRB)::ZC
REAL (KIND=JPRB)::ZTSPHY
REAL (KIND=JPRB)::ZPOSI
REAL (KIND=JPRB)::ZERATE
REAL (KIND=JPRB)::ZIMP
REAL (KIND=JPRB)::ZMFA
REAL (KIND=JPRB)::ZZP
REAL (KIND=JPRB)::ZRMFSOLCT
REAL (KIND=JPRB)::ZRMFCMIN
fxtran_acdc_temp (REAL (KIND=JPRB), ZMFC, (KLON, KLEV, KTRAC))
fxtran_acdc_temp (REAL (KIND=JPRB), ZTENC, (KLON, KLEV, KTRAC))
fxtran_acdc_temp (REAL (KIND=JPRB), ZCD, (KLON, KLEV, KTRAC))
fxtran_acdc_temp (REAL (KIND=JPRB), ZCU, (KLON, KLEV, KTRAC))
fxtran_acdc_temp (REAL (KIND=JPRB), ZCEN, (KLON, KLEV, KTRAC))
fxtran_acdc_temp (REAL (KIND=JPRB), ZR1, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZB, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZDP, (KLON, KLEV))
fxtran_acdc_temp (LOGICAL, LLCUMBAS, (KLON, KLEV))
fxtran_acdc_temp (LOGICAL, LLCUMASK, (KLON, KLEV))

#include "cubidiag.intfb.h"

fxtran_acdc_assoc (KCTOP_PTR, KCTOP)

fxtran_acdc_assoc (KDTOP_PTR, KDTOP)

fxtran_acdc_assoc (KTYPE_PTR, KTYPE)

fxtran_acdc_assoc (LDCUM_PTR, LDCUM)

fxtran_acdc_assoc (LDDRAF_PTR, LDDRAF)

fxtran_acdc_assoc (PAPH_PTR, PAPH)

fxtran_acdc_assoc (PAP_PTR, PAP)

fxtran_acdc_assoc (PMFU_PTR, PMFU)

fxtran_acdc_assoc (PMFD_PTR, PMFD)

fxtran_acdc_assoc (PMFUO_PTR, PMFUO)

fxtran_acdc_assoc (PMFDO_PTR, PMFDO)

fxtran_acdc_assoc (PUDRATE_PTR, PUDRATE)

fxtran_acdc_assoc (PDDRATE_PTR, PDDRATE)

fxtran_acdc_assoc (PDMFUP_PTR, PDMFUP)

fxtran_acdc_assoc (PDMFDP_PTR, PDMFDP)

fxtran_acdc_assoc (PCEN_PTR, PCEN)

fxtran_acdc_assoc (PTENC_PTR, PTENC)

YLSTACK = YDSTACK



IF (KIND (ZMFC) == 8) THEN
    fxtran_acdc_alloc8 (ZMFC)
ELSEIF (KIND (ZMFC) == 4) THEN
    fxtran_acdc_alloc4 (ZMFC)
ELSE
    STOP 1
ENDIF


IF (KIND (ZTENC) == 8) THEN
    fxtran_acdc_alloc8 (ZTENC)
ELSEIF (KIND (ZTENC) == 4) THEN
    fxtran_acdc_alloc4 (ZTENC)
ELSE
    STOP 1
ENDIF


IF (KIND (ZCD) == 8) THEN
    fxtran_acdc_alloc8 (ZCD)
ELSEIF (KIND (ZCD) == 4) THEN
    fxtran_acdc_alloc4 (ZCD)
ELSE
    STOP 1
ENDIF


IF (KIND (ZCU) == 8) THEN
    fxtran_acdc_alloc8 (ZCU)
ELSEIF (KIND (ZCU) == 4) THEN
    fxtran_acdc_alloc4 (ZCU)
ELSE
    STOP 1
ENDIF


IF (KIND (ZCEN) == 8) THEN
    fxtran_acdc_alloc8 (ZCEN)
ELSEIF (KIND (ZCEN) == 4) THEN
    fxtran_acdc_alloc4 (ZCEN)
ELSE
    STOP 1
ENDIF


IF (KIND (ZR1) == 8) THEN
    fxtran_acdc_alloc8 (ZR1)
ELSEIF (KIND (ZR1) == 4) THEN
    fxtran_acdc_alloc4 (ZR1)
ELSE
    STOP 1
ENDIF


IF (KIND (ZB) == 8) THEN
    fxtran_acdc_alloc8 (ZB)
ELSEIF (KIND (ZB) == 4) THEN
    fxtran_acdc_alloc4 (ZB)
ELSE
    STOP 1
ENDIF


IF (KIND (ZDP) == 8) THEN
    fxtran_acdc_alloc8 (ZDP)
ELSEIF (KIND (ZDP) == 4) THEN
    fxtran_acdc_alloc4 (ZDP)
ELSE
    STOP 1
ENDIF


IF (KIND (LLCUMBAS) == 8) THEN
    fxtran_acdc_alloc8 (LLCUMBAS)
ELSEIF (KIND (LLCUMBAS) == 4) THEN
    fxtran_acdc_alloc4 (LLCUMBAS)
ELSE
    STOP 1
ENDIF


IF (KIND (LLCUMASK) == 8) THEN
    fxtran_acdc_alloc8 (LLCUMASK)
ELSEIF (KIND (LLCUMASK) == 4) THEN
    fxtran_acdc_alloc4 (LLCUMASK)
ELSE
    STOP 1
ENDIF


JL = KIDIA





IF (YDCUMFS%LECUMFS) THEN
  ZRMFSOLCT=YDECUMF2%RMFSOLCT2
  ZRMFCMIN=YDECUMF2%RMFCMIN2
ELSE
  ZRMFSOLCT=YDECUMF%RMFSOLCT
  ZRMFCMIN=YDECUMF%RMFCMIN
ENDIF

ZIMP=1.0_JPRB-ZRMFSOLCT
ZTSPHY=1.0_JPRB/PTSPHY

ZADVW =0.0_JPRB

IF (KTYPE_PTR (JL)==1)  THEN
  ZADVW =YDECUMF%RMFADVW
ENDIF



DO JK=2, KLEV
  
  LLCUMASK (JL, JK)=.FALSE.

  IF (LDCUM_PTR (JL)) THEN
    ZDP (JL, JK)=YDCST%RG/(PAPH_PTR (JL, JK+1)-PAPH_PTR (JL, JK))

    IF (JK>=KCTOP_PTR (JL)-1) THEN
      LLCUMASK (JL, JK)=.TRUE.
    ENDIF

  ENDIF

  
ENDDO


DO JN=1, KTRAC

  DO JK=2, KLEV
    IK=JK-1
    
    ZCEN (JL, JK, JN)=PCEN_PTR (JL, JK, JN)
    ZCD (JL, JK, JN)=PCEN_PTR (JL, IK, JN)
    ZCU (JL, JK, JN)=PCEN_PTR (JL, IK, JN)
    ZMFC (JL, JK, JN)=0.0_JPRB
    ZTENC (JL, JK, JN)=0.0_JPRB
  
  ENDDO

  
  ZCU (JL, KLEV, JN)=PCEN_PTR (JL, KLEV, JN)

  

  DO JK=KLEV-1, 3,-1
    IK=JK+1

    

    IF (LLCUMASK (JL, JK)) THEN
      ZERATE=PMFU_PTR (JL, JK)-PMFU_PTR (JL, IK)+PUDRATE_PTR (JL, JK)
      ZMFA=1.0_JPRB/MAX (ZRMFCMIN, PMFU_PTR (JL, JK))

      IF (JK>=KCTOP_PTR (JL)) THEN
        ZCU (JL, JK, JN)=(PMFU_PTR (JL, IK)*ZCU (JL, IK, JN)+ZERATE*PCEN_PTR (JL, JK, JN)&
        &-(PUDRATE_PTR (JL, JK)+PDMFUP_PTR (JL, JK)*PSCAV (JN))*ZCU (JL, IK, JN))*ZMFA
      ENDIF

    ENDIF

  
  ENDDO


  DO JK=3, KLEV
    IK=JK-1

    

    IF (LDDRAF_PTR (JL).AND.JK==KDTOP_PTR (JL)) THEN
      ZCD (JL, JK, JN)=0.1_JPRB*ZCU (JL, JK, JN)+0.9_JPRB*PCEN_PTR (JL, IK, JN)
    ELSEIF (LDDRAF_PTR (JL).AND.JK>KDTOP_PTR (JL)) THEN
      ZERATE=-PMFD_PTR (JL, JK)+PMFD_PTR (JL, IK)+PDDRATE_PTR (JL, JK)
      ZMFA=1._JPRB/MIN (-ZRMFCMIN, PMFD_PTR (JL, JK))
      ZCD (JL, JK, JN)=(PMFD_PTR (JL, IK)*ZCD (JL, IK, JN)-ZERATE*PCEN_PTR (JL, IK, JN)&
      &+(PDDRATE_PTR (JL, JK)+PDMFDP_PTR (JL, JK)*PSCAV (JN))*ZCD (JL, IK, JN))*ZMFA
    ENDIF

  
  ENDDO

  JK=KLEV
  IK=JK-1

  

  IF (LDDRAF_PTR (JL)) THEN
    ZPOSI=-ZDP (JL, JK)*(PMFU_PTR (JL, JK)*ZCU (JL, JK, JN)+PMFD_PTR (JL, JK)*ZCD&
    & (JL, JK, JN)-(PMFU_PTR (JL, JK)+PMFD_PTR (JL, JK))*PCEN_PTR (JL, IK, JN))

    IF (PCEN_PTR (JL, JK, JN)+ZPOSI*PTSPHY<0.0_JPRB) THEN
      ZMFA=1._JPRB/MIN (-ZRMFCMIN, PMFD_PTR (JL, JK))
      ZCD (JL, JK, JN)=((PMFU_PTR (JL, JK)+PMFD_PTR (JL, JK))*PCEN_PTR (JL, IK, JN)-PMFU_PTR&
      & (JL, JK)*ZCU (JL, JK, JN)+PCEN_PTR (JL, JK, JN)/(PTSPHY*ZDP (JL, JK)))*ZMFA
    ENDIF

  ENDIF

  
ENDDO


DO JN=1, KTRAC

  DO JK=2, KLEV
    IK=JK-1

    

    IF (LLCUMASK (JL, JK)) THEN
      ZMFA=PMFU_PTR (JL, JK)+PMFD_PTR (JL, JK)
      ZMFC (JL, JK, JN)=PMFU_PTR (JL, JK)*ZCU (JL, JK, JN)+PMFD_PTR&
      & (JL, JK)*ZCD (JL, JK, JN)-ZIMP*ZMFA*ZCEN (JL, IK, JN)
    ENDIF

  
  ENDDO


  DO JK=2, KLEV-1
    IK=JK+1

    

    IF (LLCUMASK (JL, JK)) THEN
      ZTENC (JL, JK, JN)=ZDP (JL, JK)*(ZMFC (JL, IK, JN)-ZMFC (JL, JK, JN))
    ENDIF

  
  ENDDO

  JK=KLEV

  

  IF (LDCUM_PTR (JL)) THEN
    ZTENC (JL, JK, JN)=-ZDP (JL, JK)*ZMFC (JL, JK, JN)
  ENDIF

  
ENDDO


IF (ZRMFSOLCT==0.0_JPRB) THEN

  DO JN=1, KTRAC

    DO JK=2, KLEV

      

      IF (LLCUMASK (JL, JK)) THEN
        PTENC_PTR (JL, JK, JN)=PTENC_PTR (JL, JK, JN)+ZTENC (JL, JK, JN)
      ENDIF

    
    ENDDO

  ENDDO

ELSE
  LLCUMBAS (JL,:)=.FALSE.
  ZB (JL,:)=1._JPRB

  DO JN=1, KTRAC

    DO JK=2, KLEV
      IK=JK+1
      IM=JK-1
      
      LLCUMBAS (JL, JK)=LLCUMASK (JL, JK)

      IF (LLCUMBAS (JL, JK)) THEN
        ZZP=ZRMFSOLCT*ZDP (JL, JK)*PTSPHY
        ZMFC (JL, JK, JN)=-ZZP*(PMFU_PTR (JL, JK)+PMFD_PTR (JL, JK))

        IF (JK<KLEV) THEN
          ZB (JL, JK)=1.0_JPRB+ZZP*(PMFU_PTR (JL, IK)+PMFD_PTR (JL, IK))
        ELSE
          ZB (JL, JK)=1.0_JPRB
        ENDIF

        ZZP=YDCST%RG*(PMFUO_PTR (JL, JK)+YDECUMF%RMFADVWDD*PMFDO_PTR (JL&
        &, JK))/(PAP_PTR (JL, JK)-PAP_PTR (JL, IM))*PTSPHY*ZADVW 
        ZC=ZZP*(PCEN_PTR (JL, IM, JN)-PCEN_PTR (JL, JK, JN))
        ZTENC (JL, JK, JN)=ZTENC (JL, JK, JN)*PTSPHY+PCEN_PTR (JL, JK, JN)-ZC
      ENDIF

    
    ENDDO

    CALL CUBIDIAG_OPENACC (KIDIA, KFDIA, KLON, KLEV, KCTOP_PTR, LLCUMBAS&
    &, ZMFC (:,:, JN), ZB, ZTENC (:,:, JN), ZR1, YDSTACK=YLSTACK)

    DO JK=2, KLEV

      

      IF (LLCUMBAS (JL, JK)) THEN
        PTENC_PTR (JL, JK, JN)=PTENC_PTR (JL, JK, JN)+(ZR1 (JL, JK)-PCEN_PTR (JL, JK, JN))*ZTSPHY
      ENDIF

    
    ENDDO

  ENDDO

ENDIF



ENDSUBROUTINE CUCTRACER_OPENACC
