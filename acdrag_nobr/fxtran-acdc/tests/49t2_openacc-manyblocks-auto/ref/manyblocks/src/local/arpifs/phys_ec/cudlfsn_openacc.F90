SUBROUTINE CUDLFSN_OPENACC (YDTHF, YDCST, YDEPHLI, YDECUMF, KIDIA, KFDIA, KLON, KLEV&
&, KCBOT, KCTOP, LDCUM, PTENH, PQENH, PTEN, PQSEN, PGEO, PGEOH, PAPH, PTU, PQU, PMFUB&
&, PRFL, PTD, PQD, PMFD, PMFDS, PMFDQ, PDMFDP, KDTOP, LDDRAF, YDSTACK)
!$ACC ROUTINE (CUDLFSN_OPENACC) SEQ
USE PARKIND1,ONLY:JPIM, JPRB

USE YOMCST,ONLY:TCST
USE YOETHF,ONLY:TTHF
USE YOECUMF,ONLY:TECUMF
USE YOEPHLI,ONLY:TEPHLI
#include "fxtran_acdc_stack.h"
USE FXTRAN_ACDC_STACK_MOD
USE FXTRAN_ACDC_ABORT_MOD

IMPLICIT NONE


TYPE (TTHF), INTENT (IN)::YDTHF
TYPE (TCST), INTENT (IN)::YDCST
TYPE (TECUMF), INTENT (IN)::YDECUMF
TYPE (TEPHLI), INTENT (IN)::YDEPHLI
INTEGER (KIND=JPIM), INTENT (IN)::KLON
INTEGER (KIND=JPIM), INTENT (IN)::KLEV
INTEGER (KIND=JPIM), INTENT (IN)::KIDIA
INTEGER (KIND=JPIM), INTENT (IN)::KFDIA
INTEGER (KIND=JPIM), INTENT (IN)::KCBOT 
INTEGER (KIND=JPIM), INTENT (IN)::KCTOP 
LOGICAL, INTENT (IN)::LDCUM 
REAL (KIND=JPRB), INTENT (IN)::PTENH 
REAL (KIND=JPRB), INTENT (IN)::PQENH 
REAL (KIND=JPRB), INTENT (IN)::PTEN 
REAL (KIND=JPRB), INTENT (IN)::PQSEN 
REAL (KIND=JPRB), INTENT (IN)::PGEO 
REAL (KIND=JPRB), INTENT (IN)::PGEOH 
REAL (KIND=JPRB), INTENT (IN)::PAPH 
REAL (KIND=JPRB), INTENT (IN)::PTU 
REAL (KIND=JPRB), INTENT (IN)::PQU 
REAL (KIND=JPRB), INTENT (IN)::PMFUB 
REAL (KIND=JPRB), INTENT (INOUT)::PRFL 
REAL (KIND=JPRB), INTENT (OUT)::PTD 
REAL (KIND=JPRB), INTENT (OUT)::PQD 
REAL (KIND=JPRB), INTENT (INOUT)::PMFD 
REAL (KIND=JPRB), INTENT (OUT)::PMFDS 
REAL (KIND=JPRB), INTENT (OUT)::PMFDQ 
REAL (KIND=JPRB), INTENT (OUT)::PDMFDP 
INTEGER (KIND=JPIM), INTENT (OUT)::KDTOP 
LOGICAL, INTENT (OUT)::LDDRAF 
TYPE(FXTRAN_ACDC_STACK), INTENT (IN) :: YDSTACK

fxtran_acdc_temp (INTEGER(KIND=JPIM), KCBOT_PTR, (KLON))
fxtran_acdc_temp (INTEGER(KIND=JPIM), KCTOP_PTR, (KLON))
fxtran_acdc_temp (LOGICAL, LDCUM_PTR, (KLON))
fxtran_acdc_temp (REAL(KIND=JPRB), PTENH_PTR, (KLON, KLEV))
fxtran_acdc_temp (REAL(KIND=JPRB), PQENH_PTR, (KLON, KLEV))
fxtran_acdc_temp (REAL(KIND=JPRB), PTEN_PTR, (KLON, KLEV))
fxtran_acdc_temp (REAL(KIND=JPRB), PQSEN_PTR, (KLON, KLEV))
fxtran_acdc_temp (REAL(KIND=JPRB), PGEO_PTR, (KLON, KLEV))
fxtran_acdc_temp (REAL(KIND=JPRB), PGEOH_PTR, (KLON, KLEV+1))
fxtran_acdc_temp (REAL(KIND=JPRB), PAPH_PTR, (KLON, KLEV+1))
fxtran_acdc_temp (REAL(KIND=JPRB), PTU_PTR, (KLON, KLEV))
fxtran_acdc_temp (REAL(KIND=JPRB), PQU_PTR, (KLON, KLEV))
fxtran_acdc_temp (REAL(KIND=JPRB), PMFUB_PTR, (KLON))
fxtran_acdc_temp (REAL(KIND=JPRB), PRFL_PTR, (KLON))
fxtran_acdc_temp (REAL(KIND=JPRB), PTD_PTR, (KLON, KLEV))
fxtran_acdc_temp (REAL(KIND=JPRB), PQD_PTR, (KLON, KLEV))
fxtran_acdc_temp (REAL(KIND=JPRB), PMFD_PTR, (KLON, KLEV))
fxtran_acdc_temp (REAL(KIND=JPRB), PMFDS_PTR, (KLON, KLEV))
fxtran_acdc_temp (REAL(KIND=JPRB), PMFDQ_PTR, (KLON, KLEV))
fxtran_acdc_temp (REAL(KIND=JPRB), PDMFDP_PTR, (KLON, KLEV))
fxtran_acdc_temp (INTEGER(KIND=JPIM), KDTOP_PTR, (KLON))
fxtran_acdc_temp (LOGICAL, LDDRAF_PTR, (KLON))

TYPE(FXTRAN_ACDC_STACK) :: YLSTACK
INTEGER (KIND=JPIM)::IKHSMIN 
REAL (KIND=JPRB)::ZHSMIN 
REAL (KIND=JPRB)::ZPH 
REAL (KIND=JPRB)::ZCOND 
fxtran_acdc_temp (REAL (KIND=JPRB), ZQENWB, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZTENWB, (KLON, KLEV))
LOGICAL::LLO2 
INTEGER (KIND=JPIM)::JL
INTEGER (KIND=JPIM)::JK
INTEGER (KIND=JPIM)::IS
INTEGER (KIND=JPIM)::IKE
INTEGER (KIND=JPIM)::IK
REAL (KIND=JPRB)::ZTTEST
REAL (KIND=JPRB)::ZTARG
REAL (KIND=JPRB)::ZQTEST
REAL (KIND=JPRB)::ZOELHM
REAL (KIND=JPRB)::ZOEALFA
REAL (KIND=JPRB)::ZMFTOP
REAL (KIND=JPRB)::ZHSK
REAL (KIND=JPRB)::ZBUO

#include "fcttre.func.h"
REAL (KIND=JPRB)::ZQP
REAL (KIND=JPRB)::ZTARG_CUADJTQ
REAL (KIND=JPRB)::ZQSAT
REAL (KIND=JPRB)::ZQMAX
REAL (KIND=JPRB)::ZOEALFA_CUADJTQ
REAL (KIND=JPRB)::ZFOEEWL
REAL (KIND=JPRB)::ZFOEEWI
REAL (KIND=JPRB)::ZCOR
REAL (KIND=JPRB)::ZCOND1
REAL (KIND=JPRB)::ZCOND_CUADJTQ
REAL (KIND=JPRB)::Z2S
REAL (KIND=JPRB)::Z1S
REAL (KIND=JPRB)::ZF
REAL (KIND=JPRB)::ZI
REAL (KIND=JPRB)::ZL
LOGICAL::LLFLAG 

#include "cuadjtq.func.h"

fxtran_acdc_assoc (KCBOT_PTR, KCBOT)

fxtran_acdc_assoc (KCTOP_PTR, KCTOP)

fxtran_acdc_assoc (LDCUM_PTR, LDCUM)

fxtran_acdc_assoc (PTENH_PTR, PTENH)

fxtran_acdc_assoc (PQENH_PTR, PQENH)

fxtran_acdc_assoc (PTEN_PTR, PTEN)

fxtran_acdc_assoc (PQSEN_PTR, PQSEN)

fxtran_acdc_assoc (PGEO_PTR, PGEO)

fxtran_acdc_assoc (PGEOH_PTR, PGEOH)

fxtran_acdc_assoc (PAPH_PTR, PAPH)

fxtran_acdc_assoc (PTU_PTR, PTU)

fxtran_acdc_assoc (PQU_PTR, PQU)

fxtran_acdc_assoc (PMFUB_PTR, PMFUB)

fxtran_acdc_assoc (PRFL_PTR, PRFL)

fxtran_acdc_assoc (PTD_PTR, PTD)

fxtran_acdc_assoc (PQD_PTR, PQD)

fxtran_acdc_assoc (PMFD_PTR, PMFD)

fxtran_acdc_assoc (PMFDS_PTR, PMFDS)

fxtran_acdc_assoc (PMFDQ_PTR, PMFDQ)

fxtran_acdc_assoc (PDMFDP_PTR, PDMFDP)

fxtran_acdc_assoc (KDTOP_PTR, KDTOP)

fxtran_acdc_assoc (LDDRAF_PTR, LDDRAF)

YLSTACK = YDSTACK



IF (KIND (ZQENWB) == 8) THEN
    fxtran_acdc_alloc8 (ZQENWB)
ELSEIF (KIND (ZQENWB) == 4) THEN
    fxtran_acdc_alloc4 (ZQENWB)
ELSE
    STOP 1
ENDIF


IF (KIND (ZTENWB) == 8) THEN
    fxtran_acdc_alloc8 (ZTENWB)
ELSEIF (KIND (ZTENWB) == 4) THEN
    fxtran_acdc_alloc4 (ZTENWB)
ELSE
    STOP 1
ENDIF


JL = KIDIA




LDDRAF_PTR (JL)=.FALSE.
KDTOP_PTR (JL)=KLEV+1
IKHSMIN =KLEV+1
ZHSMIN =1.E8_JPRB


IF (YDECUMF%LMFDD) THEN

  DO JK=3, KLEV-2

    IF (YDEPHLI%LPHYLIN) THEN
      
      ZTARG=PTEN_PTR (JL, JK)
      ZOEALFA=MIN (1.0_JPRB, 0.545_JPRB*(TANH (0.17_JPRB*(ZTARG-YDEPHLI%RLPTRC))+1.0_JPRB))
      ZOELHM=ZOEALFA*YDCST%RLVTT+(1.0_JPRB-ZOEALFA)*YDCST%RLSTT
      ZHSK=YDCST%RCPD*PTEN_PTR (JL, JK)+PGEO_PTR (JL, JK)+ZOELHM*PQSEN_PTR (JL, JK)

      IF (ZHSK<ZHSMIN ) THEN
        ZHSMIN =ZHSK
        IKHSMIN =JK
      ENDIF

    
    ELSE
      
      ZHSK=YDCST%RCPD*PTEN_PTR (JL, JK)+PGEO_PTR (JL, JK)+FOELHMCU (PTEN_PTR (JL, JK))*PQSEN_PTR (JL, JK)

      IF (ZHSK<ZHSMIN ) THEN
        ZHSMIN =ZHSK
        IKHSMIN =JK
      ENDIF

    
    ENDIF

  ENDDO

  IKE=KLEV-3

  DO JK=3, IKE
    IS=0
    
    ZTENWB (JL, JK)=PTENH_PTR (JL, JK)
    ZQENWB (JL, JK)=PQENH_PTR (JL, JK)
    ZPH =PAPH_PTR (JL, JK)
    LLO2 =LDCUM_PTR (JL).AND.PRFL_PTR (JL)>0.0_JPRB.AND..NOT.LDDRAF_PTR (JL&
    &).AND.(JK<KCBOT_PTR (JL).AND.JK>KCTOP_PTR (JL)).AND.JK>=IKHSMIN 

    IF (LLO2 ) THEN
      IS=IS+1
    ENDIF


    

    IF (IS==0)  THEN
      CYCLE
    ENDIF

    IK=JK
    
    
    ZQMAX=0.5_JPRB

    IF (.NOT.YDEPHLI%LPHYLIN) THEN

      

      

      

      IF (LLO2 ) THEN
        ZQP=1.0_JPRB/ZPH 
        ZQSAT=FOEEWMCU (ZTENWB (JL, IK))*ZQP
        ZQSAT=MIN (0.5_JPRB, ZQSAT)
        ZCOR=1.0_JPRB/(1.0_JPRB-YDCST%RETV*ZQSAT)
        ZQSAT=ZQSAT*ZCOR
        ZCOND_CUADJTQ=(ZQENWB (JL, IK)-ZQSAT)/(1.0_JPRB+ZQSAT*ZCOR*FOEDEMCU (ZTENWB (JL, IK)))
        ZCOND_CUADJTQ=MIN (ZCOND_CUADJTQ, 0.0_JPRB)
        ZTENWB (JL, IK)=ZTENWB (JL, IK)+FOELDCPMCU (ZTENWB (JL, IK))*ZCOND_CUADJTQ
        ZQENWB (JL, IK)=ZQENWB (JL, IK)-ZCOND_CUADJTQ
        ZQSAT=FOEEWMCU (ZTENWB (JL, IK))*ZQP
        ZQSAT=MIN (0.5_JPRB, ZQSAT)
        ZCOR=1.0_JPRB/(1.0_JPRB-YDCST%RETV*ZQSAT)
        ZQSAT=ZQSAT*ZCOR
        ZCOND1=(ZQENWB (JL, IK)-ZQSAT)/(1.0_JPRB+ZQSAT*ZCOR*FOEDEMCU (ZTENWB (JL, IK)))

        IF (ZCOND_CUADJTQ==0.0_JPRB)  THEN
          ZCOND1=MIN (ZCOND1, 0.0_JPRB)
        ENDIF

        ZTENWB (JL, IK)=ZTENWB (JL, IK)+FOELDCPMCU (ZTENWB (JL, IK))*ZCOND1
        ZQENWB (JL, IK)=ZQENWB (JL, IK)-ZCOND1
      ENDIF

    
    
    
    
    
    
    ELSE

      

      

      

      IF (LLO2 ) THEN
        ZQP=1.0_JPRB/ZPH 
        ZTARG_CUADJTQ=ZTENWB (JL, IK)
        ZOEALFA_CUADJTQ=0.5_JPRB*(TANH (YDEPHLI%RLPAL1*(ZTARG_CUADJTQ-YDEPHLI%RLPTRC))+1.0_JPRB)
        ZFOEEWL=YDTHF%R2ES*EXP (YDTHF%R3LES*(ZTARG_CUADJTQ-YDCST%RTT)/(ZTARG_CUADJTQ-YDTHF%R4LES))
        ZFOEEWI=YDTHF%R2ES*EXP (YDTHF%R3IES*(ZTARG_CUADJTQ-YDCST%RTT)/(ZTARG_CUADJTQ-YDTHF%R4IES))
        ZQSAT=ZQP*(ZOEALFA_CUADJTQ*ZFOEEWL+(1.0_JPRB-ZOEALFA_CUADJTQ)*ZFOEEWI)
        Z1S=TANH (YDEPHLI%RLPAL2*(ZQSAT-ZQMAX))
        ZQSAT=0.5_JPRB*((1.0_JPRB-Z1S)*ZQSAT+(1.0_JPRB+Z1S)*ZQMAX)
        ZCOR=1.0_JPRB/(1.0_JPRB-YDCST%RETV*ZQSAT)
        ZQSAT=ZQSAT*ZCOR
        Z2S=ZOEALFA_CUADJTQ*YDTHF%R5ALVCP*(1.0_JPRB/(ZTARG_CUADJTQ-YDTHF%R4LES)**2)+(1.0_JPRB&
        &-ZOEALFA_CUADJTQ)*YDTHF%R5ALSCP*(1.0_JPRB/(ZTARG_CUADJTQ-YDTHF%R4IES)**2)
        ZCOND_CUADJTQ=(ZQENWB (JL, IK)-ZQSAT)/(1.0_JPRB+ZQSAT*ZCOR*Z2S)
        ZCOND_CUADJTQ=MIN (ZCOND_CUADJTQ, 0.0_JPRB)

        IF (ZCOND_CUADJTQ/=0.0_JPRB) THEN
          ZTENWB (JL, IK)=ZTENWB (JL, IK)+(ZOEALFA_CUADJTQ*YDTHF%RALVDCP&
          &+(1.0_JPRB-ZOEALFA_CUADJTQ)*YDTHF%RALSDCP)*ZCOND_CUADJTQ
          ZQENWB (JL, IK)=ZQENWB (JL, IK)-ZCOND_CUADJTQ
          ZTARG_CUADJTQ=ZTENWB (JL, IK)
          ZOEALFA_CUADJTQ=0.5_JPRB*(TANH (YDEPHLI%RLPAL1*(ZTARG_CUADJTQ-YDEPHLI%RLPTRC))+1.0_JPRB)
          ZFOEEWL=YDTHF%R2ES*EXP (YDTHF%R3LES*(ZTARG_CUADJTQ-YDCST%RTT)/(ZTARG_CUADJTQ-YDTHF%R4LES))
          ZFOEEWI=YDTHF%R2ES*EXP (YDTHF%R3IES*(ZTARG_CUADJTQ-YDCST%RTT)/(ZTARG_CUADJTQ-YDTHF%R4IES))
          ZQSAT=ZQP*(ZOEALFA_CUADJTQ*ZFOEEWL+(1.0_JPRB-ZOEALFA_CUADJTQ)*ZFOEEWI)
          Z1S=TANH (YDEPHLI%RLPAL2*(ZQSAT-ZQMAX))
          ZQSAT=0.5_JPRB*((1.0_JPRB-Z1S)*ZQSAT+(1.0_JPRB+Z1S)*ZQMAX)
          ZCOR=1.0_JPRB/(1.0_JPRB-YDCST%RETV*ZQSAT)
          ZQSAT=ZQSAT*ZCOR
          Z2S=ZOEALFA_CUADJTQ*YDTHF%R5ALVCP*(1.0_JPRB/(ZTARG_CUADJTQ-YDTHF%R4LES)**2)+(1.0_JPRB&
          &-ZOEALFA_CUADJTQ)*YDTHF%R5ALSCP*(1.0_JPRB/(ZTARG_CUADJTQ-YDTHF%R4IES)**2)
          ZCOND1=(ZQENWB (JL, IK)-ZQSAT)/(1.0_JPRB+ZQSAT*ZCOR*Z2S)
          ZTENWB (JL, IK)=ZTENWB (JL, IK)+(ZOEALFA_CUADJTQ*YDTHF%RALVDCP&
          &+(1.0_JPRB-ZOEALFA_CUADJTQ)*YDTHF%RALSDCP)*ZCOND1
          ZQENWB (JL, IK)=ZQENWB (JL, IK)-ZCOND1
        ENDIF

      ENDIF

    
    
    
    
    ENDIF


    

    

    

    

    IF (LLO2 ) THEN
      ZTTEST=0.5_JPRB*(PTU_PTR (JL, JK)+ZTENWB (JL, JK))
      ZQTEST=0.5_JPRB*(PQU_PTR (JL, JK)+ZQENWB (JL, JK))
      ZBUO=ZTTEST*(1.0_JPRB+YDCST%RETV*ZQTEST)-PTENH_PTR (JL, JK)*(1.0_JPRB+YDCST%RETV*PQENH_PTR (JL, JK))
      ZCOND =PQENH_PTR (JL, JK)-ZQENWB (JL, JK)
      ZMFTOP=-YDECUMF%RMFDEPS*PMFUB_PTR (JL)

      IF (ZBUO<0.0_JPRB.AND.PRFL_PTR (JL)>10._JPRB*ZMFTOP*ZCOND ) THEN
        KDTOP_PTR (JL)=JK
        LDDRAF_PTR (JL)=.TRUE.
        PTD_PTR (JL, JK)=ZTTEST
        PQD_PTR (JL, JK)=ZQTEST
        PMFD_PTR (JL, JK)=ZMFTOP
        PMFDS_PTR (JL, JK)=PMFD_PTR (JL, JK)*(YDCST%RCPD*PTD_PTR (JL, JK)+PGEOH_PTR (JL, JK))
        PMFDQ_PTR (JL, JK)=PMFD_PTR (JL, JK)*PQD_PTR (JL, JK)
        PDMFDP_PTR (JL, JK-1)=-0.5_JPRB*PMFD_PTR (JL, JK)*ZCOND 
        PRFL_PTR (JL)=PRFL_PTR (JL)+PDMFDP_PTR (JL, JK-1)
      ENDIF

    ENDIF

  
  ENDDO

ENDIF



ENDSUBROUTINE CUDLFSN_OPENACC
