SUBROUTINE CUMASTRN_SINGLEBLOCK (PPLDARE, PPLRG, YDTHF, YDCST, YDML_PHY_SLIN, YDML_PHY_EC, YGFL&
&, YDCHEM, YDSPP_CONFIG, YDPERTPAR, KIDIA, KFDIA, KLON, KLEV, PDX, LDTDKMF, LDMCAPEA, LDLAND, PTSPHY&
&, PTEN, PQEN, PUEN, PVEN, PLITOT, PVERVEL, PQSEN, PQHFL, PAHFS, PAP, PAPH, PGEO, PGEOH, PGAW, PCUCONVCA&
&, PGP2DSPP, PTENT, PTENQ, PTENU, PTENV, PTENTA, PTENQA, LDCUM, KTYPE, KCBOT, KCTOP, LDCUM_LIG,&
& KCBOT_LIG, KCTOP_LIG, KBOTSC, LDSC, LDSHCV, PLCRIT_AER, PTU, PQU, PLU, PLUDE, PLUDELI, PSNDE,&
& PENTH, PMFLXR, PMFLXS, PRAIN, PLRAIN, PRSUD, PMFU, PMFD, PLGLAC, PMFUDE_RATE, PMFDDE_RATE, PCAPE&
&, PWU, PWMEAN, PVDISCU, PDISS, KTRAC, PCEN, PTENC, PSCAV, PSCAV0, LDACC)
USE MODEL_PHYSICS_ECMWF_MOD,ONLY:MODEL_PHYSICS_ECMWF_TYPE
USE MODEL_PHYSICS_SIMPLINEAR_MOD,ONLY:MODEL_PHYSICS_SIMPLINEAR_TYPE
USE YOM_YGFL,ONLY:TYPE_GFLD
USE YOMCHEM,ONLY:TCHEM
USE PARKIND1,ONLY:JPIM, JPRB
#ifdef __PGI
USE NVTX, ONLY : NVTXSTARTRANGE, NVTXENDRANGE
#endif
USE YOMCST,ONLY:TCST
USE YOETHF,ONLY:TTHF
USE SPP_MOD,ONLY:TSPP_CONFIG
USE SPP_GEN_MOD,ONLY:SPP_PERT
USE YOMPERTPAR,ONLY:TPERTPAR
USE FXTRAN_ACDC_STACK_MOD
#include "fxtran_acdc_stack.h"

IMPLICIT NONE


REAL (KIND=JPRB), INTENT (IN)::PPLDARE
REAL (KIND=JPRB), INTENT (IN)::PPLRG
TYPE (TTHF), INTENT (IN)::YDTHF
TYPE (TCST), INTENT (IN)::YDCST
TYPE (MODEL_PHYSICS_ECMWF_TYPE), INTENT (IN)::YDML_PHY_EC
TYPE (TCHEM), INTENT (IN)::YDCHEM
TYPE (TSPP_CONFIG), INTENT (IN)::YDSPP_CONFIG
TYPE (TPERTPAR), INTENT (IN)::YDPERTPAR
TYPE (MODEL_PHYSICS_SIMPLINEAR_TYPE), INTENT (IN)::YDML_PHY_SLIN
TYPE (TYPE_GFLD), INTENT (IN)::YGFL
INTEGER (KIND=JPIM), INTENT (IN)::KLON
INTEGER (KIND=JPIM), INTENT (IN)::KLEV
INTEGER (KIND=JPIM), INTENT (IN)::KIDIA
INTEGER (KIND=JPIM), INTENT (IN)::KFDIA
INTEGER (KIND=JPIM), INTENT (IN)::KTRAC
LOGICAL, INTENT (IN)::LDMCAPEA
LOGICAL, INTENT (IN)::LDLAND (KLON)
REAL (KIND=JPRB), INTENT (IN)::PTSPHY
REAL (KIND=JPRB), INTENT (IN)::PLCRIT_AER (KLON, KLEV)
REAL (KIND=JPRB), INTENT (INOUT)::PTEN (KLON, KLEV)
REAL (KIND=JPRB), INTENT (INOUT)::PQEN (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PUEN (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PVEN (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PLITOT (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PVERVEL (KLON, KLEV)
REAL (KIND=JPRB), INTENT (INOUT)::PQSEN (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PQHFL (KLON, KLEV+1)
REAL (KIND=JPRB), INTENT (IN)::PAHFS (KLON, KLEV+1)
REAL (KIND=JPRB), INTENT (IN)::PAP (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PAPH (KLON, KLEV+1)
REAL (KIND=JPRB), INTENT (IN)::PGEO (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PGEOH (KLON, KLEV+1)
REAL (KIND=JPRB), INTENT (IN)::PGAW (KLON)
REAL (KIND=JPRB), INTENT (IN)::PCUCONVCA (KLON)
REAL (KIND=JPRB), INTENT (IN)::PGP2DSPP (KLON, YDSPP_CONFIG%SM%NRFTOTAL)
REAL (KIND=JPRB), INTENT (IN)::PCEN (KLON, KLEV, KTRAC)
REAL (KIND=JPRB), INTENT (IN)::PSCAV (KTRAC)
REAL (KIND=JPRB), INTENT (IN)::PSCAV0 (KTRAC)
REAL (KIND=JPRB), INTENT (IN)::PDX (KLON)
LOGICAL, INTENT (IN)::LDTDKMF
REAL (KIND=JPRB), INTENT (INOUT)::PTENT (KLON, KLEV)
REAL (KIND=JPRB), INTENT (INOUT)::PTENQ (KLON, KLEV)
REAL (KIND=JPRB), INTENT (INOUT)::PTENU (KLON, KLEV)
REAL (KIND=JPRB), INTENT (INOUT)::PTENV (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PTENTA (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PTENQA (KLON, KLEV)
REAL (KIND=JPRB), INTENT (INOUT)::PTENC (KLON, KLEV, KTRAC)
LOGICAL, INTENT (OUT)::LDCUM (KLON)
INTEGER (KIND=JPIM), INTENT (OUT)::KTYPE (KLON)
INTEGER (KIND=JPIM), INTENT (OUT)::KCBOT (KLON)
INTEGER (KIND=JPIM), INTENT (OUT)::KCTOP (KLON)
LOGICAL, INTENT (OUT)::LDCUM_LIG (KLON)
INTEGER (KIND=JPIM), INTENT (OUT)::KCBOT_LIG (KLON)
INTEGER (KIND=JPIM), INTENT (OUT)::KCTOP_LIG (KLON)
INTEGER (KIND=JPIM), INTENT (OUT)::KBOTSC (KLON)
LOGICAL, INTENT (OUT)::LDSC (KLON)
LOGICAL, INTENT (IN)::LDSHCV (KLON)
REAL (KIND=JPRB), INTENT (OUT)::PTU (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PQU (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PLU (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PLUDE (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PLUDELI (KLON, KLEV, 4)
REAL (KIND=JPRB), INTENT (OUT)::PSNDE (KLON, KLEV, 2)
REAL (KIND=JPRB), INTENT (OUT)::PENTH (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PMFLXR (KLON, KLEV+1)
REAL (KIND=JPRB), INTENT (OUT)::PMFLXS (KLON, KLEV+1)
REAL (KIND=JPRB), INTENT (OUT)::PRAIN (KLON)
REAL (KIND=JPRB), INTENT (OUT)::PLRAIN (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PRSUD (KLON, KLEV, 2)
REAL (KIND=JPRB), INTENT (OUT)::PMFU (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PMFD (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PLGLAC (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PMFUDE_RATE (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PMFDDE_RATE (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PCAPE (KLON)
REAL (KIND=JPRB), INTENT (OUT)::PWMEAN (KLON)
REAL (KIND=JPRB), INTENT (OUT)::PVDISCU (KLON)
REAL (KIND=JPRB), INTENT (OUT)::PWU (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PDISS (KLON, KLEV)
LOGICAL, INTENT (IN) :: LDACC
REAL (KIND=JPRB)::ZKINED (KLON, KLEV)
REAL (KIND=JPRB)::ZKINEU (KLON, KLEV)
REAL (KIND=JPRB)::ZVD (KLON, KLEV)
REAL (KIND=JPRB)::ZUD (KLON, KLEV)
REAL (KIND=JPRB)::ZVU (KLON, KLEV)
REAL (KIND=JPRB)::ZUU (KLON, KLEV)
REAL (KIND=JPRB)::ZRFL (KLON)
REAL (KIND=JPRB)::ZMFUL (KLON, KLEV)
REAL (KIND=JPRB)::ZDMFDP (KLON, KLEV)
REAL (KIND=JPRB)::ZDMFUP (KLON, KLEV)
REAL (KIND=JPRB)::ZMFDQ (KLON, KLEV)
REAL (KIND=JPRB)::ZMFUQ (KLON, KLEV)
REAL (KIND=JPRB)::ZMFDS (KLON, KLEV)
REAL (KIND=JPRB)::ZMFUS (KLON, KLEV)
REAL (KIND=JPRB)::ZQD (KLON, KLEV)
REAL (KIND=JPRB)::ZTD (KLON, KLEV)
REAL (KIND=JPRB)::ZQSENH (KLON, KLEV)
REAL (KIND=JPRB)::ZQENH2 (KLON, KLEV)
REAL (KIND=JPRB)::ZTENH2 (KLON, KLEV)
REAL (KIND=JPRB)::ZQENH (KLON, KLEV)
REAL (KIND=JPRB)::ZTENH (KLON, KLEV)
REAL (KIND=JPRB)::ZSATFR (KLON)
REAL (KIND=JPRB)::ZMFCFL (KLON)
REAL (KIND=JPRB)::ZFACCA (KLON)
REAL (KIND=JPRB)::ZDQCV (KLON)
REAL (KIND=JPRB)::ZKHFL (KLON)
REAL (KIND=JPRB)::ZKHVFL (KLON)
REAL (KIND=JPRB)::ZMFUB1 (KLON)
REAL (KIND=JPRB)::ZMFUB (KLON)
REAL (KIND=JPRB)::ZDPMEL (KLON, KLEV)
REAL (KIND=JPRB)::ZWUBASE (KLON)
REAL (KIND=JPRB)::ZDHPBL (KLON)
REAL (KIND=JPRB)::ZDX (KLON)
REAL (KIND=JPRB)::ZDMFDE (KLON, KLEV)
REAL (KIND=JPRB)::ZDMFEN (KLON, KLEV)
INTEGER (KIND=JPIM)::ICTOP0 (KLON)
INTEGER (KIND=JPIM)::IDTOP (KLON)
INTEGER (KIND=JPIM)::ILAB (KLON, KLEV)
INTEGER (KIND=JPIM)::IDPL (KLON)
REAL (KIND=JPRB)::ZCAPDCYCLSE (KLON)
REAL (KIND=JPRB)::ZCAPDCYCLLD (KLON)
REAL (KIND=JPRB)::ZCAPDCYCL (KLON)
REAL (KIND=JPRB)::ZCAPPBL (KLON)
REAL (KIND=JPRB)::ZHEAT (KLON)
REAL (KIND=JPRB)::ZCAPE2 (KLON)
REAL (KIND=JPRB)::ZCAPE (KLON)
LOGICAL::LLSCVFLAG (KLON)
LOGICAL::LLDCUM (KLON)
LOGICAL::LLDDRAF3 (KLON)
LOGICAL::LLDDRAF (KLON)
LOGICAL::LLO3
LOGICAL::LLMIXS
LOGICAL::LLO2 (KLON)
LOGICAL::LLO1
INTEGER (KIND=JPIM)::JL
INTEGER (KIND=JPIM)::IK
INTEGER (KIND=JPIM)::JK
INTEGER (KIND=JPIM)::ITOPM2
INTEGER (KIND=JPIM)::IKD
INTEGER (KIND=JPIM)::IKB
REAL (KIND=JPRB)::ZIND
REAL (KIND=JPRB)::ZRG
REAL (KIND=JPRB)::ZAK
REAL (KIND=JPRB)::ZBS
REAL (KIND=JPRB)::ZBR
REAL (KIND=JPRB)::ZAS
REAL (KIND=JPRB)::ZAR
REAL (KIND=JPRB)::ZTAURES
REAL (KIND=JPRB)::ZTDIS
REAL (KIND=JPRB)::ZDVTEN
REAL (KIND=JPRB)::ZDUTEN
REAL (KIND=JPRB)::ZRDOCPD
REAL (KIND=JPRB)::ZORCPD
REAL (KIND=JPRB)::ZDERATE
REAL (KIND=JPRB)::ZERATE
REAL (KIND=JPRB)::ZMFA
REAL (KIND=JPRB)::ZRO
REAL (KIND=JPRB)::ZQUMQE
REAL (KIND=JPRB)::ZPBMPT
REAL (KIND=JPRB)::ZMFMAX
REAL (KIND=JPRB)::ZFAC
REAL (KIND=JPRB)::ZEPS
REAL (KIND=JPRB)::ZDZ
REAL (KIND=JPRB)::ZDQMIN
REAL (KIND=JPRB)::ZDH2
REAL (KIND=JPRB)::ZDH
REAL (KIND=JPRB)::ZCONS
REAL (KIND=JPRB)::ZCONS2
REAL (KIND=JPRB)::ZTAUPBL (KLON)
REAL (KIND=JPRB)::ZTAU (KLON)
REAL (KIND=JPRB)::ZXTAU (KLON)
LOGICAL::LLPERT_RTAU
INTEGER (KIND=JPIM)::IPRTAU
INTEGER (KIND=JPIM)::IPN
TYPE (SPP_PERT)::PN1
REAL (KIND=JPRB)::ZSUM22 (KLON)
REAL (KIND=JPRB)::ZSUM12 (KLON)
REAL (KIND=JPRB)::ZUV2 (KLON, KLEV)
REAL (KIND=JPRB)::ZDMFDPC (KLON, KLEV)
REAL (KIND=JPRB)::ZDMFUPC (KLON, KLEV)
REAL (KIND=JPRB)::ZKMFL (KLON)
REAL (KIND=JPRB)::ZMF_SHAL (KLON)
REAL (KIND=JPRB)::ZMFUVB (KLON)
REAL (KIND=JPRB)::ZMFUUB (KLON)
REAL (KIND=JPRB)::ZTENV (KLON, KLEV)
REAL (KIND=JPRB)::ZTENU (KLON, KLEV)
REAL (KIND=JPRB)::ZMFDDR (KLON, KLEV)
REAL (KIND=JPRB)::ZMFUDR (KLON, KLEV)
REAL (KIND=JPRB)::ZMFDUS (KLON, KLEV)
REAL (KIND=JPRB)::ZMFUUS (KLON, KLEV)
REAL (KIND=JPRB)::ZMFS (KLON)

#include "cuascn.intfb.h"
#include "cubasen.intfb.h"
#include "cuddrafn.intfb.h"
#include "cudlfsn.intfb.h"
#include "cudtdqn.intfb.h"
#include "cududv.intfb.h"
#include "cuflxn.intfb.h"
#include "cuinin.intfb.h"
#include "cuctracer.intfb.h"
#include "fcttre.func.h"
TYPE (FXTRAN_ACDC_STACK) :: YLSTACK

!$ACC DATA &
!$ACC&CREATE (ICTOP0, IDPL, IDTOP, ILAB, LLDCUM, LLDDRAF, LLDDRAF3, LLO2, LLSCVFLAG, &
!$ACC&        ZCAPDCYCL, ZCAPDCYCLLD, ZCAPDCYCLSE, ZCAPE, ZCAPE2, ZCAPPBL, ZDHPBL, &
!$ACC&        ZDMFDE, ZDMFDP, ZDMFDPC, ZDMFEN, ZDMFUP, ZDMFUPC, ZDPMEL, ZDQCV, ZDX, &
!$ACC&        ZFACCA, ZHEAT, ZKHFL, ZKHVFL, ZKINED, ZKINEU, ZKMFL, ZMFCFL, ZMFDDR, &
!$ACC&        ZMFDQ, ZMFDS, ZMFDUS, ZMFS, ZMFUB, ZMFUB1, ZMFUDR, ZMFUL, ZMFUQ, ZMFUS, &
!$ACC&        ZMFUUB, ZMFUUS, ZMFUVB, ZMF_SHAL, ZQD, ZQENH, ZQENH2, ZQSENH, ZRFL, ZSATFR, &
!$ACC&        ZSUM12, ZSUM22, ZTAU, ZTAUPBL, ZTD, ZTENH, ZTENH2, ZTENU, ZTENV, ZUD, ZUU, &
!$ACC&        ZUV2, ZVD, ZVU, ZWUBASE, ZXTAU) &
!$ACC&IF (LDACC) &
!$ACC&PRESENT (KBOTSC, KCBOT, KCBOT_LIG, KCTOP, KCTOP_LIG, KTYPE, LDCUM, LDCUM_LIG, &
!$ACC&         LDLAND, LDSC, LDSHCV, PAHFS, PAP, PAPH, PCAPE, PCEN, PCUCONVCA, PDISS, &
!$ACC&         PDX, PENTH, PGAW, PGEO, PGEOH, PGP2DSPP, PLCRIT_AER, PLGLAC, PLITOT, &
!$ACC&         PLRAIN, PLU, PLUDE, PLUDELI, PMFD, PMFDDE_RATE, PMFLXR, PMFLXS, PMFU, &
!$ACC&         PMFUDE_RATE, PQEN, PQHFL, PQSEN, PQU, PRAIN, PRSUD, PSNDE, PTEN, PTENC, &
!$ACC&         PTENQ, PTENQA, PTENT, PTENTA, PTENU, PTENV, PTU, PUEN, PVDISCU, PVEN, PVERVEL, &
!$ACC&         PWMEAN, PWU, YDCHEM, YDCST, YDML_PHY_EC, YDML_PHY_SLIN, YDPERTPAR, &
!$ACC&         YDSPP_CONFIG, YDTHF, YGFL) 

#ifdef __PGI
CALL NVTXSTARTRANGE ('CUMASTRN_SINGLEBLOCK')
#endif

ZCONS2=YDML_PHY_EC%YRECUMF%RMFCFL/(YDCST%RG*PTSPHY)
ZCONS=1.0_JPRB/(YDCST%RG*PTSPHY)
ZORCPD=1.0_JPRB/YDCST%RCPD
ZRDOCPD=YDCST%RD*ZORCPD
ZRG=1.0_JPRB/YDCST%RG

!$ACC PARALLEL LOOP GANG VECTOR &
!$ACC&IF (LDACC) &
!$ACC&PRIVATE (JL) 


DO JL = KIDIA, KFDIA
  
  ZTAU (JL)=0.0
ENDDO


LLPERT_RTAU=.FALSE.


!$ACC PARALLEL LOOP GANG VECTOR &
!$ACC&IF (LDACC) &
!$ACC&PRIVATE (JL, YLSTACK) 


DO JL = KIDIA, KFDIA
  YLSTACK%L8 = fxtran_acdc_stack_l8 (YFXTRAN_ACDC_STACK, 1, 1)
  YLSTACK%U8 = fxtran_acdc_stack_u8 (YFXTRAN_ACDC_STACK, 1, 1)
  YLSTACK%L4 = fxtran_acdc_stack_l4 (YFXTRAN_ACDC_STACK, 1, 1)
  YLSTACK%U4 = fxtran_acdc_stack_u4 (YFXTRAN_ACDC_STACK, 1, 1)
  
  
  PCAPE (JL)=0.0_JPRB
  PVDISCU (JL)=0.0_JPRB
  LDCUM (JL)=.FALSE.
  
  CALL CUININ_OPENACC (YDCST, YDTHF, YDML_PHY_SLIN%YREPHLI, YDML_PHY_EC%YRECUMF, JL&
  &, JL, KLON, KLEV, PTEN, PQEN, PQSEN, PUEN, PVEN, PGEO, PAPH, ILAB, ZTENH, ZQENH,&
  & ZQSENH, PGEOH, PTU, PQU, ZTD, ZQD, ZUU, ZVU, ZUD, ZVD, PLU, YDSTACK=YLSTACK)
  ZKMFL (JL)=0.0_JPRB
ENDDO

LLMIXS=LDTDKMF
CALL CUBASEN_SINGLEBLOCK (PPLDARE, PPLRG, YDTHF, YDCST, YDML_PHY_SLIN%YREPHLI, YDML_PHY_EC%YRECLDP&
&, YDML_PHY_EC%YRECUMF, YDSPP_CONFIG, KIDIA, KFDIA, KLON, KLEV, YDML_PHY_EC%YRECUMF%NJKT1, LLMIXS,&
& LDTDKMF, ZTENH, ZQENH, PGEOH, PAPH, PQHFL, PAHFS, PGP2DSPP, ZKMFL, PTEN, PQEN, PQSEN, PGEO, PTU,&
& PQU, PLU, ZKINEU, ZWUBASE, ILAB, LDCUM, LDSC, KCBOT, KBOTSC, ICTOP0, IDPL, PCAPE, LDACC=LDACC)

!$ACC PARALLEL LOOP GANG VECTOR &
!$ACC&IF (LDACC) &
!$ACC&PRIVATE (JK, JL, ZDZ) 


DO JL = KIDIA, KFDIA
  
  
  ZDHPBL (JL)=0.0_JPRB
  IDTOP (JL)=0
  ZCAPPBL (JL)=0.
  ZKHVFL (JL)=(-PAHFS (JL, KLEV+1)*ZORCPD-YDCST%RETV*PTEN&
  & (JL, KLEV)*PQHFL (JL, KLEV+1))/(PPLRG*PPLDARE)
  ZKHFL (JL)=(-PAHFS (JL, KLEV+1)-YDCST%RLVTT*PQHFL (JL, KLEV+1))/(PPLRG*PPLDARE)

  

  DO JK=YDML_PHY_EC%YRECUMF%NJKT2, KLEV

    

    IF (LDCUM (JL).AND.JK>=KCBOT (JL)) THEN
      ZDZ=(PAPH (JL, JK+1)-PAPH (JL, JK))
      ZDHPBL (JL)=ZDHPBL (JL)+(YDCST%RLVTT*PTENQ (JL, JK)+YDCST%RCPD*PTENT (JL, JK))*ZDZ
      ZCAPPBL (JL)=ZCAPPBL (JL)+(PTENT (JL, JK)+YDCST%RETV*PTEN (JL, JK)*PTENQ (JL, JK))*ZDZ
    ENDIF

  
  ENDDO

ENDDO


!$ACC PARALLEL LOOP GANG VECTOR &
!$ACC&IF (LDACC) &
!$ACC&PRIVATE (IKB, ITOPM2, JL, ZDH, ZDQMIN, ZDZ, ZMFMAX, ZPBMPT, ZQUMQE) 


DO JL = KIDIA, KFDIA

  

  

  IF (LDCUM (JL)) THEN
    IKB=KCBOT (JL)
    ITOPM2=ICTOP0 (JL)
    ZPBMPT=PAPH (JL, IKB)-PAPH (JL, ITOPM2)

    IF (ZPBMPT>=YDML_PHY_EC%YRECUMF%RDEPTHS) THEN
      KTYPE (JL)=1
    ELSE
      KTYPE (JL)=2
    ENDIF

  ELSE
    KTYPE (JL)=0
  ENDIF


  

  IF (YDML_PHY_EC%YRECUMF%LMFWSTAR) THEN

    

    IF (LDCUM (JL)) THEN
      IKB=KCBOT (JL)
      ZDZ=MAX (0.0_JPRB, MIN (1.5E3_JPRB,(PGEOH (JL, IKB)-PGEOH (JL, KLEV+1))/YDCST%RG))
      ZMF_SHAL (JL)=0.07_JPRB*(YDCST%RG/PTEN (JL, KLEV)*ZDZ*MAX (0.0_JPRB, ZKHVFL (JL)))**.3333
      ZMFMAX=(PAPH (JL, IKB)-PAPH (JL, IKB-1))*ZCONS2
      ZMF_SHAL (JL)=MIN (ZMF_SHAL (JL), ZMFMAX)
    ENDIF

  
  ENDIF


  

  IF (LDCUM (JL)) THEN
    IKB=KCBOT (JL)
    ZMFMAX=(PAPH (JL, IKB)-PAPH (JL, IKB-1))*ZCONS2

    IF (KTYPE (JL)==1) THEN
      ZMFUB (JL)=ZMFMAX*0.1_JPRB
    ELSEIF (KTYPE (JL)==2) THEN
      ZQUMQE=PQU (JL, IKB)+PLU (JL, IKB)-ZQENH (JL, IKB)
      ZDQMIN=MAX (0.01_JPRB*ZQENH (JL, IKB), 1.E-10_JPRB)
      ZDH=YDCST%RCPD*(PTU (JL, IKB)-ZTENH (JL, IKB))+YDCST%RLVTT*ZQUMQE
      ZDH=YDCST%RG*MAX (ZDH, 1.E5_JPRB*ZDQMIN)

      IF (ZDHPBL (JL)>0.0_JPRB) THEN
        ZMFUB (JL)=ZDHPBL (JL)/ZDH
        ZMFUB (JL)=MIN (ZMFUB (JL), ZMFMAX)
      ELSE
        ZMFUB (JL)=ZMFMAX*0.1_JPRB
        LDCUM (JL)=.FALSE.
      ENDIF


      IF (YDML_PHY_EC%YRECUMF%LMFWSTAR)  THEN
        ZMFUB (JL)=ZMF_SHAL (JL)
      ENDIF

    ENDIF

  ELSE
    ZMFUB (JL)=0.0_JPRB
  ENDIF

  
ENDDO

CALL CUASCN_SINGLEBLOCK (YDTHF, YDCST, YDML_PHY_SLIN%YREPHLI, YDML_PHY_EC%YRECLDP, YDML_PHY_EC%YRECUMF&
&, YDSPP_CONFIG, YGFL, KIDIA, KFDIA, KLON, KLEV, LDTDKMF, PTSPHY, ZTENH, ZQENH, PUEN, PVEN, PTEN, PQEN&
&, PQSEN, PLITOT, PGEO, PGEOH, PAP, PAPH, PVERVEL, ZWUBASE, PGP2DSPP, LDLAND, LDCUM, KTYPE, ILAB, LLSCVFLAG&
&, PTU, PQU, PLU, PLRAIN, PMFU, ZMFUB, PLGLAC, ZMFUS, ZMFUQ, ZMFUL, PLUDE, PLUDELI, ZDMFUP, PLCRIT_AER&
&, ZDMFEN, KCBOT, KCTOP, ICTOP0, IDPL, PMFUDE_RATE, ZKINEU, PWU, PWMEAN, LDACC=LDACC)

!$ACC PARALLEL LOOP GANG VECTOR &
!$ACC&IF (LDACC) &
!$ACC&PRIVATE (IKB, ITOPM2, JK, JL, ZPBMPT) 


DO JL = KIDIA, KFDIA

  

  

  IF (LDCUM (JL)) THEN
    IKB=KCBOT (JL)
    ITOPM2=KCTOP (JL)
    ZPBMPT=PAPH (JL, IKB)-PAPH (JL, ITOPM2)

    IF (KTYPE (JL)==1.AND.ZPBMPT<YDML_PHY_EC%YRECUMF%RDEPTHS)  THEN
      KTYPE (JL)=2
    ENDIF


    IF (KTYPE (JL)==2.AND.ZPBMPT>=YDML_PHY_EC%YRECUMF%RDEPTHS)  THEN
      KTYPE (JL)=1
    ENDIF

    ICTOP0 (JL)=KCTOP (JL)
  ENDIF

  ZRFL (JL)=ZDMFUP (JL, 1)

  

  DO JK=2, KLEV
    
    ZRFL (JL)=ZRFL (JL)+ZDMFUP (JL, JK)
  
  ENDDO


  DO JK=1, KLEV
    
    PMFD (JL, JK)=0.0_JPRB
    ZMFDS (JL, JK)=0.0_JPRB
    ZMFDQ (JL, JK)=0.0_JPRB
    ZDMFDP (JL, JK)=0.0_JPRB
    ZDPMEL (JL, JK)=0.0_JPRB
  
  ENDDO


  DO JK=1, KLEV
    
    ZTENU (JL, JK)=PTENU (JL, JK)
    ZTENV (JL, JK)=PTENV (JL, JK)
  
  ENDDO

ENDDO


!$ACC PARALLEL LOOP GANG VECTOR &
!$ACC&IF (LDACC) &
!$ACC&PRIVATE (JL, YLSTACK) 


DO JL = KIDIA, KFDIA
  YLSTACK%L8 = fxtran_acdc_stack_l8 (YFXTRAN_ACDC_STACK, 1, 1)
  YLSTACK%U8 = fxtran_acdc_stack_u8 (YFXTRAN_ACDC_STACK, 1, 1)
  YLSTACK%L4 = fxtran_acdc_stack_l4 (YFXTRAN_ACDC_STACK, 1, 1)
  YLSTACK%U4 = fxtran_acdc_stack_u4 (YFXTRAN_ACDC_STACK, 1, 1)

  

  IF (YDML_PHY_EC%YRECUMF%LMFDD) THEN
    CALL CUDLFSN_OPENACC (YDTHF, YDCST, YDML_PHY_SLIN%YREPHLI, YDML_PHY_EC%YRECUMF, JL, JL, KLON&
    &, KLEV, KCBOT, KCTOP, LDCUM, ZTENH, ZQENH, PTEN, PQSEN, PGEO, PGEOH, PAPH, PTU, PQU, ZMFUB&
    &, ZRFL, ZTD, ZQD, PMFD, ZMFDS, ZMFDQ, ZDMFDP, IDTOP, LLDDRAF, YDSTACK=YLSTACK)
    CALL CUDDRAFN_OPENACC (YDCST, YDTHF, YDML_PHY_SLIN%YREPHLI, YDML_PHY_EC%YRECUMF, JL&
    &, JL, KLON, KLEV, LLDDRAF, ZTENH, ZQENH, PQSEN, PGEO, PGEOH, PAPH, ZRFL, ZTD, ZQD,&
    & PMFU, PMFD, ZMFDS, ZMFDQ, ZDMFDP, ZDMFDE, PMFDDE_RATE, ZKINED, YDSTACK=YLSTACK)
  ENDIF

ENDDO


!$ACC PARALLEL LOOP GANG VECTOR &
!$ACC&IF (LDACC) &
!$ACC&PRIVATE (IK, IKB, IKD, JK, JL, LLO1, LLO3, ZDUTEN, ZDZ, ZIND, ZTAURES) 


DO JL = KIDIA, KFDIA
  
  
  ZHEAT (JL)=0.0_JPRB
  ZCAPE (JL)=0.0_JPRB
  ZCAPE2 (JL)=0.0_JPRB
  ZMFUB1 (JL)=ZMFUB (JL)
  ZDQCV (JL)=0.0_JPRB
  ZSATFR (JL)=0.0_JPRB
  ZDX (JL)=2*YDCST%RA*SQRT (YDCST%RPI*PGAW (JL))
  ZDX (JL)=MAX (ZDX (JL), 1.E2_JPRB)

  

  DO JK=YDML_PHY_EC%YRECUMF%NJKT2, KLEV
    
    LLO1=LDCUM (JL).AND.KTYPE (JL)==1
    LLO3=LLO1.AND.JK<=KCBOT (JL).AND.JK>KCTOP (JL)

    IF (LLO3) THEN
      ZDZ=(PGEO (JL, JK-1)-PGEO (JL, JK))

      IF (LDTDKMF) THEN
        ZHEAT (JL)=ZHEAT (JL)+((PTEN (JL, JK-1)-PTEN (JL, JK)+ZDZ*ZORCPD)/ZTENH (JL, JK)+YDCST&
        &%RETV*(PQEN (JL, JK-1)-PQEN (JL, JK)))*(YDCST%RG*(PMFU (JL, JK)+PMFD (JL, JK)))
      ELSE
        ZHEAT (JL)=ZHEAT (JL)+MAX (0.0_JPRB,((PTEN (JL, JK-1)-PTEN (JL, JK)+ZDZ*ZORCPD)/ZTENH (JL, JK&
        &)+YDCST%RETV*(PQEN (JL, JK-1)-PQEN (JL, JK)))*(YDCST%RG*(PMFU (JL, JK)+PMFD (JL, JK))))
      ENDIF

      ZDZ=(PAP (JL, JK)-PAP (JL, JK-1))
      ZCAPE (JL)=ZCAPE (JL)+((PTU (JL, JK)-ZTENH (JL, JK))/ZTENH (JL, JK&
      &)+YDCST%RETV*(PQU (JL, JK)-ZQENH (JL, JK))-PLU (JL, JK))*ZDZ
    ENDIF


    IF (LLO3.AND.YDML_PHY_EC%YRECUMF%RCAPQADV>0.0_JPRB) THEN
      ZTENH2 (JL, JK)=ZTENH (JL, JK)-0.5_JPRB*(PTENTA (JL, JK)+PTENTA (JL, JK-1))*PTSPHY
      ZQENH2 (JL, JK)=ZQENH (JL, JK)-0.5_JPRB*(PTENQA (JL, JK)+PTENQA (JL, JK-1))*PTSPHY
      ZCAPE2 (JL)=ZCAPE2 (JL)+((PTU (JL, JK)-ZTENH2 (JL, JK))/ZTENH2 (JL,&
      & JK)+YDCST%RETV*(PQU (JL, JK)-ZQENH2 (JL, JK))-PLU (JL, JK))*ZDZ
    ENDIF


    IF (LLO1) THEN
      ZDZ=(PAPH (JL, JK+1)-PAPH (JL, JK))
      ZDQCV (JL)=ZDQCV (JL)+PTENQA (JL, JK)*ZDZ*(PQEN (JL, JK)/PQSEN (JL, JK))
    ENDIF


    IF (LLO1.AND.JK>=KCTOP (JL)) THEN
      ZDZ=(PAPH (JL, JK+1)-PAPH (JL, JK))
      ZSATFR (JL)=ZSATFR (JL)+(PQEN (JL, JK)/PQSEN (JL, JK))*ZDZ
    ENDIF

  
  ENDDO

  
  ZCAPDCYCL (JL)=0.0_JPRB
  ZTAU (JL)=0.0_JPRB

  IF (LDTDKMF) THEN
    ZDX (JL)=PDX (JL)
    ZDX (JL)=MAX (ZDX (JL), 1.E2_JPRB)
  ENDIF


  IF (LDCUM (JL).AND.KTYPE (JL)==1) THEN

    IF (YDML_PHY_EC%YRECUMF%LNEWTAU) THEN
      ZTAURES=YDML_PHY_EC%YRECUMF%RTAULIM*(1._JPRB+YDML_PHY_EC%YRECUMF%RTAUFAC&
      &/((ZDX (JL)/1000._JPRB-YDML_PHY_EC%YRECUMF%RXMIN+1._JPRB)**2))
    ELSE
      ZTAURES=1.0_JPRB+1.60_JPRB*ZDX (JL)/125.E3_JPRB

      IF (ZDX (JL)<8.E3_JPRB) THEN
        ZTAURES=1.0_JPRB+(LOG (8.E3_JPRB/ZDX (JL)))**2
      ENDIF

    ENDIF


    IF (ZDX (JL)>125.E3_JPRB)  THEN
      ZTAURES=MIN (3.0_JPRB, ZTAURES)
    ENDIF

    IKD=IDPL (JL)
    IKB=KCBOT (JL)
    IK=KCTOP (JL)
    ZTAU (JL)=(PGEOH (JL, IK)-PGEOH (JL, IKB))/((2.0_JPRB+MIN (15.0_JPRB&
    &, PWMEAN (JL)))*YDCST%RG)*ZTAURES*YDML_PHY_EC%YRECUMF%RTAUA
    
    ZXTAU (JL)=ZTAU (JL)
    
    LLO1=PAPH (JL, KLEV+1)-PAPH (JL, IKD)<50.E2_JPRB

    IF (LLO1.AND.LDLAND (JL).AND.YDML_PHY_EC%YRECUMF%RCAPDCYCL==1.0_JPRB) THEN
      ZDZ=MIN (1.E4_JPRB, PGEOH (JL, IKB)-PGEOH (JL, KLEV+1))/YDCST%RG
      ZCAPDCYCL (JL)=ZXTAU (JL)*MAX (0.0_JPRB, ZKHVFL (JL))*YDCST%RCPD/ZDZ
    ENDIF


    IF (LLO1.AND.YDML_PHY_EC%YRECUMF%RCAPDCYCL==2.0_JPRB) THEN
      ZIND=MAX (0._JPRB, MIN (1._JPRB,(YDML_PHY_EC%YRECUMF%RDXMAX-ZDX (JL&
      &))/(YDML_PHY_EC%YRECUMF%RDXMAX-YDML_PHY_EC%YRECUMF%RDXMIN)))

      IF (LDLAND (JL))  THEN
        ZIND=1._JPRB
      ENDIF

      ZCAPDCYCLLD (JL)=ZCAPPBL (JL)*ZTAU (JL)/ZTAURES
      ZDUTEN=2.0_JPRB+SQRT (0.5*(PUEN (JL, IKB)**2+PVEN (JL, IKB)**2+PUEN (JL, YDML_PHY_EC&
      &%YRECUMF%NJKT3)**2+PVEN (JL, YDML_PHY_EC%YRECUMF%NJKT3)**2))
      ZTAUPBL (JL)=MIN (1.E4_JPRB, PGEOH (JL, IKB)-PGEOH (JL, KLEV+1))/(YDCST%RG*ZDUTEN)
      ZCAPDCYCLSE (JL)=ZCAPPBL (JL)*ZTAUPBL (JL)
      ZCAPDCYCL (JL)=ZIND*ZCAPDCYCLLD (JL)+(1._JPRB-ZIND)*ZCAPDCYCLSE (JL)
    ENDIF

    ZDQCV (JL)=ZDQCV (JL)*YDCST%RLVTT/PGEOH (JL, IK)*ZXTAU (JL&
    &)/MAX (1.25_JPRB, ZTAURES)*YDML_PHY_EC%YRECUMF%RCAPQADV
    ZSATFR (JL)=ZSATFR (JL)/(PAPH (JL, KLEV+1)-PAPH (JL, IK))
  ELSE
    ZTAU (JL)=0.0_JPRB
  ENDIF

  
ENDDO


!$ACC PARALLEL LOOP GANG VECTOR &
!$ACC&IF (LDACC) &
!$ACC&PRIVATE (IKB, JL, ZMFMAX) 


DO JL = KIDIA, KFDIA

  

  IF (YDML_PHY_EC%YRECUMF%LMFCUCA) THEN
    
    ZFACCA (JL)=MAX (0.3_JPRB, MIN (1.8_JPRB, PCUCONVCA (JL)))
  
  ELSE
    ZFACCA (JL)=1.0_JPRB
  ENDIF


  

  IF (LDCUM (JL).AND.KTYPE (JL)==1) THEN
    IKB=KCBOT (JL)
    ZCAPE2 (JL)=YDML_PHY_EC%YRECUMF%RCAPQADV*ZCAPE2 (JL)+&
    &(1.0_JPRB-YDML_PHY_EC%YRECUMF%RCAPQADV)*ZCAPE (JL)
    ZCAPDCYCL (JL)=MAX (ZCAPDCYCL (JL),-2*ZCAPE2 (JL))

    IF (ZSATFR (JL)<=0.94.OR.PVERVEL (JL, YDML_PHY_EC%YRECUMF%NJKT5)<-100._JPRB) THEN
      ZCAPE (JL)=MAX (YDML_PHY_EC%YRECUMF%RMINCAPE*ZCAPE (JL), ZCAPE2 (JL)-ZCAPDCYCL (JL)+ZDQCV (JL))
    ELSE
      ZCAPE (JL)=MAX (YDML_PHY_EC%YRECUMF%RMINCAPE*ZCAPE (JL), ZCAPE (JL)-ZCAPDCYCL (JL))
    ENDIF

    ZCAPE (JL)=MIN (ZCAPE (JL), 5000.0_JPRB)
    ZHEAT (JL)=MAX (1.E-4_JPRB, ZHEAT (JL))
    ZXTAU (JL)=MAX (3.6E3_JPRB/(5.0_JPRB*PPLRG*PPLDARE), MIN&
    & (3.0_JPRB*3.6E3_JPRB/(PPLRG*PPLDARE), ZXTAU (JL)))
    ZMFUB1 (JL)=(ZCAPE (JL)*ZMFUB (JL))/(ZHEAT (JL)*ZXTAU (JL))
    ZMFUB1 (JL)=MAX (ZMFUB1 (JL), 0.001_JPRB)*ZFACCA (JL)
    ZMFMAX=(PAPH (JL, IKB)-PAPH (JL, IKB-1))*ZCONS2
    ZMFUB1 (JL)=MIN (ZMFUB1 (JL), ZMFMAX)
  ENDIF


  

  IF (LDMCAPEA) THEN
    
    PCAPE (JL)=YDCST%RG*ZCAPE (JL)
  
  ENDIF

ENDDO


!$ACC PARALLEL LOOP GANG VECTOR &
!$ACC&IF (LDACC) &
!$ACC&PRIVATE (IKB, JL, ZDH, ZDH2, ZEPS, ZMFMAX, ZQUMQE) 


DO JL = KIDIA, KFDIA

  

  

  IF (LDCUM (JL).AND.KTYPE (JL)>=2) THEN
    IKB=KCBOT (JL)

    IF (PMFD (JL, IKB)<0.0_JPRB) THEN
      ZEPS=-PMFD (JL, IKB)/MAX (ZMFUB (JL), 1.E-10_JPRB)
    ELSE
      ZEPS=0.0_JPRB
    ENDIF

    ZMFMAX=(PAPH (JL, IKB)-PAPH (JL, IKB-1))*ZCONS2

    IF (KTYPE (JL)==2) THEN

      IF (ZDHPBL (JL)>0.0_JPRB) THEN
        ZQUMQE=PQU (JL, IKB)+PLU (JL, IKB)-ZEPS*ZQD (JL, IKB)-(1.0_JPRB-ZEPS)*ZQENH (JL, IKB)
        ZDH=YDCST%RCPD*(PTU (JL, IKB)-ZEPS*ZTD (JL, IKB)-(1.0_JPRB-ZEPS)*ZTENH (JL, IKB))+YDCST%RLVTT*ZQUMQE
        ZDH2=YDCST%RCPD*(PTU (JL, IKB-1)-ZEPS*ZTD (JL, IKB-1)-(1&
        &.0_JPRB-ZEPS)*ZTENH (JL, IKB-1))+YDCST%RLVTT*ZQUMQE
        ZDH=0.5_JPRB*(ZDH+ZDH2)
        ZDH=YDCST%RG*MAX (ZDH, 0.1_JPRB*YDCST%RCPD)
        ZMFUB1 (JL)=ZDHPBL (JL)/ZDH

        IF (.NOT.LDTDKMF) THEN

          IF (ZMFUB1 (JL)>0.9_JPRB*ZMFMAX/YDML_PHY_EC%YRECUMF%RMFCFL&
            &.AND.ZDH<0.5_JPRB*YDCST%RG*YDCST%RCPD) THEN
            ZDH=0.75_JPRB*YDCST%RCPD*YDCST%RG
            ZMFUB1 (JL)=ZDHPBL (JL)/ZDH
          ENDIF

        ENDIF

      ELSE
        ZMFUB1 (JL)=ZMFUB (JL)
      ENDIF


      IF (YDML_PHY_EC%YRECUMF%LMFWSTAR)  THEN
        ZMFUB1 (JL)=ZMF_SHAL (JL)
      ENDIF

      ZMFUB1 (JL)=MIN (ZMFUB1 (JL), ZMFMAX)
    ENDIF


    IF (KTYPE (JL)==3) THEN

      IF (LDTDKMF) THEN
        ZMFUB1 (JL)=MAX (ZMFUB (JL), ZKHFL (JL)/PGEOH (JL, IKB))*(1.0_JPRB+ZEPS)
      ELSE
        ZMFUB1 (JL)=MAX (ZMFUB (JL), 5*ZKHFL (JL)/PGEOH (JL, IKB))*(1.0_JPRB+ZEPS)
      ENDIF


      IF (PGEOH (JL, IKB)<1.5E3_JPRB) THEN
        ZMFUB1 (JL)=MIN (ZMFUB1 (JL), ZMFMAX/(1.05_JPRB*YDML_PHY_EC%YRECUMF%RMFCFL))
      ELSE
        ZMFUB1 (JL)=MIN (ZMFUB1 (JL), ZMFMAX)
      ENDIF

    ENDIF

  ENDIF

  
ENDDO


!$ACC PARALLEL LOOP GANG VECTOR &
!$ACC&IF (LDACC) &
!$ACC&PRIVATE (IKB, JK, JL, ZDZ, ZFAC, ZMFMAX) 


DO JL = KIDIA, KFDIA

  

  DO JK=1, KLEV

    

    IF (LLDDRAF (JL).AND.(KTYPE (JL)==1.OR.KTYPE (JL)==2)) THEN
      ZFAC=ZMFUB1 (JL)/MAX (ZMFUB (JL), 1.E-10_JPRB)
      PMFD (JL, JK)=PMFD (JL, JK)*ZFAC
      ZMFDS (JL, JK)=ZMFDS (JL, JK)*ZFAC
      ZMFDQ (JL, JK)=ZMFDQ (JL, JK)*ZFAC
      ZDMFDP (JL, JK)=ZDMFDP (JL, JK)*ZFAC
      PMFDDE_RATE (JL, JK)=PMFDDE_RATE (JL, JK)*ZFAC
    ENDIF

  
  ENDDO


  

  IF (LDCUM (JL)) THEN
    ZMFS (JL)=ZMFUB1 (JL)/MAX (YDML_PHY_EC%YRECUMF%RMFCMIN, ZMFUB (JL))
  ENDIF


  

  DO JK=2, KLEV

    

    IF (LDCUM (JL).AND.JK>=KCTOP (JL)-1) THEN
      IKB=KCBOT (JL)

      IF (JK>IKB) THEN
        ZDZ=((PAPH (JL, KLEV+1)-PAPH (JL, JK))/(PAPH (JL, KLEV+1)-PAPH (JL, IKB)))
        PMFU (JL, JK)=PMFU (JL, IKB)*ZDZ
      ENDIF

      ZMFMAX=(PAPH (JL, JK)-PAPH (JL, JK-1))*ZCONS2

      IF (.NOT.LDTDKMF)  THEN
        ZMFMAX=MIN (ZMFMAX, YDML_PHY_EC%YRECUMF%RMFLIA)
      ENDIF


      IF (PMFU (JL, JK)*ZMFS (JL)>ZMFMAX) THEN
        ZMFS (JL)=MIN (ZMFS (JL), ZMFMAX/PMFU (JL, JK))
        ZMFS (JL)=MAX (ZMFS (JL), 1.E-10_JPRB)
      ENDIF

    ENDIF

  
  ENDDO


  IF (YDML_PHY_EC%YRECUMF%RMFADVW>0.0_JPRB) THEN

    DO JK=2, KLEV-1

      

      IF (KTYPE (JL)==1.AND.JK>=KCTOP (JL)-1) THEN
        ZFAC=ZMFS (JL)*YDCST%RG*YDML_PHY_EC%YRECUMF%RMFADVW*(PMFU (JL, JK)-PMFU (JL, JK+1)+YDML_PHY_EC&
        &%YRECUMF%RMFADVWDD*(PMFD (JL, JK)-PMFD (JL, JK+1)))/(PAPH (JL, JK)-PAPH (JL, JK+1))*PTSPHY

        IF (ABS (ZFAC)>0.98_JPRB)  THEN
          ZMFS (JL)=ZMFS (JL)/MAX (1.02_JPRB, ABS (ZFAC))
        ENDIF

      ENDIF

    
    ENDDO

    JK=KLEV

    

    IF (KTYPE (JL)==1) THEN
      ZFAC=ZMFS (JL)*YDCST%RG*YDML_PHY_EC%YRECUMF%RMFADVW*(PMFU (JL, JK)+YDML_PHY_EC&
      &%YRECUMF%RMFADVWDD*PMFD (JL, JK))/(PAPH (JL, JK)-PAPH (JL, JK+1))*PTSPHY

      IF (ABS (ZFAC)>0.98_JPRB)  THEN
        ZMFS (JL)=ZMFS (JL)/MAX (1.02_JPRB, ABS (ZFAC))
      ENDIF

    ENDIF

  
  ENDIF

ENDDO


!$ACC PARALLEL LOOP GANG VECTOR &
!$ACC&IF (LDACC) &
!$ACC&PRIVATE (JK, JL) 


DO JL = KIDIA, KFDIA

  

  DO JK=2, KLEV

    

    IF (LDCUM (JL).AND.JK<=KCBOT (JL).AND.JK>=KCTOP (JL)-1) THEN
      PMFU (JL, JK)=PMFU (JL, JK)*ZMFS (JL)
      ZMFUS (JL, JK)=ZMFUS (JL, JK)*ZMFS (JL)
      ZMFUQ (JL, JK)=ZMFUQ (JL, JK)*ZMFS (JL)
      ZMFUL (JL, JK)=ZMFUL (JL, JK)*ZMFS (JL)
      ZDMFUP (JL, JK)=ZDMFUP (JL, JK)*ZMFS (JL)
      ZDMFEN (JL, JK)=ZDMFEN (JL, JK)*ZMFS (JL)
      PLUDE (JL, JK)=PLUDE (JL, JK)*ZMFS (JL)
      PLUDELI (JL, JK, 1)=PLUDELI (JL, JK, 1)*ZMFS (JL)
      PLUDELI (JL, JK, 2)=PLUDELI (JL, JK, 2)*ZMFS (JL)
      PMFUDE_RATE (JL, JK)=PMFUDE_RATE (JL, JK)*ZMFS (JL)
    ENDIF

  
  ENDDO


  

  IF (KTYPE (JL)==2.AND.KCBOT (JL)==KCTOP (JL).AND.KCBOT (JL)>=KLEV-1) THEN
    LDCUM (JL)=.FALSE.
    KTYPE (JL)=0
  ENDIF

  
  
  LLO2 (JL)=.FALSE.

  IF ((.NOT.LDSHCV (JL).AND.KTYPE (JL)==2)) THEN
    LLO2 (JL)=.TRUE.
    LDCUM (JL)=.FALSE.
  ENDIF

  
  
  LDCUM_LIG (JL)=LDCUM (JL)
  KCTOP_LIG (JL)=KCTOP (JL)
  KCBOT_LIG (JL)=KCBOT (JL)

  

  IF (.NOT.YDML_PHY_EC%YRECUMF%LMFSCV.OR..NOT.YDML_PHY_EC%YRECUMF%LMFPEN) THEN

    

    IF ((.NOT.YDML_PHY_EC%YRECUMF%LMFSCV.AND.KTYPE (JL)==2).OR.(&
      &.NOT.YDML_PHY_EC%YRECUMF%LMFPEN.AND.KTYPE (JL)==1)) THEN
      LLO2 (JL)=.TRUE.
      LDCUM (JL)=.FALSE.
    ENDIF

  
  ENDIF

ENDDO

ITOPM2=2

!$ACC PARALLEL LOOP GANG VECTOR &
!$ACC&IF (LDACC) &
!$ACC&PRIVATE (JK, JL, YLSTACK) 


DO JL = KIDIA, KFDIA
  YLSTACK%L8 = fxtran_acdc_stack_l8 (YFXTRAN_ACDC_STACK, 1, 1)
  YLSTACK%U8 = fxtran_acdc_stack_u8 (YFXTRAN_ACDC_STACK, 1, 1)
  YLSTACK%L4 = fxtran_acdc_stack_l4 (YFXTRAN_ACDC_STACK, 1, 1)
  YLSTACK%U4 = fxtran_acdc_stack_u4 (YFXTRAN_ACDC_STACK, 1, 1)

  

  

  IF (LLDDRAF (JL).AND.IDTOP (JL)<=KCTOP (JL)) THEN
    IDTOP (JL)=KCTOP (JL)+1
  ENDIF


  

  DO JK=2, KLEV

    

    IF (LLDDRAF (JL)) THEN

      IF (JK<IDTOP (JL)) THEN
        PMFD (JL, JK)=0.0_JPRB
        ZMFDS (JL, JK)=0.0_JPRB
        ZMFDQ (JL, JK)=0.0_JPRB
        PMFDDE_RATE (JL, JK)=0.0_JPRB
        ZDMFDP (JL, JK)=0.0_JPRB
      ELSEIF (JK==IDTOP (JL)) THEN
        PMFDDE_RATE (JL, JK)=0.0_JPRB
      ENDIF

    ENDIF

  
  ENDDO

  CALL CUFLXN_OPENACC (YDTHF, YDCST, YDML_PHY_SLIN%YREPHLI, YDML_PHY_EC%YRECUMF, JL,&
  & JL, KLON, KLEV, PTSPHY, PTEN, PQEN, PQSEN, ZTENH, ZQENH, PAPH, PAP, PGEOH, LDLAND&
  &, LDCUM, LDTDKMF, KCBOT, KCTOP, IDTOP, ITOPM2, KTYPE, LLDDRAF, PMFU, PMFD, ZMFUS,&
  & ZMFDS, ZMFUQ, ZMFDQ, ZMFUL, PLUDE, PLUDELI, PLRAIN, PSNDE, ZDMFUP, ZDMFDP, ZDPMEL&
  &, PLGLAC, PMFLXR, PMFLXS, PRAIN, PMFUDE_RATE, PMFDDE_RATE, YDSTACK=YLSTACK)
ENDDO


!$ACC PARALLEL LOOP GANG VECTOR &
!$ACC&IF (LDACC) &
!$ACC&PRIVATE (IK, JK, JL, ZDZ, ZERATE, ZFAC, ZMFA) 


DO JL = KIDIA, KFDIA

  

  DO JK=2, KLEV-1

    

    IF (LLDDRAF (JL).AND.JK>=IDTOP (JL)-1) THEN
      ZERATE=-PMFD (JL, JK)+PMFD (JL, JK-1)+PMFDDE_RATE (JL, JK)

      IF (ZERATE<0.0_JPRB) THEN
        PMFDDE_RATE (JL, JK)=PMFDDE_RATE (JL, JK)-ZERATE
      ENDIF

    ENDIF


    IF (LDCUM (JL).AND.JK>=KCTOP (JL)-1) THEN
      ZERATE=PMFU (JL, JK)-PMFU (JL, JK+1)+PMFUDE_RATE (JL, JK)

      IF (ZERATE<0.0_JPRB) THEN
        PMFUDE_RATE (JL, JK)=PMFUDE_RATE (JL, JK)-ZERATE
      ENDIF

      ZDMFUP (JL, JK)=PMFLXR (JL, JK+1)+PMFLXS (JL, JK+1)-PMFLXR (JL, JK)-PMFLXS (JL, JK)
      ZDMFDP (JL, JK)=0.0_JPRB
    ENDIF

  
  ENDDO


  

  IF (LLDDRAF (JL)) THEN
    JK=IDTOP (JL)
    IK=MIN (JK+1, KLEV)

    IF (ZMFDQ (JL, JK)<0.3_JPRB*ZMFDQ (JL, IK)) THEN

      IF (YDML_PHY_EC%YRECUMF%RMFSOLTQ==0.0_JPRB) THEN
        ZMFDQ (JL, JK)=0.3_JPRB*ZMFDQ (JL, IK)
      ELSE
        PMFD (JL, JK)=0.3_JPRB*PMFD (JL, IK)
      ENDIF

    ENDIF

  ENDIF


  

  DO JK=2, KLEV

    

    IF (LDCUM (JL).AND.JK>=KCTOP (JL)-1.AND.JK<KCBOT (JL)) THEN
      ZDZ=PTSPHY*YDCST%RG/(PAPH (JL, JK+1)-PAPH (JL, JK))
      ZMFA=ZMFUQ (JL, JK+1)+ZMFDQ (JL, JK+1)-ZMFUQ (JL, JK)-ZMFDQ (JL, JK)+ZMFUL (JL&
      &, JK+1)-ZMFUL (JL, JK)+ZDMFUP (JL, JK)-PSNDE (JL, JK, 1)-PSNDE (JL, JK, 2)
      ZMFA=(ZMFA-PLUDE (JL, JK))*ZDZ

      IF (PQEN (JL, JK)+ZMFA<0.0_JPRB.AND.PLUDE (JL, JK)>0.0_JPRB) THEN
        ZFAC=MIN (-(PQEN (JL, JK)+ZMFA)/ZDZ, PLUDE (JL, JK))
        PLUDE (JL, JK)=PLUDE (JL, JK)+ZFAC
        PLUDELI (JL, JK, 1)=PLUDELI (JL, JK, 1)+ZFAC*PLUDELI (JL, JK, 1)/PLUDE (JL, JK)
        PLUDELI (JL, JK, 2)=PLUDELI (JL, JK, 2)+ZFAC*PLUDELI (JL, JK, 2)/PLUDE (JL, JK)
      ENDIF


      IF (PLUDE (JL, JK)<0.0_JPRB) THEN
        PLUDE (JL, JK)=0.0_JPRB
        PLUDELI (JL, JK, 1)=0.0_JPRB
        PLUDELI (JL, JK, 2)=0.0_JPRB
      ENDIF

    ENDIF


    IF (.NOT.LDCUM (JL)) THEN
      PMFUDE_RATE (JL, JK)=0.0_JPRB
    ENDIF


    IF (PMFD (JL, JK-1)==0.0_JPRB) THEN
      PMFDDE_RATE (JL, JK)=0.0_JPRB
    ENDIF

  
  ENDDO

ENDDO


!$ACC PARALLEL LOOP GANG VECTOR &
!$ACC&IF (LDACC) &
!$ACC&PRIVATE (JK, JL, YLSTACK, ZMFA) 


DO JL = KIDIA, KFDIA
  YLSTACK%L8 = fxtran_acdc_stack_l8 (YFXTRAN_ACDC_STACK, 1, 1)
  YLSTACK%U8 = fxtran_acdc_stack_u8 (YFXTRAN_ACDC_STACK, 1, 1)
  YLSTACK%L4 = fxtran_acdc_stack_l4 (YFXTRAN_ACDC_STACK, 1, 1)
  YLSTACK%U4 = fxtran_acdc_stack_u4 (YFXTRAN_ACDC_STACK, 1, 1)

  

  IF (YDML_PHY_EC%YRECUMF%RMFSOLTQ>0.0_JPRB) THEN

    DO JK=KLEV, 2,-1

      

      IF (LDCUM (JL)) THEN

        IF (JK>KCBOT (JL)) THEN
          ZMFA=1.0_JPRB/MAX (1.E-15_JPRB, PMFU (JL, JK))
          PQU (JL, JK)=ZQENH (JL, JK)+ZMFUQ (JL, JK)*ZMFA
          PTU (JL, JK)=ZTENH (JL, JK)+ZMFUS (JL, JK)*ZMFA*ZORCPD
          ZMFUS (JL, JK)=PMFU (JL, JK)*(YDCST%RCPD*PTU (JL, JK)+PGEOH (JL, JK))
          ZMFUQ (JL, JK)=PMFU (JL, JK)*PQU (JL, JK)

          IF (LLDDRAF (JL)) THEN
            ZMFA=1.0_JPRB/MIN (-1.E-15_JPRB, PMFD (JL, JK))
            ZQD (JL, JK)=ZQENH (JL, JK)+ZMFDQ (JL, JK)*ZMFA
            ZTD (JL, JK)=ZTENH (JL, JK)+ZMFDS (JL, JK)*ZMFA*ZORCPD
            ZMFDQ (JL, JK)=PMFD (JL, JK)*ZQD (JL, JK)
            ZMFDS (JL, JK)=PMFD (JL, JK)*(YDCST%RCPD*ZTD (JL, JK)+PGEOH (JL, JK))
          ENDIF

        ELSEIF (JK<=KCBOT (JL).AND.JK>=KCTOP (JL)) THEN
          ZMFUS (JL, JK)=PMFU (JL, JK)*(YDCST%RCPD*PTU (JL, JK)+PGEOH (JL, JK))
          ZMFUQ (JL, JK)=PMFU (JL, JK)*PQU (JL, JK)
          ZMFDS (JL, JK)=PMFD (JL, JK)*(YDCST%RCPD*ZTD (JL, JK)+PGEOH (JL, JK))
          ZMFDQ (JL, JK)=PMFD (JL, JK)*ZQD (JL, JK)
        ENDIF

      ENDIF

    
    ENDDO

  ENDIF

  CALL CUDTDQN_OPENACC (YDTHF, YDCST, YDML_PHY_SLIN%YREPHLI, YDML_PHY_SLIN%YRPHNC, YDML_PHY_EC&
  &%YRECUMF, YDML_PHY_EC%YREPHY, JL, JL, KLON, KLEV, ITOPM2, KTYPE, KCTOP, KCBOT, IDTOP, LDTDKMF&
  &, LDCUM, LLDDRAF, LLSCVFLAG, PTSPHY, PAPH, PAP, PGEOH, PGEO, PTEN, ZTENH, PQEN, ZQENH,&
  & PQSEN, PLGLAC, PLUDE, PLUDELI, PSNDE, PMFU, PMFD, ZMFUS, ZMFDS, ZMFUQ, ZMFDQ, ZMFUL, ZDMFUP&
  &, ZDPMEL, PMFLXR, PMFLXS, PTENT, PTENQ, PENTH, YDSTACK=YLSTACK)
ENDDO


!$ACC PARALLEL LOOP GANG VECTOR &
!$ACC&IF (LDACC) &
!$ACC&PRIVATE (IK, IKB, JK, JL, YLSTACK, ZDERATE, ZDUTEN, ZDVTEN, ZDZ, ZERATE, ZFAC, ZMFA, &
!$ACC&         ZMFMAX, ZTDIS) 


DO JL = KIDIA, KFDIA
  YLSTACK%L8 = fxtran_acdc_stack_l8 (YFXTRAN_ACDC_STACK, 1, 1)
  YLSTACK%U8 = fxtran_acdc_stack_u8 (YFXTRAN_ACDC_STACK, 1, 1)
  YLSTACK%L4 = fxtran_acdc_stack_l4 (YFXTRAN_ACDC_STACK, 1, 1)
  YLSTACK%U4 = fxtran_acdc_stack_u4 (YFXTRAN_ACDC_STACK, 1, 1)

  

  IF (YDML_PHY_EC%YRECUMF%LMFDUDV) THEN

    DO JK=KLEV-1, 2,-1
      IK=JK+1

      

      IF (LDCUM (JL)) THEN

        IF (JK==KCBOT (JL).AND.KTYPE (JL)<3) THEN
          IKB=IDPL (JL)
          ZUU (JL, JK)=PUEN (JL, IKB-1)
          ZVU (JL, JK)=PVEN (JL, IKB-1)
        ELSEIF (JK==KCBOT (JL).AND.KTYPE (JL)==3) THEN
          ZUU (JL, JK)=PUEN (JL, JK-1)
          ZVU (JL, JK)=PVEN (JL, JK-1)
        ENDIF


        IF (JK<KCBOT (JL).AND.JK>=KCTOP (JL)) THEN
          ZFAC=0.0_JPRB

          IF (LDTDKMF.AND.(KTYPE (JL)==1.OR.KTYPE (JL)==3))  THEN
            ZFAC=2.0_JPRB
          ENDIF

          ZERATE=PMFU (JL, JK)-PMFU (JL, IK)+(1.0_JPRB+ZFAC)*PMFUDE_RATE (JL, JK)
          ZDERATE=(1.0_JPRB+ZFAC)*PMFUDE_RATE (JL, JK)
          ZMFA=1.0_JPRB/MAX (YDML_PHY_EC%YRECUMF%RMFCMIN, PMFU (JL, JK))
          ZUU (JL, JK)=(ZUU (JL, IK)*PMFU (JL, IK)+ZERATE*PUEN (JL, JK)-ZDERATE*ZUU (JL, IK))*ZMFA
          ZVU (JL, JK)=(ZVU (JL, IK)*PMFU (JL, IK)+ZERATE*PVEN (JL, JK)-ZDERATE*ZVU (JL, IK))*ZMFA
        ENDIF

      ENDIF

    
    ENDDO


    DO JK=3, KLEV
      IK=JK-1

      

      IF (LDCUM (JL)) THEN

        IF (JK==IDTOP (JL)) THEN
          ZUD (JL, JK)=0.5_JPRB*(ZUU (JL, JK)+PUEN (JL, IK))
          ZVD (JL, JK)=0.5_JPRB*(ZVU (JL, JK)+PVEN (JL, IK))
        ELSEIF (JK>IDTOP (JL)) THEN
          ZERATE=-PMFD (JL, JK)+PMFD (JL, IK)+PMFDDE_RATE (JL, JK)
          ZMFA=1.0_JPRB/MIN (-YDML_PHY_EC%YRECUMF%RMFCMIN, PMFD (JL, JK))
          ZUD (JL, JK)=(ZUD (JL, IK)*PMFD (JL, IK)-ZERATE*PUEN&
          & (JL, IK)+PMFDDE_RATE (JL, JK)*ZUD (JL, IK))*ZMFA
          ZVD (JL, JK)=(ZVD (JL, IK)*PMFD (JL, IK)-ZERATE*PVEN&
          & (JL, IK)+PMFDDE_RATE (JL, JK)*ZVD (JL, IK))*ZMFA
        ENDIF

      ENDIF

    
    ENDDO

    ZMFS (JL)=1.0_JPRB

    IF (YDML_PHY_EC%YRECUMF%RMFSOLUV<=1.0_JPRB) THEN

      DO JK=2, KLEV

        

        IF (LDCUM (JL).AND.JK>=KCTOP (JL)-1) THEN
          ZMFMAX=(PAPH (JL, JK)-PAPH (JL, JK-1))*ZCONS

          IF (PMFU (JL, JK)>ZMFMAX.AND.JK>=KCTOP (JL))  THEN
            ZMFS (JL)=MIN (ZMFS (JL), ZMFMAX/PMFU (JL, JK))
          ENDIF

        ENDIF

      
      ENDDO

    ENDIF


    DO JK=1, KLEV
      
      ZMFUUS (JL, JK)=PMFU (JL, JK)
      ZMFDUS (JL, JK)=PMFD (JL, JK)

      IF (LDCUM (JL).AND.JK>=KCTOP (JL)-1) THEN
        ZMFUUS (JL, JK)=PMFU (JL, JK)*ZMFS (JL)
        ZMFDUS (JL, JK)=PMFD (JL, JK)*ZMFS (JL)
      ENDIF

    
    ENDDO


    IF (YDML_PHY_EC%YRECUMF%RMFSOLUV>0.0_JPRB) THEN

      

      IF (LDCUM (JL)) THEN
        JK=KCBOT (JL)
        IK=JK-1
        ZMFUUB (JL)=ZMFUUS (JL, JK)*(ZUU (JL, JK)-PUEN (JL, IK))
        ZMFUVB (JL)=ZMFUUS (JL, JK)*(ZVU (JL, JK)-PVEN (JL, IK))
      ENDIF


      

      DO JK=2, KLEV
        IK=JK-1

        

        IF (LDCUM (JL).AND.JK>KCBOT (JL)) THEN
          IKB=KCBOT (JL)
          ZDZ=((PAPH (JL, KLEV+1)-PAPH (JL, JK))/(PAPH (JL, KLEV+1)-PAPH (JL, IKB)))

          IF (KTYPE (JL)==3) THEN
            ZDZ=ZDZ*ZDZ
          ENDIF

          ZMFA=1.0_JPRB/MAX (YDML_PHY_EC%YRECUMF%RMFCMIN, ZMFUUS (JL, JK))
          ZUU (JL, JK)=PUEN (JL, IK)+ZMFUUB (JL)*ZDZ*ZMFA
          ZVU (JL, JK)=PVEN (JL, IK)+ZMFUVB (JL)*ZDZ*ZMFA
          ZMFDUS (JL, JK)=ZMFDUS (JL, IKB)*ZDZ
          ZUD (JL, JK)=PUEN (JL, IK)+ZUD (JL, IKB)-PUEN (JL, IKB-1)
          ZVD (JL, JK)=PVEN (JL, IK)+ZVD (JL, IKB)-PVEN (JL, IKB-1)
        ENDIF


        IF (LDCUM (JL).AND.JK>=KCTOP (JL)) THEN

          IF (LDTDKMF) THEN
            ZUU (JL, JK)=ZUU (JL, JK)-YDML_PHY_EC%YRECUMF%RUVPER*SIGN (1.0_JPRB, ZUU (JL, JK))
            ZVU (JL, JK)=ZVU (JL, JK)-YDML_PHY_EC%YRECUMF%RUVPER*SIGN (1.0_JPRB, ZVU (JL, JK))
          ELSE
            ZUU (JL, JK)=ZUU (JL, JK)-MIN (ABS (ZUU (JL, JK)), YDML_PHY_EC&
            &%YRECUMF%RUVPER)*SIGN (1.0_JPRB, ZUU (JL, JK))
            ZVU (JL, JK)=ZVU (JL, JK)-MIN (ABS (ZVU (JL, JK)), YDML_PHY_EC&
            &%YRECUMF%RUVPER)*SIGN (1.0_JPRB, ZVU (JL, JK))
          ENDIF

        ENDIF

      
      ENDDO

    ENDIF

    CALL CUDUDV_OPENACC (YDCST, YDML_PHY_EC%YRECUMF, YDSPP_CONFIG, YDPERTPAR, JL, JL, KLON&
    &, KLEV, ITOPM2, KTYPE, KCBOT, KCTOP, LDCUM, PTSPHY, PAPH, PAP, PUEN, PVEN, ZMFUUS, ZMFDUS&
    &, PMFU, PMFD, ZUU, ZUD, ZVU, ZVD, PGP2DSPP, PTENU, PTENV, YDSTACK=YLSTACK)

    IF (YDML_PHY_EC%YRECUMF%LMFUVDIS) THEN
      
      ZSUM12 (JL)=0.0_JPRB
      ZSUM22 (JL)=0.0_JPRB

      

      DO JK=1, KLEV
        
        ZUV2 (JL, JK)=0.0_JPRB

        IF (LDCUM (JL).AND.JK>=KCTOP (JL)-1) THEN
          ZDZ=(PAPH (JL, JK+1)-PAPH (JL, JK))
          ZDUTEN=PTENU (JL, JK)-ZTENU (JL, JK)
          ZDVTEN=PTENV (JL, JK)-ZTENV (JL, JK)
          ZUV2 (JL, JK)=SQRT (ZDUTEN**2+ZDVTEN**2)
          ZSUM22 (JL)=ZSUM22 (JL)+ZUV2 (JL, JK)*ZDZ
          ZSUM12 (JL)=ZSUM12 (JL)-(PUEN (JL, JK)*ZDUTEN+PVEN (JL, JK)*ZDVTEN)*ZDZ
        ENDIF

      
      ENDDO

      
      PVDISCU (JL)=ZSUM12 (JL)*ZRG

      

      DO JK=1, KLEV

        

        IF (LDCUM (JL).AND.JK>=KCTOP (JL)-1) THEN
          ZTDIS=ZORCPD*ZSUM12 (JL)*ZUV2 (JL, JK)/MAX (1.E-15_JPRB, ZSUM22 (JL))
          PTENT (JL, JK)=PTENT (JL, JK)+ZTDIS
        ENDIF

      
      ENDDO

    ENDIF

  ENDIF

ENDDO


!$ACC PARALLEL LOOP GANG VECTOR &
!$ACC&IF (LDACC) &
!$ACC&PRIVATE (JK, JL) 


DO JL = KIDIA, KFDIA

  

  IF (.NOT.YDML_PHY_EC%YRECUMF%LMFSCV.OR..NOT.YDML_PHY_EC%YRECUMF%LMFPEN) THEN

    DO JK=2, KLEV

      

      IF (LLO2 (JL).AND.JK>=KCTOP (JL)-1) THEN
        PMFUDE_RATE (JL, JK)=0.0_JPRB
        PMFDDE_RATE (JL, JK)=0.0_JPRB
      ENDIF

    
    ENDDO


    

    IF (LLO2 (JL)) THEN
      KCTOP (JL)=KLEV-1
      KCBOT (JL)=KLEV-1
    ENDIF

  
  ENDIF

ENDDO


IF (YDML_PHY_EC%YREPHY%LMFTRAC.AND.KTRAC>0) THEN
  
  !$ACC PARALLEL LOOP GANG VECTOR &
  !$ACC&IF (LDACC) &
  !$ACC&PRIVATE (IKB, JK, JL, YLSTACK, ZERATE, ZMFMAX) 

  

  DO JL = KIDIA, KFDIA
    YLSTACK%L8 = fxtran_acdc_stack_l8 (YFXTRAN_ACDC_STACK, 1, 1)
    YLSTACK%U8 = fxtran_acdc_stack_u8 (YFXTRAN_ACDC_STACK, 1, 1)
    YLSTACK%L4 = fxtran_acdc_stack_l4 (YFXTRAN_ACDC_STACK, 1, 1)
    YLSTACK%U4 = fxtran_acdc_stack_u4 (YFXTRAN_ACDC_STACK, 1, 1)

    

    

    IF (LDCUM (JL).AND.KTYPE (JL)/=3.AND.KCBOT (JL)-KCTOP (JL)>=1) THEN
      LLDCUM (JL)=.TRUE.
      LLDDRAF3 (JL)=LLDDRAF (JL)
    ELSE
      LLDCUM (JL)=.FALSE.
      LLDDRAF3 (JL)=.FALSE.
    ENDIF

    
    ZMFS (JL)=1.0_JPRB

    IF (YDML_PHY_EC%YRECUMF%RMFSOLCT<=3.0_JPRB) THEN

      DO JK=2, KLEV

        

        IF (LLDCUM (JL).AND.JK>=KCTOP (JL)) THEN
          ZMFMAX=(PAPH (JL, JK)-PAPH (JL, JK-1))*0.8_JPRB*ZCONS

          IF (PMFU (JL, JK)>ZMFMAX)  THEN
            ZMFS (JL)=MIN (ZMFS (JL), ZMFMAX/PMFU (JL, JK))
          ENDIF

        ENDIF

      
      ENDDO

    ENDIF


    DO JK=1, KLEV

      

      IF (LLDCUM (JL).AND.JK>=KCTOP (JL)-1) THEN
        ZMFUUS (JL, JK)=PMFU (JL, JK)*ZMFS (JL)
        ZMFUDR (JL, JK)=PMFUDE_RATE (JL, JK)*ZMFS (JL)
        ZDMFUPC (JL, JK)=(PMFLXR (JL, JK)+PMFLXS (JL, JK))*ZMFS (JL)
        IKB=KCBOT (JL)

        IF (JK>IKB) THEN
          ZDMFUPC (JL, JK)=ZDMFUPC (JL, IKB)
        ENDIF

      ELSE
        ZMFUUS (JL, JK)=0._JPRB
        ZMFUDR (JL, JK)=0._JPRB
      ENDIF


      IF (LLDDRAF3 (JL).AND.JK>=IDTOP (JL)-1) THEN
        ZMFDUS (JL, JK)=PMFD (JL, JK)*ZMFS (JL)
        ZMFDDR (JL, JK)=PMFDDE_RATE (JL, JK)*ZMFS (JL)
        ZDMFDPC (JL, JK)=0.0_JPRB
      ELSE
        ZMFDUS (JL, JK)=0._JPRB
        ZMFDDR (JL, JK)=0._JPRB
      ENDIF

    
    ENDDO


    IF (YDML_PHY_EC%YRECUMF%LMFSMOOTH) THEN

      DO JK=2, KLEV-1

        

        IF (LLDDRAF3 (JL).AND.ZMFDUS (JL, JK)<0.0_JPRB.AND.ZMFDUS (JL, JK+1)==0.0_JPRB) THEN
          ZERATE=MIN (0._JPRB, ZMFDUS (JL, JK)-0.5*ZMFDUS (JL, JK-1))
          ZMFDUS (JL, JK)=ZMFDUS (JL, JK)-ZERATE
          ZMFDDR (JL, JK)=ZMFDDR (JL, JK)-ZERATE
          ZMFDDR (JL, JK+1)=-ZMFDUS (JL, JK)
        ENDIF


        IF (LLDCUM (JL).AND.JK==KCTOP (JL)) THEN
          ZERATE=MAX (0.0_JPRB, ZMFUUS (JL, JK)-0.5_JPRB*ZMFUUS (JL, JK+1))
          ZMFUUS (JL, JK)=ZMFUUS (JL, JK)-ZERATE
          ZMFUDR (JL, JK)=ZMFUDR (JL, JK)+ZERATE
          ZMFUDR (JL, JK-1)=ZMFUUS (JL, JK)
        ENDIF

      
      ENDDO


      DO JK=KLEV-1, 2,-1

        

        IF (LLDCUM (JL)) THEN

          IF (ZMFUDR (JL, JK)==0.0_JPRB.AND.ZMFUDR (JL, JK-1)>0.0_JPRB) THEN
            ZMFUDR (JL, JK)=0.5_JPRB*ZMFUDR (JL, JK-1)
          ENDIF

        ENDIF

      
      ENDDO

    ENDIF


    IF (YDML_PHY_EC%YREPHY%LMFSCAV) THEN
      CALL CUCTRACER_OPENACC (YDCST, YDML_PHY_SLIN%YRCUMFS, YDML_PHY_SLIN%YRECUMF2, YDML_PHY_EC%YRECUMF&
      &, JL, JL, KLON, KLEV, KTRAC, KCTOP, IDTOP, KTYPE, LLDCUM, LLDDRAF3, PTSPHY, PAPH, PAP, ZMFUUS, ZMFDUS&
      &, PMFU, PMFD, ZMFUDR, ZMFDDR, ZDMFUPC, ZDMFDPC, PCEN, PTENC, PSCAV, YDSTACK=YLSTACK)
    ELSE
      ZDMFUPC (JL,:)=0.0_JPRB
      CALL CUCTRACER_OPENACC (YDCST, YDML_PHY_SLIN%YRCUMFS, YDML_PHY_SLIN%YRECUMF2, YDML_PHY_EC%YRECUMF&
      &, JL, JL, KLON, KLEV, KTRAC, KCTOP, IDTOP, KTYPE, LLDCUM, LLDDRAF3, PTSPHY, PAPH, PAP, ZMFUUS, ZMFDUS&
      &, PMFU, PMFD, ZMFUDR, ZMFDDR, ZDMFUPC, ZDMFDPC, PCEN, PTENC, PSCAV0, YDSTACK=YLSTACK)
    ENDIF

  ENDDO

ENDIF


!$ACC PARALLEL LOOP GANG VECTOR &
!$ACC&IF (LDACC) &
!$ACC&PRIVATE (IK, IKD, JK, JL, ZAK, ZAR, ZAS, ZBR, ZBS, ZDUTEN, ZDVTEN, ZRO) 


DO JL = KIDIA, KFDIA
  
  PDISS (JL, 1)=0.0_JPRB
  ZAR=1.0_JPRB/20.89_JPRB
  ZAS=1.0_JPRB/29.51_JPRB
  ZBR=1.0_JPRB/1.15_JPRB
  ZBS=1.0_JPRB/1.10_JPRB
  ZAK=1.0_JPRB/5.09E-3_JPRB

  DO JK=1, KLEV
    IK=MIN (JK+1, KLEV)
    IKD=MAX (JK-1, 1)
    
    PDISS (JL, JK)=0.0_JPRB
    PRSUD (JL, JK, 1)=0.0_JPRB
    PRSUD (JL, JK, 2)=0.0_JPRB

    IF (LDCUM (JL).AND.JK>=KCTOP (JL)-1) THEN
      PLUDELI (JL, JK, 3)=PMFUDE_RATE (JL, JK)*(PQU (JL, IK)-ZQENH (JL&
      &, IK))+PMFDDE_RATE (JL, JK)*(ZQD (JL, IKD)-ZQENH (JL, IKD))
      PLUDELI (JL, JK, 4)=PMFUDE_RATE (JL, JK)*(PTU (JL, IK)-ZTENH (JL&
      &, IK))+PMFDDE_RATE (JL, JK)*(ZTD (JL, IKD)-ZTENH (JL, IKD))
      ZRO=YDCST%RG/(PGEOH (JL, JK)-PGEOH (JL, JK+1))
      PMFUDE_RATE (JL, JK)=PMFUDE_RATE (JL, JK)*ZRO
      PMFDDE_RATE (JL, JK)=PMFDDE_RATE (JL, JK)*ZRO
      ZRO=YDCST%RD*PTEN (JL, JK)*(1.0_JPRB+YDCST%RETV*PQEN (JL, JK))/PAP (JL, JK)
      ZDUTEN=PTENU (JL, JK)-ZTENU (JL, JK)
      ZDVTEN=PTENV (JL, JK)-ZTENV (JL, JK)
      PDISS (JL, JK)=ABS (PUEN (JL, JK)*ZDUTEN+PVEN (JL, JK)*ZDVTEN)**0.3333
      PRSUD (JL, JK, 1)=1.E-3_JPRB*ZRO*(PMFLXR (JL, JK)*3600._JPRB*ZAR)**ZBR
      PRSUD (JL, JK, 2)=0.5*1.E-3_JPRB*ZRO*(10.0_JPRB*PMFLXS (JL, JK)*3600._JPRB*ZAS)**ZBS
    ELSE
      PMFU (JL, JK)=0.0_JPRB
      PMFD (JL, JK)=0.0_JPRB
      PLUDE (JL, JK)=0.0_JPRB
      PLUDELI (JL, JK, 1)=0.0_JPRB
      PLUDELI (JL, JK, 2)=0.0_JPRB
      PLUDELI (JL, JK, 3)=0.0_JPRB
      PLUDELI (JL, JK, 4)=0.0_JPRB
      PSNDE (JL, JK, 1)=0.0_JPRB
      PSNDE (JL, JK, 2)=0.0_JPRB
      PTU (JL, JK)=PTEN (JL, JK)
      PQU (JL, JK)=PQEN (JL, JK)
      PLU (JL, JK)=0.0_JPRB
      PENTH (JL, JK)=0.0_JPRB
      PMFUDE_RATE (JL, JK)=0.0_JPRB
      PMFDDE_RATE (JL, JK)=0.0_JPRB
    ENDIF

  
  ENDDO

ENDDO


#ifdef __PGI
CALL NVTXENDRANGE ()
#endif
!$ACC END DATA

ENDSUBROUTINE CUMASTRN_SINGLEBLOCK
